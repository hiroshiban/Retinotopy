<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
                "http://www.w3.org/TR/REC-html40/loose.dtd">
<html>
<head>
  <title>Description of cretinotopy</title>
  <meta name="keywords" content="cretinotopy">
  <meta name="description" content="Color/luminance-defined checkerboard retinotopy stimulus with checker-patch luminance change-detection tasks.">
  <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
  <meta name="generator" content="m2html &copy; 2005 Guillaume Flandin">
  <meta name="robots" content="index, follow">
  <link type="text/css" rel="stylesheet" href="../../m2html.css">
  <script type="text/javascript">
    if (top.frames.length == 0) { top.location = "../../index.html"; };
  </script>
</head>
<body>
<a name="_top"></a>
<!-- # Retinotopy --><!-- menu.html Presentation -->
<h1>cretinotopy
</h1>

<h2><a name="_name"></a>PURPOSE <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
<div class="box"><strong>Color/luminance-defined checkerboard retinotopy stimulus with checker-patch luminance change-detection tasks.</strong></div>

<h2><a name="_synopsis"></a>SYNOPSIS <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
<div class="box"><strong>function cretinotopy(subjID,exp_mode,acq,displayfile,stimulusfile,gamma_table,overwrite_flg,force_proceed_flag) </strong></div>

<h2><a name="_description"></a>DESCRIPTION <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
<div class="fragment" style="background-image:url(../../hb_brain.png); background-position:right top"><pre class="comment"> Color/luminance-defined checkerboard retinotopy stimulus with checker-patch luminance change-detection tasks.
 function cretinotopy(subjID,exp_mode,acq,:displayfile,:stimulusfile,:gamma_table,:overwrite_flg,:force_proceed_flag)
 (: is optional)

 - This function generates and presents color/luminance-defined checkerboard stimulus
   (rotating wedge and expanding/contracting annulus) to measure cortical retinotopy
   and to delineate retinotopic borders using the standard phase-encoded or pRF
   (population receptive field) analysis techniques.

   references: 1. Borders of multiple visual areas in humans revealed by functional magnetic resonance imaging.
                  Sereno MI, Dale AM, Reppas JB, Kwong KK, Belliveau JW, Brady TJ, Rosen BR, Tootell RB. (1995).
                  Science 268(5212), 889-893.
               2. fMRI of human visual cortex.
                  Engel SA, Rumelhart DE, Wandell BA, Lee AT, Glover GH, Chichilnisky EJ, Shadlen MN. (1994).
                  Nature, 369(6481), 525.
               3. Visual field maps in human cortex.
                  Wandell BA, Dumoulin SO, Brewer AA. (2007). Neuron, 56(2), 366-383.

 - This script shoud be used with MATLAB Psychtoolbox version 3 or above.

 - Luminance detection task: one of the checks of the checkerboard pattern
   randomly turns to darker. An observer has to press the button if s/he
   detects this luminance change. Response keys are defined in displayfile.

 [note]
 Behavioral task of (function_name)_fixtask is to detect changes of luminance
 of the central fixation point, while the task in (function_name) is to detect
 changes of luminance of one of the patches in the checkerboard stimuli.
 Here, the central fixation task is more easy to sustain the stable fixation
 on the center of the screen and may be suitable for naive/non-expert
 participants with minimizing unwilling eye movements. However, some studies
 have reported that attention to the target stimulus (checker-patch luminance
 change detection task) is required to get reliable retinotopic representations
 in higher-order visual areas.


 Created    : &quot;2013-11-25 11:34:59 ban&quot;
 Last Update: &quot;2021-06-07 17:22:19 ban&quot;



 [input variables]
 sujID         : ID of subject, string, such as 's01'
                 you also need to create a directory ./subjects/(subj) and put displayfile and stimulusfile there.
                 !!!!!!!!!!!!!!!!!! IMPORTANT NOTE !!!!!!!!!!!!!!!!!!!!!!!!
                 !!! if 'debug' (case insensitive) is included          !!!
                 !!! in subjID string, this program runs as DEBUG mode; !!!
                 !!! stimulus images are saved as *.png format at       !!!
                 !!! ~/Retinotopy/Presentation/images                   !!!
                 !!!!!!!!!!!!!!!!!! IMPORTANT NOTE !!!!!!!!!!!!!!!!!!!!!!!!

 exp_mode      : experiment mode that you want to run, one of
  - ccw   : checkerboard wedge rotated counter-clockwise
  - cw    : checkerboard wedge rotated clockwise
  - exp   : checkerboard anuulus expanding from fovea
  - cont  : checkerboard annulus contracting from periphery
 acq           : acquisition number (design file number),
                 an integer, such as 1, 2, 3, ...
 displayfile   : (optional) display condition file,
                 *.m file, such as 'RetDepth_display_fmri.m'
                 the file should be located in ./subjects/(subj)/
 stimulusfile  : (optional) stimulus condition file,
                 *.m file, such as 'RetDepth_stimulus_exp1.m'
                 the file should be located in ./subjects/(subj)/
 gamma_table   : (optional) table(s) of gamma-corrected video input values (Color LookupTable).
                 256(8-bits) x 3(RGB) x 1(or 2,3,... when using multiple displays) matrix
                 or a *.mat file specified with a relative path format. e.g. '/gamma_table/gamma1.mat'
                 The *.mat should include a variable named &quot;gamma_table&quot; consists of a 256x3xN matrix.
                 if you use multiple (more than 1) displays and set a 256x3x1 gamma-table, the same
                 table will be applied to all displays. if the number of displays and gamma tables
                 are different (e.g. you have 3 displays and 256x3x!2! gamma-tables), the last
                 gamma_table will be applied to the second and third displays.
                 if empty, normalized gamma table (repmat(linspace(0.0,1.0,256),3,1)) will be applied.
 overwrite_flg : (optional) whether overwriting pre-existing result file. if 1, the previous result
                 file with the same acquisition number will be overwritten by the previous one.
                 if 0, the existing file will be backed-up by adding a prefix '_old' at the tail
                 of the file. 0 by default.
 force_proceed_flag : (optional) whether proceeding stimulus presentatin without waiting for
                 the experimenter response (e.g. presesing the ENTER key) or a trigger.
                 if 1, the stimulus presentation will be automatically carried on.

 !!! NOTICE !!!!
 displayfile &amp; stimulusfile should be located at
 ./subjects/(subjID)/
 as ./subjects/(subjID)/*_display_fmri.m
    ./subjects/(subjID)/*_stimuli.m


 [output variables]
 no output matlab variable.


 [output files]
 1. result file
    stored ./subjects/(subjID)/results/(date)
    as ./subjects/(subjID)/results/(date)/(subjID)_cretinotopy_(exp_mode)_results_run_(run_num).mat


 [example]
 &gt;&gt; cretinotopy('HB','ccw',1,'ret_display.m','ret_checker_stimulus_exp1.m')

 [About displayfile]
 The contents of the displayfile are as below.
 (The file includs 6 lines of headers and following display parameters)

 (an example of the displayfile)

 % ************************************************************
 % This is the display configuration file for the retinotopy stimuli
 % Programmed by Hiroshi Ban Nov 01 2013
 % ************************************************************

 % display mode, one of &quot;mono&quot;, &quot;dual&quot;, &quot;dualcross&quot;, &quot;dualparallel&quot;, &quot;cross&quot;, &quot;parallel&quot;, &quot;redgreen&quot;, &quot;greenred&quot;,
 % &quot;redblue&quot;, &quot;bluered&quot;, &quot;shutter&quot;, &quot;topbottom&quot;, &quot;bottomtop&quot;, &quot;interleavedline&quot;, &quot;interleavedcolumn&quot;, &quot;propixxmono&quot;, &quot;propixxstereo&quot;
 dparam.ExpMode='mono';

 dparam.scrID=1; % screen ID, generally 0 for a single display setup, 1 for dual display setup

 % a method to start stimulus presentation
 % 0:ENTER/SPACE, 1:Left-mouse button, 2:the first MR trigger pulse (CiNet),
 % 3:waiting for a MR trigger pulse (BUIC) -- checking onset of pin #11 of the parallel port,
 % or 4:custom key trigger (wait for a key input that you specify as tgt_key).
 dparam.start_method=2;

 % a pseudo trigger key from the MR scanner when it starts, valid only when dparam.start_method=4;
 dparam.custom_trigger='t';

 % keyboard settings
 dparam.Key1=51; % key 1 (left)
 dparam.Key2=52; % key 2 (right)

 % screen settings

 %%% whether displaying the stimuli in full-screen mode or
 %%% as is (the precise resolution), 'true' or 'false' (true)
 dparam.fullscr=false;

 %%% the resolution of the screen height
 dparam.ScrHeight=1200;

 %% the resolution of the screen width
 dparam.ScrWidth=1920;

 % whether forcing to use specific frame rate, if 0, the frame rate wil bw computed in the ImagesShowPTB function.
 % if non zero, the value is used as the screen frame rate.
 dparam.force_frame_rate=60;

 % whther skipping the PTB's vertical-sync signal test. if 1, the sync test is skipped
 dparam.skip_sync_test=0;


 [About stimulusfile]
 The contents of the stimulusfile are as below.
 (The file includs 6 lines of headers and following stimulus parameters)

 (an example of the stimulusfile)

 % ************************************************************
 % This is the stimulus parameter file for the phase-encoded retinotopy stimulus
 % Programmed by Hiroshi Ban Apr 01 2011
 % ************************************************************

 % &quot;sparam&quot; means &quot;stimulus generation parameters&quot;

 %%% stimulus parameters
 sparam.nwedges     = 4;     % number of wedge subdivisions along polar angle
 sparam.nrings      = 4;     % number of ring subdivisions along eccentricity angle
 sparam.width       = 48;    % wedge width in deg along polar angle
 sparam.phase       = 0;     % phase shift in deg
 sparam.rotangle    = 12;    % rotation angle in deg
 sparam.startangle  = -sparam.width/2;     % presentation start angle in deg, from right-horizontal meridian, ccw

 sparam.maxRad      = 8;    % maximum radius of  annulus (degrees)
 sparam.minRad      = 0;    % minumum

 sparam.dimratio    = 0.4; % luminance dim ratio for the checker-pattern change detection task

 sparam.colors      = [ 128, 128, 128; % number of colors for compensating flickering checkerboard
                        255,   0,   0; % the first row is background
                          0, 255,   0; % the second to end are patch colors
                        255, 255,   0;
                          0,   0, 255;
                        255,   0, 255;
                          0, 255, 255;
                        255, 255, 255;
                          0,   0,   0;
                        255, 128,   0;
                        128,   0, 255;];

 %%% duration in msec for each cycle &amp; repetitions
 sparam.cycle_duration=60000; % msec
 sparam.rest_duration =0; % msec, rest after each cycle, stimulation = cycle_duration-eccrest
 sparam.numRepeats=6;

 %%% set number of frames to flip the screen
 % Here, I set the number as large as I can to minimize vertical cynching error.
 % the final 2 is for 2 times repetitions of flicker
 % Set 1 if you want to flip the display at each vertical sync, but not recommended as it uses much CPU power
 sparam.waitframes = Screen('FrameRate',0)*(sparam.cycle_duration/1000) / (360/sparam.rotangle) / ( (size(sparam.colors,1)-1)*2 );
 % sparam.waitframes = 1;

 %%% fixation period in msec before/after presenting the target stimuli, integer
 % must set a value more than 1 TR for initializing the frame counting.
 sparam.initial_fixation_time=[4000,4000];

 %%% fixation size &amp; color
 sparam.fixtype=1; % 1: circular, 2: rectangular, 3: concentric fixation point
 sparam.fixsize=12; % radius in pixels
 sparam.fixcolor=[255,255,255];

 %%% background color
 sparam.bgcolor=sparam.colors(1,:); %[0,0,0];

 %%% background-patch colors (RGB)
 sparam.bgtype=1; % 1: a simple background with sparam.bgcolor (then, the parameters belows are not used), 2: a background with grid guides
 sparam.patch_size=[30,30]; % background patch size, [height,width] in pixels
 sparam.patch_num=[20,40];  % the number of background patches along vertical and horizontal axis
 sparam.patch_color1=[255,255,255];
 sparam.patch_color2=[0,0,0];

 %%% for converting degree to pixels
 run(fullfile(fileparts(mfilename('fullpath')),'sizeparams'));
 %sparam.pix_per_cm=57.1429;
 %sparam.vdist=65;


 [HOWTO create stimulus files]
 1. All of the stimuli are created in this script in real-time
    with MATLAB scripts &amp; functions.
    see ../Generation &amp; ../Common directries.
 2. Stimulus parameters are defined in the display &amp; stimulus file.


 [reference]
 for stmulus generation, see ../Generation &amp; ../Common directories.</pre></div>

<!-- crossreference -->
<h2><a name="_cross"></a>CROSS-REFERENCE INFORMATION <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
<div class="fragment" style="background-image:url(../../hb_brain.png); background-position:right top">
This function calls:
<ul style="list-style-image:url(../../matlabicon.gif)">
<li><a href="../../Retinotopy/Common/BackUpObsoleteFiles.html" class="code" title="function [new_fname,backup_fname]=BackUpObsoleteFiles(tgt_dir,tgt_fname,backup_prefix)">BackUpObsoleteFiles</a>	Backups already-existing file(s) in the target directory by adding some file-prefix.</li><li><a href="../../Retinotopy/Common/CheckPTBversion.html" class="code" title="function [PTB_OK,vertxt] = CheckPTBversion(num_mainver_youwant)">CheckPTBversion</a>	Checks the version of the currently running Psychtoolbox.</li><li><a href="../../Retinotopy/Common/CreateBackgroundImage.html" class="code" title="function [Bimg,parameters] = CreateBackgroundImage(wdims,stdims,pdims,bgcolor,color1,color2,fixcolor,patchnum,fix_flag,save_flag,show_flag)">CreateBackgroundImage</a>	Creates background image that can be used as a background of your stimulus displays.</li><li><a href="../../Retinotopy/Common/CreateFixationImgCircular.html" class="code" title="function fix=CreateFixationImgCircular(fixsize,fixcolor,bgcolor,circlesize,show_flag,save_flag)">CreateFixationImgCircular</a>	Creates a circular fixation image for a monocular display setting.</li><li><a href="../../Retinotopy/Common/CreateFixationImgConcentrateMono.html" class="code" title="function fix=CreateFixationImgConcentrateMono(fixsize,fixcolor,bgcolor,circlesize,gap,show_flag,save_flag)">CreateFixationImgConcentrateMono</a>	Creates a circular fixation image for a monocular display setting.</li><li><a href="../../Retinotopy/Common/CreateFixationImgMono.html" class="code" title="function fix=CreateFixationImgMono(fixsize,fixcolor,bgcolor,fixlinew,fixlineh,show_flag,save_flag)">CreateFixationImgMono</a>	Creates a cross-shaped fixation image for a monocular display setting.</li><li><a href="../../Retinotopy/Common/DisplayMessage2.html" class="code" title="function DisplayMessage2(message,bgcolor,winPtr,numScreens,drawing_font,drawing_size)">DisplayMessage2</a>	Displays message on the center of each of multiple PTB windows.</li><li><a href="../../Retinotopy/Common/DrawTextureWithCLUT.html" class="code" title="function DrawTextureWithCLUT(win, src, newclut, srcRect, destRect, rotangle)">DrawTextureWithCLUT</a>	Draws a texture with Color LookupTable you specified (modified version of Screen('DrawTexture')).</li><li><a href="../../Retinotopy/Common/GammaLoadPTB.html" class="code" title="function GammaLoadPTB(gamma_table)">GammaLoadPTB</a>	Loads and sets display gamma-table(s) using PTB Screen() function.</li><li><a href="../../Retinotopy/Common/GammaResetPTB.html" class="code" title="function GammaResetPTB(luminance_ratio)">GammaResetPTB</a>	Resets display gamma with PTB Screen() function.</li><li><a href="../../Retinotopy/Common/InitializePTBDisplays.html" class="code" title="function [winPtr,winRect,nScr,fps,ifi,initDisplay_OK]=InitializePTBDisplays(disp_mode,bgcolor,flipping,rgb_gains,custom_scrIDs)">InitializePTBDisplays</a>	Initializes PTB screen(s) for monocular/binocular presentations using PsychImaging() function.</li><li><a href="../../Retinotopy/Common/InitializeRandomSeed.html" class="code" title="function cseed=InitializeRandomSeed">InitializeRandomSeed</a>	Initializes MATLAB internal state of a random seed.</li><li><a href="../../Retinotopy/Common/ValidateStructureFields.html" class="code" title="function structval=ValidateStructureFields(structval,varargin)">ValidateStructureFields</a>	Validates the input structure and set the default values to the missing field(s)</li><li><a href="../../Retinotopy/Common/eventlogger.html" class="code" title="">eventlogger</a>	</li><li><a href="../../Retinotopy/Common/isstructmember.html" class="code" title="function isFieldResult = isstructmember(inStruct, fieldName)">isstructmember</a>	Checks whether the target struct contains a filed you specified as a member.</li><li><a href="../../Retinotopy/Common/responselogger.html" class="code" title="">responselogger</a>	</li><li><a href="../../Retinotopy/Generation/DrawTextureWithCLUT.html" class="code" title="function DrawTextureWithCLUT(win, src, newclut, srcRect, destRect, rotangle)">DrawTextureWithCLUT</a>	Draws a texture with Color LookupTable you specified (modified version of Screen('DrawTexture')).</li><li><a href="../../Retinotopy/Generation/ecc_GenerateCheckerBoard1D.html" class="code" title="function [checkerboard,bincheckerboard,mask]=ecc_GenerateCheckerBoard1D(edges,width,startangle,pix_per_deg,nwedges,nrings,phase)">ecc_GenerateCheckerBoard1D</a>	Generates checkerboard patterns (annulus-based subdivision) with an individual ID number on each patch.</li><li><a href="../../Retinotopy/Generation/pol_GenerateCheckerBoard1D.html" class="code" title="function [checkerboard,bincheckerboard,mask]=pol_GenerateCheckerBoard1D(rmin,rmax,width,startangle,pix_per_deg,nwedges,nrings,phase,dual_flg)">pol_GenerateCheckerBoard1D</a>	Generates checkerboard patterns (polar angle-based subdivision) with an individual ID number on each patch.</li></ul>
This function is called by:
<ul style="list-style-image:url(../../matlabicon.gif)">
</ul>
</div>
<!-- crossreference -->



<h2><a name="_source"></a>SOURCE CODE <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
<div class="fragment" style="background-image:url(../../hb_brain.png); background-position:right top"><pre>0001 <a name="_sub0" href="#_subfunctions" class="code">function cretinotopy(subjID,exp_mode,acq,displayfile,stimulusfile,gamma_table,overwrite_flg,force_proceed_flag)</a>
0002 
0003 <span class="comment">% Color/luminance-defined checkerboard retinotopy stimulus with checker-patch luminance change-detection tasks.</span>
0004 <span class="comment">% function cretinotopy(subjID,exp_mode,acq,:displayfile,:stimulusfile,:gamma_table,:overwrite_flg,:force_proceed_flag)</span>
0005 <span class="comment">% (: is optional)</span>
0006 <span class="comment">%</span>
0007 <span class="comment">% - This function generates and presents color/luminance-defined checkerboard stimulus</span>
0008 <span class="comment">%   (rotating wedge and expanding/contracting annulus) to measure cortical retinotopy</span>
0009 <span class="comment">%   and to delineate retinotopic borders using the standard phase-encoded or pRF</span>
0010 <span class="comment">%   (population receptive field) analysis techniques.</span>
0011 <span class="comment">%</span>
0012 <span class="comment">%   references: 1. Borders of multiple visual areas in humans revealed by functional magnetic resonance imaging.</span>
0013 <span class="comment">%                  Sereno MI, Dale AM, Reppas JB, Kwong KK, Belliveau JW, Brady TJ, Rosen BR, Tootell RB. (1995).</span>
0014 <span class="comment">%                  Science 268(5212), 889-893.</span>
0015 <span class="comment">%               2. fMRI of human visual cortex.</span>
0016 <span class="comment">%                  Engel SA, Rumelhart DE, Wandell BA, Lee AT, Glover GH, Chichilnisky EJ, Shadlen MN. (1994).</span>
0017 <span class="comment">%                  Nature, 369(6481), 525.</span>
0018 <span class="comment">%               3. Visual field maps in human cortex.</span>
0019 <span class="comment">%                  Wandell BA, Dumoulin SO, Brewer AA. (2007). Neuron, 56(2), 366-383.</span>
0020 <span class="comment">%</span>
0021 <span class="comment">% - This script shoud be used with MATLAB Psychtoolbox version 3 or above.</span>
0022 <span class="comment">%</span>
0023 <span class="comment">% - Luminance detection task: one of the checks of the checkerboard pattern</span>
0024 <span class="comment">%   randomly turns to darker. An observer has to press the button if s/he</span>
0025 <span class="comment">%   detects this luminance change. Response keys are defined in displayfile.</span>
0026 <span class="comment">%</span>
0027 <span class="comment">% [note]</span>
0028 <span class="comment">% Behavioral task of (function_name)_fixtask is to detect changes of luminance</span>
0029 <span class="comment">% of the central fixation point, while the task in (function_name) is to detect</span>
0030 <span class="comment">% changes of luminance of one of the patches in the checkerboard stimuli.</span>
0031 <span class="comment">% Here, the central fixation task is more easy to sustain the stable fixation</span>
0032 <span class="comment">% on the center of the screen and may be suitable for naive/non-expert</span>
0033 <span class="comment">% participants with minimizing unwilling eye movements. However, some studies</span>
0034 <span class="comment">% have reported that attention to the target stimulus (checker-patch luminance</span>
0035 <span class="comment">% change detection task) is required to get reliable retinotopic representations</span>
0036 <span class="comment">% in higher-order visual areas.</span>
0037 <span class="comment">%</span>
0038 <span class="comment">%</span>
0039 <span class="comment">% Created    : &quot;2013-11-25 11:34:59 ban&quot;</span>
0040 <span class="comment">% Last Update: &quot;2021-06-07 17:22:19 ban&quot;</span>
0041 <span class="comment">%</span>
0042 <span class="comment">%</span>
0043 <span class="comment">%</span>
0044 <span class="comment">% [input variables]</span>
0045 <span class="comment">% sujID         : ID of subject, string, such as 's01'</span>
0046 <span class="comment">%                 you also need to create a directory ./subjects/(subj) and put displayfile and stimulusfile there.</span>
0047 <span class="comment">%                 !!!!!!!!!!!!!!!!!! IMPORTANT NOTE !!!!!!!!!!!!!!!!!!!!!!!!</span>
0048 <span class="comment">%                 !!! if 'debug' (case insensitive) is included          !!!</span>
0049 <span class="comment">%                 !!! in subjID string, this program runs as DEBUG mode; !!!</span>
0050 <span class="comment">%                 !!! stimulus images are saved as *.png format at       !!!</span>
0051 <span class="comment">%                 !!! ~/Retinotopy/Presentation/images                   !!!</span>
0052 <span class="comment">%                 !!!!!!!!!!!!!!!!!! IMPORTANT NOTE !!!!!!!!!!!!!!!!!!!!!!!!</span>
0053 <span class="comment">%</span>
0054 <span class="comment">% exp_mode      : experiment mode that you want to run, one of</span>
0055 <span class="comment">%  - ccw   : checkerboard wedge rotated counter-clockwise</span>
0056 <span class="comment">%  - cw    : checkerboard wedge rotated clockwise</span>
0057 <span class="comment">%  - exp   : checkerboard anuulus expanding from fovea</span>
0058 <span class="comment">%  - cont  : checkerboard annulus contracting from periphery</span>
0059 <span class="comment">% acq           : acquisition number (design file number),</span>
0060 <span class="comment">%                 an integer, such as 1, 2, 3, ...</span>
0061 <span class="comment">% displayfile   : (optional) display condition file,</span>
0062 <span class="comment">%                 *.m file, such as 'RetDepth_display_fmri.m'</span>
0063 <span class="comment">%                 the file should be located in ./subjects/(subj)/</span>
0064 <span class="comment">% stimulusfile  : (optional) stimulus condition file,</span>
0065 <span class="comment">%                 *.m file, such as 'RetDepth_stimulus_exp1.m'</span>
0066 <span class="comment">%                 the file should be located in ./subjects/(subj)/</span>
0067 <span class="comment">% gamma_table   : (optional) table(s) of gamma-corrected video input values (Color LookupTable).</span>
0068 <span class="comment">%                 256(8-bits) x 3(RGB) x 1(or 2,3,... when using multiple displays) matrix</span>
0069 <span class="comment">%                 or a *.mat file specified with a relative path format. e.g. '/gamma_table/gamma1.mat'</span>
0070 <span class="comment">%                 The *.mat should include a variable named &quot;gamma_table&quot; consists of a 256x3xN matrix.</span>
0071 <span class="comment">%                 if you use multiple (more than 1) displays and set a 256x3x1 gamma-table, the same</span>
0072 <span class="comment">%                 table will be applied to all displays. if the number of displays and gamma tables</span>
0073 <span class="comment">%                 are different (e.g. you have 3 displays and 256x3x!2! gamma-tables), the last</span>
0074 <span class="comment">%                 gamma_table will be applied to the second and third displays.</span>
0075 <span class="comment">%                 if empty, normalized gamma table (repmat(linspace(0.0,1.0,256),3,1)) will be applied.</span>
0076 <span class="comment">% overwrite_flg : (optional) whether overwriting pre-existing result file. if 1, the previous result</span>
0077 <span class="comment">%                 file with the same acquisition number will be overwritten by the previous one.</span>
0078 <span class="comment">%                 if 0, the existing file will be backed-up by adding a prefix '_old' at the tail</span>
0079 <span class="comment">%                 of the file. 0 by default.</span>
0080 <span class="comment">% force_proceed_flag : (optional) whether proceeding stimulus presentatin without waiting for</span>
0081 <span class="comment">%                 the experimenter response (e.g. presesing the ENTER key) or a trigger.</span>
0082 <span class="comment">%                 if 1, the stimulus presentation will be automatically carried on.</span>
0083 <span class="comment">%</span>
0084 <span class="comment">% !!! NOTICE !!!!</span>
0085 <span class="comment">% displayfile &amp; stimulusfile should be located at</span>
0086 <span class="comment">% ./subjects/(subjID)/</span>
0087 <span class="comment">% as ./subjects/(subjID)/*_display_fmri.m</span>
0088 <span class="comment">%    ./subjects/(subjID)/*_stimuli.m</span>
0089 <span class="comment">%</span>
0090 <span class="comment">%</span>
0091 <span class="comment">% [output variables]</span>
0092 <span class="comment">% no output matlab variable.</span>
0093 <span class="comment">%</span>
0094 <span class="comment">%</span>
0095 <span class="comment">% [output files]</span>
0096 <span class="comment">% 1. result file</span>
0097 <span class="comment">%    stored ./subjects/(subjID)/results/(date)</span>
0098 <span class="comment">%    as ./subjects/(subjID)/results/(date)/(subjID)_cretinotopy_(exp_mode)_results_run_(run_num).mat</span>
0099 <span class="comment">%</span>
0100 <span class="comment">%</span>
0101 <span class="comment">% [example]</span>
0102 <span class="comment">% &gt;&gt; cretinotopy('HB','ccw',1,'ret_display.m','ret_checker_stimulus_exp1.m')</span>
0103 <span class="comment">%</span>
0104 <span class="comment">% [About displayfile]</span>
0105 <span class="comment">% The contents of the displayfile are as below.</span>
0106 <span class="comment">% (The file includs 6 lines of headers and following display parameters)</span>
0107 <span class="comment">%</span>
0108 <span class="comment">% (an example of the displayfile)</span>
0109 <span class="comment">%</span>
0110 <span class="comment">% % ************************************************************</span>
0111 <span class="comment">% % This is the display configuration file for the retinotopy stimuli</span>
0112 <span class="comment">% % Programmed by Hiroshi Ban Nov 01 2013</span>
0113 <span class="comment">% % ************************************************************</span>
0114 <span class="comment">%</span>
0115 <span class="comment">% % display mode, one of &quot;mono&quot;, &quot;dual&quot;, &quot;dualcross&quot;, &quot;dualparallel&quot;, &quot;cross&quot;, &quot;parallel&quot;, &quot;redgreen&quot;, &quot;greenred&quot;,</span>
0116 <span class="comment">% % &quot;redblue&quot;, &quot;bluered&quot;, &quot;shutter&quot;, &quot;topbottom&quot;, &quot;bottomtop&quot;, &quot;interleavedline&quot;, &quot;interleavedcolumn&quot;, &quot;propixxmono&quot;, &quot;propixxstereo&quot;</span>
0117 <span class="comment">% dparam.ExpMode='mono';</span>
0118 <span class="comment">%</span>
0119 <span class="comment">% dparam.scrID=1; % screen ID, generally 0 for a single display setup, 1 for dual display setup</span>
0120 <span class="comment">%</span>
0121 <span class="comment">% % a method to start stimulus presentation</span>
0122 <span class="comment">% % 0:ENTER/SPACE, 1:Left-mouse button, 2:the first MR trigger pulse (CiNet),</span>
0123 <span class="comment">% % 3:waiting for a MR trigger pulse (BUIC) -- checking onset of pin #11 of the parallel port,</span>
0124 <span class="comment">% % or 4:custom key trigger (wait for a key input that you specify as tgt_key).</span>
0125 <span class="comment">% dparam.start_method=2;</span>
0126 <span class="comment">%</span>
0127 <span class="comment">% % a pseudo trigger key from the MR scanner when it starts, valid only when dparam.start_method=4;</span>
0128 <span class="comment">% dparam.custom_trigger='t';</span>
0129 <span class="comment">%</span>
0130 <span class="comment">% % keyboard settings</span>
0131 <span class="comment">% dparam.Key1=51; % key 1 (left)</span>
0132 <span class="comment">% dparam.Key2=52; % key 2 (right)</span>
0133 <span class="comment">%</span>
0134 <span class="comment">% % screen settings</span>
0135 <span class="comment">%</span>
0136 <span class="comment">% %%% whether displaying the stimuli in full-screen mode or</span>
0137 <span class="comment">% %%% as is (the precise resolution), 'true' or 'false' (true)</span>
0138 <span class="comment">% dparam.fullscr=false;</span>
0139 <span class="comment">%</span>
0140 <span class="comment">% %%% the resolution of the screen height</span>
0141 <span class="comment">% dparam.ScrHeight=1200;</span>
0142 <span class="comment">%</span>
0143 <span class="comment">% %% the resolution of the screen width</span>
0144 <span class="comment">% dparam.ScrWidth=1920;</span>
0145 <span class="comment">%</span>
0146 <span class="comment">% % whether forcing to use specific frame rate, if 0, the frame rate wil bw computed in the ImagesShowPTB function.</span>
0147 <span class="comment">% % if non zero, the value is used as the screen frame rate.</span>
0148 <span class="comment">% dparam.force_frame_rate=60;</span>
0149 <span class="comment">%</span>
0150 <span class="comment">% % whther skipping the PTB's vertical-sync signal test. if 1, the sync test is skipped</span>
0151 <span class="comment">% dparam.skip_sync_test=0;</span>
0152 <span class="comment">%</span>
0153 <span class="comment">%</span>
0154 <span class="comment">% [About stimulusfile]</span>
0155 <span class="comment">% The contents of the stimulusfile are as below.</span>
0156 <span class="comment">% (The file includs 6 lines of headers and following stimulus parameters)</span>
0157 <span class="comment">%</span>
0158 <span class="comment">% (an example of the stimulusfile)</span>
0159 <span class="comment">%</span>
0160 <span class="comment">% % ************************************************************</span>
0161 <span class="comment">% % This is the stimulus parameter file for the phase-encoded retinotopy stimulus</span>
0162 <span class="comment">% % Programmed by Hiroshi Ban Apr 01 2011</span>
0163 <span class="comment">% % ************************************************************</span>
0164 <span class="comment">%</span>
0165 <span class="comment">% % &quot;sparam&quot; means &quot;stimulus generation parameters&quot;</span>
0166 <span class="comment">%</span>
0167 <span class="comment">% %%% stimulus parameters</span>
0168 <span class="comment">% sparam.nwedges     = 4;     % number of wedge subdivisions along polar angle</span>
0169 <span class="comment">% sparam.nrings      = 4;     % number of ring subdivisions along eccentricity angle</span>
0170 <span class="comment">% sparam.width       = 48;    % wedge width in deg along polar angle</span>
0171 <span class="comment">% sparam.phase       = 0;     % phase shift in deg</span>
0172 <span class="comment">% sparam.rotangle    = 12;    % rotation angle in deg</span>
0173 <span class="comment">% sparam.startangle  = -sparam.width/2;     % presentation start angle in deg, from right-horizontal meridian, ccw</span>
0174 <span class="comment">%</span>
0175 <span class="comment">% sparam.maxRad      = 8;    % maximum radius of  annulus (degrees)</span>
0176 <span class="comment">% sparam.minRad      = 0;    % minumum</span>
0177 <span class="comment">%</span>
0178 <span class="comment">% sparam.dimratio    = 0.4; % luminance dim ratio for the checker-pattern change detection task</span>
0179 <span class="comment">%</span>
0180 <span class="comment">% sparam.colors      = [ 128, 128, 128; % number of colors for compensating flickering checkerboard</span>
0181 <span class="comment">%                        255,   0,   0; % the first row is background</span>
0182 <span class="comment">%                          0, 255,   0; % the second to end are patch colors</span>
0183 <span class="comment">%                        255, 255,   0;</span>
0184 <span class="comment">%                          0,   0, 255;</span>
0185 <span class="comment">%                        255,   0, 255;</span>
0186 <span class="comment">%                          0, 255, 255;</span>
0187 <span class="comment">%                        255, 255, 255;</span>
0188 <span class="comment">%                          0,   0,   0;</span>
0189 <span class="comment">%                        255, 128,   0;</span>
0190 <span class="comment">%                        128,   0, 255;];</span>
0191 <span class="comment">%</span>
0192 <span class="comment">% %%% duration in msec for each cycle &amp; repetitions</span>
0193 <span class="comment">% sparam.cycle_duration=60000; % msec</span>
0194 <span class="comment">% sparam.rest_duration =0; % msec, rest after each cycle, stimulation = cycle_duration-eccrest</span>
0195 <span class="comment">% sparam.numRepeats=6;</span>
0196 <span class="comment">%</span>
0197 <span class="comment">% %%% set number of frames to flip the screen</span>
0198 <span class="comment">% % Here, I set the number as large as I can to minimize vertical cynching error.</span>
0199 <span class="comment">% % the final 2 is for 2 times repetitions of flicker</span>
0200 <span class="comment">% % Set 1 if you want to flip the display at each vertical sync, but not recommended as it uses much CPU power</span>
0201 <span class="comment">% sparam.waitframes = Screen('FrameRate',0)*(sparam.cycle_duration/1000) / (360/sparam.rotangle) / ( (size(sparam.colors,1)-1)*2 );</span>
0202 <span class="comment">% % sparam.waitframes = 1;</span>
0203 <span class="comment">%</span>
0204 <span class="comment">% %%% fixation period in msec before/after presenting the target stimuli, integer</span>
0205 <span class="comment">% % must set a value more than 1 TR for initializing the frame counting.</span>
0206 <span class="comment">% sparam.initial_fixation_time=[4000,4000];</span>
0207 <span class="comment">%</span>
0208 <span class="comment">% %%% fixation size &amp; color</span>
0209 <span class="comment">% sparam.fixtype=1; % 1: circular, 2: rectangular, 3: concentric fixation point</span>
0210 <span class="comment">% sparam.fixsize=12; % radius in pixels</span>
0211 <span class="comment">% sparam.fixcolor=[255,255,255];</span>
0212 <span class="comment">%</span>
0213 <span class="comment">% %%% background color</span>
0214 <span class="comment">% sparam.bgcolor=sparam.colors(1,:); %[0,0,0];</span>
0215 <span class="comment">%</span>
0216 <span class="comment">% %%% background-patch colors (RGB)</span>
0217 <span class="comment">% sparam.bgtype=1; % 1: a simple background with sparam.bgcolor (then, the parameters belows are not used), 2: a background with grid guides</span>
0218 <span class="comment">% sparam.patch_size=[30,30]; % background patch size, [height,width] in pixels</span>
0219 <span class="comment">% sparam.patch_num=[20,40];  % the number of background patches along vertical and horizontal axis</span>
0220 <span class="comment">% sparam.patch_color1=[255,255,255];</span>
0221 <span class="comment">% sparam.patch_color2=[0,0,0];</span>
0222 <span class="comment">%</span>
0223 <span class="comment">% %%% for converting degree to pixels</span>
0224 <span class="comment">% run(fullfile(fileparts(mfilename('fullpath')),'sizeparams'));</span>
0225 <span class="comment">% %sparam.pix_per_cm=57.1429;</span>
0226 <span class="comment">% %sparam.vdist=65;</span>
0227 <span class="comment">%</span>
0228 <span class="comment">%</span>
0229 <span class="comment">% [HOWTO create stimulus files]</span>
0230 <span class="comment">% 1. All of the stimuli are created in this script in real-time</span>
0231 <span class="comment">%    with MATLAB scripts &amp; functions.</span>
0232 <span class="comment">%    see ../Generation &amp; ../Common directries.</span>
0233 <span class="comment">% 2. Stimulus parameters are defined in the display &amp; stimulus file.</span>
0234 <span class="comment">%</span>
0235 <span class="comment">%</span>
0236 <span class="comment">% [reference]</span>
0237 <span class="comment">% for stmulus generation, see ../Generation &amp; ../Common directories.</span>
0238 
0239 
0240 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0241 <span class="comment">%%%% Check the input variables</span>
0242 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0243 
0244 clear <span class="keyword">global</span>; clear mex;
0245 <span class="keyword">if</span> nargin&lt;3, help(mfilename()); <span class="keyword">return</span>; <span class="keyword">end</span>
0246 <span class="keyword">if</span> nargin&lt;4 || isempty(displayfile), displayfile=[]; <span class="keyword">end</span>
0247 <span class="keyword">if</span> nargin&lt;5 || isempty(stimulusfile), stimulusfile=[]; <span class="keyword">end</span>
0248 <span class="keyword">if</span> nargin&lt;6 || isempty(gamma_table), gamma_table=[]; <span class="keyword">end</span>
0249 <span class="keyword">if</span> nargin&lt;7 || isempty(overwrite_flg), overwrite_flg=1; <span class="keyword">end</span>
0250 <span class="keyword">if</span> nargin&lt;8 || isempty(force_proceed_flag), force_proceed_flag=0; <span class="keyword">end</span>
0251 
0252 <span class="comment">% check the aqcuisition number</span>
0253 <span class="keyword">if</span> acq&lt;1, error(<span class="string">'Acquistion number must be integer and greater than zero'</span>); <span class="keyword">end</span>
0254 
0255 <span class="comment">% check the experiment mode (stimulus type)</span>
0256 <span class="keyword">if</span> ~strcmpi(exp_mode,<span class="string">'ccw'</span>) &amp;&amp; ~strcmpi(exp_mode,<span class="string">'cw'</span>) &amp;&amp; ~strcmpi(exp_mode,<span class="string">'exp'</span>) &amp;&amp; ~strcmpi(exp_mode,<span class="string">'cont'</span>)
0257   error(<span class="string">'exp_mode should be one of &quot;ccw&quot;, &quot;cw&quot;, &quot;exp&quot;, and &quot;cont&quot;. check the input variable.'</span>);
0258 <span class="keyword">end</span>
0259 
0260 rootDir=fileparts(mfilename(<span class="string">'fullpath'</span>));
0261 
0262 <span class="comment">% check the subject directory</span>
0263 <span class="keyword">if</span> ~exist(fullfile(rootDir,<span class="string">'subjects'</span>,subjID),<span class="string">'dir'</span>), error(<span class="string">'can not find subj directory. check the input variable.'</span>); <span class="keyword">end</span>
0264 
0265 <span class="comment">% check the display/stimulus files</span>
0266 <span class="keyword">if</span> ~isempty(displayfile)
0267   <span class="keyword">if</span> ~strcmpi(displayfile(end-1:end),<span class="string">'.m'</span>), displayfile=[displayfile,<span class="string">'.m'</span>]; <span class="keyword">end</span>
0268   <span class="keyword">if</span> ~exist(fullfile(rootDir,<span class="string">'subjects'</span>,subjID,displayfile),<span class="string">'file'</span>), error(<span class="string">'displayfile not found. check the input variable.'</span>); <span class="keyword">end</span>
0269 <span class="keyword">end</span>
0270 
0271 <span class="keyword">if</span> ~isempty(stimulusfile)
0272   <span class="keyword">if</span> ~strcmpi(stimulusfile(end-1:end),<span class="string">'.m'</span>), stimulusfile=[stimulusfile,<span class="string">'.m'</span>]; <span class="keyword">end</span>
0273   <span class="keyword">if</span> ~exist(fullfile(rootDir,<span class="string">'subjects'</span>,subjID,stimulusfile),<span class="string">'file'</span>), error(<span class="string">'stimulusfile not found. check the input variable.'</span>); <span class="keyword">end</span>
0274 <span class="keyword">end</span>
0275 
0276 
0277 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0278 <span class="comment">%%%% Add path to the subfunctions</span>
0279 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0280 
0281 <span class="comment">% add paths to the subfunctions</span>
0282 addpath(genpath(fullfile(rootDir,<span class="string">'..'</span>,<span class="string">'Common'</span>)));
0283 addpath(fullfile(rootDir,<span class="string">'..'</span>,<span class="string">'Generation'</span>));
0284 
0285 
0286 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0287 <span class="comment">%%%% For log file</span>
0288 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0289 
0290 <span class="comment">% get date</span>
0291 today=datestr(now,<span class="string">'yymmdd'</span>);
0292 
0293 <span class="comment">% result directry &amp; file</span>
0294 resultDir=fullfile(rootDir,<span class="string">'subjects'</span>,num2str(subjID),<span class="string">'results'</span>,today);
0295 <span class="keyword">if</span> ~exist(resultDir,<span class="string">'dir'</span>), mkdir(resultDir); <span class="keyword">end</span>
0296 
0297 <span class="comment">% record the output window</span>
0298 logfname=fullfile(resultDir,[num2str(subjID),<span class="string">'_cretinotopy_'</span>,exp_mode,<span class="string">'_results_run_'</span>,num2str(acq,<span class="string">'%02d'</span>),<span class="string">'.log'</span>]);
0299 diary(logfname);
0300 warning off; <span class="comment">%#ok warning('off','MATLAB:dispatcher:InexactCaseMatch');</span>
0301 
0302 
0303 <span class="comment">%%%%% try &amp; catch %%%%%</span>
0304 <span class="keyword">try</span>
0305 
0306 
0307 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0308 <span class="comment">%%%% Check the PTB version</span>
0309 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0310 
0311 PTB_OK=<a href="../../Retinotopy/Common/CheckPTBversion.html" class="code" title="function [PTB_OK,vertxt] = CheckPTBversion(num_mainver_youwant)">CheckPTBversion</a>(3); <span class="comment">% check wether the PTB version is 3</span>
0312 <span class="keyword">if</span> ~PTB_OK, error(<span class="string">'Wrong version of Psychtoolbox is running. %s requires PTB ver.3'</span>,mfilename()); <span class="keyword">end</span>
0313 
0314 <span class="comment">% debug level, black screen during calibration</span>
0315 Screen(<span class="string">'Preference'</span>, <span class="string">'VisualDebuglevel'</span>, 3);
0316 
0317 
0318 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0319 <span class="comment">%%%% Setup random seed</span>
0320 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0321 
0322 <a href="../../Retinotopy/Common/InitializeRandomSeed.html" class="code" title="function cseed=InitializeRandomSeed">InitializeRandomSeed</a>();
0323 
0324 
0325 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0326 <span class="comment">%%%% Reset display Gamma-function</span>
0327 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0328 
0329 <span class="keyword">if</span> isempty(gamma_table)
0330   gamma_table=repmat(linspace(0.0,1.0,256),3,1); <span class="comment">%#ok</span>
0331   <a href="../../Retinotopy/Common/GammaResetPTB.html" class="code" title="function GammaResetPTB(luminance_ratio)">GammaResetPTB</a>(1.0);
0332 <span class="keyword">else</span>
0333   <a href="../../Retinotopy/Common/GammaLoadPTB.html" class="code" title="function GammaLoadPTB(gamma_table)">GammaLoadPTB</a>(gamma_table);
0334 <span class="keyword">end</span>
0335 
0336 
0337 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0338 <span class="comment">%%%% Validate dparam (displayfile) and sparam (stimulusfile) structures</span>
0339 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0340 
0341 <span class="comment">% organize dparam</span>
0342 dparam=struct(); <span class="comment">% initialize</span>
0343 <span class="keyword">if</span> ~isempty(displayfile), run(fullfile(rootDir,<span class="string">'subjects'</span>,subjID,displayfile)); <span class="keyword">end</span> <span class="comment">% load specific dparam parameters configured for each of the participants</span>
0344 dparam=<a href="../../Retinotopy/Common/ValidateStructureFields.html" class="code" title="function structval=ValidateStructureFields(structval,varargin)">ValidateStructureFields</a>(dparam,<span class="keyword">...</span><span class="comment"> % validate fields and set the default values to missing field(s)</span>
0345          <span class="string">'ExpMode'</span>,<span class="string">'mono'</span>,<span class="keyword">...</span>
0346          <span class="string">'scrID'</span>,1,<span class="keyword">...</span>
0347          <span class="string">'start_method'</span>,0,<span class="keyword">...</span>
0348          <span class="string">'custom_trigger'</span>,<span class="string">'t'</span>,<span class="keyword">...</span>
0349          <span class="string">'Key1'</span>,51,<span class="keyword">...</span>
0350          <span class="string">'Key2'</span>,52,<span class="keyword">...</span>
0351          <span class="string">'fullscr'</span>,false,<span class="keyword">...</span>
0352          <span class="string">'ScrHeight'</span>,1200,<span class="keyword">...</span>
0353          <span class="string">'ScrWidth'</span>,1920,<span class="keyword">...</span>
0354          <span class="string">'force_frame_rate'</span>,60,<span class="keyword">...</span>
0355          <span class="string">'skip_sync_test'</span>,0);
0356 
0357 <span class="comment">% organize sparam</span>
0358 sparam=struct(); <span class="comment">% initialize</span>
0359 sparam.mode=exp_mode;
0360 <span class="keyword">if</span> ~isempty(stimulusfile), run(fullfile(rootDir,<span class="string">'subjects'</span>,subjID,stimulusfile)); <span class="keyword">end</span> <span class="comment">% load specific sparam parameters configured for each of the participants</span>
0361 sparam=<a href="../../Retinotopy/Common/ValidateStructureFields.html" class="code" title="function structval=ValidateStructureFields(structval,varargin)">ValidateStructureFields</a>(sparam,<span class="keyword">...</span><span class="comment"> % validate fields and set the default values to missing field(s)</span>
0362          <span class="string">'nwedges'</span>,4,<span class="keyword">...</span>
0363          <span class="string">'nrings'</span>,4,<span class="keyword">...</span>
0364          <span class="string">'width'</span>,48,<span class="keyword">...</span>
0365          <span class="string">'phase'</span>,0,<span class="keyword">...</span>
0366          <span class="string">'rotangle'</span>,12,<span class="keyword">...</span>
0367          <span class="string">'startangle'</span>,-48/2,<span class="keyword">...</span>
0368          <span class="string">'maxRad'</span>,8,<span class="keyword">...</span>
0369          <span class="string">'minRad'</span>,0,<span class="keyword">...</span>
0370          <span class="string">'dimratio'</span>,0.4,<span class="keyword">...</span>
0371          <span class="string">'colors'</span>,[ 128, 128, 128;
0372                     255,   0,   0;
0373                       0, 255,   0;
0374                     255, 255,   0;
0375                       0,   0, 255;
0376                     255,   0, 255;
0377                       0, 255, 255;
0378                     255, 255, 255;
0379                       0,   0,   0;
0380                     255, 128,   0;
0381                     128,   0, 255],<span class="keyword">...</span>
0382          <span class="string">'cycle_duration'</span>,60000,<span class="keyword">...</span>
0383          <span class="string">'rest_duration'</span>,0,<span class="keyword">...</span>
0384          <span class="string">'numRepeats'</span>,6,<span class="keyword">...</span>
0385          <span class="string">'waitframes'</span>,6,<span class="keyword">...</span><span class="comment"> % Screen('FrameRate',0)*(sparam.cycle_duration/1000) / (360/sparam.rotangle) / ( (size(sparam.colors,1)-1)*2 );</span>
0386          <span class="string">'initial_fixation_time'</span>,[4000,4000],<span class="keyword">...</span>
0387          <span class="string">'fixtype'</span>,1,<span class="keyword">...</span>
0388          <span class="string">'fixsize'</span>,12,<span class="keyword">...</span>
0389          <span class="string">'fixcolor'</span>,[255,255,255],<span class="keyword">...</span>
0390          <span class="string">'bgcolor'</span>,[128,128,128],<span class="keyword">...</span><span class="comment"> % sparam.colors(1,:);</span>
0391          <span class="string">'bgtype'</span>,1,<span class="keyword">...</span>
0392          <span class="string">'patch_size'</span>,[30,30],<span class="keyword">...</span>
0393          <span class="string">'patch_num'</span>,[20,40],<span class="keyword">...</span>
0394          <span class="string">'patch_color1'</span>,[255,255,255],<span class="keyword">...</span>
0395          <span class="string">'patch_color2'</span>,[0,0,0],<span class="keyword">...</span>
0396          <span class="string">'pix_per_cm'</span>,57.1429,<span class="keyword">...</span>
0397          <span class="string">'vdist'</span>,65);
0398 
0399 <span class="comment">% change unit from msec to sec.</span>
0400 sparam.initial_fixation_time=sparam.initial_fixation_time./1000; <span class="comment">%#ok</span>
0401 
0402 <span class="comment">% change unit from msec to sec.</span>
0403 sparam.cycle_duration = sparam.cycle_duration./1000;
0404 sparam.rest_duration  = sparam.rest_duration./1000;
0405 
0406 <span class="comment">% set the other parameters</span>
0407 dparam.RunScript = mfilename();
0408 sparam.RunScript = mfilename();
0409 
0410 <span class="comment">%% check varidity of parameters</span>
0411 fprintf(<span class="string">'checking validity of stimulus generation/presentation parameters...'</span>);
0412 <span class="keyword">if</span> mod(360,sparam.rotangle), error(<span class="string">'mod(360,sparam.rotangle) should be 0. check the input variables.'</span>); <span class="keyword">end</span>
0413 <span class="keyword">if</span> mod(sparam.width,sparam.rotangle), error(<span class="string">'mod(sparam.width,sparam.rotangle) should be 0. check the input variables.'</span>); <span class="keyword">end</span>
0414 fprintf(<span class="string">'done.\n'</span>);
0415 
0416 
0417 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0418 <span class="comment">%%%% Displaying the presentation parameters you set</span>
0419 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0420 
0421 fprintf(<span class="string">'The Presentation Parameters are as below.\n\n'</span>);
0422 fprintf(<span class="string">'************************************************\n'</span>);
0423 fprintf(<span class="string">'****** Script, Subject, Acquistion Number ******\n'</span>);
0424 fprintf(<span class="string">'Date &amp; Time            : %s\n'</span>,strcat([datestr(now,<span class="string">'yymmdd'</span>),<span class="string">' '</span>,datestr(now,<span class="string">'HH:mm:ss'</span>)]));
0425 fprintf(<span class="string">'Running Script Name    : %s\n'</span>,mfilename());
0426 fprintf(<span class="string">'Subject ID             : %s\n'</span>,subjID);
0427 fprintf(<span class="string">'Acquisition Number     : %d\n'</span>,acq);
0428 fprintf(<span class="string">'********* Run Type, Display Image Type *********\n'</span>);
0429 fprintf(<span class="string">'Display Mode           : %s\n'</span>,dparam.ExpMode);
0430 fprintf(<span class="string">'use Full Screen Mode   : %d\n'</span>,dparam.fullscr);
0431 fprintf(<span class="string">'Start Method           : %d\n'</span>,dparam.start_method);
0432 <span class="keyword">if</span> dparam.start_method==4
0433   fprintf(<span class="string">'Custom Trigger         : %d\n'</span>,dparam.custom_trigger);
0434 <span class="keyword">end</span>
0435 fprintf(<span class="string">'*************** Screen Settings ****************\n'</span>);
0436 fprintf(<span class="string">'Screen Height          : %d\n'</span>,dparam.ScrHeight);
0437 fprintf(<span class="string">'Screen Width           : %d\n'</span>,dparam.ScrWidth);
0438 fprintf(<span class="string">'*********** Stimulation Periods etc. ***********\n'</span>);
0439 fprintf(<span class="string">'Fixation Time(sec)     : %d &amp; %d\n'</span>,sparam.initial_fixation_time(1),sparam.initial_fixation_time(2));
0440 fprintf(<span class="string">'Cycle Duration(sec)    : %d\n'</span>,sparam.cycle_duration);
0441 fprintf(<span class="string">'Rest  Duration(sec)    : %d\n'</span>,sparam.rest_duration);
0442 fprintf(<span class="string">'Repetitions(cycles)    : %d\n'</span>,sparam.numRepeats);
0443 fprintf(<span class="string">'Frame Flip(per VerSync): %d\n'</span>,sparam.waitframes);
0444 fprintf(<span class="string">'Total Time (sec)       : %d\n'</span>,sum(sparam.initial_fixation_time)+sparam.numRepeats*sparam.cycle_duration);
0445 fprintf(<span class="string">'**************** Stimulus Type *****************\n'</span>);
0446 fprintf(<span class="string">'Experiment Mode        : %s\n'</span>,sparam.mode);
0447 fprintf(<span class="string">'************ Response key settings *************\n'</span>);
0448 fprintf(<span class="string">'Reponse Key #1         : %d = %s\n'</span>,dparam.Key1,KbName(dparam.Key1));
0449 fprintf(<span class="string">'Reponse Key #2         : %d = %s\n'</span>,dparam.Key2,KbName(dparam.Key2));
0450 fprintf(<span class="string">'************************************************\n\n'</span>);
0451 fprintf(<span class="string">'Please carefully check before proceeding.\n\n'</span>);
0452 
0453 
0454 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0455 <span class="comment">%%%% Initialize response &amp; event logger objects</span>
0456 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0457 
0458 <span class="comment">% initialize MATLAB objects for event and response logs</span>
0459 event=<a href="../../Retinotopy/Common/eventlogger.html" class="code" title="">eventlogger</a>();
0460 resps=<a href="../../Retinotopy/Common/responselogger.html" class="code" title="">responselogger</a>([dparam.Key1,dparam.Key2]);
0461 resps.initialize(event); <span class="comment">% initialize responselogger</span>
0462 
0463 
0464 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0465 <span class="comment">%%%% Wait for user reponse to start</span>
0466 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0467 
0468 <span class="keyword">if</span> ~force_proceed_flag
0469   [user_answer,resps]=resps.wait_to_proceed();
0470   <span class="keyword">if</span> ~user_answer, diary off; <span class="keyword">return</span>; <span class="keyword">end</span>
0471 <span class="keyword">end</span>
0472 
0473 
0474 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0475 <span class="comment">%%%% Initialization of Left &amp; Right screens for binocular presenting/viewing mode</span>
0476 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0477 
0478 <span class="keyword">if</span> dparam.skip_sync_test, Screen(<span class="string">'Preference'</span>,<span class="string">'SkipSyncTests'</span>,1); <span class="keyword">end</span>
0479 
0480 [winPtr,winRect,nScr,dparam.fps,dparam.ifi,initDisplay_OK]=<a href="../../Retinotopy/Common/InitializePTBDisplays.html" class="code" title="function [winPtr,winRect,nScr,fps,ifi,initDisplay_OK]=InitializePTBDisplays(disp_mode,bgcolor,flipping,rgb_gains,custom_scrIDs)">InitializePTBDisplays</a>(dparam.ExpMode,sparam.bgcolor,0,[],dparam.scrID);
0481 <span class="keyword">if</span> ~initDisplay_OK, error(<span class="string">'Display initialization error. Please check your exp_run parameter.'</span>); <span class="keyword">end</span>
0482 HideCursor();
0483 
0484 <span class="keyword">if</span> <a href="../../Retinotopy/Common/isstructmember.html" class="code" title="function isFieldResult = isstructmember(inStruct, fieldName)">isstructmember</a>(dparam,<span class="string">'force_frame_rate'</span>)
0485   <span class="keyword">if</span> dparam.force_frame_rate
0486     dparam.fps=dparam.force_frame_rate;
0487     dparam.ifi=1/dparam.fps;
0488   <span class="keyword">end</span>
0489 <span class="keyword">end</span>
0490 
0491 
0492 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0493 <span class="comment">%%%% Setting the PTB runnning priority to MAX</span>
0494 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0495 
0496 <span class="comment">% set the priority of this script to MAX</span>
0497 priorityLevel=MaxPriority(winPtr,<span class="string">'WaitBlanking'</span>);
0498 Priority(priorityLevel);
0499 
0500 <span class="comment">% conserve VRAM memory: Workaround for flawed hardware and drivers</span>
0501 <span class="comment">% 32 == kPsychDontShareContextRessources: Do not share ressources between</span>
0502 <span class="comment">% different onscreen windows. Usually you want PTB to share all ressources</span>
0503 <span class="comment">% like offscreen windows, textures and GLSL shaders among all open onscreen</span>
0504 <span class="comment">% windows. If that causes trouble for some weird reason, you can prevent</span>
0505 <span class="comment">% automatic sharing with this flag.</span>
0506 <span class="comment">%Screen('Preference','ConserveVRAM',32);</span>
0507 
0508 
0509 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0510 <span class="comment">%%%% Setting the PTB OpenGL functions</span>
0511 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0512 
0513 <span class="comment">% Enable OpenGL mode of Psychtoolbox: This is crucially needed for clut animation</span>
0514 InitializeMatlabOpenGL();
0515 
0516 <span class="comment">% This script calls Psychtoolbox commands available only in OpenGL-based</span>
0517 <span class="comment">% versions of the Psychtoolbox. (So far, the OS X Psychtoolbox is the</span>
0518 <span class="comment">% only OpenGL-base Psychtoolbox.)  The Psychtoolbox command AssertPsychOpenGL will issue</span>
0519 <span class="comment">% an error message if someone tries to execute this script on a computer without</span>
0520 <span class="comment">% an OpenGL Psychtoolbox</span>
0521 AssertOpenGL();
0522 
0523 <span class="comment">% set OpenGL blend functions</span>
0524 Screen(<span class="string">'BlendFunction'</span>, winPtr, GL_SRC_ALPHA, GL_ONE_MINUS_SRC_ALPHA);
0525 
0526 
0527 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0528 <span class="comment">%%%% Initializing MATLAB OpenGL shader API</span>
0529 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0530 
0531 <span class="comment">% just call DrawTextureWithCLUT with window pointer alone</span>
0532 <a href="../../Retinotopy/Common/DrawTextureWithCLUT.html" class="code" title="function DrawTextureWithCLUT(win, src, newclut, srcRect, destRect, rotangle)">DrawTextureWithCLUT</a>(winPtr);
0533 
0534 
0535 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0536 <span class="comment">%%%% Displaying 'Initializing...'</span>
0537 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0538 
0539 <span class="comment">% displaying texts on the center of the screen</span>
0540 <a href="../../Retinotopy/Common/DisplayMessage2.html" class="code" title="function DisplayMessage2(message,bgcolor,winPtr,numScreens,drawing_font,drawing_size)">DisplayMessage2</a>(<span class="string">'Initializing...'</span>,sparam.bgcolor,winPtr,nScr,<span class="string">'Arial'</span>,36);
0541 
0542 
0543 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0544 <span class="comment">%%%% Initializing variables</span>
0545 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0546 
0547 <span class="comment">%% unit conversion</span>
0548 
0549 <span class="comment">% cm per pix</span>
0550 sparam.cm_per_pix=1/sparam.pix_per_cm;
0551 
0552 <span class="comment">% pixles per degree</span>
0553 sparam.pix_per_deg=round( 1/( 180*atan(sparam.cm_per_pix/sparam.vdist)/pi ) );
0554 
0555 <span class="comment">% deg to radian</span>
0556 <span class="comment">% do not convert!</span>
0557 <span class="comment">% sparam.width, sparam.phase, sparam.startangle, sparam.rotangle are used in deg formats</span>
0558 
0559 <span class="comment">% number of checkerboard color</span>
0560 sparam.ncolors=(size(sparam.colors,1)-1)/2;
0561 
0562 <span class="comment">% sec to number of frames</span>
0563 nframe_fixation=round(sparam.initial_fixation_time.*dparam.fps./sparam.waitframes);
0564 nframe_stim=round((sparam.cycle_duration-sparam.rest_duration)*dparam.fps/sparam.waitframes);
0565 nframe_rest=round(sparam.rest_duration*dparam.fps/sparam.waitframes);
0566 nframe_movement=round((sparam.cycle_duration-sparam.rest_duration)*dparam.fps/(360/sparam.rotangle)/sparam.waitframes);
0567 nframe_flicker=round(nframe_movement/sparam.ncolors/4);
0568 nframe_task=round(nframe_movement/2);
0569 
0570 <span class="comment">%% initialize chackerboard parameters</span>
0571 
0572 <span class="comment">% adjust size ratio considering full-screen effect</span>
0573 <span class="keyword">if</span> dparam.fullscr
0574   <span class="comment">% here, use width information alone, assuming that the pixel is square</span>
0575   ratio_wid=( winRect(3)-winRect(1) )/dparam.ScrWidth;
0576   <span class="comment">%ratio_hei=( winRect(4)-winRect(2) )/dparam.ScrHeight;</span>
0577 
0578   <span class="comment">% min/max radius of annulus</span>
0579   rmin=sparam.minRad*ratio_wid; <span class="comment">% !!! degree, not pixel or cm !!!</span>
0580   rmax=sparam.maxRad*ratio_wid;
0581 <span class="keyword">else</span>
0582   rmin=sparam.minRad;
0583   rmax=sparam.maxRad;
0584 <span class="keyword">end</span>
0585 
0586 
0587 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0588 <span class="comment">%%%% Generating checkerboard patterns</span>
0589 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0590 
0591 <span class="comment">% [note]</span>
0592 <span class="comment">% After this processing, each checkerboard image has checker elements with values as shown below</span>
0593 <span class="comment">% 0 = background</span>
0594 <span class="comment">% 1 = checker ID 1</span>
0595 <span class="comment">% 2 = checker ID 2</span>
0596 <span class="comment">% 3 = checker ID 3</span>
0597 <span class="comment">% .....</span>
0598 <span class="comment">% sparam.npatches = checker ID</span>
0599 <span class="comment">% Each patch ID will be associated with a CLUT color of the same ID</span>
0600 <span class="keyword">if</span> strcmpi(sparam.mode,<span class="string">'ccw'</span>) || strcmpi(sparam.mode,<span class="string">'cw'</span>)
0601 
0602   sparam.npositions=360/sparam.rotangle;
0603   startangles=zeros(sparam.npositions,1);
0604   <span class="keyword">for</span> nn=1:1:sparam.npositions, startangles(nn)=sparam.startangle+(nn-1)*sparam.rotangle; <span class="keyword">end</span>
0605 
0606   [checkerboardID,checkerboard]=<a href="../../Retinotopy/Generation/pol_GenerateCheckerBoard1D.html" class="code" title="function [checkerboard,bincheckerboard,mask]=pol_GenerateCheckerBoard1D(rmin,rmax,width,startangle,pix_per_deg,nwedges,nrings,phase,dual_flg)">pol_GenerateCheckerBoard1D</a>(rmin,rmax,sparam.width,startangles,sparam.pix_per_deg,<span class="keyword">...</span>
0607                                                            sparam.nwedges,sparam.nrings,sparam.phase);
0608 
0609 <span class="keyword">elseif</span> strcmpi(sparam.mode,<span class="string">'exp'</span>) || strcmpi(sparam.mode,<span class="string">'cont'</span>)
0610 
0611   sparam.npositions=(sparam.cycle_duration-sparam.rest_duration)/(sparam.cycle_duration/(360/sparam.rotangle));
0612   eccedge=(rmax-rmin)/( sparam.npositions-1 );
0613   eccwidth=eccedge*(sparam.width/sparam.rotangle);
0614 
0615   <span class="comment">%% !!! NOTICE !!!</span>
0616   <span class="comment">% update some parameters here for 'exp' or 'cont' mode</span>
0617   nframe_movement=round((sparam.cycle_duration-sparam.rest_duration)*dparam.fps/sparam.npositions/sparam.waitframes);
0618   nframe_flicker=round(nframe_movement/sparam.ncolors/4);
0619   nframe_task=round(nframe_movement/2);
0620 
0621   <span class="comment">% get annuli's min/max lims</span>
0622   ecclims=zeros(sparam.npositions,3);
0623   <span class="keyword">for</span> nn=1:1:sparam.npositions <span class="comment">%1:1:sparam.npositions</span>
0624     minlim=rmin+(nn-1)*eccedge-eccwidth/2;
0625     <span class="keyword">if</span> minlim&lt;rmin, minlim=rmin; <span class="keyword">end</span>
0626     maxlim=rmin+(nn-1)*eccedge+eccwidth/2;
0627     <span class="keyword">if</span> maxlim&gt;rmax, maxlim=rmax; <span class="keyword">end</span>
0628 
0629     ecclims(nn,:)=[minlim,maxlim,eccwidth];
0630   <span class="keyword">end</span>
0631 
0632   [checkerboardID,checkerboard]=<a href="../../Retinotopy/Generation/ecc_GenerateCheckerBoard1D.html" class="code" title="function [checkerboard,bincheckerboard,mask]=ecc_GenerateCheckerBoard1D(edges,width,startangle,pix_per_deg,nwedges,nrings,phase)">ecc_GenerateCheckerBoard1D</a>(ecclims,360,sparam.startangle,sparam.pix_per_deg,<span class="keyword">...</span>
0633                                                            round(360*sparam.nwedges/sparam.width),sparam.nrings,sparam.phase);
0634 
0635 <span class="keyword">end</span> <span class="comment">% if strcmpi(sparam.mode,'ccw') || strcmpi(sparam.mode,'cw')</span>
0636 
0637 <span class="comment">%% flip all data for ccw/cont</span>
0638 <span class="keyword">if</span> strcmpi(sparam.mode,<span class="string">'ccw'</span>) || strcmpi(sparam.mode,<span class="string">'cont'</span>)
0639 
0640   tmp_checkerboardID=cell(sparam.npositions,1);
0641   <span class="keyword">for</span> nn=1:1:sparam.npositions, tmp_checkerboardID{nn}=checkerboardID{sparam.npositions-(nn-1)}; <span class="keyword">end</span>
0642   checkerboardID=tmp_checkerboardID;
0643   clear tmp_checkerboardID;
0644 
0645   tmp_checkerboard=cell(sparam.npositions,1);
0646   <span class="keyword">for</span> nn=1:1:sparam.npositions, tmp_checkerboard{nn}=checkerboard{sparam.npositions-(nn-1)}; <span class="keyword">end</span>
0647   checkerboard=tmp_checkerboard;
0648   clear tmp_checkerboard;
0649 
0650 <span class="keyword">end</span>
0651 
0652 
0653 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0654 <span class="comment">%%%% Initializing Color Lookup-Table (CLUT)</span>
0655 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0656 
0657 <span class="comment">% [note]</span>
0658 <span class="comment">% all checker color/luminance flickering is realized by just flipping CLUT generated here</span>
0659 <span class="comment">% to save memory and CPU power</span>
0660 
0661 CLUT=cell(sparam.ncolors,2); <span class="comment">% 2 is for compensating patterns</span>
0662 
0663 <span class="comment">% generate base CLUT</span>
0664 <span class="keyword">for</span> cc=1:1:sparam.ncolors
0665   <span class="keyword">for</span> pp=1:1:2 <span class="comment">% compensating checkers</span>
0666 
0667     <span class="comment">% initialize, DrawTextureWithCLUT requires [256x4] color lookup table even when we do not use whole 256 colors</span>
0668     <span class="comment">% though DrawTextureWithCLUT does not support alpha transparency up to now...</span>
0669     CLUT{cc,pp}=zeros(256,4);
0670     CLUT{cc,pp}(:,4)=1; <span class="comment">% default alpha is 1 (no transparent)</span>
0671 
0672     CLUT{cc,pp}(1,:)=[sparam.colors(1,:),0]; <span class="comment">% background LUT, default alpha is 0 (invisible);</span>
0673 
0674     <span class="keyword">if</span> ~mod(pp,2)
0675       CLUT{cc,pp}(2,1:3)=sparam.colors(2*cc,:);
0676       CLUT{cc,pp}(3,1:3)=sparam.colors(2*cc+1,:);
0677       CLUT{cc,pp}(4,1:3)=sparam.dimratio.*sparam.colors(2*cc,:);
0678       CLUT{cc,pp}(5,1:3)=sparam.dimratio.*sparam.colors(2*cc+1,:);
0679     <span class="keyword">else</span>
0680       CLUT{cc,pp}(2,1:3)=sparam.colors(2*cc+1,:);
0681       CLUT{cc,pp}(3,1:3)=sparam.colors(2*cc,:);
0682       CLUT{cc,pp}(4,1:3)=sparam.dimratio.*sparam.colors(2*cc+1,:);
0683       CLUT{cc,pp}(5,1:3)=sparam.dimratio.*sparam.colors(2*cc,:);
0684     <span class="keyword">end</span>
0685 
0686   <span class="keyword">end</span> <span class="comment">% for pp=1:1:2 % compensating checkers</span>
0687 <span class="keyword">end</span> <span class="comment">% for cc=1:1:sparam.ncolors</span>
0688 
0689 
0690 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0691 <span class="comment">%%%% Debug codes</span>
0692 <span class="comment">%%%% saving the stimulus images as *.png format files and enter the debug (keyboard) mode</span>
0693 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0694 
0695 <span class="comment">% %%%%%% DEBUG codes start here</span>
0696 <span class="comment">% note: debug stimuli have no jitters of binocular disparity</span>
0697 <span class="keyword">if</span> strfind(upper(subjID),<span class="string">'DEBUG'</span>)
0698 
0699   <span class="comment">% just to get stimulus figures</span>
0700   Screen(<span class="string">'CloseAll'</span>);
0701   save_dir=fullfile(resultDir,<span class="string">'images_cretinotopy'</span>);
0702   <span class="keyword">if</span> ~exist(save_dir,<span class="string">'dir'</span>), mkdir(save_dir); <span class="keyword">end</span>
0703 
0704   figure; hold off;
0705   <span class="keyword">for</span> nn=1:1:sparam.npositions
0706     imagesc(checkerboard{nn}+1,[1,numel(unique(checkerboard{nn}))]);
0707     axis off; axis equal;
0708 
0709     <span class="keyword">for</span> cc=1:1:sparam.ncolors
0710       <span class="keyword">for</span> pp=1:1:2 <span class="comment">% compensating checkers</span>
0711         colormap(CLUT{cc,pp}(1:3,1:3)./255);
0712         drawnow;
0713         pause(0.05);
0714         imwrite(checkerboard{nn}+1,CLUT{cc,pp}(1:3,1:3)./255,fullfile(save_dir,sprintf(<span class="string">'retinotopy_%s_pos_%02d_lut_%02d_%02d.png'</span>,sparam.mode,nn,cc,pp)),<span class="string">'png'</span>); <span class="comment">% +1 is required as the image index is assumed to be started from 1.</span>
0715       <span class="keyword">end</span>
0716     <span class="keyword">end</span>
0717 
0718   <span class="keyword">end</span>
0719   close all;
0720   save(fullfile(save_dir,sprintf(<span class="string">'stimulus_%s.mat'</span>,sparam.mode)),<span class="string">'checkerboard'</span>,<span class="string">'sparam'</span>,<span class="string">'dparam'</span>,<span class="string">'CLUT'</span>);
0721   keyboard;
0722 
0723 <span class="keyword">end</span> <span class="comment">% if strfind(upper(subjID),'DEBUG')</span>
0724 <span class="comment">% %%%%%% DEBUG code ends here</span>
0725 
0726 
0727 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0728 <span class="comment">%%%% Generating contrast detection task parameters</span>
0729 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0730 
0731 <span class="comment">%% set task variables</span>
0732 <span class="comment">% flag to decide in which period (first half or second half) the disparity task is applied</span>
0733 <span class="comment">% about task_flg:</span>
0734 <span class="comment">% 1, task is added in the first half period</span>
0735 <span class="comment">% 2, task is added in the second half period</span>
0736 task_flg=randi(2,[ceil(sparam.numRepeats*nframe_stim/nframe_task),1]);
0737 
0738 <span class="comment">% flag whether presenting disparity task</span>
0739 do_task=zeros(ceil(sparam.numRepeats*nframe_stim/nframe_task),1);
0740 do_task(1)=0; <span class="comment">% no task for the first presentation</span>
0741 <span class="keyword">for</span> ii=2:1:ceil(sparam.numRepeats*nframe_stim/nframe_task)
0742   <span class="keyword">if</span> do_task(ii-1)==1
0743     do_task(ii)=0;
0744   <span class="keyword">else</span>
0745     do_task(ii)=round(rand(1,1));
0746   <span class="keyword">end</span>
0747 <span class="keyword">end</span>
0748 
0749 <span class="comment">% variable to store the current task array order</span>
0750 task_id=1;
0751 
0752 <span class="comment">% variable to store task position</span>
0753 task_pos=cell(sparam.npositions,1);
0754 <span class="keyword">for</span> nn=1:1:sparam.npositions
0755   task_pos{nn}=randi(numel(unique(checkerboardID{nn}))-1,[ceil(sparam.numRepeats*nframe_stim/nframe_task),1]);
0756 <span class="keyword">end</span>
0757 
0758 <span class="comment">% flag to index the first task frame</span>
0759 firsttask_flg=0;
0760 
0761 
0762 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0763 <span class="comment">%%%% Initializing checkerboard color management parameters</span>
0764 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0765 
0766 <span class="comment">% checkerboard color id</span>
0767 color_id=1;
0768 
0769 <span class="comment">% checkerboard compensating color id</span>
0770 compensate_id=1;
0771 
0772 <span class="comment">% variable to store the current rotation/disparity id</span>
0773 stim_pos_id=1;
0774 
0775 
0776 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0777 <span class="comment">%%%% Creating background images</span>
0778 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0779 
0780 <span class="keyword">if</span> sparam.bgtype==1 <span class="comment">% a simple background with sparam.bgcolor</span>
0781   bgimg{1}=repmat(reshape(sparam.colors(1,:),[1,1,3]),[dparam.ScrHeight,dparam.ScrWidth]);
0782 
0783 <span class="keyword">elseif</span> sparam.bgtype==2 <span class="comment">% a background with grid guides</span>
0784 
0785   <span class="comment">% calculate the central aperture size of the background image</span>
0786   edgeY=mod(dparam.ScrHeight,sparam.patch_num(1)); <span class="comment">% delete the exceeded region</span>
0787   p_height=round((dparam.ScrHeight-edgeY)/sparam.patch_num(1)); <span class="comment">% height in pix of patch_height + interval-Y</span>
0788 
0789   edgeX=mod(dparam.ScrWidth,sparam.patch_num(2)); <span class="comment">% delete exceeded region</span>
0790   p_width=round((dparam.ScrWidth-edgeX)/sparam.patch_num(2)); <span class="comment">% width in pix of patch_width + interval-X</span>
0791 
0792   <span class="keyword">if</span> dparam.fullscr
0793     aperture_size=[2*( p_height*ceil( size(checkerboard{1},1)/2*( (winRect(4)-winRect(2))/dparam.ScrHeight ) /p_height ) ),<span class="keyword">...</span>
0794                    2*( p_width*ceil( size(checkerboard{1},2)/2*( (winRect(3)-winRect(1))/dparam.ScrWidth ) /p_width ) )];
0795   <span class="keyword">else</span>
0796     aperture_size=[2*( p_height*ceil(size(checkerboard{1},1)/2/p_height) ),<span class="keyword">...</span>
0797                    2*( p_width*ceil(size(checkerboard{1},2)/2/p_width) )];
0798   <span class="keyword">end</span>
0799 
0800   bgimg=<a href="../../Retinotopy/Common/CreateBackgroundImage.html" class="code" title="function [Bimg,parameters] = CreateBackgroundImage(wdims,stdims,pdims,bgcolor,color1,color2,fixcolor,patchnum,fix_flag,save_flag,show_flag)">CreateBackgroundImage</a>([dparam.ScrHeight,dparam.ScrWidth],aperture_size,sparam.patch_size,sparam.bgcolor,sparam.patch_color1,sparam.patch_color2,sparam.fixcolor,sparam.patch_num,0,0,0);
0801 <span class="keyword">else</span>
0802   error(<span class="string">'sparam.bgtype should be 1 or 2. check the input variable.'</span>);
0803 <span class="keyword">end</span>
0804 
0805 background=Screen(<span class="string">'MakeTexture'</span>,winPtr,bgimg{1});
0806 
0807 
0808 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0809 <span class="comment">%%%% Creating the central fixation, cross images</span>
0810 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0811 
0812 <span class="comment">% Create fixation cross images.</span>
0813 <span class="comment">% Firstly larger fixations are generated, then they are antialiased. This is required to present a beautiful circle</span>
0814 
0815 <span class="keyword">if</span> sparam.fixtype==1 <span class="comment">% circular fixation</span>
0816   fixW=<a href="../../Retinotopy/Common/CreateFixationImgCircular.html" class="code" title="function fix=CreateFixationImgCircular(fixsize,fixcolor,bgcolor,circlesize,show_flag,save_flag)">CreateFixationImgCircular</a>(4*sparam.fixsize,sparam.fixcolor,sparam.bgcolor,4*sparam.fixsize,0,0);
0817   fixD=<a href="../../Retinotopy/Common/CreateFixationImgCircular.html" class="code" title="function fix=CreateFixationImgCircular(fixsize,fixcolor,bgcolor,circlesize,show_flag,save_flag)">CreateFixationImgCircular</a>(4*sparam.fixsize,[64,64,64],sparam.bgcolor,4*sparam.fixsize,0,0);
0818 <span class="keyword">elseif</span> sparam.fixtype==2 <span class="comment">% rectangular fixation</span>
0819   fixW=<a href="../../Retinotopy/Common/CreateFixationImgMono.html" class="code" title="function fix=CreateFixationImgMono(fixsize,fixcolor,bgcolor,fixlinew,fixlineh,show_flag,save_flag)">CreateFixationImgMono</a>(4*sparam.fixsize,sparam.fixcolor,sparam.bgcolor,4*2,4*ceil(0.4*sparam.fixsize),0,0);
0820   fixD=<a href="../../Retinotopy/Common/CreateFixationImgMono.html" class="code" title="function fix=CreateFixationImgMono(fixsize,fixcolor,bgcolor,fixlinew,fixlineh,show_flag,save_flag)">CreateFixationImgMono</a>(4*sparam.fixsize,[64,64,64],sparam.bgcolor,4*2,4*ceil(0.4*sparam.fixsize),0,0);
0821 <span class="keyword">elseif</span> sparam.fixtype==3 <span class="comment">% concentric fixation</span>
0822   fixW=<a href="../../Retinotopy/Common/CreateFixationImgConcentrateMono.html" class="code" title="function fix=CreateFixationImgConcentrateMono(fixsize,fixcolor,bgcolor,circlesize,gap,show_flag,save_flag)">CreateFixationImgConcentrateMono</a>(4*sparam.fixsize,sparam.fixcolor,sparam.bgcolor,4*[2,ceil(0.8*sparam.fixsize)],0,0,0);
0823   fixD=<a href="../../Retinotopy/Common/CreateFixationImgConcentrateMono.html" class="code" title="function fix=CreateFixationImgConcentrateMono(fixsize,fixcolor,bgcolor,circlesize,gap,show_flag,save_flag)">CreateFixationImgConcentrateMono</a>(4*sparam.fixsize,[64,64,64],sparam.bgcolor,4*[2,ceil(0.8*sparam.fixsize)],0,0,0);
0824 <span class="keyword">else</span>
0825   error(<span class="string">'sparam.fixtype should be one of 1,2, and 3. check the input variable.'</span>);
0826 <span class="keyword">end</span>
0827 fixW=imresize(fixW,0.25);
0828 fixD=imresize(fixD,0.25);
0829 
0830 fix=cell(2,1); <span class="comment">% 1 is for default fixation, 2 is for darker fixation (luminance detection task)</span>
0831 fix{1}=Screen(<span class="string">'MakeTexture'</span>,winPtr,fixW);
0832 fix{2}=Screen(<span class="string">'MakeTexture'</span>,winPtr,fixD);
0833 
0834 
0835 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0836 <span class="comment">%%%% Prepare blue lines for stereo image flip sync with VPixx PROPixx</span>
0837 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0838 
0839 <span class="comment">% There seems to be a blueline generation bug on some OpenGL systems.</span>
0840 <span class="comment">% SetStereoBlueLineSyncParameters(winPtr, winRect(4)) corrects the</span>
0841 <span class="comment">% bug on some systems, but breaks on other systems.</span>
0842 <span class="comment">% We'll just disable automatic blueline, and manually draw our own bluelines!</span>
0843 
0844 <span class="keyword">if</span> strcmpi(dparam.ExpMode,<span class="string">'propixxstereo'</span>)
0845   SetStereoBlueLineSyncParameters(winPtr, winRect(4)+10);
0846   blueRectOn(1,:)=[0, winRect(4)-1, winRect(3)/4, winRect(4)];
0847   blueRectOn(2,:)=[0, winRect(4)-1, winRect(3)*3/4, winRect(4)];
0848   blueRectOff(1,:)=[winRect(3)/4, winRect(4)-1, winRect(3), winRect(4)];
0849   blueRectOff(2,:)=[winRect(3)*3/4, winRect(4)-1, winRect(3), winRect(4)];
0850 <span class="keyword">end</span>
0851 
0852 
0853 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0854 <span class="comment">%%%% Image size adjusting to match the current display resolutions</span>
0855 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0856 
0857 <span class="keyword">if</span> dparam.fullscr
0858   ratio_wid= ( winRect(3)-winRect(1) )/dparam.ScrWidth;
0859   ratio_hei= ( winRect(4)-winRect(2) )/dparam.ScrHeight;
0860   bgSize   = [size(bgimg{1},2)*ratio_wid, size(bgimg{1},1)*ratio_hei];
0861   stimSize = [size(checkerboard{1},2)*ratio_wid, size(checkerboard{1},1)*ratio_hei];
0862   fixSize  = [2*sparam.fixsize*ratio_wid, 2*sparam.fixsize*ratio_hei];
0863 <span class="keyword">else</span>
0864   bgSize   = [dparam.ScrWidth, dparam.ScrHeight];
0865   stimSize = [size(checkerboard{1},2), size(checkerboard{1},1)];
0866   fixSize  = [2*sparam.fixsize, 2*sparam.fixsize];
0867 <span class="keyword">end</span>
0868 
0869 <span class="comment">% for some display modes in which one screen is splitted into two binocular displays</span>
0870 <span class="keyword">if</span> strcmpi(dparam.ExpMode,<span class="string">'cross'</span>) || strcmpi(dparam.ExpMode,<span class="string">'parallel'</span>) || <span class="keyword">...</span>
0871    strcmpi(dparam.ExpMode,<span class="string">'topbottom'</span>) || strcmpi(dparam.ExpMode,<span class="string">'bottomtop'</span>)
0872   bgSize=bgSize./2;
0873   stimSize=stimSize./2;
0874   fixSize=fixSize./2;
0875 <span class="keyword">end</span>
0876 
0877 bgRect  = [0, 0, bgSize]; <span class="comment">% used to display background images;</span>
0878 stimRect= [0, 0, stimSize];
0879 fixRect = [0, 0, fixSize]; <span class="comment">% used to display the central fixation point</span>
0880 
0881 
0882 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0883 <span class="comment">%%%% Displaying 'Ready to Start'</span>
0884 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0885 
0886 <span class="comment">% displaying texts on the center of the screen</span>
0887 <a href="../../Retinotopy/Common/DisplayMessage2.html" class="code" title="function DisplayMessage2(message,bgcolor,winPtr,numScreens,drawing_font,drawing_size)">DisplayMessage2</a>(<span class="string">'Ready to Start'</span>,sparam.bgcolor,winPtr,nScr,<span class="string">'Arial'</span>,36);
0888 ttime=GetSecs(); <span class="keyword">while</span> (GetSecs()-ttime &lt; 0.5), <span class="keyword">end</span>  <span class="comment">% run up the clock.</span>
0889 
0890 
0891 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0892 <span class="comment">%%%% Flip the display(s) to the background image(s)</span>
0893 <span class="comment">%%%% and inform the ready of stimulus presentation</span>
0894 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0895 
0896 <span class="comment">% change the screen and wait for the trigger or pressing the start button</span>
0897 <span class="keyword">for</span> nn=1:1:nScr
0898   Screen(<span class="string">'SelectStereoDrawBuffer'</span>,winPtr,nn-1);
0899   Screen(<span class="string">'DrawTexture'</span>,winPtr,background,[],CenterRect(bgRect,winRect));
0900   Screen(<span class="string">'DrawTexture'</span>,winPtr,fix{2},[],CenterRect(fixRect,winRect));
0901 
0902   <span class="comment">% blue line for stereo sync</span>
0903   <span class="keyword">if</span> strcmpi(dparam.ExpMode,<span class="string">'propixxstereo'</span>)
0904     Screen(<span class="string">'FillRect'</span>,winPtr,[0,0,255],blueRectOn(nn,:));
0905     Screen(<span class="string">'FillRect'</span>,winPtr,[0,0,0],blueRectOff(nn,:));
0906   <span class="keyword">end</span>
0907 <span class="keyword">end</span>
0908 Screen(<span class="string">'DrawingFinished'</span>,winPtr);
0909 Screen(<span class="string">'Flip'</span>, winPtr,[],[],[],1);
0910 
0911 <span class="comment">% prepare the next frame for the initial fixation period</span>
0912 <span class="keyword">for</span> nn=1:1:nScr
0913   Screen(<span class="string">'SelectStereoDrawBuffer'</span>,winPtr,nn-1);
0914   Screen(<span class="string">'DrawTexture'</span>,winPtr,background,[],CenterRect(bgRect,winRect));
0915   Screen(<span class="string">'DrawTexture'</span>,winPtr,fix{1},[],CenterRect(fixRect,winRect));
0916 
0917   <span class="comment">% blue line for stereo sync</span>
0918   <span class="keyword">if</span> strcmpi(dparam.ExpMode,<span class="string">'propixxstereo'</span>)
0919     Screen(<span class="string">'FillRect'</span>,winPtr,[0,0,255],blueRectOn(nn,:));
0920     Screen(<span class="string">'FillRect'</span>,winPtr,[0,0,0],blueRectOff(nn,:));
0921   <span class="keyword">end</span>
0922 <span class="keyword">end</span>
0923 Screen(<span class="string">'DrawingFinished'</span>,winPtr);
0924 
0925 
0926 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0927 <span class="comment">%%%% Wait for the first trigger pulse from fMRI scanner or start with button pressing</span>
0928 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0929 
0930 <span class="comment">% add time stamp (this also works to load add_event method in memory in advance of the actual displays)</span>
0931 fprintf(<span class="string">'\nWaiting for the start...\n'</span>);
0932 event=event.add_event(<span class="string">'Experiment Start'</span>,strcat([datestr(now,<span class="string">'yymmdd'</span>),<span class="string">' '</span>,datestr(now,<span class="string">'HH:mm:ss'</span>)]),NaN);
0933 
0934 <span class="comment">% waiting for stimulus presentation</span>
0935 resps.wait_stimulus_presentation(dparam.start_method,dparam.custom_trigger);
0936 <span class="comment">%PlaySound(1);</span>
0937 fprintf(<span class="string">'\nExperiment running...\n'</span>);
0938 
0939 
0940 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0941 <span class="comment">%%%% Initial Fixation Period</span>
0942 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0943 
0944 vbl=Screen(<span class="string">'Flip'</span>,winPtr,[],[],[],1); <span class="comment">% the first flip</span>
0945 [event,the_experiment_start]=event.set_reference_time(vbl);
0946 event=event.add_event(<span class="string">'Initial Fixation'</span>,[]);
0947 fprintf(<span class="string">'\nfixation\n\n'</span>);
0948 
0949 <span class="comment">% wait for the initial fixation</span>
0950 <span class="keyword">for</span> ff=1:1:nframe_fixation(1)
0951   <span class="keyword">for</span> nn=1:1:nScr
0952     Screen(<span class="string">'SelectStereoDrawBuffer'</span>,winPtr,nn-1);
0953     Screen(<span class="string">'DrawTexture'</span>,winPtr,background,[],CenterRect(bgRect,winRect));
0954     Screen(<span class="string">'DrawTexture'</span>,winPtr,fix{1},[],CenterRect(fixRect,winRect));
0955 
0956     <span class="comment">% blue line for stereo sync</span>
0957     <span class="keyword">if</span> strcmpi(dparam.ExpMode,<span class="string">'propixxstereo'</span>)
0958       Screen(<span class="string">'FillRect'</span>,winPtr,[0,0,255],blueRectOn(nn,:));
0959       Screen(<span class="string">'FillRect'</span>,winPtr,[0,0,0],blueRectOff(nn,:));
0960     <span class="keyword">end</span>
0961   <span class="keyword">end</span>
0962   Screen(<span class="string">'DrawingFinished'</span>,winPtr);
0963   <span class="keyword">while</span> GetSecs()&lt;vbl+(ff*sparam.waitframes-0.5)*dparam.ifi, [resps,event]=resps.check_responses(event); <span class="keyword">end</span>
0964   Screen(<span class="string">'Flip'</span>,winPtr,[],[],[],1);
0965 <span class="keyword">end</span>
0966 
0967 
0968 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0969 <span class="comment">%%%% The Trial Loop</span>
0970 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0971 
0972 <span class="keyword">for</span> cc=1:1:sparam.numRepeats
0973 
0974   <span class="comment">%% rest perioed</span>
0975   <span class="keyword">if</span> ( strcmpi(sparam.mode,<span class="string">'cw'</span>) || strcmpi(sparam.mode,<span class="string">'cont'</span>) ) &amp;&amp; nframe_rest~=0
0976     <span class="keyword">for</span> ff=1:1:nframe_rest
0977       <span class="keyword">for</span> nn=1:1:nScr
0978         Screen(<span class="string">'SelectStereoDrawBuffer'</span>,winPtr,nn-1);
0979         <span class="comment">% background &amp; the central fixation</span>
0980         Screen(<span class="string">'DrawTexture'</span>,winPtr,background,[],CenterRect(bgRect,winRect));
0981         Screen(<span class="string">'DrawTexture'</span>,winPtr,fix{1},[],CenterRect(fixRect,winRect));
0982 
0983         <span class="comment">% blue line for stereo sync</span>
0984         <span class="keyword">if</span> strcmpi(dparam.ExpMode,<span class="string">'propixxstereo'</span>)
0985           Screen(<span class="string">'FillRect'</span>,winPtr,[0,0,255],blueRectOn(nn,:));
0986           Screen(<span class="string">'FillRect'</span>,winPtr,[0,0,0],blueRectOff(nn,:));
0987         <span class="keyword">end</span>
0988       <span class="keyword">end</span>
0989 
0990       <span class="comment">% flip the window</span>
0991       Screen(<span class="string">'DrawingFinished'</span>,winPtr);
0992       <span class="keyword">while</span> GetSecs()&lt;vbl+sparam.initial_fixation_time(1)+(cc-1)*sparam.cycle_duration+((ff-1)*sparam.waitframes-0.5)*dparam.ifi, [resps,event]=resps.check_responses(event); <span class="keyword">end</span>
0993       Screen(<span class="string">'Flip'</span>,winPtr,[],[],[],1);
0994 
0995       <span class="keyword">if</span> ff==1
0996         event=event.add_event(sprintf(<span class="string">'Cycle: %d'</span>,cc),[]);
0997         fprintf(sprintf(<span class="string">'Cycle: %03d...\n'</span>,cc));
0998       <span class="keyword">end</span>
0999     <span class="keyword">end</span>
1000   <span class="keyword">end</span>
1001 
1002   <span class="comment">%% stimulus presentation loop</span>
1003   <span class="keyword">for</span> ff=1:1:nframe_stim
1004 
1005     <span class="comment">% generate a checkerboard texture with/without a luminance detection task</span>
1006     <span class="keyword">if</span> do_task(task_id) &amp;&amp; <span class="keyword">...</span>
1007       ( ( task_flg(task_id)==1 &amp;&amp; mod(ff,nframe_movement)&lt;=nframe_movement/2 ) || <span class="keyword">...</span>
1008         ( task_flg(task_id)==2 &amp;&amp; mod(ff,nframe_movement)&gt;nframe_movement/2 ) )
1009       tidx=find(checkerboardID{stim_pos_id}==task_pos{stim_pos_id}(task_id));
1010       checkerboard{stim_pos_id}(tidx)=checkerboard{stim_pos_id}(tidx)+2; <span class="comment">% here +2 is for a dim checker pattern. for details, please see codes in generating CLUT.</span>
1011       checkertexture=Screen(<span class="string">'MakeTexture'</span>,winPtr,checkerboard{stim_pos_id});
1012       checkerboard{stim_pos_id}(tidx)=checkerboard{stim_pos_id}(tidx)-2; <span class="comment">% put the checkerboard ID back to the default</span>
1013     <span class="keyword">else</span>
1014       tidx=[];
1015       checkertexture=Screen(<span class="string">'MakeTexture'</span>,winPtr,checkerboard{stim_pos_id});
1016     <span class="keyword">end</span>
1017 
1018     <span class="comment">%% display the current frame</span>
1019     <span class="keyword">for</span> nn=1:1:nScr
1020       Screen(<span class="string">'SelectStereoDrawBuffer'</span>,winPtr,nn-1);
1021       Screen(<span class="string">'DrawTexture'</span>,winPtr,background,[],CenterRect(bgRect,winRect)); <span class="comment">% background</span>
1022       <a href="../../Retinotopy/Common/DrawTextureWithCLUT.html" class="code" title="function DrawTextureWithCLUT(win, src, newclut, srcRect, destRect, rotangle)">DrawTextureWithCLUT</a>(winPtr,checkertexture,CLUT{color_id,compensate_id},[],CenterRect(stimRect,winRect)); <span class="comment">% checkerboard</span>
1023       Screen(<span class="string">'DrawTexture'</span>,winPtr,fix{1},[],CenterRect(fixRect,winRect)); <span class="comment">% the central fixation oval</span>
1024 
1025       <span class="comment">% blue line for stereo sync</span>
1026       <span class="keyword">if</span> strcmpi(dparam.ExpMode,<span class="string">'propixxstereo'</span>)
1027         Screen(<span class="string">'FillRect'</span>,winPtr,[0,0,255],blueRectOn(nn,:));
1028         Screen(<span class="string">'FillRect'</span>,winPtr,[0,0,0],blueRectOff(nn,:));
1029       <span class="keyword">end</span>
1030     <span class="keyword">end</span>
1031 
1032     <span class="comment">% flip the window</span>
1033     Screen(<span class="string">'DrawingFinished'</span>,winPtr);
1034     <span class="keyword">if</span> strcmpi(sparam.mode,<span class="string">'cw'</span>) || strcmpi(sparam.mode,<span class="string">'cont'</span>)
1035       <span class="keyword">while</span> GetSecs()&lt;vbl+sparam.initial_fixation_time(1)+(cc-1)*sparam.cycle_duration+sparam.rest_duration+((ff-1)*sparam.waitframes-0.5)*dparam.ifi, [resps,event]=resps.check_responses(event); <span class="keyword">end</span>
1036     <span class="keyword">else</span>
1037       <span class="keyword">while</span> GetSecs()&lt;vbl+sparam.initial_fixation_time(1)+(cc-1)*sparam.cycle_duration+((ff-1)*sparam.waitframes-0.5)*dparam.ifi, [resps,event]=resps.check_responses(event); <span class="keyword">end</span>
1038     <span class="keyword">end</span>
1039     Screen(<span class="string">'Flip'</span>,winPtr,[],[],[],1);
1040 
1041     <span class="keyword">if</span> ff==1 &amp;&amp; ( ( ~strcmpi(sparam.mode,<span class="string">'cw'</span>) &amp;&amp; ~strcmpi(sparam.mode,<span class="string">'cont'</span>) ) || <span class="keyword">...</span>
1042                   ( ( strcmpi(sparam.mode,<span class="string">'cw'</span>) || strcmpi(sparam.mode,<span class="string">'cont'</span>) ) &amp;&amp; nframe_rest==0 ) )
1043       event=event.add_event(sprintf(<span class="string">'Cycle: %d'</span>,cc),[]);
1044       fprintf(sprintf(<span class="string">'Cycle: %03d...\n'</span>,cc));
1045     <span class="keyword">end</span>
1046 
1047     <span class="keyword">if</span> firsttask_flg==1 &amp;&amp; ( do_task(task_id) &amp;&amp; <span class="keyword">...</span>
1048        ( ( task_flg(task_id)==1 &amp;&amp; mod(ff,nframe_movement)&lt;=nframe_movement/2 ) || <span class="keyword">...</span>
1049          ( task_flg(task_id)==2 &amp;&amp; mod(ff,nframe_movement)&gt;nframe_movement/2 ) ) ), event=event.add_event(<span class="string">'Luminance Task'</span>,[]); <span class="keyword">end</span>
1050 
1051     <span class="comment">% clean up</span>
1052     Screen(<span class="string">'Close'</span>,checkertexture);
1053 
1054     <span class="comment">%% exit from the loop if the final frame is displayed</span>
1055     <span class="keyword">if</span> ff==nframe_stim &amp;&amp; cc==sparam.numRepeats, <span class="keyword">continue</span>; <span class="keyword">end</span>
1056 
1057     <span class="comment">%% update IDs</span>
1058 
1059     <span class="comment">% flickering checkerboard</span>
1060     <span class="keyword">if</span> ~mod(ff,nframe_flicker) <span class="comment">% color reversal</span>
1061       compensate_id=mod(compensate_id,2)+1;
1062     <span class="keyword">end</span>
1063 
1064     <span class="keyword">if</span> ~mod(ff,2*nframe_flicker) <span class="comment">% color change</span>
1065       color_id=color_id+1;
1066       <span class="keyword">if</span> color_id&gt;sparam.ncolors, color_id=1; <span class="keyword">end</span>
1067     <span class="keyword">end</span>
1068 
1069     <span class="comment">% stimulus position id for the next presentation</span>
1070     <span class="keyword">if</span> ~mod(ff,nframe_movement)
1071       stim_pos_id=stim_pos_id+1;
1072       <span class="keyword">if</span> stim_pos_id&gt;sparam.npositions, stim_pos_id=1; <span class="keyword">end</span>
1073     <span class="keyword">end</span>
1074 
1075     <span class="comment">%% update task. about task_flg: 1, task is added in the first half period. 2, task is added in the second half period</span>
1076     <span class="keyword">if</span> ~mod(ff,nframe_task), task_id=task_id+1; firsttask_flg=0; <span class="keyword">end</span>
1077     firsttask_flg=firsttask_flg+1;
1078   <span class="keyword">end</span> <span class="comment">% for ff=1:1:nframe_stim</span>
1079 
1080   <span class="comment">%% rest perioed</span>
1081   <span class="keyword">if</span> strcmpi(sparam.mode,<span class="string">'ccw'</span>) || strcmpi(sparam.mode,<span class="string">'exp'</span>)
1082     <span class="keyword">for</span> ff=1:1:nframe_rest
1083       <span class="keyword">for</span> nn=1:1:nScr
1084         Screen(<span class="string">'SelectStereoDrawBuffer'</span>,winPtr,nn-1);
1085         Screen(<span class="string">'DrawTexture'</span>,winPtr,background,[],CenterRect(bgRect,winRect));
1086         Screen(<span class="string">'DrawTexture'</span>,winPtr,fix{1},[],CenterRect(fixRect,winRect));
1087 
1088         <span class="comment">% blue line for stereo sync</span>
1089         <span class="keyword">if</span> strcmpi(dparam.ExpMode,<span class="string">'propixxstereo'</span>)
1090           Screen(<span class="string">'FillRect'</span>,winPtr,[0,0,255],blueRectOn(nn,:));
1091           Screen(<span class="string">'FillRect'</span>,winPtr,[0,0,0],blueRectOff(nn,:));
1092         <span class="keyword">end</span>
1093       <span class="keyword">end</span>
1094 
1095       <span class="comment">% flip the window</span>
1096       Screen(<span class="string">'DrawingFinished'</span>,winPtr);
1097       <span class="keyword">while</span> GetSecs()&lt;vbl+sparam.initial_fixation_time(1)+(cc-1)*sparam.cycle_duration+(sparam.cycle_duration-sparam.rest_duration)+((ff-1)*sparam.waitframes-0.5)*dparam.ifi, [resps,event]=resps.check_responses(event); <span class="keyword">end</span>
1098       Screen(<span class="string">'Flip'</span>,winPtr,[],[],[],1);
1099     <span class="keyword">end</span>
1100   <span class="keyword">end</span>
1101 
1102 <span class="keyword">end</span> <span class="comment">% for cc=1:1:sparam.numRepeats</span>
1103 
1104 
1105 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
1106 <span class="comment">%%%% Final Fixation</span>
1107 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
1108 
1109 <span class="keyword">for</span> nn=1:1:nScr
1110   Screen(<span class="string">'SelectStereoDrawBuffer'</span>,winPtr,nn-1);
1111   Screen(<span class="string">'DrawTexture'</span>,winPtr,background,[],CenterRect(bgRect,winRect));
1112   Screen(<span class="string">'DrawTexture'</span>,winPtr,fix{1},[],CenterRect(fixRect,winRect));
1113 
1114   <span class="comment">% blue line for stereo sync</span>
1115   <span class="keyword">if</span> strcmpi(dparam.ExpMode,<span class="string">'propixxstereo'</span>)
1116     Screen(<span class="string">'FillRect'</span>,winPtr,[0,0,255],blueRectOn(nn,:));
1117     Screen(<span class="string">'FillRect'</span>,winPtr,[0,0,0],blueRectOff(nn,:));
1118   <span class="keyword">end</span>
1119 <span class="keyword">end</span>
1120 Screen(<span class="string">'DrawingFinished'</span>,winPtr);
1121 <span class="keyword">while</span> GetSecs()&lt;vbl+sparam.initial_fixation_time(1)+sparam.numRepeats*sparam.cycle_duration-0.5*dparam.ifi, [resps,event]=resps.check_responses(event); <span class="keyword">end</span>
1122 Screen(<span class="string">'Flip'</span>,winPtr,[],[],[],1);
1123 event=event.add_event(<span class="string">'Final Fixation'</span>,[]);
1124 fprintf(<span class="string">'\nfixation\n'</span>);
1125 
1126 <span class="comment">% wait for the initial fixation</span>
1127 <span class="keyword">for</span> ff=1:1:nframe_fixation(2)
1128   <span class="keyword">for</span> nn=1:1:nScr
1129     Screen(<span class="string">'SelectStereoDrawBuffer'</span>,winPtr,nn-1);
1130     Screen(<span class="string">'DrawTexture'</span>,winPtr,background,[],CenterRect(bgRect,winRect));
1131     Screen(<span class="string">'DrawTexture'</span>,winPtr,fix{1},[],CenterRect(fixRect,winRect));
1132 
1133     <span class="comment">% blue line for stereo sync</span>
1134     <span class="keyword">if</span> strcmpi(dparam.ExpMode,<span class="string">'propixxstereo'</span>)
1135       Screen(<span class="string">'FillRect'</span>,winPtr,[0,0,255],blueRectOn(nn,:));
1136       Screen(<span class="string">'FillRect'</span>,winPtr,[0,0,0],blueRectOff(nn,:));
1137     <span class="keyword">end</span>
1138   <span class="keyword">end</span>
1139   Screen(<span class="string">'DrawingFinished'</span>,winPtr);
1140   <span class="keyword">while</span> GetSecs()&lt;vbl+sparam.initial_fixation_time(1)+sparam.numRepeats*sparam.cycle_duration+(ff*sparam.waitframes-0.5)*dparam.ifi, [resps,event]=resps.check_responses(event); <span class="keyword">end</span>
1141   Screen(<span class="string">'Flip'</span>,winPtr,[],[],[],1);
1142 <span class="keyword">end</span>
1143 
1144 <span class="comment">% the final clock up</span>
1145 <span class="keyword">while</span> GetSecs()-the_experiment_start&lt;sum(sparam.initial_fixation_time)+sparam.numRepeats*sparam.cycle_duration
1146   [resps,event]=resps.check_responses(event);
1147 <span class="keyword">end</span>
1148 
1149 
1150 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
1151 <span class="comment">%%%% Experiment &amp; scanner end here</span>
1152 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
1153 
1154 experimentDuration=GetSecs()-the_experiment_start;
1155 event=event.add_event(<span class="string">'End'</span>,[]);
1156 fprintf(<span class="string">'\n'</span>);
1157 fprintf(<span class="string">'Experiment Completed: %.2f/%.2f secs\n'</span>,experimentDuration,<span class="keyword">...</span>
1158         sum(sparam.initial_fixation_time)+sparam.numRepeats*sparam.cycle_duration);
1159 fprintf(<span class="string">'\n'</span>);
1160 
1161 
1162 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
1163 <span class="comment">%%%% Cleaning up MATLAB OpenGL shader API</span>
1164 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
1165 
1166 <span class="comment">% just call DrawTextureWithCLUT without any input argument</span>
1167 <a href="../../Retinotopy/Common/DrawTextureWithCLUT.html" class="code" title="function DrawTextureWithCLUT(win, src, newclut, srcRect, destRect, rotangle)">DrawTextureWithCLUT</a>();
1168 
1169 
1170 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
1171 <span class="comment">%%%% Cleaning up the PTB screen</span>
1172 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
1173 
1174 Screen(<span class="string">'CloseAll'</span>);
1175 
1176 <span class="comment">% closing datapixx</span>
1177 <span class="keyword">if</span> strcmpi(dparam.ExpMode,<span class="string">'propixxmono'</span>) || strcmpi(dparam.ExpMode,<span class="string">'propixxstereo'</span>)
1178   <span class="keyword">if</span> Datapixx(<span class="string">'IsViewpixx3D'</span>)
1179     Datapixx(<span class="string">'DisableVideoLcd3D60Hz'</span>);
1180     Datapixx(<span class="string">'RegWr'</span>);
1181   <span class="keyword">end</span>
1182   Datapixx(<span class="string">'Close'</span>);
1183 <span class="keyword">end</span>
1184 
1185 ShowCursor();
1186 Priority(0);
1187 <a href="../../Retinotopy/Common/GammaResetPTB.html" class="code" title="function GammaResetPTB(luminance_ratio)">GammaResetPTB</a>(1.0);
1188 
1189 
1190 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
1191 <span class="comment">%%%% Write data into file for post analysis</span>
1192 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
1193 
1194 <span class="comment">% saving the results</span>
1195 fprintf(<span class="string">'saving data...'</span>);
1196 
1197 <span class="comment">% save data</span>
1198 savefname=fullfile(resultDir,[num2str(subjID),<span class="string">'_cretinotopy_'</span>,sparam.mode,<span class="string">'_results_run_'</span>,num2str(acq,<span class="string">'%02d'</span>),<span class="string">'.mat'</span>]);
1199 
1200 <span class="comment">% backup the old file(s)</span>
1201 <span class="keyword">if</span> ~overwrite_flg
1202   <a href="../../Retinotopy/Common/BackUpObsoleteFiles.html" class="code" title="function [new_fname,backup_fname]=BackUpObsoleteFiles(tgt_dir,tgt_fname,backup_prefix)">BackUpObsoleteFiles</a>(fullfile(<span class="string">'subjects'</span>,num2str(subjID),<span class="string">'results'</span>,today),<span class="keyword">...</span>
1203                       [num2str(subjID),<span class="string">'_cretinotopy_'</span>,sparam.mode,<span class="string">'_results_run_'</span>,num2str(acq,<span class="string">'%02d'</span>),<span class="string">'.mat'</span>],<span class="string">'_old'</span>);
1204 <span class="keyword">end</span>
1205 
1206 eval(sprintf(<span class="string">'save %s subjID acq sparam dparam event gamma_table;'</span>,savefname));
1207 fprintf(<span class="string">'done.\n'</span>);
1208 
1209 <span class="comment">% calculate &amp; display task performance</span>
1210 fprintf(<span class="string">'calculating task accuracy...\n'</span>);
1211 correct_event=cell(2,1); <span class="keyword">for</span> ii=1:1:2, correct_event{ii}=sprintf(<span class="string">'key%d'</span>,ii); <span class="keyword">end</span>
1212 [task.numTasks,task.numHits,task.numErrors,task.numResponses,task.RT]=event.calc_accuracy(correct_event);
1213 event=event.get_event(); <span class="comment">% convert an event logger object to a cell data structure</span>
1214 eval(sprintf(<span class="string">'save -append %s event task;'</span>,savefname));
1215 fprintf(<span class="string">'done.\n'</span>);
1216 
1217 
1218 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
1219 <span class="comment">%%%% Removing path to the subfunctions, and finalizing the script</span>
1220 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
1221 
1222 rmpath(genpath(fullfile(rootDir,<span class="string">'..'</span>,<span class="string">'Common'</span>)));
1223 rmpath(fullfile(rootDir,<span class="string">'..'</span>,<span class="string">'Generation'</span>));
1224 clear all; clear mex; clear <span class="keyword">global</span>;
1225 diary off;
1226 
1227 
1228 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
1229 <span class="comment">%%%% tell the experimenter that the measurements are completed</span>
1230 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
1231 
1232 <span class="keyword">try</span>
1233   <span class="keyword">for</span> ii=1:1:3, Snd(<span class="string">'Play'</span>,sin(2*pi*0.2*(0:900)),8000); <span class="keyword">end</span>
1234 <span class="keyword">catch</span>
1235   <span class="comment">% do nothing</span>
1236 <span class="keyword">end</span>
1237 
1238 
1239 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
1240 <span class="comment">%%%% Catch the errors</span>
1241 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
1242 
1243 <span class="keyword">catch</span> <span class="comment">%lasterror</span>
1244   <span class="comment">% this &quot;catch&quot; section executes in case of an error in the &quot;try&quot; section</span>
1245   <span class="comment">% above.  Importantly, it closes the onscreen window if its open.</span>
1246   Screen(<span class="string">'CloseAll'</span>);
1247 
1248   <span class="keyword">if</span> exist(<span class="string">'dparam'</span>,<span class="string">'var'</span>)
1249     <span class="keyword">if</span> <a href="../../Retinotopy/Common/isstructmember.html" class="code" title="function isFieldResult = isstructmember(inStruct, fieldName)">isstructmember</a>(dparam,<span class="string">'ExpMode'</span>)
1250       <span class="keyword">if</span> strcmpi(dparam.ExpMode,<span class="string">'propixxmono'</span>) || strcmpi(dparam.ExpMode,<span class="string">'propixxstereo'</span>)
1251         <span class="keyword">if</span> Datapixx(<span class="string">'IsViewpixx3D'</span>)
1252           Datapixx(<span class="string">'DisableVideoLcd3D60Hz'</span>);
1253           Datapixx(<span class="string">'RegWr'</span>);
1254         <span class="keyword">end</span>
1255         Datapixx(<span class="string">'Close'</span>);
1256       <span class="keyword">end</span>
1257     <span class="keyword">end</span>
1258   <span class="keyword">end</span>
1259 
1260   ShowCursor();
1261   Priority(0);
1262   <a href="../../Retinotopy/Common/GammaResetPTB.html" class="code" title="function GammaResetPTB(luminance_ratio)">GammaResetPTB</a>(1.0);
1263   tmp=lasterror; <span class="comment">%#ok</span>
1264   <span class="comment">%if exist('event','var'), event=event.get_event(); end %#ok % just for debugging</span>
1265   diary off;
1266   fprintf([<span class="string">'\nError detected and the program was terminated.\n'</span>,<span class="keyword">...</span>
1267            <span class="string">'To check error(s), please type ''tmp''.\n'</span>,<span class="keyword">...</span>
1268            <span class="string">'Please save the current variables now if you need.\n'</span>,<span class="keyword">...</span>
1269            <span class="string">'Then, quit by ''dbquit''\n'</span>]);
1270   keyboard;
1271   rmpath(genpath(fullfile(rootDir,<span class="string">'..'</span>,<span class="string">'Common'</span>)));
1272   rmpath(fullfile(rootDir,<span class="string">'..'</span>,<span class="string">'Generation'</span>));
1273   clear all; clear mex; clear <span class="keyword">global</span>;
1274   <span class="keyword">return</span>
1275 <span class="keyword">end</span> <span class="comment">% try..catch</span>
1276 
1277 
1278 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
1279 <span class="comment">%%%%% That's it - we're done</span>
1280 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
1281 <span class="keyword">return</span>;
1282 <span class="comment">% end % function cretinotopy</span></pre></div>
<hr><address>Generated on Wed 09-Jun-2021 14:56:30 by <strong><a href="http://www.artefact.tk/software/matlab/m2html/" target="_parent">m2html</a></strong> &copy; 2005 using a BVQX_hbtools customized template</address>
</body>
</html>