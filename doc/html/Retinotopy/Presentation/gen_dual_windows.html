<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
                "http://www.w3.org/TR/REC-html40/loose.dtd">
<html>
<head>
  <title>Description of gen_dual_windows</title>
  <meta name="keywords" content="gen_dual_windows">
  <meta name="description" content="Generates retinotopy stimulus (polar wedge + eccentricity annulus) windows for pRF (population receptive field) analysis.">
  <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
  <meta name="generator" content="m2html &copy; 2005 Guillaume Flandin">
  <meta name="robots" content="index, follow">
  <link type="text/css" rel="stylesheet" href="../../m2html.css">
  <script type="text/javascript">
    if (top.frames.length == 0) { top.location = "../../index.html"; };
  </script>
</head>
<body>
<a name="_top"></a>
<!-- # Retinotopy --><!-- menu.html Presentation -->
<h1>gen_dual_windows
</h1>

<h2><a name="_name"></a>PURPOSE <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
<div class="box"><strong>Generates retinotopy stimulus (polar wedge + eccentricity annulus) windows for pRF (population receptive field) analysis.</strong></div>

<h2><a name="_synopsis"></a>SYNOPSIS <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
<div class="box"><strong>function stim_windows=gen_dual_windows(subjID,exp_mode,acq,displayfile,stimulusfile,overwrite_pix_per_deg,TR) </strong></div>

<h2><a name="_description"></a>DESCRIPTION <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
<div class="fragment" style="background-image:url(../../hb_brain.png); background-position:right top"><pre class="comment"> Generates retinotopy stimulus (polar wedge + eccentricity annulus) windows for pRF (population receptive field) analysis.
 function stim_windows=gen_dual_windows(subjID,exp_mode,acq,:displayfile,:stimulusfile,:overwrite_pix_per_deg,:TR)
 (: is optional)

 - This function generates stimulus windows corresponding to the color/luminance-defined
   checkerboard stimuli, cdual and cdual_fixtask, in which a wedge (polar angle) and an
   annulus (eccentricity) are simultaneously presented. The generated stimulus windows
   can be used to generate pRF (population receptive field) models.

   references: 1. Population receptive field estimates in human visual cortex.
                  Dumoulin, S.O. and Wandell, B.A. (2008). Neuroimage, 39(2), 647-660.
               2. Borders of multiple visual areas in humans revealed by functional magnetic resonance imaging.
                  Sereno MI, Dale AM, Reppas JB, Kwong KK, Belliveau JW, Brady TJ, Rosen BR, Tootell RB. (1995).
                  Science 268(5212), 889-893.
               3. fMRI of human visual cortex.
                  Engel SA, Rumelhart DE, Wandell BA, Lee AT, Glover GH, Chichilnisky EJ, Shadlen MN. (1994).
                  Nature, 369(6481), 525.
               4. Visual field maps in human cortex.
                  Wandell BA, Dumoulin SO, Brewer AA. (2007). Neuron, 56(2), 366-383.


 Created    : &quot;2019-01-25 12:30:39 ban&quot;
 Last Update: &quot;2021-03-29 15:49:54 ban&quot;



 [input variables]
 sujID         : ID of subject, string, such as 's01'
                 you also need to create a directory ./subjects/(subj) and put displayfile and stimulusfile there.
 exp_mode      : experiment mode that you want to run, one of
  - ccwexp : a checkerboard wedge rotating counter-clockwisely + an expanding annulus
  - cwexp  : a checkerboard wedge rotating clockwisely + an expanding annulus
  - ccwcont: a checkerboard wedge rotating counter-clockwisely + a contracting annulus
  - cwcont : a checkerboard wedge rotating clockwisely + a contracting annulus
 acq           : acquisition number (design file number),
                 an integer, such as 1, 2, 3, ...
 displayfile   : (optional) display condition file,
                 *.m file, such as 'RetDepth_display_fmri.m'
                 the file should be located in ./subjects/(subj)/
 stimulusfile  : (optional) stimulus condition file,
                 *.m file, such as 'RetDepth_stimulus_exp1.m'
                 the file should be located in ./subjects/(subj)/
 overwrite_pix_per_deg : (optional) pixels-per-deg value to overwrite the sparam.pix_per_deg
                 if not specified, sparam.pix_per_deg is used to reconstruct
                 stim_windows.
                 This is useful to reconstruct stim_windows with less memory space
                 1/pix_per_deg = spatial resolution of the generated visual field,
                 e.g. when pix_per_deg=20, then, 1 pixel = 0.05 deg.
                 empty (use sparam.pix_per_deg) by default
 TR            : (optional) TR used in fMRI scans, in sec, 2 by default

 !!! NOTICE !!!!
 displayfile &amp; stimulusfile should be located at
 ./subjects/(subjID)/
 as ./subjects/(subjID)/*_display_fmri.m
    ./subjects/(subjID)/*_stimuli.m


 [output variables]
 stim_windows : stimulus windows (logical images) at each TR, [row,col,TRs] matrix


 [output files]
 1. result file
    stored ./subjects/(subjID)/pRF/(date)
    as ./subjects/(subjID)/pRF/(date)/(subjID)_stimulus_window_(exp_mode)_run_XX.mat


 [example]
 &gt;&gt; stim_windows=gen_dual_windows('HB','ccwexp',1,'retinotopy_display.m','c_pol.m',10,2);

 [About displayfile]
 The contents of the displayfile are as below.
 (The file includs 6 lines of headers and following display parameters)

 (an example of the displayfile)

 % ************************************************************
 % This is the display configuration file for the retinotopy stimuli
 % Programmed by Hiroshi Ban Nov 01 2013
 % ************************************************************

 %%% the resolution of the screen height
 dparam.ScrHeight=1200;

 %% the resolution of the screen width
 dparam.ScrWidth=1920;


 [About stimulusfile]
 The contents of the stimulusfile are as below.
 (The file includs 6 lines of headers and following stimulus parameters)

 (an example of the stimulusfile)

 % ************************************************************
 % This is the stimulus parameter file for the dual (wedge + annulus) retinotopy stimulus
 % Programmed by Hiroshi Ban Jan 25 2019
 % ************************************************************

 % &quot;sparam&quot; means &quot;stimulus generation parameters&quot;

 %%% stimulus parameters
 sparam.pol_width       = 48;    % wedge width in deg along polar angle
 sparam.pol_rotangle    = 12;    % rotation angle in deg
 sparam.pol_startangle  = -sparam.pol_width/2-90; % presentation start angle in deg, from right-horizontal meridian, ccw

 sparam.ecc_width       = sparam.pol_width/2;
 sparam.ecc_rotangle    = sparam.pol_rotangle;
 sparam.ecc_startangle  = -sparam.ecc_width/2-90;  % presentation start angle in deg, from right-horizontal meridian, ccw (actually this value is not used for the eccentricity stimuli (exp and cont))

 sparam.maxRad      = 6.0    % maximum radius of  annulus (degrees)
 sparam.minRad      = 0;    % minumum

 %%% duration in msec for each cycle &amp; repetitions
 % ===========================================================================================================================================
 % IMPORTANT NOTE: sparam.pol_cycle_duration x sparam.pol_numRepeats should be the same with sparam.ecc_cycle_duration x sparam.ecc_numRepeats
 % ===========================================================================================================================================

 sparam.pol_cycle_duration=60000; % msec
 sparam.pol_rest_duration =0; % msec, rest after each cycle, stimulation = cycle_duration-eccrest
 sparam.pol_numRepeats=6;

 sparam.ecc_cycle_duration=40000; % msec
 sparam.ecc_rest_duration =8000; % msec, rest after each cycle, stimulation = cycle_duration-eccrest
 sparam.ecc_numRepeats=9;

 %%% fixation period in msec before/after presenting the target stimuli, integer
 % must set a value more than 1 TR for initializing the frame counting.
 sparam.initial_fixation_time=[4000,4000];

 %%% fixation size &amp; color
 sparam.fixsize=12; % radius in pixels
 sparam.fixcolor=[255,255,255];

 %%% for converting degree to pixels
 run(fullfile(fileparts(mfilename('fullpath')),'sizeparams'));
 %sparam.pix_per_cm=57.1429;
 %sparam.vdist=65;


 [HOWTO create stimulus files]
 1. All of the stimuli are created in this script in real-time
    with MATLAB scripts &amp; functions.
    see ../Generation &amp; ../Common directries.
 2. Stimulus parameters are defined in the display &amp; stimulus file.


 [about stimuli and task]
 The central fixation point sometimes changes its color from white to gray.
 If you find this contrast difference, press any key.
 Response kes are difined in display file.


 [reference]
 for stmulus generation, see ../Generation &amp; ../Common directories.</pre></div>

<!-- crossreference -->
<h2><a name="_cross"></a>CROSS-REFERENCE INFORMATION <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
<div class="fragment" style="background-image:url(../../hb_brain.png); background-position:right top">
This function calls:
<ul style="list-style-image:url(../../matlabicon.gif)">
<li><a href="../../Retinotopy/Common/ValidateStructureFields.html" class="code" title="function structval=ValidateStructureFields(structval,varargin)">ValidateStructureFields</a>	Validates the input structure and set the default values to the missing field(s)</li><li><a href="../../Retinotopy/Generation/ecc_GenerateCheckerBoard1D.html" class="code" title="function [checkerboard,bincheckerboard,mask]=ecc_GenerateCheckerBoard1D(edges,width,startangle,pix_per_deg,nwedges,nrings,phase)">ecc_GenerateCheckerBoard1D</a>	Generates checkerboard patterns (annulus-based subdivision) with an individual ID number on each patch.</li><li><a href="../../Retinotopy/Generation/pol_GenerateCheckerBoard1D.html" class="code" title="function [checkerboard,bincheckerboard,mask]=pol_GenerateCheckerBoard1D(rmin,rmax,width,startangle,pix_per_deg,nwedges,nrings,phase,dual_flg)">pol_GenerateCheckerBoard1D</a>	Generates checkerboard patterns (polar angle-based subdivision) with an individual ID number on each patch.</li></ul>
This function is called by:
<ul style="list-style-image:url(../../matlabicon.gif)">
<li><a href="script_gen_all_windows_BVQX_hbtools.html" class="code" title="function script_gen_all_windows_BVQX_hbtools(subj,pix_per_deg,TR)">script_gen_all_windows_BVQX_hbtools</a>	a simple script to generate all the retinotopy stimulus windows for pRF analyses, which are compatible with the BVQX_hbtools's pRF analysis routines.</li></ul>
</div>
<!-- crossreference -->



<h2><a name="_source"></a>SOURCE CODE <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
<div class="fragment" style="background-image:url(../../hb_brain.png); background-position:right top"><pre>0001 <a name="_sub0" href="#_subfunctions" class="code">function stim_windows=gen_dual_windows(subjID,exp_mode,acq,displayfile,stimulusfile,overwrite_pix_per_deg,TR)</a>
0002 
0003 <span class="comment">% Generates retinotopy stimulus (polar wedge + eccentricity annulus) windows for pRF (population receptive field) analysis.</span>
0004 <span class="comment">% function stim_windows=gen_dual_windows(subjID,exp_mode,acq,:displayfile,:stimulusfile,:overwrite_pix_per_deg,:TR)</span>
0005 <span class="comment">% (: is optional)</span>
0006 <span class="comment">%</span>
0007 <span class="comment">% - This function generates stimulus windows corresponding to the color/luminance-defined</span>
0008 <span class="comment">%   checkerboard stimuli, cdual and cdual_fixtask, in which a wedge (polar angle) and an</span>
0009 <span class="comment">%   annulus (eccentricity) are simultaneously presented. The generated stimulus windows</span>
0010 <span class="comment">%   can be used to generate pRF (population receptive field) models.</span>
0011 <span class="comment">%</span>
0012 <span class="comment">%   references: 1. Population receptive field estimates in human visual cortex.</span>
0013 <span class="comment">%                  Dumoulin, S.O. and Wandell, B.A. (2008). Neuroimage, 39(2), 647-660.</span>
0014 <span class="comment">%               2. Borders of multiple visual areas in humans revealed by functional magnetic resonance imaging.</span>
0015 <span class="comment">%                  Sereno MI, Dale AM, Reppas JB, Kwong KK, Belliveau JW, Brady TJ, Rosen BR, Tootell RB. (1995).</span>
0016 <span class="comment">%                  Science 268(5212), 889-893.</span>
0017 <span class="comment">%               3. fMRI of human visual cortex.</span>
0018 <span class="comment">%                  Engel SA, Rumelhart DE, Wandell BA, Lee AT, Glover GH, Chichilnisky EJ, Shadlen MN. (1994).</span>
0019 <span class="comment">%                  Nature, 369(6481), 525.</span>
0020 <span class="comment">%               4. Visual field maps in human cortex.</span>
0021 <span class="comment">%                  Wandell BA, Dumoulin SO, Brewer AA. (2007). Neuron, 56(2), 366-383.</span>
0022 <span class="comment">%</span>
0023 <span class="comment">%</span>
0024 <span class="comment">% Created    : &quot;2019-01-25 12:30:39 ban&quot;</span>
0025 <span class="comment">% Last Update: &quot;2021-03-29 15:49:54 ban&quot;</span>
0026 <span class="comment">%</span>
0027 <span class="comment">%</span>
0028 <span class="comment">%</span>
0029 <span class="comment">% [input variables]</span>
0030 <span class="comment">% sujID         : ID of subject, string, such as 's01'</span>
0031 <span class="comment">%                 you also need to create a directory ./subjects/(subj) and put displayfile and stimulusfile there.</span>
0032 <span class="comment">% exp_mode      : experiment mode that you want to run, one of</span>
0033 <span class="comment">%  - ccwexp : a checkerboard wedge rotating counter-clockwisely + an expanding annulus</span>
0034 <span class="comment">%  - cwexp  : a checkerboard wedge rotating clockwisely + an expanding annulus</span>
0035 <span class="comment">%  - ccwcont: a checkerboard wedge rotating counter-clockwisely + a contracting annulus</span>
0036 <span class="comment">%  - cwcont : a checkerboard wedge rotating clockwisely + a contracting annulus</span>
0037 <span class="comment">% acq           : acquisition number (design file number),</span>
0038 <span class="comment">%                 an integer, such as 1, 2, 3, ...</span>
0039 <span class="comment">% displayfile   : (optional) display condition file,</span>
0040 <span class="comment">%                 *.m file, such as 'RetDepth_display_fmri.m'</span>
0041 <span class="comment">%                 the file should be located in ./subjects/(subj)/</span>
0042 <span class="comment">% stimulusfile  : (optional) stimulus condition file,</span>
0043 <span class="comment">%                 *.m file, such as 'RetDepth_stimulus_exp1.m'</span>
0044 <span class="comment">%                 the file should be located in ./subjects/(subj)/</span>
0045 <span class="comment">% overwrite_pix_per_deg : (optional) pixels-per-deg value to overwrite the sparam.pix_per_deg</span>
0046 <span class="comment">%                 if not specified, sparam.pix_per_deg is used to reconstruct</span>
0047 <span class="comment">%                 stim_windows.</span>
0048 <span class="comment">%                 This is useful to reconstruct stim_windows with less memory space</span>
0049 <span class="comment">%                 1/pix_per_deg = spatial resolution of the generated visual field,</span>
0050 <span class="comment">%                 e.g. when pix_per_deg=20, then, 1 pixel = 0.05 deg.</span>
0051 <span class="comment">%                 empty (use sparam.pix_per_deg) by default</span>
0052 <span class="comment">% TR            : (optional) TR used in fMRI scans, in sec, 2 by default</span>
0053 <span class="comment">%</span>
0054 <span class="comment">% !!! NOTICE !!!!</span>
0055 <span class="comment">% displayfile &amp; stimulusfile should be located at</span>
0056 <span class="comment">% ./subjects/(subjID)/</span>
0057 <span class="comment">% as ./subjects/(subjID)/*_display_fmri.m</span>
0058 <span class="comment">%    ./subjects/(subjID)/*_stimuli.m</span>
0059 <span class="comment">%</span>
0060 <span class="comment">%</span>
0061 <span class="comment">% [output variables]</span>
0062 <span class="comment">% stim_windows : stimulus windows (logical images) at each TR, [row,col,TRs] matrix</span>
0063 <span class="comment">%</span>
0064 <span class="comment">%</span>
0065 <span class="comment">% [output files]</span>
0066 <span class="comment">% 1. result file</span>
0067 <span class="comment">%    stored ./subjects/(subjID)/pRF/(date)</span>
0068 <span class="comment">%    as ./subjects/(subjID)/pRF/(date)/(subjID)_stimulus_window_(exp_mode)_run_XX.mat</span>
0069 <span class="comment">%</span>
0070 <span class="comment">%</span>
0071 <span class="comment">% [example]</span>
0072 <span class="comment">% &gt;&gt; stim_windows=gen_dual_windows('HB','ccwexp',1,'retinotopy_display.m','c_pol.m',10,2);</span>
0073 <span class="comment">%</span>
0074 <span class="comment">% [About displayfile]</span>
0075 <span class="comment">% The contents of the displayfile are as below.</span>
0076 <span class="comment">% (The file includs 6 lines of headers and following display parameters)</span>
0077 <span class="comment">%</span>
0078 <span class="comment">% (an example of the displayfile)</span>
0079 <span class="comment">%</span>
0080 <span class="comment">% % ************************************************************</span>
0081 <span class="comment">% % This is the display configuration file for the retinotopy stimuli</span>
0082 <span class="comment">% % Programmed by Hiroshi Ban Nov 01 2013</span>
0083 <span class="comment">% % ************************************************************</span>
0084 <span class="comment">%</span>
0085 <span class="comment">% %%% the resolution of the screen height</span>
0086 <span class="comment">% dparam.ScrHeight=1200;</span>
0087 <span class="comment">%</span>
0088 <span class="comment">% %% the resolution of the screen width</span>
0089 <span class="comment">% dparam.ScrWidth=1920;</span>
0090 <span class="comment">%</span>
0091 <span class="comment">%</span>
0092 <span class="comment">% [About stimulusfile]</span>
0093 <span class="comment">% The contents of the stimulusfile are as below.</span>
0094 <span class="comment">% (The file includs 6 lines of headers and following stimulus parameters)</span>
0095 <span class="comment">%</span>
0096 <span class="comment">% (an example of the stimulusfile)</span>
0097 <span class="comment">%</span>
0098 <span class="comment">% % ************************************************************</span>
0099 <span class="comment">% % This is the stimulus parameter file for the dual (wedge + annulus) retinotopy stimulus</span>
0100 <span class="comment">% % Programmed by Hiroshi Ban Jan 25 2019</span>
0101 <span class="comment">% % ************************************************************</span>
0102 <span class="comment">%</span>
0103 <span class="comment">% % &quot;sparam&quot; means &quot;stimulus generation parameters&quot;</span>
0104 <span class="comment">%</span>
0105 <span class="comment">% %%% stimulus parameters</span>
0106 <span class="comment">% sparam.pol_width       = 48;    % wedge width in deg along polar angle</span>
0107 <span class="comment">% sparam.pol_rotangle    = 12;    % rotation angle in deg</span>
0108 <span class="comment">% sparam.pol_startangle  = -sparam.pol_width/2-90; % presentation start angle in deg, from right-horizontal meridian, ccw</span>
0109 <span class="comment">%</span>
0110 <span class="comment">% sparam.ecc_width       = sparam.pol_width/2;</span>
0111 <span class="comment">% sparam.ecc_rotangle    = sparam.pol_rotangle;</span>
0112 <span class="comment">% sparam.ecc_startangle  = -sparam.ecc_width/2-90;  % presentation start angle in deg, from right-horizontal meridian, ccw (actually this value is not used for the eccentricity stimuli (exp and cont))</span>
0113 <span class="comment">%</span>
0114 <span class="comment">% sparam.maxRad      = 6.0    % maximum radius of  annulus (degrees)</span>
0115 <span class="comment">% sparam.minRad      = 0;    % minumum</span>
0116 <span class="comment">%</span>
0117 <span class="comment">% %%% duration in msec for each cycle &amp; repetitions</span>
0118 <span class="comment">% % ===========================================================================================================================================</span>
0119 <span class="comment">% % IMPORTANT NOTE: sparam.pol_cycle_duration x sparam.pol_numRepeats should be the same with sparam.ecc_cycle_duration x sparam.ecc_numRepeats</span>
0120 <span class="comment">% % ===========================================================================================================================================</span>
0121 <span class="comment">%</span>
0122 <span class="comment">% sparam.pol_cycle_duration=60000; % msec</span>
0123 <span class="comment">% sparam.pol_rest_duration =0; % msec, rest after each cycle, stimulation = cycle_duration-eccrest</span>
0124 <span class="comment">% sparam.pol_numRepeats=6;</span>
0125 <span class="comment">%</span>
0126 <span class="comment">% sparam.ecc_cycle_duration=40000; % msec</span>
0127 <span class="comment">% sparam.ecc_rest_duration =8000; % msec, rest after each cycle, stimulation = cycle_duration-eccrest</span>
0128 <span class="comment">% sparam.ecc_numRepeats=9;</span>
0129 <span class="comment">%</span>
0130 <span class="comment">% %%% fixation period in msec before/after presenting the target stimuli, integer</span>
0131 <span class="comment">% % must set a value more than 1 TR for initializing the frame counting.</span>
0132 <span class="comment">% sparam.initial_fixation_time=[4000,4000];</span>
0133 <span class="comment">%</span>
0134 <span class="comment">% %%% fixation size &amp; color</span>
0135 <span class="comment">% sparam.fixsize=12; % radius in pixels</span>
0136 <span class="comment">% sparam.fixcolor=[255,255,255];</span>
0137 <span class="comment">%</span>
0138 <span class="comment">% %%% for converting degree to pixels</span>
0139 <span class="comment">% run(fullfile(fileparts(mfilename('fullpath')),'sizeparams'));</span>
0140 <span class="comment">% %sparam.pix_per_cm=57.1429;</span>
0141 <span class="comment">% %sparam.vdist=65;</span>
0142 <span class="comment">%</span>
0143 <span class="comment">%</span>
0144 <span class="comment">% [HOWTO create stimulus files]</span>
0145 <span class="comment">% 1. All of the stimuli are created in this script in real-time</span>
0146 <span class="comment">%    with MATLAB scripts &amp; functions.</span>
0147 <span class="comment">%    see ../Generation &amp; ../Common directries.</span>
0148 <span class="comment">% 2. Stimulus parameters are defined in the display &amp; stimulus file.</span>
0149 <span class="comment">%</span>
0150 <span class="comment">%</span>
0151 <span class="comment">% [about stimuli and task]</span>
0152 <span class="comment">% The central fixation point sometimes changes its color from white to gray.</span>
0153 <span class="comment">% If you find this contrast difference, press any key.</span>
0154 <span class="comment">% Response kes are difined in display file.</span>
0155 <span class="comment">%</span>
0156 <span class="comment">%</span>
0157 <span class="comment">% [reference]</span>
0158 <span class="comment">% for stmulus generation, see ../Generation &amp; ../Common directories.</span>
0159 
0160 
0161 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0162 <span class="comment">%%%% Check the input variables</span>
0163 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0164 
0165 clear <span class="keyword">global</span>; clear mex;
0166 <span class="keyword">if</span> nargin&lt;3, help(mfilename()); <span class="keyword">return</span>; <span class="keyword">end</span>
0167 <span class="keyword">if</span> nargin&lt;4 || isempty(displayfile), displayfile=[]; <span class="keyword">end</span>
0168 <span class="keyword">if</span> nargin&lt;5 || isempty(stimulusfile), stimulusfile=[]; <span class="keyword">end</span>
0169 <span class="keyword">if</span> nargin&lt;6 || isempty(overwrite_pix_per_deg), overwrite_pix_per_deg=[]; <span class="keyword">end</span>
0170 <span class="keyword">if</span> nargin&lt;7 || isempty(TR), TR=2; <span class="keyword">end</span>
0171 
0172 <span class="comment">% check the aqcuisition number</span>
0173 <span class="keyword">if</span> acq&lt;1, error(<span class="string">'Acquistion number must be integer and greater than zero'</span>); <span class="keyword">end</span>
0174 
0175 <span class="comment">% check the experiment mode (stimulus type)</span>
0176 <span class="keyword">if</span> ~strcmpi(exp_mode,<span class="string">'ccwexp'</span>) &amp;&amp; ~strcmpi(exp_mode,<span class="string">'cwexp'</span>) &amp;&amp; ~strcmpi(exp_mode,<span class="string">'ccwcont'</span>) &amp;&amp; ~strcmpi(exp_mode,<span class="string">'cwcont'</span>)
0177   error(<span class="string">'exp_mode should be one of &quot;ccwexp&quot;, &quot;cwexp&quot;, &quot;ccwcont&quot;, and &quot;cwcont&quot;. check the input variable.'</span>);
0178 <span class="keyword">end</span>
0179 
0180 rootDir=fileparts(mfilename(<span class="string">'fullpath'</span>));
0181 
0182 <span class="comment">% check the subject directory</span>
0183 <span class="keyword">if</span> ~exist(fullfile(rootDir,<span class="string">'subjects'</span>,subjID),<span class="string">'dir'</span>), error(<span class="string">'can not find subj directory. check the input variable.'</span>); <span class="keyword">end</span>
0184 
0185 <span class="comment">% check the display/stimulus files</span>
0186 <span class="keyword">if</span> ~isempty(displayfile)
0187   <span class="keyword">if</span> ~strcmpi(displayfile(end-1:end),<span class="string">'.m'</span>), displayfile=[displayfile,<span class="string">'.m'</span>]; <span class="keyword">end</span>
0188   <span class="keyword">if</span> ~exist(fullfile(rootDir,<span class="string">'subjects'</span>,subjID,displayfile),<span class="string">'file'</span>), error(<span class="string">'displayfile not found. check the input variable.'</span>); <span class="keyword">end</span>
0189 <span class="keyword">end</span>
0190 
0191 <span class="keyword">if</span> ~isempty(stimulusfile)
0192   <span class="keyword">if</span> ~strcmpi(stimulusfile(end-1:end),<span class="string">'.m'</span>), stimulusfile=[stimulusfile,<span class="string">'.m'</span>]; <span class="keyword">end</span>
0193   <span class="keyword">if</span> ~exist(fullfile(rootDir,<span class="string">'subjects'</span>,subjID,stimulusfile),<span class="string">'file'</span>), error(<span class="string">'stimulusfile not found. check the input variable.'</span>); <span class="keyword">end</span>
0194 <span class="keyword">end</span>
0195 
0196 
0197 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0198 <span class="comment">%%%% Add path to the subfunctions</span>
0199 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0200 
0201 <span class="comment">% add paths to the subfunctions</span>
0202 addpath(genpath(fullfile(rootDir,<span class="string">'..'</span>,<span class="string">'Common'</span>)));
0203 addpath(fullfile(rootDir,<span class="string">'..'</span>,<span class="string">'Generation'</span>));
0204 
0205 
0206 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0207 <span class="comment">%%%% For log file</span>
0208 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0209 
0210 <span class="comment">% get date</span>
0211 today=datestr(now,<span class="string">'yymmdd'</span>);
0212 
0213 <span class="comment">% result directry &amp; file</span>
0214 resultDir=fullfile(rootDir,<span class="string">'subjects'</span>,num2str(subjID),<span class="string">'pRF'</span>,today);
0215 <span class="keyword">if</span> ~exist(resultDir,<span class="string">'dir'</span>), mkdir(resultDir); <span class="keyword">end</span>
0216 
0217 <span class="comment">% record the output window</span>
0218 logfname=fullfile(resultDir,[num2str(subjID),<span class="string">'_stimulus_window_'</span>,exp_mode,<span class="string">'_run_'</span>,num2str(acq,<span class="string">'%02d'</span>),<span class="string">'.log'</span>]);
0219 diary(logfname);
0220 warning off; <span class="comment">%#ok warning('off','MATLAB:dispatcher:InexactCaseMatch');</span>
0221 
0222 
0223 <span class="comment">%%%%% try &amp; catch %%%%%</span>
0224 <span class="keyword">try</span>
0225 
0226 
0227 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0228 <span class="comment">%%%% Validate dparam (displayfile) and sparam (stimulusfile) structures</span>
0229 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0230 
0231 <span class="comment">% organize dparam</span>
0232 dparam=struct(); <span class="comment">% initialize</span>
0233 <span class="keyword">if</span> ~isempty(displayfile), run(fullfile(rootDir,<span class="string">'subjects'</span>,subjID,displayfile)); <span class="keyword">end</span> <span class="comment">% load specific dparam parameters configured for each of the participants</span>
0234 dparam=<a href="../../Retinotopy/Common/ValidateStructureFields.html" class="code" title="function structval=ValidateStructureFields(structval,varargin)">ValidateStructureFields</a>(dparam,<span class="keyword">...</span><span class="comment"> % validate fields and set the default values to missing field(s)</span>
0235          <span class="string">'ScrHeight'</span>,1200,<span class="keyword">...</span>
0236          <span class="string">'ScrWidth'</span>,1920);
0237 
0238 <span class="comment">% organize sparam</span>
0239 sparam=struct(); <span class="comment">% initialize</span>
0240 sparam.mode=exp_mode;
0241 <span class="keyword">if</span> ~isempty(stimulusfile), run(fullfile(rootDir,<span class="string">'subjects'</span>,subjID,stimulusfile)); <span class="keyword">end</span> <span class="comment">% load specific sparam parameters configured for each of the participants</span>
0242 sparam=<a href="../../Retinotopy/Common/ValidateStructureFields.html" class="code" title="function structval=ValidateStructureFields(structval,varargin)">ValidateStructureFields</a>(sparam,<span class="keyword">...</span><span class="comment"> % validate fields and set the default values to missing field(s)</span>
0243          <span class="string">'pol_width'</span>,48,<span class="keyword">...</span>
0244          <span class="string">'pol_rotangle'</span>,12,<span class="keyword">...</span>
0245          <span class="string">'pol_startangle'</span>,-48/2-90,<span class="keyword">...</span>
0246          <span class="string">'ecc_width'</span>,48,<span class="keyword">...</span>
0247          <span class="string">'ecc_rotangle'</span>,12,<span class="keyword">...</span>
0248          <span class="string">'ecc_startangle'</span>,-48/2-90,<span class="keyword">...</span>
0249          <span class="string">'maxRad'</span>,8,<span class="keyword">...</span>
0250          <span class="string">'minRad'</span>,0,<span class="keyword">...</span>
0251          <span class="string">'pol_cycle_duration'</span>,60000,<span class="keyword">...</span>
0252          <span class="string">'pol_rest_duration'</span>,0,<span class="keyword">...</span>
0253          <span class="string">'pol_numRepeats'</span>,6,<span class="keyword">...</span>
0254          <span class="string">'ecc_cycle_duration'</span>,40000,<span class="keyword">...</span>
0255          <span class="string">'ecc_rest_duration'</span>,8000,<span class="keyword">...</span>
0256          <span class="string">'ecc_numRepeats'</span>,9,<span class="keyword">...</span>
0257          <span class="string">'initial_fixation_time'</span>,[4000,4000],<span class="keyword">...</span>
0258          <span class="string">'fixsize'</span>,12,<span class="keyword">...</span>
0259          <span class="string">'pix_per_cm'</span>,57.1429,<span class="keyword">...</span>
0260          <span class="string">'vdist'</span>,65);
0261 
0262 <span class="comment">% change unit from msec to sec.</span>
0263 sparam.initial_fixation_time=sparam.initial_fixation_time./1000; <span class="comment">%#ok</span>
0264 
0265 <span class="comment">% change unit from msec to sec.</span>
0266 sparam.pol_cycle_duration = sparam.pol_cycle_duration./1000;
0267 sparam.pol_rest_duration  = sparam.pol_rest_duration./1000;
0268 
0269 sparam.ecc_cycle_duration = sparam.ecc_cycle_duration./1000;
0270 sparam.ecc_rest_duration  = sparam.ecc_rest_duration./1000;
0271 
0272 <span class="comment">% set the other parameters</span>
0273 dparam.RunScript = mfilename();
0274 sparam.RunScript = mfilename();
0275 
0276 <span class="comment">%% check varidity of parameters</span>
0277 fprintf(<span class="string">'checking validity of stimulus generation/presentation parameters...'</span>);
0278 <span class="keyword">if</span> sparam.pol_cycle_duration*sparam.pol_numRepeats~=sparam.ecc_cycle_duration*sparam.ecc_numRepeats
0279   error(<span class="string">'sparam.pol_cycle_duration x sparam.pol_numRepeats should be the same with sparam.ecc_cycle_duration x sparam.ecc_numRepeats. check the input variables.'</span>);
0280 <span class="keyword">end</span>
0281 <span class="keyword">if</span> mod(360,sparam.pol_rotangle), error(<span class="string">'mod(360,sparam.pol_rotangle) should be 0. check the input variables.'</span>); <span class="keyword">end</span>
0282 <span class="keyword">if</span> mod(360,sparam.ecc_rotangle), error(<span class="string">'mod(360,sparam.ecc_rotangle) should be 0. check the input variables.'</span>); <span class="keyword">end</span>
0283 <span class="keyword">if</span> mod(sparam.pol_width,sparam.pol_rotangle), error(<span class="string">'mod(sparam.pol_width,sparam.pol_rotangle) should be 0. check the input variables.'</span>); <span class="keyword">end</span>
0284 <span class="keyword">if</span> mod(sparam.ecc_width,sparam.ecc_rotangle), error(<span class="string">'mod(sparam.ecc_width,sparam.ecc_rotangle) should be 0. check the input variables.'</span>); <span class="keyword">end</span>
0285 fprintf(<span class="string">'done.\n'</span>);
0286 
0287 
0288 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0289 <span class="comment">%%%% Displaying the presentation parameters you set</span>
0290 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0291 
0292 fprintf(<span class="string">'The Presentation Parameters are as below.\n\n'</span>);
0293 fprintf(<span class="string">'************************************************\n'</span>);
0294 fprintf(<span class="string">'****** Script, Subject, Acquistion Number ******\n'</span>);
0295 fprintf(<span class="string">'Date &amp; Time            : %s\n'</span>,strcat([datestr(now,<span class="string">'yymmdd'</span>),<span class="string">' '</span>,datestr(now,<span class="string">'HH:mm:ss'</span>)]));
0296 fprintf(<span class="string">'Running Script Name    : %s\n'</span>,mfilename());
0297 fprintf(<span class="string">'Subject ID             : %s\n'</span>,subjID);
0298 fprintf(<span class="string">'Acquisition Number     : %d\n'</span>,acq);
0299 fprintf(<span class="string">'*************** Screen Settings ****************\n'</span>);
0300 fprintf(<span class="string">'Screen Height          : %d\n'</span>,dparam.ScrHeight);
0301 fprintf(<span class="string">'Screen Width           : %d\n'</span>,dparam.ScrWidth);
0302 fprintf(<span class="string">'*********** Stimulation Periods etc. ***********\n'</span>);
0303 fprintf(<span class="string">'Fixation Time(sec)     : %d &amp; %d\n'</span>,sparam.initial_fixation_time(1),sparam.initial_fixation_time(2));
0304 fprintf(<span class="string">'[POL] Cycle Duration(sec) : %d\n'</span>,sparam.pol_cycle_duration);
0305 fprintf(<span class="string">'      Rest  Duration(sec) : %d\n'</span>,sparam.pol_rest_duration);
0306 fprintf(<span class="string">'      Repetitions(cycles) : %d\n'</span>,sparam.pol_numRepeats);
0307 fprintf(<span class="string">'[ECC] Cycle Duration(sec) : %d\n'</span>,sparam.ecc_cycle_duration);
0308 fprintf(<span class="string">'      Rest  Duration(sec) : %d\n'</span>,sparam.ecc_rest_duration);
0309 fprintf(<span class="string">'      Repetitions(cycles) : %d\n'</span>,sparam.ecc_numRepeats);
0310 fprintf(<span class="string">'Total Time (sec)       : %d\n'</span>,sum(sparam.initial_fixation_time)+sparam.pol_numRepeats*sparam.pol_cycle_duration);
0311 fprintf(<span class="string">'**************** Stimulus Type *****************\n'</span>);
0312 fprintf(<span class="string">'Experiment Mode        : %s\n'</span>,sparam.mode);
0313 fprintf(<span class="string">'************************************************\n\n'</span>);
0314 fprintf(<span class="string">'Please carefully check before proceeding.\n\n'</span>);
0315 
0316 
0317 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0318 <span class="comment">%%%% Initializing variables</span>
0319 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0320 
0321 fprintf(<span class="string">'Initializing stimulus generation variables...'</span>);
0322 
0323 <span class="comment">% difine constant variables</span>
0324 display_flg=1;
0325 pause_dur=0.2;
0326 
0327 <span class="comment">%% unit conversion</span>
0328 
0329 <span class="comment">% cm per pix</span>
0330 sparam.cm_per_pix=1/sparam.pix_per_cm;
0331 
0332 <span class="comment">% pixles per degree</span>
0333 sparam.pix_per_deg=round( 1/( 180*atan(sparam.cm_per_pix/sparam.vdist)/pi ) );
0334 
0335 <span class="comment">% overwrite pixels per degree if overwrite_pix_per_deg is given</span>
0336 <span class="keyword">if</span> ~isempty(overwrite_pix_per_deg)
0337   <span class="comment">% as fixation point is defind by pixels, we need to first resize it based on overwrite_pix_per_deg</span>
0338   sparam.fixsize=round(sparam.fixsize*overwrite_pix_per_deg/sparam.pix_per_deg);
0339   sparam.pix_per_deg=overwrite_pix_per_deg;
0340 <span class="keyword">end</span>
0341 
0342 <span class="comment">% convert sec to number of TRs</span>
0343 
0344 sparam.TR=TR; <span class="comment">% TR=2000ms by default</span>
0345 
0346 nTR_fixation=round(sparam.initial_fixation_time./sparam.TR);
0347 nTR_rotation=round((sparam.pol_cycle_duration-sparam.pol_rest_duration)/(360/sparam.pol_rotangle)/sparam.TR);
0348 nTR_whole=round((sum(sparam.initial_fixation_time)+sparam.pol_cycle_duration*sparam.pol_numRepeats)/sparam.TR);
0349 
0350 <span class="comment">% initialize chackerboard parameters</span>
0351 rmin=sparam.minRad+sparam.fixsize/sparam.pix_per_deg; <span class="comment">% omit the central fixation point</span>
0352 rmax=sparam.maxRad;
0353 
0354 sparam.pol_npositions=360/sparam.pol_rotangle;
0355 sparam.ecc_npositions=sparam.pol_npositions*(sparam.ecc_cycle_duration-sparam.ecc_rest_duration)/(sparam.pol_cycle_duration-sparam.pol_rest_duration);
0356 
0357 fprintf(<span class="string">'done.\n\n'</span>);
0358 
0359 
0360 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0361 <span class="comment">%%%% Generating checkerboard patterns</span>
0362 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0363 
0364 fprintf(<span class="string">'generating stimulus patterns...'</span>);
0365 
0366 <span class="comment">%%% a wedge for polar representation</span>
0367 startangles=zeros(sparam.pol_npositions,1);
0368 <span class="keyword">for</span> nn=1:1:sparam.pol_npositions, startangles(nn)=sparam.pol_startangle+(nn-1)*sparam.pol_rotangle; <span class="keyword">end</span>
0369 
0370 [dummy1,dummy2,pol_checkerboard]=<a href="../../Retinotopy/Generation/pol_GenerateCheckerBoard1D.html" class="code" title="function [checkerboard,bincheckerboard,mask]=pol_GenerateCheckerBoard1D(rmin,rmax,width,startangle,pix_per_deg,nwedges,nrings,phase,dual_flg)">pol_GenerateCheckerBoard1D</a>(rmin,rmax,sparam.pol_width,startangles,sparam.pix_per_deg,1,1,0);
0371 clear dummy1 dummy2;
0372 
0373 <span class="comment">%%% an annulus for eccentricity representation</span>
0374 eccedge=(rmax-rmin)/( sparam.ecc_npositions-1 );
0375 eccwidth=eccedge*(sparam.ecc_width/sparam.ecc_rotangle);
0376 
0377 <span class="comment">% get annuli's min/max lims</span>
0378 ecclims=zeros(sparam.ecc_npositions,3);
0379 <span class="keyword">for</span> nn=1:1:sparam.ecc_npositions <span class="comment">%1:1:sparam.npositions</span>
0380   minlim=rmin+(nn-1)*eccedge-eccwidth/2;
0381   <span class="keyword">if</span> minlim&lt;rmin, minlim=rmin; <span class="keyword">end</span>
0382   maxlim=rmin+(nn-1)*eccedge+eccwidth/2;
0383   <span class="keyword">if</span> maxlim&gt;rmax, maxlim=rmax; <span class="keyword">end</span>
0384 
0385   ecclims(nn,:)=[minlim,maxlim,eccwidth];
0386 <span class="keyword">end</span>
0387 
0388 [dummy1,dummy2,ecc_checkerboard]=<a href="../../Retinotopy/Generation/ecc_GenerateCheckerBoard1D.html" class="code" title="function [checkerboard,bincheckerboard,mask]=ecc_GenerateCheckerBoard1D(edges,width,startangle,pix_per_deg,nwedges,nrings,phase)">ecc_GenerateCheckerBoard1D</a>(ecclims,360,sparam.ecc_startangle,sparam.pix_per_deg,1,1,0);
0389 clear dummy1 dummy2;
0390 
0391 <span class="comment">%% flip all data for ccw/cont</span>
0392 <span class="keyword">if</span> ~isempty(strfind(sparam.mode,<span class="string">'ccw'</span>))
0393 
0394   tmp_checkerboard=cell(sparam.pol_npositions,1);
0395   <span class="keyword">for</span> nn=1:1:sparam.pol_npositions, tmp_checkerboard{nn}=pol_checkerboard{sparam.pol_npositions-(nn-1)}; <span class="keyword">end</span>
0396   pol_checkerboard=tmp_checkerboard;
0397   clear tmp_checkerboard;
0398 
0399 <span class="keyword">end</span>
0400 
0401 <span class="keyword">if</span> ~isempty(strfind(sparam.mode,<span class="string">'cont'</span>))
0402 
0403   tmp_checkerboard=cell(sparam.ecc_npositions,1);
0404   <span class="keyword">for</span> nn=1:1:sparam.ecc_npositions, tmp_checkerboard{nn}=ecc_checkerboard{sparam.ecc_npositions-(nn-1)}; <span class="keyword">end</span>
0405   ecc_checkerboard=tmp_checkerboard;
0406   clear tmp_checkerboard;
0407 
0408 <span class="keyword">end</span>
0409 
0410 <span class="comment">%%% generate the combined checkerboard patterns</span>
0411 
0412 commduration=lcm(sparam.pol_cycle_duration,sparam.ecc_cycle_duration); <span class="comment">% the least common multiple duration at which the stimulus rotation turns to the beginning.</span>
0413 <span class="keyword">if</span> commduration&lt;sparam.pol_cycle_duration*sparam.pol_numRepeats
0414   pol_subrepeats=ceil(commduration/sparam.pol_cycle_duration);
0415   ecc_subrepeats=ceil(commduration/sparam.ecc_cycle_duration);
0416 <span class="keyword">else</span>
0417   fprintf(<span class="string">'WARNING: It is recommended to adjust the sparam parameters so that lcm(sparam.pol_cycle_duration,sparam.ecc_cycle_duration) is less than sparam.pol_cycle_duration*sparam.pol_numRepeats\n'</span>);
0418   pol_subrepeats=sparam.pol_numRepeats;
0419   ecc_subrepeats=sparam.ecc_numRepeats;
0420 <span class="keyword">end</span>
0421 
0422 <span class="comment">% put the rest period for polar patterns</span>
0423 nrest=sparam.pol_npositions/(sparam.pol_cycle_duration-sparam.pol_rest_duration)*sparam.pol_rest_duration;
0424 <span class="keyword">if</span> nrest&gt;0
0425   <span class="keyword">if</span> ~isempty(strfind(sparam.mode,<span class="string">'ccw'</span>))
0426     pol_checkerboard=[pol_checkerboard;repmat({zeros(size(pol_checkerboard{1}))},nrest,1)];
0427   <span class="keyword">else</span> <span class="comment">% if ~isempty(strfind(sparam.mode,'cw'))</span>
0428     pol_checkerboard=[repmat({zeros(size(pol_checkerboard{1}))},nrest,1);pol_checkerboard];
0429   <span class="keyword">end</span>
0430 <span class="keyword">end</span>
0431 
0432 <span class="comment">% put the rest period for eccentricity patterns</span>
0433 nrest=sparam.ecc_npositions/(sparam.ecc_cycle_duration-sparam.ecc_rest_duration)*sparam.ecc_rest_duration;
0434 <span class="keyword">if</span> nrest&gt;0
0435   <span class="keyword">if</span> ~isempty(strfind(sparam.mode,<span class="string">'cont'</span>))
0436     ecc_checkerboard=[repmat({zeros(size(ecc_checkerboard{1}))},nrest,1);ecc_checkerboard];
0437   <span class="keyword">else</span> <span class="comment">% if ~isempty(strfind(sparam.mode,'ecc'))</span>
0438     ecc_checkerboard=[ecc_checkerboard;repmat({zeros(size(ecc_checkerboard{1}))},nrest,1)];
0439   <span class="keyword">end</span>
0440 <span class="keyword">end</span>
0441 
0442 <span class="comment">% multiply the patterns for the pol_subrepeats</span>
0443 pol_checkerboard=repmat(pol_checkerboard,pol_subrepeats,1);
0444 
0445 <span class="comment">% initialize the final checkerboard by eccentricity patterns</span>
0446 checkerboard=repmat(ecc_checkerboard,ecc_subrepeats,1);
0447 
0448 <span class="comment">% overwrite the polar patterns</span>
0449 <span class="keyword">for</span> nn=1:1:length(pol_checkerboard)
0450   checkerboard{nn}(pol_checkerboard{nn}~=0)=pol_checkerboard{nn}(pol_checkerboard{nn}~=0);
0451 <span class="keyword">end</span>
0452 clear pol_checkerboard ecc_checkerboard;
0453 
0454 <span class="comment">% generate the final checkerboard patterns</span>
0455 subrepeats=ceil(sparam.pol_numRepeats/pol_subrepeats);
0456 checkerboard=repmat(checkerboard,[subrepeats,1]);
0457 
0458 <span class="comment">% cut the patterns that exceeds the whole stimulus presentation trials</span>
0459 <span class="keyword">if</span> length(checkerboard) &gt; sparam.pol_cycle_duration*sparam.pol_numRepeats/(sparam.pol_cycle_duration/sparam.pol_npositions)
0460   checkerboard=checkerboard(1:sparam.pol_cycle_duration*sparam.pol_numRepeats/(sparam.pol_cycle_duration/sparam.pol_npositions));
0461 <span class="keyword">end</span>
0462 
0463 <span class="comment">%% initialize stimulus windows</span>
0464 <span class="comment">%stim_windows=zeros([round(size(checkerboard{1})),nTR_whole]);</span>
0465 stim_windows=false([round(size(checkerboard{1})),nTR_whole]);
0466 TRcounter=1; <span class="comment">% TR counter</span>
0467 
0468 fprintf(<span class="string">'done.\n\n'</span>);
0469 
0470 
0471 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0472 <span class="comment">%%%% Initilize figure window</span>
0473 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0474 
0475 <span class="keyword">if</span> display_flg
0476   <span class="comment">%scrsz = get(0,'ScreenSize');</span>
0477   figure(<span class="string">'Name'</span>,sprintf(<span class="string">'stimulus window: %s'</span>,sparam.mode),<span class="string">'NumberTitle'</span>,<span class="string">'off'</span>);
0478 <span class="keyword">end</span>
0479 
0480 
0481 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0482 <span class="comment">%%%% Initial Fixation Period</span>
0483 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0484 
0485 fprintf(<span class="string">'storing stimulus patterns...\n'</span>);
0486 fprintf(<span class="string">'Frames(TR):\n'</span>);
0487 
0488 <span class="comment">% generate images in the fixation periods</span>
0489 counterend=TRcounter+nTR_fixation(1)-1;
0490 <span class="keyword">for</span> ff=TRcounter:1:counterend
0491   stim_windows(:,:,ff)=0;
0492   TRcounter=TRcounter+1;
0493   fprintf(<span class="string">'%03d '</span>,ff); <span class="keyword">if</span> mod(ff,20)==0, fprintf(<span class="string">'\n'</span>); <span class="keyword">end</span>
0494   <span class="keyword">if</span> display_flg
0495     imagesc(stim_windows(:,:,ff),[0,1]); title(sprintf(<span class="string">'Frame(TR): %03d'</span>,ff)); colormap(gray); axis equal; axis off; drawnow; pause(pause_dur);
0496   <span class="keyword">end</span>
0497 <span class="keyword">end</span>
0498 
0499 
0500 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0501 <span class="comment">%%%% The Trial Loop</span>
0502 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0503 
0504 <span class="keyword">for</span> cc=1:1:length(checkerboard)
0505 
0506   <span class="comment">%% stimulus presentation loop</span>
0507   counterend=TRcounter+nTR_rotation-1;
0508   <span class="keyword">for</span> ff=TRcounter:1:counterend
0509     <span class="comment">% set the current checkerboard</span>
0510     stim_windows(:,:,ff)=checkerboard{cc};
0511 
0512     TRcounter=TRcounter+1;
0513     fprintf(<span class="string">'%03d '</span>,ff); <span class="keyword">if</span> mod(ff,20)==0, fprintf(<span class="string">'\n'</span>); <span class="keyword">end</span>
0514     <span class="keyword">if</span> display_flg
0515       imagesc(stim_windows(:,:,ff),[0,1]); title(sprintf(<span class="string">'Frame(TR): %03d'</span>,ff)); colormap(gray); axis equal; axis off; drawnow; pause(pause_dur);
0516     <span class="keyword">end</span>
0517   <span class="keyword">end</span> <span class="comment">% for ff=TRcounter:1:counterend</span>
0518 
0519 <span class="keyword">end</span> <span class="comment">% for cc=1:1:length(checkerboard)</span>
0520 
0521 
0522 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0523 <span class="comment">%%%% Final Fixation</span>
0524 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0525 
0526 <span class="comment">% generate images in the fixation periods</span>
0527 counterend=TRcounter+nTR_fixation(2)-1;
0528 <span class="keyword">for</span> ff=TRcounter:1:counterend
0529   stim_windows(:,:,ff)=0;
0530   TRcounter=TRcounter+1;
0531   fprintf(<span class="string">'%03d '</span>,ff); <span class="keyword">if</span> mod(ff,20)==0, fprintf(<span class="string">'\n'</span>); <span class="keyword">end</span>
0532   <span class="keyword">if</span> display_flg
0533     imagesc(stim_windows(:,:,ff),[0,1]); title(sprintf(<span class="string">'Frame(TR): %03d'</span>,ff)); colormap(gray); axis equal; axis off; drawnow; pause(pause_dur);
0534   <span class="keyword">end</span>
0535 <span class="keyword">end</span>
0536 
0537 fprintf(<span class="string">'done.\n\n'</span>);
0538 close all;
0539 
0540 
0541 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0542 <span class="comment">%%%% Write data into file for post analysis</span>
0543 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0544 
0545 <span class="comment">% saving the results</span>
0546 fprintf(<span class="string">'saving data...'</span>);
0547 savefname=fullfile(resultDir,[num2str(subjID),<span class="string">'_stimulus_window_'</span>,sparam.mode,<span class="string">'_run_'</span>,num2str(acq,<span class="string">'%02d'</span>),<span class="string">'.mat'</span>]);
0548 eval(sprintf(<span class="string">'save %s subjID sparam dparam stim_windows;'</span>,savefname));
0549 fprintf(<span class="string">'done.\n'</span>);
0550 
0551 
0552 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0553 <span class="comment">%%%% Remove paths to the subfunctions</span>
0554 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0555 
0556 rmpath(genpath(fullfile(rootDir,<span class="string">'..'</span>,<span class="string">'Common'</span>)));
0557 rmpath(fullfile(rootDir,<span class="string">'..'</span>,<span class="string">'Generation'</span>));
0558 <span class="comment">%clear all; clear mex; clear global;</span>
0559 diary off;
0560 
0561 
0562 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0563 <span class="comment">%%%% Catch the errors</span>
0564 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0565 
0566 <span class="keyword">catch</span> lasterror
0567   <span class="comment">% this &quot;catch&quot; section executes in case of an error in the &quot;try&quot; section</span>
0568   <span class="comment">% above.  Importantly, it closes the onscreen window if its open.</span>
0569   tmp=lasterror; <span class="comment">%#ok</span>
0570   diary off;
0571   fprintf([<span class="string">'\nError detected and the program was terminated.\n'</span>,<span class="keyword">...</span>
0572            <span class="string">'To check error(s), please type ''tmp''.\n'</span>,<span class="keyword">...</span>
0573            <span class="string">'Please save the current variables now if you need.\n'</span>,<span class="keyword">...</span>
0574            <span class="string">'Then, quit by ''dbquit''\n'</span>]);
0575   keyboard;
0576   rmpath(genpath(fullfile(rootDir,<span class="string">'..'</span>,<span class="string">'Common'</span>)));
0577   rmpath(fullfile(rootDir,<span class="string">'..'</span>,<span class="string">'Generation'</span>));
0578   <span class="comment">%clear global; clear mex; clear all; close all;</span>
0579   <span class="keyword">return</span>
0580 <span class="keyword">end</span> <span class="comment">% try..catch</span>
0581 
0582 
0583 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0584 <span class="comment">%%%%% That's it - we're done</span>
0585 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0586 <span class="keyword">return</span>;
0587 <span class="comment">% end % function gen_dual_window</span></pre></div>
<hr><address>Generated on Thu 10-Jun-2021 10:01:25 by <strong><a href="http://www.artefact.tk/software/matlab/m2html/" target="_parent">m2html</a></strong> &copy; 2005 using a BVQX_hbtools customized template</address>
</body>
</html>