<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
                "http://www.w3.org/TR/REC-html40/loose.dtd">
<html>
<head>
  <title>Description of ddual</title>
  <meta name="keywords" content="ddual">
  <meta name="description" content="Random-Dot-Stereogram(RDS)-defined checkerboard retinotopy stimulus with checker-patch depth change-detection tasks.">
  <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
  <meta name="generator" content="m2html &copy; 2005 Guillaume Flandin">
  <meta name="robots" content="index, follow">
  <link type="text/css" rel="stylesheet" href="../../m2html.css">
  <script type="text/javascript">
    if (top.frames.length == 0) { top.location = "../../index.html"; };
  </script>
</head>
<body>
<a name="_top"></a>
<!-- # Retinotopy --><!-- menu.html Presentation -->
<h1>ddual
</h1>

<h2><a name="_name"></a>PURPOSE <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
<div class="box"><strong>Random-Dot-Stereogram(RDS)-defined checkerboard retinotopy stimulus with checker-patch depth change-detection tasks.</strong></div>

<h2><a name="_synopsis"></a>SYNOPSIS <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
<div class="box"><strong>function ddual(subjID,exp_mode,acq,displayfile,stimulusfile,gamma_table,overwrite_flg,force_proceed_flag) </strong></div>

<h2><a name="_description"></a>DESCRIPTION <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
<div class="fragment" style="background-image:url(../../hb_brain.png); background-position:right top"><pre class="comment"> Random-Dot-Stereogram(RDS)-defined checkerboard retinotopy stimulus with checker-patch depth change-detection tasks.
 function ddual(subjID,exp_mode,acq,:displayfile,:stimulusfile,:gamma_table,:overwrite_flg,:force_proceed_flag)
 (: is optional)

 - This function generates and presents Random-Dot-Stereogram(RDS)-defined checkerboard stimulus
   (dual stimuli: wedge + annulus) to measure cortical retinotopy and to delineate
   retinotopic borders using the standard phase-encoded or pRF (population receptive
   field) analysis techniques.

   references: 1. Population receptive field estimates in human visual cortex.
                  Dumoulin, S.O. and Wandell, B.A. (2008). Neuroimage, 39(2), 647-660.
               2. Borders of multiple visual areas in humans revealed by functional magnetic resonance imaging.
                  Sereno MI, Dale AM, Reppas JB, Kwong KK, Belliveau JW, Brady TJ, Rosen BR, Tootell RB. (1995).
                  Science 268(5212), 889-893.
               3. fMRI of human visual cortex.
                  Engel SA, Rumelhart DE, Wandell BA, Lee AT, Glover GH, Chichilnisky EJ, Shadlen MN. (1994).
                  Nature, 369(6481), 525.
               4. Visual field maps in human cortex.
                  Wandell BA, Dumoulin SO, Brewer AA. (2007). Neuron, 56(2), 366-383.

 - This script shoud be used with MATLAB Psychtoolbox version 3 or above.

 - Depth-change detection task: one of the checks of the checkerboard pattern
   randomly appears to be more depthy compared to the other checkers.
   An observer has to press the button if s/he detects this luminance change.
   Response keys are defined in displayfile.

 [note]
 Behavioral task of (function_name)_fixtask is to detect changes of luminance
 of the central fixation point, while the task in (function_name_alone) is to
 detect changes of depth of one of the patches in the checkerboard stimuli.
 Here, the central fixation task is more easy to sustain the stable fixation
 on the center of the screen and may be suitable for naive/non-expert
 participants with minimizing unwilling eye movements. However, some studies
 have reported that attention to the target stimulus (lead by checker-patch depth
 change detection task) is required to get reliable retinotopic representations
 in higher-order visual areas.


 Created    : &quot;2019-05-22 18:27:26 ban&quot;
 Last Update: &quot;2021-06-07 17:21:38 ban&quot;



 [input variables]
 sujID         : ID of subject, string, such as 's01'
                 you also need to create a directory ./subjects/(subj) and put displayfile and stimulusfile there.
                 !!!!!!!!!!!!!!!!!! IMPORTANT NOTE !!!!!!!!!!!!!!!!!!!!!!!!
                 !!! if 'debug' (case insensitive) is included          !!!
                 !!! in subjID string, this program runs as DEBUG mode; !!!
                 !!! stimulus images are saved as *.png format at       !!!
                 !!! ~/Retinotopy/Presentation/images                   !!!
                 !!!!!!!!!!!!!!!!!! IMPORTANT NOTE !!!!!!!!!!!!!!!!!!!!!!!!

 exp_mode      : experiment mode that you want to run, one of
  - ccwexp : a checkerboard wedge rotating counter-clockwisely + an expanding annulus
  - cwexp  : a checkerboard wedge rotating clockwisely + an expanding annulus
  - ccwcont: a checkerboard wedge rotating counter-clockwisely + a contracting annulus
  - cwcont : a checkerboard wedge rotating clockwisely + a contracting annulus
 acq           : acquisition number (design file number),
                 an integer, such as 1, 2, 3, ...
 displayfile   : (optional) display condition file,
                 *.m file, such as 'RetDepth_display_fmri.m'
                 the file should be located in ./subjects/(subj)/
 stimulusfile  : (optional) stimulus condition file,
                 *.m file, such as 'RetDepth_stimulus_exp1.m'
                 the file should be located in ./subjects/(subj)/
 gamma_table   : (optional) table(s) of gamma-corrected video input values (Color LookupTable).
                 256(8-bits) x 3(RGB) x 1(or 2,3,... when using multiple displays) matrix
                 or a *.mat file specified with a relative path format. e.g. '/gamma_table/gamma1.mat'
                 The *.mat should include a variable named &quot;gamma_table&quot; consists of a 256x3xN matrix.
                 if you use multiple (more than 1) displays and set a 256x3x1 gamma-table, the same
                 table will be applied to all displays. if the number of displays and gamma tables
                 are different (e.g. you have 3 displays and 256x3x!2! gamma-tables), the last
                 gamma_table will be applied to the second and third displays.
                 if empty, normalized gamma table (repmat(linspace(0.0,1.0,256),3,1)) will be applied.
 overwrite_flg : (optional) whether overwriting pre-existing result file. if 1, the previous result
                 file with the same acquisition number will be overwritten by the previous one.
                 if 0, the existing file will be backed-up by adding a prefix '_old' at the tail
                 of the file. 0 by default.
 force_proceed_flag : (optional) whether proceeding stimulus presentatin without waiting for
                 the experimenter response (e.g. presesing the ENTER key) or a trigger.
                 if 1, the stimulus presentation will be automatically carried on.

 !!! NOTICE !!!!
 displayfile &amp; stimulusfile should be located at
 ./subjects/(subjID)/
 as ./subjects/(subjID)/*_display_fmri.m
    ./subjects/(subjID)/*_stimuli.m


 [output variables]
 no output matlab variable.


 [output files]
 1. result file
    stored ./subjects/(subjID)/results/(date)
    as ./subjects/(subjID)/results/(date)/(subjID)_ddual_(exp_mode)_results_run_(run_num).mat


 [example]
 &gt;&gt; ddual('HB','ccwexp',1,'ret_display.m','ret_checker_stimulus_exp1.m')

 [About displayfile]
 The contents of the displayfile are as below.
 (The file includs 6 lines of headers and following display parameters)

 (an example of the displayfile)

 % ************************************************************
 % This is the display configuration file for the retinotopy stimuli
 % Programmed by Hiroshi Ban Nov 01 2013
 % ************************************************************

 % display mode, one of &quot;mono&quot;, &quot;dual&quot;, &quot;dualcross&quot;, &quot;dualparallel&quot;, &quot;cross&quot;, &quot;parallel&quot;, &quot;redgreen&quot;, &quot;greenred&quot;,
 % &quot;redblue&quot;, &quot;bluered&quot;, &quot;shutter&quot;, &quot;topbottom&quot;, &quot;bottomtop&quot;, &quot;interleavedline&quot;, &quot;interleavedcolumn&quot;, &quot;propixxmono&quot;, &quot;propixxstereo&quot;
 dparam.ExpMode='mono';

 dparam.scrID=1; % screen ID, generally 0 for a single display setup, 1 for dual display setup

 % a method to start stimulus presentation
 % 0:ENTER/SPACE, 1:Left-mouse button, 2:the first MR trigger pulse (CiNet),
 % 3:waiting for a MR trigger pulse (BUIC) -- checking onset of pin #11 of the parallel port,
 % or 4:custom key trigger (wait for a key input that you specify as tgt_key).
 dparam.start_method=2;

 % a pseudo trigger key from the MR scanner when it starts, valid only when dparam.start_method=4;
 dparam.custom_trigger='t';

 % keyboard settings
 dparam.Key1=51; % key 1 (left)
 dparam.Key2=52; % key 2 (right)

 % screen settings

 %%% whether displaying the stimuli in full-screen mode or
 %%% as is (the precise resolution), 'true' or 'false' (true)
 dparam.fullscr=false;

 %%% the resolution of the screen height
 dparam.ScrHeight=1200;

 %% the resolution of the screen width
 dparam.ScrWidth=1920;

 % whether forcing to use specific frame rate, if 0, the frame rate wil bw computed in the ImagesShowPTB function.
 % if non zero, the value is used as the screen frame rate.
 dparam.force_frame_rate=60;

 % whther skipping the PTB's vertical-sync signal test. if 1, the sync test is skipped
 dparam.skip_sync_test=0;


 [About stimulusfile]
 The contents of the stimulusfile are as below.
 (The file includs 6 lines of headers and following stimulus parameters)

 (an example of the stimulusfile)

 % ************************************************************
 % This is the stimulus parameter file for the dual (wedge + annulus) retinotopy stimulus
 % Programmed by Hiroshi Ban Jan 25 2019
 % ************************************************************

 % &quot;sparam&quot; means &quot;stimulus generation parameters&quot;

 %%% stimulus parameters
 sparam.pol_nwedges     = 4;     % number of wedge subdivisions along polar angle
 sparam.pol_nrings      = 8;     % number of ring subdivisions along eccentricity angle
 sparam.pol_width       = 48;    % wedge width in deg along polar angle
 sparam.pol_phase       = 0;     % phase shift in deg
 sparam.pol_rotangle    = 12;    % rotation angle in deg
 sparam.pol_startangle  = -sparam.pol_width/2-90; % presentation start angle in deg, from right-horizontal meridian, ccw

 sparam.ecc_nwedges     = 4;     % number of wedge subdivisions along polar angle
 sparam.ecc_nrings      = 2;     % number of ring subdivisions along eccentricity angle
 sparam.ecc_width       = sparam.pol_width/2;
 sparam.ecc_phase       = 0;     % phase shift in deg
 sparam.ecc_rotangle    = sparam.pol_rotangle;
 sparam.ecc_startangle  = -sparam.ecc_width/2-90;  % presentation start angle in deg, from right-horizontal meridian, ccw (actually this value is not used for the eccentricity stimuli (exp and cont))

 sparam.maxRad      = 6.0;  % maximum radius of  annulus (degrees)
 sparam.minRad      = 0;    % minumum

 %%% RDS parameters
 sparam.RDSdepth = [ -12, 12, 5]; % binocular disparity in arcmins, [min, max, #steps(from min to max)]
 sparam.RDSDense=0.5; % dot density in the RDS images to be generated (percentage)
 sparam.RDSradius=0.05; % dot radius in deg
 sparam.RDScolors=[255,0,128]; % dot colors in the RDS, [color1, color2, background (grayscale)]
 sparam.RDSbackground=0; % 1 = with background, 0 = no background
 sparam.RDStaskmagnitude=2; % ratio (x2, x3, etc against the sparam.RDSdepth([1,2])) of the depth maginitude in the change-detection task

 %%% duration in msec for each cycle &amp; repetitions
 % ===========================================================================================================================================
 % IMPORTANT NOTE: sparam.pol_cycle_duration x sparam.pol_numRepeats should be the same with sparam.ecc_cycle_duration x sparam.ecc_numRepeats
 % ===========================================================================================================================================

 sparam.pol_cycle_duration=60000; % msec
 sparam.pol_rest_duration =0; % msec, rest after each cycle, stimulation = cycle_duration-eccrest
 sparam.pol_numRepeats=6;

 sparam.ecc_cycle_duration=40000; % msec
 sparam.ecc_rest_duration =8000; % msec, rest after each cycle, stimulation = cycle_duration-eccrest
 sparam.ecc_numRepeats=9;

 %%% set number of frames to flip the screen
 % Here, I set the number as large as I can to minimize vertical cynching error.
 % the final 2 is for 2 times repetitions of flicker
 % Set 1 if you want to flip the display at each vertical sync, but not recommended as it uses much CPU power
 sparam.waitframes = Screen('FrameRate',0)*(sparam.cycle_duration/1000) / (360/sparam.rotangle) / ( (size(sparam.colors,1)-1)*2 );
 % sparam.waitframes = 1;

 %%% fixation period in msec before/after presenting the target stimuli, integer
 % must set a value more than 1 TR for initializing the frame counting.
 sparam.initial_fixation_time=[4000,4000];

 %%% fixation size &amp; color
 sparam.fixtype=1; % 1: circular, 2: rectangular, 3: concentric fixation point
 sparam.fixsize=12; % radius in pixels
 sparam.fixcolor=[255,255,255];

 %%% background color
 sparam.bgcolor=[128,128,128];

 %%% background-patch colors (RGB)
 sparam.bgtype=1; % 1: a simple background with sparam.bgcolor (then, the parameters belows are not used), 2: a background with grid guides
 sparam.patch_size=[30,30]; % background patch size, [height,width] in pixels
 sparam.patch_num=[20,40];  % the number of background patches along vertical and horizontal axis
 sparam.patch_color1=[255,255,255];
 sparam.patch_color2=[0,0,0];

 %%% for converting degree to pixels
 run(fullfile(fileparts(mfilename('fullpath')),'sizeparams'));
 %sparam.pix_per_cm=57.1429;
 %sparam.vdist=65;
 %sparam.ipd=6.5;


 [HOWTO create stimulus files]
 1. All of the stimuli are created in this script in real-time
    with MATLAB scripts &amp; functions.
    see ../Generation &amp; ../Common directries.
 2. Stimulus parameters are defined in the display &amp; stimulus file.


 [reference]
 for stmulus generation, see ../Generation &amp; ../Common directories.</pre></div>

<!-- crossreference -->
<h2><a name="_cross"></a>CROSS-REFERENCE INFORMATION <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
<div class="fragment" style="background-image:url(../../hb_brain.png); background-position:right top">
This function calls:
<ul style="list-style-image:url(../../matlabicon.gif)">
<li><a href="../../Retinotopy/Common/BackUpObsoleteFiles.html" class="code" title="function [new_fname,backup_fname]=BackUpObsoleteFiles(tgt_dir,tgt_fname,backup_prefix)">BackUpObsoleteFiles</a>	Backups already-existing file(s) in the target directory by adding some file-prefix.</li><li><a href="../../Retinotopy/Common/CheckPTBversion.html" class="code" title="function [PTB_OK,vertxt] = CheckPTBversion(num_mainver_youwant)">CheckPTBversion</a>	Checks the version of the currently running Psychtoolbox.</li><li><a href="../../Retinotopy/Common/CreateBackgroundImage.html" class="code" title="function [Bimg,parameters] = CreateBackgroundImage(wdims,stdims,pdims,bgcolor,color1,color2,fixcolor,patchnum,fix_flag,save_flag,show_flag)">CreateBackgroundImage</a>	Creates background image that can be used as a background of your stimulus displays.</li><li><a href="../../Retinotopy/Common/CreateFixationImgCircular.html" class="code" title="function fix=CreateFixationImgCircular(fixsize,fixcolor,bgcolor,circlesize,show_flag,save_flag)">CreateFixationImgCircular</a>	Creates a circular fixation image for a monocular display setting.</li><li><a href="../../Retinotopy/Common/CreateFixationImgConcentrateMono.html" class="code" title="function fix=CreateFixationImgConcentrateMono(fixsize,fixcolor,bgcolor,circlesize,gap,show_flag,save_flag)">CreateFixationImgConcentrateMono</a>	Creates a circular fixation image for a monocular display setting.</li><li><a href="../../Retinotopy/Common/CreateFixationImgMono.html" class="code" title="function fix=CreateFixationImgMono(fixsize,fixcolor,bgcolor,fixlinew,fixlineh,show_flag,save_flag)">CreateFixationImgMono</a>	Creates a cross-shaped fixation image for a monocular display setting.</li><li><a href="../../Retinotopy/Common/DisplayMessage2.html" class="code" title="function DisplayMessage2(message,bgcolor,winPtr,numScreens,drawing_font,drawing_size)">DisplayMessage2</a>	Displays message on the center of each of multiple PTB windows.</li><li><a href="../../Retinotopy/Common/GammaLoadPTB.html" class="code" title="function GammaLoadPTB(gamma_table)">GammaLoadPTB</a>	Loads and sets display gamma-table(s) using PTB Screen() function.</li><li><a href="../../Retinotopy/Common/GammaResetPTB.html" class="code" title="function GammaResetPTB(luminance_ratio)">GammaResetPTB</a>	Resets display gamma with PTB Screen() function.</li><li><a href="../../Retinotopy/Common/InitializePTBDisplays.html" class="code" title="function [winPtr,winRect,nScr,fps,ifi,initDisplay_OK]=InitializePTBDisplays(disp_mode,bgcolor,flipping,rgb_gains,custom_scrIDs)">InitializePTBDisplays</a>	Initializes PTB screen(s) for monocular/binocular presentations using PsychImaging() function.</li><li><a href="../../Retinotopy/Common/InitializeRandomSeed.html" class="code" title="function cseed=InitializeRandomSeed">InitializeRandomSeed</a>	Initializes MATLAB internal state of a random seed.</li><li><a href="../../Retinotopy/Common/ValidateStructureFields.html" class="code" title="function structval=ValidateStructureFields(structval,varargin)">ValidateStructureFields</a>	Validates the input structure and set the default values to the missing field(s)</li><li><a href="../../Retinotopy/Common/eventlogger.html" class="code" title="">eventlogger</a>	</li><li><a href="../../Retinotopy/Common/isstructmember.html" class="code" title="function isFieldResult = isstructmember(inStruct, fieldName)">isstructmember</a>	Checks whether the target struct contains a filed you specified as a member.</li><li><a href="../../Retinotopy/Common/responselogger.html" class="code" title="">responselogger</a>	</li><li><a href="../../Retinotopy/Common/shuffle.html" class="code" title="function [Y,index] = shuffle(X)">shuffle</a>	Randomly sorts the input array.</li><li><a href="../../Retinotopy/Generation/GetDotPositionsRDS.html" class="code" title="function [XY,colors]=GetDotPositionsRDS(checkerboard,depths,dotdense,RDScolors,ipd,vdist,pix_per_cm)">GetDotPositionsRDS</a>	Returns XY positions and colors (grayscale, 0-255) of dots in a Random-Dot-Stereogram(RDS) image.</li><li><a href="../../Retinotopy/Generation/ecc_GenerateCheckerBoard1D.html" class="code" title="function [checkerboard,bincheckerboard,mask]=ecc_GenerateCheckerBoard1D(edges,width,startangle,pix_per_deg,nwedges,nrings,phase)">ecc_GenerateCheckerBoard1D</a>	Generates checkerboard patterns (annulus-based subdivision) with an individual ID number on each patch.</li><li><a href="../../Retinotopy/Generation/pol_GenerateCheckerBoard1D.html" class="code" title="function [checkerboard,bincheckerboard,mask]=pol_GenerateCheckerBoard1D(rmin,rmax,width,startangle,pix_per_deg,nwedges,nrings,phase,dual_flg)">pol_GenerateCheckerBoard1D</a>	Generates checkerboard patterns (polar angle-based subdivision) with an individual ID number on each patch.</li></ul>
This function is called by:
<ul style="list-style-image:url(../../matlabicon.gif)">
</ul>
</div>
<!-- crossreference -->



<h2><a name="_source"></a>SOURCE CODE <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
<div class="fragment" style="background-image:url(../../hb_brain.png); background-position:right top"><pre>0001 <a name="_sub0" href="#_subfunctions" class="code">function ddual(subjID,exp_mode,acq,displayfile,stimulusfile,gamma_table,overwrite_flg,force_proceed_flag)</a>
0002 
0003 <span class="comment">% Random-Dot-Stereogram(RDS)-defined checkerboard retinotopy stimulus with checker-patch depth change-detection tasks.</span>
0004 <span class="comment">% function ddual(subjID,exp_mode,acq,:displayfile,:stimulusfile,:gamma_table,:overwrite_flg,:force_proceed_flag)</span>
0005 <span class="comment">% (: is optional)</span>
0006 <span class="comment">%</span>
0007 <span class="comment">% - This function generates and presents Random-Dot-Stereogram(RDS)-defined checkerboard stimulus</span>
0008 <span class="comment">%   (dual stimuli: wedge + annulus) to measure cortical retinotopy and to delineate</span>
0009 <span class="comment">%   retinotopic borders using the standard phase-encoded or pRF (population receptive</span>
0010 <span class="comment">%   field) analysis techniques.</span>
0011 <span class="comment">%</span>
0012 <span class="comment">%   references: 1. Population receptive field estimates in human visual cortex.</span>
0013 <span class="comment">%                  Dumoulin, S.O. and Wandell, B.A. (2008). Neuroimage, 39(2), 647-660.</span>
0014 <span class="comment">%               2. Borders of multiple visual areas in humans revealed by functional magnetic resonance imaging.</span>
0015 <span class="comment">%                  Sereno MI, Dale AM, Reppas JB, Kwong KK, Belliveau JW, Brady TJ, Rosen BR, Tootell RB. (1995).</span>
0016 <span class="comment">%                  Science 268(5212), 889-893.</span>
0017 <span class="comment">%               3. fMRI of human visual cortex.</span>
0018 <span class="comment">%                  Engel SA, Rumelhart DE, Wandell BA, Lee AT, Glover GH, Chichilnisky EJ, Shadlen MN. (1994).</span>
0019 <span class="comment">%                  Nature, 369(6481), 525.</span>
0020 <span class="comment">%               4. Visual field maps in human cortex.</span>
0021 <span class="comment">%                  Wandell BA, Dumoulin SO, Brewer AA. (2007). Neuron, 56(2), 366-383.</span>
0022 <span class="comment">%</span>
0023 <span class="comment">% - This script shoud be used with MATLAB Psychtoolbox version 3 or above.</span>
0024 <span class="comment">%</span>
0025 <span class="comment">% - Depth-change detection task: one of the checks of the checkerboard pattern</span>
0026 <span class="comment">%   randomly appears to be more depthy compared to the other checkers.</span>
0027 <span class="comment">%   An observer has to press the button if s/he detects this luminance change.</span>
0028 <span class="comment">%   Response keys are defined in displayfile.</span>
0029 <span class="comment">%</span>
0030 <span class="comment">% [note]</span>
0031 <span class="comment">% Behavioral task of (function_name)_fixtask is to detect changes of luminance</span>
0032 <span class="comment">% of the central fixation point, while the task in (function_name_alone) is to</span>
0033 <span class="comment">% detect changes of depth of one of the patches in the checkerboard stimuli.</span>
0034 <span class="comment">% Here, the central fixation task is more easy to sustain the stable fixation</span>
0035 <span class="comment">% on the center of the screen and may be suitable for naive/non-expert</span>
0036 <span class="comment">% participants with minimizing unwilling eye movements. However, some studies</span>
0037 <span class="comment">% have reported that attention to the target stimulus (lead by checker-patch depth</span>
0038 <span class="comment">% change detection task) is required to get reliable retinotopic representations</span>
0039 <span class="comment">% in higher-order visual areas.</span>
0040 <span class="comment">%</span>
0041 <span class="comment">%</span>
0042 <span class="comment">% Created    : &quot;2019-05-22 18:27:26 ban&quot;</span>
0043 <span class="comment">% Last Update: &quot;2021-06-07 17:21:38 ban&quot;</span>
0044 <span class="comment">%</span>
0045 <span class="comment">%</span>
0046 <span class="comment">%</span>
0047 <span class="comment">% [input variables]</span>
0048 <span class="comment">% sujID         : ID of subject, string, such as 's01'</span>
0049 <span class="comment">%                 you also need to create a directory ./subjects/(subj) and put displayfile and stimulusfile there.</span>
0050 <span class="comment">%                 !!!!!!!!!!!!!!!!!! IMPORTANT NOTE !!!!!!!!!!!!!!!!!!!!!!!!</span>
0051 <span class="comment">%                 !!! if 'debug' (case insensitive) is included          !!!</span>
0052 <span class="comment">%                 !!! in subjID string, this program runs as DEBUG mode; !!!</span>
0053 <span class="comment">%                 !!! stimulus images are saved as *.png format at       !!!</span>
0054 <span class="comment">%                 !!! ~/Retinotopy/Presentation/images                   !!!</span>
0055 <span class="comment">%                 !!!!!!!!!!!!!!!!!! IMPORTANT NOTE !!!!!!!!!!!!!!!!!!!!!!!!</span>
0056 <span class="comment">%</span>
0057 <span class="comment">% exp_mode      : experiment mode that you want to run, one of</span>
0058 <span class="comment">%  - ccwexp : a checkerboard wedge rotating counter-clockwisely + an expanding annulus</span>
0059 <span class="comment">%  - cwexp  : a checkerboard wedge rotating clockwisely + an expanding annulus</span>
0060 <span class="comment">%  - ccwcont: a checkerboard wedge rotating counter-clockwisely + a contracting annulus</span>
0061 <span class="comment">%  - cwcont : a checkerboard wedge rotating clockwisely + a contracting annulus</span>
0062 <span class="comment">% acq           : acquisition number (design file number),</span>
0063 <span class="comment">%                 an integer, such as 1, 2, 3, ...</span>
0064 <span class="comment">% displayfile   : (optional) display condition file,</span>
0065 <span class="comment">%                 *.m file, such as 'RetDepth_display_fmri.m'</span>
0066 <span class="comment">%                 the file should be located in ./subjects/(subj)/</span>
0067 <span class="comment">% stimulusfile  : (optional) stimulus condition file,</span>
0068 <span class="comment">%                 *.m file, such as 'RetDepth_stimulus_exp1.m'</span>
0069 <span class="comment">%                 the file should be located in ./subjects/(subj)/</span>
0070 <span class="comment">% gamma_table   : (optional) table(s) of gamma-corrected video input values (Color LookupTable).</span>
0071 <span class="comment">%                 256(8-bits) x 3(RGB) x 1(or 2,3,... when using multiple displays) matrix</span>
0072 <span class="comment">%                 or a *.mat file specified with a relative path format. e.g. '/gamma_table/gamma1.mat'</span>
0073 <span class="comment">%                 The *.mat should include a variable named &quot;gamma_table&quot; consists of a 256x3xN matrix.</span>
0074 <span class="comment">%                 if you use multiple (more than 1) displays and set a 256x3x1 gamma-table, the same</span>
0075 <span class="comment">%                 table will be applied to all displays. if the number of displays and gamma tables</span>
0076 <span class="comment">%                 are different (e.g. you have 3 displays and 256x3x!2! gamma-tables), the last</span>
0077 <span class="comment">%                 gamma_table will be applied to the second and third displays.</span>
0078 <span class="comment">%                 if empty, normalized gamma table (repmat(linspace(0.0,1.0,256),3,1)) will be applied.</span>
0079 <span class="comment">% overwrite_flg : (optional) whether overwriting pre-existing result file. if 1, the previous result</span>
0080 <span class="comment">%                 file with the same acquisition number will be overwritten by the previous one.</span>
0081 <span class="comment">%                 if 0, the existing file will be backed-up by adding a prefix '_old' at the tail</span>
0082 <span class="comment">%                 of the file. 0 by default.</span>
0083 <span class="comment">% force_proceed_flag : (optional) whether proceeding stimulus presentatin without waiting for</span>
0084 <span class="comment">%                 the experimenter response (e.g. presesing the ENTER key) or a trigger.</span>
0085 <span class="comment">%                 if 1, the stimulus presentation will be automatically carried on.</span>
0086 <span class="comment">%</span>
0087 <span class="comment">% !!! NOTICE !!!!</span>
0088 <span class="comment">% displayfile &amp; stimulusfile should be located at</span>
0089 <span class="comment">% ./subjects/(subjID)/</span>
0090 <span class="comment">% as ./subjects/(subjID)/*_display_fmri.m</span>
0091 <span class="comment">%    ./subjects/(subjID)/*_stimuli.m</span>
0092 <span class="comment">%</span>
0093 <span class="comment">%</span>
0094 <span class="comment">% [output variables]</span>
0095 <span class="comment">% no output matlab variable.</span>
0096 <span class="comment">%</span>
0097 <span class="comment">%</span>
0098 <span class="comment">% [output files]</span>
0099 <span class="comment">% 1. result file</span>
0100 <span class="comment">%    stored ./subjects/(subjID)/results/(date)</span>
0101 <span class="comment">%    as ./subjects/(subjID)/results/(date)/(subjID)_ddual_(exp_mode)_results_run_(run_num).mat</span>
0102 <span class="comment">%</span>
0103 <span class="comment">%</span>
0104 <span class="comment">% [example]</span>
0105 <span class="comment">% &gt;&gt; ddual('HB','ccwexp',1,'ret_display.m','ret_checker_stimulus_exp1.m')</span>
0106 <span class="comment">%</span>
0107 <span class="comment">% [About displayfile]</span>
0108 <span class="comment">% The contents of the displayfile are as below.</span>
0109 <span class="comment">% (The file includs 6 lines of headers and following display parameters)</span>
0110 <span class="comment">%</span>
0111 <span class="comment">% (an example of the displayfile)</span>
0112 <span class="comment">%</span>
0113 <span class="comment">% % ************************************************************</span>
0114 <span class="comment">% % This is the display configuration file for the retinotopy stimuli</span>
0115 <span class="comment">% % Programmed by Hiroshi Ban Nov 01 2013</span>
0116 <span class="comment">% % ************************************************************</span>
0117 <span class="comment">%</span>
0118 <span class="comment">% % display mode, one of &quot;mono&quot;, &quot;dual&quot;, &quot;dualcross&quot;, &quot;dualparallel&quot;, &quot;cross&quot;, &quot;parallel&quot;, &quot;redgreen&quot;, &quot;greenred&quot;,</span>
0119 <span class="comment">% % &quot;redblue&quot;, &quot;bluered&quot;, &quot;shutter&quot;, &quot;topbottom&quot;, &quot;bottomtop&quot;, &quot;interleavedline&quot;, &quot;interleavedcolumn&quot;, &quot;propixxmono&quot;, &quot;propixxstereo&quot;</span>
0120 <span class="comment">% dparam.ExpMode='mono';</span>
0121 <span class="comment">%</span>
0122 <span class="comment">% dparam.scrID=1; % screen ID, generally 0 for a single display setup, 1 for dual display setup</span>
0123 <span class="comment">%</span>
0124 <span class="comment">% % a method to start stimulus presentation</span>
0125 <span class="comment">% % 0:ENTER/SPACE, 1:Left-mouse button, 2:the first MR trigger pulse (CiNet),</span>
0126 <span class="comment">% % 3:waiting for a MR trigger pulse (BUIC) -- checking onset of pin #11 of the parallel port,</span>
0127 <span class="comment">% % or 4:custom key trigger (wait for a key input that you specify as tgt_key).</span>
0128 <span class="comment">% dparam.start_method=2;</span>
0129 <span class="comment">%</span>
0130 <span class="comment">% % a pseudo trigger key from the MR scanner when it starts, valid only when dparam.start_method=4;</span>
0131 <span class="comment">% dparam.custom_trigger='t';</span>
0132 <span class="comment">%</span>
0133 <span class="comment">% % keyboard settings</span>
0134 <span class="comment">% dparam.Key1=51; % key 1 (left)</span>
0135 <span class="comment">% dparam.Key2=52; % key 2 (right)</span>
0136 <span class="comment">%</span>
0137 <span class="comment">% % screen settings</span>
0138 <span class="comment">%</span>
0139 <span class="comment">% %%% whether displaying the stimuli in full-screen mode or</span>
0140 <span class="comment">% %%% as is (the precise resolution), 'true' or 'false' (true)</span>
0141 <span class="comment">% dparam.fullscr=false;</span>
0142 <span class="comment">%</span>
0143 <span class="comment">% %%% the resolution of the screen height</span>
0144 <span class="comment">% dparam.ScrHeight=1200;</span>
0145 <span class="comment">%</span>
0146 <span class="comment">% %% the resolution of the screen width</span>
0147 <span class="comment">% dparam.ScrWidth=1920;</span>
0148 <span class="comment">%</span>
0149 <span class="comment">% % whether forcing to use specific frame rate, if 0, the frame rate wil bw computed in the ImagesShowPTB function.</span>
0150 <span class="comment">% % if non zero, the value is used as the screen frame rate.</span>
0151 <span class="comment">% dparam.force_frame_rate=60;</span>
0152 <span class="comment">%</span>
0153 <span class="comment">% % whther skipping the PTB's vertical-sync signal test. if 1, the sync test is skipped</span>
0154 <span class="comment">% dparam.skip_sync_test=0;</span>
0155 <span class="comment">%</span>
0156 <span class="comment">%</span>
0157 <span class="comment">% [About stimulusfile]</span>
0158 <span class="comment">% The contents of the stimulusfile are as below.</span>
0159 <span class="comment">% (The file includs 6 lines of headers and following stimulus parameters)</span>
0160 <span class="comment">%</span>
0161 <span class="comment">% (an example of the stimulusfile)</span>
0162 <span class="comment">%</span>
0163 <span class="comment">% % ************************************************************</span>
0164 <span class="comment">% % This is the stimulus parameter file for the dual (wedge + annulus) retinotopy stimulus</span>
0165 <span class="comment">% % Programmed by Hiroshi Ban Jan 25 2019</span>
0166 <span class="comment">% % ************************************************************</span>
0167 <span class="comment">%</span>
0168 <span class="comment">% % &quot;sparam&quot; means &quot;stimulus generation parameters&quot;</span>
0169 <span class="comment">%</span>
0170 <span class="comment">% %%% stimulus parameters</span>
0171 <span class="comment">% sparam.pol_nwedges     = 4;     % number of wedge subdivisions along polar angle</span>
0172 <span class="comment">% sparam.pol_nrings      = 8;     % number of ring subdivisions along eccentricity angle</span>
0173 <span class="comment">% sparam.pol_width       = 48;    % wedge width in deg along polar angle</span>
0174 <span class="comment">% sparam.pol_phase       = 0;     % phase shift in deg</span>
0175 <span class="comment">% sparam.pol_rotangle    = 12;    % rotation angle in deg</span>
0176 <span class="comment">% sparam.pol_startangle  = -sparam.pol_width/2-90; % presentation start angle in deg, from right-horizontal meridian, ccw</span>
0177 <span class="comment">%</span>
0178 <span class="comment">% sparam.ecc_nwedges     = 4;     % number of wedge subdivisions along polar angle</span>
0179 <span class="comment">% sparam.ecc_nrings      = 2;     % number of ring subdivisions along eccentricity angle</span>
0180 <span class="comment">% sparam.ecc_width       = sparam.pol_width/2;</span>
0181 <span class="comment">% sparam.ecc_phase       = 0;     % phase shift in deg</span>
0182 <span class="comment">% sparam.ecc_rotangle    = sparam.pol_rotangle;</span>
0183 <span class="comment">% sparam.ecc_startangle  = -sparam.ecc_width/2-90;  % presentation start angle in deg, from right-horizontal meridian, ccw (actually this value is not used for the eccentricity stimuli (exp and cont))</span>
0184 <span class="comment">%</span>
0185 <span class="comment">% sparam.maxRad      = 6.0;  % maximum radius of  annulus (degrees)</span>
0186 <span class="comment">% sparam.minRad      = 0;    % minumum</span>
0187 <span class="comment">%</span>
0188 <span class="comment">% %%% RDS parameters</span>
0189 <span class="comment">% sparam.RDSdepth = [ -12, 12, 5]; % binocular disparity in arcmins, [min, max, #steps(from min to max)]</span>
0190 <span class="comment">% sparam.RDSDense=0.5; % dot density in the RDS images to be generated (percentage)</span>
0191 <span class="comment">% sparam.RDSradius=0.05; % dot radius in deg</span>
0192 <span class="comment">% sparam.RDScolors=[255,0,128]; % dot colors in the RDS, [color1, color2, background (grayscale)]</span>
0193 <span class="comment">% sparam.RDSbackground=0; % 1 = with background, 0 = no background</span>
0194 <span class="comment">% sparam.RDStaskmagnitude=2; % ratio (x2, x3, etc against the sparam.RDSdepth([1,2])) of the depth maginitude in the change-detection task</span>
0195 <span class="comment">%</span>
0196 <span class="comment">% %%% duration in msec for each cycle &amp; repetitions</span>
0197 <span class="comment">% % ===========================================================================================================================================</span>
0198 <span class="comment">% % IMPORTANT NOTE: sparam.pol_cycle_duration x sparam.pol_numRepeats should be the same with sparam.ecc_cycle_duration x sparam.ecc_numRepeats</span>
0199 <span class="comment">% % ===========================================================================================================================================</span>
0200 <span class="comment">%</span>
0201 <span class="comment">% sparam.pol_cycle_duration=60000; % msec</span>
0202 <span class="comment">% sparam.pol_rest_duration =0; % msec, rest after each cycle, stimulation = cycle_duration-eccrest</span>
0203 <span class="comment">% sparam.pol_numRepeats=6;</span>
0204 <span class="comment">%</span>
0205 <span class="comment">% sparam.ecc_cycle_duration=40000; % msec</span>
0206 <span class="comment">% sparam.ecc_rest_duration =8000; % msec, rest after each cycle, stimulation = cycle_duration-eccrest</span>
0207 <span class="comment">% sparam.ecc_numRepeats=9;</span>
0208 <span class="comment">%</span>
0209 <span class="comment">% %%% set number of frames to flip the screen</span>
0210 <span class="comment">% % Here, I set the number as large as I can to minimize vertical cynching error.</span>
0211 <span class="comment">% % the final 2 is for 2 times repetitions of flicker</span>
0212 <span class="comment">% % Set 1 if you want to flip the display at each vertical sync, but not recommended as it uses much CPU power</span>
0213 <span class="comment">% sparam.waitframes = Screen('FrameRate',0)*(sparam.cycle_duration/1000) / (360/sparam.rotangle) / ( (size(sparam.colors,1)-1)*2 );</span>
0214 <span class="comment">% % sparam.waitframes = 1;</span>
0215 <span class="comment">%</span>
0216 <span class="comment">% %%% fixation period in msec before/after presenting the target stimuli, integer</span>
0217 <span class="comment">% % must set a value more than 1 TR for initializing the frame counting.</span>
0218 <span class="comment">% sparam.initial_fixation_time=[4000,4000];</span>
0219 <span class="comment">%</span>
0220 <span class="comment">% %%% fixation size &amp; color</span>
0221 <span class="comment">% sparam.fixtype=1; % 1: circular, 2: rectangular, 3: concentric fixation point</span>
0222 <span class="comment">% sparam.fixsize=12; % radius in pixels</span>
0223 <span class="comment">% sparam.fixcolor=[255,255,255];</span>
0224 <span class="comment">%</span>
0225 <span class="comment">% %%% background color</span>
0226 <span class="comment">% sparam.bgcolor=[128,128,128];</span>
0227 <span class="comment">%</span>
0228 <span class="comment">% %%% background-patch colors (RGB)</span>
0229 <span class="comment">% sparam.bgtype=1; % 1: a simple background with sparam.bgcolor (then, the parameters belows are not used), 2: a background with grid guides</span>
0230 <span class="comment">% sparam.patch_size=[30,30]; % background patch size, [height,width] in pixels</span>
0231 <span class="comment">% sparam.patch_num=[20,40];  % the number of background patches along vertical and horizontal axis</span>
0232 <span class="comment">% sparam.patch_color1=[255,255,255];</span>
0233 <span class="comment">% sparam.patch_color2=[0,0,0];</span>
0234 <span class="comment">%</span>
0235 <span class="comment">% %%% for converting degree to pixels</span>
0236 <span class="comment">% run(fullfile(fileparts(mfilename('fullpath')),'sizeparams'));</span>
0237 <span class="comment">% %sparam.pix_per_cm=57.1429;</span>
0238 <span class="comment">% %sparam.vdist=65;</span>
0239 <span class="comment">% %sparam.ipd=6.5;</span>
0240 <span class="comment">%</span>
0241 <span class="comment">%</span>
0242 <span class="comment">% [HOWTO create stimulus files]</span>
0243 <span class="comment">% 1. All of the stimuli are created in this script in real-time</span>
0244 <span class="comment">%    with MATLAB scripts &amp; functions.</span>
0245 <span class="comment">%    see ../Generation &amp; ../Common directries.</span>
0246 <span class="comment">% 2. Stimulus parameters are defined in the display &amp; stimulus file.</span>
0247 <span class="comment">%</span>
0248 <span class="comment">%</span>
0249 <span class="comment">% [reference]</span>
0250 <span class="comment">% for stmulus generation, see ../Generation &amp; ../Common directories.</span>
0251 
0252 
0253 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0254 <span class="comment">%%%% Check the input variables</span>
0255 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0256 
0257 clear <span class="keyword">global</span>; clear mex;
0258 <span class="keyword">if</span> nargin&lt;3, help(mfilename()); <span class="keyword">return</span>; <span class="keyword">end</span>
0259 <span class="keyword">if</span> nargin&lt;4 || isempty(displayfile), displayfile=[]; <span class="keyword">end</span>
0260 <span class="keyword">if</span> nargin&lt;5 || isempty(stimulusfile), stimulusfile=[]; <span class="keyword">end</span>
0261 <span class="keyword">if</span> nargin&lt;6 || isempty(gamma_table), gamma_table=[]; <span class="keyword">end</span>
0262 <span class="keyword">if</span> nargin&lt;7 || isempty(overwrite_flg), overwrite_flg=1; <span class="keyword">end</span>
0263 <span class="keyword">if</span> nargin&lt;8 || isempty(force_proceed_flag), force_proceed_flag=0; <span class="keyword">end</span>
0264 
0265 <span class="comment">% check the aqcuisition number</span>
0266 <span class="keyword">if</span> acq&lt;1, error(<span class="string">'Acquistion number must be integer and greater than zero'</span>); <span class="keyword">end</span>
0267 
0268 <span class="comment">% check the experiment mode (stimulus type)</span>
0269 <span class="keyword">if</span> ~strcmpi(exp_mode,<span class="string">'ccwexp'</span>) &amp;&amp; ~strcmpi(exp_mode,<span class="string">'cwexp'</span>) &amp;&amp; ~strcmpi(exp_mode,<span class="string">'ccwcont'</span>) &amp;&amp; ~strcmpi(exp_mode,<span class="string">'cwcont'</span>)
0270   error(<span class="string">'exp_mode should be one of &quot;ccwexp&quot;, &quot;cwexp&quot;, &quot;ccwcont&quot;, and &quot;cwcont&quot;. check the input variable.'</span>);
0271 <span class="keyword">end</span>
0272 
0273 rootDir=fileparts(mfilename(<span class="string">'fullpath'</span>));
0274 
0275 <span class="comment">% check the subject directory</span>
0276 <span class="keyword">if</span> ~exist(fullfile(rootDir,<span class="string">'subjects'</span>,subjID),<span class="string">'dir'</span>), error(<span class="string">'can not find subj directory. check the input variable.'</span>); <span class="keyword">end</span>
0277 
0278 <span class="comment">% check the display/stimulus files</span>
0279 <span class="keyword">if</span> ~isempty(displayfile)
0280   <span class="keyword">if</span> ~strcmpi(displayfile(end-1:end),<span class="string">'.m'</span>), displayfile=[displayfile,<span class="string">'.m'</span>]; <span class="keyword">end</span>
0281   <span class="keyword">if</span> ~exist(fullfile(rootDir,<span class="string">'subjects'</span>,subjID,displayfile),<span class="string">'file'</span>), error(<span class="string">'displayfile not found. check the input variable.'</span>); <span class="keyword">end</span>
0282 <span class="keyword">end</span>
0283 
0284 <span class="keyword">if</span> ~isempty(stimulusfile)
0285   <span class="keyword">if</span> ~strcmpi(stimulusfile(end-1:end),<span class="string">'.m'</span>), stimulusfile=[stimulusfile,<span class="string">'.m'</span>]; <span class="keyword">end</span>
0286   <span class="keyword">if</span> ~exist(fullfile(rootDir,<span class="string">'subjects'</span>,subjID,stimulusfile),<span class="string">'file'</span>), error(<span class="string">'stimulusfile not found. check the input variable.'</span>); <span class="keyword">end</span>
0287 <span class="keyword">end</span>
0288 
0289 
0290 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0291 <span class="comment">%%%% Add path to the subfunctions</span>
0292 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0293 
0294 <span class="comment">% add paths to the subfunctions</span>
0295 addpath(genpath(fullfile(rootDir,<span class="string">'..'</span>,<span class="string">'Common'</span>)));
0296 addpath(fullfile(rootDir,<span class="string">'..'</span>,<span class="string">'Generation'</span>));
0297 
0298 
0299 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0300 <span class="comment">%%%% For log file</span>
0301 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0302 
0303 <span class="comment">% get date</span>
0304 today=datestr(now,<span class="string">'yymmdd'</span>);
0305 
0306 <span class="comment">% result directry &amp; file</span>
0307 resultDir=fullfile(rootDir,<span class="string">'subjects'</span>,num2str(subjID),<span class="string">'results'</span>,today);
0308 <span class="keyword">if</span> ~exist(resultDir,<span class="string">'dir'</span>), mkdir(resultDir); <span class="keyword">end</span>
0309 
0310 <span class="comment">% record the output window</span>
0311 logfname=fullfile(resultDir,[num2str(subjID),<span class="string">'_ddual_'</span>,exp_mode,<span class="string">'_results_run_'</span>,num2str(acq,<span class="string">'%02d'</span>),<span class="string">'.log'</span>]);
0312 diary(logfname);
0313 warning off; <span class="comment">%#ok warning('off','MATLAB:dispatcher:InexactCaseMatch');</span>
0314 
0315 
0316 <span class="comment">%%%%% try &amp; catch %%%%%</span>
0317 <span class="keyword">try</span>
0318 
0319 
0320 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0321 <span class="comment">%%%% Check the PTB version</span>
0322 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0323 
0324 PTB_OK=<a href="../../Retinotopy/Common/CheckPTBversion.html" class="code" title="function [PTB_OK,vertxt] = CheckPTBversion(num_mainver_youwant)">CheckPTBversion</a>(3); <span class="comment">% check wether the PTB version is 3</span>
0325 <span class="keyword">if</span> ~PTB_OK, error(<span class="string">'Wrong version of Psychtoolbox is running. %s requires PTB ver.3'</span>,mfilename()); <span class="keyword">end</span>
0326 
0327 <span class="comment">% debug level, black screen during calibration</span>
0328 Screen(<span class="string">'Preference'</span>, <span class="string">'VisualDebuglevel'</span>, 3);
0329 
0330 
0331 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0332 <span class="comment">%%%% Setup random seed</span>
0333 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0334 
0335 <a href="../../Retinotopy/Common/InitializeRandomSeed.html" class="code" title="function cseed=InitializeRandomSeed">InitializeRandomSeed</a>();
0336 
0337 
0338 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0339 <span class="comment">%%%% Reset display Gamma-function</span>
0340 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0341 
0342 <span class="keyword">if</span> isempty(gamma_table)
0343   gamma_table=repmat(linspace(0.0,1.0,256),3,1); <span class="comment">%#ok</span>
0344   <a href="../../Retinotopy/Common/GammaResetPTB.html" class="code" title="function GammaResetPTB(luminance_ratio)">GammaResetPTB</a>(1.0);
0345 <span class="keyword">else</span>
0346   <a href="../../Retinotopy/Common/GammaLoadPTB.html" class="code" title="function GammaLoadPTB(gamma_table)">GammaLoadPTB</a>(gamma_table);
0347 <span class="keyword">end</span>
0348 
0349 
0350 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0351 <span class="comment">%%%% Validate dparam (displayfile) and sparam (stimulusfile) structures</span>
0352 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0353 
0354 <span class="comment">% organize dparam</span>
0355 dparam=struct(); <span class="comment">% initialize</span>
0356 <span class="keyword">if</span> ~isempty(displayfile), run(fullfile(rootDir,<span class="string">'subjects'</span>,subjID,displayfile)); <span class="keyword">end</span> <span class="comment">% load specific dparam parameters configured for each of the participants</span>
0357 dparam=<a href="../../Retinotopy/Common/ValidateStructureFields.html" class="code" title="function structval=ValidateStructureFields(structval,varargin)">ValidateStructureFields</a>(dparam,<span class="keyword">...</span><span class="comment"> % validate fields and set the default values to missing field(s)</span>
0358          <span class="string">'ExpMode'</span>,<span class="string">'mono'</span>,<span class="keyword">...</span>
0359          <span class="string">'scrID'</span>,1,<span class="keyword">...</span>
0360          <span class="string">'start_method'</span>,0,<span class="keyword">...</span>
0361          <span class="string">'custom_trigger'</span>,<span class="string">'t'</span>,<span class="keyword">...</span>
0362          <span class="string">'Key1'</span>,51,<span class="keyword">...</span>
0363          <span class="string">'Key2'</span>,52,<span class="keyword">...</span>
0364          <span class="string">'fullscr'</span>,false,<span class="keyword">...</span>
0365          <span class="string">'ScrHeight'</span>,1200,<span class="keyword">...</span>
0366          <span class="string">'ScrWidth'</span>,1920,<span class="keyword">...</span>
0367          <span class="string">'force_frame_rate'</span>,60,<span class="keyword">...</span>
0368          <span class="string">'skip_sync_test'</span>,0);
0369 
0370 <span class="comment">% organize sparam</span>
0371 sparam=struct(); <span class="comment">% initialize</span>
0372 sparam.mode=exp_mode;
0373 <span class="keyword">if</span> ~isempty(stimulusfile), run(fullfile(rootDir,<span class="string">'subjects'</span>,subjID,stimulusfile)); <span class="keyword">end</span> <span class="comment">% load specific sparam parameters configured for each of the participants</span>
0374 sparam=<a href="../../Retinotopy/Common/ValidateStructureFields.html" class="code" title="function structval=ValidateStructureFields(structval,varargin)">ValidateStructureFields</a>(sparam,<span class="keyword">...</span><span class="comment"> % validate fields and set the default values to missing field(s)</span>
0375          <span class="string">'pol_nwedges'</span>,4,<span class="keyword">...</span>
0376          <span class="string">'pol_nrings'</span>,4,<span class="keyword">...</span>
0377          <span class="string">'pol_width'</span>,48,<span class="keyword">...</span>
0378          <span class="string">'pol_phase'</span>,0,<span class="keyword">...</span>
0379          <span class="string">'pol_rotangle'</span>,12,<span class="keyword">...</span>
0380          <span class="string">'pol_startangle'</span>,-48/2-90,<span class="keyword">...</span>
0381          <span class="string">'ecc_nwedges'</span>,4,<span class="keyword">...</span>
0382          <span class="string">'ecc_nrings'</span>,2,<span class="keyword">...</span>
0383          <span class="string">'ecc_width'</span>,48,<span class="keyword">...</span>
0384          <span class="string">'ecc_phase'</span>,0,<span class="keyword">...</span>
0385          <span class="string">'ecc_rotangle'</span>,12,<span class="keyword">...</span>
0386          <span class="string">'ecc_startangle'</span>,-48/2-90,<span class="keyword">...</span>
0387          <span class="string">'maxRad'</span>,8,<span class="keyword">...</span>
0388          <span class="string">'minRad'</span>,0,<span class="keyword">...</span>
0389          <span class="string">'RDSdepth'</span>,[-12,12,5],<span class="keyword">...</span>
0390          <span class="string">'RDSDense'</span>,0.5,<span class="keyword">...</span>
0391          <span class="string">'RDSradius'</span>,0.05,<span class="keyword">...</span>
0392          <span class="string">'RDScolors'</span>,[255,0,128],<span class="keyword">...</span>
0393          <span class="string">'RDSbackground'</span>,0,<span class="keyword">...</span>
0394          <span class="string">'RDStaskmagnitude'</span>,2,<span class="keyword">...</span>
0395          <span class="string">'pol_cycle_duration'</span>,60000,<span class="keyword">...</span>
0396          <span class="string">'pol_rest_duration'</span>,0,<span class="keyword">...</span>
0397          <span class="string">'pol_numRepeats'</span>,6,<span class="keyword">...</span>
0398          <span class="string">'ecc_cycle_duration'</span>,40000,<span class="keyword">...</span>
0399          <span class="string">'ecc_rest_duration'</span>,8000,<span class="keyword">...</span>
0400          <span class="string">'ecc_numRepeats'</span>,9,<span class="keyword">...</span>
0401          <span class="string">'waitframes'</span>,6,<span class="keyword">...</span><span class="comment"> % Screen('FrameRate',0)*(sparam.cycle_duration/1000) / (360/sparam.rotangle) / ( (size(sparam.colors,1)-1)*2 );</span>
0402          <span class="string">'initial_fixation_time'</span>,[4000,4000],<span class="keyword">...</span>
0403          <span class="string">'fixtype'</span>,1,<span class="keyword">...</span>
0404          <span class="string">'fixsize'</span>,12,<span class="keyword">...</span>
0405          <span class="string">'fixcolor'</span>,[255,255,255],<span class="keyword">...</span>
0406          <span class="string">'bgcolor'</span>,[128,128,128],<span class="keyword">...</span><span class="comment"> % sparam.colors(1,:);</span>
0407          <span class="string">'bgtype'</span>,1,<span class="keyword">...</span>
0408          <span class="string">'patch_size'</span>,[30,30],<span class="keyword">...</span>
0409          <span class="string">'patch_num'</span>,[20,40],<span class="keyword">...</span>
0410          <span class="string">'patch_color1'</span>,[255,255,255],<span class="keyword">...</span>
0411          <span class="string">'patch_color2'</span>,[0,0,0],<span class="keyword">...</span>
0412          <span class="string">'pix_per_cm'</span>,57.1429,<span class="keyword">...</span>
0413          <span class="string">'vdist'</span>,65);
0414 
0415 <span class="comment">% change unit from msec to sec.</span>
0416 sparam.initial_fixation_time=sparam.initial_fixation_time./1000; <span class="comment">%#ok</span>
0417 
0418 <span class="comment">% change unit from msec to sec.</span>
0419 sparam.pol_cycle_duration = sparam.pol_cycle_duration./1000;
0420 sparam.pol_rest_duration  = sparam.pol_rest_duration./1000;
0421 
0422 sparam.ecc_cycle_duration = sparam.ecc_cycle_duration./1000;
0423 sparam.ecc_rest_duration  = sparam.ecc_rest_duration./1000;
0424 
0425 <span class="comment">% set the other parameters</span>
0426 dparam.RunScript = mfilename();
0427 sparam.RunScript = mfilename();
0428 
0429 <span class="comment">%% check varidity of parameters</span>
0430 fprintf(<span class="string">'checking validity of stimulus generation/presentation parameters...'</span>);
0431 <span class="keyword">if</span> sparam.pol_cycle_duration*sparam.pol_numRepeats~=sparam.ecc_cycle_duration*sparam.ecc_numRepeats
0432   error(<span class="string">'sparam.pol_cycle_duration x sparam.pol_numRepeats should be the same with sparam.ecc_cycle_duration x sparam.ecc_numRepeats. check the input variables.'</span>);
0433 <span class="keyword">end</span>
0434 <span class="keyword">if</span> mod(360,sparam.pol_rotangle), error(<span class="string">'mod(360,sparam.pol_rotangle) should be 0. check the input variables.'</span>); <span class="keyword">end</span>
0435 <span class="keyword">if</span> mod(360,sparam.ecc_rotangle), error(<span class="string">'mod(360,sparam.ecc_rotangle) should be 0. check the input variables.'</span>); <span class="keyword">end</span>
0436 <span class="keyword">if</span> mod(sparam.pol_width,sparam.pol_rotangle), error(<span class="string">'mod(sparam.pol_width,sparam.pol_rotangle) should be 0. check the input variables.'</span>); <span class="keyword">end</span>
0437 <span class="keyword">if</span> mod(sparam.ecc_width,sparam.ecc_rotangle), error(<span class="string">'mod(sparam.ecc_width,sparam.ecc_rotangle) should be 0. check the input variables.'</span>); <span class="keyword">end</span>
0438 fprintf(<span class="string">'done.\n'</span>);
0439 
0440 
0441 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0442 <span class="comment">%%%% Displaying the presentation parameters you set</span>
0443 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0444 
0445 fprintf(<span class="string">'The Presentation Parameters are as below.\n\n'</span>);
0446 fprintf(<span class="string">'************************************************\n'</span>);
0447 fprintf(<span class="string">'****** Script, Subject, Acquistion Number ******\n'</span>);
0448 fprintf(<span class="string">'Date &amp; Time            : %s\n'</span>,strcat([datestr(now,<span class="string">'yymmdd'</span>),<span class="string">' '</span>,datestr(now,<span class="string">'HH:mm:ss'</span>)]));
0449 fprintf(<span class="string">'Running Script Name    : %s\n'</span>,mfilename());
0450 fprintf(<span class="string">'Subject ID             : %s\n'</span>,subjID);
0451 fprintf(<span class="string">'Acquisition Number     : %d\n'</span>,acq);
0452 fprintf(<span class="string">'********* Run Type, Display Image Type *********\n'</span>);
0453 fprintf(<span class="string">'Display Mode           : %s\n'</span>,dparam.ExpMode);
0454 fprintf(<span class="string">'use Full Screen Mode   : %d\n'</span>,dparam.fullscr);
0455 fprintf(<span class="string">'Start Method           : %d\n'</span>,dparam.start_method);
0456 <span class="keyword">if</span> dparam.start_method==4
0457   fprintf(<span class="string">'Custom Trigger         : %d\n'</span>,dparam.custom_trigger);
0458 <span class="keyword">end</span>
0459 fprintf(<span class="string">'*************** Screen Settings ****************\n'</span>);
0460 fprintf(<span class="string">'Screen Height          : %d\n'</span>,dparam.ScrHeight);
0461 fprintf(<span class="string">'Screen Width           : %d\n'</span>,dparam.ScrWidth);
0462 fprintf(<span class="string">'*********** Stimulation Periods etc. ***********\n'</span>);
0463 fprintf(<span class="string">'Fixation Time(sec)     : %d &amp; %d\n'</span>,sparam.initial_fixation_time(1),sparam.initial_fixation_time(2));
0464 fprintf(<span class="string">'[POL] Cycle Duration(sec) : %d\n'</span>,sparam.pol_cycle_duration);
0465 fprintf(<span class="string">'      Rest  Duration(sec) : %d\n'</span>,sparam.pol_rest_duration);
0466 fprintf(<span class="string">'      Repetitions(cycles) : %d\n'</span>,sparam.pol_numRepeats);
0467 fprintf(<span class="string">'[ECC] Cycle Duration(sec) : %d\n'</span>,sparam.ecc_cycle_duration);
0468 fprintf(<span class="string">'      Rest  Duration(sec) : %d\n'</span>,sparam.ecc_rest_duration);
0469 fprintf(<span class="string">'      Repetitions(cycles) : %d\n'</span>,sparam.ecc_numRepeats);
0470 fprintf(<span class="string">'Frame Flip(per VerSync): %d\n'</span>,sparam.waitframes);
0471 fprintf(<span class="string">'Total Time (sec)       : %d\n'</span>,sum(sparam.initial_fixation_time)+sparam.pol_numRepeats*sparam.pol_cycle_duration);
0472 fprintf(<span class="string">'**************** Stimulus Type *****************\n'</span>);
0473 fprintf(<span class="string">'Experiment Mode        : %s\n'</span>,sparam.mode);
0474 fprintf(<span class="string">'************ Response key settings *************\n'</span>);
0475 fprintf(<span class="string">'Reponse Key #1         : %d = %s\n'</span>,dparam.Key1,KbName(dparam.Key1));
0476 fprintf(<span class="string">'Reponse Key #2         : %d = %s\n'</span>,dparam.Key2,KbName(dparam.Key2));
0477 fprintf(<span class="string">'************************************************\n\n'</span>);
0478 fprintf(<span class="string">'Please carefully check before proceeding.\n\n'</span>);
0479 
0480 
0481 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0482 <span class="comment">%%%% Initialize response &amp; event logger objects</span>
0483 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0484 
0485 <span class="comment">% initialize MATLAB objects for event and response logs</span>
0486 event=<a href="../../Retinotopy/Common/eventlogger.html" class="code" title="">eventlogger</a>();
0487 resps=<a href="../../Retinotopy/Common/responselogger.html" class="code" title="">responselogger</a>([dparam.Key1,dparam.Key2]);
0488 resps.initialize(event); <span class="comment">% initialize responselogger</span>
0489 
0490 
0491 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0492 <span class="comment">%%%% Wait for user reponse to start</span>
0493 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0494 
0495 <span class="keyword">if</span> ~force_proceed_flag
0496   [user_answer,resps]=resps.wait_to_proceed();
0497   <span class="keyword">if</span> ~user_answer, diary off; <span class="keyword">return</span>; <span class="keyword">end</span>
0498 <span class="keyword">end</span>
0499 
0500 
0501 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0502 <span class="comment">%%%% Initialization of Left &amp; Right screens for binocular presenting/viewing mode</span>
0503 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0504 
0505 <span class="keyword">if</span> dparam.skip_sync_test, Screen(<span class="string">'Preference'</span>,<span class="string">'SkipSyncTests'</span>,1); <span class="keyword">end</span>
0506 
0507 [winPtr,winRect,nScr,dparam.fps,dparam.ifi,initDisplay_OK]=<a href="../../Retinotopy/Common/InitializePTBDisplays.html" class="code" title="function [winPtr,winRect,nScr,fps,ifi,initDisplay_OK]=InitializePTBDisplays(disp_mode,bgcolor,flipping,rgb_gains,custom_scrIDs)">InitializePTBDisplays</a>(dparam.ExpMode,sparam.bgcolor,0,[],dparam.scrID);
0508 <span class="keyword">if</span> ~initDisplay_OK, error(<span class="string">'Display initialization error. Please check your exp_run parameter.'</span>); <span class="keyword">end</span>
0509 HideCursor();
0510 
0511 <span class="keyword">if</span> <a href="../../Retinotopy/Common/isstructmember.html" class="code" title="function isFieldResult = isstructmember(inStruct, fieldName)">isstructmember</a>(dparam,<span class="string">'force_frame_rate'</span>)
0512   <span class="keyword">if</span> dparam.force_frame_rate
0513     dparam.fps=dparam.force_frame_rate;
0514     dparam.ifi=1/dparam.fps;
0515   <span class="keyword">end</span>
0516 <span class="keyword">end</span>
0517 
0518 
0519 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0520 <span class="comment">%%%% Setting the PTB runnning priority to MAX</span>
0521 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0522 
0523 <span class="comment">% set the priority of this script to MAX</span>
0524 priorityLevel=MaxPriority(winPtr,<span class="string">'WaitBlanking'</span>);
0525 Priority(priorityLevel);
0526 
0527 <span class="comment">% conserve VRAM memory: Workaround for flawed hardware and drivers</span>
0528 <span class="comment">% 32 == kPsychDontShareContextRessources: Do not share ressources between</span>
0529 <span class="comment">% different onscreen windows. Usually you want PTB to share all ressources</span>
0530 <span class="comment">% like offscreen windows, textures and GLSL shaders among all open onscreen</span>
0531 <span class="comment">% windows. If that causes trouble for some weird reason, you can prevent</span>
0532 <span class="comment">% automatic sharing with this flag.</span>
0533 <span class="comment">%Screen('Preference','ConserveVRAM',32);</span>
0534 
0535 
0536 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0537 <span class="comment">%%%% Setting the PTB OpenGL functions</span>
0538 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0539 
0540 <span class="comment">% Enable OpenGL mode of Psychtoolbox: This is crucially needed for clut animation</span>
0541 InitializeMatlabOpenGL();
0542 
0543 <span class="comment">% This script calls Psychtoolbox commands available only in OpenGL-based</span>
0544 <span class="comment">% versions of the Psychtoolbox. (So far, the OS X Psychtoolbox is the</span>
0545 <span class="comment">% only OpenGL-base Psychtoolbox.)  The Psychtoolbox command AssertPsychOpenGL will issue</span>
0546 <span class="comment">% an error message if someone tries to execute this script on a computer without</span>
0547 <span class="comment">% an OpenGL Psychtoolbox</span>
0548 AssertOpenGL();
0549 
0550 <span class="comment">% set OpenGL blend functions</span>
0551 Screen(<span class="string">'BlendFunction'</span>, winPtr, GL_SRC_ALPHA, GL_ONE_MINUS_SRC_ALPHA);
0552 
0553 
0554 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0555 <span class="comment">%%%% Displaying 'Initializing...'</span>
0556 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0557 
0558 <span class="comment">% displaying texts on the center of the screen</span>
0559 <a href="../../Retinotopy/Common/DisplayMessage2.html" class="code" title="function DisplayMessage2(message,bgcolor,winPtr,numScreens,drawing_font,drawing_size)">DisplayMessage2</a>(<span class="string">'Initializing...'</span>,sparam.bgcolor,winPtr,nScr,<span class="string">'Arial'</span>,36);
0560 
0561 
0562 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0563 <span class="comment">%%%% Initializing variables</span>
0564 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0565 
0566 <span class="comment">%% unit conversion</span>
0567 
0568 <span class="comment">% cm per pix</span>
0569 sparam.cm_per_pix=1/sparam.pix_per_cm;
0570 
0571 <span class="comment">% pixles per degree</span>
0572 sparam.pix_per_deg=round( 1/( 180*atan(sparam.cm_per_pix/sparam.vdist)/pi ) );
0573 
0574 <span class="comment">% deg to radian</span>
0575 <span class="comment">% do not convert!</span>
0576 <span class="comment">% sparam.width, sparam.phase, sparam.startangle, sparam.rotangle are used in deg formats</span>
0577 
0578 <span class="comment">% sec to number of frames</span>
0579 nframe_fixation=round(sparam.initial_fixation_time.*dparam.fps./sparam.waitframes);
0580 
0581 sparam.pol_npositions=360/sparam.pol_rotangle;
0582 sparam.ecc_npositions=sparam.pol_npositions*(sparam.ecc_cycle_duration-sparam.ecc_rest_duration)/(sparam.pol_cycle_duration-sparam.pol_rest_duration);
0583 
0584 nframe_stim=round((sparam.pol_cycle_duration-sparam.pol_rest_duration)*dparam.fps/(360/sparam.pol_rotangle)/sparam.waitframes);
0585 nframe_flicker=round(nframe_stim/sparam.RDSdepth(3)/4);
0586 nframe_task=round(nframe_stim/2);
0587 
0588 <span class="comment">%% initialize chackerboard parameters</span>
0589 
0590 <span class="comment">% adjust size ratio considering full-screen effect</span>
0591 <span class="keyword">if</span> dparam.fullscr
0592   <span class="comment">% here, use width information alone, assuming that the pixel is square</span>
0593   ratio_wid=( winRect(3)-winRect(1) )/dparam.ScrWidth;
0594   <span class="comment">%ratio_hei=( winRect(4)-winRect(2) )/dparam.ScrHeight;</span>
0595 
0596   <span class="comment">% min/max radius of annulus</span>
0597   rmin=sparam.minRad*ratio_wid; <span class="comment">% !!! degree, not pixel or cm !!!</span>
0598   rmax=sparam.maxRad*ratio_wid;
0599 <span class="keyword">else</span>
0600   rmin=sparam.minRad;
0601   rmax=sparam.maxRad;
0602 <span class="keyword">end</span>
0603 
0604 
0605 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0606 <span class="comment">%%%% Generating checkerboard patterns</span>
0607 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0608 
0609 <span class="comment">% [note]</span>
0610 <span class="comment">% After this processing, each checkerboard image has checker elements with values as shown below</span>
0611 <span class="comment">% 0 = background</span>
0612 <span class="comment">% 1 = checker ID 1</span>
0613 <span class="comment">% 2 = checker ID 2</span>
0614 <span class="comment">% 3 = checker ID 3</span>
0615 <span class="comment">% .....</span>
0616 <span class="comment">% sparam.npatches = checker ID</span>
0617 <span class="comment">% Each patch ID will be associated with a CLUT color of the same ID</span>
0618 
0619 <span class="comment">%%% a wedge for polar representation</span>
0620 startangles=zeros(sparam.pol_npositions,1);
0621 <span class="keyword">for</span> nn=1:1:sparam.pol_npositions, startangles(nn)=sparam.pol_startangle+(nn-1)*sparam.pol_rotangle; <span class="keyword">end</span>
0622 
0623 [pol_checkerboardID,pol_checkerboard]=<a href="../../Retinotopy/Generation/pol_GenerateCheckerBoard1D.html" class="code" title="function [checkerboard,bincheckerboard,mask]=pol_GenerateCheckerBoard1D(rmin,rmax,width,startangle,pix_per_deg,nwedges,nrings,phase,dual_flg)">pol_GenerateCheckerBoard1D</a>(rmin,rmax,sparam.pol_width,startangles,sparam.pix_per_deg,<span class="keyword">...</span>
0624                                                                        sparam.pol_nwedges,sparam.pol_nrings,sparam.pol_phase);
0625 
0626 <span class="comment">%%% an annulus for eccentricity representation</span>
0627 eccedge=(rmax-rmin)/( sparam.ecc_npositions-1 );
0628 eccwidth=eccedge*(sparam.ecc_width/sparam.ecc_rotangle);
0629 
0630 <span class="comment">% get annuli's min/max lims</span>
0631 ecclims=zeros(sparam.ecc_npositions,3);
0632 <span class="keyword">for</span> nn=1:1:sparam.ecc_npositions <span class="comment">%1:1:sparam.npositions</span>
0633   minlim=rmin+(nn-1)*eccedge-eccwidth/2;
0634   <span class="keyword">if</span> minlim&lt;rmin, minlim=rmin; <span class="keyword">end</span>
0635   maxlim=rmin+(nn-1)*eccedge+eccwidth/2;
0636   <span class="keyword">if</span> maxlim&gt;rmax, maxlim=rmax; <span class="keyword">end</span>
0637 
0638   ecclims(nn,:)=[minlim,maxlim,eccwidth];
0639 <span class="keyword">end</span>
0640 
0641 [ecc_checkerboardID,ecc_checkerboard]=<a href="../../Retinotopy/Generation/ecc_GenerateCheckerBoard1D.html" class="code" title="function [checkerboard,bincheckerboard,mask]=ecc_GenerateCheckerBoard1D(edges,width,startangle,pix_per_deg,nwedges,nrings,phase)">ecc_GenerateCheckerBoard1D</a>(ecclims,360,sparam.ecc_startangle,sparam.pix_per_deg,<span class="keyword">...</span>
0642                                       round(360*sparam.ecc_nwedges/sparam.ecc_width),sparam.ecc_nrings,sparam.ecc_phase);
0643 
0644 <span class="comment">%% flip all data for ccw/cont</span>
0645 <span class="keyword">if</span> ~isempty(strfind(sparam.mode,<span class="string">'ccw'</span>))
0646 
0647   tmp_checkerboardID=cell(sparam.pol_npositions,1);
0648   <span class="keyword">for</span> nn=1:1:sparam.pol_npositions, tmp_checkerboardID{nn}=pol_checkerboardID{sparam.pol_npositions-(nn-1)}; <span class="keyword">end</span>
0649   pol_checkerboardID=tmp_checkerboardID;
0650   clear tmp_checkerboardID;
0651 
0652   tmp_checkerboard=cell(sparam.pol_npositions,1);
0653   <span class="keyword">for</span> nn=1:1:sparam.pol_npositions, tmp_checkerboard{nn}=pol_checkerboard{sparam.pol_npositions-(nn-1)}; <span class="keyword">end</span>
0654   pol_checkerboard=tmp_checkerboard;
0655   clear tmp_checkerboard;
0656 
0657 <span class="keyword">end</span>
0658 
0659 <span class="keyword">if</span> ~isempty(strfind(sparam.mode,<span class="string">'cont'</span>))
0660 
0661   tmp_checkerboardID=cell(sparam.ecc_npositions,1);
0662   <span class="keyword">for</span> nn=1:1:sparam.ecc_npositions, tmp_checkerboardID{nn}=ecc_checkerboardID{sparam.ecc_npositions-(nn-1)}; <span class="keyword">end</span>
0663   ecc_checkerboardID=tmp_checkerboardID;
0664   clear tmp_checkerboardID;
0665 
0666   tmp_checkerboard=cell(sparam.ecc_npositions,1);
0667   <span class="keyword">for</span> nn=1:1:sparam.ecc_npositions, tmp_checkerboard{nn}=ecc_checkerboard{sparam.ecc_npositions-(nn-1)}; <span class="keyword">end</span>
0668   ecc_checkerboard=tmp_checkerboard;
0669   clear tmp_checkerboard;
0670 
0671 <span class="keyword">end</span>
0672 
0673 <span class="comment">%%% generate the combined checkerboard patterns</span>
0674 
0675 commduration=lcm(sparam.pol_cycle_duration,sparam.ecc_cycle_duration); <span class="comment">% the least common multiple duration at which the stimulus rotation turns to the beginning.</span>
0676 <span class="keyword">if</span> commduration&lt;sparam.pol_cycle_duration*sparam.pol_numRepeats
0677   pol_subrepeats=ceil(commduration/sparam.pol_cycle_duration);
0678   ecc_subrepeats=ceil(commduration/sparam.ecc_cycle_duration);
0679 <span class="keyword">else</span>
0680   fprintf(<span class="string">'WARNING: It is recommended to adjust the sparam parameters so that lcm(sparam.pol_cycle_duration,sparam.ecc_cycle_duration) is less than sparam.pol_cycle_duration*sparam.pol_numRepeats\n'</span>);
0681   pol_subrepeats=sparam.pol_numRepeats;
0682   ecc_subrepeats=sparam.ecc_numRepeats;
0683 <span class="keyword">end</span>
0684 
0685 <span class="comment">% put the rest period for polar patterns</span>
0686 nrest=sparam.pol_npositions/(sparam.pol_cycle_duration-sparam.pol_rest_duration)*sparam.pol_rest_duration;
0687 <span class="keyword">if</span> nrest&gt;0
0688   <span class="keyword">if</span> ~isempty(strfind(sparam.mode,<span class="string">'ccw'</span>))
0689     pol_checkerboard=[pol_checkerboard;repmat({zeros(size(pol_checkerboard{1}))},nrest,1)];
0690     pol_checkerboardID=[pol_checkerboardID;repmat({zeros(size(pol_checkerboardID{1}))},nrest,1)];
0691   <span class="keyword">else</span> <span class="comment">% if ~isempty(strfind(sparam.mode,'cw'))</span>
0692     pol_checkerboard=[repmat({zeros(size(pol_checkerboard{1}))},nrest,1);pol_checkerboard];
0693     pol_checkerboardID=[repmat({zeros(size(pol_checkerboardID{1}))},nrest,1);pol_checkerboardID];
0694   <span class="keyword">end</span>
0695 <span class="keyword">end</span>
0696 
0697 <span class="comment">% put the rest period for eccentricity patterns</span>
0698 nrest=sparam.ecc_npositions/(sparam.ecc_cycle_duration-sparam.ecc_rest_duration)*sparam.ecc_rest_duration;
0699 <span class="keyword">if</span> nrest&gt;0
0700   <span class="keyword">if</span> ~isempty(strfind(sparam.mode,<span class="string">'cont'</span>))
0701     ecc_checkerboard=[repmat({zeros(size(ecc_checkerboard{1}))},nrest,1);ecc_checkerboard];
0702     ecc_checkerboardID=[repmat({zeros(size(ecc_checkerboardID{1}))},nrest,1);ecc_checkerboardID];
0703   <span class="keyword">else</span> <span class="comment">% if ~isempty(strfind(sparam.mode,'ecc'))</span>
0704     ecc_checkerboard=[ecc_checkerboard;repmat({zeros(size(ecc_checkerboard{1}))},nrest,1)];
0705     ecc_checkerboardID=[ecc_checkerboardID;repmat({zeros(size(ecc_checkerboardID{1}))},nrest,1)];
0706   <span class="keyword">end</span>
0707 <span class="keyword">end</span>
0708 
0709 <span class="comment">% multiply the patterns for the pol_subrepeats</span>
0710 pol_checkerboard=repmat(pol_checkerboard,pol_subrepeats,1);
0711 pol_checkerboardID=repmat(pol_checkerboardID,pol_subrepeats,1);
0712 
0713 <span class="comment">% initialize the final checkerboard by eccentricity patterns</span>
0714 checkerboard=repmat(ecc_checkerboard,ecc_subrepeats,1);
0715 checkerboardID=repmat(ecc_checkerboardID,ecc_subrepeats,1);
0716 
0717 <span class="comment">% get the maximum ID of the ecc_checkerboardID</span>
0718 maxID=1;
0719 <span class="keyword">for</span> nn=1:1:length(ecc_checkerboardID)
0720   <span class="keyword">if</span> maxID&lt;max(ecc_checkerboardID{nn}(:))
0721     maxID=max(ecc_checkerboardID{nn}(:));
0722   <span class="keyword">end</span>
0723 <span class="keyword">end</span>
0724 
0725 <span class="comment">% overwrite the polar patterns</span>
0726 <span class="keyword">for</span> nn=1:1:length(pol_checkerboard)
0727   checkerboard{nn}(pol_checkerboard{nn}~=0)=pol_checkerboard{nn}(pol_checkerboard{nn}~=0);
0728   checkerboardID{nn}(pol_checkerboardID{nn}~=0)=pol_checkerboardID{nn}(pol_checkerboardID{nn}~=0)+maxID; <span class="comment">% +maxID is required to avoid overlapping of the IDs</span>
0729 <span class="keyword">end</span>
0730 clear pol_checkerboard pol_checkerboardID ecc_checkerboard ecc_checkerboardID;
0731 
0732 <span class="comment">% generate the final checkerboard patterns</span>
0733 subrepeats=ceil(sparam.pol_numRepeats/pol_subrepeats);
0734 checkerboard=repmat(checkerboard,[subrepeats,1]);
0735 checkerboardID=repmat(checkerboardID,[subrepeats,1]);
0736 
0737 <span class="comment">% cut the patterns that exceeds the whole stimulus presentation trials</span>
0738 <span class="keyword">if</span> length(checkerboard) &gt; sparam.pol_cycle_duration*sparam.pol_numRepeats/(sparam.pol_cycle_duration/sparam.pol_npositions)
0739   checkerboard=checkerboard(1:sparam.pol_cycle_duration*sparam.pol_numRepeats/(sparam.pol_cycle_duration/sparam.pol_npositions));
0740 <span class="keyword">end</span>
0741 
0742 <span class="comment">%% update number of patches and number of wedges, taking into an account of checkerboard phase shift</span>
0743 
0744 <span class="comment">% here, all parameters are generated for each checkerboard</span>
0745 <span class="comment">% This looks circuitous, duplicating procedures, and it consumes more CPU and memory.</span>
0746 <span class="comment">% 'if' statements may be better.</span>
0747 <span class="comment">% However, to decrease the number of 'if' statement after starting stimulus</span>
0748 <span class="comment">% presentation as possible as I can, I will do adopt this circuitous procedures.</span>
0749 patchids=cell(length(checkerboard),1);
0750 
0751 <span class="comment">% in the bar presentation, the number of patches/wedges are different over time</span>
0752 <span class="comment">% because a part of the bar can be occluded by the circular aperture mask.</span>
0753 <span class="comment">% therefore, we have to re-compute the patches and the corresponding IDs here.</span>
0754 <span class="keyword">for</span> cc=1:1:length(checkerboard)
0755   patchids{cc}=unique(checkerboardID{cc})';
0756   patchids{cc}=patchids{cc}(2:end); <span class="comment">% omit background id</span>
0757 <span class="keyword">end</span>
0758 
0759 <span class="comment">%% generate a circular mask</span>
0760 <span class="keyword">if</span> sparam.RDSbackground
0761   [dummy1,dummy2,mask]=<a href="../../Retinotopy/Generation/pol_GenerateCheckerBoard1D.html" class="code" title="function [checkerboard,bincheckerboard,mask]=pol_GenerateCheckerBoard1D(rmin,rmax,width,startangle,pix_per_deg,nwedges,nrings,phase,dual_flg)">pol_GenerateCheckerBoard1D</a>(rmin,rmax,360,0,sparam.pix_per_deg,1,1,0);
0762   <span class="keyword">for</span> nn=1:1:length(checkerboard), checkerboard{nn}(~logical(mask{1}))=NaN; <span class="keyword">end</span>
0763 <span class="keyword">else</span>
0764   <span class="keyword">for</span> nn=1:1:length(checkerboard), checkerboard{nn}(~logical(checkerboard{nn}))=NaN; <span class="keyword">end</span>
0765 <span class="keyword">end</span>
0766 
0767 <span class="comment">% generating the first RDS</span>
0768 [XY,colors]=<a href="../../Retinotopy/Generation/GetDotPositionsRDS.html" class="code" title="function [XY,colors]=GetDotPositionsRDS(checkerboard,depths,dotdense,RDScolors,ipd,vdist,pix_per_cm)">GetDotPositionsRDS</a>(checkerboard{1},[0,sparam.RDSdepth(1),sparam.RDSdepth(2)],sparam.RDSDense,<span class="keyword">...</span>
0769                                sparam.RDScolors(1:2),sparam.ipd,sparam.vdist,sparam.pix_per_cm);
0770 
0771 
0772 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0773 <span class="comment">%%%% Debug codes</span>
0774 <span class="comment">%%%% saving the stimulus images as *.png format files and enter the debug (keyboard) mode</span>
0775 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0776 
0777 <span class="comment">% %%%%%% DEBUG codes start here</span>
0778 <span class="comment">% note: debug stimuli have no jitters of binocular disparity</span>
0779 <span class="keyword">if</span> strfind(upper(subjID),<span class="string">'DEBUG'</span>)
0780 
0781   Screen(<span class="string">'CloseAll'</span>);
0782 
0783   save_dir=fullfile(resultDir,<span class="string">'images_ddual'</span>);
0784   <span class="keyword">if</span> ~exist(save_dir,<span class="string">'dir'</span>), mkdir(save_dir); <span class="keyword">end</span>
0785 
0786   <span class="comment">% open a new window for drawing stimuli</span>
0787   stimRect=[0,0,size(checkerboard{1},2),size(checkerboard{1},1)];
0788   [winPtr,winRect]=Screen(<span class="string">'OpenWindow'</span>,dparam.scrID,sparam.bgcolor,CenterRect(stimRect,Screen(<span class="string">'Rect'</span>,dparam.scrID)));
0789 
0790   <span class="comment">% set OpenGL</span>
0791   priorityLevel=MaxPriority(winPtr,<span class="string">'WaitBlanking'</span>);
0792   Priority(priorityLevel);
0793   AssertOpenGL();
0794   Screen(<span class="string">'BlendFunction'</span>, winPtr, GL_SRC_ALPHA, GL_ONE_MINUS_SRC_ALPHA);
0795 
0796   <span class="comment">% processing</span>
0797   <span class="keyword">for</span> cc=1:1:length(checkerboard)
0798     <span class="keyword">for</span> rr=1:1:round(nframe_stim/(nframe_flicker*sparam.RDSdepth(3)))
0799       <span class="keyword">for</span> mm=1:1:sparam.RDSdepth(3) <span class="comment">% depth steps</span>
0800 
0801         <span class="comment">% generate/get dot positions/colors</span>
0802         <span class="keyword">if</span> sparam.RDSdepth(3)~=1
0803           depth1=sparam.RDSdepth(1)+(mm-1)*(sparam.RDSdepth(2)-sparam.RDSdepth(1))/(sparam.RDSdepth(3)-1);
0804           depth2=sparam.RDSdepth(2)-(mm-1)*(sparam.RDSdepth(2)-sparam.RDSdepth(1))/(sparam.RDSdepth(3)-1);
0805         <span class="keyword">else</span>
0806           depth1=sparam.RDSdepth(1);
0807           depth2=sparam.RDSdepth(2);
0808         <span class="keyword">end</span>
0809         [XY,colors]=<a href="../../Retinotopy/Generation/GetDotPositionsRDS.html" class="code" title="function [XY,colors]=GetDotPositionsRDS(checkerboard,depths,dotdense,RDScolors,ipd,vdist,pix_per_cm)">GetDotPositionsRDS</a>(checkerboard{cc},[0,depth1,depth2],sparam.RDSDense,<span class="keyword">...</span>
0810                                        sparam.RDScolors(1:2),sparam.ipd,sparam.vdist,sparam.pix_per_cm);
0811 
0812         <span class="keyword">for</span> pp=1:1:2 <span class="comment">% left and right images</span>
0813           Screen(<span class="string">'FillRect'</span>,winPtr,sparam.bgcolor,stimRect); <span class="comment">% wipe the background just in case</span>
0814           Screen(<span class="string">'DrawDots'</span>,winPtr,XY{pp},2*sparam.RDSradius*sparam.pix_per_deg,colors{pp},[0,0],3); <span class="comment">% RDS</span>
0815 
0816           <span class="comment">% flip the window</span>
0817           Screen(<span class="string">'DrawingFinished'</span>,winPtr);
0818           Screen(<span class="string">'Flip'</span>,winPtr,[],[],[],1);
0819 
0820           <span class="comment">% get the current frame and save it</span>
0821           imwrite(Screen(<span class="string">'GetImage'</span>,winPtr,winRect),fullfile(save_dir,sprintf(<span class="string">'retinotopy_%s_pos_%02d_%02d_depth_%02d_%02d.png'</span>,sparam.mode,cc,rr,mm,pp)),<span class="string">'png'</span>);
0822         <span class="keyword">end</span>
0823       <span class="keyword">end</span>
0824     <span class="keyword">end</span>
0825   <span class="keyword">end</span>
0826 
0827   Screen(<span class="string">'CloseAll'</span>);
0828   save(fullfile(save_dir,sprintf(<span class="string">'stimulus_%s.mat'</span>,sparam.mode)),<span class="string">'checkerboard'</span>,<span class="string">'sparam'</span>,<span class="string">'dparam'</span>);
0829   keyboard;
0830 
0831 <span class="keyword">end</span> <span class="comment">% if strfind(upper(subjID),'DEBUG')</span>
0832 <span class="comment">% %%%%%% DEBUG code ends here</span>
0833 
0834 
0835 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0836 <span class="comment">%%%% Generating depth detection tastk parameters</span>
0837 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0838 
0839 <span class="comment">%% set task variables</span>
0840 <span class="comment">% flag to decide in which period (first half or second half) the disparity task is applied</span>
0841 <span class="comment">% about task_flg:</span>
0842 <span class="comment">% 1, task is added in the first half period</span>
0843 <span class="comment">% 2, task is added in the second half period</span>
0844 task_flg=randi(2,[ceil(length(checkerboard)*nframe_stim/nframe_task),1]);
0845 
0846 <span class="comment">% flag whether presenting disparity task</span>
0847 do_task=zeros(ceil(length(checkerboard)*nframe_stim/nframe_task),1);
0848 do_task(1)=0; <span class="comment">% no task for the first presentation</span>
0849 <span class="keyword">for</span> ii=2:1:ceil(length(checkerboard)*nframe_stim/nframe_task)
0850   <span class="keyword">if</span> do_task(ii-1)==1
0851     do_task(ii)=0;
0852   <span class="keyword">else</span>
0853     do_task(ii)=round(rand(1,1));
0854   <span class="keyword">end</span>
0855 <span class="keyword">end</span>
0856 
0857 <span class="comment">% variable to store the current task array order</span>
0858 task_id=1;
0859 
0860 <span class="comment">% variable to store task position</span>
0861 task_pos=cell(length(checkerboard),1);
0862 <span class="keyword">for</span> cc=1:1:length(checkerboard)
0863   task_pos{cc}=zeros(1,ceil(length(checkerboard)*nframe_stim/nframe_task));
0864   <span class="keyword">for</span> pp=1:1:ceil(length(checkerboard)*nframe_stim/nframe_task)
0865     tmp_id=<a href="../../Retinotopy/Common/shuffle.html" class="code" title="function [Y,index] = shuffle(X)">shuffle</a>(patchids{cc});
0866     task_pos{cc}(pp)=tmp_id(1);
0867   <span class="keyword">end</span>
0868 <span class="keyword">end</span>
0869 
0870 <span class="comment">% flag to index the first task frame</span>
0871 firsttask_flg=0;
0872 
0873 
0874 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0875 <span class="comment">%%%% Initializing checkerboard color management parameters</span>
0876 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0877 
0878 <span class="comment">% checkerboard depth id</span>
0879 depth_id=1;
0880 
0881 
0882 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0883 <span class="comment">%%%% Creating background images</span>
0884 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0885 
0886 <span class="keyword">if</span> sparam.bgtype==1 <span class="comment">% a simple background with sparam.bgcolor</span>
0887   bgimg{1}=repmat(reshape(sparam.bgcolor,[1,1,3]),[dparam.ScrHeight,dparam.ScrWidth]);
0888 
0889 <span class="keyword">elseif</span> sparam.bgtype==2 <span class="comment">% a background with grid guides</span>
0890 
0891   <span class="comment">% calculate the central aperture size of the background image</span>
0892   edgeY=mod(dparam.ScrHeight,sparam.patch_num(1)); <span class="comment">% delete the exceeded region</span>
0893   p_height=round((dparam.ScrHeight-edgeY)/sparam.patch_num(1)); <span class="comment">% height in pix of patch_height + interval-Y</span>
0894 
0895   edgeX=mod(dparam.ScrWidth,sparam.patch_num(2)); <span class="comment">% delete exceeded region</span>
0896   p_width=round((dparam.ScrWidth-edgeX)/sparam.patch_num(2)); <span class="comment">% width in pix of patch_width + interval-X</span>
0897 
0898   <span class="keyword">if</span> dparam.fullscr
0899     aperture_size=[2*( p_height*ceil( size(checkerboard{1},1)/2*( (winRect(4)-winRect(2))/dparam.ScrHeight ) /p_height ) ),<span class="keyword">...</span>
0900                    2*( p_width*ceil( size(checkerboard{1},2)/2*( (winRect(3)-winRect(1))/dparam.ScrWidth ) /p_width ) )];
0901   <span class="keyword">else</span>
0902     aperture_size=[2*( p_height*ceil(size(checkerboard{1},1)/2/p_height) ),<span class="keyword">...</span>
0903                    2*( p_width*ceil(size(checkerboard{1},2)/2/p_width) )];
0904   <span class="keyword">end</span>
0905 
0906   bgimg=<a href="../../Retinotopy/Common/CreateBackgroundImage.html" class="code" title="function [Bimg,parameters] = CreateBackgroundImage(wdims,stdims,pdims,bgcolor,color1,color2,fixcolor,patchnum,fix_flag,save_flag,show_flag)">CreateBackgroundImage</a>([dparam.ScrHeight,dparam.ScrWidth],aperture_size,sparam.patch_size,sparam.bgcolor,sparam.patch_color1,sparam.patch_color2,sparam.fixcolor,sparam.patch_num,0,0,0);
0907 <span class="keyword">else</span>
0908   error(<span class="string">'sparam.bgtype should be 1 or 2. check the input variable.'</span>);
0909 <span class="keyword">end</span>
0910 
0911 background=Screen(<span class="string">'MakeTexture'</span>,winPtr,bgimg{1});
0912 
0913 
0914 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0915 <span class="comment">%%%% Creating the central fixation, cross images</span>
0916 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0917 
0918 <span class="comment">% Create fixation cross images.</span>
0919 <span class="comment">% Firstly larger fixations are generated, then they are antialiased. This is required to present a beautiful circle</span>
0920 
0921 <span class="keyword">if</span> sparam.fixtype==1 <span class="comment">% circular fixation</span>
0922   fixW=<a href="../../Retinotopy/Common/CreateFixationImgCircular.html" class="code" title="function fix=CreateFixationImgCircular(fixsize,fixcolor,bgcolor,circlesize,show_flag,save_flag)">CreateFixationImgCircular</a>(4*sparam.fixsize,sparam.fixcolor,sparam.bgcolor,4*sparam.fixsize,0,0);
0923   fixD=<a href="../../Retinotopy/Common/CreateFixationImgCircular.html" class="code" title="function fix=CreateFixationImgCircular(fixsize,fixcolor,bgcolor,circlesize,show_flag,save_flag)">CreateFixationImgCircular</a>(4*sparam.fixsize,[64,64,64],sparam.bgcolor,4*sparam.fixsize,0,0);
0924 <span class="keyword">elseif</span> sparam.fixtype==2 <span class="comment">% rectangular fixation</span>
0925   fixW=<a href="../../Retinotopy/Common/CreateFixationImgMono.html" class="code" title="function fix=CreateFixationImgMono(fixsize,fixcolor,bgcolor,fixlinew,fixlineh,show_flag,save_flag)">CreateFixationImgMono</a>(4*sparam.fixsize,sparam.fixcolor,sparam.bgcolor,4*2,4*ceil(0.4*sparam.fixsize),0,0);
0926   fixD=<a href="../../Retinotopy/Common/CreateFixationImgMono.html" class="code" title="function fix=CreateFixationImgMono(fixsize,fixcolor,bgcolor,fixlinew,fixlineh,show_flag,save_flag)">CreateFixationImgMono</a>(4*sparam.fixsize,[64,64,64],sparam.bgcolor,4*2,4*ceil(0.4*sparam.fixsize),0,0);
0927 <span class="keyword">elseif</span> sparam.fixtype==3 <span class="comment">% concentric fixation</span>
0928   fixW=<a href="../../Retinotopy/Common/CreateFixationImgConcentrateMono.html" class="code" title="function fix=CreateFixationImgConcentrateMono(fixsize,fixcolor,bgcolor,circlesize,gap,show_flag,save_flag)">CreateFixationImgConcentrateMono</a>(4*sparam.fixsize,sparam.fixcolor,sparam.bgcolor,4*[2,ceil(0.8*sparam.fixsize)],0,0,0);
0929   fixD=<a href="../../Retinotopy/Common/CreateFixationImgConcentrateMono.html" class="code" title="function fix=CreateFixationImgConcentrateMono(fixsize,fixcolor,bgcolor,circlesize,gap,show_flag,save_flag)">CreateFixationImgConcentrateMono</a>(4*sparam.fixsize,[64,64,64],sparam.bgcolor,4*[2,ceil(0.8*sparam.fixsize)],0,0,0);
0930 <span class="keyword">else</span>
0931   error(<span class="string">'sparam.fixtype should be one of 1,2, and 3. check the input variable.'</span>);
0932 <span class="keyword">end</span>
0933 fixW=imresize(fixW,0.25);
0934 fixD=imresize(fixD,0.25);
0935 
0936 fix=cell(2,1); <span class="comment">% 1 is for default fixation, 2 is for darker fixation (luminance detection task)</span>
0937 fix{1}=Screen(<span class="string">'MakeTexture'</span>,winPtr,fixW);
0938 fix{2}=Screen(<span class="string">'MakeTexture'</span>,winPtr,fixD);
0939 
0940 
0941 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0942 <span class="comment">%%%% Prepare blue lines for stereo image flip sync with VPixx PROPixx</span>
0943 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0944 
0945 <span class="comment">% There seems to be a blueline generation bug on some OpenGL systems.</span>
0946 <span class="comment">% SetStereoBlueLineSyncParameters(winPtr, winRect(4)) corrects the</span>
0947 <span class="comment">% bug on some systems, but breaks on other systems.</span>
0948 <span class="comment">% We'll just disable automatic blueline, and manually draw our own bluelines!</span>
0949 
0950 <span class="keyword">if</span> strcmpi(dparam.ExpMode,<span class="string">'propixxstereo'</span>)
0951   SetStereoBlueLineSyncParameters(winPtr, winRect(4)+10);
0952   blueRectOn(1,:)=[0, winRect(4)-1, winRect(3)/4, winRect(4)];
0953   blueRectOn(2,:)=[0, winRect(4)-1, winRect(3)*3/4, winRect(4)];
0954   blueRectOff(1,:)=[winRect(3)/4, winRect(4)-1, winRect(3), winRect(4)];
0955   blueRectOff(2,:)=[winRect(3)*3/4, winRect(4)-1, winRect(3), winRect(4)];
0956 <span class="keyword">end</span>
0957 
0958 
0959 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0960 <span class="comment">%%%% Image size adjusting to match the current display resolutions</span>
0961 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0962 
0963 <span class="keyword">if</span> dparam.fullscr
0964   ratio_wid= ( winRect(3)-winRect(1) )/dparam.ScrWidth;
0965   ratio_hei= ( winRect(4)-winRect(2) )/dparam.ScrHeight;
0966   bgSize   = [size(bgimg{1},2)*ratio_wid, size(bgimg{1},1)*ratio_hei];
0967   stimSize = [size(checkerboard{1},2)*ratio_wid, size(checkerboard{1},1)*ratio_hei];
0968   fixSize  = [2*sparam.fixsize*ratio_wid, 2*sparam.fixsize*ratio_hei];
0969 <span class="keyword">else</span>
0970   bgSize   = [dparam.ScrWidth, dparam.ScrHeight];
0971   stimSize = [size(checkerboard{1},2), size(checkerboard{1},1)];
0972   fixSize  = [2*sparam.fixsize, 2*sparam.fixsize];
0973 <span class="keyword">end</span>
0974 
0975 <span class="comment">% for some display modes in which one screen is splitted into two binocular displays</span>
0976 <span class="keyword">if</span> strcmpi(dparam.ExpMode,<span class="string">'cross'</span>) || strcmpi(dparam.ExpMode,<span class="string">'parallel'</span>) || <span class="keyword">...</span>
0977    strcmpi(dparam.ExpMode,<span class="string">'topbottom'</span>) || strcmpi(dparam.ExpMode,<span class="string">'bottomtop'</span>)
0978   bgSize=bgSize./2;
0979   stimSize=stimSize./2;
0980   fixSize=fixSize./2;
0981 <span class="keyword">end</span>
0982 
0983 bgRect  = [0, 0, bgSize]; <span class="comment">% used to display background images;</span>
0984 stimRect= [0, 0, stimSize];
0985 fixRect = [0, 0, fixSize]; <span class="comment">% used to display the central fixation point</span>
0986 
0987 <span class="comment">% compute Random-Dot-Stereogram image center</span>
0988 <span class="keyword">if</span> strcmpi(dparam.ExpMode,<span class="string">'cross'</span>) || strcmpi(dparam.ExpMode,<span class="string">'parallel'</span>) || <span class="keyword">...</span>
0989    strcmpi(dparam.ExpMode,<span class="string">'topbottom'</span>) || strcmpi(dparam.ExpMode,<span class="string">'bottomtop'</span>)
0990   half_flg=1;
0991 <span class="keyword">else</span>
0992   half_flg=0;
0993 <span class="keyword">end</span>
0994 dotCenter=[diff(winRect([1,3])),diff(winRect([2,4]))]./2-[diff(stimRect([1,3])),diff(stimRect([2,4]))]./2;
0995 
0996 
0997 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0998 <span class="comment">%%%% Displaying 'Ready to Start'</span>
0999 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
1000 
1001 <span class="comment">% displaying texts on the center of the screen</span>
1002 <a href="../../Retinotopy/Common/DisplayMessage2.html" class="code" title="function DisplayMessage2(message,bgcolor,winPtr,numScreens,drawing_font,drawing_size)">DisplayMessage2</a>(<span class="string">'Ready to Start'</span>,sparam.bgcolor,winPtr,nScr,<span class="string">'Arial'</span>,36);
1003 ttime=GetSecs(); <span class="keyword">while</span> (GetSecs()-ttime &lt; 0.5), <span class="keyword">end</span>  <span class="comment">% run up the clock.</span>
1004 
1005 
1006 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
1007 <span class="comment">%%%% Flip the display(s) to the background image(s)</span>
1008 <span class="comment">%%%% and inform the ready of stimulus presentation</span>
1009 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
1010 
1011 <span class="comment">% change the screen and wait for the trigger or pressing the start button</span>
1012 <span class="keyword">for</span> nn=1:1:nScr
1013   Screen(<span class="string">'SelectStereoDrawBuffer'</span>,winPtr,nn-1);
1014   Screen(<span class="string">'DrawTexture'</span>,winPtr,background,[],CenterRect(bgRect,winRect));
1015   Screen(<span class="string">'DrawTexture'</span>,winPtr,fix{2},[],CenterRect(fixRect,winRect));
1016 
1017   <span class="comment">% blue line for stereo sync</span>
1018   <span class="keyword">if</span> strcmpi(dparam.ExpMode,<span class="string">'propixxstereo'</span>)
1019     Screen(<span class="string">'FillRect'</span>,winPtr,[0,0,255],blueRectOn(nn,:));
1020     Screen(<span class="string">'FillRect'</span>,winPtr,[0,0,0],blueRectOff(nn,:));
1021   <span class="keyword">end</span>
1022 <span class="keyword">end</span>
1023 Screen(<span class="string">'DrawingFinished'</span>,winPtr);
1024 Screen(<span class="string">'Flip'</span>, winPtr,[],[],[],1);
1025 
1026 <span class="comment">% prepare the next frame for the initial fixation period</span>
1027 <span class="keyword">for</span> nn=1:1:nScr
1028   Screen(<span class="string">'SelectStereoDrawBuffer'</span>,winPtr,nn-1);
1029   Screen(<span class="string">'DrawTexture'</span>,winPtr,background,[],CenterRect(bgRect,winRect));
1030   Screen(<span class="string">'DrawTexture'</span>,winPtr,fix{1},[],CenterRect(fixRect,winRect)); <span class="comment">% fix{1} is valis as no task in the first period</span>
1031 
1032   <span class="comment">% blue line for stereo sync</span>
1033   <span class="keyword">if</span> strcmpi(dparam.ExpMode,<span class="string">'propixxstereo'</span>)
1034     Screen(<span class="string">'FillRect'</span>,winPtr,[0,0,255],blueRectOn(nn,:));
1035     Screen(<span class="string">'FillRect'</span>,winPtr,[0,0,0],blueRectOff(nn,:));
1036   <span class="keyword">end</span>
1037 <span class="keyword">end</span>
1038 Screen(<span class="string">'DrawingFinished'</span>,winPtr);
1039 
1040 
1041 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
1042 <span class="comment">%%%% Wait for the first trigger pulse from fMRI scanner or start with button pressing</span>
1043 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
1044 
1045 <span class="comment">% add time stamp (this also works to load add_event method in memory in advance of the actual displays)</span>
1046 fprintf(<span class="string">'\nWaiting for the start...\n'</span>);
1047 event=event.add_event(<span class="string">'Experiment Start'</span>,strcat([datestr(now,<span class="string">'yymmdd'</span>),<span class="string">' '</span>,datestr(now,<span class="string">'HH:mm:ss'</span>)]),NaN);
1048 
1049 <span class="comment">% waiting for stimulus presentation</span>
1050 resps.wait_stimulus_presentation(dparam.start_method,dparam.custom_trigger);
1051 <span class="comment">%PlaySound(1);</span>
1052 fprintf(<span class="string">'\nExperiment running...\n'</span>);
1053 
1054 
1055 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
1056 <span class="comment">%%%% Initial Fixation Period</span>
1057 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
1058 
1059 vbl=Screen(<span class="string">'Flip'</span>,winPtr,[],[],[],1); <span class="comment">% the first flip</span>
1060 [event,the_experiment_start]=event.set_reference_time(vbl);
1061 event=event.add_event(<span class="string">'Initial Fixation'</span>,[]);
1062 fprintf(<span class="string">'\nfixation\n\n'</span>);
1063 
1064 <span class="comment">% wait for the initial fixation</span>
1065 <span class="keyword">for</span> ff=1:1:nframe_fixation(1)
1066   <span class="keyword">for</span> nn=1:1:nScr
1067     Screen(<span class="string">'SelectStereoDrawBuffer'</span>,winPtr,nn-1);
1068     Screen(<span class="string">'DrawTexture'</span>,winPtr,background,[],CenterRect(bgRect,winRect));
1069     Screen(<span class="string">'DrawTexture'</span>,winPtr,fix{1},[],CenterRect(fixRect,winRect));
1070 
1071     <span class="comment">% blue line for stereo sync</span>
1072     <span class="keyword">if</span> strcmpi(dparam.ExpMode,<span class="string">'propixxstereo'</span>)
1073       Screen(<span class="string">'FillRect'</span>,winPtr,[0,0,255],blueRectOn(nn,:));
1074       Screen(<span class="string">'FillRect'</span>,winPtr,[0,0,0],blueRectOff(nn,:));
1075     <span class="keyword">end</span>
1076   <span class="keyword">end</span>
1077   Screen(<span class="string">'DrawingFinished'</span>,winPtr);
1078   <span class="keyword">while</span> GetSecs()&lt;vbl+(ff*sparam.waitframes-0.5)*dparam.ifi, [resps,event]=resps.check_responses(event); <span class="keyword">end</span>
1079   Screen(<span class="string">'Flip'</span>,winPtr,[],[],[],1);
1080 <span class="keyword">end</span>
1081 
1082 
1083 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
1084 <span class="comment">%%%% The Trial Loop</span>
1085 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
1086 
1087 <span class="keyword">for</span> cc=1:1:length(checkerboard)
1088 
1089   <span class="comment">%% stimulus presentation loop</span>
1090   <span class="keyword">for</span> ff=1:1:nframe_stim
1091 
1092     <span class="comment">% preparaing the next stimulus</span>
1093     <span class="keyword">if</span> ~mod(ff,nframe_flicker)
1094 
1095       <span class="comment">% generate a checkerboard texture with/without a depth detection task</span>
1096       <span class="keyword">if</span> do_task(task_id) &amp;&amp; <span class="keyword">...</span>
1097         ( ( task_flg(task_id)==1 &amp;&amp; mod(ff,nframe_stim)&lt;=nframe_stim/2 ) || <span class="keyword">...</span>
1098           ( task_flg(task_id)==2 &amp;&amp; mod(ff,nframe_stim)&gt;nframe_stim/2 ) )
1099         tidx=find(checkerboardID{cc}==task_pos{cc}(task_id));
1100         cval=checkerboard{cc}(tidx(ceil(numel(tidx)/2))); <span class="comment">% ceil(numel(tidx)/2) is required as sometimes tidx(1) is located at the edge of the checkerboard which gives NaN.</span>
1101         checkerboard{cc}(tidx)=3; <span class="comment">% as IDs of the original checkerboard are 0|1|2, 3 is assigned to the task patch.</span>
1102       <span class="keyword">else</span>
1103         tidx=[];
1104       <span class="keyword">end</span>
1105 
1106       <span class="keyword">if</span> sparam.RDSdepth(3)~=1
1107         depth1=sparam.RDSdepth(1)+(depth_id-1)*(sparam.RDSdepth(2)-sparam.RDSdepth(1))/(sparam.RDSdepth(3)-1);
1108         depth2=sparam.RDSdepth(2)-(depth_id-1)*(sparam.RDSdepth(2)-sparam.RDSdepth(1))/(sparam.RDSdepth(3)-1);
1109       <span class="keyword">else</span>
1110         depth1=sparam.RDSdepth(1);
1111         depth2=sparam.RDSdepth(2);
1112       <span class="keyword">end</span>
1113 
1114       <span class="keyword">if</span> ~isempty(tidx)
1115         <span class="keyword">if</span> cval==1
1116           [XY,colors]=<a href="../../Retinotopy/Generation/GetDotPositionsRDS.html" class="code" title="function [XY,colors]=GetDotPositionsRDS(checkerboard,depths,dotdense,RDScolors,ipd,vdist,pix_per_cm)">GetDotPositionsRDS</a>(checkerboard{cc},[0,depth1,depth2,sparam.RDStaskmagnitude*(-1)*abs(sparam.RDSdepth(1))],sparam.RDSDense,<span class="keyword">...</span>
1117                                          sparam.RDScolors(1:2),sparam.ipd,sparam.vdist,sparam.pix_per_cm);
1118         <span class="keyword">else</span> <span class="comment">% if cval==2</span>
1119           [XY,colors]=<a href="../../Retinotopy/Generation/GetDotPositionsRDS.html" class="code" title="function [XY,colors]=GetDotPositionsRDS(checkerboard,depths,dotdense,RDScolors,ipd,vdist,pix_per_cm)">GetDotPositionsRDS</a>(checkerboard{cc},[0,depth1,depth2,sparam.RDStaskmagnitude*(-1)*abs(sparam.RDSdepth(2))],sparam.RDSDense,<span class="keyword">...</span>
1120                                          sparam.RDScolors(1:2),sparam.ipd,sparam.vdist,sparam.pix_per_cm);
1121         <span class="keyword">end</span>
1122         checkerboard{cc}(tidx)=cval; <span class="comment">% put the checkerboard ID back to the default</span>
1123       <span class="keyword">else</span>
1124           [XY,colors]=<a href="../../Retinotopy/Generation/GetDotPositionsRDS.html" class="code" title="function [XY,colors]=GetDotPositionsRDS(checkerboard,depths,dotdense,RDScolors,ipd,vdist,pix_per_cm)">GetDotPositionsRDS</a>(checkerboard{cc},[0,depth1,depth2],sparam.RDSDense,<span class="keyword">...</span>
1125                                          sparam.RDScolors(1:2),sparam.ipd,sparam.vdist,sparam.pix_per_cm);
1126       <span class="keyword">end</span>
1127     <span class="keyword">end</span> <span class="comment">% if ~mod(ff,nframe_flicker)</span>
1128 
1129     <span class="comment">%% display the current frame</span>
1130     <span class="keyword">for</span> nn=1:1:nScr
1131       Screen(<span class="string">'SelectStereoDrawBuffer'</span>,winPtr,nn-1);
1132       Screen(<span class="string">'DrawTexture'</span>,winPtr,background,[],CenterRect(bgRect,winRect)); <span class="comment">% background</span>
1133       <span class="keyword">if</span> half_flg
1134         Screen(<span class="string">'DrawDots'</span>,winPtr,XY{nn}./2,sparam.RDSradius*sparam.pix_per_deg,colors{nn},dotCenter,3); <span class="comment">% RDS</span>
1135       <span class="keyword">else</span>
1136         Screen(<span class="string">'DrawDots'</span>,winPtr,XY{nn},2*sparam.RDSradius*sparam.pix_per_deg,colors{nn},dotCenter,3); <span class="comment">% RDS</span>
1137       <span class="keyword">end</span>
1138       Screen(<span class="string">'DrawTexture'</span>,winPtr,fix{1},[],CenterRect(fixRect,winRect)); <span class="comment">% the central fixation oval</span>
1139 
1140       <span class="comment">% blue line for stereo sync</span>
1141       <span class="keyword">if</span> strcmpi(dparam.ExpMode,<span class="string">'propixxstereo'</span>)
1142         Screen(<span class="string">'FillRect'</span>,winPtr,[0,0,255],blueRectOn(nn,:));
1143         Screen(<span class="string">'FillRect'</span>,winPtr,[0,0,0],blueRectOff(nn,:));
1144       <span class="keyword">end</span>
1145     <span class="keyword">end</span>
1146 
1147     <span class="comment">% flip the window</span>
1148     Screen(<span class="string">'DrawingFinished'</span>,winPtr);
1149     <span class="keyword">while</span> GetSecs()&lt;vbl+sparam.initial_fixation_time(1)+( ((cc-1)*nframe_stim+(ff-1))*sparam.waitframes-0.5 )*dparam.ifi, [resps,event]=resps.check_responses(event); <span class="keyword">end</span>
1150     Screen(<span class="string">'Flip'</span>,winPtr,[],[],[],1);
1151 
1152     <span class="keyword">if</span> ff==1
1153       event=event.add_event(sprintf(<span class="string">'Trial: %d'</span>,cc),[]);
1154       <span class="keyword">if</span> cc==1, fprintf(<span class="string">'Trial: '</span>); <span class="keyword">end</span>
1155       <span class="keyword">if</span> mod(cc,20)~=0 &amp;&amp; cc~=length(checkerboard), fprintf(sprintf(<span class="string">'%03d, '</span>,cc)); <span class="keyword">end</span>
1156       <span class="keyword">if</span> mod(cc,20)==0 || cc==length(checkerboard), fprintf(<span class="string">'%03d\n       '</span>,cc); <span class="keyword">end</span>
1157     <span class="keyword">end</span>
1158 
1159     <span class="keyword">if</span> ff&lt;=nframe_stim &amp;&amp; firsttask_flg==1 &amp;&amp; ( do_task(task_id) &amp;&amp; <span class="keyword">...</span>
1160        ( ( task_flg(task_id)==1 &amp;&amp; mod(ff,nframe_stim)&lt;=nframe_stim/2 ) || <span class="keyword">...</span>
1161          ( task_flg(task_id)==2 &amp;&amp; mod(ff,nframe_stim)&gt;nframe_stim/2 ) ) ), event=event.add_event(<span class="string">'Depth Task'</span>,[]); <span class="keyword">end</span>
1162 
1163     <span class="comment">%% exit from the loop if the final frame is displayed</span>
1164     <span class="keyword">if</span> ff==nframe_stim &amp;&amp; cc==length(checkerboard), <span class="keyword">continue</span>; <span class="keyword">end</span>
1165 
1166     <span class="comment">%% update IDs</span>
1167 
1168     <span class="comment">% flickering checkerboard</span>
1169     <span class="keyword">if</span> ~mod(ff,nframe_flicker) <span class="comment">% depth change</span>
1170       depth_id=depth_id+1;
1171       <span class="keyword">if</span> depth_id&gt;sparam.RDSdepth(3), depth_id=1; <span class="keyword">end</span>
1172     <span class="keyword">end</span>
1173 
1174     <span class="comment">%% update task. about task_flg: 1, task is added in the first half period. 2, task is added in the second half period</span>
1175     <span class="keyword">if</span> ~mod(ff,nframe_task), task_id=task_id+1; firsttask_flg=0; <span class="keyword">end</span>
1176     firsttask_flg=firsttask_flg+1;
1177   <span class="keyword">end</span> <span class="comment">% for ff=1:1:nframe_stim</span>
1178 <span class="keyword">end</span> <span class="comment">% for cc=1:1:length(checkerboard)</span>
1179 
1180 
1181 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
1182 <span class="comment">%%%% Final Fixation</span>
1183 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
1184 
1185 <span class="keyword">for</span> nn=1:1:nScr
1186   Screen(<span class="string">'SelectStereoDrawBuffer'</span>,winPtr,nn-1);
1187   Screen(<span class="string">'DrawTexture'</span>,winPtr,background,[],CenterRect(bgRect,winRect));
1188   Screen(<span class="string">'DrawTexture'</span>,winPtr,fix{1},[],CenterRect(fixRect,winRect));
1189 
1190   <span class="comment">% blue line for stereo sync</span>
1191   <span class="keyword">if</span> strcmpi(dparam.ExpMode,<span class="string">'propixxstereo'</span>)
1192     Screen(<span class="string">'FillRect'</span>,winPtr,[0,0,255],blueRectOn(nn,:));
1193     Screen(<span class="string">'FillRect'</span>,winPtr,[0,0,0],blueRectOff(nn,:));
1194   <span class="keyword">end</span>
1195 <span class="keyword">end</span>
1196 Screen(<span class="string">'DrawingFinished'</span>,winPtr);
1197 <span class="keyword">while</span> GetSecs()&lt;vbl+sparam.initial_fixation_time(1)+sparam.pol_numRepeats*sparam.pol_cycle_duration-0.5*dparam.ifi, [resps,event]=resps.check_responses(event); <span class="keyword">end</span>
1198 Screen(<span class="string">'Flip'</span>,winPtr,[],[],[],1);
1199 event=event.add_event(<span class="string">'Final Fixation'</span>,[]);
1200 fprintf(<span class="string">'\nfixation\n'</span>);
1201 
1202 <span class="comment">% wait for the initial fixation</span>
1203 <span class="keyword">for</span> ff=1:1:nframe_fixation(2)
1204   <span class="keyword">for</span> nn=1:1:nScr
1205     Screen(<span class="string">'SelectStereoDrawBuffer'</span>,winPtr,nn-1);
1206     Screen(<span class="string">'DrawTexture'</span>,winPtr,background,[],CenterRect(bgRect,winRect));
1207     Screen(<span class="string">'DrawTexture'</span>,winPtr,fix{1},[],CenterRect(fixRect,winRect));
1208 
1209     <span class="comment">% blue line for stereo sync</span>
1210     <span class="keyword">if</span> strcmpi(dparam.ExpMode,<span class="string">'propixxstereo'</span>)
1211       Screen(<span class="string">'FillRect'</span>,winPtr,[0,0,255],blueRectOn(nn,:));
1212       Screen(<span class="string">'FillRect'</span>,winPtr,[0,0,0],blueRectOff(nn,:));
1213     <span class="keyword">end</span>
1214   <span class="keyword">end</span>
1215   Screen(<span class="string">'DrawingFinished'</span>,winPtr);
1216   <span class="keyword">while</span> GetSecs()&lt;vbl+sparam.initial_fixation_time(1)+sparam.pol_numRepeats*sparam.pol_cycle_duration+(ff*sparam.waitframes-0.5)*dparam.ifi, [resps,event]=resps.check_responses(event); <span class="keyword">end</span>
1217   Screen(<span class="string">'Flip'</span>,winPtr,[],[],[],1);
1218 <span class="keyword">end</span>
1219 
1220 <span class="comment">% the final clock up</span>
1221 <span class="keyword">while</span> GetSecs()-the_experiment_start&lt;sum(sparam.initial_fixation_time)+sparam.pol_numRepeats*sparam.pol_cycle_duration
1222   [resps,event]=resps.check_responses(event);
1223 <span class="keyword">end</span>
1224 
1225 
1226 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
1227 <span class="comment">%%%% Experiment &amp; scanner end here</span>
1228 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
1229 
1230 experimentDuration=GetSecs()-the_experiment_start;
1231 event=event.add_event(<span class="string">'End'</span>,[]);
1232 fprintf(<span class="string">'\n'</span>);
1233 fprintf(<span class="string">'Experiment Completed: %.2f/%.2f secs\n'</span>,experimentDuration,<span class="keyword">...</span>
1234         sum(sparam.initial_fixation_time)+sparam.pol_numRepeats*sparam.pol_cycle_duration);
1235 fprintf(<span class="string">'\n'</span>);
1236 
1237 
1238 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
1239 <span class="comment">%%%% Cleaning up the PTB screen</span>
1240 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
1241 
1242 Screen(<span class="string">'CloseAll'</span>);
1243 
1244 <span class="comment">% closing datapixx</span>
1245 <span class="keyword">if</span> strcmpi(dparam.ExpMode,<span class="string">'propixxmono'</span>) || strcmpi(dparam.ExpMode,<span class="string">'propixxstereo'</span>)
1246   <span class="keyword">if</span> Datapixx(<span class="string">'IsViewpixx3D'</span>)
1247     Datapixx(<span class="string">'DisableVideoLcd3D60Hz'</span>);
1248     Datapixx(<span class="string">'RegWr'</span>);
1249   <span class="keyword">end</span>
1250   Datapixx(<span class="string">'Close'</span>);
1251 <span class="keyword">end</span>
1252 
1253 ShowCursor();
1254 Priority(0);
1255 <a href="../../Retinotopy/Common/GammaResetPTB.html" class="code" title="function GammaResetPTB(luminance_ratio)">GammaResetPTB</a>(1.0);
1256 
1257 
1258 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
1259 <span class="comment">%%%% Write data into file for post analysis</span>
1260 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
1261 
1262 <span class="comment">% saving the results</span>
1263 fprintf(<span class="string">'saving data...'</span>);
1264 
1265 <span class="comment">% save data</span>
1266 savefname=fullfile(resultDir,[num2str(subjID),<span class="string">'_ddual_'</span>,sparam.mode,<span class="string">'_results_run_'</span>,num2str(acq,<span class="string">'%02d'</span>),<span class="string">'.mat'</span>]);
1267 
1268 <span class="comment">% backup the old file(s)</span>
1269 <span class="keyword">if</span> ~overwrite_flg
1270   <a href="../../Retinotopy/Common/BackUpObsoleteFiles.html" class="code" title="function [new_fname,backup_fname]=BackUpObsoleteFiles(tgt_dir,tgt_fname,backup_prefix)">BackUpObsoleteFiles</a>(fullfile(<span class="string">'subjects'</span>,num2str(subjID),<span class="string">'results'</span>,today),<span class="keyword">...</span>
1271                       [num2str(subjID),<span class="string">'_ddual_'</span>,sparam.mode,<span class="string">'_results_run_'</span>,num2str(acq,<span class="string">'%02d'</span>),<span class="string">'.mat'</span>],<span class="string">'_old'</span>);
1272 <span class="keyword">end</span>
1273 
1274 eval(sprintf(<span class="string">'save %s subjID acq sparam dparam event gamma_table;'</span>,savefname));
1275 fprintf(<span class="string">'done.\n'</span>);
1276 
1277 <span class="comment">% calculate &amp; display task performance</span>
1278 fprintf(<span class="string">'calculating task accuracy...\n'</span>);
1279 correct_event=cell(2,1); <span class="keyword">for</span> ii=1:1:2, correct_event{ii}=sprintf(<span class="string">'key%d'</span>,ii); <span class="keyword">end</span>
1280 [task.numTasks,task.numHits,task.numErrors,task.numResponses,task.RT]=event.calc_accuracy(correct_event);
1281 event=event.get_event(); <span class="comment">% convert an event logger object to a cell data structure</span>
1282 eval(sprintf(<span class="string">'save -append %s event task;'</span>,savefname));
1283 fprintf(<span class="string">'done.\n'</span>);
1284 
1285 
1286 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
1287 <span class="comment">%%%% Removing path to the subfunctions, and finalizing the script</span>
1288 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
1289 
1290 rmpath(genpath(fullfile(rootDir,<span class="string">'..'</span>,<span class="string">'Common'</span>)));
1291 rmpath(fullfile(rootDir,<span class="string">'..'</span>,<span class="string">'Generation'</span>));
1292 clear all; clear mex; clear <span class="keyword">global</span>;
1293 diary off;
1294 
1295 
1296 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
1297 <span class="comment">%%%% tell the experimenter that the measurements are completed</span>
1298 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
1299 
1300 <span class="keyword">try</span>
1301   <span class="keyword">for</span> ii=1:1:3, Snd(<span class="string">'Play'</span>,sin(2*pi*0.2*(0:900)),8000); <span class="keyword">end</span>
1302 <span class="keyword">catch</span>
1303   <span class="comment">% do nothing</span>
1304 <span class="keyword">end</span>
1305 
1306 
1307 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
1308 <span class="comment">%%%% Catch the errors</span>
1309 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
1310 
1311 <span class="keyword">catch</span> lasterror
1312   <span class="comment">% this &quot;catch&quot; section executes in case of an error in the &quot;try&quot; section</span>
1313   <span class="comment">% above.  Importantly, it closes the onscreen window if its open.</span>
1314   Screen(<span class="string">'CloseAll'</span>);
1315 
1316   <span class="keyword">if</span> exist(<span class="string">'dparam'</span>,<span class="string">'var'</span>)
1317     <span class="keyword">if</span> <a href="../../Retinotopy/Common/isstructmember.html" class="code" title="function isFieldResult = isstructmember(inStruct, fieldName)">isstructmember</a>(dparam,<span class="string">'ExpMode'</span>)
1318       <span class="keyword">if</span> strcmpi(dparam.ExpMode,<span class="string">'propixxmono'</span>) || strcmpi(dparam.ExpMode,<span class="string">'propixxstereo'</span>)
1319         <span class="keyword">if</span> Datapixx(<span class="string">'IsViewpixx3D'</span>)
1320           Datapixx(<span class="string">'DisableVideoLcd3D60Hz'</span>);
1321           Datapixx(<span class="string">'RegWr'</span>);
1322         <span class="keyword">end</span>
1323         Datapixx(<span class="string">'Close'</span>);
1324       <span class="keyword">end</span>
1325     <span class="keyword">end</span>
1326   <span class="keyword">end</span>
1327 
1328   ShowCursor();
1329   Priority(0);
1330   <a href="../../Retinotopy/Common/GammaResetPTB.html" class="code" title="function GammaResetPTB(luminance_ratio)">GammaResetPTB</a>(1.0);
1331   tmp=lasterror; <span class="comment">%#ok</span>
1332   <span class="comment">%if exist('event','var'), event=event.get_event(); end %#ok % just for debugging</span>
1333   diary off;
1334   fprintf([<span class="string">'\nError detected and the program was terminated.\n'</span>,<span class="keyword">...</span>
1335            <span class="string">'To check error(s), please type ''tmp''.\n'</span>,<span class="keyword">...</span>
1336            <span class="string">'Please save the current variables now if you need.\n'</span>,<span class="keyword">...</span>
1337            <span class="string">'Then, quit by ''dbquit''\n'</span>]);
1338   keyboard;
1339   rmpath(genpath(fullfile(rootDir,<span class="string">'..'</span>,<span class="string">'Common'</span>)));
1340   rmpath(fullfile(rootDir,<span class="string">'..'</span>,<span class="string">'Generation'</span>));
1341   clear all; clear mex; clear <span class="keyword">global</span>;
1342   <span class="keyword">return</span>
1343 <span class="keyword">end</span> <span class="comment">% try..catch</span>
1344 
1345 
1346 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
1347 <span class="comment">%%%%% That's it - we're done</span>
1348 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
1349 <span class="keyword">return</span>;
1350 <span class="comment">% end % function ddual</span></pre></div>
<hr><address>Generated on Thu 10-Jun-2021 10:01:25 by <strong><a href="http://www.artefact.tk/software/matlab/m2html/" target="_parent">m2html</a></strong> &copy; 2005 using a BVQX_hbtools customized template</address>
</body>
</html>