<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
                "http://www.w3.org/TR/REC-html40/loose.dtd">
<html>
<head>
  <title>Description of cdual_fixtask</title>
  <meta name="keywords" content="cdual_fixtask">
  <meta name="description" content="Color/luminance-defined checkerboard retinotopy stimulus with fixation luminance change-detection tasks.">
  <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
  <meta name="generator" content="m2html &copy; 2005 Guillaume Flandin">
  <meta name="robots" content="index, follow">
  <link type="text/css" rel="stylesheet" href="../../m2html.css">
  <script type="text/javascript">
    if (top.frames.length == 0) { top.location = "../../index.html"; };
  </script>
</head>
<body>
<a name="_top"></a>
<!-- # Retinotopy --><!-- menu.html Presentation -->
<h1>cdual_fixtask
</h1>

<h2><a name="_name"></a>PURPOSE <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
<div class="box"><strong>Color/luminance-defined checkerboard retinotopy stimulus with fixation luminance change-detection tasks.</strong></div>

<h2><a name="_synopsis"></a>SYNOPSIS <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
<div class="box"><strong>function cdual_fixtask(subjID,exp_mode,acq,displayfile,stimulusfile,gamma_table,overwrite_flg,force_proceed_flag) </strong></div>

<h2><a name="_description"></a>DESCRIPTION <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
<div class="fragment" style="background-image:url(../../hb_brain.png); background-position:right top"><pre class="comment"> Color/luminance-defined checkerboard retinotopy stimulus with fixation luminance change-detection tasks.
 function cdual_fixtask(subjID,exp_mode,acq,:displayfile,:stimulusfile,:gamma_table,:overwrite_flg,:force_proceed_flag)
 (: is optional)

 - This function generates and presents color/luminance-defined checkerboard stimulus
   (dual stimuli: wedge + annulus) to measure cortical retinotopy and to delineate
   retinotopic borders using the standard phase-encoded or pRF (population receptive
   field) analysis techniques.

   references: 1. Population receptive field estimates in human visual cortex.
                  Dumoulin, S.O. and Wandell, B.A. (2008). Neuroimage, 39(2), 647-660.
               2. Borders of multiple visual areas in humans revealed by functional magnetic resonance imaging.
                  Sereno MI, Dale AM, Reppas JB, Kwong KK, Belliveau JW, Brady TJ, Rosen BR, Tootell RB. (1995).
                  Science 268(5212), 889-893.
               3. fMRI of human visual cortex.
                  Engel SA, Rumelhart DE, Wandell BA, Lee AT, Glover GH, Chichilnisky EJ, Shadlen MN. (1994).
                  Nature, 369(6481), 525.
               4. Visual field maps in human cortex.
                  Wandell BA, Dumoulin SO, Brewer AA. (2007). Neuron, 56(2), 366-383.

 - This script shoud be used with MATLAB Psychtoolbox version 3 or above.

 - Luminance detection task: the central fixation point (default: white)
   randomly turns to gray. An observer has to press the button if s/he
   detects this luminance change. Response keys are defined in displayfile.

 [note]
 Behavioral task of (function_name)_fixtask is to detect changes of luminance
 of the central fixation point, while the task in (function_name) is to detect
 changes of luminance of one of the patches in the checkerboard stimuli.
 Here, the central fixation task is more easy to sustain the stable fixation
 on the center of the screen and may be suitable for naive/non-expert
 participants with minimizing unwilling eye movements. However, some studies
 have reported that attention to the target stimulus (checker-patch luminance
 change detection task) is required to get reliable retinotopic representations
 in higher-order visual areas.


 Created    : &quot;2018-12-20 14:26:03 ban&quot;
 Last Update: &quot;2021-06-07 17:28:35 ban&quot;



 [input variables]
 sujID         : ID of subject, string, such as 's01'
                 you also need to create a directory ./subjects/(subj) and put displayfile and stimulusfile there.
                 !!!!!!!!!!!!!!!!!! IMPORTANT NOTE !!!!!!!!!!!!!!!!!!!!!!!!
                 !!! if 'debug' (case insensitive) is included          !!!
                 !!! in subjID string, this program runs as DEBUG mode; !!!
                 !!! stimulus images are saved as *.png format at       !!!
                 !!! ~/Retinotopy/Presentation/images                   !!!
                 !!!!!!!!!!!!!!!!!! IMPORTANT NOTE !!!!!!!!!!!!!!!!!!!!!!!!

 exp_mode      : experiment mode that you want to run, one of
  - ccwexp : a checkerboard wedge rotating counter-clockwisely + an expanding annulus
  - cwexp  : a checkerboard wedge rotating clockwisely + an expanding annulus
  - ccwcont: a checkerboard wedge rotating counter-clockwisely + a contracting annulus
  - cwcont : a checkerboard wedge rotating clockwisely + a contracting annulus
 acq           : acquisition number (design file number),
                 an integer, such as 1, 2, 3, ...
 displayfile   : (optional) display condition file,
                 *.m file, such as 'RetDepth_display_fmri.m'
                 the file should be located in ./subjects/(subj)/
 stimulusfile  : (optional) stimulus condition file,
                 *.m file, such as 'RetDepth_stimulus_exp1.m'
                 the file should be located in ./subjects/(subj)/
 gamma_table   : (optional) table(s) of gamma-corrected video input values (Color LookupTable).
                 256(8-bits) x 3(RGB) x 1(or 2,3,... when using multiple displays) matrix
                 or a *.mat file specified with a relative path format. e.g. '/gamma_table/gamma1.mat'
                 The *.mat should include a variable named &quot;gamma_table&quot; consists of a 256x3xN matrix.
                 if you use multiple (more than 1) displays and set a 256x3x1 gamma-table, the same
                 table will be applied to all displays. if the number of displays and gamma tables
                 are different (e.g. you have 3 displays and 256x3x!2! gamma-tables), the last
                 gamma_table will be applied to the second and third displays.
                 if empty, normalized gamma table (repmat(linspace(0.0,1.0,256),3,1)) will be applied.
 overwrite_flg : (optional) whether overwriting pre-existing result file. if 1, the previous result
                 file with the same acquisition number will be overwritten by the previous one.
                 if 0, the existing file will be backed-up by adding a prefix '_old' at the tail
                 of the file. 0 by default.
 force_proceed_flag : (optional) whether proceeding stimulus presentatin without waiting for
                 the experimenter response (e.g. presesing the ENTER key) or a trigger.
                 if 1, the stimulus presentation will be automatically carried on.

 !!! NOTICE !!!!
 displayfile &amp; stimulusfile should be located at
 ./subjects/(subjID)/
 as ./subjects/(subjID)/*_display_fmri.m
    ./subjects/(subjID)/*_stimuli.m


 [output variables]
 no output matlab variable.


 [output files]
 1. result file
    stored ./subjects/(subjID)/results/(date)
    as ./subjects/(subjID)/results/(date)/(subjID)_cdual_fixtask_(exp_mode)_results_run_(run_num).mat


 [example]
 &gt;&gt; cdual_fixtask('HB','ccwexp',1,'ret_display.m','ret_checker_stimulus_exp1.m')

 [About displayfile]
 The contents of the displayfile are as below.
 (The file includs 6 lines of headers and following display parameters)

 (an example of the displayfile)

 % ************************************************************
 % This is the display configuration file for the retinotopy stimuli
 % Programmed by Hiroshi Ban Nov 01 2013
 % ************************************************************

 % display mode, one of &quot;mono&quot;, &quot;dual&quot;, &quot;dualcross&quot;, &quot;dualparallel&quot;, &quot;cross&quot;, &quot;parallel&quot;, &quot;redgreen&quot;, &quot;greenred&quot;,
 % &quot;redblue&quot;, &quot;bluered&quot;, &quot;shutter&quot;, &quot;topbottom&quot;, &quot;bottomtop&quot;, &quot;interleavedline&quot;, &quot;interleavedcolumn&quot;, &quot;propixxmono&quot;, &quot;propixxstereo&quot;
 dparam.ExpMode='mono';

 dparam.scrID=1; % screen ID, generally 0 for a single display setup, 1 for dual display setup

 % a method to start stimulus presentation
 % 0:ENTER/SPACE, 1:Left-mouse button, 2:the first MR trigger pulse (CiNet),
 % 3:waiting for a MR trigger pulse (BUIC) -- checking onset of pin #11 of the parallel port,
 % or 4:custom key trigger (wait for a key input that you specify as tgt_key).
 dparam.start_method=2;

 % a pseudo trigger key from the MR scanner when it starts, valid only when dparam.start_method=4;
 dparam.custom_trigger='t';

 % keyboard settings
 dparam.Key1=51; % key 1 (left)
 dparam.Key2=52; % key 2 (right)

 % screen settings

 %%% whether displaying the stimuli in full-screen mode or
 %%% as is (the precise resolution), 'true' or 'false' (true)
 dparam.fullscr=false;

 %%% the resolution of the screen height
 dparam.ScrHeight=1200;

 %% the resolution of the screen width
 dparam.ScrWidth=1920;

 % whether forcing to use specific frame rate, if 0, the frame rate wil bw computed in the ImagesShowPTB function.
 % if non zero, the value is used as the screen frame rate.
 dparam.force_frame_rate=60;

 % whther skipping the PTB's vertical-sync signal test. if 1, the sync test is skipped
 dparam.skip_sync_test=0;


 [About stimulusfile]
 The contents of the stimulusfile are as below.
 (The file includs 6 lines of headers and following stimulus parameters)

 (an example of the stimulusfile)

 % ************************************************************
 % This is the stimulus parameter file for the dual (wedge + annulus) retinotopy stimulus
 % Programmed by Hiroshi Ban Jan 25 2019
 % ************************************************************

 % &quot;sparam&quot; means &quot;stimulus generation parameters&quot;

 %%% stimulus parameters
 sparam.pol_nwedges     = 4;     % number of wedge subdivisions along polar angle
 sparam.pol_nrings      = 8;     % number of ring subdivisions along eccentricity angle
 sparam.pol_width       = 48;    % wedge width in deg along polar angle
 sparam.pol_phase       = 0;     % phase shift in deg
 sparam.pol_rotangle    = 12;    % rotation angle in deg
 sparam.pol_startangle  = -sparam.pol_width/2-90; % presentation start angle in deg, from right-horizontal meridian, ccw

 sparam.ecc_nwedges     = 4;     % number of wedge subdivisions along polar angle
 sparam.ecc_nrings      = 2;     % number of ring subdivisions along eccentricity angle
 sparam.ecc_width       = sparam.pol_width/2;
 sparam.ecc_phase       = 0;     % phase shift in deg
 sparam.ecc_rotangle    = sparam.pol_rotangle;
 sparam.ecc_startangle  = -sparam.ecc_width/2-90;  % presentation start angle in deg, from right-horizontal meridian, ccw (actually this value is not used for the eccentricity stimuli (exp and cont))

 sparam.maxRad      = 6.0;  % maximum radius of  annulus (degrees)
 sparam.minRad      = 0;    % minumum

 sparam.colors      = [ 128, 128, 128; % number of colors for compensating flickering checkerboard
                        255,   0,   0; % the first row is background
                          0, 255,   0; % the second to end are patch colors
                        255, 255,   0;
                          0,   0, 255;
                        255,   0, 255;
                          0, 255, 255;
                        255, 255, 255;
                          0,   0,   0;
                        255, 128,   0;
                        128,   0, 255;];

 %%% duration in msec for each cycle &amp; repetitions
 % ===========================================================================================================================================
 % IMPORTANT NOTE: sparam.pol_cycle_duration x sparam.pol_numRepeats should be the same with sparam.ecc_cycle_duration x sparam.ecc_numRepeats
 % ===========================================================================================================================================

 sparam.pol_cycle_duration=60000; % msec
 sparam.pol_rest_duration =0; % msec, rest after each cycle, stimulation = cycle_duration-eccrest
 sparam.pol_numRepeats=6;

 sparam.ecc_cycle_duration=40000; % msec
 sparam.ecc_rest_duration =8000; % msec, rest after each cycle, stimulation = cycle_duration-eccrest
 sparam.ecc_numRepeats=9;

 %%% set number of frames to flip the screen
 % Here, I set the number as large as I can to minimize vertical cynching error.
 % the final 2 is for 2 times repetitions of flicker
 % Set 1 if you want to flip the display at each vertical sync, but not recommended as it uses much CPU power
 sparam.waitframes = Screen('FrameRate',0)*(sparam.cycle_duration/1000) / (360/sparam.rotangle) / ( (size(sparam.colors,1)-1)*2 );
 % sparam.waitframes = 1;

 %%% fixation period in msec before/after presenting the target stimuli, integer
 % must set a value more than 1 TR for initializing the frame counting.
 sparam.initial_fixation_time=[4000,4000];

 %%% fixation size &amp; color
 sparam.fixtype=1; % 1: circular, 2: rectangular, 3: concentric fixation point
 sparam.fixsize=12; % radius in pixels
 sparam.fixcolor=[255,255,255];

 %%% background color
 sparam.bgcolor=sparam.colors(1,:); %[0,0,0];

 %%% background-patch colors (RGB)
 sparam.bgtype=1; % 1: a simple background with sparam.bgcolor (then, the parameters belows are not used), 2: a background with grid guides
 sparam.patch_size=[30,30]; % background patch size, [height,width] in pixels
 sparam.patch_num=[20,40];  % the number of background patches along vertical and horizontal axis
 sparam.patch_color1=[255,255,255];
 sparam.patch_color2=[0,0,0];

 %%% for converting degree to pixels
 run(fullfile(fileparts(mfilename('fullpath')),'sizeparams'));
 %sparam.pix_per_cm=57.1429;
 %sparam.vdist=65;


 [HOWTO create stimulus files]
 1. All of the stimuli are created in this script in real-time
    with MATLAB scripts &amp; functions.
    see ../Generation &amp; ../Common directries.
 2. Stimulus parameters are defined in the display &amp; stimulus file.


 [reference]
 for stmulus generation, see ../Generation &amp; ../Common directories.</pre></div>

<!-- crossreference -->
<h2><a name="_cross"></a>CROSS-REFERENCE INFORMATION <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
<div class="fragment" style="background-image:url(../../hb_brain.png); background-position:right top">
This function calls:
<ul style="list-style-image:url(../../matlabicon.gif)">
<li><a href="../../Retinotopy/Common/BackUpObsoleteFiles.html" class="code" title="function [new_fname,backup_fname]=BackUpObsoleteFiles(tgt_dir,tgt_fname,backup_prefix)">BackUpObsoleteFiles</a>	Backups already-existing file(s) in the target directory by adding some file-prefix.</li><li><a href="../../Retinotopy/Common/CheckPTBversion.html" class="code" title="function [PTB_OK,vertxt] = CheckPTBversion(num_mainver_youwant)">CheckPTBversion</a>	Checks the version of the currently running Psychtoolbox.</li><li><a href="../../Retinotopy/Common/CreateBackgroundImage.html" class="code" title="function [Bimg,parameters] = CreateBackgroundImage(wdims,stdims,pdims,bgcolor,color1,color2,fixcolor,patchnum,fix_flag,save_flag,show_flag)">CreateBackgroundImage</a>	Creates background image that can be used as a background of your stimulus displays.</li><li><a href="../../Retinotopy/Common/CreateFixationImgCircular.html" class="code" title="function fix=CreateFixationImgCircular(fixsize,fixcolor,bgcolor,circlesize,show_flag,save_flag)">CreateFixationImgCircular</a>	Creates a circular fixation image for a monocular display setting.</li><li><a href="../../Retinotopy/Common/CreateFixationImgConcentrateMono.html" class="code" title="function fix=CreateFixationImgConcentrateMono(fixsize,fixcolor,bgcolor,circlesize,gap,show_flag,save_flag)">CreateFixationImgConcentrateMono</a>	Creates a circular fixation image for a monocular display setting.</li><li><a href="../../Retinotopy/Common/CreateFixationImgMono.html" class="code" title="function fix=CreateFixationImgMono(fixsize,fixcolor,bgcolor,fixlinew,fixlineh,show_flag,save_flag)">CreateFixationImgMono</a>	Creates a cross-shaped fixation image for a monocular display setting.</li><li><a href="../../Retinotopy/Common/DisplayMessage2.html" class="code" title="function DisplayMessage2(message,bgcolor,winPtr,numScreens,drawing_font,drawing_size)">DisplayMessage2</a>	Displays message on the center of each of multiple PTB windows.</li><li><a href="../../Retinotopy/Common/DrawTextureWithCLUT.html" class="code" title="function DrawTextureWithCLUT(win, src, newclut, srcRect, destRect, rotangle)">DrawTextureWithCLUT</a>	Draws a texture with Color LookupTable you specified (modified version of Screen('DrawTexture')).</li><li><a href="../../Retinotopy/Common/GammaLoadPTB.html" class="code" title="function GammaLoadPTB(gamma_table)">GammaLoadPTB</a>	Loads and sets display gamma-table(s) using PTB Screen() function.</li><li><a href="../../Retinotopy/Common/GammaResetPTB.html" class="code" title="function GammaResetPTB(luminance_ratio)">GammaResetPTB</a>	Resets display gamma with PTB Screen() function.</li><li><a href="../../Retinotopy/Common/InitializePTBDisplays.html" class="code" title="function [winPtr,winRect,nScr,fps,ifi,initDisplay_OK]=InitializePTBDisplays(disp_mode,bgcolor,flipping,rgb_gains,custom_scrIDs)">InitializePTBDisplays</a>	Initializes PTB screen(s) for monocular/binocular presentations using PsychImaging() function.</li><li><a href="../../Retinotopy/Common/InitializeRandomSeed.html" class="code" title="function cseed=InitializeRandomSeed">InitializeRandomSeed</a>	Initializes MATLAB internal state of a random seed.</li><li><a href="../../Retinotopy/Common/ValidateStructureFields.html" class="code" title="function structval=ValidateStructureFields(structval,varargin)">ValidateStructureFields</a>	Validates the input structure and set the default values to the missing field(s)</li><li><a href="../../Retinotopy/Common/eventlogger.html" class="code" title="">eventlogger</a>	</li><li><a href="../../Retinotopy/Common/isstructmember.html" class="code" title="function isFieldResult = isstructmember(inStruct, fieldName)">isstructmember</a>	Checks whether the target struct contains a filed you specified as a member.</li><li><a href="../../Retinotopy/Common/responselogger.html" class="code" title="">responselogger</a>	</li><li><a href="../../Retinotopy/Generation/DrawTextureWithCLUT.html" class="code" title="function DrawTextureWithCLUT(win, src, newclut, srcRect, destRect, rotangle)">DrawTextureWithCLUT</a>	Draws a texture with Color LookupTable you specified (modified version of Screen('DrawTexture')).</li><li><a href="../../Retinotopy/Generation/ecc_GenerateCheckerBoard1D.html" class="code" title="function [checkerboard,bincheckerboard,mask]=ecc_GenerateCheckerBoard1D(edges,width,startangle,pix_per_deg,nwedges,nrings,phase)">ecc_GenerateCheckerBoard1D</a>	Generates checkerboard patterns (annulus-based subdivision) with an individual ID number on each patch.</li><li><a href="../../Retinotopy/Generation/pol_GenerateCheckerBoard1D.html" class="code" title="function [checkerboard,bincheckerboard,mask]=pol_GenerateCheckerBoard1D(rmin,rmax,width,startangle,pix_per_deg,nwedges,nrings,phase,dual_flg)">pol_GenerateCheckerBoard1D</a>	Generates checkerboard patterns (polar angle-based subdivision) with an individual ID number on each patch.</li></ul>
This function is called by:
<ul style="list-style-image:url(../../matlabicon.gif)">
</ul>
</div>
<!-- crossreference -->



<h2><a name="_source"></a>SOURCE CODE <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
<div class="fragment" style="background-image:url(../../hb_brain.png); background-position:right top"><pre>0001 <a name="_sub0" href="#_subfunctions" class="code">function cdual_fixtask(subjID,exp_mode,acq,displayfile,stimulusfile,gamma_table,overwrite_flg,force_proceed_flag)</a>
0002 
0003 <span class="comment">% Color/luminance-defined checkerboard retinotopy stimulus with fixation luminance change-detection tasks.</span>
0004 <span class="comment">% function cdual_fixtask(subjID,exp_mode,acq,:displayfile,:stimulusfile,:gamma_table,:overwrite_flg,:force_proceed_flag)</span>
0005 <span class="comment">% (: is optional)</span>
0006 <span class="comment">%</span>
0007 <span class="comment">% - This function generates and presents color/luminance-defined checkerboard stimulus</span>
0008 <span class="comment">%   (dual stimuli: wedge + annulus) to measure cortical retinotopy and to delineate</span>
0009 <span class="comment">%   retinotopic borders using the standard phase-encoded or pRF (population receptive</span>
0010 <span class="comment">%   field) analysis techniques.</span>
0011 <span class="comment">%</span>
0012 <span class="comment">%   references: 1. Population receptive field estimates in human visual cortex.</span>
0013 <span class="comment">%                  Dumoulin, S.O. and Wandell, B.A. (2008). Neuroimage, 39(2), 647-660.</span>
0014 <span class="comment">%               2. Borders of multiple visual areas in humans revealed by functional magnetic resonance imaging.</span>
0015 <span class="comment">%                  Sereno MI, Dale AM, Reppas JB, Kwong KK, Belliveau JW, Brady TJ, Rosen BR, Tootell RB. (1995).</span>
0016 <span class="comment">%                  Science 268(5212), 889-893.</span>
0017 <span class="comment">%               3. fMRI of human visual cortex.</span>
0018 <span class="comment">%                  Engel SA, Rumelhart DE, Wandell BA, Lee AT, Glover GH, Chichilnisky EJ, Shadlen MN. (1994).</span>
0019 <span class="comment">%                  Nature, 369(6481), 525.</span>
0020 <span class="comment">%               4. Visual field maps in human cortex.</span>
0021 <span class="comment">%                  Wandell BA, Dumoulin SO, Brewer AA. (2007). Neuron, 56(2), 366-383.</span>
0022 <span class="comment">%</span>
0023 <span class="comment">% - This script shoud be used with MATLAB Psychtoolbox version 3 or above.</span>
0024 <span class="comment">%</span>
0025 <span class="comment">% - Luminance detection task: the central fixation point (default: white)</span>
0026 <span class="comment">%   randomly turns to gray. An observer has to press the button if s/he</span>
0027 <span class="comment">%   detects this luminance change. Response keys are defined in displayfile.</span>
0028 <span class="comment">%</span>
0029 <span class="comment">% [note]</span>
0030 <span class="comment">% Behavioral task of (function_name)_fixtask is to detect changes of luminance</span>
0031 <span class="comment">% of the central fixation point, while the task in (function_name) is to detect</span>
0032 <span class="comment">% changes of luminance of one of the patches in the checkerboard stimuli.</span>
0033 <span class="comment">% Here, the central fixation task is more easy to sustain the stable fixation</span>
0034 <span class="comment">% on the center of the screen and may be suitable for naive/non-expert</span>
0035 <span class="comment">% participants with minimizing unwilling eye movements. However, some studies</span>
0036 <span class="comment">% have reported that attention to the target stimulus (checker-patch luminance</span>
0037 <span class="comment">% change detection task) is required to get reliable retinotopic representations</span>
0038 <span class="comment">% in higher-order visual areas.</span>
0039 <span class="comment">%</span>
0040 <span class="comment">%</span>
0041 <span class="comment">% Created    : &quot;2018-12-20 14:26:03 ban&quot;</span>
0042 <span class="comment">% Last Update: &quot;2021-06-07 17:28:35 ban&quot;</span>
0043 <span class="comment">%</span>
0044 <span class="comment">%</span>
0045 <span class="comment">%</span>
0046 <span class="comment">% [input variables]</span>
0047 <span class="comment">% sujID         : ID of subject, string, such as 's01'</span>
0048 <span class="comment">%                 you also need to create a directory ./subjects/(subj) and put displayfile and stimulusfile there.</span>
0049 <span class="comment">%                 !!!!!!!!!!!!!!!!!! IMPORTANT NOTE !!!!!!!!!!!!!!!!!!!!!!!!</span>
0050 <span class="comment">%                 !!! if 'debug' (case insensitive) is included          !!!</span>
0051 <span class="comment">%                 !!! in subjID string, this program runs as DEBUG mode; !!!</span>
0052 <span class="comment">%                 !!! stimulus images are saved as *.png format at       !!!</span>
0053 <span class="comment">%                 !!! ~/Retinotopy/Presentation/images                   !!!</span>
0054 <span class="comment">%                 !!!!!!!!!!!!!!!!!! IMPORTANT NOTE !!!!!!!!!!!!!!!!!!!!!!!!</span>
0055 <span class="comment">%</span>
0056 <span class="comment">% exp_mode      : experiment mode that you want to run, one of</span>
0057 <span class="comment">%  - ccwexp : a checkerboard wedge rotating counter-clockwisely + an expanding annulus</span>
0058 <span class="comment">%  - cwexp  : a checkerboard wedge rotating clockwisely + an expanding annulus</span>
0059 <span class="comment">%  - ccwcont: a checkerboard wedge rotating counter-clockwisely + a contracting annulus</span>
0060 <span class="comment">%  - cwcont : a checkerboard wedge rotating clockwisely + a contracting annulus</span>
0061 <span class="comment">% acq           : acquisition number (design file number),</span>
0062 <span class="comment">%                 an integer, such as 1, 2, 3, ...</span>
0063 <span class="comment">% displayfile   : (optional) display condition file,</span>
0064 <span class="comment">%                 *.m file, such as 'RetDepth_display_fmri.m'</span>
0065 <span class="comment">%                 the file should be located in ./subjects/(subj)/</span>
0066 <span class="comment">% stimulusfile  : (optional) stimulus condition file,</span>
0067 <span class="comment">%                 *.m file, such as 'RetDepth_stimulus_exp1.m'</span>
0068 <span class="comment">%                 the file should be located in ./subjects/(subj)/</span>
0069 <span class="comment">% gamma_table   : (optional) table(s) of gamma-corrected video input values (Color LookupTable).</span>
0070 <span class="comment">%                 256(8-bits) x 3(RGB) x 1(or 2,3,... when using multiple displays) matrix</span>
0071 <span class="comment">%                 or a *.mat file specified with a relative path format. e.g. '/gamma_table/gamma1.mat'</span>
0072 <span class="comment">%                 The *.mat should include a variable named &quot;gamma_table&quot; consists of a 256x3xN matrix.</span>
0073 <span class="comment">%                 if you use multiple (more than 1) displays and set a 256x3x1 gamma-table, the same</span>
0074 <span class="comment">%                 table will be applied to all displays. if the number of displays and gamma tables</span>
0075 <span class="comment">%                 are different (e.g. you have 3 displays and 256x3x!2! gamma-tables), the last</span>
0076 <span class="comment">%                 gamma_table will be applied to the second and third displays.</span>
0077 <span class="comment">%                 if empty, normalized gamma table (repmat(linspace(0.0,1.0,256),3,1)) will be applied.</span>
0078 <span class="comment">% overwrite_flg : (optional) whether overwriting pre-existing result file. if 1, the previous result</span>
0079 <span class="comment">%                 file with the same acquisition number will be overwritten by the previous one.</span>
0080 <span class="comment">%                 if 0, the existing file will be backed-up by adding a prefix '_old' at the tail</span>
0081 <span class="comment">%                 of the file. 0 by default.</span>
0082 <span class="comment">% force_proceed_flag : (optional) whether proceeding stimulus presentatin without waiting for</span>
0083 <span class="comment">%                 the experimenter response (e.g. presesing the ENTER key) or a trigger.</span>
0084 <span class="comment">%                 if 1, the stimulus presentation will be automatically carried on.</span>
0085 <span class="comment">%</span>
0086 <span class="comment">% !!! NOTICE !!!!</span>
0087 <span class="comment">% displayfile &amp; stimulusfile should be located at</span>
0088 <span class="comment">% ./subjects/(subjID)/</span>
0089 <span class="comment">% as ./subjects/(subjID)/*_display_fmri.m</span>
0090 <span class="comment">%    ./subjects/(subjID)/*_stimuli.m</span>
0091 <span class="comment">%</span>
0092 <span class="comment">%</span>
0093 <span class="comment">% [output variables]</span>
0094 <span class="comment">% no output matlab variable.</span>
0095 <span class="comment">%</span>
0096 <span class="comment">%</span>
0097 <span class="comment">% [output files]</span>
0098 <span class="comment">% 1. result file</span>
0099 <span class="comment">%    stored ./subjects/(subjID)/results/(date)</span>
0100 <span class="comment">%    as ./subjects/(subjID)/results/(date)/(subjID)_cdual_fixtask_(exp_mode)_results_run_(run_num).mat</span>
0101 <span class="comment">%</span>
0102 <span class="comment">%</span>
0103 <span class="comment">% [example]</span>
0104 <span class="comment">% &gt;&gt; cdual_fixtask('HB','ccwexp',1,'ret_display.m','ret_checker_stimulus_exp1.m')</span>
0105 <span class="comment">%</span>
0106 <span class="comment">% [About displayfile]</span>
0107 <span class="comment">% The contents of the displayfile are as below.</span>
0108 <span class="comment">% (The file includs 6 lines of headers and following display parameters)</span>
0109 <span class="comment">%</span>
0110 <span class="comment">% (an example of the displayfile)</span>
0111 <span class="comment">%</span>
0112 <span class="comment">% % ************************************************************</span>
0113 <span class="comment">% % This is the display configuration file for the retinotopy stimuli</span>
0114 <span class="comment">% % Programmed by Hiroshi Ban Nov 01 2013</span>
0115 <span class="comment">% % ************************************************************</span>
0116 <span class="comment">%</span>
0117 <span class="comment">% % display mode, one of &quot;mono&quot;, &quot;dual&quot;, &quot;dualcross&quot;, &quot;dualparallel&quot;, &quot;cross&quot;, &quot;parallel&quot;, &quot;redgreen&quot;, &quot;greenred&quot;,</span>
0118 <span class="comment">% % &quot;redblue&quot;, &quot;bluered&quot;, &quot;shutter&quot;, &quot;topbottom&quot;, &quot;bottomtop&quot;, &quot;interleavedline&quot;, &quot;interleavedcolumn&quot;, &quot;propixxmono&quot;, &quot;propixxstereo&quot;</span>
0119 <span class="comment">% dparam.ExpMode='mono';</span>
0120 <span class="comment">%</span>
0121 <span class="comment">% dparam.scrID=1; % screen ID, generally 0 for a single display setup, 1 for dual display setup</span>
0122 <span class="comment">%</span>
0123 <span class="comment">% % a method to start stimulus presentation</span>
0124 <span class="comment">% % 0:ENTER/SPACE, 1:Left-mouse button, 2:the first MR trigger pulse (CiNet),</span>
0125 <span class="comment">% % 3:waiting for a MR trigger pulse (BUIC) -- checking onset of pin #11 of the parallel port,</span>
0126 <span class="comment">% % or 4:custom key trigger (wait for a key input that you specify as tgt_key).</span>
0127 <span class="comment">% dparam.start_method=2;</span>
0128 <span class="comment">%</span>
0129 <span class="comment">% % a pseudo trigger key from the MR scanner when it starts, valid only when dparam.start_method=4;</span>
0130 <span class="comment">% dparam.custom_trigger='t';</span>
0131 <span class="comment">%</span>
0132 <span class="comment">% % keyboard settings</span>
0133 <span class="comment">% dparam.Key1=51; % key 1 (left)</span>
0134 <span class="comment">% dparam.Key2=52; % key 2 (right)</span>
0135 <span class="comment">%</span>
0136 <span class="comment">% % screen settings</span>
0137 <span class="comment">%</span>
0138 <span class="comment">% %%% whether displaying the stimuli in full-screen mode or</span>
0139 <span class="comment">% %%% as is (the precise resolution), 'true' or 'false' (true)</span>
0140 <span class="comment">% dparam.fullscr=false;</span>
0141 <span class="comment">%</span>
0142 <span class="comment">% %%% the resolution of the screen height</span>
0143 <span class="comment">% dparam.ScrHeight=1200;</span>
0144 <span class="comment">%</span>
0145 <span class="comment">% %% the resolution of the screen width</span>
0146 <span class="comment">% dparam.ScrWidth=1920;</span>
0147 <span class="comment">%</span>
0148 <span class="comment">% % whether forcing to use specific frame rate, if 0, the frame rate wil bw computed in the ImagesShowPTB function.</span>
0149 <span class="comment">% % if non zero, the value is used as the screen frame rate.</span>
0150 <span class="comment">% dparam.force_frame_rate=60;</span>
0151 <span class="comment">%</span>
0152 <span class="comment">% % whther skipping the PTB's vertical-sync signal test. if 1, the sync test is skipped</span>
0153 <span class="comment">% dparam.skip_sync_test=0;</span>
0154 <span class="comment">%</span>
0155 <span class="comment">%</span>
0156 <span class="comment">% [About stimulusfile]</span>
0157 <span class="comment">% The contents of the stimulusfile are as below.</span>
0158 <span class="comment">% (The file includs 6 lines of headers and following stimulus parameters)</span>
0159 <span class="comment">%</span>
0160 <span class="comment">% (an example of the stimulusfile)</span>
0161 <span class="comment">%</span>
0162 <span class="comment">% % ************************************************************</span>
0163 <span class="comment">% % This is the stimulus parameter file for the dual (wedge + annulus) retinotopy stimulus</span>
0164 <span class="comment">% % Programmed by Hiroshi Ban Jan 25 2019</span>
0165 <span class="comment">% % ************************************************************</span>
0166 <span class="comment">%</span>
0167 <span class="comment">% % &quot;sparam&quot; means &quot;stimulus generation parameters&quot;</span>
0168 <span class="comment">%</span>
0169 <span class="comment">% %%% stimulus parameters</span>
0170 <span class="comment">% sparam.pol_nwedges     = 4;     % number of wedge subdivisions along polar angle</span>
0171 <span class="comment">% sparam.pol_nrings      = 8;     % number of ring subdivisions along eccentricity angle</span>
0172 <span class="comment">% sparam.pol_width       = 48;    % wedge width in deg along polar angle</span>
0173 <span class="comment">% sparam.pol_phase       = 0;     % phase shift in deg</span>
0174 <span class="comment">% sparam.pol_rotangle    = 12;    % rotation angle in deg</span>
0175 <span class="comment">% sparam.pol_startangle  = -sparam.pol_width/2-90; % presentation start angle in deg, from right-horizontal meridian, ccw</span>
0176 <span class="comment">%</span>
0177 <span class="comment">% sparam.ecc_nwedges     = 4;     % number of wedge subdivisions along polar angle</span>
0178 <span class="comment">% sparam.ecc_nrings      = 2;     % number of ring subdivisions along eccentricity angle</span>
0179 <span class="comment">% sparam.ecc_width       = sparam.pol_width/2;</span>
0180 <span class="comment">% sparam.ecc_phase       = 0;     % phase shift in deg</span>
0181 <span class="comment">% sparam.ecc_rotangle    = sparam.pol_rotangle;</span>
0182 <span class="comment">% sparam.ecc_startangle  = -sparam.ecc_width/2-90;  % presentation start angle in deg, from right-horizontal meridian, ccw (actually this value is not used for the eccentricity stimuli (exp and cont))</span>
0183 <span class="comment">%</span>
0184 <span class="comment">% sparam.maxRad      = 6.0;  % maximum radius of  annulus (degrees)</span>
0185 <span class="comment">% sparam.minRad      = 0;    % minumum</span>
0186 <span class="comment">%</span>
0187 <span class="comment">% sparam.colors      = [ 128, 128, 128; % number of colors for compensating flickering checkerboard</span>
0188 <span class="comment">%                        255,   0,   0; % the first row is background</span>
0189 <span class="comment">%                          0, 255,   0; % the second to end are patch colors</span>
0190 <span class="comment">%                        255, 255,   0;</span>
0191 <span class="comment">%                          0,   0, 255;</span>
0192 <span class="comment">%                        255,   0, 255;</span>
0193 <span class="comment">%                          0, 255, 255;</span>
0194 <span class="comment">%                        255, 255, 255;</span>
0195 <span class="comment">%                          0,   0,   0;</span>
0196 <span class="comment">%                        255, 128,   0;</span>
0197 <span class="comment">%                        128,   0, 255;];</span>
0198 <span class="comment">%</span>
0199 <span class="comment">% %%% duration in msec for each cycle &amp; repetitions</span>
0200 <span class="comment">% % ===========================================================================================================================================</span>
0201 <span class="comment">% % IMPORTANT NOTE: sparam.pol_cycle_duration x sparam.pol_numRepeats should be the same with sparam.ecc_cycle_duration x sparam.ecc_numRepeats</span>
0202 <span class="comment">% % ===========================================================================================================================================</span>
0203 <span class="comment">%</span>
0204 <span class="comment">% sparam.pol_cycle_duration=60000; % msec</span>
0205 <span class="comment">% sparam.pol_rest_duration =0; % msec, rest after each cycle, stimulation = cycle_duration-eccrest</span>
0206 <span class="comment">% sparam.pol_numRepeats=6;</span>
0207 <span class="comment">%</span>
0208 <span class="comment">% sparam.ecc_cycle_duration=40000; % msec</span>
0209 <span class="comment">% sparam.ecc_rest_duration =8000; % msec, rest after each cycle, stimulation = cycle_duration-eccrest</span>
0210 <span class="comment">% sparam.ecc_numRepeats=9;</span>
0211 <span class="comment">%</span>
0212 <span class="comment">% %%% set number of frames to flip the screen</span>
0213 <span class="comment">% % Here, I set the number as large as I can to minimize vertical cynching error.</span>
0214 <span class="comment">% % the final 2 is for 2 times repetitions of flicker</span>
0215 <span class="comment">% % Set 1 if you want to flip the display at each vertical sync, but not recommended as it uses much CPU power</span>
0216 <span class="comment">% sparam.waitframes = Screen('FrameRate',0)*(sparam.cycle_duration/1000) / (360/sparam.rotangle) / ( (size(sparam.colors,1)-1)*2 );</span>
0217 <span class="comment">% % sparam.waitframes = 1;</span>
0218 <span class="comment">%</span>
0219 <span class="comment">% %%% fixation period in msec before/after presenting the target stimuli, integer</span>
0220 <span class="comment">% % must set a value more than 1 TR for initializing the frame counting.</span>
0221 <span class="comment">% sparam.initial_fixation_time=[4000,4000];</span>
0222 <span class="comment">%</span>
0223 <span class="comment">% %%% fixation size &amp; color</span>
0224 <span class="comment">% sparam.fixtype=1; % 1: circular, 2: rectangular, 3: concentric fixation point</span>
0225 <span class="comment">% sparam.fixsize=12; % radius in pixels</span>
0226 <span class="comment">% sparam.fixcolor=[255,255,255];</span>
0227 <span class="comment">%</span>
0228 <span class="comment">% %%% background color</span>
0229 <span class="comment">% sparam.bgcolor=sparam.colors(1,:); %[0,0,0];</span>
0230 <span class="comment">%</span>
0231 <span class="comment">% %%% background-patch colors (RGB)</span>
0232 <span class="comment">% sparam.bgtype=1; % 1: a simple background with sparam.bgcolor (then, the parameters belows are not used), 2: a background with grid guides</span>
0233 <span class="comment">% sparam.patch_size=[30,30]; % background patch size, [height,width] in pixels</span>
0234 <span class="comment">% sparam.patch_num=[20,40];  % the number of background patches along vertical and horizontal axis</span>
0235 <span class="comment">% sparam.patch_color1=[255,255,255];</span>
0236 <span class="comment">% sparam.patch_color2=[0,0,0];</span>
0237 <span class="comment">%</span>
0238 <span class="comment">% %%% for converting degree to pixels</span>
0239 <span class="comment">% run(fullfile(fileparts(mfilename('fullpath')),'sizeparams'));</span>
0240 <span class="comment">% %sparam.pix_per_cm=57.1429;</span>
0241 <span class="comment">% %sparam.vdist=65;</span>
0242 <span class="comment">%</span>
0243 <span class="comment">%</span>
0244 <span class="comment">% [HOWTO create stimulus files]</span>
0245 <span class="comment">% 1. All of the stimuli are created in this script in real-time</span>
0246 <span class="comment">%    with MATLAB scripts &amp; functions.</span>
0247 <span class="comment">%    see ../Generation &amp; ../Common directries.</span>
0248 <span class="comment">% 2. Stimulus parameters are defined in the display &amp; stimulus file.</span>
0249 <span class="comment">%</span>
0250 <span class="comment">%</span>
0251 <span class="comment">% [reference]</span>
0252 <span class="comment">% for stmulus generation, see ../Generation &amp; ../Common directories.</span>
0253 
0254 
0255 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0256 <span class="comment">%%%% Check the input variables</span>
0257 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0258 
0259 clear <span class="keyword">global</span>; clear mex;
0260 <span class="keyword">if</span> nargin&lt;3, help(mfilename()); <span class="keyword">return</span>; <span class="keyword">end</span>
0261 <span class="keyword">if</span> nargin&lt;4 || isempty(displayfile), displayfile=[]; <span class="keyword">end</span>
0262 <span class="keyword">if</span> nargin&lt;5 || isempty(stimulusfile), stimulusfile=[]; <span class="keyword">end</span>
0263 <span class="keyword">if</span> nargin&lt;6 || isempty(gamma_table), gamma_table=[]; <span class="keyword">end</span>
0264 <span class="keyword">if</span> nargin&lt;7 || isempty(overwrite_flg), overwrite_flg=1; <span class="keyword">end</span>
0265 <span class="keyword">if</span> nargin&lt;8 || isempty(force_proceed_flag), force_proceed_flag=0; <span class="keyword">end</span>
0266 
0267 <span class="comment">% check the aqcuisition number</span>
0268 <span class="keyword">if</span> acq&lt;1, error(<span class="string">'Acquistion number must be integer and greater than zero'</span>); <span class="keyword">end</span>
0269 
0270 <span class="comment">% check the experiment mode (stimulus type)</span>
0271 <span class="keyword">if</span> ~strcmpi(exp_mode,<span class="string">'ccwexp'</span>) &amp;&amp; ~strcmpi(exp_mode,<span class="string">'cwexp'</span>) &amp;&amp; ~strcmpi(exp_mode,<span class="string">'ccwcont'</span>) &amp;&amp; ~strcmpi(exp_mode,<span class="string">'cwcont'</span>)
0272   error(<span class="string">'exp_mode should be one of &quot;ccwexp&quot;, &quot;cwexp&quot;, &quot;ccwcont&quot;, and &quot;cwcont&quot;. check the input variable.'</span>);
0273 <span class="keyword">end</span>
0274 
0275 rootDir=fileparts(mfilename(<span class="string">'fullpath'</span>));
0276 
0277 <span class="comment">% check the subject directory</span>
0278 <span class="keyword">if</span> ~exist(fullfile(rootDir,<span class="string">'subjects'</span>,subjID),<span class="string">'dir'</span>), error(<span class="string">'can not find subj directory. check the input variable.'</span>); <span class="keyword">end</span>
0279 
0280 <span class="comment">% check the display/stimulus files</span>
0281 <span class="keyword">if</span> ~isempty(displayfile)
0282   <span class="keyword">if</span> ~strcmpi(displayfile(end-1:end),<span class="string">'.m'</span>), displayfile=[displayfile,<span class="string">'.m'</span>]; <span class="keyword">end</span>
0283   <span class="keyword">if</span> ~exist(fullfile(rootDir,<span class="string">'subjects'</span>,subjID,displayfile),<span class="string">'file'</span>), error(<span class="string">'displayfile not found. check the input variable.'</span>); <span class="keyword">end</span>
0284 <span class="keyword">end</span>
0285 
0286 <span class="keyword">if</span> ~isempty(stimulusfile)
0287   <span class="keyword">if</span> ~strcmpi(stimulusfile(end-1:end),<span class="string">'.m'</span>), stimulusfile=[stimulusfile,<span class="string">'.m'</span>]; <span class="keyword">end</span>
0288   <span class="keyword">if</span> ~exist(fullfile(rootDir,<span class="string">'subjects'</span>,subjID,stimulusfile),<span class="string">'file'</span>), error(<span class="string">'stimulusfile not found. check the input variable.'</span>); <span class="keyword">end</span>
0289 <span class="keyword">end</span>
0290 
0291 
0292 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0293 <span class="comment">%%%% Add path to the subfunctions</span>
0294 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0295 
0296 <span class="comment">% add paths to the subfunctions</span>
0297 addpath(genpath(fullfile(rootDir,<span class="string">'..'</span>,<span class="string">'Common'</span>)));
0298 addpath(fullfile(rootDir,<span class="string">'..'</span>,<span class="string">'Generation'</span>));
0299 
0300 
0301 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0302 <span class="comment">%%%% For log file</span>
0303 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0304 
0305 <span class="comment">% get date</span>
0306 today=datestr(now,<span class="string">'yymmdd'</span>);
0307 
0308 <span class="comment">% result directry &amp; file</span>
0309 resultDir=fullfile(rootDir,<span class="string">'subjects'</span>,num2str(subjID),<span class="string">'results'</span>,today);
0310 <span class="keyword">if</span> ~exist(resultDir,<span class="string">'dir'</span>), mkdir(resultDir); <span class="keyword">end</span>
0311 
0312 <span class="comment">% record the output window</span>
0313 logfname=fullfile(resultDir,[num2str(subjID),<span class="string">'_cdual_fixtask_'</span>,exp_mode,<span class="string">'_results_run_'</span>,num2str(acq,<span class="string">'%02d'</span>),<span class="string">'.log'</span>]);
0314 diary(logfname);
0315 warning off; <span class="comment">%#ok warning('off','MATLAB:dispatcher:InexactCaseMatch');</span>
0316 
0317 
0318 <span class="comment">%%%%% try &amp; catch %%%%%</span>
0319 <span class="keyword">try</span>
0320 
0321 
0322 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0323 <span class="comment">%%%% Check the PTB version</span>
0324 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0325 
0326 PTB_OK=<a href="../../Retinotopy/Common/CheckPTBversion.html" class="code" title="function [PTB_OK,vertxt] = CheckPTBversion(num_mainver_youwant)">CheckPTBversion</a>(3); <span class="comment">% check wether the PTB version is 3</span>
0327 <span class="keyword">if</span> ~PTB_OK, error(<span class="string">'Wrong version of Psychtoolbox is running. %s requires PTB ver.3'</span>,mfilename()); <span class="keyword">end</span>
0328 
0329 <span class="comment">% debug level, black screen during calibration</span>
0330 Screen(<span class="string">'Preference'</span>, <span class="string">'VisualDebuglevel'</span>, 3);
0331 
0332 
0333 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0334 <span class="comment">%%%% Setup random seed</span>
0335 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0336 
0337 <a href="../../Retinotopy/Common/InitializeRandomSeed.html" class="code" title="function cseed=InitializeRandomSeed">InitializeRandomSeed</a>();
0338 
0339 
0340 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0341 <span class="comment">%%%% Reset display Gamma-function</span>
0342 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0343 
0344 <span class="keyword">if</span> isempty(gamma_table)
0345   gamma_table=repmat(linspace(0.0,1.0,256),3,1); <span class="comment">%#ok</span>
0346   <a href="../../Retinotopy/Common/GammaResetPTB.html" class="code" title="function GammaResetPTB(luminance_ratio)">GammaResetPTB</a>(1.0);
0347 <span class="keyword">else</span>
0348   <a href="../../Retinotopy/Common/GammaLoadPTB.html" class="code" title="function GammaLoadPTB(gamma_table)">GammaLoadPTB</a>(gamma_table);
0349 <span class="keyword">end</span>
0350 
0351 
0352 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0353 <span class="comment">%%%% Validate dparam (displayfile) and sparam (stimulusfile) structures</span>
0354 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0355 
0356 <span class="comment">% organize dparam</span>
0357 dparam=struct(); <span class="comment">% initialize</span>
0358 <span class="keyword">if</span> ~isempty(displayfile), run(fullfile(rootDir,<span class="string">'subjects'</span>,subjID,displayfile)); <span class="keyword">end</span> <span class="comment">% load specific dparam parameters configured for each of the participants</span>
0359 dparam=<a href="../../Retinotopy/Common/ValidateStructureFields.html" class="code" title="function structval=ValidateStructureFields(structval,varargin)">ValidateStructureFields</a>(dparam,<span class="keyword">...</span><span class="comment"> % validate fields and set the default values to missing field(s)</span>
0360          <span class="string">'ExpMode'</span>,<span class="string">'mono'</span>,<span class="keyword">...</span>
0361          <span class="string">'scrID'</span>,1,<span class="keyword">...</span>
0362          <span class="string">'start_method'</span>,0,<span class="keyword">...</span>
0363          <span class="string">'custom_trigger'</span>,<span class="string">'t'</span>,<span class="keyword">...</span>
0364          <span class="string">'Key1'</span>,51,<span class="keyword">...</span>
0365          <span class="string">'Key2'</span>,52,<span class="keyword">...</span>
0366          <span class="string">'fullscr'</span>,false,<span class="keyword">...</span>
0367          <span class="string">'ScrHeight'</span>,1200,<span class="keyword">...</span>
0368          <span class="string">'ScrWidth'</span>,1920,<span class="keyword">...</span>
0369          <span class="string">'force_frame_rate'</span>,60,<span class="keyword">...</span>
0370          <span class="string">'skip_sync_test'</span>,0);
0371 
0372 <span class="comment">% organize sparam</span>
0373 sparam=struct(); <span class="comment">% initialize</span>
0374 sparam.mode=exp_mode;
0375 <span class="keyword">if</span> ~isempty(stimulusfile), run(fullfile(rootDir,<span class="string">'subjects'</span>,subjID,stimulusfile)); <span class="keyword">end</span> <span class="comment">% load specific sparam parameters configured for each of the participants</span>
0376 sparam=<a href="../../Retinotopy/Common/ValidateStructureFields.html" class="code" title="function structval=ValidateStructureFields(structval,varargin)">ValidateStructureFields</a>(sparam,<span class="keyword">...</span><span class="comment"> % validate fields and set the default values to missing field(s)</span>
0377          <span class="string">'pol_nwedges'</span>,4,<span class="keyword">...</span>
0378          <span class="string">'pol_nrings'</span>,4,<span class="keyword">...</span>
0379          <span class="string">'pol_width'</span>,48,<span class="keyword">...</span>
0380          <span class="string">'pol_phase'</span>,0,<span class="keyword">...</span>
0381          <span class="string">'pol_rotangle'</span>,12,<span class="keyword">...</span>
0382          <span class="string">'pol_startangle'</span>,-48/2-90,<span class="keyword">...</span>
0383          <span class="string">'ecc_nwedges'</span>,4,<span class="keyword">...</span>
0384          <span class="string">'ecc_nrings'</span>,2,<span class="keyword">...</span>
0385          <span class="string">'ecc_width'</span>,48,<span class="keyword">...</span>
0386          <span class="string">'ecc_phase'</span>,0,<span class="keyword">...</span>
0387          <span class="string">'ecc_rotangle'</span>,12,<span class="keyword">...</span>
0388          <span class="string">'ecc_startangle'</span>,-48/2-90,<span class="keyword">...</span>
0389          <span class="string">'maxRad'</span>,8,<span class="keyword">...</span>
0390          <span class="string">'minRad'</span>,0,<span class="keyword">...</span>
0391          <span class="string">'colors'</span>,[ 128, 128, 128;
0392                     255,   0,   0;
0393                       0, 255,   0;
0394                     255, 255,   0;
0395                       0,   0, 255;
0396                     255,   0, 255;
0397                       0, 255, 255;
0398                     255, 255, 255;
0399                       0,   0,   0;
0400                     255, 128,   0;
0401                     128,   0, 255],<span class="keyword">...</span>
0402          <span class="string">'pol_cycle_duration'</span>,60000,<span class="keyword">...</span>
0403          <span class="string">'pol_rest_duration'</span>,0,<span class="keyword">...</span>
0404          <span class="string">'pol_numRepeats'</span>,6,<span class="keyword">...</span>
0405          <span class="string">'ecc_cycle_duration'</span>,40000,<span class="keyword">...</span>
0406          <span class="string">'ecc_rest_duration'</span>,8000,<span class="keyword">...</span>
0407          <span class="string">'ecc_numRepeats'</span>,9,<span class="keyword">...</span>
0408          <span class="string">'waitframes'</span>,6,<span class="keyword">...</span><span class="comment"> % Screen('FrameRate',0)*(sparam.cycle_duration/1000) / (360/sparam.rotangle) / ( (size(sparam.colors,1)-1)*2 );</span>
0409          <span class="string">'initial_fixation_time'</span>,[4000,4000],<span class="keyword">...</span>
0410          <span class="string">'fixtype'</span>,1,<span class="keyword">...</span>
0411          <span class="string">'fixsize'</span>,12,<span class="keyword">...</span>
0412          <span class="string">'fixcolor'</span>,[255,255,255],<span class="keyword">...</span>
0413          <span class="string">'bgcolor'</span>,[128,128,128],<span class="keyword">...</span><span class="comment"> % sparam.colors(1,:);</span>
0414          <span class="string">'bgtype'</span>,1,<span class="keyword">...</span>
0415          <span class="string">'patch_size'</span>,[30,30],<span class="keyword">...</span>
0416          <span class="string">'patch_num'</span>,[20,40],<span class="keyword">...</span>
0417          <span class="string">'patch_color1'</span>,[255,255,255],<span class="keyword">...</span>
0418          <span class="string">'patch_color2'</span>,[0,0,0],<span class="keyword">...</span>
0419          <span class="string">'pix_per_cm'</span>,57.1429,<span class="keyword">...</span>
0420          <span class="string">'vdist'</span>,65);
0421 
0422 <span class="comment">% change unit from msec to sec.</span>
0423 sparam.initial_fixation_time=sparam.initial_fixation_time./1000; <span class="comment">%#ok</span>
0424 
0425 <span class="comment">% change unit from msec to sec.</span>
0426 sparam.pol_cycle_duration = sparam.pol_cycle_duration./1000;
0427 sparam.pol_rest_duration  = sparam.pol_rest_duration./1000;
0428 
0429 sparam.ecc_cycle_duration = sparam.ecc_cycle_duration./1000;
0430 sparam.ecc_rest_duration  = sparam.ecc_rest_duration./1000;
0431 
0432 <span class="comment">% set the other parameters</span>
0433 dparam.RunScript = mfilename();
0434 sparam.RunScript = mfilename();
0435 
0436 <span class="comment">%% check varidity of parameters</span>
0437 fprintf(<span class="string">'checking validity of stimulus generation/presentation parameters...'</span>);
0438 <span class="keyword">if</span> sparam.pol_cycle_duration*sparam.pol_numRepeats~=sparam.ecc_cycle_duration*sparam.ecc_numRepeats
0439   error(<span class="string">'sparam.pol_cycle_duration x sparam.pol_numRepeats should be the same with sparam.ecc_cycle_duration x sparam.ecc_numRepeats. check the input variables.'</span>);
0440 <span class="keyword">end</span>
0441 <span class="keyword">if</span> mod(360,sparam.pol_rotangle), error(<span class="string">'mod(360,sparam.pol_rotangle) should be 0. check the input variables.'</span>); <span class="keyword">end</span>
0442 <span class="keyword">if</span> mod(360,sparam.ecc_rotangle), error(<span class="string">'mod(360,sparam.ecc_rotangle) should be 0. check the input variables.'</span>); <span class="keyword">end</span>
0443 <span class="keyword">if</span> mod(sparam.pol_width,sparam.pol_rotangle), error(<span class="string">'mod(sparam.pol_width,sparam.pol_rotangle) should be 0. check the input variables.'</span>); <span class="keyword">end</span>
0444 <span class="keyword">if</span> mod(sparam.ecc_width,sparam.ecc_rotangle), error(<span class="string">'mod(sparam.ecc_width,sparam.ecc_rotangle) should be 0. check the input variables.'</span>); <span class="keyword">end</span>
0445 fprintf(<span class="string">'done.\n'</span>);
0446 
0447 
0448 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0449 <span class="comment">%%%% Displaying the presentation parameters you set</span>
0450 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0451 
0452 fprintf(<span class="string">'The Presentation Parameters are as below.\n\n'</span>);
0453 fprintf(<span class="string">'************************************************\n'</span>);
0454 fprintf(<span class="string">'****** Script, Subject, Acquistion Number ******\n'</span>);
0455 fprintf(<span class="string">'Date &amp; Time            : %s\n'</span>,strcat([datestr(now,<span class="string">'yymmdd'</span>),<span class="string">' '</span>,datestr(now,<span class="string">'HH:mm:ss'</span>)]));
0456 fprintf(<span class="string">'Running Script Name    : %s\n'</span>,mfilename());
0457 fprintf(<span class="string">'Subject ID             : %s\n'</span>,subjID);
0458 fprintf(<span class="string">'Acquisition Number     : %d\n'</span>,acq);
0459 fprintf(<span class="string">'********* Run Type, Display Image Type *********\n'</span>);
0460 fprintf(<span class="string">'Display Mode           : %s\n'</span>,dparam.ExpMode);
0461 fprintf(<span class="string">'use Full Screen Mode   : %d\n'</span>,dparam.fullscr);
0462 fprintf(<span class="string">'Start Method           : %d\n'</span>,dparam.start_method);
0463 <span class="keyword">if</span> dparam.start_method==4
0464   fprintf(<span class="string">'Custom Trigger         : %d\n'</span>,dparam.custom_trigger);
0465 <span class="keyword">end</span>
0466 fprintf(<span class="string">'*************** Screen Settings ****************\n'</span>);
0467 fprintf(<span class="string">'Screen Height          : %d\n'</span>,dparam.ScrHeight);
0468 fprintf(<span class="string">'Screen Width           : %d\n'</span>,dparam.ScrWidth);
0469 fprintf(<span class="string">'*********** Stimulation Periods etc. ***********\n'</span>);
0470 fprintf(<span class="string">'Fixation Time(sec)     : %d &amp; %d\n'</span>,sparam.initial_fixation_time(1),sparam.initial_fixation_time(2));
0471 fprintf(<span class="string">'[POL] Cycle Duration(sec) : %d\n'</span>,sparam.pol_cycle_duration);
0472 fprintf(<span class="string">'      Rest  Duration(sec) : %d\n'</span>,sparam.pol_rest_duration);
0473 fprintf(<span class="string">'      Repetitions(cycles) : %d\n'</span>,sparam.pol_numRepeats);
0474 fprintf(<span class="string">'[ECC] Cycle Duration(sec) : %d\n'</span>,sparam.ecc_cycle_duration);
0475 fprintf(<span class="string">'      Rest  Duration(sec) : %d\n'</span>,sparam.ecc_rest_duration);
0476 fprintf(<span class="string">'      Repetitions(cycles) : %d\n'</span>,sparam.ecc_numRepeats);
0477 fprintf(<span class="string">'Frame Flip(per VerSync): %d\n'</span>,sparam.waitframes);
0478 fprintf(<span class="string">'Total Time (sec)       : %d\n'</span>,sum(sparam.initial_fixation_time)+sparam.pol_numRepeats*sparam.pol_cycle_duration);
0479 fprintf(<span class="string">'**************** Stimulus Type *****************\n'</span>);
0480 fprintf(<span class="string">'Experiment Mode        : %s\n'</span>,sparam.mode);
0481 fprintf(<span class="string">'************ Response key settings *************\n'</span>);
0482 fprintf(<span class="string">'Reponse Key #1         : %d = %s\n'</span>,dparam.Key1,KbName(dparam.Key1));
0483 fprintf(<span class="string">'Reponse Key #2         : %d = %s\n'</span>,dparam.Key2,KbName(dparam.Key2));
0484 fprintf(<span class="string">'************************************************\n\n'</span>);
0485 fprintf(<span class="string">'Please carefully check before proceeding.\n\n'</span>);
0486 
0487 
0488 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0489 <span class="comment">%%%% Initialize response &amp; event logger objects</span>
0490 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0491 
0492 <span class="comment">% initialize MATLAB objects for event and response logs</span>
0493 event=<a href="../../Retinotopy/Common/eventlogger.html" class="code" title="">eventlogger</a>();
0494 resps=<a href="../../Retinotopy/Common/responselogger.html" class="code" title="">responselogger</a>([dparam.Key1,dparam.Key2]);
0495 resps.initialize(event); <span class="comment">% initialize responselogger</span>
0496 
0497 
0498 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0499 <span class="comment">%%%% Wait for user reponse to start</span>
0500 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0501 
0502 <span class="keyword">if</span> ~force_proceed_flag
0503   [user_answer,resps]=resps.wait_to_proceed();
0504   <span class="keyword">if</span> ~user_answer, diary off; <span class="keyword">return</span>; <span class="keyword">end</span>
0505 <span class="keyword">end</span>
0506 
0507 
0508 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0509 <span class="comment">%%%% Initialization of Left &amp; Right screens for binocular presenting/viewing mode</span>
0510 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0511 
0512 <span class="keyword">if</span> dparam.skip_sync_test, Screen(<span class="string">'Preference'</span>,<span class="string">'SkipSyncTests'</span>,1); <span class="keyword">end</span>
0513 
0514 [winPtr,winRect,nScr,dparam.fps,dparam.ifi,initDisplay_OK]=<a href="../../Retinotopy/Common/InitializePTBDisplays.html" class="code" title="function [winPtr,winRect,nScr,fps,ifi,initDisplay_OK]=InitializePTBDisplays(disp_mode,bgcolor,flipping,rgb_gains,custom_scrIDs)">InitializePTBDisplays</a>(dparam.ExpMode,sparam.bgcolor,0,[],dparam.scrID);
0515 <span class="keyword">if</span> ~initDisplay_OK, error(<span class="string">'Display initialization error. Please check your exp_run parameter.'</span>); <span class="keyword">end</span>
0516 HideCursor();
0517 
0518 <span class="keyword">if</span> <a href="../../Retinotopy/Common/isstructmember.html" class="code" title="function isFieldResult = isstructmember(inStruct, fieldName)">isstructmember</a>(dparam,<span class="string">'force_frame_rate'</span>)
0519   <span class="keyword">if</span> dparam.force_frame_rate
0520     dparam.fps=dparam.force_frame_rate;
0521     dparam.ifi=1/dparam.fps;
0522   <span class="keyword">end</span>
0523 <span class="keyword">end</span>
0524 
0525 
0526 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0527 <span class="comment">%%%% Setting the PTB runnning priority to MAX</span>
0528 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0529 
0530 <span class="comment">% set the priority of this script to MAX</span>
0531 priorityLevel=MaxPriority(winPtr,<span class="string">'WaitBlanking'</span>);
0532 Priority(priorityLevel);
0533 
0534 <span class="comment">% conserve VRAM memory: Workaround for flawed hardware and drivers</span>
0535 <span class="comment">% 32 == kPsychDontShareContextRessources: Do not share ressources between</span>
0536 <span class="comment">% different onscreen windows. Usually you want PTB to share all ressources</span>
0537 <span class="comment">% like offscreen windows, textures and GLSL shaders among all open onscreen</span>
0538 <span class="comment">% windows. If that causes trouble for some weird reason, you can prevent</span>
0539 <span class="comment">% automatic sharing with this flag.</span>
0540 <span class="comment">%Screen('Preference','ConserveVRAM',32);</span>
0541 
0542 
0543 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0544 <span class="comment">%%%% Setting the PTB OpenGL functions</span>
0545 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0546 
0547 <span class="comment">% Enable OpenGL mode of Psychtoolbox: This is crucially needed for clut animation</span>
0548 InitializeMatlabOpenGL();
0549 
0550 <span class="comment">% This script calls Psychtoolbox commands available only in OpenGL-based</span>
0551 <span class="comment">% versions of the Psychtoolbox. (So far, the OS X Psychtoolbox is the</span>
0552 <span class="comment">% only OpenGL-base Psychtoolbox.)  The Psychtoolbox command AssertPsychOpenGL will issue</span>
0553 <span class="comment">% an error message if someone tries to execute this script on a computer without</span>
0554 <span class="comment">% an OpenGL Psychtoolbox</span>
0555 AssertOpenGL();
0556 
0557 <span class="comment">% set OpenGL blend functions</span>
0558 Screen(<span class="string">'BlendFunction'</span>, winPtr, GL_SRC_ALPHA, GL_ONE_MINUS_SRC_ALPHA);
0559 
0560 
0561 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0562 <span class="comment">%%%% Initializing MATLAB OpenGL shader API</span>
0563 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0564 
0565 <span class="comment">% just call DrawTextureWithCLUT with window pointer alone</span>
0566 <a href="../../Retinotopy/Common/DrawTextureWithCLUT.html" class="code" title="function DrawTextureWithCLUT(win, src, newclut, srcRect, destRect, rotangle)">DrawTextureWithCLUT</a>(winPtr);
0567 
0568 
0569 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0570 <span class="comment">%%%% Displaying 'Initializing...'</span>
0571 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0572 
0573 <span class="comment">% displaying texts on the center of the screen</span>
0574 <a href="../../Retinotopy/Common/DisplayMessage2.html" class="code" title="function DisplayMessage2(message,bgcolor,winPtr,numScreens,drawing_font,drawing_size)">DisplayMessage2</a>(<span class="string">'Initializing...'</span>,sparam.bgcolor,winPtr,nScr,<span class="string">'Arial'</span>,36);
0575 
0576 
0577 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0578 <span class="comment">%%%% Initializing variables</span>
0579 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0580 
0581 <span class="comment">%% unit conversion</span>
0582 
0583 <span class="comment">% cm per pix</span>
0584 sparam.cm_per_pix=1/sparam.pix_per_cm;
0585 
0586 <span class="comment">% pixles per degree</span>
0587 sparam.pix_per_deg=round( 1/( 180*atan(sparam.cm_per_pix/sparam.vdist)/pi ) );
0588 
0589 <span class="comment">% deg to radian</span>
0590 <span class="comment">% do not convert!</span>
0591 <span class="comment">% sparam.width, sparam.phase, sparam.startangle, sparam.rotangle are used in deg formats</span>
0592 
0593 <span class="comment">% number of checkerboard color</span>
0594 sparam.ncolors=(size(sparam.colors,1)-1)/2;
0595 
0596 <span class="comment">% sec to number of frames</span>
0597 nframe_fixation=round(sparam.initial_fixation_time.*dparam.fps./sparam.waitframes);
0598 
0599 sparam.pol_npositions=360/sparam.pol_rotangle;
0600 sparam.ecc_npositions=sparam.pol_npositions*(sparam.ecc_cycle_duration-sparam.ecc_rest_duration)/(sparam.pol_cycle_duration-sparam.pol_rest_duration);
0601 
0602 nframe_stim=round((sparam.pol_cycle_duration-sparam.pol_rest_duration)*dparam.fps/(360/sparam.pol_rotangle)/sparam.waitframes);
0603 nframe_flicker=round(nframe_stim/sparam.ncolors/4);
0604 nframe_task=round(18/sparam.waitframes); <span class="comment">% just arbitral, you can change as you like</span>
0605 
0606 <span class="comment">%% initialize chackerboard parameters</span>
0607 
0608 <span class="comment">% adjust size ratio considering full-screen effect</span>
0609 <span class="keyword">if</span> dparam.fullscr
0610   <span class="comment">% here, use width information alone, assuming that the pixel is square</span>
0611   ratio_wid=( winRect(3)-winRect(1) )/dparam.ScrWidth;
0612   <span class="comment">%ratio_hei=( winRect(4)-winRect(2) )/dparam.ScrHeight;</span>
0613 
0614   <span class="comment">% min/max radius of annulus</span>
0615   rmin=sparam.minRad*ratio_wid; <span class="comment">% !!! degree, not pixel or cm !!!</span>
0616   rmax=sparam.maxRad*ratio_wid;
0617 <span class="keyword">else</span>
0618   rmin=sparam.minRad;
0619   rmax=sparam.maxRad;
0620 <span class="keyword">end</span>
0621 
0622 
0623 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0624 <span class="comment">%%%% Generating checkerboard patterns</span>
0625 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0626 
0627 <span class="comment">% [note]</span>
0628 <span class="comment">% After this processing, each checkerboard image has checker elements with values as shown below</span>
0629 <span class="comment">% 0 = background</span>
0630 <span class="comment">% 1 = checker ID 1</span>
0631 <span class="comment">% 2 = checker ID 2</span>
0632 <span class="comment">% 3 = checker ID 3</span>
0633 <span class="comment">% .....</span>
0634 <span class="comment">% sparam.npatches = checker ID</span>
0635 <span class="comment">% Each patch ID will be associated with a CLUT color of the same ID</span>
0636 
0637 <span class="comment">%%% a wedge for polar representation</span>
0638 startangles=zeros(sparam.pol_npositions,1);
0639 <span class="keyword">for</span> nn=1:1:sparam.pol_npositions, startangles(nn)=sparam.pol_startangle+(nn-1)*sparam.pol_rotangle; <span class="keyword">end</span>
0640 
0641 [pol_checkerboardID,pol_checkerboard]=<a href="../../Retinotopy/Generation/pol_GenerateCheckerBoard1D.html" class="code" title="function [checkerboard,bincheckerboard,mask]=pol_GenerateCheckerBoard1D(rmin,rmax,width,startangle,pix_per_deg,nwedges,nrings,phase,dual_flg)">pol_GenerateCheckerBoard1D</a>(rmin,rmax,sparam.pol_width,startangles,sparam.pix_per_deg,<span class="keyword">...</span>
0642                                                                        sparam.pol_nwedges,sparam.pol_nrings,sparam.pol_phase);
0643 
0644 <span class="comment">%%% an annulus for eccentricity representation</span>
0645 eccedge=(rmax-rmin)/( sparam.ecc_npositions-1 );
0646 eccwidth=eccedge*(sparam.ecc_width/sparam.ecc_rotangle);
0647 
0648 <span class="comment">% get annuli's min/max lims</span>
0649 ecclims=zeros(sparam.ecc_npositions,3);
0650 <span class="keyword">for</span> nn=1:1:sparam.ecc_npositions <span class="comment">%1:1:sparam.npositions</span>
0651   minlim=rmin+(nn-1)*eccedge-eccwidth/2;
0652   <span class="keyword">if</span> minlim&lt;rmin, minlim=rmin; <span class="keyword">end</span>
0653   maxlim=rmin+(nn-1)*eccedge+eccwidth/2;
0654   <span class="keyword">if</span> maxlim&gt;rmax, maxlim=rmax; <span class="keyword">end</span>
0655 
0656   ecclims(nn,:)=[minlim,maxlim,eccwidth];
0657 <span class="keyword">end</span>
0658 
0659 [ecc_checkerboardID,ecc_checkerboard]=<a href="../../Retinotopy/Generation/ecc_GenerateCheckerBoard1D.html" class="code" title="function [checkerboard,bincheckerboard,mask]=ecc_GenerateCheckerBoard1D(edges,width,startangle,pix_per_deg,nwedges,nrings,phase)">ecc_GenerateCheckerBoard1D</a>(ecclims,360,sparam.ecc_startangle,sparam.pix_per_deg,<span class="keyword">...</span>
0660                                       round(360*sparam.ecc_nwedges/sparam.ecc_width),sparam.ecc_nrings,sparam.ecc_phase);
0661 
0662 <span class="comment">%% flip all data for ccw/cont</span>
0663 <span class="keyword">if</span> ~isempty(strfind(sparam.mode,<span class="string">'ccw'</span>))
0664 
0665   tmp_checkerboardID=cell(sparam.pol_npositions,1);
0666   <span class="keyword">for</span> nn=1:1:sparam.pol_npositions, tmp_checkerboardID{nn}=pol_checkerboardID{sparam.pol_npositions-(nn-1)}; <span class="keyword">end</span>
0667   pol_checkerboardID=tmp_checkerboardID;
0668   clear tmp_checkerboardID;
0669 
0670   tmp_checkerboard=cell(sparam.pol_npositions,1);
0671   <span class="keyword">for</span> nn=1:1:sparam.pol_npositions, tmp_checkerboard{nn}=pol_checkerboard{sparam.pol_npositions-(nn-1)}; <span class="keyword">end</span>
0672   pol_checkerboard=tmp_checkerboard;
0673   clear tmp_checkerboard;
0674 
0675 <span class="keyword">end</span>
0676 
0677 <span class="keyword">if</span> ~isempty(strfind(sparam.mode,<span class="string">'cont'</span>))
0678 
0679   tmp_checkerboardID=cell(sparam.ecc_npositions,1);
0680   <span class="keyword">for</span> nn=1:1:sparam.ecc_npositions, tmp_checkerboardID{nn}=ecc_checkerboardID{sparam.ecc_npositions-(nn-1)}; <span class="keyword">end</span>
0681   ecc_checkerboardID=tmp_checkerboardID;
0682   clear tmp_checkerboardID;
0683 
0684   tmp_checkerboard=cell(sparam.ecc_npositions,1);
0685   <span class="keyword">for</span> nn=1:1:sparam.ecc_npositions, tmp_checkerboard{nn}=ecc_checkerboard{sparam.ecc_npositions-(nn-1)}; <span class="keyword">end</span>
0686   ecc_checkerboard=tmp_checkerboard;
0687   clear tmp_checkerboard;
0688 
0689 <span class="keyword">end</span>
0690 
0691 <span class="comment">%%% generate the combined checkerboard patterns</span>
0692 
0693 commduration=lcm(sparam.pol_cycle_duration,sparam.ecc_cycle_duration); <span class="comment">% the least common multiple duration at which the stimulus rotation turns to the beginning.</span>
0694 <span class="keyword">if</span> commduration&lt;sparam.pol_cycle_duration*sparam.pol_numRepeats
0695   pol_subrepeats=ceil(commduration/sparam.pol_cycle_duration);
0696   ecc_subrepeats=ceil(commduration/sparam.ecc_cycle_duration);
0697 <span class="keyword">else</span>
0698   fprintf(<span class="string">'WARNING: It is recommended to adjust the sparam parameters so that lcm(sparam.pol_cycle_duration,sparam.ecc_cycle_duration) is less than sparam.pol_cycle_duration*sparam.pol_numRepeats\n'</span>);
0699   pol_subrepeats=sparam.pol_numRepeats;
0700   ecc_subrepeats=sparam.ecc_numRepeats;
0701 <span class="keyword">end</span>
0702 
0703 <span class="comment">% put the rest period for polar patterns</span>
0704 nrest=sparam.pol_npositions/(sparam.pol_cycle_duration-sparam.pol_rest_duration)*sparam.pol_rest_duration;
0705 <span class="keyword">if</span> nrest&gt;0
0706   <span class="keyword">if</span> ~isempty(strfind(sparam.mode,<span class="string">'ccw'</span>))
0707     pol_checkerboard=[pol_checkerboard;repmat({zeros(size(pol_checkerboard{1}))},nrest,1)];
0708     pol_checkerboardID=[pol_checkerboardID;repmat({zeros(size(pol_checkerboardID{1}))},nrest,1)];
0709   <span class="keyword">else</span> <span class="comment">% if ~isempty(strfind(sparam.mode,'cw'))</span>
0710     pol_checkerboard=[repmat({zeros(size(pol_checkerboard{1}))},nrest,1);pol_checkerboard];
0711     pol_checkerboardID=[repmat({zeros(size(pol_checkerboardID{1}))},nrest,1);pol_checkerboardID];
0712   <span class="keyword">end</span>
0713 <span class="keyword">end</span>
0714 
0715 <span class="comment">% put the rest period for eccentricity patterns</span>
0716 nrest=sparam.ecc_npositions/(sparam.ecc_cycle_duration-sparam.ecc_rest_duration)*sparam.ecc_rest_duration;
0717 <span class="keyword">if</span> nrest&gt;0
0718   <span class="keyword">if</span> ~isempty(strfind(sparam.mode,<span class="string">'cont'</span>))
0719     ecc_checkerboard=[repmat({zeros(size(ecc_checkerboard{1}))},nrest,1);ecc_checkerboard];
0720     ecc_checkerboardID=[repmat({zeros(size(ecc_checkerboardID{1}))},nrest,1);ecc_checkerboardID];
0721   <span class="keyword">else</span> <span class="comment">% if ~isempty(strfind(sparam.mode,'ecc'))</span>
0722     ecc_checkerboard=[ecc_checkerboard;repmat({zeros(size(ecc_checkerboard{1}))},nrest,1)];
0723     ecc_checkerboardID=[ecc_checkerboardID;repmat({zeros(size(ecc_checkerboardID{1}))},nrest,1)];
0724   <span class="keyword">end</span>
0725 <span class="keyword">end</span>
0726 
0727 <span class="comment">% multiply the patterns for the pol_subrepeats</span>
0728 pol_checkerboard=repmat(pol_checkerboard,pol_subrepeats,1);
0729 pol_checkerboardID=repmat(pol_checkerboardID,pol_subrepeats,1);
0730 
0731 <span class="comment">% initialize the final checkerboard by eccentricity patterns</span>
0732 checkerboard=repmat(ecc_checkerboard,ecc_subrepeats,1);
0733 checkerboardID=repmat(ecc_checkerboardID,ecc_subrepeats,1);
0734 
0735 <span class="comment">% get the maximum ID of the ecc_checkerboardID</span>
0736 maxID=1;
0737 <span class="keyword">for</span> nn=1:1:length(ecc_checkerboardID)
0738   <span class="keyword">if</span> maxID&lt;max(ecc_checkerboardID{nn}(:))
0739     maxID=max(ecc_checkerboardID{nn}(:));
0740   <span class="keyword">end</span>
0741 <span class="keyword">end</span>
0742 
0743 <span class="comment">% overwrite the polar patterns</span>
0744 <span class="keyword">for</span> nn=1:1:length(pol_checkerboard)
0745   checkerboard{nn}(pol_checkerboard{nn}~=0)=pol_checkerboard{nn}(pol_checkerboard{nn}~=0);
0746   checkerboardID{nn}(pol_checkerboardID{nn}~=0)=pol_checkerboardID{nn}(pol_checkerboardID{nn}~=0)+maxID; <span class="comment">% +maxID is required to avoid overlapping of the IDs</span>
0747 <span class="keyword">end</span>
0748 clear pol_checkerboard pol_checkerboardID ecc_checkerboard ecc_checkerboardID;
0749 
0750 <span class="comment">% generate the final checkerboard patterns</span>
0751 subrepeats=ceil(sparam.pol_numRepeats/pol_subrepeats);
0752 checkerboard=repmat(checkerboard,[subrepeats,1]);
0753 checkerboardID=repmat(checkerboardID,[subrepeats,1]);
0754 
0755 <span class="comment">% cut the patterns that exceeds the whole stimulus presentation trials</span>
0756 <span class="keyword">if</span> length(checkerboard) &gt; sparam.pol_cycle_duration*sparam.pol_numRepeats/(sparam.pol_cycle_duration/sparam.pol_npositions)
0757   checkerboard=checkerboard(1:sparam.pol_cycle_duration*sparam.pol_numRepeats/(sparam.pol_cycle_duration/sparam.pol_npositions));
0758 <span class="keyword">end</span>
0759 
0760 <span class="comment">%% Make Checkerboard textures</span>
0761 checkertexture=cell(length(checkerboard),1);
0762 <span class="keyword">for</span> nn=1:1:length(checkerboard)
0763   checkertexture{nn}=Screen(<span class="string">'MakeTexture'</span>,winPtr,checkerboard{nn});
0764 <span class="keyword">end</span>
0765 
0766 
0767 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0768 <span class="comment">%%%% Initializing Color Lookup-Table (CLUT)</span>
0769 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0770 
0771 <span class="comment">% [note]</span>
0772 <span class="comment">% all checker color/luminance flickering is realized by just flipping CLUT generated here</span>
0773 <span class="comment">% to save memory and CPU power</span>
0774 
0775 CLUT=cell(sparam.ncolors,2); <span class="comment">% 2 is for compensating patterns</span>
0776 
0777 <span class="comment">% generate base CLUT</span>
0778 <span class="keyword">for</span> cc=1:1:sparam.ncolors
0779   <span class="keyword">for</span> pp=1:1:2 <span class="comment">% compensating checkers</span>
0780 
0781     <span class="comment">% initialize, DrawTextureWithCLUT requires [256x4] color lookup table even when we do not use whole 256 colors</span>
0782     <span class="comment">% though DrawTextureWithCLUT does not support alpha transparency up to now...</span>
0783     CLUT{cc,pp}=zeros(256,4);
0784     CLUT{cc,pp}(:,4)=1; <span class="comment">% default alpha is 1 (no transparent)</span>
0785 
0786     CLUT{cc,pp}(1,:)=[sparam.colors(1,:),0]; <span class="comment">% background LUT, default alpha is 0 (invisible);</span>
0787 
0788     <span class="keyword">if</span> ~mod(pp,2)
0789       CLUT{cc,pp}(2,1:3)=sparam.colors(2*cc,:);
0790       CLUT{cc,pp}(3,1:3)=sparam.colors(2*cc+1,:);
0791     <span class="keyword">else</span>
0792       CLUT{cc,pp}(2,1:3)=sparam.colors(2*cc+1,:);
0793       CLUT{cc,pp}(3,1:3)=sparam.colors(2*cc,:);
0794     <span class="keyword">end</span>
0795 
0796   <span class="keyword">end</span> <span class="comment">% for pp=1:1:2 % compensating checkers</span>
0797 <span class="keyword">end</span> <span class="comment">% for cc=1:1:sparam.ncolors</span>
0798 
0799 
0800 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0801 <span class="comment">%%%% Debug codes</span>
0802 <span class="comment">%%%% saving the stimulus images as *.png format files and enter the debug (keyboard) mode</span>
0803 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0804 
0805 <span class="comment">% %%%%%% DEBUG codes start here</span>
0806 <span class="comment">% note: debug stimuli have no jitters of binocular disparity</span>
0807 <span class="keyword">if</span> strfind(upper(subjID),<span class="string">'DEBUG'</span>)
0808 
0809   <span class="comment">% just to get stimulus figures</span>
0810   Screen(<span class="string">'CloseAll'</span>);
0811   save_dir=fullfile(resultDir,<span class="string">'images_cdual_fixtask'</span>);
0812   <span class="keyword">if</span> ~exist(save_dir,<span class="string">'dir'</span>), mkdir(save_dir); <span class="keyword">end</span>
0813 
0814   figure; hold off;
0815   <span class="keyword">for</span> nn=1:1:length(checkerboard)
0816     imagesc(checkerboard{nn}+1,[1,numel(unique(checkerboard{nn}))]);
0817     axis off; axis equal;
0818 
0819     <span class="keyword">for</span> cc=1:1:sparam.ncolors
0820       <span class="keyword">for</span> pp=1:1:2 <span class="comment">% compensating checkers</span>
0821         colormap(CLUT{cc,pp}(1:3,1:3)./255);
0822         drawnow;
0823         pause(0.05);
0824         imwrite(checkerboard{nn}+1,CLUT{cc,pp}(1:3,1:3)./255,fullfile(save_dir,sprintf(<span class="string">'retinotopy_%s_pos_%02d_lut_%02d_%02d.png'</span>,sparam.mode,nn,cc,pp)),<span class="string">'png'</span>); <span class="comment">% +1 is required as the image index is assumed to be started from 1.</span>
0825       <span class="keyword">end</span>
0826     <span class="keyword">end</span>
0827 
0828   <span class="keyword">end</span>
0829   close all;
0830   save(fullfile(save_dir,sprintf(<span class="string">'stimulus_%s.mat'</span>,sparam.mode)),<span class="string">'checkerboard'</span>,<span class="string">'sparam'</span>,<span class="string">'dparam'</span>,<span class="string">'CLUT'</span>);
0831   keyboard;
0832 
0833 <span class="keyword">end</span> <span class="comment">% if strfind(upper(subjID),'DEBUG')</span>
0834 <span class="comment">% %%%%%% DEBUG code ends here</span>
0835 
0836 
0837 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0838 <span class="comment">%%%% Generating fixation detection task parameters</span>
0839 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0840 
0841 <span class="comment">%% set task variables</span>
0842 <span class="comment">% flag to decide whether presenting fixation task</span>
0843 totalframes=max(sum(nframe_fixation),1)+length(checkerboard)*nframe_stim;
0844 num_tasks=ceil(totalframes/nframe_task);
0845 task_flg=ones(1,num_tasks);
0846 <span class="keyword">for</span> nn=2:1:num_tasks
0847   <span class="keyword">if</span> task_flg(nn-1)==2
0848     task_flg(nn)=1;
0849   <span class="keyword">else</span>
0850     <span class="keyword">if</span> mod(randi(4,1),4)==0 <span class="comment">% this is arbitral, but I put these lines just to reduce the number of tasks</span>
0851       task_flg(nn)=round(rand(1,1))+1;
0852     <span class="keyword">else</span>
0853       task_flg(nn)=1;
0854     <span class="keyword">end</span>
0855   <span class="keyword">end</span>
0856 <span class="keyword">end</span>
0857 task_flg=repmat(task_flg,nframe_task,1);
0858 task_flg=task_flg(:);
0859 
0860 
0861 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0862 <span class="comment">%%%% Initializing checkerboard color management parameters</span>
0863 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0864 
0865 <span class="comment">% checkerboard color id</span>
0866 color_id=1;
0867 
0868 <span class="comment">% checkerboard compensating color id</span>
0869 compensate_id=1;
0870 
0871 
0872 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0873 <span class="comment">%%%% Creating background images</span>
0874 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0875 
0876 <span class="keyword">if</span> sparam.bgtype==1 <span class="comment">% a simple background with sparam.bgcolor</span>
0877   bgimg{1}=repmat(reshape(sparam.colors(1,:),[1,1,3]),[dparam.ScrHeight,dparam.ScrWidth]);
0878 
0879 <span class="keyword">elseif</span> sparam.bgtype==2 <span class="comment">% a background with grid guides</span>
0880 
0881   <span class="comment">% calculate the central aperture size of the background image</span>
0882   edgeY=mod(dparam.ScrHeight,sparam.patch_num(1)); <span class="comment">% delete the exceeded region</span>
0883   p_height=round((dparam.ScrHeight-edgeY)/sparam.patch_num(1)); <span class="comment">% height in pix of patch_height + interval-Y</span>
0884 
0885   edgeX=mod(dparam.ScrWidth,sparam.patch_num(2)); <span class="comment">% delete exceeded region</span>
0886   p_width=round((dparam.ScrWidth-edgeX)/sparam.patch_num(2)); <span class="comment">% width in pix of patch_width + interval-X</span>
0887 
0888   <span class="keyword">if</span> dparam.fullscr
0889     aperture_size=[2*( p_height*ceil( size(checkerboard{1},1)/2*( (winRect(4)-winRect(2))/dparam.ScrHeight ) /p_height ) ),<span class="keyword">...</span>
0890                    2*( p_width*ceil( size(checkerboard{1},2)/2*( (winRect(3)-winRect(1))/dparam.ScrWidth ) /p_width ) )];
0891   <span class="keyword">else</span>
0892     aperture_size=[2*( p_height*ceil(size(checkerboard{1},1)/2/p_height) ),<span class="keyword">...</span>
0893                    2*( p_width*ceil(size(checkerboard{1},2)/2/p_width) )];
0894   <span class="keyword">end</span>
0895 
0896   bgimg=<a href="../../Retinotopy/Common/CreateBackgroundImage.html" class="code" title="function [Bimg,parameters] = CreateBackgroundImage(wdims,stdims,pdims,bgcolor,color1,color2,fixcolor,patchnum,fix_flag,save_flag,show_flag)">CreateBackgroundImage</a>([dparam.ScrHeight,dparam.ScrWidth],aperture_size,sparam.patch_size,sparam.bgcolor,sparam.patch_color1,sparam.patch_color2,sparam.fixcolor,sparam.patch_num,0,0,0);
0897 <span class="keyword">else</span>
0898   error(<span class="string">'sparam.bgtype should be 1 or 2. check the input variable.'</span>);
0899 <span class="keyword">end</span>
0900 
0901 background=Screen(<span class="string">'MakeTexture'</span>,winPtr,bgimg{1});
0902 
0903 
0904 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0905 <span class="comment">%%%% Creating the central fixation, cross images</span>
0906 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0907 
0908 <span class="comment">% Create fixation cross images.</span>
0909 <span class="comment">% Firstly larger fixations are generated, then they are antialiased. This is required to present a beautiful circle</span>
0910 
0911 <span class="keyword">if</span> sparam.fixtype==1 <span class="comment">% circular fixation</span>
0912   fixW=<a href="../../Retinotopy/Common/CreateFixationImgCircular.html" class="code" title="function fix=CreateFixationImgCircular(fixsize,fixcolor,bgcolor,circlesize,show_flag,save_flag)">CreateFixationImgCircular</a>(4*sparam.fixsize,sparam.fixcolor,sparam.bgcolor,4*sparam.fixsize,0,0);
0913   fixD=<a href="../../Retinotopy/Common/CreateFixationImgCircular.html" class="code" title="function fix=CreateFixationImgCircular(fixsize,fixcolor,bgcolor,circlesize,show_flag,save_flag)">CreateFixationImgCircular</a>(4*sparam.fixsize,[64,64,64],sparam.bgcolor,4*sparam.fixsize,0,0);
0914 <span class="keyword">elseif</span> sparam.fixtype==2 <span class="comment">% rectangular fixation</span>
0915   fixW=<a href="../../Retinotopy/Common/CreateFixationImgMono.html" class="code" title="function fix=CreateFixationImgMono(fixsize,fixcolor,bgcolor,fixlinew,fixlineh,show_flag,save_flag)">CreateFixationImgMono</a>(4*sparam.fixsize,sparam.fixcolor,sparam.bgcolor,4*2,4*ceil(0.4*sparam.fixsize),0,0);
0916   fixD=<a href="../../Retinotopy/Common/CreateFixationImgMono.html" class="code" title="function fix=CreateFixationImgMono(fixsize,fixcolor,bgcolor,fixlinew,fixlineh,show_flag,save_flag)">CreateFixationImgMono</a>(4*sparam.fixsize,[64,64,64],sparam.bgcolor,4*2,4*ceil(0.4*sparam.fixsize),0,0);
0917 <span class="keyword">elseif</span> sparam.fixtype==3 <span class="comment">% concentric fixation</span>
0918   fixW=<a href="../../Retinotopy/Common/CreateFixationImgConcentrateMono.html" class="code" title="function fix=CreateFixationImgConcentrateMono(fixsize,fixcolor,bgcolor,circlesize,gap,show_flag,save_flag)">CreateFixationImgConcentrateMono</a>(4*sparam.fixsize,sparam.fixcolor,sparam.bgcolor,4*[2,ceil(0.8*sparam.fixsize)],0,0,0);
0919   fixD=<a href="../../Retinotopy/Common/CreateFixationImgConcentrateMono.html" class="code" title="function fix=CreateFixationImgConcentrateMono(fixsize,fixcolor,bgcolor,circlesize,gap,show_flag,save_flag)">CreateFixationImgConcentrateMono</a>(4*sparam.fixsize,[64,64,64],sparam.bgcolor,4*[2,ceil(0.8*sparam.fixsize)],0,0,0);
0920 <span class="keyword">else</span>
0921   error(<span class="string">'sparam.fixtype should be one of 1,2, and 3. check the input variable.'</span>);
0922 <span class="keyword">end</span>
0923 fixW=imresize(fixW,0.25);
0924 fixD=imresize(fixD,0.25);
0925 
0926 fix=cell(2,1); <span class="comment">% 1 is for default fixation, 2 is for darker fixation (luminance detection task)</span>
0927 fix{1}=Screen(<span class="string">'MakeTexture'</span>,winPtr,fixW);
0928 fix{2}=Screen(<span class="string">'MakeTexture'</span>,winPtr,fixD);
0929 
0930 
0931 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0932 <span class="comment">%%%% Prepare blue lines for stereo image flip sync with VPixx PROPixx</span>
0933 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0934 
0935 <span class="comment">% There seems to be a blueline generation bug on some OpenGL systems.</span>
0936 <span class="comment">% SetStereoBlueLineSyncParameters(winPtr, winRect(4)) corrects the</span>
0937 <span class="comment">% bug on some systems, but breaks on other systems.</span>
0938 <span class="comment">% We'll just disable automatic blueline, and manually draw our own bluelines!</span>
0939 
0940 <span class="keyword">if</span> strcmpi(dparam.ExpMode,<span class="string">'propixxstereo'</span>)
0941   SetStereoBlueLineSyncParameters(winPtr, winRect(4)+10);
0942   blueRectOn(1,:)=[0, winRect(4)-1, winRect(3)/4, winRect(4)];
0943   blueRectOn(2,:)=[0, winRect(4)-1, winRect(3)*3/4, winRect(4)];
0944   blueRectOff(1,:)=[winRect(3)/4, winRect(4)-1, winRect(3), winRect(4)];
0945   blueRectOff(2,:)=[winRect(3)*3/4, winRect(4)-1, winRect(3), winRect(4)];
0946 <span class="keyword">end</span>
0947 
0948 
0949 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0950 <span class="comment">%%%% Image size adjusting to match the current display resolutions</span>
0951 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0952 
0953 <span class="keyword">if</span> dparam.fullscr
0954   ratio_wid= ( winRect(3)-winRect(1) )/dparam.ScrWidth;
0955   ratio_hei= ( winRect(4)-winRect(2) )/dparam.ScrHeight;
0956   bgSize   = [size(bgimg{1},2)*ratio_wid, size(bgimg{1},1)*ratio_hei];
0957   stimSize = [size(checkerboard{1},2)*ratio_wid, size(checkerboard{1},1)*ratio_hei];
0958   fixSize  = [2*sparam.fixsize*ratio_wid, 2*sparam.fixsize*ratio_hei];
0959 <span class="keyword">else</span>
0960   bgSize   = [dparam.ScrWidth, dparam.ScrHeight];
0961   stimSize = [size(checkerboard{1},2), size(checkerboard{1},1)];
0962   fixSize  = [2*sparam.fixsize, 2*sparam.fixsize];
0963 <span class="keyword">end</span>
0964 
0965 <span class="comment">% for some display modes in which one screen is splitted into two binocular displays</span>
0966 <span class="keyword">if</span> strcmpi(dparam.ExpMode,<span class="string">'cross'</span>) || strcmpi(dparam.ExpMode,<span class="string">'parallel'</span>) || <span class="keyword">...</span>
0967    strcmpi(dparam.ExpMode,<span class="string">'topbottom'</span>) || strcmpi(dparam.ExpMode,<span class="string">'bottomtop'</span>)
0968   bgSize=bgSize./2;
0969   stimSize=stimSize./2;
0970   fixSize=fixSize./2;
0971 <span class="keyword">end</span>
0972 
0973 bgRect  = [0, 0, bgSize]; <span class="comment">% used to display background images;</span>
0974 stimRect= [0, 0, stimSize];
0975 fixRect = [0, 0, fixSize]; <span class="comment">% used to display the central fixation point</span>
0976 
0977 
0978 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0979 <span class="comment">%%%% Initialize functions and variables for trial loop</span>
0980 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0981 
0982 <span class="comment">% initialize variables that we will use during the experiment (faster)</span>
0983 cur_frames=0;
0984 
0985 
0986 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0987 <span class="comment">%%%% Displaying 'Ready to Start'</span>
0988 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0989 
0990 <span class="comment">% displaying texts on the center of the screen</span>
0991 <a href="../../Retinotopy/Common/DisplayMessage2.html" class="code" title="function DisplayMessage2(message,bgcolor,winPtr,numScreens,drawing_font,drawing_size)">DisplayMessage2</a>(<span class="string">'Ready to Start'</span>,sparam.bgcolor,winPtr,nScr,<span class="string">'Arial'</span>,36);
0992 ttime=GetSecs(); <span class="keyword">while</span> (GetSecs()-ttime &lt; 0.5), <span class="keyword">end</span>  <span class="comment">% run up the clock.</span>
0993 
0994 
0995 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0996 <span class="comment">%%%% Flip the display(s) to the background image(s)</span>
0997 <span class="comment">%%%% and inform the ready of stimulus presentation</span>
0998 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0999 
1000 <span class="comment">% change the screen and wait for the trigger or pressing the start button</span>
1001 <span class="keyword">for</span> nn=1:1:nScr
1002   Screen(<span class="string">'SelectStereoDrawBuffer'</span>,winPtr,nn-1);
1003   Screen(<span class="string">'DrawTexture'</span>,winPtr,background,[],CenterRect(bgRect,winRect));
1004   Screen(<span class="string">'DrawTexture'</span>,winPtr,fix{2},[],CenterRect(fixRect,winRect));
1005 
1006   <span class="comment">% blue line for stereo sync</span>
1007   <span class="keyword">if</span> strcmpi(dparam.ExpMode,<span class="string">'propixxstereo'</span>)
1008     Screen(<span class="string">'FillRect'</span>,winPtr,[0,0,255],blueRectOn(nn,:));
1009     Screen(<span class="string">'FillRect'</span>,winPtr,[0,0,0],blueRectOff(nn,:));
1010   <span class="keyword">end</span>
1011 <span class="keyword">end</span>
1012 Screen(<span class="string">'DrawingFinished'</span>,winPtr);
1013 Screen(<span class="string">'Flip'</span>, winPtr,[],[],[],1);
1014 
1015 <span class="comment">% prepare the next frame for the initial fixation period</span>
1016 <span class="keyword">for</span> nn=1:1:nScr
1017   Screen(<span class="string">'SelectStereoDrawBuffer'</span>,winPtr,nn-1);
1018   Screen(<span class="string">'DrawTexture'</span>,winPtr,background,[],CenterRect(bgRect,winRect));
1019   Screen(<span class="string">'DrawTexture'</span>,winPtr,fix{1},[],CenterRect(fixRect,winRect)); <span class="comment">% fix{1} is valis as no task in the first period</span>
1020 
1021   <span class="comment">% blue line for stereo sync</span>
1022   <span class="keyword">if</span> strcmpi(dparam.ExpMode,<span class="string">'propixxstereo'</span>)
1023     Screen(<span class="string">'FillRect'</span>,winPtr,[0,0,255],blueRectOn(nn,:));
1024     Screen(<span class="string">'FillRect'</span>,winPtr,[0,0,0],blueRectOff(nn,:));
1025   <span class="keyword">end</span>
1026 <span class="keyword">end</span>
1027 Screen(<span class="string">'DrawingFinished'</span>,winPtr);
1028 
1029 
1030 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
1031 <span class="comment">%%%% Wait for the first trigger pulse from fMRI scanner or start with button pressing</span>
1032 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
1033 
1034 <span class="comment">% add time stamp (this also works to load add_event method in memory in advance of the actual displays)</span>
1035 fprintf(<span class="string">'\nWaiting for the start...\n'</span>);
1036 event=event.add_event(<span class="string">'Experiment Start'</span>,strcat([datestr(now,<span class="string">'yymmdd'</span>),<span class="string">' '</span>,datestr(now,<span class="string">'HH:mm:ss'</span>)]),NaN);
1037 
1038 <span class="comment">% waiting for stimulus presentation</span>
1039 resps.wait_stimulus_presentation(dparam.start_method,dparam.custom_trigger);
1040 <span class="comment">%PlaySound(1);</span>
1041 fprintf(<span class="string">'\nExperiment running...\n'</span>);
1042 
1043 
1044 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
1045 <span class="comment">%%%% Initial Fixation Period</span>
1046 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
1047 
1048 vbl=Screen(<span class="string">'Flip'</span>,winPtr,[],[],[],1); <span class="comment">% the first flip</span>
1049 [event,the_experiment_start]=event.set_reference_time(vbl);
1050 event=event.add_event(<span class="string">'Initial Fixation'</span>,[]);
1051 fprintf(<span class="string">'\nfixation\n\n'</span>);
1052 cur_frames=cur_frames+1;
1053 
1054 <span class="comment">% wait for the initial fixation</span>
1055 <span class="keyword">for</span> ff=1:1:nframe_fixation(1)
1056   <span class="keyword">for</span> nn=1:1:nScr
1057     Screen(<span class="string">'SelectStereoDrawBuffer'</span>,winPtr,nn-1);
1058     Screen(<span class="string">'DrawTexture'</span>,winPtr,background,[],CenterRect(bgRect,winRect));
1059     Screen(<span class="string">'DrawTexture'</span>,winPtr,fix{task_flg(cur_frames)},[],CenterRect(fixRect,winRect));
1060 
1061     <span class="comment">% blue line for stereo sync</span>
1062     <span class="keyword">if</span> strcmpi(dparam.ExpMode,<span class="string">'propixxstereo'</span>)
1063       Screen(<span class="string">'FillRect'</span>,winPtr,[0,0,255],blueRectOn(nn,:));
1064       Screen(<span class="string">'FillRect'</span>,winPtr,[0,0,0],blueRectOff(nn,:));
1065     <span class="keyword">end</span>
1066   <span class="keyword">end</span>
1067   Screen(<span class="string">'DrawingFinished'</span>,winPtr);
1068   <span class="keyword">while</span> GetSecs()&lt;vbl+(ff*sparam.waitframes-0.5)*dparam.ifi, [resps,event]=resps.check_responses(event); <span class="keyword">end</span>
1069   Screen(<span class="string">'Flip'</span>,winPtr,[],[],[],1);
1070 
1071   <span class="comment">% update task</span>
1072   cur_frames=cur_frames+1;
1073   <span class="keyword">if</span> task_flg(cur_frames-1)==2 &amp;&amp; task_flg(cur_frames-2)==1, event=event.add_event(<span class="string">'Luminance Task'</span>,[]); <span class="keyword">end</span>
1074 <span class="keyword">end</span>
1075 
1076 
1077 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
1078 <span class="comment">%%%% The Trial Loop</span>
1079 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
1080 
1081 <span class="keyword">for</span> cc=1:1:length(checkerboard)
1082 
1083   <span class="comment">%% stimulus presentation loop</span>
1084   <span class="keyword">for</span> ff=1:1:nframe_stim
1085 
1086     <span class="comment">%% display the current frame</span>
1087     <span class="keyword">for</span> nn=1:1:nScr
1088       Screen(<span class="string">'SelectStereoDrawBuffer'</span>,winPtr,nn-1);
1089       Screen(<span class="string">'DrawTexture'</span>,winPtr,background,[],CenterRect(bgRect,winRect)); <span class="comment">% background</span>
1090       <a href="../../Retinotopy/Common/DrawTextureWithCLUT.html" class="code" title="function DrawTextureWithCLUT(win, src, newclut, srcRect, destRect, rotangle)">DrawTextureWithCLUT</a>(winPtr,checkertexture{cc},CLUT{color_id,compensate_id},[],CenterRect(stimRect,winRect)); <span class="comment">% checkerboard</span>
1091       Screen(<span class="string">'DrawTexture'</span>,winPtr,fix{task_flg(cur_frames)},[],CenterRect(fixRect,winRect)); <span class="comment">% the central fixation oval</span>
1092 
1093       <span class="comment">% blue line for stereo sync</span>
1094       <span class="keyword">if</span> strcmpi(dparam.ExpMode,<span class="string">'propixxstereo'</span>)
1095         Screen(<span class="string">'FillRect'</span>,winPtr,[0,0,255],blueRectOn(nn,:));
1096         Screen(<span class="string">'FillRect'</span>,winPtr,[0,0,0],blueRectOff(nn,:));
1097       <span class="keyword">end</span>
1098     <span class="keyword">end</span>
1099 
1100     <span class="comment">% flip the window</span>
1101     Screen(<span class="string">'DrawingFinished'</span>,winPtr);
1102     <span class="keyword">while</span> GetSecs()&lt;vbl+sparam.initial_fixation_time(1)+( ((cc-1)*nframe_stim+(ff-1))*sparam.waitframes-0.5 )*dparam.ifi, [resps,event]=resps.check_responses(event); <span class="keyword">end</span>
1103     Screen(<span class="string">'Flip'</span>,winPtr,[],[],[],1);
1104 
1105     <span class="keyword">if</span> ff==1
1106       event=event.add_event(sprintf(<span class="string">'Trial: %d'</span>,cc),[]);
1107       <span class="keyword">if</span> cc==1, fprintf(<span class="string">'Trial: '</span>); <span class="keyword">end</span>
1108       <span class="keyword">if</span> mod(cc,20)~=0 &amp;&amp; cc~=length(checkerboard), fprintf(sprintf(<span class="string">'%03d, '</span>,cc)); <span class="keyword">end</span>
1109       <span class="keyword">if</span> mod(cc,20)==0 || cc==length(checkerboard), fprintf(<span class="string">'%03d\n       '</span>,cc); <span class="keyword">end</span>
1110     <span class="keyword">end</span>
1111 
1112     <span class="comment">% update task</span>
1113     cur_frames=cur_frames+1;
1114     <span class="keyword">if</span> task_flg(cur_frames)==2 &amp;&amp; task_flg(cur_frames-1)==1, event=event.add_event(<span class="string">'Luminance Task'</span>,[]); <span class="keyword">end</span>
1115 
1116     <span class="comment">%% exit from the loop if the final frame is displayed</span>
1117     <span class="keyword">if</span> ff==nframe_stim &amp;&amp; cc==length(checkerboard), <span class="keyword">continue</span>; <span class="keyword">end</span>
1118 
1119     <span class="comment">%% update IDs</span>
1120 
1121     <span class="comment">% flickering checkerboard</span>
1122     <span class="keyword">if</span> ~mod(ff,nframe_flicker) <span class="comment">% color reversal</span>
1123       compensate_id=mod(compensate_id,2)+1;
1124     <span class="keyword">end</span>
1125 
1126     <span class="keyword">if</span> ~mod(ff,2*nframe_flicker) <span class="comment">% color change</span>
1127       color_id=color_id+1;
1128       <span class="keyword">if</span> color_id&gt;sparam.ncolors, color_id=1; <span class="keyword">end</span>
1129     <span class="keyword">end</span>
1130   <span class="keyword">end</span> <span class="comment">% for ff=1:1:nframe_stim</span>
1131 <span class="keyword">end</span> <span class="comment">% for cc=1:1:length(checkerboard)</span>
1132 
1133 
1134 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
1135 <span class="comment">%%%% Final Fixation</span>
1136 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
1137 
1138 <span class="keyword">for</span> nn=1:1:nScr
1139   Screen(<span class="string">'SelectStereoDrawBuffer'</span>,winPtr,nn-1);
1140   Screen(<span class="string">'DrawTexture'</span>,winPtr,background,[],CenterRect(bgRect,winRect));
1141   Screen(<span class="string">'DrawTexture'</span>,winPtr,fix{task_flg(cur_frames)},[],CenterRect(fixRect,winRect));
1142 
1143   <span class="comment">% blue line for stereo sync</span>
1144   <span class="keyword">if</span> strcmpi(dparam.ExpMode,<span class="string">'propixxstereo'</span>)
1145     Screen(<span class="string">'FillRect'</span>,winPtr,[0,0,255],blueRectOn(nn,:));
1146     Screen(<span class="string">'FillRect'</span>,winPtr,[0,0,0],blueRectOff(nn,:));
1147   <span class="keyword">end</span>
1148 <span class="keyword">end</span>
1149 Screen(<span class="string">'DrawingFinished'</span>,winPtr);
1150 <span class="keyword">while</span> GetSecs()&lt;vbl+sparam.initial_fixation_time(1)+sparam.pol_numRepeats*sparam.pol_cycle_duration-0.5*dparam.ifi, [resps,event]=resps.check_responses(event); <span class="keyword">end</span>
1151 Screen(<span class="string">'Flip'</span>,winPtr,[],[],[],1);
1152 <span class="comment">%cur_frames=cur_frames+1;</span>
1153 event=event.add_event(<span class="string">'Final Fixation'</span>,[]);
1154 fprintf(<span class="string">'\nfixation\n'</span>);
1155 
1156 <span class="comment">% wait for the initial fixation</span>
1157 <span class="keyword">for</span> ff=1:1:nframe_fixation(2)
1158   <span class="keyword">for</span> nn=1:1:nScr
1159     Screen(<span class="string">'SelectStereoDrawBuffer'</span>,winPtr,nn-1);
1160     Screen(<span class="string">'DrawTexture'</span>,winPtr,background,[],CenterRect(bgRect,winRect));
1161     Screen(<span class="string">'DrawTexture'</span>,winPtr,fix{task_flg(cur_frames)},[],CenterRect(fixRect,winRect));
1162 
1163     <span class="comment">% blue line for stereo sync</span>
1164     <span class="keyword">if</span> strcmpi(dparam.ExpMode,<span class="string">'propixxstereo'</span>)
1165       Screen(<span class="string">'FillRect'</span>,winPtr,[0,0,255],blueRectOn(nn,:));
1166       Screen(<span class="string">'FillRect'</span>,winPtr,[0,0,0],blueRectOff(nn,:));
1167     <span class="keyword">end</span>
1168   <span class="keyword">end</span>
1169   Screen(<span class="string">'DrawingFinished'</span>,winPtr);
1170   <span class="keyword">while</span> GetSecs()&lt;vbl+sparam.initial_fixation_time(1)+sparam.pol_numRepeats*sparam.pol_cycle_duration+(ff*sparam.waitframes-0.5)*dparam.ifi, [resps,event]=resps.check_responses(event); <span class="keyword">end</span>
1171   Screen(<span class="string">'Flip'</span>,winPtr,[],[],[],1);
1172 
1173   <span class="comment">% update task</span>
1174   cur_frames=cur_frames+1;
1175   <span class="keyword">if</span> task_flg(cur_frames-1)==2 &amp;&amp; task_flg(cur_frames-2)==1, event=event.add_event(<span class="string">'Luminance Task'</span>,[]); <span class="keyword">end</span>
1176 <span class="keyword">end</span>
1177 
1178 <span class="comment">% the final clock up</span>
1179 <span class="keyword">while</span> GetSecs()-the_experiment_start&lt;sum(sparam.initial_fixation_time)+sparam.pol_numRepeats*sparam.pol_cycle_duration
1180   [resps,event]=resps.check_responses(event);
1181 <span class="keyword">end</span>
1182 
1183 
1184 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
1185 <span class="comment">%%%% Experiment &amp; scanner end here</span>
1186 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
1187 
1188 experimentDuration=GetSecs()-the_experiment_start;
1189 event=event.add_event(<span class="string">'End'</span>,[]);
1190 fprintf(<span class="string">'\n'</span>);
1191 fprintf(<span class="string">'Experiment Completed: %.2f/%.2f secs\n'</span>,experimentDuration,<span class="keyword">...</span>
1192         sum(sparam.initial_fixation_time)+sparam.pol_numRepeats*sparam.pol_cycle_duration);
1193 fprintf(<span class="string">'\n'</span>);
1194 
1195 
1196 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
1197 <span class="comment">%%%% Cleaning up MATLAB OpenGL shader API</span>
1198 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
1199 
1200 <span class="comment">% just call DrawTextureWithCLUT without any input argument</span>
1201 <a href="../../Retinotopy/Common/DrawTextureWithCLUT.html" class="code" title="function DrawTextureWithCLUT(win, src, newclut, srcRect, destRect, rotangle)">DrawTextureWithCLUT</a>();
1202 
1203 
1204 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
1205 <span class="comment">%%%% Cleaning up the PTB screen</span>
1206 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
1207 
1208 Screen(<span class="string">'CloseAll'</span>);
1209 
1210 <span class="comment">% closing datapixx</span>
1211 <span class="keyword">if</span> strcmpi(dparam.ExpMode,<span class="string">'propixxmono'</span>) || strcmpi(dparam.ExpMode,<span class="string">'propixxstereo'</span>)
1212   <span class="keyword">if</span> Datapixx(<span class="string">'IsViewpixx3D'</span>)
1213     Datapixx(<span class="string">'DisableVideoLcd3D60Hz'</span>);
1214     Datapixx(<span class="string">'RegWr'</span>);
1215   <span class="keyword">end</span>
1216   Datapixx(<span class="string">'Close'</span>);
1217 <span class="keyword">end</span>
1218 
1219 ShowCursor();
1220 Priority(0);
1221 <a href="../../Retinotopy/Common/GammaResetPTB.html" class="code" title="function GammaResetPTB(luminance_ratio)">GammaResetPTB</a>(1.0);
1222 
1223 
1224 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
1225 <span class="comment">%%%% Write data into file for post analysis</span>
1226 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
1227 
1228 <span class="comment">% saving the results</span>
1229 fprintf(<span class="string">'saving data...'</span>);
1230 
1231 <span class="comment">% save data</span>
1232 savefname=fullfile(resultDir,[num2str(subjID),<span class="string">'_cdual_fixtask_'</span>,sparam.mode,<span class="string">'_results_run_'</span>,num2str(acq,<span class="string">'%02d'</span>),<span class="string">'.mat'</span>]);
1233 
1234 <span class="comment">% backup the old file(s)</span>
1235 <span class="keyword">if</span> ~overwrite_flg
1236   <a href="../../Retinotopy/Common/BackUpObsoleteFiles.html" class="code" title="function [new_fname,backup_fname]=BackUpObsoleteFiles(tgt_dir,tgt_fname,backup_prefix)">BackUpObsoleteFiles</a>(fullfile(<span class="string">'subjects'</span>,num2str(subjID),<span class="string">'results'</span>,today),<span class="keyword">...</span>
1237                       [num2str(subjID),<span class="string">'_cdual_fixtask_'</span>,sparam.mode,<span class="string">'_results_run_'</span>,num2str(acq,<span class="string">'%02d'</span>),<span class="string">'.mat'</span>],<span class="string">'_old'</span>);
1238 <span class="keyword">end</span>
1239 
1240 eval(sprintf(<span class="string">'save %s subjID acq sparam dparam event gamma_table;'</span>,savefname));
1241 fprintf(<span class="string">'done.\n'</span>);
1242 
1243 <span class="comment">% calculate &amp; display task performance</span>
1244 fprintf(<span class="string">'calculating task accuracy...\n'</span>);
1245 correct_event=cell(2,1); <span class="keyword">for</span> ii=1:1:2, correct_event{ii}=sprintf(<span class="string">'key%d'</span>,ii); <span class="keyword">end</span>
1246 [task.numTasks,task.numHits,task.numErrors,task.numResponses,task.RT]=event.calc_accuracy(correct_event);
1247 event=event.get_event(); <span class="comment">% convert an event logger object to a cell data structure</span>
1248 eval(sprintf(<span class="string">'save -append %s event task;'</span>,savefname));
1249 fprintf(<span class="string">'done.\n'</span>);
1250 
1251 
1252 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
1253 <span class="comment">%%%% Removing path to the subfunctions, and finalizing the script</span>
1254 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
1255 
1256 rmpath(genpath(fullfile(rootDir,<span class="string">'..'</span>,<span class="string">'Common'</span>)));
1257 rmpath(fullfile(rootDir,<span class="string">'..'</span>,<span class="string">'Generation'</span>));
1258 clear all; clear mex; clear <span class="keyword">global</span>;
1259 diary off;
1260 
1261 
1262 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
1263 <span class="comment">%%%% tell the experimenter that the measurements are completed</span>
1264 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
1265 
1266 <span class="keyword">try</span>
1267   <span class="keyword">for</span> ii=1:1:3, Snd(<span class="string">'Play'</span>,sin(2*pi*0.2*(0:900)),8000); <span class="keyword">end</span>
1268 <span class="keyword">catch</span>
1269   <span class="comment">% do nothing</span>
1270 <span class="keyword">end</span>
1271 
1272 
1273 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
1274 <span class="comment">%%%% Catch the errors</span>
1275 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
1276 
1277 <span class="keyword">catch</span> lasterror
1278   <span class="comment">% this &quot;catch&quot; section executes in case of an error in the &quot;try&quot; section</span>
1279   <span class="comment">% above.  Importantly, it closes the onscreen window if its open.</span>
1280   Screen(<span class="string">'CloseAll'</span>);
1281 
1282   <span class="keyword">if</span> exist(<span class="string">'dparam'</span>,<span class="string">'var'</span>)
1283     <span class="keyword">if</span> <a href="../../Retinotopy/Common/isstructmember.html" class="code" title="function isFieldResult = isstructmember(inStruct, fieldName)">isstructmember</a>(dparam,<span class="string">'ExpMode'</span>)
1284       <span class="keyword">if</span> strcmpi(dparam.ExpMode,<span class="string">'propixxmono'</span>) || strcmpi(dparam.ExpMode,<span class="string">'propixxstereo'</span>)
1285         <span class="keyword">if</span> Datapixx(<span class="string">'IsViewpixx3D'</span>)
1286           Datapixx(<span class="string">'DisableVideoLcd3D60Hz'</span>);
1287           Datapixx(<span class="string">'RegWr'</span>);
1288         <span class="keyword">end</span>
1289         Datapixx(<span class="string">'Close'</span>);
1290       <span class="keyword">end</span>
1291     <span class="keyword">end</span>
1292   <span class="keyword">end</span>
1293 
1294   ShowCursor();
1295   Priority(0);
1296   <a href="../../Retinotopy/Common/GammaResetPTB.html" class="code" title="function GammaResetPTB(luminance_ratio)">GammaResetPTB</a>(1.0);
1297   tmp=lasterror; <span class="comment">%#ok</span>
1298   <span class="comment">%if exist('event','var'), event=event.get_event(); end %#ok % just for debugging</span>
1299   diary off;
1300   fprintf([<span class="string">'\nError detected and the program was terminated.\n'</span>,<span class="keyword">...</span>
1301            <span class="string">'To check error(s), please type ''tmp''.\n'</span>,<span class="keyword">...</span>
1302            <span class="string">'Please save the current variables now if you need.\n'</span>,<span class="keyword">...</span>
1303            <span class="string">'Then, quit by ''dbquit''\n'</span>]);
1304   keyboard;
1305   rmpath(genpath(fullfile(rootDir,<span class="string">'..'</span>,<span class="string">'Common'</span>)));
1306   rmpath(fullfile(rootDir,<span class="string">'..'</span>,<span class="string">'Generation'</span>));
1307   clear all; clear mex; clear <span class="keyword">global</span>;
1308   <span class="keyword">return</span>
1309 <span class="keyword">end</span> <span class="comment">% try..catch</span>
1310 
1311 
1312 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
1313 <span class="comment">%%%%% That's it - we're done</span>
1314 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
1315 <span class="keyword">return</span>;
1316 <span class="comment">% end % function cdual_fixtask</span></pre></div>
<hr><address>Generated on Tue 03-Aug-2021 14:14:51 by <strong><a href="http://www.artefact.tk/software/matlab/m2html/" target="_parent">m2html</a></strong> &copy; 2005 using a BVQX_hbtools customized template</address>
</body>
</html>