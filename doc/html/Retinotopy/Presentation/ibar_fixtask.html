<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
                "http://www.w3.org/TR/REC-html40/loose.dtd">
<html>
<head>
  <title>Description of ibar_fixtask</title>
  <meta name="keywords" content="ibar_fixtask">
  <meta name="description" content="Object-image-defined bar stimulus with fixation luminance change-detection tasks.">
  <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
  <meta name="generator" content="m2html &copy; 2005 Guillaume Flandin">
  <meta name="robots" content="index, follow">
  <link type="text/css" rel="stylesheet" href="../../m2html.css">
  <script type="text/javascript">
    if (top.frames.length == 0) { top.location = "../../index.html"; };
  </script>
</head>
<body>
<a name="_top"></a>
<!-- # Retinotopy --><!-- menu.html Presentation -->
<h1>ibar_fixtask
</h1>

<h2><a name="_name"></a>PURPOSE <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
<div class="box"><strong>Object-image-defined bar stimulus with fixation luminance change-detection tasks.</strong></div>

<h2><a name="_synopsis"></a>SYNOPSIS <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
<div class="box"><strong>function ibar_fixtask(subjID,exp_mode,acq,displayfile,stimulusfile,gamma_table,overwrite_flg,force_proceed_flag) </strong></div>

<h2><a name="_description"></a>DESCRIPTION <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
<div class="fragment" style="background-image:url(../../hb_brain.png); background-position:right top"><pre class="comment"> Object-image-defined bar stimulus with fixation luminance change-detection tasks.
 function ibar_fixtask(subjID,exp_mode,acq,:displayfile,:stimulusfile,:gamma_table,:overwrite_flg,:force_proceed_flag)
 (: is optional)

 - This function generates and presents the conventional pRF bar stimulus on which
   object images are randomly located with brownian noise images on its background.
   The bar sweeps periodically over the whole visual field.
   The stimulus can be used to measure cortical retinotopy and to delineate retinotopic
   borders using the standard pRF (population receptive field) analysis techniques.

   reference: Population receptive field estimates in human visual cortex.
              Dumoulin, S.O. and Wandell, B.A. (2008). Neuroimage, 39(2), 647-660.

 - This script shoud be used with MATLAB Psychtoolbox version 3 or above.

 - Luminance detection task: the central fixation point (default: white)
   randomly turns to gray. An observer has to press the button if s/he
   detects this luminance change. Response keys are defined in displayfile.

 [about the object images used in this function]
 The object images used in this function (stored in ~/Retinotopy/object_images/ as object_image_database.mat) are
 obtained and modified from the databases publicly available from http://konklab.fas.harvard.edu/#
 I sincerely express my gratitude to the developers, distributors, and scientists in Dr Talia Konkle's research group
 for their contributions to these databases. When you use this function for your research, please cite the original
 papers listed below.

 - Tripartite Organization of the Ventral Stream by Animacy and Object Size.
   Konkle, T., &amp; Caramazza, A. (2013). Journal of Neuroscience, 33 (25), 10235-42.

 - A real-world size organization of object responses in occipito-temporal cortex.
   Konkle. T., &amp; Oliva, A. (2012). Neuron, 74(6), 1114-24.

 - Visual long-term memory has a massive storage capacity for object details.
   Brady, T. F., Konkle, T., Alvarez, G. A. &amp; Oliva, A. (2008). Proceedings of the National Academy of Sciences USA, 105(38), 14325-9.

 - Conceptual distinctiveness supports detailed visual long-term memory.
   Konkle, T., Brady, T. F., Alvarez, G. A., &amp; Oliva, A. (2010). Journal of Experimental Psychology: General, 139(3), 558-578.

 - A Familiar Size Stroop Effect: Real-world size is an automatic property of object representation.
   Konkle, T., &amp; Oliva, A. (2012). Journal of Experimental Psychology: Human Perception &amp; Performance, 38, 561-9.

 [note]
 Behavioral task of (function_name)_fixtask is to detect changes of luminance
 of the central fixation point, while the task in (function_name) is to detect
 changes of luminance of one of the patches in the checkerboard stimuli.
 Here, the central fixation task is more easy to sustain the stable fixation
 on the center of the screen and may be suitable for naive/non-expert
 participants with minimizing unwilling eye movements. However, some studies
 have reported that attention to the target stimulus (checker-patch luminance
 change detection task) is required to get reliable retinotopic representations
 in higher-order visual areas.


 Created    : &quot;2019-03-05 15:54:52 ban&quot;
 Last Update: &quot;2021-06-07 17:18:48 ban&quot;



 [input variables]
 sujID         : ID of subject, string, such as 's01'
                 you also need to create a directory ./subjects/(subj) and put displayfile and stimulusfile there.
                 !!!!!!!!!!!!!!!!!! IMPORTANT NOTE !!!!!!!!!!!!!!!!!!!!!!!!
                 !!! if 'debug' (case insensitive) is included          !!!
                 !!! in subjID string, this program runs as DEBUG mode; !!!
                 !!! stimulus images are saved as *.png format at       !!!
                 !!! ~/Retinotopy/Presentation/images                   !!!
                 !!!!!!!!!!!!!!!!!! IMPORTANT NOTE !!!!!!!!!!!!!!!!!!!!!!!!

 exp_mode      : experiment mode acceptable in this script is only &quot;bar&quot;
 acq           : acquisition number (design file number),
                 an integer, such as 1, 2, 3, ...
 displayfile   : (optional) display condition file,
                 *.m file, such as 'RetDepth_display_fmri.m'
                 the file should be located in ./subjects/(subj)/
 stimulusfile  : (optional) stimulus condition file,
                 *.m file, such as 'RetDepth_stimulus_exp1.m'
                 the file should be located in ./subjects/(subj)/
 gamma_table   : (optional) table(s) of gamma-corrected video input values (Color LookupTable).
                 256(8-bits) x 3(RGB) x 1(or 2,3,... when using multiple displays) matrix
                 or a *.mat file specified with a relative path format. e.g. '/gamma_table/gamma1.mat'
                 The *.mat should include a variable named &quot;gamma_table&quot; consists of a 256x3xN matrix.
                 if you use multiple (more than 1) displays and set a 256x3x1 gamma-table, the same
                 table will be applied to all displays. if the number of displays and gamma tables
                 are different (e.g. you have 3 displays and 256x3x!2! gamma-tables), the last
                 gamma_table will be applied to the second and third displays.
                 if empty, normalized gamma table (repmat(linspace(0.0,1.0,256),3,1)) will be applied.
 overwrite_flg : (optional) whether overwriting pre-existing result file. if 1, the previous result
                 file with the same acquisition number will be overwritten by the previous one.
                 if 0, the existing file will be backed-up by adding a prefix '_old' at the tail
                 of the file. 0 by default.
 force_proceed_flag : (optional) whether proceeding stimulus presentatin without waiting for
                 the experimenter response (e.g. presesing the ENTER key) or a trigger.
                 if 1, the stimulus presentation will be automatically carried on.

 !!! NOTICE !!!!
 displayfile &amp; stimulusfile should be located at
 ./subjects/(subjID)/
 as ./subjects/(subjID)/*_display_fmri.m
    ./subjects/(subjID)/*_stimuli.m


 [output variables]
 no output matlab variable.


 [output files]
 1. result file
    stored ./subjects/(subjID)/results/(date)
    as ./subjects/(subjID)/results/(date)/(subjID)_ibar_fixtask_results_run_(run_num).mat


 [example]
 &gt;&gt; ibar_fixtask('HB','bar',1,'bar_display.m','bar_stimulus.m')

 [About displayfile]
 The contents of the displayfile are as below.
 (The file includs 6 lines of headers and following display parameters)

 (an example of the displayfile)

 % ************************************************************
 % This is the display configuration file for the retinotopy stimuli
 % Programmed by Hiroshi Ban Nov 01 2013
 % ************************************************************

 % display mode, one of &quot;mono&quot;, &quot;dual&quot;, &quot;dualcross&quot;, &quot;dualparallel&quot;, &quot;cross&quot;, &quot;parallel&quot;, &quot;redgreen&quot;, &quot;greenred&quot;,
 % &quot;redblue&quot;, &quot;bluered&quot;, &quot;shutter&quot;, &quot;topbottom&quot;, &quot;bottomtop&quot;, &quot;interleavedline&quot;, &quot;interleavedcolumn&quot;, &quot;propixxmono&quot;, &quot;propixxstereo&quot;
 dparam.ExpMode='mono';

 dparam.scrID=1; % screen ID, generally 0 for a single display setup, 1 for dual display setup

 % a method to start stimulus presentation
 % 0:ENTER/SPACE, 1:Left-mouse button, 2:the first MR trigger pulse (CiNet),
 % 3:waiting for a MR trigger pulse (BUIC) -- checking onset of pin #11 of the parallel port,
 % or 4:custom key trigger (wait for a key input that you specify as tgt_key).
 dparam.start_method=2;

 % a pseudo trigger key from the MR scanner when it starts, valid only when dparam.start_method=4;
 dparam.custom_trigger='t';

 % keyboard settings
 dparam.Key1=51; % key 1 (left)
 dparam.Key2=52; % key 2 (right)

 % screen settings

 %%% whether displaying the stimuli in full-screen mode or
 %%% as is (the precise resolution), 'true' or 'false' (true)
 dparam.fullscr=false;

 %%% the resolution of the screen height
 dparam.ScrHeight=1200;

 %% the resolution of the screen width
 dparam.ScrWidth=1920;

 % whether forcing to use specific frame rate, if 0, the frame rate wil bw computed in the ImagesShowPTB function.
 % if non zero, the value is used as the screen frame rate.
 dparam.force_frame_rate=60;

 % whther skipping the PTB's vertical-sync signal test. if 1, the sync test is skipped
 dparam.skip_sync_test=0;


 [About stimulusfile]
 The contents of the stimulusfile are as below.
 (The file includs 6 lines of headers and following stimulus parameters)

 (an example of the stimulusfile)

 % ************************************************************
 % This is the stimulus parameter file for the pRF bar stimulus
 % Programmed by Hiroshi Ban Nov 20 2018
 % ************************************************************

 % &quot;sparam&quot; means &quot;stimulus generation parameters&quot;

 %%% stimulus parameters
 sparam.fieldSize   = 12; % stimulation field size in deg, [row,col]. circular region with sparam.fieldSize is stimulated.
 sparam.width       = 1.5; % bar width in deg

 % rotation angles in deg, 0 = right horizontal meridian, counter-clockwise.
 % when sparam.rotangles(1)=0, the bar emerges at the right hemifield and sweeps
 % the visual field leftwards.
 %
 % following this parameter, stimulus presentation seuence is defined.
 % for instance, is sparam.rotangles   = [0,45,90,135,180,225,270,315];,
 % the bar sweeps visual field like
 % 1. sparam.rotangles(1)=0   : right to left horizontally, then rest for sparam.rest_duration
 % 2. sparam.rotangles(2)=45  : upper right to lower left at 45 deg direction, then rest for sparam.rest_duration
 % 3. sparam.rotangles(3)=90  : upper to lower vertically, then rest for sparam.rest_duration
 % 4. sparam.rotangles(4)=135 : upper left to lower right at 45 deg direction, then rest for sparam.rest_duration
 % ...
 % ... to sparam.rotangles(end)
 sparam.rotangles   = [0,45,90,135,180,225,270,315];

 sparam.steps       = 16; % steps in sweeping the visual field (from start to end)

 %%% duration in msec for each cycle &amp; repetitions
 sparam.cycle_duration=40000; % msec
 sparam.rest_duration =8000; % msec, rest after each cycle, stimulation = cycle_duration-eccrest
 sparam.numRepeats=1;

 %%% parameters used only for object-image-based retinotopy stimuli
 sparam.flip_duration=250; % msec
 sparam.nimg=120; % number of images to be presented at a frame
 sparam.imRatio=[0.2,0.5]; % image magnification ratio, [min, max] (0.0-1.0), the image sizes are randomly selected whithin this range
 sparam.imdepth=[-12,12]; % disparities (arcmins) added to the images, effective only in a stereo mode (e.g. shutter, dual, parallel etc)

 %%% set number of frames to flip the screen
 % Here, I set the number as large as I can to minimize vertical cynching error.
 % Set 1 if you want to flip the display at each vertical sync, but not recommended as it uses much CPU power
 sparam.waitframes = 6; % #frames for each object-images, 30 = 0.5 sec if the display vsynch = 60 Hz.

 %%% fixation period in msec before/after presenting the target stimuli, integer
 % must set a value more than 1 TR for initializing the frame counting.
 sparam.initial_fixation_time=[4000,4000];

 %%% fixation size &amp; color
 sparam.fixtype=1; % 1: circular, 2: rectangular, 3: concentric fixation point
 sparam.fixsize=4; % radius in pixels
 sparam.fixcolor=[255,255,255];

 %%% background color
 sparam.bgcolor=[128,128,128];

 %%% background-patch colors (RGB)
 sparam.bgtype=1; % 1: a simple background with sparam.bgcolor (then, the parameters belows are not used), 2: a background with grid guides
 sparam.patch_size=[30,30]; % background patch size, [height,width] in pixels
 sparam.patch_num=[20,40];  % the number of background patches along vertical and horizontal axis
 sparam.patch_color1=[255,255,255];
 sparam.patch_color2=[0,0,0];

 %%% for converting degree to pixels
 run(fullfile(fileparts(mfilename('fullpath')),'sizeparams'));
 %sparam.pix_per_cm=57.1429;
 %sparam.vdist=65;
 %sparam.ipd=6.5;


 [HOWTO create stimulus files]
 1. All of the stimuli are created in this script in real-time
    with MATLAB scripts &amp; functions.
    see ../Generation &amp; ../Common directries.
 2. Stimulus parameters are defined in the display &amp; stimulus file.


 [reference]
 for stmulus generation, see ../Generation &amp; ../Common directories.</pre></div>

<!-- crossreference -->
<h2><a name="_cross"></a>CROSS-REFERENCE INFORMATION <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
<div class="fragment" style="background-image:url(../../hb_brain.png); background-position:right top">
This function calls:
<ul style="list-style-image:url(../../matlabicon.gif)">
<li><a href="../../Retinotopy/Common/BackUpObsoleteFiles.html" class="code" title="function [new_fname,backup_fname]=BackUpObsoleteFiles(tgt_dir,tgt_fname,backup_prefix)">BackUpObsoleteFiles</a>	Backups already-existing file(s) in the target directory by adding some file-prefix.</li><li><a href="../../Retinotopy/Common/CalcDistFromDisparity.html" class="code" title="function zdist = CalcDistFromDisparity(ipd,disparity,viewdist)">CalcDistFromDisparity</a>	Calculates the actual distance (cm) from binocular disparity (arcmin).</li><li><a href="../../Retinotopy/Common/CheckPTBversion.html" class="code" title="function [PTB_OK,vertxt] = CheckPTBversion(num_mainver_youwant)">CheckPTBversion</a>	Checks the version of the currently running Psychtoolbox.</li><li><a href="../../Retinotopy/Common/CreateBackgroundImage.html" class="code" title="function [Bimg,parameters] = CreateBackgroundImage(wdims,stdims,pdims,bgcolor,color1,color2,fixcolor,patchnum,fix_flag,save_flag,show_flag)">CreateBackgroundImage</a>	Creates background image that can be used as a background of your stimulus displays.</li><li><a href="../../Retinotopy/Common/CreateColoredNoise.html" class="code" title="function img=CreateColoredNoise(idims,sdims,num,beta,norm_flg,save_flg,show_flg)">CreateColoredNoise</a>	Creates colored (i.e. pink, brown(ian), blue, and white) noise image(s).</li><li><a href="../../Retinotopy/Common/CreateFixationImgCircular.html" class="code" title="function fix=CreateFixationImgCircular(fixsize,fixcolor,bgcolor,circlesize,show_flag,save_flag)">CreateFixationImgCircular</a>	Creates a circular fixation image for a monocular display setting.</li><li><a href="../../Retinotopy/Common/CreateFixationImgConcentrateMono.html" class="code" title="function fix=CreateFixationImgConcentrateMono(fixsize,fixcolor,bgcolor,circlesize,gap,show_flag,save_flag)">CreateFixationImgConcentrateMono</a>	Creates a circular fixation image for a monocular display setting.</li><li><a href="../../Retinotopy/Common/CreateFixationImgMono.html" class="code" title="function fix=CreateFixationImgMono(fixsize,fixcolor,bgcolor,fixlinew,fixlineh,show_flag,save_flag)">CreateFixationImgMono</a>	Creates a cross-shaped fixation image for a monocular display setting.</li><li><a href="../../Retinotopy/Common/DisplayMessage2.html" class="code" title="function DisplayMessage2(message,bgcolor,winPtr,numScreens,drawing_font,drawing_size)">DisplayMessage2</a>	Displays message on the center of each of multiple PTB windows.</li><li><a href="../../Retinotopy/Common/GammaLoadPTB.html" class="code" title="function GammaLoadPTB(gamma_table)">GammaLoadPTB</a>	Loads and sets display gamma-table(s) using PTB Screen() function.</li><li><a href="../../Retinotopy/Common/GammaResetPTB.html" class="code" title="function GammaResetPTB(luminance_ratio)">GammaResetPTB</a>	Resets display gamma with PTB Screen() function.</li><li><a href="../../Retinotopy/Common/InitializePTBDisplays.html" class="code" title="function [winPtr,winRect,nScr,fps,ifi,initDisplay_OK]=InitializePTBDisplays(disp_mode,bgcolor,flipping,rgb_gains,custom_scrIDs)">InitializePTBDisplays</a>	Initializes PTB screen(s) for monocular/binocular presentations using PsychImaging() function.</li><li><a href="../../Retinotopy/Common/InitializeRandomSeed.html" class="code" title="function cseed=InitializeRandomSeed">InitializeRandomSeed</a>	Initializes MATLAB internal state of a random seed.</li><li><a href="../../Retinotopy/Common/ValidateStructureFields.html" class="code" title="function structval=ValidateStructureFields(structval,varargin)">ValidateStructureFields</a>	Validates the input structure and set the default values to the missing field(s)</li><li><a href="../../Retinotopy/Common/eventlogger.html" class="code" title="">eventlogger</a>	</li><li><a href="../../Retinotopy/Common/isstructmember.html" class="code" title="function isFieldResult = isstructmember(inStruct, fieldName)">isstructmember</a>	Checks whether the target struct contains a filed you specified as a member.</li><li><a href="../../Retinotopy/Common/responselogger.html" class="code" title="">responselogger</a>	</li><li><a href="../../Retinotopy/Common/shuffle.html" class="code" title="function [Y,index] = shuffle(X)">shuffle</a>	Randomly sorts the input array.</li><li><a href="../../Retinotopy/Generation/bar_GenerateCheckerBar1D.html" class="code" title="function [checkerboard,bincheckerboard,mask]=bar_GenerateCheckerBar1D(fieldSize,width,angles,steps,pix_per_deg,ndivsL,ndivsS,phase)">bar_GenerateCheckerBar1D</a>	Generates bar-shaped checkerboard patterns masked by a circular aperture (can be used for pRF stimuli) with an individual ID number on each patch.</li></ul>
This function is called by:
<ul style="list-style-image:url(../../matlabicon.gif)">
</ul>
</div>
<!-- crossreference -->



<h2><a name="_source"></a>SOURCE CODE <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
<div class="fragment" style="background-image:url(../../hb_brain.png); background-position:right top"><pre>0001 <a name="_sub0" href="#_subfunctions" class="code">function ibar_fixtask(subjID,exp_mode,acq,displayfile,stimulusfile,gamma_table,overwrite_flg,force_proceed_flag)</a>
0002 
0003 <span class="comment">% Object-image-defined bar stimulus with fixation luminance change-detection tasks.</span>
0004 <span class="comment">% function ibar_fixtask(subjID,exp_mode,acq,:displayfile,:stimulusfile,:gamma_table,:overwrite_flg,:force_proceed_flag)</span>
0005 <span class="comment">% (: is optional)</span>
0006 <span class="comment">%</span>
0007 <span class="comment">% - This function generates and presents the conventional pRF bar stimulus on which</span>
0008 <span class="comment">%   object images are randomly located with brownian noise images on its background.</span>
0009 <span class="comment">%   The bar sweeps periodically over the whole visual field.</span>
0010 <span class="comment">%   The stimulus can be used to measure cortical retinotopy and to delineate retinotopic</span>
0011 <span class="comment">%   borders using the standard pRF (population receptive field) analysis techniques.</span>
0012 <span class="comment">%</span>
0013 <span class="comment">%   reference: Population receptive field estimates in human visual cortex.</span>
0014 <span class="comment">%              Dumoulin, S.O. and Wandell, B.A. (2008). Neuroimage, 39(2), 647-660.</span>
0015 <span class="comment">%</span>
0016 <span class="comment">% - This script shoud be used with MATLAB Psychtoolbox version 3 or above.</span>
0017 <span class="comment">%</span>
0018 <span class="comment">% - Luminance detection task: the central fixation point (default: white)</span>
0019 <span class="comment">%   randomly turns to gray. An observer has to press the button if s/he</span>
0020 <span class="comment">%   detects this luminance change. Response keys are defined in displayfile.</span>
0021 <span class="comment">%</span>
0022 <span class="comment">% [about the object images used in this function]</span>
0023 <span class="comment">% The object images used in this function (stored in ~/Retinotopy/object_images/ as object_image_database.mat) are</span>
0024 <span class="comment">% obtained and modified from the databases publicly available from http://konklab.fas.harvard.edu/#</span>
0025 <span class="comment">% I sincerely express my gratitude to the developers, distributors, and scientists in Dr Talia Konkle's research group</span>
0026 <span class="comment">% for their contributions to these databases. When you use this function for your research, please cite the original</span>
0027 <span class="comment">% papers listed below.</span>
0028 <span class="comment">%</span>
0029 <span class="comment">% - Tripartite Organization of the Ventral Stream by Animacy and Object Size.</span>
0030 <span class="comment">%   Konkle, T., &amp; Caramazza, A. (2013). Journal of Neuroscience, 33 (25), 10235-42.</span>
0031 <span class="comment">%</span>
0032 <span class="comment">% - A real-world size organization of object responses in occipito-temporal cortex.</span>
0033 <span class="comment">%   Konkle. T., &amp; Oliva, A. (2012). Neuron, 74(6), 1114-24.</span>
0034 <span class="comment">%</span>
0035 <span class="comment">% - Visual long-term memory has a massive storage capacity for object details.</span>
0036 <span class="comment">%   Brady, T. F., Konkle, T., Alvarez, G. A. &amp; Oliva, A. (2008). Proceedings of the National Academy of Sciences USA, 105(38), 14325-9.</span>
0037 <span class="comment">%</span>
0038 <span class="comment">% - Conceptual distinctiveness supports detailed visual long-term memory.</span>
0039 <span class="comment">%   Konkle, T., Brady, T. F., Alvarez, G. A., &amp; Oliva, A. (2010). Journal of Experimental Psychology: General, 139(3), 558-578.</span>
0040 <span class="comment">%</span>
0041 <span class="comment">% - A Familiar Size Stroop Effect: Real-world size is an automatic property of object representation.</span>
0042 <span class="comment">%   Konkle, T., &amp; Oliva, A. (2012). Journal of Experimental Psychology: Human Perception &amp; Performance, 38, 561-9.</span>
0043 <span class="comment">%</span>
0044 <span class="comment">% [note]</span>
0045 <span class="comment">% Behavioral task of (function_name)_fixtask is to detect changes of luminance</span>
0046 <span class="comment">% of the central fixation point, while the task in (function_name) is to detect</span>
0047 <span class="comment">% changes of luminance of one of the patches in the checkerboard stimuli.</span>
0048 <span class="comment">% Here, the central fixation task is more easy to sustain the stable fixation</span>
0049 <span class="comment">% on the center of the screen and may be suitable for naive/non-expert</span>
0050 <span class="comment">% participants with minimizing unwilling eye movements. However, some studies</span>
0051 <span class="comment">% have reported that attention to the target stimulus (checker-patch luminance</span>
0052 <span class="comment">% change detection task) is required to get reliable retinotopic representations</span>
0053 <span class="comment">% in higher-order visual areas.</span>
0054 <span class="comment">%</span>
0055 <span class="comment">%</span>
0056 <span class="comment">% Created    : &quot;2019-03-05 15:54:52 ban&quot;</span>
0057 <span class="comment">% Last Update: &quot;2021-06-07 17:18:48 ban&quot;</span>
0058 <span class="comment">%</span>
0059 <span class="comment">%</span>
0060 <span class="comment">%</span>
0061 <span class="comment">% [input variables]</span>
0062 <span class="comment">% sujID         : ID of subject, string, such as 's01'</span>
0063 <span class="comment">%                 you also need to create a directory ./subjects/(subj) and put displayfile and stimulusfile there.</span>
0064 <span class="comment">%                 !!!!!!!!!!!!!!!!!! IMPORTANT NOTE !!!!!!!!!!!!!!!!!!!!!!!!</span>
0065 <span class="comment">%                 !!! if 'debug' (case insensitive) is included          !!!</span>
0066 <span class="comment">%                 !!! in subjID string, this program runs as DEBUG mode; !!!</span>
0067 <span class="comment">%                 !!! stimulus images are saved as *.png format at       !!!</span>
0068 <span class="comment">%                 !!! ~/Retinotopy/Presentation/images                   !!!</span>
0069 <span class="comment">%                 !!!!!!!!!!!!!!!!!! IMPORTANT NOTE !!!!!!!!!!!!!!!!!!!!!!!!</span>
0070 <span class="comment">%</span>
0071 <span class="comment">% exp_mode      : experiment mode acceptable in this script is only &quot;bar&quot;</span>
0072 <span class="comment">% acq           : acquisition number (design file number),</span>
0073 <span class="comment">%                 an integer, such as 1, 2, 3, ...</span>
0074 <span class="comment">% displayfile   : (optional) display condition file,</span>
0075 <span class="comment">%                 *.m file, such as 'RetDepth_display_fmri.m'</span>
0076 <span class="comment">%                 the file should be located in ./subjects/(subj)/</span>
0077 <span class="comment">% stimulusfile  : (optional) stimulus condition file,</span>
0078 <span class="comment">%                 *.m file, such as 'RetDepth_stimulus_exp1.m'</span>
0079 <span class="comment">%                 the file should be located in ./subjects/(subj)/</span>
0080 <span class="comment">% gamma_table   : (optional) table(s) of gamma-corrected video input values (Color LookupTable).</span>
0081 <span class="comment">%                 256(8-bits) x 3(RGB) x 1(or 2,3,... when using multiple displays) matrix</span>
0082 <span class="comment">%                 or a *.mat file specified with a relative path format. e.g. '/gamma_table/gamma1.mat'</span>
0083 <span class="comment">%                 The *.mat should include a variable named &quot;gamma_table&quot; consists of a 256x3xN matrix.</span>
0084 <span class="comment">%                 if you use multiple (more than 1) displays and set a 256x3x1 gamma-table, the same</span>
0085 <span class="comment">%                 table will be applied to all displays. if the number of displays and gamma tables</span>
0086 <span class="comment">%                 are different (e.g. you have 3 displays and 256x3x!2! gamma-tables), the last</span>
0087 <span class="comment">%                 gamma_table will be applied to the second and third displays.</span>
0088 <span class="comment">%                 if empty, normalized gamma table (repmat(linspace(0.0,1.0,256),3,1)) will be applied.</span>
0089 <span class="comment">% overwrite_flg : (optional) whether overwriting pre-existing result file. if 1, the previous result</span>
0090 <span class="comment">%                 file with the same acquisition number will be overwritten by the previous one.</span>
0091 <span class="comment">%                 if 0, the existing file will be backed-up by adding a prefix '_old' at the tail</span>
0092 <span class="comment">%                 of the file. 0 by default.</span>
0093 <span class="comment">% force_proceed_flag : (optional) whether proceeding stimulus presentatin without waiting for</span>
0094 <span class="comment">%                 the experimenter response (e.g. presesing the ENTER key) or a trigger.</span>
0095 <span class="comment">%                 if 1, the stimulus presentation will be automatically carried on.</span>
0096 <span class="comment">%</span>
0097 <span class="comment">% !!! NOTICE !!!!</span>
0098 <span class="comment">% displayfile &amp; stimulusfile should be located at</span>
0099 <span class="comment">% ./subjects/(subjID)/</span>
0100 <span class="comment">% as ./subjects/(subjID)/*_display_fmri.m</span>
0101 <span class="comment">%    ./subjects/(subjID)/*_stimuli.m</span>
0102 <span class="comment">%</span>
0103 <span class="comment">%</span>
0104 <span class="comment">% [output variables]</span>
0105 <span class="comment">% no output matlab variable.</span>
0106 <span class="comment">%</span>
0107 <span class="comment">%</span>
0108 <span class="comment">% [output files]</span>
0109 <span class="comment">% 1. result file</span>
0110 <span class="comment">%    stored ./subjects/(subjID)/results/(date)</span>
0111 <span class="comment">%    as ./subjects/(subjID)/results/(date)/(subjID)_ibar_fixtask_results_run_(run_num).mat</span>
0112 <span class="comment">%</span>
0113 <span class="comment">%</span>
0114 <span class="comment">% [example]</span>
0115 <span class="comment">% &gt;&gt; ibar_fixtask('HB','bar',1,'bar_display.m','bar_stimulus.m')</span>
0116 <span class="comment">%</span>
0117 <span class="comment">% [About displayfile]</span>
0118 <span class="comment">% The contents of the displayfile are as below.</span>
0119 <span class="comment">% (The file includs 6 lines of headers and following display parameters)</span>
0120 <span class="comment">%</span>
0121 <span class="comment">% (an example of the displayfile)</span>
0122 <span class="comment">%</span>
0123 <span class="comment">% % ************************************************************</span>
0124 <span class="comment">% % This is the display configuration file for the retinotopy stimuli</span>
0125 <span class="comment">% % Programmed by Hiroshi Ban Nov 01 2013</span>
0126 <span class="comment">% % ************************************************************</span>
0127 <span class="comment">%</span>
0128 <span class="comment">% % display mode, one of &quot;mono&quot;, &quot;dual&quot;, &quot;dualcross&quot;, &quot;dualparallel&quot;, &quot;cross&quot;, &quot;parallel&quot;, &quot;redgreen&quot;, &quot;greenred&quot;,</span>
0129 <span class="comment">% % &quot;redblue&quot;, &quot;bluered&quot;, &quot;shutter&quot;, &quot;topbottom&quot;, &quot;bottomtop&quot;, &quot;interleavedline&quot;, &quot;interleavedcolumn&quot;, &quot;propixxmono&quot;, &quot;propixxstereo&quot;</span>
0130 <span class="comment">% dparam.ExpMode='mono';</span>
0131 <span class="comment">%</span>
0132 <span class="comment">% dparam.scrID=1; % screen ID, generally 0 for a single display setup, 1 for dual display setup</span>
0133 <span class="comment">%</span>
0134 <span class="comment">% % a method to start stimulus presentation</span>
0135 <span class="comment">% % 0:ENTER/SPACE, 1:Left-mouse button, 2:the first MR trigger pulse (CiNet),</span>
0136 <span class="comment">% % 3:waiting for a MR trigger pulse (BUIC) -- checking onset of pin #11 of the parallel port,</span>
0137 <span class="comment">% % or 4:custom key trigger (wait for a key input that you specify as tgt_key).</span>
0138 <span class="comment">% dparam.start_method=2;</span>
0139 <span class="comment">%</span>
0140 <span class="comment">% % a pseudo trigger key from the MR scanner when it starts, valid only when dparam.start_method=4;</span>
0141 <span class="comment">% dparam.custom_trigger='t';</span>
0142 <span class="comment">%</span>
0143 <span class="comment">% % keyboard settings</span>
0144 <span class="comment">% dparam.Key1=51; % key 1 (left)</span>
0145 <span class="comment">% dparam.Key2=52; % key 2 (right)</span>
0146 <span class="comment">%</span>
0147 <span class="comment">% % screen settings</span>
0148 <span class="comment">%</span>
0149 <span class="comment">% %%% whether displaying the stimuli in full-screen mode or</span>
0150 <span class="comment">% %%% as is (the precise resolution), 'true' or 'false' (true)</span>
0151 <span class="comment">% dparam.fullscr=false;</span>
0152 <span class="comment">%</span>
0153 <span class="comment">% %%% the resolution of the screen height</span>
0154 <span class="comment">% dparam.ScrHeight=1200;</span>
0155 <span class="comment">%</span>
0156 <span class="comment">% %% the resolution of the screen width</span>
0157 <span class="comment">% dparam.ScrWidth=1920;</span>
0158 <span class="comment">%</span>
0159 <span class="comment">% % whether forcing to use specific frame rate, if 0, the frame rate wil bw computed in the ImagesShowPTB function.</span>
0160 <span class="comment">% % if non zero, the value is used as the screen frame rate.</span>
0161 <span class="comment">% dparam.force_frame_rate=60;</span>
0162 <span class="comment">%</span>
0163 <span class="comment">% % whther skipping the PTB's vertical-sync signal test. if 1, the sync test is skipped</span>
0164 <span class="comment">% dparam.skip_sync_test=0;</span>
0165 <span class="comment">%</span>
0166 <span class="comment">%</span>
0167 <span class="comment">% [About stimulusfile]</span>
0168 <span class="comment">% The contents of the stimulusfile are as below.</span>
0169 <span class="comment">% (The file includs 6 lines of headers and following stimulus parameters)</span>
0170 <span class="comment">%</span>
0171 <span class="comment">% (an example of the stimulusfile)</span>
0172 <span class="comment">%</span>
0173 <span class="comment">% % ************************************************************</span>
0174 <span class="comment">% % This is the stimulus parameter file for the pRF bar stimulus</span>
0175 <span class="comment">% % Programmed by Hiroshi Ban Nov 20 2018</span>
0176 <span class="comment">% % ************************************************************</span>
0177 <span class="comment">%</span>
0178 <span class="comment">% % &quot;sparam&quot; means &quot;stimulus generation parameters&quot;</span>
0179 <span class="comment">%</span>
0180 <span class="comment">% %%% stimulus parameters</span>
0181 <span class="comment">% sparam.fieldSize   = 12; % stimulation field size in deg, [row,col]. circular region with sparam.fieldSize is stimulated.</span>
0182 <span class="comment">% sparam.width       = 1.5; % bar width in deg</span>
0183 <span class="comment">%</span>
0184 <span class="comment">% % rotation angles in deg, 0 = right horizontal meridian, counter-clockwise.</span>
0185 <span class="comment">% % when sparam.rotangles(1)=0, the bar emerges at the right hemifield and sweeps</span>
0186 <span class="comment">% % the visual field leftwards.</span>
0187 <span class="comment">% %</span>
0188 <span class="comment">% % following this parameter, stimulus presentation seuence is defined.</span>
0189 <span class="comment">% % for instance, is sparam.rotangles   = [0,45,90,135,180,225,270,315];,</span>
0190 <span class="comment">% % the bar sweeps visual field like</span>
0191 <span class="comment">% % 1. sparam.rotangles(1)=0   : right to left horizontally, then rest for sparam.rest_duration</span>
0192 <span class="comment">% % 2. sparam.rotangles(2)=45  : upper right to lower left at 45 deg direction, then rest for sparam.rest_duration</span>
0193 <span class="comment">% % 3. sparam.rotangles(3)=90  : upper to lower vertically, then rest for sparam.rest_duration</span>
0194 <span class="comment">% % 4. sparam.rotangles(4)=135 : upper left to lower right at 45 deg direction, then rest for sparam.rest_duration</span>
0195 <span class="comment">% % ...</span>
0196 <span class="comment">% % ... to sparam.rotangles(end)</span>
0197 <span class="comment">% sparam.rotangles   = [0,45,90,135,180,225,270,315];</span>
0198 <span class="comment">%</span>
0199 <span class="comment">% sparam.steps       = 16; % steps in sweeping the visual field (from start to end)</span>
0200 <span class="comment">%</span>
0201 <span class="comment">% %%% duration in msec for each cycle &amp; repetitions</span>
0202 <span class="comment">% sparam.cycle_duration=40000; % msec</span>
0203 <span class="comment">% sparam.rest_duration =8000; % msec, rest after each cycle, stimulation = cycle_duration-eccrest</span>
0204 <span class="comment">% sparam.numRepeats=1;</span>
0205 <span class="comment">%</span>
0206 <span class="comment">% %%% parameters used only for object-image-based retinotopy stimuli</span>
0207 <span class="comment">% sparam.flip_duration=250; % msec</span>
0208 <span class="comment">% sparam.nimg=120; % number of images to be presented at a frame</span>
0209 <span class="comment">% sparam.imRatio=[0.2,0.5]; % image magnification ratio, [min, max] (0.0-1.0), the image sizes are randomly selected whithin this range</span>
0210 <span class="comment">% sparam.imdepth=[-12,12]; % disparities (arcmins) added to the images, effective only in a stereo mode (e.g. shutter, dual, parallel etc)</span>
0211 <span class="comment">%</span>
0212 <span class="comment">% %%% set number of frames to flip the screen</span>
0213 <span class="comment">% % Here, I set the number as large as I can to minimize vertical cynching error.</span>
0214 <span class="comment">% % Set 1 if you want to flip the display at each vertical sync, but not recommended as it uses much CPU power</span>
0215 <span class="comment">% sparam.waitframes = 6; % #frames for each object-images, 30 = 0.5 sec if the display vsynch = 60 Hz.</span>
0216 <span class="comment">%</span>
0217 <span class="comment">% %%% fixation period in msec before/after presenting the target stimuli, integer</span>
0218 <span class="comment">% % must set a value more than 1 TR for initializing the frame counting.</span>
0219 <span class="comment">% sparam.initial_fixation_time=[4000,4000];</span>
0220 <span class="comment">%</span>
0221 <span class="comment">% %%% fixation size &amp; color</span>
0222 <span class="comment">% sparam.fixtype=1; % 1: circular, 2: rectangular, 3: concentric fixation point</span>
0223 <span class="comment">% sparam.fixsize=4; % radius in pixels</span>
0224 <span class="comment">% sparam.fixcolor=[255,255,255];</span>
0225 <span class="comment">%</span>
0226 <span class="comment">% %%% background color</span>
0227 <span class="comment">% sparam.bgcolor=[128,128,128];</span>
0228 <span class="comment">%</span>
0229 <span class="comment">% %%% background-patch colors (RGB)</span>
0230 <span class="comment">% sparam.bgtype=1; % 1: a simple background with sparam.bgcolor (then, the parameters belows are not used), 2: a background with grid guides</span>
0231 <span class="comment">% sparam.patch_size=[30,30]; % background patch size, [height,width] in pixels</span>
0232 <span class="comment">% sparam.patch_num=[20,40];  % the number of background patches along vertical and horizontal axis</span>
0233 <span class="comment">% sparam.patch_color1=[255,255,255];</span>
0234 <span class="comment">% sparam.patch_color2=[0,0,0];</span>
0235 <span class="comment">%</span>
0236 <span class="comment">% %%% for converting degree to pixels</span>
0237 <span class="comment">% run(fullfile(fileparts(mfilename('fullpath')),'sizeparams'));</span>
0238 <span class="comment">% %sparam.pix_per_cm=57.1429;</span>
0239 <span class="comment">% %sparam.vdist=65;</span>
0240 <span class="comment">% %sparam.ipd=6.5;</span>
0241 <span class="comment">%</span>
0242 <span class="comment">%</span>
0243 <span class="comment">% [HOWTO create stimulus files]</span>
0244 <span class="comment">% 1. All of the stimuli are created in this script in real-time</span>
0245 <span class="comment">%    with MATLAB scripts &amp; functions.</span>
0246 <span class="comment">%    see ../Generation &amp; ../Common directries.</span>
0247 <span class="comment">% 2. Stimulus parameters are defined in the display &amp; stimulus file.</span>
0248 <span class="comment">%</span>
0249 <span class="comment">%</span>
0250 <span class="comment">% [reference]</span>
0251 <span class="comment">% for stmulus generation, see ../Generation &amp; ../Common directories.</span>
0252 
0253 
0254 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0255 <span class="comment">%%%% Check the input variables</span>
0256 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0257 
0258 clear <span class="keyword">global</span>; clear mex;
0259 <span class="keyword">if</span> nargin&lt;3, help(mfilename()); <span class="keyword">return</span>; <span class="keyword">end</span>
0260 <span class="keyword">if</span> nargin&lt;4 || isempty(displayfile), displayfile=[]; <span class="keyword">end</span>
0261 <span class="keyword">if</span> nargin&lt;5 || isempty(stimulusfile), stimulusfile=[]; <span class="keyword">end</span>
0262 <span class="keyword">if</span> nargin&lt;6 || isempty(gamma_table), gamma_table=[]; <span class="keyword">end</span>
0263 <span class="keyword">if</span> nargin&lt;7 || isempty(overwrite_flg), overwrite_flg=1; <span class="keyword">end</span>
0264 <span class="keyword">if</span> nargin&lt;8 || isempty(force_proceed_flag), force_proceed_flag=0; <span class="keyword">end</span>
0265 
0266 <span class="comment">% check the aqcuisition number</span>
0267 <span class="keyword">if</span> acq&lt;1, error(<span class="string">'Acquistion number must be integer and greater than zero'</span>); <span class="keyword">end</span>
0268 
0269 <span class="comment">% check the experiment mode (stimulus type)</span>
0270 <span class="keyword">if</span> ~strcmpi(exp_mode,<span class="string">'bar'</span>), error(<span class="string">'exp_mode acceptable in this script is only &quot;bar&quot;. check the input variable.'</span>); <span class="keyword">end</span>
0271 
0272 rootDir=fileparts(mfilename(<span class="string">'fullpath'</span>));
0273 
0274 <span class="comment">% check the subject directory</span>
0275 <span class="keyword">if</span> ~exist(fullfile(rootDir,<span class="string">'subjects'</span>,subjID),<span class="string">'dir'</span>), error(<span class="string">'can not find subj directory. check the input variable.'</span>); <span class="keyword">end</span>
0276 
0277 <span class="comment">% check the display/stimulus files</span>
0278 <span class="keyword">if</span> ~isempty(displayfile)
0279   <span class="keyword">if</span> ~strcmpi(displayfile(end-1:end),<span class="string">'.m'</span>), displayfile=[displayfile,<span class="string">'.m'</span>]; <span class="keyword">end</span>
0280   <span class="keyword">if</span> ~exist(fullfile(rootDir,<span class="string">'subjects'</span>,subjID,displayfile),<span class="string">'file'</span>), error(<span class="string">'displayfile not found. check the input variable.'</span>); <span class="keyword">end</span>
0281 <span class="keyword">end</span>
0282 
0283 <span class="keyword">if</span> ~isempty(stimulusfile)
0284   <span class="keyword">if</span> ~strcmpi(stimulusfile(end-1:end),<span class="string">'.m'</span>), stimulusfile=[stimulusfile,<span class="string">'.m'</span>]; <span class="keyword">end</span>
0285   <span class="keyword">if</span> ~exist(fullfile(rootDir,<span class="string">'subjects'</span>,subjID,stimulusfile),<span class="string">'file'</span>), error(<span class="string">'stimulusfile not found. check the input variable.'</span>); <span class="keyword">end</span>
0286 <span class="keyword">end</span>
0287 
0288 
0289 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0290 <span class="comment">%%%% Add path to the subfunctions</span>
0291 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0292 
0293 <span class="comment">% add paths to the subfunctions</span>
0294 addpath(genpath(fullfile(rootDir,<span class="string">'..'</span>,<span class="string">'Common'</span>)));
0295 addpath(fullfile(rootDir,<span class="string">'..'</span>,<span class="string">'Generation'</span>));
0296 
0297 
0298 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0299 <span class="comment">%%%% For log file</span>
0300 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0301 
0302 <span class="comment">% get date</span>
0303 today=datestr(now,<span class="string">'yymmdd'</span>);
0304 
0305 <span class="comment">% result directry &amp; file</span>
0306 resultDir=fullfile(rootDir,<span class="string">'subjects'</span>,num2str(subjID),<span class="string">'results'</span>,today);
0307 <span class="keyword">if</span> ~exist(resultDir,<span class="string">'dir'</span>), mkdir(resultDir); <span class="keyword">end</span>
0308 
0309 <span class="comment">% record the output window</span>
0310 logfname=fullfile(resultDir,[num2str(subjID),<span class="string">'_ibar_fixtask_results_run_'</span>,num2str(acq,<span class="string">'%02d'</span>),<span class="string">'.log'</span>]);
0311 diary(logfname);
0312 warning off; <span class="comment">%#ok warning('off','MATLAB:dispatcher:InexactCaseMatch');</span>
0313 
0314 
0315 <span class="comment">%%%%% try &amp; catch %%%%%</span>
0316 <span class="keyword">try</span>
0317 
0318 
0319 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0320 <span class="comment">%%%% Check the PTB version</span>
0321 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0322 
0323 PTB_OK=<a href="../../Retinotopy/Common/CheckPTBversion.html" class="code" title="function [PTB_OK,vertxt] = CheckPTBversion(num_mainver_youwant)">CheckPTBversion</a>(3); <span class="comment">% check wether the PTB version is 3</span>
0324 <span class="keyword">if</span> ~PTB_OK, error(<span class="string">'Wrong version of Psychtoolbox is running. %s requires PTB ver.3'</span>,mfilename()); <span class="keyword">end</span>
0325 
0326 <span class="comment">% debug level, black screen during calibration</span>
0327 Screen(<span class="string">'Preference'</span>, <span class="string">'VisualDebuglevel'</span>, 3);
0328 
0329 
0330 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0331 <span class="comment">%%%% Setup random seed</span>
0332 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0333 
0334 <a href="../../Retinotopy/Common/InitializeRandomSeed.html" class="code" title="function cseed=InitializeRandomSeed">InitializeRandomSeed</a>();
0335 
0336 
0337 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0338 <span class="comment">%%%% Reset display Gamma-function</span>
0339 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0340 
0341 <span class="keyword">if</span> isempty(gamma_table)
0342   gamma_table=repmat(linspace(0.0,1.0,256),3,1); <span class="comment">%#ok</span>
0343   <a href="../../Retinotopy/Common/GammaResetPTB.html" class="code" title="function GammaResetPTB(luminance_ratio)">GammaResetPTB</a>(1.0);
0344 <span class="keyword">else</span>
0345   <a href="../../Retinotopy/Common/GammaLoadPTB.html" class="code" title="function GammaLoadPTB(gamma_table)">GammaLoadPTB</a>(gamma_table);
0346 <span class="keyword">end</span>
0347 
0348 
0349 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0350 <span class="comment">%%%% Validate dparam (displayfile) and sparam (stimulusfile) structures</span>
0351 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0352 
0353 <span class="comment">% organize dparam</span>
0354 dparam=struct(); <span class="comment">% initialize</span>
0355 <span class="keyword">if</span> ~isempty(displayfile), run(fullfile(rootDir,<span class="string">'subjects'</span>,subjID,displayfile)); <span class="keyword">end</span> <span class="comment">% load specific dparam parameters configured for each of the participants</span>
0356 dparam=<a href="../../Retinotopy/Common/ValidateStructureFields.html" class="code" title="function structval=ValidateStructureFields(structval,varargin)">ValidateStructureFields</a>(dparam,<span class="keyword">...</span><span class="comment"> % validate fields and set the default values to missing field(s)</span>
0357          <span class="string">'ExpMode'</span>,<span class="string">'mono'</span>,<span class="keyword">...</span>
0358          <span class="string">'scrID'</span>,1,<span class="keyword">...</span>
0359          <span class="string">'start_method'</span>,0,<span class="keyword">...</span>
0360          <span class="string">'custom_trigger'</span>,<span class="string">'t'</span>,<span class="keyword">...</span>
0361          <span class="string">'Key1'</span>,51,<span class="keyword">...</span>
0362          <span class="string">'Key2'</span>,52,<span class="keyword">...</span>
0363          <span class="string">'fullscr'</span>,false,<span class="keyword">...</span>
0364          <span class="string">'ScrHeight'</span>,1200,<span class="keyword">...</span>
0365          <span class="string">'ScrWidth'</span>,1920,<span class="keyword">...</span>
0366          <span class="string">'force_frame_rate'</span>,60,<span class="keyword">...</span>
0367          <span class="string">'skip_sync_test'</span>,0);
0368 
0369 <span class="comment">% organize sparam</span>
0370 sparam=struct(); <span class="comment">% initialize</span>
0371 sparam.mode=exp_mode;
0372 <span class="keyword">if</span> ~isempty(stimulusfile), run(fullfile(rootDir,<span class="string">'subjects'</span>,subjID,stimulusfile)); <span class="keyword">end</span> <span class="comment">% load specific sparam parameters configured for each of the participants</span>
0373 sparam=<a href="../../Retinotopy/Common/ValidateStructureFields.html" class="code" title="function structval=ValidateStructureFields(structval,varargin)">ValidateStructureFields</a>(sparam,<span class="keyword">...</span><span class="comment"> % validate fields and set the default values to missing field(s)</span>
0374          <span class="string">'fieldSize'</span>,[12,12],<span class="keyword">...</span>
0375          <span class="string">'width'</span>,1.5,<span class="keyword">...</span>
0376          <span class="string">'rotangles'</span>,[0,45,90,135,180,225,270,315],<span class="keyword">...</span>
0377          <span class="string">'steps'</span>,16,<span class="keyword">...</span>
0378          <span class="string">'cycle_duration'</span>,40000,<span class="keyword">...</span>
0379          <span class="string">'rest_duration'</span>,8000,<span class="keyword">...</span>
0380          <span class="string">'numRepeats'</span>,1,<span class="keyword">...</span>
0381          <span class="string">'flip_duration'</span>,250,<span class="keyword">...</span>
0382          <span class="string">'nimg'</span>,120,<span class="keyword">...</span>
0383          <span class="string">'imRatio'</span>,[0.2,0.5],<span class="keyword">...</span>
0384          <span class="string">'imdepth'</span>,[-12,12],<span class="keyword">...</span><span class="comment"> % effective only when the stimuli are presented in stereo mode (e.g. dual, cross, parallel etc)</span>
0385          <span class="string">'waitframes'</span>,6,<span class="keyword">...</span><span class="comment"> % Screen('FrameRate',0)*(sparam.cycle_duration/1000) / (360/sparam.rotangle) / ( (size(sparam.colors,1)-1)*2 );</span>
0386          <span class="string">'initial_fixation_time'</span>,[4000,4000],<span class="keyword">...</span>
0387          <span class="string">'fixtype'</span>,1,<span class="keyword">...</span>
0388          <span class="string">'fixsize'</span>,4,<span class="keyword">...</span>
0389          <span class="string">'fixcolor'</span>,[255,255,255],<span class="keyword">...</span>
0390          <span class="string">'bgcolor'</span>,[128,128,128],<span class="keyword">...</span><span class="comment"> % sparam.colors(1,:);</span>
0391          <span class="string">'bgtype'</span>,1,<span class="keyword">...</span>
0392          <span class="string">'patch_size'</span>,[30,30],<span class="keyword">...</span>
0393          <span class="string">'patch_num'</span>,[20,40],<span class="keyword">...</span>
0394          <span class="string">'patch_color1'</span>,[255,255,255],<span class="keyword">...</span>
0395          <span class="string">'patch_color2'</span>,[0,0,0],<span class="keyword">...</span>
0396          <span class="string">'pix_per_cm'</span>,57.1429,<span class="keyword">...</span>
0397          <span class="string">'vdist'</span>,65,<span class="keyword">...</span>
0398          <span class="string">'ipd'</span>,6.5);
0399 
0400 <span class="comment">% change unit from msec to sec.</span>
0401 sparam.initial_fixation_time=sparam.initial_fixation_time./1000; <span class="comment">%#ok</span>
0402 
0403 <span class="comment">% change unit from msec to sec.</span>
0404 sparam.cycle_duration = sparam.cycle_duration./1000;
0405 sparam.flip_duration  = sparam.flip_duration./1000;
0406 sparam.rest_duration  = sparam.rest_duration./1000;
0407 
0408 <span class="comment">% set the other parameters</span>
0409 dparam.RunScript = mfilename();
0410 sparam.RunScript = mfilename();
0411 
0412 
0413 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0414 <span class="comment">%%%% Displaying the presentation parameters you set</span>
0415 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0416 
0417 fprintf(<span class="string">'The Presentation Parameters are as below.\n\n'</span>);
0418 fprintf(<span class="string">'************************************************\n'</span>);
0419 fprintf(<span class="string">'****** Script, Subject, Acquistion Number ******\n'</span>);
0420 fprintf(<span class="string">'Date &amp; Time            : %s\n'</span>,strcat([datestr(now,<span class="string">'yymmdd'</span>),<span class="string">' '</span>,datestr(now,<span class="string">'HH:mm:ss'</span>)]));
0421 fprintf(<span class="string">'Running Script Name    : %s\n'</span>,mfilename());
0422 fprintf(<span class="string">'Subject ID             : %s\n'</span>,subjID);
0423 fprintf(<span class="string">'Acquisition Number     : %d\n'</span>,acq);
0424 fprintf(<span class="string">'********* Run Type, Display Image Type *********\n'</span>);
0425 fprintf(<span class="string">'Display Mode           : %s\n'</span>,dparam.ExpMode);
0426 fprintf(<span class="string">'use Full Screen Mode   : %d\n'</span>,dparam.fullscr);
0427 fprintf(<span class="string">'Start Method           : %d\n'</span>,dparam.start_method);
0428 <span class="keyword">if</span> dparam.start_method==4
0429   fprintf(<span class="string">'Custom Trigger         : %d\n'</span>,dparam.custom_trigger);
0430 <span class="keyword">end</span>
0431 fprintf(<span class="string">'*************** Screen Settings ****************\n'</span>);
0432 fprintf(<span class="string">'Screen Height          : %d\n'</span>,dparam.ScrHeight);
0433 fprintf(<span class="string">'Screen Width           : %d\n'</span>,dparam.ScrWidth);
0434 fprintf(<span class="string">'*********** Stimulation Periods etc. ***********\n'</span>);
0435 fprintf(<span class="string">'Fixation Time(sec)     : %d &amp; %d\n'</span>,sparam.initial_fixation_time(1),sparam.initial_fixation_time(2));
0436 fprintf(<span class="string">'Cycle Duration(sec)    : %d\n'</span>,sparam.cycle_duration);
0437 fprintf(<span class="string">'Rest  Duration(sec)    : %d\n'</span>,sparam.rest_duration);
0438 fprintf(<span class="string">'Repetitions(cycles)    : %d\n'</span>,sparam.numRepeats);
0439 fprintf(<span class="string">'Frame Flip(per VerSync): %d\n'</span>,sparam.waitframes);
0440 fprintf(<span class="string">'Total Time (sec)       : %d\n'</span>,sum(sparam.initial_fixation_time)+sparam.numRepeats*sparam.cycle_duration*numel(sparam.rotangles));
0441 fprintf(<span class="string">'**************** Stimulus Type *****************\n'</span>);
0442 fprintf(<span class="string">'Experiment Mode        : %s\n'</span>,sparam.mode);
0443 fprintf(<span class="string">'************ Response key settings *************\n'</span>);
0444 fprintf(<span class="string">'Reponse Key #1         : %d = %s\n'</span>,dparam.Key1,KbName(dparam.Key1));
0445 fprintf(<span class="string">'Reponse Key #2         : %d = %s\n'</span>,dparam.Key2,KbName(dparam.Key2));
0446 fprintf(<span class="string">'************************************************\n\n'</span>);
0447 fprintf(<span class="string">'Please carefully check before proceeding.\n\n'</span>);
0448 
0449 
0450 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0451 <span class="comment">%%%% Initialize response &amp; event logger objects</span>
0452 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0453 
0454 <span class="comment">% initialize MATLAB objects for event and response logs</span>
0455 event=<a href="../../Retinotopy/Common/eventlogger.html" class="code" title="">eventlogger</a>();
0456 resps=<a href="../../Retinotopy/Common/responselogger.html" class="code" title="">responselogger</a>([dparam.Key1,dparam.Key2]);
0457 resps.initialize(event); <span class="comment">% initialize responselogger</span>
0458 
0459 
0460 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0461 <span class="comment">%%%% Wait for user reponse to start</span>
0462 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0463 
0464 <span class="keyword">if</span> ~force_proceed_flag
0465   [user_answer,resps]=resps.wait_to_proceed();
0466   <span class="keyword">if</span> ~user_answer, diary off; <span class="keyword">return</span>; <span class="keyword">end</span>
0467 <span class="keyword">end</span>
0468 
0469 
0470 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0471 <span class="comment">%%%% Initialization of Left &amp; Right screens for binocular presenting/viewing mode</span>
0472 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0473 
0474 <span class="keyword">if</span> dparam.skip_sync_test, Screen(<span class="string">'Preference'</span>,<span class="string">'SkipSyncTests'</span>,1); <span class="keyword">end</span>
0475 
0476 [winPtr,winRect,nScr,dparam.fps,dparam.ifi,initDisplay_OK]=<a href="../../Retinotopy/Common/InitializePTBDisplays.html" class="code" title="function [winPtr,winRect,nScr,fps,ifi,initDisplay_OK]=InitializePTBDisplays(disp_mode,bgcolor,flipping,rgb_gains,custom_scrIDs)">InitializePTBDisplays</a>(dparam.ExpMode,sparam.bgcolor,0,[],dparam.scrID);
0477 <span class="keyword">if</span> ~initDisplay_OK, error(<span class="string">'Display initialization error. Please check your exp_run parameter.'</span>); <span class="keyword">end</span>
0478 HideCursor();
0479 
0480 <span class="keyword">if</span> <a href="../../Retinotopy/Common/isstructmember.html" class="code" title="function isFieldResult = isstructmember(inStruct, fieldName)">isstructmember</a>(dparam,<span class="string">'force_frame_rate'</span>)
0481   <span class="keyword">if</span> dparam.force_frame_rate
0482     dparam.fps=dparam.force_frame_rate;
0483     dparam.ifi=1/dparam.fps;
0484   <span class="keyword">end</span>
0485 <span class="keyword">end</span>
0486 
0487 
0488 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0489 <span class="comment">%%%% Setting the PTB runnning priority to MAX</span>
0490 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0491 
0492 <span class="comment">% set the priority of this script to MAX</span>
0493 priorityLevel=MaxPriority(winPtr,<span class="string">'WaitBlanking'</span>);
0494 Priority(priorityLevel);
0495 
0496 <span class="comment">% conserve VRAM memory: Workaround for flawed hardware and drivers</span>
0497 <span class="comment">% 32 == kPsychDontShareContextRessources: Do not share ressources between</span>
0498 <span class="comment">% different onscreen windows. Usually you want PTB to share all ressources</span>
0499 <span class="comment">% like offscreen windows, textures and GLSL shaders among all open onscreen</span>
0500 <span class="comment">% windows. If that causes trouble for some weird reason, you can prevent</span>
0501 <span class="comment">% automatic sharing with this flag.</span>
0502 <span class="comment">%Screen('Preference','ConserveVRAM',32);</span>
0503 
0504 
0505 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0506 <span class="comment">%%%% Setting the PTB OpenGL functions</span>
0507 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0508 
0509 <span class="comment">% Enable OpenGL mode of Psychtoolbox: This is crucially needed for clut animation</span>
0510 InitializeMatlabOpenGL();
0511 
0512 <span class="comment">% This script calls Psychtoolbox commands available only in OpenGL-based</span>
0513 <span class="comment">% versions of the Psychtoolbox. (So far, the OS X Psychtoolbox is the</span>
0514 <span class="comment">% only OpenGL-base Psychtoolbox.)  The Psychtoolbox command AssertPsychOpenGL will issue</span>
0515 <span class="comment">% an error message if someone tries to execute this script on a computer without</span>
0516 <span class="comment">% an OpenGL Psychtoolbox</span>
0517 AssertOpenGL();
0518 
0519 <span class="comment">% set OpenGL blend functions</span>
0520 Screen(<span class="string">'BlendFunction'</span>, winPtr, GL_SRC_ALPHA, GL_ONE_MINUS_SRC_ALPHA);
0521 
0522 
0523 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0524 <span class="comment">%%%% Displaying 'Initializing...'</span>
0525 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0526 
0527 <span class="comment">% displaying texts on the center of the screen</span>
0528 <a href="../../Retinotopy/Common/DisplayMessage2.html" class="code" title="function DisplayMessage2(message,bgcolor,winPtr,numScreens,drawing_font,drawing_size)">DisplayMessage2</a>(<span class="string">'Initializing...'</span>,sparam.bgcolor,winPtr,nScr,<span class="string">'Arial'</span>,36);
0529 
0530 
0531 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0532 <span class="comment">%%%% Initializing variables</span>
0533 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0534 
0535 <span class="comment">%% unit conversion</span>
0536 
0537 <span class="comment">% cm per pix</span>
0538 sparam.cm_per_pix=1/sparam.pix_per_cm;
0539 
0540 <span class="comment">% pixles per degree</span>
0541 sparam.pix_per_deg=round( 1/( 180*atan(sparam.cm_per_pix/sparam.vdist)/pi ) );
0542 
0543 <span class="comment">% deg to radian</span>
0544 <span class="comment">% do not convert!</span>
0545 <span class="comment">% sparam.width, sparam.phase, sparam.startangle, sparam.rotangle are used in deg formats</span>
0546 
0547 <span class="comment">% sec to number of frames</span>
0548 nframe_fixation=round(sparam.initial_fixation_time.*dparam.fps./sparam.waitframes);
0549 nframe_stim=round((sparam.cycle_duration-sparam.rest_duration)*dparam.fps/sparam.waitframes);
0550 nframe_rest=round(sparam.rest_duration*dparam.fps/sparam.waitframes);
0551 nframe_movement=round((sparam.cycle_duration-sparam.rest_duration)*dparam.fps/sparam.steps/sparam.waitframes);
0552 nframe_flicker=round(sparam.flip_duration*dparam.fps/sparam.waitframes);
0553 nframe_task=round(18/sparam.waitframes); <span class="comment">% just arbitral, you can change as you like</span>
0554 
0555 <span class="comment">%% initialize chackerboard parameters</span>
0556 
0557 <span class="comment">% adjust size ratio considering full-screen effect</span>
0558 <span class="keyword">if</span> dparam.fullscr
0559   <span class="comment">% here, use width information alone, assuming that the pixel is square</span>
0560   ratio_wid=( winRect(3)-winRect(1) )/dparam.ScrWidth;
0561   <span class="comment">%ratio_hei=( winRect(4)-winRect(2) )/dparam.ScrHeight;</span>
0562 
0563   <span class="comment">% adjusting stimulus sizes</span>
0564   fieldSize=sparam.fieldSize*ratio_wid; <span class="comment">% !!! degree, not pixel or cm !!!</span>
0565   width=sparam.width*ratio_wid;
0566 <span class="keyword">else</span>
0567   fieldSize=sparam.fieldSize;
0568   width=sparam.width;
0569 <span class="keyword">end</span>
0570 
0571 
0572 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0573 <span class="comment">%%%% Generating checkerboard bar patterns</span>
0574 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0575 
0576 <span class="comment">% [note]</span>
0577 <span class="comment">% After this processing, each checkerboard image has checker elements with values as shown below</span>
0578 <span class="comment">% 0 = background</span>
0579 <span class="comment">% 1 = checker ID 1</span>
0580 <span class="comment">% 2 = checker ID 2</span>
0581 <span class="comment">% 3 = checker ID 3</span>
0582 <span class="comment">% .....</span>
0583 <span class="comment">% sparam.npatches = checker ID</span>
0584 <span class="comment">% Each patch ID will be associated with a CLUT color of the same ID</span>
0585 
0586 <span class="comment">% generate the checker bar stimuli, checkerboard{rotangles,steps}</span>
0587 [dummy1,dummy2,checkerboard]=<a href="../../Retinotopy/Generation/bar_GenerateCheckerBar1D.html" class="code" title="function [checkerboard,bincheckerboard,mask]=bar_GenerateCheckerBar1D(fieldSize,width,angles,steps,pix_per_deg,ndivsL,ndivsS,phase)">bar_GenerateCheckerBar1D</a>(fieldSize,width,sparam.rotangles,sparam.steps,sparam.pix_per_deg,1,1,0);
0588 
0589 <span class="comment">%% organize the checkerboard into masks</span>
0590 <span class="keyword">for</span> aa=1:1:numel(sparam.rotangles)
0591   <span class="keyword">for</span> nn=1:1:sparam.steps
0592     checkerboard{aa,nn}=repmat(255.*double(~checkerboard{aa,nn}),[1,1,4]);
0593     checkerboard{aa,nn}(:,:,1:3)=repmat(reshape(sparam.bgcolor,[1,1,3]),[size(checkerboard{aa,nn},1),size(checkerboard{aa,nn},2)]);
0594   <span class="keyword">end</span>
0595 <span class="keyword">end</span>
0596 
0597 <span class="comment">%% Make Checkerboard-mask textures</span>
0598 checkertexture=cell(numel(sparam.rotangles),sparam.steps);
0599 <span class="keyword">for</span> aa=1:1:numel(sparam.rotangles)
0600   <span class="keyword">for</span> nn=1:1:sparam.steps
0601     checkertexture{aa,nn}=Screen(<span class="string">'MakeTexture'</span>,winPtr,checkerboard{aa,nn});
0602   <span class="keyword">end</span>
0603 <span class="keyword">end</span>
0604 
0605 
0606 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0607 <span class="comment">%%%% Initializing a background brownian noise image</span>
0608 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0609 
0610 <span class="comment">%pdims=[4,4];</span>
0611 <span class="comment">%szh=size(checkerboard{1,1},1);</span>
0612 <span class="comment">%if mod(szh,pdims(1)), szh=szh+pdims(1)-mod(szh,pdims(1)); end</span>
0613 <span class="comment">%szw=size(checkerboard{1,1},2);</span>
0614 <span class="comment">%if mod(szw,pdims(2)), szw=szw+pdims(2)-mod(szw,pdims(1)); end</span>
0615 <span class="comment">%bnimg=CreateColoredNoise([szh,szw],pdims,3,2,1,0,0);</span>
0616 <span class="comment">%bnimg=bnimg(1:size(checkerboard{1,1},1),1:size(checkerboard{1,1},2),:);</span>
0617 
0618 bnimg=<a href="../../Retinotopy/Common/CreateColoredNoise.html" class="code" title="function img=CreateColoredNoise(idims,sdims,num,beta,norm_flg,save_flg,show_flg)">CreateColoredNoise</a>(round([size(checkerboard{1,1},1),size(checkerboard{1,1},2)]./4),[1,1],3,2,1,0,0); <span class="comment">% ./4 is for reducing computation time, 3 is required for RGB color noise</span>
0619 noisetexture=Screen(<span class="string">'MakeTexture'</span>,winPtr,bnimg);
0620 
0621 
0622 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0623 <span class="comment">%%%% Initializing object images</span>
0624 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0625 
0626 <span class="comment">% loading the object image database</span>
0627 load(fullfile(fileparts(mfilename(<span class="string">'fullpath'</span>)),<span class="string">'..'</span>,<span class="string">'object_images'</span>,<span class="string">'object_image_database.mat'</span>)); <span class="comment">% img is loaded on the memory</span>
0628 
0629 <span class="comment">% shuffling the presentation order</span>
0630 img=img(:,:,:,<a href="../../Retinotopy/Common/shuffle.html" class="code" title="function [Y,index] = shuffle(X)">shuffle</a>(1:size(img,4)));
0631 imgsz=[size(img,1),size(img,2)];
0632 posLims=CenterRect([0,0,size(checkerboard{1,1},2),size(checkerboard{1,1},1)],winRect); <span class="comment">% image location limit, [x_min, y_min, x_max, y_max], the image positions are randomly selected whithin this range</span>
0633 
0634 <span class="comment">% initializing the firt object image textures</span>
0635 
0636 <span class="comment">% image IDs</span>
0637 imgids=1:1:sparam.nimg;
0638 imgids(imgids&gt;size(img,4))=mod(imgids(imgids&gt;size(img,4)),size(img,4));
0639 imgids(imgids==0)=size(img,4);
0640 
0641 <span class="comment">% rectangles</span>
0642 cpos=[(posLims(3)-posLims(1)).*rand(sparam.nimg,1)+posLims(1),(posLims(4)-posLims(2)).*rand(sparam.nimg,1)+posLims(2)]; <span class="comment">% center positions, [x,y]</span>
0643 cszs=(sparam.imRatio(2)-sparam.imRatio(1)).*rand(sparam.nimg,1)+sparam.imRatio(1); <span class="comment">% image maginification factor</span>
0644 imgpos=[round(cpos(:,1)-cszs*imgsz(2)/2)+1,round(cpos(:,2)-cszs*imgsz(1)/2)+1,round(cpos(:,1)+cszs*imgsz(2)/2),round(cpos(:,2)+cszs*imgsz(1)/2)]';
0645 
0646 <span class="comment">% angles</span>
0647 imgrot=360.*rand(sparam.nimg,1);
0648 
0649 <span class="comment">% stereo depth</span>
0650 <span class="keyword">if</span> nScr&gt;1
0651   <span class="comment">% compute image shift from disparity</span>
0652   depths=(sparam.imdepth(2)-sparam.imdepth(1)).*rand(sparam.nimg,1)+sparam.imdepth(1);
0653   zdist=<a href="../../Retinotopy/Common/CalcDistFromDisparity.html" class="code" title="function zdist = CalcDistFromDisparity(ipd,disparity,viewdist)">CalcDistFromDisparity</a>(sparam.ipd,depths,sparam.vdist);
0654   zdist=sort(zdist,<span class="string">'descend'</span>);
0655   [Lshift,Rshift]=RayTrace_ScreenPos_X_MEX(zdist,sparam.ipd,sparam.vdist,sparam.pix_per_cm,0);
0656   stereopos{1}=[Lshift,zeros(sparam.nimg,1),Lshift,zeros(sparam.nimg,1)]';
0657   stereopos{2}=[Rshift,zeros(sparam.nimg,1),Rshift,zeros(sparam.nimg,1)]';
0658 <span class="keyword">else</span>
0659   stereopos{1}=repmat([0,0,0,0],[sparam.nimg,1])';
0660   stereopos{2}=repmat([0,0,0,0],[sparam.nimg,1])';
0661 <span class="keyword">end</span>
0662 
0663 <span class="comment">% generate the object image textures at the first frame</span>
0664 objecttextures=zeros(numel(imgids),1);
0665 <span class="keyword">for</span> pp=1:1:numel(imgids), objecttextures(pp)=Screen(<span class="string">'MakeTexture'</span>,winPtr,img(:,:,:,imgids(pp))); <span class="keyword">end</span>
0666 
0667 
0668 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0669 <span class="comment">%%%% Debug codes</span>
0670 <span class="comment">%%%% saving the stimulus images as *.png format files and enter the debug (keyboard) mode</span>
0671 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0672 
0673 <span class="comment">% %%%%%% DEBUG codes start here</span>
0674 <span class="keyword">if</span> strfind(upper(subjID),<span class="string">'DEBUG'</span>)
0675 
0676   Screen(<span class="string">'CloseAll'</span>);
0677 
0678   save_dir=fullfile(resultDir,<span class="string">'images_ibar_fixtask'</span>);
0679   <span class="keyword">if</span> ~exist(save_dir,<span class="string">'dir'</span>), mkdir(save_dir); <span class="keyword">end</span>
0680 
0681   <span class="comment">% open a new window for drawing stimuli</span>
0682   stimRect=[0,0,size(checkerboard{1,1},2),size(checkerboard{1,1},1)];
0683   [winPtr,winRect]=Screen(<span class="string">'OpenWindow'</span>,dparam.scrID,sparam.bgcolor,CenterRect(stimRect,Screen(<span class="string">'Rect'</span>,dparam.scrID)));
0684 
0685   <span class="comment">% set OpenGL</span>
0686   priorityLevel=MaxPriority(winPtr,<span class="string">'WaitBlanking'</span>);
0687   Priority(priorityLevel);
0688   AssertOpenGL();
0689   Screen(<span class="string">'BlendFunction'</span>, winPtr, GL_SRC_ALPHA, GL_ONE_MINUS_SRC_ALPHA);
0690 
0691   <span class="comment">% regenerate checkerboard textures</span>
0692   <span class="keyword">for</span> aa=1:1:numel(sparam.rotangles)
0693     <span class="keyword">for</span> nn=1:1:sparam.steps
0694       checkertexture{aa,nn}=Screen(<span class="string">'MakeTexture'</span>,winPtr,checkerboard{aa,nn});
0695     <span class="keyword">end</span>
0696   <span class="keyword">end</span>
0697 
0698   <span class="comment">% check the number of flickers</span>
0699   <span class="keyword">if</span> mod((sparam.cycle_duration-sparam.rest_duration)/sparam.steps/sparam.flip_duration,1)~=0
0700     warning(<span class="string">'(sparam.cycle_duration-sparam.rest_duration)/sparam.steps/sparam.flip_duration is not an integer. check the sparam parameters.'</span>);
0701   <span class="keyword">end</span>
0702 
0703   <span class="comment">% processing</span>
0704   obj_counter=0;
0705   <span class="keyword">for</span> aa=1:1:numel(sparam.rotangles)
0706     <span class="keyword">for</span> nn=1:1:sparam.steps
0707       <span class="keyword">for</span> cc=1:1:round((sparam.cycle_duration-sparam.rest_duration)/sparam.steps/sparam.flip_duration)
0708 
0709         <span class="comment">% brownian noise image</span>
0710         bnimg=<a href="../../Retinotopy/Common/CreateColoredNoise.html" class="code" title="function img=CreateColoredNoise(idims,sdims,num,beta,norm_flg,save_flg,show_flg)">CreateColoredNoise</a>(round([size(checkerboard{1,1},1),size(checkerboard{1,1},2)]./4),[1,1],3,2,1,0,0);
0711         noisetexture=Screen(<span class="string">'MakeTexture'</span>,winPtr,bnimg);
0712 
0713         <span class="keyword">for</span> pp=1:1:2 <span class="comment">% by default, 2 image sets in one background noise flicker</span>
0714           <span class="comment">% generate object image textures</span>
0715 
0716           <span class="comment">% image IDs</span>
0717           obj_counter=obj_counter+1;
0718           imgids=sparam.nimg*(obj_counter-1)+1:1:sparam.nimg*obj_counter;
0719           imgids(imgids&gt;size(img,4))=mod(imgids(imgids&gt;size(img,4)),size(img,4));
0720           imgids(imgids==0)=size(img,4);
0721 
0722           <span class="comment">% rectangles</span>
0723           cpos=[(stimRect(3)-stimRect(1)).*rand(sparam.nimg,1)+stimRect(1),(stimRect(4)-stimRect(2)).*rand(sparam.nimg,1)+stimRect(2)]; <span class="comment">% center positions, [x,y]</span>
0724           cszs=(sparam.imRatio(2)-sparam.imRatio(1)).*rand(sparam.nimg,1)+sparam.imRatio(1); <span class="comment">% image maginification factor</span>
0725           imgpos=[round(cpos(:,1)-cszs*imgsz(2)/2)+1,round(cpos(:,2)-cszs*imgsz(1)/2)+1,round(cpos(:,1)+cszs*imgsz(2)/2),round(cpos(:,2)+cszs*imgsz(1)/2)]';
0726 
0727           <span class="comment">% angles</span>
0728           imgrot=360.*rand(sparam.nimg,1);
0729 
0730           <span class="comment">% stereo depth</span>
0731           <span class="keyword">if</span> nScr&gt;1
0732             <span class="comment">% compute image shift from disparity</span>
0733             depths=(sparam.imdepth(2)-sparam.imdepth(1)).*rand(sparam.nimg,1)+sparam.imdepth(1);
0734             zdist=<a href="../../Retinotopy/Common/CalcDistFromDisparity.html" class="code" title="function zdist = CalcDistFromDisparity(ipd,disparity,viewdist)">CalcDistFromDisparity</a>(sparam.ipd,depths,sparam.vdist);
0735             zdist=sort(zdist,<span class="string">'descend'</span>);
0736             [Lshift,Rshift]=RayTrace_ScreenPos_X_MEX(zdist,sparam.ipd,sparam.vdist,sparam.pix_per_cm,0);
0737             stereopos{1}=[Lshift,zeros(sparam.nimg,1),Lshift,zeros(sparam.nimg,1)]';
0738             stereopos{2}=[Rshift,zeros(sparam.nimg,1),Rshift,zeros(sparam.nimg,1)]';
0739           <span class="keyword">else</span>
0740             stereopos{1}=repmat([0,0,0,0],[sparam.nimg,1])';
0741             stereopos{2}=repmat([0,0,0,0],[sparam.nimg,1])';
0742           <span class="keyword">end</span>
0743 
0744           <span class="keyword">for</span> mm=1:1:numel(imgids), objecttextures(mm)=Screen(<span class="string">'MakeTexture'</span>,winPtr,img(:,:,:,imgids(mm))); <span class="keyword">end</span>
0745 
0746           <span class="keyword">for</span> nnnn=1:1:nScr
0747             <span class="comment">% drawing</span>
0748             Screen(<span class="string">'DrawTexture'</span>,winPtr,noisetexture,[],CenterRect(stimRect,winRect)); <span class="comment">% noise textures</span>
0749             Screen(<span class="string">'DrawTextures'</span>,winPtr,objecttextures,[],imgpos+stereopos{nnnn},imgrot); <span class="comment">% object images</span>
0750             Screen(<span class="string">'DrawTexture'</span>,winPtr,checkertexture{aa,nn},[],CenterRect(stimRect,winRect)); <span class="comment">% checkerboard mask</span>
0751 
0752             <span class="comment">% flip the window</span>
0753             Screen(<span class="string">'DrawingFinished'</span>,winPtr);
0754             Screen(<span class="string">'Flip'</span>,winPtr,[],[],[],1);
0755 
0756             <span class="comment">% get the current frame and save it</span>
0757             imwrite(Screen(<span class="string">'GetImage'</span>,winPtr,winRect),fullfile(save_dir,sprintf(<span class="string">'retinotopy_%s_angle_%02d_pos_%02d_type_%02d_%02d_stereo_%02d.png'</span>,sparam.mode,aa,nn,cc,pp,nnnn)),<span class="string">'png'</span>);
0758           <span class="keyword">end</span>
0759 
0760           <span class="comment">% close the textures and OffScreenWindow</span>
0761           <span class="keyword">for</span> mm=1:1:numel(imgids), Screen(<span class="string">'Close'</span>,objecttextures(mm)); <span class="keyword">end</span>
0762         <span class="keyword">end</span> <span class="comment">% for pp=1:1:2</span>
0763         Screen(<span class="string">'Close'</span>,noisetexture);
0764 
0765       <span class="keyword">end</span> <span class="comment">% for cc=1:1:round((sparam.cycle_duration-sparam.rest_duration)/(360/sparam.rotangle)/sparam.flip_duration)</span>
0766     <span class="keyword">end</span> <span class="comment">% for nn=1:1:sparam.steps</span>
0767   <span class="keyword">end</span> <span class="comment">% for aa=1:1:numel(sparam.rotangles)</span>
0768 
0769   Screen(<span class="string">'CloseAll'</span>);
0770   save(fullfile(save_dir,sprintf(<span class="string">'stimulus_%s.mat'</span>,sparam.mode)),<span class="string">'checkerboard'</span>,<span class="string">'sparam'</span>,<span class="string">'dparam'</span>);
0771   keyboard;
0772 
0773 <span class="keyword">end</span> <span class="comment">% if strfind(upper(subjID),'DEBUG')</span>
0774 <span class="comment">% %%%%%% DEBUG code ends here</span>
0775 
0776 
0777 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0778 <span class="comment">%%%% Generating fixation detection task parameters</span>
0779 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0780 
0781 <span class="comment">%% set task variables</span>
0782 <span class="comment">% flag to decide whether presenting fixation task</span>
0783 totalframes=max(sum(nframe_fixation),1)+numel(sparam.rotangles)*(nframe_stim+nframe_rest)*sparam.numRepeats;
0784 num_tasks=ceil(totalframes/nframe_task);
0785 task_flg=ones(1,num_tasks);
0786 <span class="keyword">for</span> nn=2:1:num_tasks
0787   <span class="keyword">if</span> task_flg(nn-1)==2
0788     task_flg(nn)=1;
0789   <span class="keyword">else</span>
0790     <span class="keyword">if</span> mod(randi(4,1),4)==0 <span class="comment">% this is arbitral, but I put these lines just to reduce the number of tasks</span>
0791       task_flg(nn)=round(rand(1,1))+1;
0792     <span class="keyword">else</span>
0793       task_flg(nn)=1;
0794     <span class="keyword">end</span>
0795   <span class="keyword">end</span>
0796 <span class="keyword">end</span>
0797 task_flg=repmat(task_flg,nframe_task,1);
0798 task_flg=task_flg(:);
0799 
0800 
0801 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0802 <span class="comment">%%%% Initializing checkerboard color management parameters</span>
0803 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0804 
0805 <span class="comment">% variable to store the current rotation/disparity id</span>
0806 stim_pos_id=1;
0807 
0808 
0809 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0810 <span class="comment">%%%% Creating background images</span>
0811 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0812 
0813 <span class="keyword">if</span> sparam.bgtype==1 <span class="comment">% a simple background with sparam.bgcolor</span>
0814   bgimg{1}=repmat(reshape(sparam.bgcolor,[1,1,3]),[dparam.ScrHeight,dparam.ScrWidth]);
0815 
0816 <span class="keyword">elseif</span> sparam.bgtype==2 <span class="comment">% a background with grid guides</span>
0817 
0818   <span class="comment">% calculate the central aperture size of the background image</span>
0819   edgeY=mod(dparam.ScrHeight,sparam.patch_num(1)); <span class="comment">% delete the exceeded region</span>
0820   p_height=round((dparam.ScrHeight-edgeY)/sparam.patch_num(1)); <span class="comment">% height in pix of patch_height + interval-Y</span>
0821 
0822   edgeX=mod(dparam.ScrWidth,sparam.patch_num(2)); <span class="comment">% delete exceeded region</span>
0823   p_width=round((dparam.ScrWidth-edgeX)/sparam.patch_num(2)); <span class="comment">% width in pix of patch_width + interval-X</span>
0824 
0825   <span class="keyword">if</span> dparam.fullscr
0826     aperture_size=[2*( p_height*ceil( size(checkerboard{1,1},1)/2*( (winRect(4)-winRect(2))/dparam.ScrHeight ) /p_height ) ),<span class="keyword">...</span>
0827                    2*( p_width*ceil( size(checkerboard{1,1},2)/2*( (winRect(3)-winRect(1))/dparam.ScrWidth ) /p_width ) )];
0828   <span class="keyword">else</span>
0829     aperture_size=[2*( p_height*ceil(size(checkerboard{1,1},1)/2/p_height) ),<span class="keyword">...</span>
0830                    2*( p_width*ceil(size(checkerboard{1,1},2)/2/p_width) )];
0831   <span class="keyword">end</span>
0832 
0833   bgimg=<a href="../../Retinotopy/Common/CreateBackgroundImage.html" class="code" title="function [Bimg,parameters] = CreateBackgroundImage(wdims,stdims,pdims,bgcolor,color1,color2,fixcolor,patchnum,fix_flag,save_flag,show_flag)">CreateBackgroundImage</a>([dparam.ScrHeight,dparam.ScrWidth],aperture_size,sparam.patch_size,sparam.bgcolor,sparam.patch_color1,sparam.patch_color2,sparam.fixcolor,sparam.patch_num,0,0,0);
0834 <span class="keyword">else</span>
0835   error(<span class="string">'sparam.bgtype should be 1 or 2. check the input variable.'</span>);
0836 <span class="keyword">end</span>
0837 
0838 <span class="comment">% set mask and transparency in the middle region of the background where the target stimuli are to be presented.</span>
0839 <span class="comment">% this mask is required to prevent the object images from being presented in the external regions.</span>
0840 bgimg=bgimg{1};
0841 bgimg(:,:,4)=255*ones(size(bgimg,1),size(bgimg,2));
0842 maskRect=CenterRect([1,1,size(checkerboard{1,1},2),size(checkerboard{1,1},1)],[1,1,size(bgimg,2),size(bgimg,1)]);
0843 bgimg(maskRect(2)+1:maskRect(4),maskRect(1)+1:maskRect(3),4)=0; <span class="comment">% alpha channel, transparency</span>
0844 
0845 background=Screen(<span class="string">'MakeTexture'</span>,winPtr,bgimg);
0846 
0847 
0848 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0849 <span class="comment">%%%% Creating the central fixation, cross images</span>
0850 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0851 
0852 <span class="comment">% Create fixation cross images.</span>
0853 <span class="comment">% Firstly larger fixations are generated, then they are antialiased. This is required to present a beautiful circle</span>
0854 
0855 <span class="keyword">if</span> sparam.fixtype==1 <span class="comment">% circular fixation</span>
0856   fixW=<a href="../../Retinotopy/Common/CreateFixationImgCircular.html" class="code" title="function fix=CreateFixationImgCircular(fixsize,fixcolor,bgcolor,circlesize,show_flag,save_flag)">CreateFixationImgCircular</a>(4*sparam.fixsize,sparam.fixcolor,sparam.bgcolor,4*sparam.fixsize,0,0);
0857   fixD=<a href="../../Retinotopy/Common/CreateFixationImgCircular.html" class="code" title="function fix=CreateFixationImgCircular(fixsize,fixcolor,bgcolor,circlesize,show_flag,save_flag)">CreateFixationImgCircular</a>(4*sparam.fixsize,[64,64,64],sparam.bgcolor,4*sparam.fixsize,0,0);
0858 <span class="keyword">elseif</span> sparam.fixtype==2 <span class="comment">% rectangular fixation</span>
0859   fixW=<a href="../../Retinotopy/Common/CreateFixationImgMono.html" class="code" title="function fix=CreateFixationImgMono(fixsize,fixcolor,bgcolor,fixlinew,fixlineh,show_flag,save_flag)">CreateFixationImgMono</a>(4*sparam.fixsize,sparam.fixcolor,sparam.bgcolor,4*2,4*ceil(0.4*sparam.fixsize),0,0);
0860   fixD=<a href="../../Retinotopy/Common/CreateFixationImgMono.html" class="code" title="function fix=CreateFixationImgMono(fixsize,fixcolor,bgcolor,fixlinew,fixlineh,show_flag,save_flag)">CreateFixationImgMono</a>(4*sparam.fixsize,[64,64,64],sparam.bgcolor,4*2,4*ceil(0.4*sparam.fixsize),0,0);
0861 <span class="keyword">elseif</span> sparam.fixtype==3 <span class="comment">% concentric fixation</span>
0862   fixW=<a href="../../Retinotopy/Common/CreateFixationImgConcentrateMono.html" class="code" title="function fix=CreateFixationImgConcentrateMono(fixsize,fixcolor,bgcolor,circlesize,gap,show_flag,save_flag)">CreateFixationImgConcentrateMono</a>(4*sparam.fixsize,sparam.fixcolor,sparam.bgcolor,4*[2,ceil(0.8*sparam.fixsize)],0,0,0);
0863   fixD=<a href="../../Retinotopy/Common/CreateFixationImgConcentrateMono.html" class="code" title="function fix=CreateFixationImgConcentrateMono(fixsize,fixcolor,bgcolor,circlesize,gap,show_flag,save_flag)">CreateFixationImgConcentrateMono</a>(4*sparam.fixsize,[64,64,64],sparam.bgcolor,4*[2,ceil(0.8*sparam.fixsize)],0,0,0);
0864 <span class="keyword">else</span>
0865   error(<span class="string">'sparam.fixtype should be one of 1,2, and 3. check the input variable.'</span>);
0866 <span class="keyword">end</span>
0867 fixW=imresize(fixW,0.25);
0868 fixD=imresize(fixD,0.25);
0869 
0870 fix=cell(2,1); <span class="comment">% 1 is for default fixation, 2 is for darker fixation (luminance detection task)</span>
0871 fix{1}=Screen(<span class="string">'MakeTexture'</span>,winPtr,fixW);
0872 fix{2}=Screen(<span class="string">'MakeTexture'</span>,winPtr,fixD);
0873 
0874 
0875 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0876 <span class="comment">%%%% Prepare blue lines for stereo image flip sync with VPixx PROPixx</span>
0877 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0878 
0879 <span class="comment">% There seems to be a blueline generation bug on some OpenGL systems.</span>
0880 <span class="comment">% SetStereoBlueLineSyncParameters(winPtr, winRect(4)) corrects the</span>
0881 <span class="comment">% bug on some systems, but breaks on other systems.</span>
0882 <span class="comment">% We'll just disable automatic blueline, and manually draw our own bluelines!</span>
0883 
0884 <span class="keyword">if</span> strcmpi(dparam.ExpMode,<span class="string">'propixxstereo'</span>)
0885   SetStereoBlueLineSyncParameters(winPtr, winRect(4)+10);
0886   blueRectOn(1,:)=[0, winRect(4)-1, winRect(3)/4, winRect(4)];
0887   blueRectOn(2,:)=[0, winRect(4)-1, winRect(3)*3/4, winRect(4)];
0888   blueRectOff(1,:)=[winRect(3)/4, winRect(4)-1, winRect(3), winRect(4)];
0889   blueRectOff(2,:)=[winRect(3)*3/4, winRect(4)-1, winRect(3), winRect(4)];
0890 <span class="keyword">end</span>
0891 
0892 
0893 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0894 <span class="comment">%%%% Image size adjusting to match the current display resolutions</span>
0895 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0896 
0897 <span class="keyword">if</span> dparam.fullscr
0898   ratio_wid= ( winRect(3)-winRect(1) )/dparam.ScrWidth;
0899   ratio_hei= ( winRect(4)-winRect(2) )/dparam.ScrHeight;
0900   bgSize   = [size(bgimg{1},2)*ratio_wid, size(bgimg{1},1)*ratio_hei];
0901   stimSize = [size(checkerboard{1,1},2)*ratio_wid, size(checkerboard{1,1},1)*ratio_hei];
0902   fixSize  = [2*sparam.fixsize*ratio_wid, 2*sparam.fixsize*ratio_hei];
0903 <span class="keyword">else</span>
0904   bgSize   = [dparam.ScrWidth, dparam.ScrHeight];
0905   stimSize = [size(checkerboard{1,1},2), size(checkerboard{1,1},1)];
0906   fixSize  = [2*sparam.fixsize, 2*sparam.fixsize];
0907 <span class="keyword">end</span>
0908 
0909 <span class="comment">% for some display modes in which one screen is splitted into two binocular displays</span>
0910 <span class="keyword">if</span> strcmpi(dparam.ExpMode,<span class="string">'cross'</span>) || strcmpi(dparam.ExpMode,<span class="string">'parallel'</span>) || <span class="keyword">...</span>
0911    strcmpi(dparam.ExpMode,<span class="string">'topbottom'</span>) || strcmpi(dparam.ExpMode,<span class="string">'bottomtop'</span>)
0912   bgSize=bgSize./2;
0913   stimSize=stimSize./2;
0914   fixSize=fixSize./2;
0915 
0916   <span class="comment">% adjust image size (note: in contrast, we have to keep the stereo shifts as they are)</span>
0917   imgsz=imgsz./2;
0918 
0919   <span class="comment">% update lim positions just for the first frame</span>
0920   posLims=CenterRect([0,0,size(checkerboard{1},2)./2,size(checkerboard{1},1)./2],winRect); <span class="comment">% image location limit, [x_min, y_min, x_max, y_max], the image positions are randomly selected whithin this range</span>
0921 
0922   <span class="comment">% update image locations just for the first frame</span>
0923   cpos=[(posLims(3)-posLims(1)).*rand(sparam.nimg,1)+posLims(1),(posLims(4)-posLims(2)).*rand(sparam.nimg,1)+posLims(2)]; <span class="comment">% center positions, [x,y]</span>
0924   cszs=(sparam.imRatio(2)-sparam.imRatio(1)).*rand(sparam.nimg,1)+sparam.imRatio(1); <span class="comment">% image maginification factor</span>
0925   imgpos=[round(cpos(:,1)-cszs*imgsz(2)/2)+1,round(cpos(:,2)-cszs*imgsz(1)/2)+1,round(cpos(:,1)+cszs*imgsz(2)/2),round(cpos(:,2)+cszs*imgsz(1)/2)]';
0926 <span class="keyword">end</span>
0927 
0928 bgRect  = [0, 0, bgSize]; <span class="comment">% used to display background images;</span>
0929 stimRect= [0, 0, stimSize];
0930 fixRect = [0, 0, fixSize]; <span class="comment">% used to display the central fixation point</span>
0931 
0932 
0933 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0934 <span class="comment">%%%% Generating additional mask which covers the outside region of the background.</span>
0935 <span class="comment">%%%% The mask is required to hide parts of the objects presented outside the background</span>
0936 <span class="comment">%%%% when the script is not running with full-screen mode.</span>
0937 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0938 
0939 wrect=Screen(<span class="string">'Rect'</span>,winPtr);
0940 <span class="keyword">if</span> wrect(3)-wrect(1)&gt;bgRect(3)-bgRect(1) | wrect(4)-wrect(2)&gt;bgRect(4)-bgRect(2) <span class="comment">% if background is smaller than the whole screen</span>
0941   hide_flg=1;
0942   amskimg=repmat(reshape(sparam.colors(1,:),[1,1,3]),[wrect(4)-wrect(2),wrect(3)-wrect(1)]);
0943   amskimg(:,:,4)=255*ones(size(amskimg,1),size(amskimg,2));
0944   amskRect=CenterRect(bgRect,wrect);
0945   amskimg(amskRect(2)+1:amskRect(4),amskRect(1)+1:amskRect(3),4)=0; <span class="comment">% alpha channel, transparency</span>
0946 
0947   abackground=Screen(<span class="string">'MakeTexture'</span>,winPtr,amskimg);
0948 <span class="keyword">else</span>
0949   hide_flg=0;
0950 <span class="keyword">end</span>
0951 
0952 
0953 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0954 <span class="comment">%%%% Initialize functions and variables for trial loop</span>
0955 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0956 
0957 <span class="comment">% initialize variables that we will use during the experiment (faster)</span>
0958 cur_frames=0;
0959 
0960 <span class="comment">% object image counter</span>
0961 obj_counter=0;
0962 
0963 
0964 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0965 <span class="comment">%%%% Displaying 'Ready to Start'</span>
0966 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0967 
0968 <span class="comment">% displaying texts on the center of the screen</span>
0969 <a href="../../Retinotopy/Common/DisplayMessage2.html" class="code" title="function DisplayMessage2(message,bgcolor,winPtr,numScreens,drawing_font,drawing_size)">DisplayMessage2</a>(<span class="string">'Ready to Start'</span>,sparam.bgcolor,winPtr,nScr,<span class="string">'Arial'</span>,36);
0970 ttime=GetSecs(); <span class="keyword">while</span> (GetSecs()-ttime &lt; 0.5), <span class="keyword">end</span>  <span class="comment">% run up the clock.</span>
0971 
0972 
0973 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0974 <span class="comment">%%%% Flip the display(s) to the background image(s)</span>
0975 <span class="comment">%%%% and inform the ready of stimulus presentation</span>
0976 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0977 
0978 <span class="comment">% change the screen and wait for the trigger or pressing the start button</span>
0979 <span class="keyword">for</span> nn=1:1:nScr
0980   Screen(<span class="string">'SelectStereoDrawBuffer'</span>,winPtr,nn-1);
0981   Screen(<span class="string">'DrawTexture'</span>,winPtr,fix{2},[],CenterRect(fixRect,winRect));
0982   Screen(<span class="string">'DrawTexture'</span>,winPtr,background,[],CenterRect(bgRect,winRect));
0983 
0984   <span class="comment">% blue line for stereo sync</span>
0985   <span class="keyword">if</span> strcmpi(dparam.ExpMode,<span class="string">'propixxstereo'</span>)
0986     Screen(<span class="string">'FillRect'</span>,winPtr,[0,0,255],blueRectOn(nn,:));
0987     Screen(<span class="string">'FillRect'</span>,winPtr,[0,0,0],blueRectOff(nn,:));
0988   <span class="keyword">end</span>
0989 <span class="keyword">end</span>
0990 Screen(<span class="string">'DrawingFinished'</span>,winPtr);
0991 Screen(<span class="string">'Flip'</span>, winPtr,[],[],[],1);
0992 
0993 <span class="comment">% prepare the next frame for the initial fixation period</span>
0994 <span class="keyword">for</span> nn=1:1:nScr
0995   Screen(<span class="string">'SelectStereoDrawBuffer'</span>,winPtr,nn-1);
0996   Screen(<span class="string">'DrawTexture'</span>,winPtr,fix{1},[],CenterRect(fixRect,winRect)); <span class="comment">% fix{1} is valid as no task in the first period</span>
0997   Screen(<span class="string">'DrawTexture'</span>,winPtr,background,[],CenterRect(bgRect,winRect));
0998 
0999   <span class="comment">% blue line for stereo sync</span>
1000   <span class="keyword">if</span> strcmpi(dparam.ExpMode,<span class="string">'propixxstereo'</span>)
1001     Screen(<span class="string">'FillRect'</span>,winPtr,[0,0,255],blueRectOn(nn,:));
1002     Screen(<span class="string">'FillRect'</span>,winPtr,[0,0,0],blueRectOff(nn,:));
1003   <span class="keyword">end</span>
1004 <span class="keyword">end</span>
1005 Screen(<span class="string">'DrawingFinished'</span>,winPtr);
1006 
1007 
1008 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
1009 <span class="comment">%%%% Wait for the first trigger pulse from fMRI scanner or start with button pressing</span>
1010 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
1011 
1012 <span class="comment">% add time stamp (this also works to load add_event method in memory in advance of the actual displays)</span>
1013 fprintf(<span class="string">'\nWaiting for the start...\n'</span>);
1014 event=event.add_event(<span class="string">'Experiment Start'</span>,strcat([datestr(now,<span class="string">'yymmdd'</span>),<span class="string">' '</span>,datestr(now,<span class="string">'HH:mm:ss'</span>)]),NaN);
1015 
1016 <span class="comment">% waiting for stimulus presentation</span>
1017 resps.wait_stimulus_presentation(dparam.start_method,dparam.custom_trigger);
1018 <span class="comment">%PlaySound(1);</span>
1019 fprintf(<span class="string">'\nExperiment running...\n'</span>);
1020 
1021 
1022 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
1023 <span class="comment">%%%% Initial Fixation Period</span>
1024 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
1025 
1026 vbl=Screen(<span class="string">'Flip'</span>,winPtr,[],[],[],1); <span class="comment">% the first flip</span>
1027 [event,the_experiment_start]=event.set_reference_time(vbl);
1028 event=event.add_event(<span class="string">'Initial Fixation'</span>,[]);
1029 fprintf(<span class="string">'\nfixation\n\n'</span>);
1030 cur_frames=cur_frames+1;
1031 
1032 <span class="comment">% wait for the initial fixation</span>
1033 <span class="keyword">for</span> ff=1:1:nframe_fixation(1)
1034   <span class="keyword">for</span> nn=1:1:nScr
1035     Screen(<span class="string">'SelectStereoDrawBuffer'</span>,winPtr,nn-1);
1036     Screen(<span class="string">'DrawTexture'</span>,winPtr,fix{task_flg(cur_frames)},[],CenterRect(fixRect,winRect));
1037     Screen(<span class="string">'DrawTexture'</span>,winPtr,background,[],CenterRect(bgRect,winRect));
1038 
1039     <span class="comment">% blue line for stereo sync</span>
1040     <span class="keyword">if</span> strcmpi(dparam.ExpMode,<span class="string">'propixxstereo'</span>)
1041       Screen(<span class="string">'FillRect'</span>,winPtr,[0,0,255],blueRectOn(nn,:));
1042       Screen(<span class="string">'FillRect'</span>,winPtr,[0,0,0],blueRectOff(nn,:));
1043     <span class="keyword">end</span>
1044   <span class="keyword">end</span>
1045   Screen(<span class="string">'DrawingFinished'</span>,winPtr);
1046   <span class="keyword">while</span> GetSecs()&lt;vbl+(ff*sparam.waitframes-0.5)*dparam.ifi, [resps,event]=resps.check_responses(event); <span class="keyword">end</span>
1047   Screen(<span class="string">'Flip'</span>,winPtr,[],[],[],1);
1048 
1049   <span class="comment">% update task</span>
1050   cur_frames=cur_frames+1;
1051   <span class="keyword">if</span> task_flg(cur_frames-1)==2 &amp;&amp; task_flg(cur_frames-2)==1, event=event.add_event(<span class="string">'Luminance Task'</span>,[]); <span class="keyword">end</span>
1052 <span class="keyword">end</span>
1053 
1054 
1055 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
1056 <span class="comment">%%%% The Trial Loop</span>
1057 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
1058 
1059 <span class="keyword">for</span> cc=1:1:sparam.numRepeats
1060 
1061   <span class="comment">% loop for angle directions</span>
1062   <span class="keyword">for</span> aa=1:1:numel(sparam.rotangles)
1063 
1064     <span class="comment">%% stimulus presentation loop</span>
1065     <span class="keyword">for</span> ff=1:1:nframe_stim+nframe_rest
1066 
1067       <span class="comment">%% display the current frame</span>
1068       <span class="keyword">for</span> nn=1:1:nScr
1069         Screen(<span class="string">'SelectStereoDrawBuffer'</span>,winPtr,nn-1);
1070         <span class="keyword">if</span> ff&lt;=nframe_stim
1071           Screen(<span class="string">'DrawTexture'</span>,winPtr,noisetexture,[],CenterRect(stimRect,winRect)); <span class="comment">% noise textures</span>
1072           Screen(<span class="string">'DrawTextures'</span>,winPtr,objecttextures,[],imgpos+stereopos{nn},imgrot); <span class="comment">% object images</span>
1073           Screen(<span class="string">'DrawTexture'</span>,winPtr,checkertexture{aa,stim_pos_id},[],CenterRect(stimRect,winRect)); <span class="comment">% checkerboard mask</span>
1074           <span class="keyword">if</span> hide_flg, Screen(<span class="string">'DrawTexture'</span>,winPtr,abackground,[],winRect); <span class="keyword">end</span> <span class="comment">% additional background to hide the external region</span>
1075         <span class="keyword">end</span>
1076         Screen(<span class="string">'DrawTexture'</span>,winPtr,fix{task_flg(cur_frames)},[],CenterRect(fixRect,winRect)); <span class="comment">% the central fixation oval</span>
1077         Screen(<span class="string">'DrawTexture'</span>,winPtr,background,[],CenterRect(bgRect,winRect)); <span class="comment">% background</span>
1078 
1079         <span class="comment">% blue line for stereo sync</span>
1080         <span class="keyword">if</span> strcmpi(dparam.ExpMode,<span class="string">'propixxstereo'</span>)
1081           Screen(<span class="string">'FillRect'</span>,winPtr,[0,0,255],blueRectOn(nn,:));
1082           Screen(<span class="string">'FillRect'</span>,winPtr,[0,0,0],blueRectOff(nn,:));
1083         <span class="keyword">end</span>
1084       <span class="keyword">end</span>
1085 
1086       <span class="comment">% flip the window</span>
1087       Screen(<span class="string">'DrawingFinished'</span>,winPtr);
1088       <span class="keyword">while</span> GetSecs()&lt;vbl+sparam.initial_fixation_time(1)+(cc-1)*numel(sparam.rotangles)*sparam.cycle_duration+<span class="keyword">...</span>
1089                       (aa-1)*sparam.cycle_duration+((ff-1)*sparam.waitframes-0.5)*dparam.ifi, [resps,event]=resps.check_responses(event); <span class="keyword">end</span>
1090       Screen(<span class="string">'Flip'</span>,winPtr,[],[],[],1);
1091 
1092       <span class="keyword">if</span> ff==1
1093         event=event.add_event(sprintf(<span class="string">'Cycle: %d, Direction: %.2f deg'</span>,(cc-1)*numel(sparam.rotangles)+aa,sparam.rotangles(aa)),[]);
1094         fprintf(<span class="string">'Cycle: %03d, Direction: %.2f deg...\n'</span>,(cc-1)*numel(sparam.rotangles)+aa,sparam.rotangles(aa));
1095       <span class="keyword">end</span>
1096 
1097       <span class="comment">% update task</span>
1098       cur_frames=cur_frames+1;
1099       <span class="keyword">if</span> task_flg(cur_frames)==2 &amp;&amp; task_flg(cur_frames-1)==1, event=event.add_event(<span class="string">'Luminance Task'</span>,[]); <span class="keyword">end</span>
1100 
1101       <span class="comment">%% exit from the loop if the final frame is displayed</span>
1102       <span class="keyword">if</span> ff==nframe_stim+nframe_rest &amp;&amp; aa==numel(sparam.rotangles), <span class="keyword">continue</span>; <span class="keyword">end</span>
1103 
1104       <span class="comment">%% update IDs</span>
1105 
1106       <span class="keyword">if</span> ff&lt;=nframe_stim
1107 
1108         <span class="comment">% flickering the target image</span>
1109         <span class="keyword">if</span> ~mod(ff,nframe_flicker) <span class="comment">% noise pattern reversal</span>
1110           <span class="comment">% update the brownian noise texture.</span>
1111           Screen(<span class="string">'Close'</span>,noisetexture);
1112           <span class="comment">%bnimg=CreateColoredNoise([szh,szw],pdims,3,2,1,0,0);</span>
1113           <span class="comment">%bnimg=bnimg(1:size(checkerboard{1,1},1),1:size(checkerboard{1,1},2),:);</span>
1114           bnimg=<a href="../../Retinotopy/Common/CreateColoredNoise.html" class="code" title="function img=CreateColoredNoise(idims,sdims,num,beta,norm_flg,save_flg,show_flg)">CreateColoredNoise</a>(round([size(checkerboard{aa,nn},1),size(checkerboard{aa,nn},2)]./4),[1,1],3,2,1,0,0);
1115           noisetexture=Screen(<span class="string">'MakeTexture'</span>,winPtr,bnimg);
1116         <span class="keyword">end</span>
1117 
1118         <span class="keyword">if</span> ~mod(ff,ceil(nframe_flicker/2)) <span class="comment">% object image reversal</span>
1119           <span class="comment">%% update object images</span>
1120           <span class="keyword">for</span> pp=1:1:numel(imgids), Screen(<span class="string">'Close'</span>,objecttextures(pp)); <span class="keyword">end</span>
1121 
1122           obj_counter=obj_counter+1;
1123 
1124           <span class="comment">% image IDs</span>
1125           imgids=sparam.nimg*obj_counter+1:1:sparam.nimg*(obj_counter+1); <span class="comment">% the first image set is already presented</span>
1126           imgids(imgids&gt;size(img,4))=mod(imgids(imgids&gt;size(img,4)),size(img,4));
1127           imgids(imgids==0)=size(img,4);
1128 
1129           <span class="comment">% rectangles</span>
1130           cpos=[(posLims(3)-posLims(1)).*rand(sparam.nimg,1)+posLims(1),(posLims(4)-posLims(2)).*rand(sparam.nimg,1)+posLims(2)]; <span class="comment">% center positions, [x,y]</span>
1131           cszs=(sparam.imRatio(2)-sparam.imRatio(1)).*rand(sparam.nimg,1)+sparam.imRatio(1); <span class="comment">% image maginification factor</span>
1132           imgpos=[round(cpos(:,1)-cszs*imgsz(2)/2)+1,round(cpos(:,2)-cszs*imgsz(1)/2)+1,round(cpos(:,1)+cszs*imgsz(2)/2),round(cpos(:,2)+cszs*imgsz(1)/2)]';
1133 
1134           <span class="comment">% angles</span>
1135           imgrot=360.*rand(sparam.nimg,1);
1136 
1137           <span class="comment">% stereo depth</span>
1138           <span class="keyword">if</span> nScr&gt;1
1139             <span class="comment">% compute image shift from disparity</span>
1140             depths=(sparam.imdepth(2)-sparam.imdepth(1)).*rand(sparam.nimg,1)+sparam.imdepth(1);
1141             zdist=<a href="../../Retinotopy/Common/CalcDistFromDisparity.html" class="code" title="function zdist = CalcDistFromDisparity(ipd,disparity,viewdist)">CalcDistFromDisparity</a>(sparam.ipd,depths,sparam.vdist);
1142             zdist=sort(zdist,<span class="string">'descend'</span>);
1143             [Lshift,Rshift]=RayTrace_ScreenPos_X_MEX(zdist,sparam.ipd,sparam.vdist,sparam.pix_per_cm,0);
1144             stereopos{1}=[Lshift,zeros(sparam.nimg,1),Lshift,zeros(sparam.nimg,1)]';
1145             stereopos{2}=[Rshift,zeros(sparam.nimg,1),Rshift,zeros(sparam.nimg,1)]';
1146           <span class="keyword">else</span>
1147             stereopos{1}=repmat([0,0,0,0],[sparam.nimg,1])';
1148             stereopos{2}=repmat([0,0,0,0],[sparam.nimg,1])';
1149           <span class="keyword">end</span>
1150 
1151           <span class="comment">% generate object image textures</span>
1152           <span class="keyword">for</span> pp=1:1:numel(imgids), objecttextures(pp)=Screen(<span class="string">'MakeTexture'</span>,winPtr,img(:,:,:,imgids(pp))); <span class="keyword">end</span>
1153         <span class="keyword">end</span>
1154 
1155         <span class="comment">% stimulus position id for the next presentation</span>
1156         <span class="keyword">if</span> ~mod(ff,nframe_movement)
1157           stim_pos_id=stim_pos_id+1;
1158           <span class="keyword">if</span> stim_pos_id&gt;sparam.steps, stim_pos_id=1; <span class="keyword">end</span>
1159         <span class="keyword">end</span>
1160       <span class="keyword">else</span> <span class="comment">% required to compensate insubdivisible frames</span>
1161         stim_pos_id=1;
1162       <span class="keyword">end</span>
1163     <span class="keyword">end</span> <span class="comment">% for ff=1:1:nframe_stim+nframe_rest</span>
1164   <span class="keyword">end</span> <span class="comment">% for aa=1:1:numel(sparam.rotangles)</span>
1165 <span class="keyword">end</span> <span class="comment">% for cc=1:1:sparam.numRepeats</span>
1166 
1167 
1168 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
1169 <span class="comment">%%%% Final Fixation</span>
1170 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
1171 
1172 <span class="keyword">for</span> nn=1:1:nScr
1173   Screen(<span class="string">'SelectStereoDrawBuffer'</span>,winPtr,nn-1);
1174   Screen(<span class="string">'DrawTexture'</span>,winPtr,fix{task_flg(cur_frames)},[],CenterRect(fixRect,winRect));
1175   Screen(<span class="string">'DrawTexture'</span>,winPtr,background,[],CenterRect(bgRect,winRect));
1176 
1177   <span class="comment">% blue line for stereo sync</span>
1178   <span class="keyword">if</span> strcmpi(dparam.ExpMode,<span class="string">'propixxstereo'</span>)
1179     Screen(<span class="string">'FillRect'</span>,winPtr,[0,0,255],blueRectOn(nn,:));
1180     Screen(<span class="string">'FillRect'</span>,winPtr,[0,0,0],blueRectOff(nn,:));
1181   <span class="keyword">end</span>
1182 <span class="keyword">end</span>
1183 Screen(<span class="string">'DrawingFinished'</span>,winPtr);
1184 <span class="keyword">while</span> GetSecs()&lt;vbl+sparam.initial_fixation_time(1)+sparam.numRepeats*numel(sparam.rotangles)*sparam.cycle_duration-0.5*dparam.ifi, [resps,event]=resps.check_responses(event); <span class="keyword">end</span>
1185 Screen(<span class="string">'Flip'</span>,winPtr,[],[],[],1);
1186 <span class="comment">%cur_frames=cur_frames+1;</span>
1187 event=event.add_event(<span class="string">'Final Fixation'</span>,[]);
1188 fprintf(<span class="string">'\nfixation\n'</span>);
1189 
1190 <span class="comment">% wait for the initial fixation</span>
1191 <span class="keyword">for</span> ff=1:1:nframe_fixation(2)
1192   <span class="keyword">for</span> nn=1:1:nScr
1193     Screen(<span class="string">'SelectStereoDrawBuffer'</span>,winPtr,nn-1);
1194     Screen(<span class="string">'DrawTexture'</span>,winPtr,fix{task_flg(cur_frames)},[],CenterRect(fixRect,winRect));
1195     Screen(<span class="string">'DrawTexture'</span>,winPtr,background,[],CenterRect(bgRect,winRect));
1196 
1197     <span class="comment">% blue line for stereo sync</span>
1198     <span class="keyword">if</span> strcmpi(dparam.ExpMode,<span class="string">'propixxstereo'</span>)
1199       Screen(<span class="string">'FillRect'</span>,winPtr,[0,0,255],blueRectOn(nn,:));
1200       Screen(<span class="string">'FillRect'</span>,winPtr,[0,0,0],blueRectOff(nn,:));
1201     <span class="keyword">end</span>
1202   <span class="keyword">end</span>
1203   Screen(<span class="string">'DrawingFinished'</span>,winPtr);
1204   <span class="keyword">while</span> GetSecs()&lt;vbl+sparam.initial_fixation_time(1)+sparam.numRepeats*numel(sparam.rotangles)*sparam.cycle_duration+(ff*sparam.waitframes-0.5)*dparam.ifi, [resps,event]=resps.check_responses(event); <span class="keyword">end</span>
1205   Screen(<span class="string">'Flip'</span>,winPtr,[],[],[],1);
1206 
1207   <span class="comment">% update task</span>
1208   cur_frames=cur_frames+1;
1209   <span class="keyword">if</span> task_flg(cur_frames-1)==2 &amp;&amp; task_flg(cur_frames-2)==1, event=event.add_event(<span class="string">'Luminance Task'</span>,[]); <span class="keyword">end</span>
1210 <span class="keyword">end</span>
1211 
1212 <span class="comment">% the final clock up</span>
1213 <span class="keyword">while</span> GetSecs()-the_experiment_start&lt;sum(sparam.initial_fixation_time)+sparam.numRepeats*numel(sparam.rotangles)*sparam.cycle_duration
1214   [resps,event]=resps.check_responses(event);
1215 <span class="keyword">end</span>
1216 
1217 
1218 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
1219 <span class="comment">%%%% Experiment &amp; scanner end here</span>
1220 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
1221 
1222 experimentDuration=GetSecs()-the_experiment_start;
1223 event=event.add_event(<span class="string">'End'</span>,[]);
1224 fprintf(<span class="string">'\n'</span>);
1225 fprintf(<span class="string">'Experiment Completed: %.2f/%.2f secs\n'</span>,experimentDuration,<span class="keyword">...</span>
1226         sum(sparam.initial_fixation_time)+sparam.numRepeats*numel(sparam.rotangles)*sparam.cycle_duration);
1227 fprintf(<span class="string">'\n'</span>);
1228 
1229 
1230 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
1231 <span class="comment">%%%% Cleaning up the PTB screen</span>
1232 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
1233 
1234 Screen(<span class="string">'CloseAll'</span>);
1235 
1236 <span class="comment">% closing datapixx</span>
1237 <span class="keyword">if</span> strcmpi(dparam.ExpMode,<span class="string">'propixxmono'</span>) || strcmpi(dparam.ExpMode,<span class="string">'propixxstereo'</span>)
1238   <span class="keyword">if</span> Datapixx(<span class="string">'IsViewpixx3D'</span>)
1239     Datapixx(<span class="string">'DisableVideoLcd3D60Hz'</span>);
1240     Datapixx(<span class="string">'RegWr'</span>);
1241   <span class="keyword">end</span>
1242   Datapixx(<span class="string">'Close'</span>);
1243 <span class="keyword">end</span>
1244 
1245 ShowCursor();
1246 Priority(0);
1247 <a href="../../Retinotopy/Common/GammaResetPTB.html" class="code" title="function GammaResetPTB(luminance_ratio)">GammaResetPTB</a>(1.0);
1248 
1249 
1250 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
1251 <span class="comment">%%%% Write data into file for post analysis</span>
1252 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
1253 
1254 <span class="comment">% saving the results</span>
1255 fprintf(<span class="string">'saving data...'</span>);
1256 
1257 <span class="comment">% save data</span>
1258 savefname=fullfile(resultDir,[num2str(subjID),<span class="string">'_ibar_fixtask_results_run_'</span>,num2str(acq,<span class="string">'%02d'</span>),<span class="string">'.mat'</span>]);
1259 
1260 <span class="comment">% backup the old file(s)</span>
1261 <span class="keyword">if</span> ~overwrite_flg
1262   <a href="../../Retinotopy/Common/BackUpObsoleteFiles.html" class="code" title="function [new_fname,backup_fname]=BackUpObsoleteFiles(tgt_dir,tgt_fname,backup_prefix)">BackUpObsoleteFiles</a>(fullfile(<span class="string">'subjects'</span>,num2str(subjID),<span class="string">'results'</span>,today),<span class="keyword">...</span>
1263                       [num2str(subjID),<span class="string">'_ibar_fixtask_results_run_'</span>,num2str(acq,<span class="string">'%02d'</span>),<span class="string">'.mat'</span>],<span class="string">'_old'</span>);
1264 <span class="keyword">end</span>
1265 
1266 eval(sprintf(<span class="string">'save %s subjID acq sparam dparam event gamma_table;'</span>,savefname));
1267 fprintf(<span class="string">'done.\n'</span>);
1268 
1269 <span class="comment">% calculate &amp; display task performance</span>
1270 fprintf(<span class="string">'calculating task accuracy...\n'</span>);
1271 correct_event=cell(2,1); <span class="keyword">for</span> ii=1:1:2, correct_event{ii}=sprintf(<span class="string">'key%d'</span>,ii); <span class="keyword">end</span>
1272 [task.numTasks,task.numHits,task.numErrors,task.numResponses,task.RT]=event.calc_accuracy(correct_event);
1273 event=event.get_event(); <span class="comment">% convert an event logger object to a cell data structure</span>
1274 eval(sprintf(<span class="string">'save -append %s event task;'</span>,savefname));
1275 fprintf(<span class="string">'done.\n'</span>);
1276 
1277 
1278 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
1279 <span class="comment">%%%% Removing path to the subfunctions, and finalizing the script</span>
1280 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
1281 
1282 rmpath(genpath(fullfile(rootDir,<span class="string">'..'</span>,<span class="string">'Common'</span>)));
1283 rmpath(fullfile(rootDir,<span class="string">'..'</span>,<span class="string">'Generation'</span>));
1284 clear all; clear mex; clear <span class="keyword">global</span>;
1285 diary off;
1286 
1287 
1288 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
1289 <span class="comment">%%%% tell the experimenter that the measurements are completed</span>
1290 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
1291 
1292 <span class="keyword">try</span>
1293   <span class="keyword">for</span> ii=1:1:3, Snd(<span class="string">'Play'</span>,sin(2*pi*0.2*(0:900)),8000); <span class="keyword">end</span>
1294 <span class="keyword">catch</span>
1295   <span class="comment">% do nothing</span>
1296 <span class="keyword">end</span>
1297 
1298 
1299 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
1300 <span class="comment">%%%% Catch the errors</span>
1301 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
1302 
1303 <span class="keyword">catch</span> lasterror
1304   <span class="comment">% this &quot;catch&quot; section executes in case of an error in the &quot;try&quot; section</span>
1305   <span class="comment">% above.  Importantly, it closes the onscreen window if its open.</span>
1306   Screen(<span class="string">'CloseAll'</span>);
1307 
1308   <span class="keyword">if</span> exist(<span class="string">'dparam'</span>,<span class="string">'var'</span>)
1309     <span class="keyword">if</span> <a href="../../Retinotopy/Common/isstructmember.html" class="code" title="function isFieldResult = isstructmember(inStruct, fieldName)">isstructmember</a>(dparam,<span class="string">'ExpMode'</span>)
1310       <span class="keyword">if</span> strcmpi(dparam.ExpMode,<span class="string">'propixxmono'</span>) || strcmpi(dparam.ExpMode,<span class="string">'propixxstereo'</span>)
1311         <span class="keyword">if</span> Datapixx(<span class="string">'IsViewpixx3D'</span>)
1312           Datapixx(<span class="string">'DisableVideoLcd3D60Hz'</span>);
1313           Datapixx(<span class="string">'RegWr'</span>);
1314         <span class="keyword">end</span>
1315         Datapixx(<span class="string">'Close'</span>);
1316       <span class="keyword">end</span>
1317     <span class="keyword">end</span>
1318   <span class="keyword">end</span>
1319 
1320   ShowCursor();
1321   Priority(0);
1322   <a href="../../Retinotopy/Common/GammaResetPTB.html" class="code" title="function GammaResetPTB(luminance_ratio)">GammaResetPTB</a>(1.0);
1323   tmp=lasterror; <span class="comment">%#ok</span>
1324   <span class="comment">%if exist('event','var'), event=event.get_event(); end %#ok % just for debugging</span>
1325   diary off;
1326   fprintf([<span class="string">'\nError detected and the program was terminated.\n'</span>,<span class="keyword">...</span>
1327            <span class="string">'To check error(s), please type ''tmp''.\n'</span>,<span class="keyword">...</span>
1328            <span class="string">'Please save the current variables now if you need.\n'</span>,<span class="keyword">...</span>
1329            <span class="string">'Then, quit by ''dbquit''\n'</span>]);
1330   keyboard;
1331   rmpath(genpath(fullfile(rootDir,<span class="string">'..'</span>,<span class="string">'Common'</span>)));
1332   rmpath(fullfile(rootDir,<span class="string">'..'</span>,<span class="string">'Generation'</span>));
1333   clear all; clear mex; clear <span class="keyword">global</span>;
1334   <span class="keyword">return</span>
1335 <span class="keyword">end</span> <span class="comment">% try..catch</span>
1336 
1337 
1338 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
1339 <span class="comment">%%%%% That's it - we're done</span>
1340 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
1341 <span class="keyword">return</span>;
1342 <span class="comment">% end % function ibar_fixtask</span></pre></div>
<hr><address>Generated on Wed 09-Jun-2021 15:37:02 by <strong><a href="http://www.artefact.tk/software/matlab/m2html/" target="_parent">m2html</a></strong> &copy; 2005 using a BVQX_hbtools customized template</address>
</body>
</html>