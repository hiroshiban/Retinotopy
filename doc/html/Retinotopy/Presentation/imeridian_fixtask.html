<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
                "http://www.w3.org/TR/REC-html40/loose.dtd">
<html>
<head>
  <title>Description of imeridian_fixtask</title>
  <meta name="keywords" content="imeridian_fixtask">
  <meta name="description" content="Object-image-defined dual wedge stimulus along horizontal/vertical meridians with fixation luminance change-detection tasks.">
  <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
  <meta name="generator" content="m2html &copy; 2005 Guillaume Flandin">
  <meta name="robots" content="index, follow">
  <link type="text/css" rel="stylesheet" href="../../m2html.css">
  <script type="text/javascript">
    if (top.frames.length == 0) { top.location = "../../index.html"; };
  </script>
</head>
<body>
<a name="_top"></a>
<!-- # Retinotopy --><!-- menu.html Presentation -->
<h1>imeridian_fixtask
</h1>

<h2><a name="_name"></a>PURPOSE <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
<div class="box"><strong>Object-image-defined dual wedge stimulus along horizontal/vertical meridians with fixation luminance change-detection tasks.</strong></div>

<h2><a name="_synopsis"></a>SYNOPSIS <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
<div class="box"><strong>function imeridian_fixtask(subjID,exp_mode,acq,displayfile,stimulusfile,gamma_table,overwrite_flg,force_proceed_flag) </strong></div>

<h2><a name="_description"></a>DESCRIPTION <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
<div class="fragment" style="background-image:url(../../hb_brain.png); background-position:right top"><pre class="comment"> Object-image-defined dual wedge stimulus along horizontal/vertical meridians with fixation luminance change-detection tasks.
 function imeridian_fixtask(subjID,exp_mode,acq,:displayfile,:stimulusfile,:gamma_table,:overwrite_flg,:force_proceed_flag)
 (: is optional)

 - This function generates and presents wedge stimulus along the horizontal and vertical
   visual field meridians, on which object images are randomly located with brownian noise
   images on its background.
   The stimulus can be used to measure cortical retinotopy and to delineate retinotopic
   borders using the standard phase-encoded or pRF (population receptive field) analysis techniques.

   Unlike the standard phase-encoded visual stimulation, this fucntion presents the checkerboards
   alond the horizontal or vertical visual meridians alternatively. Please use GLM for retinotopy
   analysis, not the conventional phase-encoded analysis technique.

   references : 1. Visuotopic cortical connectivity underlying attention revealed with white-matter tractography.
                   Greenberg AS, Verstynen T, Chiu YC, Yantis S, Schneider W, Behrmann M. (2012).
                   J Neurosci. 32(8), 2773-82.
                2. Parallel, multi-stage processing of colors, faces and shapes in macaque inferior temporal cortex.
                   Lafer-Sousa, R, Conway, BR. (2013). Nature Neuroscience, 16, 1870-1878.

 - This script shoud be used with MATLAB Psychtoolbox version 3 or above.

 - Luminance detection task: the central fixation point (default: white)
   randomly turns to gray. An observer has to press the button if s/he
   detects this luminance change. Response keys are defined in displayfile.

 [about the object images used in this function]
 The object images used in this function (stored in ~/Retinotopy/object_images/ as object_image_database.mat) are
 obtained and modified from the databases publicly available from http://konklab.fas.harvard.edu/#
 I sincerely express my gratitude to the developers, distributors, and scientists in Dr Talia Konkle's research group
 for their contributions to these databases. When you use this function for your research, please cite the original
 papers listed below.

 - Tripartite Organization of the Ventral Stream by Animacy and Object Size.
   Konkle, T., &amp; Caramazza, A. (2013). Journal of Neuroscience, 33 (25), 10235-42.

 - A real-world size organization of object responses in occipito-temporal cortex.
   Konkle. T., &amp; Oliva, A. (2012). Neuron, 74(6), 1114-24.

 - Visual long-term memory has a massive storage capacity for object details.
   Brady, T. F., Konkle, T., Alvarez, G. A. &amp; Oliva, A. (2008). Proceedings of the National Academy of Sciences USA, 105(38), 14325-9.

 - Conceptual distinctiveness supports detailed visual long-term memory.
   Konkle, T., Brady, T. F., Alvarez, G. A., &amp; Oliva, A. (2010). Journal of Experimental Psychology: General, 139(3), 558-578.

 - A Familiar Size Stroop Effect: Real-world size is an automatic property of object representation.
   Konkle, T., &amp; Oliva, A. (2012). Journal of Experimental Psychology: Human Perception &amp; Performance, 38, 561-9.

 [note]
 Behavioral task of (function_name)_fixtask is to detect changes of luminance
 of the central fixation point, while the task in (function_name) is to detect
 changes of luminance of one of the patches in the checkerboard stimuli.
 Here, the central fixation task is more easy to sustain the stable fixation
 on the center of the screen and may be suitable for naive/non-expert
 participants with minimizing unwilling eye movements. However, some studies
 have reported that attention to the target stimulus (checker-patch luminance
 change detection task) is required to get reliable retinotopic representations
 in higher-order visual areas.


 Created    : &quot;2019-03-05 17:07:56 ban&quot;
 Last Update: &quot;2021-06-07 17:17:19 ban&quot;



 [input variables]
 sujID         : ID of subject, string, such as 's01'
                 you also need to create a directory ./subjects/(subj) and put displayfile and stimulusfile there.
                 !!!!!!!!!!!!!!!!!! IMPORTANT NOTE !!!!!!!!!!!!!!!!!!!!!!!!
                 !!! if 'debug' (case insensitive) is included          !!!
                 !!! in subjID string, this program runs as DEBUG mode; !!!
                 !!! stimulus images are saved as *.png format at       !!!
                 !!! ~/Retinotopy/Presentation/images                   !!!
                 !!!!!!!!!!!!!!!!!! IMPORTANT NOTE !!!!!!!!!!!!!!!!!!!!!!!!

 exp_mode      : experiment mode acceptable in this script is only &quot;meridian&quot;
 acq           : acquisition number (design file number),
                 an integer, such as 1, 2, 3, ...
 displayfile   : (optional) display condition file,
                 *.m file, such as 'RetDepth_display_fmri.m'
                 the file should be located in ./subjects/(subj)/
 stimulusfile  : (optional) stimulus condition file,
                 *.m file, such as 'RetDepth_stimulus_exp1.m'
                 the file should be located in ./subjects/(subj)/
 gamma_table   : (optional) table(s) of gamma-corrected video input values (Color LookupTable).
                 256(8-bits) x 3(RGB) x 1(or 2,3,... when using multiple displays) matrix
                 or a *.mat file specified with a relative path format. e.g. '/gamma_table/gamma1.mat'
                 The *.mat should include a variable named &quot;gamma_table&quot; consists of a 256x3xN matrix.
                 if you use multiple (more than 1) displays and set a 256x3x1 gamma-table, the same
                 table will be applied to all displays. if the number of displays and gamma tables
                 are different (e.g. you have 3 displays and 256x3x!2! gamma-tables), the last
                 gamma_table will be applied to the second and third displays.
                 if empty, normalized gamma table (repmat(linspace(0.0,1.0,256),3,1)) will be applied.
 overwrite_flg : (optional) whether overwriting pre-existing result file. if 1, the previous result
                 file with the same acquisition number will be overwritten by the previous one.
                 if 0, the existing file will be backed-up by adding a prefix '_old' at the tail
                 of the file. 0 by default.
 force_proceed_flag : (optional) whether proceeding stimulus presentatin without waiting for
                 the experimenter response (e.g. presesing the ENTER key) or a trigger.
                 if 1, the stimulus presentation will be automatically carried on.

 !!! NOTICE !!!!
 displayfile &amp; stimulusfile should be located at
 ./subjects/(subjID)/
 as ./subjects/(subjID)/*_display_fmri.m
    ./subjects/(subjID)/*_stimuli.m


 [output variables]
 no output matlab variable.


 [output files]
 1. result file
    stored ./subjects/(subjID)/results/(date)
    as ./subjects/(subjID)/results/(date)/(subjID)_imeridian_fixtask_results_run_(run_num).mat


 [example]
 &gt;&gt; imeridian_fixtask('HB','meridian',1,'ret_display.m','ret_checker_stimulus_exp1.m')

 [About displayfile]
 The contents of the displayfile are as below.
 (The file includs 6 lines of headers and following display parameters)

 (an example of the displayfile)

 % ************************************************************
 % This is the display configuration file for the retinotopy stimuli
 % Programmed by Hiroshi Ban Nov 01 2013
 % ************************************************************

 % display mode, one of &quot;mono&quot;, &quot;dual&quot;, &quot;dualcross&quot;, &quot;dualparallel&quot;, &quot;cross&quot;, &quot;parallel&quot;, &quot;redgreen&quot;, &quot;greenred&quot;,
 % &quot;redblue&quot;, &quot;bluered&quot;, &quot;shutter&quot;, &quot;topbottom&quot;, &quot;bottomtop&quot;, &quot;interleavedline&quot;, &quot;interleavedcolumn&quot;, &quot;propixxmono&quot;, &quot;propixxstereo&quot;
 dparam.ExpMode='mono';

 dparam.scrID=1; % screen ID, generally 0 for a single display setup, 1 for dual display setup

 % a method to start stimulus presentation
 % 0:ENTER/SPACE, 1:Left-mouse button, 2:the first MR trigger pulse (CiNet),
 % 3:waiting for a MR trigger pulse (BUIC) -- checking onset of pin #11 of the parallel port,
 % or 4:custom key trigger (wait for a key input that you specify as tgt_key).
 dparam.start_method=2;

 % a pseudo trigger key from the MR scanner when it starts, valid only when dparam.start_method=4;
 dparam.custom_trigger='t';

 % keyboard settings
 dparam.Key1=51; % key 1 (left)
 dparam.Key2=52; % key 2 (right)

 % screen settings

 %%% whether displaying the stimuli in full-screen mode or
 %%% as is (the precise resolution), 'true' or 'false' (true)
 dparam.fullscr=false;

 %%% the resolution of the screen height
 dparam.ScrHeight=1200;

 %% the resolution of the screen width
 dparam.ScrWidth=1920;

 % whether forcing to use specific frame rate, if 0, the frame rate wil bw computed in the ImagesShowPTB function.
 % if non zero, the value is used as the screen frame rate.
 dparam.force_frame_rate=60;

 % whther skipping the PTB's vertical-sync signal test. if 1, the sync test is skipped
 dparam.skip_sync_test=0;


 [About stimulusfile]
 The contents of the stimulusfile are as below.
 (The file includs 6 lines of headers and following stimulus parameters)

 (an example of the stimulusfile)

 % ************************************************************
 % This is the stimulus parameter file for the imeridian retinotopy stimulus
 % Programmed by Hiroshi Ban Dec 12 2018
 % ************************************************************

 % &quot;sparam&quot; means &quot;stimulus generation parameters&quot;

 %%% stimulus parameters
 sparam.width       = 24;    % wedge width in deg along polar angle

 sparam.maxRad      = 8;     % maximum radius of  annulus (degrees)
 sparam.minRad      = 0;     % minumum

 %%% duration in msec for each cycle &amp; repetitions
 % Here, the stimulus presentation protocol is defined as below.
 % initial_fixation_time(1) ---&gt; block_duration-rest_duration (the wedge along the horizontal visual meridian) ---&gt; rest_duration (blank) ---&gt;
 %   block_duration-rest_duration (the wedge along the vertical) ---&gt; rest_duration (blank) ---&gt; block_duration-rest_duration (the wedge along the horizontal) ---&gt;
 %     rest_duration (blank) ---&gt; block_duration-rest_duration (the wedge along the vertical) ---&gt; ... (repeated numRepeats in total) ---&gt; initial_fixation_time(2)
 % Therefore, one_stimulation_cycle = block_duration x 2 (note: in this period, stimulation = block_duration-rest_duration)

 sparam.block_duration=16000; % msec
 sparam.rest_duration =0; % msec, rest after each block
 sparam.numRepeats=6;

 %%% parameters used only for object-image-based retinotopy stimuli
 sparam.flip_duration=250; % msec
 sparam.nimg=120; % number of images to be presented at a frame
 sparam.imRatio=[0.2,0.5]; % image magnification ratio, [min, max] (0.0-1.0), the image sizes are randomly selected whithin this range
 sparam.imdepth=[-12,12]; % disparities (arcmins) added to the images, effective only in a stereo mode (e.g. shutter, dual, parallel etc)

 %%% set number of frames to flip the screen
 % Here, I set the number as large as I can to minimize vertical cynching error.
 % the final 2 is for 2 times repetitions of the flicker
 % Set 1 if you want to flip the display at each vertical sync, but not recommended as it uses much CPU power
 sparam.waitframes = 60*(sparam.block_duration/1000) / ((sparam.block_duration-sparam.rest_duration)/1000) / ( (size(sparam.colors,1)-1)*2 );

 %%% fixation period in msec before/after presenting the target stimuli, integer
 % must set a value more than 1 TR for initializing the frame counting.
 sparam.initial_fixation_time=[4000,4000];

 %%% fixation size &amp; color
 sparam.fixtype=1; % 1: circular, 2: rectangular, 3: concentric fixation point
 sparam.fixsize=12; % radius in pixels
 sparam.fixcolor=[255,255,255];

 %%% background color
 sparam.bgcolor=[128,128,128];

 %%% background-patch colors (RGB)
 sparam.bgtype=1; % 1: a simple background with sparam.bgcolor (then, the parameters belows are not used), 2: a background with grid guides
 sparam.patch_size=[30,30]; % background patch size, [height,width] in pixels
 sparam.patch_num=[20,40];  % the number of background patches along vertical and horizontal axis
 sparam.patch_color1=[255,255,255];
 sparam.patch_color2=[0,0,0];

 %%% for converting degree to pixels
 run(fullfile(fileparts(mfilename('fullpath')),'sizeparams'));
 %sparam.pix_per_cm=57.1429;
 %sparam.vdist=65;
 %sparam.ipd=6.5;


 [HOWTO create stimulus files]
 1. All of the stimuli are created in this script in real-time
    with MATLAB scripts &amp; functions.
    see ../Generation &amp; ../Common directries.
 2. Stimulus parameters are defined in the display &amp; stimulus file.


 [reference]
 for stmulus generation, see ../Generation &amp; ../Common directories.</pre></div>

<!-- crossreference -->
<h2><a name="_cross"></a>CROSS-REFERENCE INFORMATION <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
<div class="fragment" style="background-image:url(../../hb_brain.png); background-position:right top">
This function calls:
<ul style="list-style-image:url(../../matlabicon.gif)">
<li><a href="../../Retinotopy/Common/BackUpObsoleteFiles.html" class="code" title="function [new_fname,backup_fname]=BackUpObsoleteFiles(tgt_dir,tgt_fname,backup_prefix)">BackUpObsoleteFiles</a>	Backups already-existing file(s) in the target directory by adding some file-prefix.</li><li><a href="../../Retinotopy/Common/CalcDistFromDisparity.html" class="code" title="function zdist = CalcDistFromDisparity(ipd,disparity,viewdist)">CalcDistFromDisparity</a>	Calculates the actual distance (cm) from binocular disparity (arcmin).</li><li><a href="../../Retinotopy/Common/CheckPTBversion.html" class="code" title="function [PTB_OK,vertxt] = CheckPTBversion(num_mainver_youwant)">CheckPTBversion</a>	Checks the version of the currently running Psychtoolbox.</li><li><a href="../../Retinotopy/Common/CreateBackgroundImage.html" class="code" title="function [Bimg,parameters] = CreateBackgroundImage(wdims,stdims,pdims,bgcolor,color1,color2,fixcolor,patchnum,fix_flag,save_flag,show_flag)">CreateBackgroundImage</a>	Creates background image that can be used as a background of your stimulus displays.</li><li><a href="../../Retinotopy/Common/CreateColoredNoise.html" class="code" title="function img=CreateColoredNoise(idims,sdims,num,beta,norm_flg,save_flg,show_flg)">CreateColoredNoise</a>	Creates colored (i.e. pink, brown(ian), blue, and white) noise image(s).</li><li><a href="../../Retinotopy/Common/CreateFixationImgCircular.html" class="code" title="function fix=CreateFixationImgCircular(fixsize,fixcolor,bgcolor,circlesize,show_flag,save_flag)">CreateFixationImgCircular</a>	Creates a circular fixation image for a monocular display setting.</li><li><a href="../../Retinotopy/Common/CreateFixationImgConcentrateMono.html" class="code" title="function fix=CreateFixationImgConcentrateMono(fixsize,fixcolor,bgcolor,circlesize,gap,show_flag,save_flag)">CreateFixationImgConcentrateMono</a>	Creates a circular fixation image for a monocular display setting.</li><li><a href="../../Retinotopy/Common/CreateFixationImgMono.html" class="code" title="function fix=CreateFixationImgMono(fixsize,fixcolor,bgcolor,fixlinew,fixlineh,show_flag,save_flag)">CreateFixationImgMono</a>	Creates a cross-shaped fixation image for a monocular display setting.</li><li><a href="../../Retinotopy/Common/DisplayMessage2.html" class="code" title="function DisplayMessage2(message,bgcolor,winPtr,numScreens,drawing_font,drawing_size)">DisplayMessage2</a>	Displays message on the center of each of multiple PTB windows.</li><li><a href="../../Retinotopy/Common/GammaLoadPTB.html" class="code" title="function GammaLoadPTB(gamma_table)">GammaLoadPTB</a>	Loads and sets display gamma-table(s) using PTB Screen() function.</li><li><a href="../../Retinotopy/Common/GammaResetPTB.html" class="code" title="function GammaResetPTB(luminance_ratio)">GammaResetPTB</a>	Resets display gamma with PTB Screen() function.</li><li><a href="../../Retinotopy/Common/InitializePTBDisplays.html" class="code" title="function [winPtr,winRect,nScr,fps,ifi,initDisplay_OK]=InitializePTBDisplays(disp_mode,bgcolor,flipping,rgb_gains,custom_scrIDs)">InitializePTBDisplays</a>	Initializes PTB screen(s) for monocular/binocular presentations using PsychImaging() function.</li><li><a href="../../Retinotopy/Common/InitializeRandomSeed.html" class="code" title="function cseed=InitializeRandomSeed">InitializeRandomSeed</a>	Initializes MATLAB internal state of a random seed.</li><li><a href="../../Retinotopy/Common/ValidateStructureFields.html" class="code" title="function structval=ValidateStructureFields(structval,varargin)">ValidateStructureFields</a>	Validates the input structure and set the default values to the missing field(s)</li><li><a href="../../Retinotopy/Common/eventlogger.html" class="code" title="">eventlogger</a>	</li><li><a href="../../Retinotopy/Common/isstructmember.html" class="code" title="function isFieldResult = isstructmember(inStruct, fieldName)">isstructmember</a>	Checks whether the target struct contains a filed you specified as a member.</li><li><a href="../../Retinotopy/Common/responselogger.html" class="code" title="">responselogger</a>	</li><li><a href="../../Retinotopy/Common/shuffle.html" class="code" title="function [Y,index] = shuffle(X)">shuffle</a>	Randomly sorts the input array.</li><li><a href="../../Retinotopy/Generation/pol_GenerateCheckerBoard1D.html" class="code" title="function [checkerboard,bincheckerboard,mask]=pol_GenerateCheckerBoard1D(rmin,rmax,width,startangle,pix_per_deg,nwedges,nrings,phase,dual_flg)">pol_GenerateCheckerBoard1D</a>	Generates checkerboard patterns (polar angle-based subdivision) with an individual ID number on each patch.</li></ul>
This function is called by:
<ul style="list-style-image:url(../../matlabicon.gif)">
</ul>
</div>
<!-- crossreference -->



<h2><a name="_source"></a>SOURCE CODE <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
<div class="fragment" style="background-image:url(../../hb_brain.png); background-position:right top"><pre>0001 <a name="_sub0" href="#_subfunctions" class="code">function imeridian_fixtask(subjID,exp_mode,acq,displayfile,stimulusfile,gamma_table,overwrite_flg,force_proceed_flag)</a>
0002 
0003 <span class="comment">% Object-image-defined dual wedge stimulus along horizontal/vertical meridians with fixation luminance change-detection tasks.</span>
0004 <span class="comment">% function imeridian_fixtask(subjID,exp_mode,acq,:displayfile,:stimulusfile,:gamma_table,:overwrite_flg,:force_proceed_flag)</span>
0005 <span class="comment">% (: is optional)</span>
0006 <span class="comment">%</span>
0007 <span class="comment">% - This function generates and presents wedge stimulus along the horizontal and vertical</span>
0008 <span class="comment">%   visual field meridians, on which object images are randomly located with brownian noise</span>
0009 <span class="comment">%   images on its background.</span>
0010 <span class="comment">%   The stimulus can be used to measure cortical retinotopy and to delineate retinotopic</span>
0011 <span class="comment">%   borders using the standard phase-encoded or pRF (population receptive field) analysis techniques.</span>
0012 <span class="comment">%</span>
0013 <span class="comment">%   Unlike the standard phase-encoded visual stimulation, this fucntion presents the checkerboards</span>
0014 <span class="comment">%   alond the horizontal or vertical visual meridians alternatively. Please use GLM for retinotopy</span>
0015 <span class="comment">%   analysis, not the conventional phase-encoded analysis technique.</span>
0016 <span class="comment">%</span>
0017 <span class="comment">%   references : 1. Visuotopic cortical connectivity underlying attention revealed with white-matter tractography.</span>
0018 <span class="comment">%                   Greenberg AS, Verstynen T, Chiu YC, Yantis S, Schneider W, Behrmann M. (2012).</span>
0019 <span class="comment">%                   J Neurosci. 32(8), 2773-82.</span>
0020 <span class="comment">%                2. Parallel, multi-stage processing of colors, faces and shapes in macaque inferior temporal cortex.</span>
0021 <span class="comment">%                   Lafer-Sousa, R, Conway, BR. (2013). Nature Neuroscience, 16, 1870-1878.</span>
0022 <span class="comment">%</span>
0023 <span class="comment">% - This script shoud be used with MATLAB Psychtoolbox version 3 or above.</span>
0024 <span class="comment">%</span>
0025 <span class="comment">% - Luminance detection task: the central fixation point (default: white)</span>
0026 <span class="comment">%   randomly turns to gray. An observer has to press the button if s/he</span>
0027 <span class="comment">%   detects this luminance change. Response keys are defined in displayfile.</span>
0028 <span class="comment">%</span>
0029 <span class="comment">% [about the object images used in this function]</span>
0030 <span class="comment">% The object images used in this function (stored in ~/Retinotopy/object_images/ as object_image_database.mat) are</span>
0031 <span class="comment">% obtained and modified from the databases publicly available from http://konklab.fas.harvard.edu/#</span>
0032 <span class="comment">% I sincerely express my gratitude to the developers, distributors, and scientists in Dr Talia Konkle's research group</span>
0033 <span class="comment">% for their contributions to these databases. When you use this function for your research, please cite the original</span>
0034 <span class="comment">% papers listed below.</span>
0035 <span class="comment">%</span>
0036 <span class="comment">% - Tripartite Organization of the Ventral Stream by Animacy and Object Size.</span>
0037 <span class="comment">%   Konkle, T., &amp; Caramazza, A. (2013). Journal of Neuroscience, 33 (25), 10235-42.</span>
0038 <span class="comment">%</span>
0039 <span class="comment">% - A real-world size organization of object responses in occipito-temporal cortex.</span>
0040 <span class="comment">%   Konkle. T., &amp; Oliva, A. (2012). Neuron, 74(6), 1114-24.</span>
0041 <span class="comment">%</span>
0042 <span class="comment">% - Visual long-term memory has a massive storage capacity for object details.</span>
0043 <span class="comment">%   Brady, T. F., Konkle, T., Alvarez, G. A. &amp; Oliva, A. (2008). Proceedings of the National Academy of Sciences USA, 105(38), 14325-9.</span>
0044 <span class="comment">%</span>
0045 <span class="comment">% - Conceptual distinctiveness supports detailed visual long-term memory.</span>
0046 <span class="comment">%   Konkle, T., Brady, T. F., Alvarez, G. A., &amp; Oliva, A. (2010). Journal of Experimental Psychology: General, 139(3), 558-578.</span>
0047 <span class="comment">%</span>
0048 <span class="comment">% - A Familiar Size Stroop Effect: Real-world size is an automatic property of object representation.</span>
0049 <span class="comment">%   Konkle, T., &amp; Oliva, A. (2012). Journal of Experimental Psychology: Human Perception &amp; Performance, 38, 561-9.</span>
0050 <span class="comment">%</span>
0051 <span class="comment">% [note]</span>
0052 <span class="comment">% Behavioral task of (function_name)_fixtask is to detect changes of luminance</span>
0053 <span class="comment">% of the central fixation point, while the task in (function_name) is to detect</span>
0054 <span class="comment">% changes of luminance of one of the patches in the checkerboard stimuli.</span>
0055 <span class="comment">% Here, the central fixation task is more easy to sustain the stable fixation</span>
0056 <span class="comment">% on the center of the screen and may be suitable for naive/non-expert</span>
0057 <span class="comment">% participants with minimizing unwilling eye movements. However, some studies</span>
0058 <span class="comment">% have reported that attention to the target stimulus (checker-patch luminance</span>
0059 <span class="comment">% change detection task) is required to get reliable retinotopic representations</span>
0060 <span class="comment">% in higher-order visual areas.</span>
0061 <span class="comment">%</span>
0062 <span class="comment">%</span>
0063 <span class="comment">% Created    : &quot;2019-03-05 17:07:56 ban&quot;</span>
0064 <span class="comment">% Last Update: &quot;2021-06-07 17:17:19 ban&quot;</span>
0065 <span class="comment">%</span>
0066 <span class="comment">%</span>
0067 <span class="comment">%</span>
0068 <span class="comment">% [input variables]</span>
0069 <span class="comment">% sujID         : ID of subject, string, such as 's01'</span>
0070 <span class="comment">%                 you also need to create a directory ./subjects/(subj) and put displayfile and stimulusfile there.</span>
0071 <span class="comment">%                 !!!!!!!!!!!!!!!!!! IMPORTANT NOTE !!!!!!!!!!!!!!!!!!!!!!!!</span>
0072 <span class="comment">%                 !!! if 'debug' (case insensitive) is included          !!!</span>
0073 <span class="comment">%                 !!! in subjID string, this program runs as DEBUG mode; !!!</span>
0074 <span class="comment">%                 !!! stimulus images are saved as *.png format at       !!!</span>
0075 <span class="comment">%                 !!! ~/Retinotopy/Presentation/images                   !!!</span>
0076 <span class="comment">%                 !!!!!!!!!!!!!!!!!! IMPORTANT NOTE !!!!!!!!!!!!!!!!!!!!!!!!</span>
0077 <span class="comment">%</span>
0078 <span class="comment">% exp_mode      : experiment mode acceptable in this script is only &quot;meridian&quot;</span>
0079 <span class="comment">% acq           : acquisition number (design file number),</span>
0080 <span class="comment">%                 an integer, such as 1, 2, 3, ...</span>
0081 <span class="comment">% displayfile   : (optional) display condition file,</span>
0082 <span class="comment">%                 *.m file, such as 'RetDepth_display_fmri.m'</span>
0083 <span class="comment">%                 the file should be located in ./subjects/(subj)/</span>
0084 <span class="comment">% stimulusfile  : (optional) stimulus condition file,</span>
0085 <span class="comment">%                 *.m file, such as 'RetDepth_stimulus_exp1.m'</span>
0086 <span class="comment">%                 the file should be located in ./subjects/(subj)/</span>
0087 <span class="comment">% gamma_table   : (optional) table(s) of gamma-corrected video input values (Color LookupTable).</span>
0088 <span class="comment">%                 256(8-bits) x 3(RGB) x 1(or 2,3,... when using multiple displays) matrix</span>
0089 <span class="comment">%                 or a *.mat file specified with a relative path format. e.g. '/gamma_table/gamma1.mat'</span>
0090 <span class="comment">%                 The *.mat should include a variable named &quot;gamma_table&quot; consists of a 256x3xN matrix.</span>
0091 <span class="comment">%                 if you use multiple (more than 1) displays and set a 256x3x1 gamma-table, the same</span>
0092 <span class="comment">%                 table will be applied to all displays. if the number of displays and gamma tables</span>
0093 <span class="comment">%                 are different (e.g. you have 3 displays and 256x3x!2! gamma-tables), the last</span>
0094 <span class="comment">%                 gamma_table will be applied to the second and third displays.</span>
0095 <span class="comment">%                 if empty, normalized gamma table (repmat(linspace(0.0,1.0,256),3,1)) will be applied.</span>
0096 <span class="comment">% overwrite_flg : (optional) whether overwriting pre-existing result file. if 1, the previous result</span>
0097 <span class="comment">%                 file with the same acquisition number will be overwritten by the previous one.</span>
0098 <span class="comment">%                 if 0, the existing file will be backed-up by adding a prefix '_old' at the tail</span>
0099 <span class="comment">%                 of the file. 0 by default.</span>
0100 <span class="comment">% force_proceed_flag : (optional) whether proceeding stimulus presentatin without waiting for</span>
0101 <span class="comment">%                 the experimenter response (e.g. presesing the ENTER key) or a trigger.</span>
0102 <span class="comment">%                 if 1, the stimulus presentation will be automatically carried on.</span>
0103 <span class="comment">%</span>
0104 <span class="comment">% !!! NOTICE !!!!</span>
0105 <span class="comment">% displayfile &amp; stimulusfile should be located at</span>
0106 <span class="comment">% ./subjects/(subjID)/</span>
0107 <span class="comment">% as ./subjects/(subjID)/*_display_fmri.m</span>
0108 <span class="comment">%    ./subjects/(subjID)/*_stimuli.m</span>
0109 <span class="comment">%</span>
0110 <span class="comment">%</span>
0111 <span class="comment">% [output variables]</span>
0112 <span class="comment">% no output matlab variable.</span>
0113 <span class="comment">%</span>
0114 <span class="comment">%</span>
0115 <span class="comment">% [output files]</span>
0116 <span class="comment">% 1. result file</span>
0117 <span class="comment">%    stored ./subjects/(subjID)/results/(date)</span>
0118 <span class="comment">%    as ./subjects/(subjID)/results/(date)/(subjID)_imeridian_fixtask_results_run_(run_num).mat</span>
0119 <span class="comment">%</span>
0120 <span class="comment">%</span>
0121 <span class="comment">% [example]</span>
0122 <span class="comment">% &gt;&gt; imeridian_fixtask('HB','meridian',1,'ret_display.m','ret_checker_stimulus_exp1.m')</span>
0123 <span class="comment">%</span>
0124 <span class="comment">% [About displayfile]</span>
0125 <span class="comment">% The contents of the displayfile are as below.</span>
0126 <span class="comment">% (The file includs 6 lines of headers and following display parameters)</span>
0127 <span class="comment">%</span>
0128 <span class="comment">% (an example of the displayfile)</span>
0129 <span class="comment">%</span>
0130 <span class="comment">% % ************************************************************</span>
0131 <span class="comment">% % This is the display configuration file for the retinotopy stimuli</span>
0132 <span class="comment">% % Programmed by Hiroshi Ban Nov 01 2013</span>
0133 <span class="comment">% % ************************************************************</span>
0134 <span class="comment">%</span>
0135 <span class="comment">% % display mode, one of &quot;mono&quot;, &quot;dual&quot;, &quot;dualcross&quot;, &quot;dualparallel&quot;, &quot;cross&quot;, &quot;parallel&quot;, &quot;redgreen&quot;, &quot;greenred&quot;,</span>
0136 <span class="comment">% % &quot;redblue&quot;, &quot;bluered&quot;, &quot;shutter&quot;, &quot;topbottom&quot;, &quot;bottomtop&quot;, &quot;interleavedline&quot;, &quot;interleavedcolumn&quot;, &quot;propixxmono&quot;, &quot;propixxstereo&quot;</span>
0137 <span class="comment">% dparam.ExpMode='mono';</span>
0138 <span class="comment">%</span>
0139 <span class="comment">% dparam.scrID=1; % screen ID, generally 0 for a single display setup, 1 for dual display setup</span>
0140 <span class="comment">%</span>
0141 <span class="comment">% % a method to start stimulus presentation</span>
0142 <span class="comment">% % 0:ENTER/SPACE, 1:Left-mouse button, 2:the first MR trigger pulse (CiNet),</span>
0143 <span class="comment">% % 3:waiting for a MR trigger pulse (BUIC) -- checking onset of pin #11 of the parallel port,</span>
0144 <span class="comment">% % or 4:custom key trigger (wait for a key input that you specify as tgt_key).</span>
0145 <span class="comment">% dparam.start_method=2;</span>
0146 <span class="comment">%</span>
0147 <span class="comment">% % a pseudo trigger key from the MR scanner when it starts, valid only when dparam.start_method=4;</span>
0148 <span class="comment">% dparam.custom_trigger='t';</span>
0149 <span class="comment">%</span>
0150 <span class="comment">% % keyboard settings</span>
0151 <span class="comment">% dparam.Key1=51; % key 1 (left)</span>
0152 <span class="comment">% dparam.Key2=52; % key 2 (right)</span>
0153 <span class="comment">%</span>
0154 <span class="comment">% % screen settings</span>
0155 <span class="comment">%</span>
0156 <span class="comment">% %%% whether displaying the stimuli in full-screen mode or</span>
0157 <span class="comment">% %%% as is (the precise resolution), 'true' or 'false' (true)</span>
0158 <span class="comment">% dparam.fullscr=false;</span>
0159 <span class="comment">%</span>
0160 <span class="comment">% %%% the resolution of the screen height</span>
0161 <span class="comment">% dparam.ScrHeight=1200;</span>
0162 <span class="comment">%</span>
0163 <span class="comment">% %% the resolution of the screen width</span>
0164 <span class="comment">% dparam.ScrWidth=1920;</span>
0165 <span class="comment">%</span>
0166 <span class="comment">% % whether forcing to use specific frame rate, if 0, the frame rate wil bw computed in the ImagesShowPTB function.</span>
0167 <span class="comment">% % if non zero, the value is used as the screen frame rate.</span>
0168 <span class="comment">% dparam.force_frame_rate=60;</span>
0169 <span class="comment">%</span>
0170 <span class="comment">% % whther skipping the PTB's vertical-sync signal test. if 1, the sync test is skipped</span>
0171 <span class="comment">% dparam.skip_sync_test=0;</span>
0172 <span class="comment">%</span>
0173 <span class="comment">%</span>
0174 <span class="comment">% [About stimulusfile]</span>
0175 <span class="comment">% The contents of the stimulusfile are as below.</span>
0176 <span class="comment">% (The file includs 6 lines of headers and following stimulus parameters)</span>
0177 <span class="comment">%</span>
0178 <span class="comment">% (an example of the stimulusfile)</span>
0179 <span class="comment">%</span>
0180 <span class="comment">% % ************************************************************</span>
0181 <span class="comment">% % This is the stimulus parameter file for the imeridian retinotopy stimulus</span>
0182 <span class="comment">% % Programmed by Hiroshi Ban Dec 12 2018</span>
0183 <span class="comment">% % ************************************************************</span>
0184 <span class="comment">%</span>
0185 <span class="comment">% % &quot;sparam&quot; means &quot;stimulus generation parameters&quot;</span>
0186 <span class="comment">%</span>
0187 <span class="comment">% %%% stimulus parameters</span>
0188 <span class="comment">% sparam.width       = 24;    % wedge width in deg along polar angle</span>
0189 <span class="comment">%</span>
0190 <span class="comment">% sparam.maxRad      = 8;     % maximum radius of  annulus (degrees)</span>
0191 <span class="comment">% sparam.minRad      = 0;     % minumum</span>
0192 <span class="comment">%</span>
0193 <span class="comment">% %%% duration in msec for each cycle &amp; repetitions</span>
0194 <span class="comment">% % Here, the stimulus presentation protocol is defined as below.</span>
0195 <span class="comment">% % initial_fixation_time(1) ---&gt; block_duration-rest_duration (the wedge along the horizontal visual meridian) ---&gt; rest_duration (blank) ---&gt;</span>
0196 <span class="comment">% %   block_duration-rest_duration (the wedge along the vertical) ---&gt; rest_duration (blank) ---&gt; block_duration-rest_duration (the wedge along the horizontal) ---&gt;</span>
0197 <span class="comment">% %     rest_duration (blank) ---&gt; block_duration-rest_duration (the wedge along the vertical) ---&gt; ... (repeated numRepeats in total) ---&gt; initial_fixation_time(2)</span>
0198 <span class="comment">% % Therefore, one_stimulation_cycle = block_duration x 2 (note: in this period, stimulation = block_duration-rest_duration)</span>
0199 <span class="comment">%</span>
0200 <span class="comment">% sparam.block_duration=16000; % msec</span>
0201 <span class="comment">% sparam.rest_duration =0; % msec, rest after each block</span>
0202 <span class="comment">% sparam.numRepeats=6;</span>
0203 <span class="comment">%</span>
0204 <span class="comment">% %%% parameters used only for object-image-based retinotopy stimuli</span>
0205 <span class="comment">% sparam.flip_duration=250; % msec</span>
0206 <span class="comment">% sparam.nimg=120; % number of images to be presented at a frame</span>
0207 <span class="comment">% sparam.imRatio=[0.2,0.5]; % image magnification ratio, [min, max] (0.0-1.0), the image sizes are randomly selected whithin this range</span>
0208 <span class="comment">% sparam.imdepth=[-12,12]; % disparities (arcmins) added to the images, effective only in a stereo mode (e.g. shutter, dual, parallel etc)</span>
0209 <span class="comment">%</span>
0210 <span class="comment">% %%% set number of frames to flip the screen</span>
0211 <span class="comment">% % Here, I set the number as large as I can to minimize vertical cynching error.</span>
0212 <span class="comment">% % the final 2 is for 2 times repetitions of the flicker</span>
0213 <span class="comment">% % Set 1 if you want to flip the display at each vertical sync, but not recommended as it uses much CPU power</span>
0214 <span class="comment">% sparam.waitframes = 60*(sparam.block_duration/1000) / ((sparam.block_duration-sparam.rest_duration)/1000) / ( (size(sparam.colors,1)-1)*2 );</span>
0215 <span class="comment">%</span>
0216 <span class="comment">% %%% fixation period in msec before/after presenting the target stimuli, integer</span>
0217 <span class="comment">% % must set a value more than 1 TR for initializing the frame counting.</span>
0218 <span class="comment">% sparam.initial_fixation_time=[4000,4000];</span>
0219 <span class="comment">%</span>
0220 <span class="comment">% %%% fixation size &amp; color</span>
0221 <span class="comment">% sparam.fixtype=1; % 1: circular, 2: rectangular, 3: concentric fixation point</span>
0222 <span class="comment">% sparam.fixsize=12; % radius in pixels</span>
0223 <span class="comment">% sparam.fixcolor=[255,255,255];</span>
0224 <span class="comment">%</span>
0225 <span class="comment">% %%% background color</span>
0226 <span class="comment">% sparam.bgcolor=[128,128,128];</span>
0227 <span class="comment">%</span>
0228 <span class="comment">% %%% background-patch colors (RGB)</span>
0229 <span class="comment">% sparam.bgtype=1; % 1: a simple background with sparam.bgcolor (then, the parameters belows are not used), 2: a background with grid guides</span>
0230 <span class="comment">% sparam.patch_size=[30,30]; % background patch size, [height,width] in pixels</span>
0231 <span class="comment">% sparam.patch_num=[20,40];  % the number of background patches along vertical and horizontal axis</span>
0232 <span class="comment">% sparam.patch_color1=[255,255,255];</span>
0233 <span class="comment">% sparam.patch_color2=[0,0,0];</span>
0234 <span class="comment">%</span>
0235 <span class="comment">% %%% for converting degree to pixels</span>
0236 <span class="comment">% run(fullfile(fileparts(mfilename('fullpath')),'sizeparams'));</span>
0237 <span class="comment">% %sparam.pix_per_cm=57.1429;</span>
0238 <span class="comment">% %sparam.vdist=65;</span>
0239 <span class="comment">% %sparam.ipd=6.5;</span>
0240 <span class="comment">%</span>
0241 <span class="comment">%</span>
0242 <span class="comment">% [HOWTO create stimulus files]</span>
0243 <span class="comment">% 1. All of the stimuli are created in this script in real-time</span>
0244 <span class="comment">%    with MATLAB scripts &amp; functions.</span>
0245 <span class="comment">%    see ../Generation &amp; ../Common directries.</span>
0246 <span class="comment">% 2. Stimulus parameters are defined in the display &amp; stimulus file.</span>
0247 <span class="comment">%</span>
0248 <span class="comment">%</span>
0249 <span class="comment">% [reference]</span>
0250 <span class="comment">% for stmulus generation, see ../Generation &amp; ../Common directories.</span>
0251 
0252 
0253 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0254 <span class="comment">%%%% Check the input variables</span>
0255 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0256 
0257 clear <span class="keyword">global</span>; clear mex;
0258 <span class="keyword">if</span> nargin&lt;3, help(mfilename()); <span class="keyword">return</span>; <span class="keyword">end</span>
0259 <span class="keyword">if</span> nargin&lt;4 || isempty(displayfile), displayfile=[]; <span class="keyword">end</span>
0260 <span class="keyword">if</span> nargin&lt;5 || isempty(stimulusfile), stimulusfile=[]; <span class="keyword">end</span>
0261 <span class="keyword">if</span> nargin&lt;6 || isempty(gamma_table), gamma_table=[]; <span class="keyword">end</span>
0262 <span class="keyword">if</span> nargin&lt;7 || isempty(overwrite_flg), overwrite_flg=1; <span class="keyword">end</span>
0263 <span class="keyword">if</span> nargin&lt;8 || isempty(force_proceed_flag), force_proceed_flag=0; <span class="keyword">end</span>
0264 
0265 <span class="comment">% check the aqcuisition number</span>
0266 <span class="keyword">if</span> acq&lt;1, error(<span class="string">'Acquistion number must be integer and greater than zero'</span>); <span class="keyword">end</span>
0267 
0268 <span class="comment">% check the experiment mode (stimulus type)</span>
0269 <span class="keyword">if</span> ~strcmpi(exp_mode,<span class="string">'meridian'</span>), error(<span class="string">'exp_mode acceptable in this script is only &quot;meridian&quot;. check the input variable.'</span>); <span class="keyword">end</span>
0270 
0271 rootDir=fileparts(mfilename(<span class="string">'fullpath'</span>));
0272 
0273 <span class="comment">% check the subject directory</span>
0274 <span class="keyword">if</span> ~exist(fullfile(rootDir,<span class="string">'subjects'</span>,subjID),<span class="string">'dir'</span>), error(<span class="string">'can not find subj directory. check the input variable.'</span>); <span class="keyword">end</span>
0275 
0276 <span class="comment">% check the display/stimulus files</span>
0277 <span class="keyword">if</span> ~isempty(displayfile)
0278   <span class="keyword">if</span> ~strcmpi(displayfile(end-1:end),<span class="string">'.m'</span>), displayfile=[displayfile,<span class="string">'.m'</span>]; <span class="keyword">end</span>
0279   <span class="keyword">if</span> ~exist(fullfile(rootDir,<span class="string">'subjects'</span>,subjID,displayfile),<span class="string">'file'</span>), error(<span class="string">'displayfile not found. check the input variable.'</span>); <span class="keyword">end</span>
0280 <span class="keyword">end</span>
0281 
0282 <span class="keyword">if</span> ~isempty(stimulusfile)
0283   <span class="keyword">if</span> ~strcmpi(stimulusfile(end-1:end),<span class="string">'.m'</span>), stimulusfile=[stimulusfile,<span class="string">'.m'</span>]; <span class="keyword">end</span>
0284   <span class="keyword">if</span> ~exist(fullfile(rootDir,<span class="string">'subjects'</span>,subjID,stimulusfile),<span class="string">'file'</span>), error(<span class="string">'stimulusfile not found. check the input variable.'</span>); <span class="keyword">end</span>
0285 <span class="keyword">end</span>
0286 
0287 
0288 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0289 <span class="comment">%%%% Add path to the subfunctions</span>
0290 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0291 
0292 <span class="comment">% add paths to the subfunctions</span>
0293 addpath(genpath(fullfile(rootDir,<span class="string">'..'</span>,<span class="string">'Common'</span>)));
0294 addpath(fullfile(rootDir,<span class="string">'..'</span>,<span class="string">'Generation'</span>));
0295 
0296 
0297 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0298 <span class="comment">%%%% For log file</span>
0299 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0300 
0301 <span class="comment">% get date</span>
0302 today=datestr(now,<span class="string">'yymmdd'</span>);
0303 
0304 <span class="comment">% result directry &amp; file</span>
0305 resultDir=fullfile(rootDir,<span class="string">'subjects'</span>,num2str(subjID),<span class="string">'results'</span>,today);
0306 <span class="keyword">if</span> ~exist(resultDir,<span class="string">'dir'</span>), mkdir(resultDir); <span class="keyword">end</span>
0307 
0308 <span class="comment">% record the output window</span>
0309 logfname=fullfile(resultDir,[num2str(subjID),<span class="string">'_imeridian_fixtask_results_run_'</span>,num2str(acq,<span class="string">'%02d'</span>),<span class="string">'.log'</span>]);
0310 diary(logfname);
0311 warning off; <span class="comment">%#ok warning('off','MATLAB:dispatcher:InexactCaseMatch');</span>
0312 
0313 
0314 <span class="comment">%%%%% try &amp; catch %%%%%</span>
0315 <span class="keyword">try</span>
0316 
0317 
0318 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0319 <span class="comment">%%%% Check the PTB version</span>
0320 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0321 
0322 PTB_OK=<a href="../../Retinotopy/Common/CheckPTBversion.html" class="code" title="function [PTB_OK,vertxt] = CheckPTBversion(num_mainver_youwant)">CheckPTBversion</a>(3); <span class="comment">% check wether the PTB version is 3</span>
0323 <span class="keyword">if</span> ~PTB_OK, error(<span class="string">'Wrong version of Psychtoolbox is running. %s requires PTB ver.3'</span>,mfilename()); <span class="keyword">end</span>
0324 
0325 <span class="comment">% debug level, black screen during calibration</span>
0326 Screen(<span class="string">'Preference'</span>, <span class="string">'VisualDebuglevel'</span>, 3);
0327 
0328 
0329 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0330 <span class="comment">%%%% Setup random seed</span>
0331 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0332 
0333 <a href="../../Retinotopy/Common/InitializeRandomSeed.html" class="code" title="function cseed=InitializeRandomSeed">InitializeRandomSeed</a>();
0334 
0335 
0336 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0337 <span class="comment">%%%% Reset display Gamma-function</span>
0338 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0339 
0340 <span class="keyword">if</span> isempty(gamma_table)
0341   gamma_table=repmat(linspace(0.0,1.0,256),3,1); <span class="comment">%#ok</span>
0342   <a href="../../Retinotopy/Common/GammaResetPTB.html" class="code" title="function GammaResetPTB(luminance_ratio)">GammaResetPTB</a>(1.0);
0343 <span class="keyword">else</span>
0344   <a href="../../Retinotopy/Common/GammaLoadPTB.html" class="code" title="function GammaLoadPTB(gamma_table)">GammaLoadPTB</a>(gamma_table);
0345 <span class="keyword">end</span>
0346 
0347 
0348 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0349 <span class="comment">%%%% Validate dparam (displayfile) and sparam (stimulusfile) structures</span>
0350 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0351 
0352 <span class="comment">% organize dparam</span>
0353 dparam=struct(); <span class="comment">% initialize</span>
0354 <span class="keyword">if</span> ~isempty(displayfile), run(fullfile(rootDir,<span class="string">'subjects'</span>,subjID,displayfile)); <span class="keyword">end</span> <span class="comment">% load specific dparam parameters configured for each of the participants</span>
0355 dparam=<a href="../../Retinotopy/Common/ValidateStructureFields.html" class="code" title="function structval=ValidateStructureFields(structval,varargin)">ValidateStructureFields</a>(dparam,<span class="keyword">...</span><span class="comment"> % validate fields and set the default values to missing field(s)</span>
0356          <span class="string">'ExpMode'</span>,<span class="string">'mono'</span>,<span class="keyword">...</span>
0357          <span class="string">'scrID'</span>,1,<span class="keyword">...</span>
0358          <span class="string">'start_method'</span>,0,<span class="keyword">...</span>
0359          <span class="string">'custom_trigger'</span>,<span class="string">'t'</span>,<span class="keyword">...</span>
0360          <span class="string">'Key1'</span>,51,<span class="keyword">...</span>
0361          <span class="string">'Key2'</span>,52,<span class="keyword">...</span>
0362          <span class="string">'fullscr'</span>,false,<span class="keyword">...</span>
0363          <span class="string">'ScrHeight'</span>,1200,<span class="keyword">...</span>
0364          <span class="string">'ScrWidth'</span>,1920,<span class="keyword">...</span>
0365          <span class="string">'force_frame_rate'</span>,60,<span class="keyword">...</span>
0366          <span class="string">'skip_sync_test'</span>,0);
0367 
0368 <span class="comment">% organize sparam</span>
0369 sparam=struct(); <span class="comment">% initialize</span>
0370 sparam.mode=exp_mode;
0371 <span class="keyword">if</span> ~isempty(stimulusfile), run(fullfile(rootDir,<span class="string">'subjects'</span>,subjID,stimulusfile)); <span class="keyword">end</span> <span class="comment">% load specific sparam parameters configured for each of the participants</span>
0372 sparam=<a href="../../Retinotopy/Common/ValidateStructureFields.html" class="code" title="function structval=ValidateStructureFields(structval,varargin)">ValidateStructureFields</a>(sparam,<span class="keyword">...</span><span class="comment"> % validate fields and set the default values to missing field(s)</span>
0373          <span class="string">'width'</span>,48,<span class="keyword">...</span>
0374          <span class="string">'maxRad'</span>,8,<span class="keyword">...</span>
0375          <span class="string">'minRad'</span>,0,<span class="keyword">...</span>
0376          <span class="string">'block_duration'</span>,16000,<span class="keyword">...</span>
0377          <span class="string">'rest_duration'</span>,0,<span class="keyword">...</span>
0378          <span class="string">'numRepeats'</span>,6,<span class="keyword">...</span>
0379          <span class="string">'flip_duration'</span>,250,<span class="keyword">...</span>
0380          <span class="string">'nimg'</span>,120,<span class="keyword">...</span>
0381          <span class="string">'imRatio'</span>,[0.2,0.5],<span class="keyword">...</span>
0382          <span class="string">'imdepth'</span>,[-12,12],<span class="keyword">...</span><span class="comment"> % effective only when the stimuli are presented in stereo mode (e.g. dual, cross, parallel etc)</span>
0383          <span class="string">'waitframes'</span>,6,<span class="keyword">...</span><span class="comment"> % Screen('FrameRate',0)*(sparam.block_duration/1000) / ((sparam.block_duration-sparam.rest_duration)/1000) / ( (size(sparam.colors,1)-1)*2 )</span>
0384          <span class="string">'initial_fixation_time'</span>,[4000,4000],<span class="keyword">...</span>
0385          <span class="string">'fixtype'</span>,1,<span class="keyword">...</span>
0386          <span class="string">'fixsize'</span>,12,<span class="keyword">...</span>
0387          <span class="string">'fixcolor'</span>,[255,255,255],<span class="keyword">...</span>
0388          <span class="string">'bgcolor'</span>,[128,128,128],<span class="keyword">...</span><span class="comment"> % sparam.colors(1,:);</span>
0389          <span class="string">'bgtype'</span>,1,<span class="keyword">...</span>
0390          <span class="string">'patch_size'</span>,[30,30],<span class="keyword">...</span>
0391          <span class="string">'patch_num'</span>,[20,40],<span class="keyword">...</span>
0392          <span class="string">'patch_color1'</span>,[255,255,255],<span class="keyword">...</span>
0393          <span class="string">'patch_color2'</span>,[0,0,0],<span class="keyword">...</span>
0394          <span class="string">'pix_per_cm'</span>,57.1429,<span class="keyword">...</span>
0395          <span class="string">'vdist'</span>,65,<span class="keyword">...</span>
0396          <span class="string">'ipd'</span>,6.5);
0397 
0398 <span class="comment">% change unit from msec to sec.</span>
0399 sparam.initial_fixation_time=sparam.initial_fixation_time./1000; <span class="comment">%#ok</span>
0400 
0401 <span class="comment">% change unit from msec to sec.</span>
0402 sparam.block_duration = sparam.block_duration./1000;
0403 sparam.flip_duration  = sparam.flip_duration./1000;
0404 sparam.rest_duration  = sparam.rest_duration./1000;
0405 
0406 <span class="comment">% set the other parameters</span>
0407 dparam.RunScript = mfilename();
0408 sparam.RunScript = mfilename();
0409 
0410 
0411 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0412 <span class="comment">%%%% Displaying the presentation parameters you set</span>
0413 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0414 
0415 fprintf(<span class="string">'The Presentation Parameters are as below.\n\n'</span>);
0416 fprintf(<span class="string">'************************************************\n'</span>);
0417 fprintf(<span class="string">'****** Script, Subject, Acquistion Number ******\n'</span>);
0418 fprintf(<span class="string">'Date &amp; Time            : %s\n'</span>,strcat([datestr(now,<span class="string">'yymmdd'</span>),<span class="string">' '</span>,datestr(now,<span class="string">'HH:mm:ss'</span>)]));
0419 fprintf(<span class="string">'Running Script Name    : %s\n'</span>,mfilename());
0420 fprintf(<span class="string">'Subject ID             : %s\n'</span>,subjID);
0421 fprintf(<span class="string">'Acquisition Number     : %d\n'</span>,acq);
0422 fprintf(<span class="string">'********* Run Type, Display Image Type *********\n'</span>);
0423 fprintf(<span class="string">'Display Mode           : %s\n'</span>,dparam.ExpMode);
0424 fprintf(<span class="string">'use Full Screen Mode   : %d\n'</span>,dparam.fullscr);
0425 fprintf(<span class="string">'Start Method           : %d\n'</span>,dparam.start_method);
0426 <span class="keyword">if</span> dparam.start_method==4
0427   fprintf(<span class="string">'Custom Trigger         : %d\n'</span>,dparam.custom_trigger);
0428 <span class="keyword">end</span>
0429 fprintf(<span class="string">'*************** Screen Settings ****************\n'</span>);
0430 fprintf(<span class="string">'Screen Height          : %d\n'</span>,dparam.ScrHeight);
0431 fprintf(<span class="string">'Screen Width           : %d\n'</span>,dparam.ScrWidth);
0432 fprintf(<span class="string">'*********** Stimulation Periods etc. ***********\n'</span>);
0433 fprintf(<span class="string">'Fixation Time(sec)     : %d &amp; %d\n'</span>,sparam.initial_fixation_time(1),sparam.initial_fixation_time(2));
0434 fprintf(<span class="string">'Cycle Duration(sec)    : %d\n'</span>,2*sparam.block_duration);
0435 fprintf(<span class="string">'Block Duration(sec)    : %d x 2 (H/V)\n'</span>,sparam.block_duration-sparam.rest_duration);
0436 fprintf(<span class="string">'Rest  Duration(sec)    : %d\n'</span>,sparam.rest_duration);
0437 fprintf(<span class="string">'Repetitions(cycles)    : %d\n'</span>,sparam.numRepeats);
0438 fprintf(<span class="string">'Frame Flip(per VerSync): %d\n'</span>,sparam.waitframes);
0439 fprintf(<span class="string">'Total Time (sec)       : %d\n'</span>,sum(sparam.initial_fixation_time)+sparam.numRepeats*2*sparam.block_duration);
0440 fprintf(<span class="string">'**************** Stimulus Type ****************\n'</span>);
0441 fprintf(<span class="string">'Experiment Mode        : %s\n'</span>,sparam.mode);
0442 fprintf(<span class="string">'************ Response key settings *************\n'</span>);
0443 fprintf(<span class="string">'Reponse Key #1         : %d = %s\n'</span>,dparam.Key1,KbName(dparam.Key1));
0444 fprintf(<span class="string">'Reponse Key #2         : %d = %s\n'</span>,dparam.Key2,KbName(dparam.Key2));
0445 fprintf(<span class="string">'************************************************\n\n'</span>);
0446 fprintf(<span class="string">'Please carefully check before proceeding.\n\n'</span>);
0447 
0448 
0449 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0450 <span class="comment">%%%% Initialize response &amp; event logger objects</span>
0451 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0452 
0453 <span class="comment">% initialize MATLAB objects for event and response logs</span>
0454 event=<a href="../../Retinotopy/Common/eventlogger.html" class="code" title="">eventlogger</a>();
0455 resps=<a href="../../Retinotopy/Common/responselogger.html" class="code" title="">responselogger</a>([dparam.Key1,dparam.Key2]);
0456 resps.initialize(event); <span class="comment">% initialize responselogger</span>
0457 
0458 
0459 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0460 <span class="comment">%%%% Wait for user reponse to start</span>
0461 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0462 
0463 <span class="keyword">if</span> ~force_proceed_flag
0464   [user_answer,resps]=resps.wait_to_proceed();
0465   <span class="keyword">if</span> ~user_answer, diary off; <span class="keyword">return</span>; <span class="keyword">end</span>
0466 <span class="keyword">end</span>
0467 
0468 
0469 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0470 <span class="comment">%%%% Initialization of Left &amp; Right screens for binocular presenting/viewing mode</span>
0471 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0472 
0473 <span class="keyword">if</span> dparam.skip_sync_test, Screen(<span class="string">'Preference'</span>,<span class="string">'SkipSyncTests'</span>,1); <span class="keyword">end</span>
0474 
0475 [winPtr,winRect,nScr,dparam.fps,dparam.ifi,initDisplay_OK]=<a href="../../Retinotopy/Common/InitializePTBDisplays.html" class="code" title="function [winPtr,winRect,nScr,fps,ifi,initDisplay_OK]=InitializePTBDisplays(disp_mode,bgcolor,flipping,rgb_gains,custom_scrIDs)">InitializePTBDisplays</a>(dparam.ExpMode,sparam.bgcolor,0,[],dparam.scrID);
0476 <span class="keyword">if</span> ~initDisplay_OK, error(<span class="string">'Display initialization error. Please check your exp_run parameter.'</span>); <span class="keyword">end</span>
0477 HideCursor();
0478 
0479 <span class="keyword">if</span> <a href="../../Retinotopy/Common/isstructmember.html" class="code" title="function isFieldResult = isstructmember(inStruct, fieldName)">isstructmember</a>(dparam,<span class="string">'force_frame_rate'</span>)
0480   <span class="keyword">if</span> dparam.force_frame_rate
0481     dparam.fps=dparam.force_frame_rate;
0482     dparam.ifi=1/dparam.fps;
0483   <span class="keyword">end</span>
0484 <span class="keyword">end</span>
0485 
0486 
0487 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0488 <span class="comment">%%%% Setting the PTB runnning priority to MAX</span>
0489 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0490 
0491 <span class="comment">% set the priority of this script to MAX</span>
0492 priorityLevel=MaxPriority(winPtr,<span class="string">'WaitBlanking'</span>);
0493 Priority(priorityLevel);
0494 
0495 <span class="comment">% conserve VRAM memory: Workaround for flawed hardware and drivers</span>
0496 <span class="comment">% 32 == kPsychDontShareContextRessources: Do not share ressources between</span>
0497 <span class="comment">% different onscreen windows. Usually you want PTB to share all ressources</span>
0498 <span class="comment">% like offscreen windows, textures and GLSL shaders among all open onscreen</span>
0499 <span class="comment">% windows. If that causes trouble for some weird reason, you can prevent</span>
0500 <span class="comment">% automatic sharing with this flag.</span>
0501 <span class="comment">%Screen('Preference','ConserveVRAM',32);</span>
0502 
0503 
0504 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0505 <span class="comment">%%%% Setting the PTB OpenGL functions</span>
0506 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0507 
0508 <span class="comment">% Enable OpenGL mode of Psychtoolbox: This is crucially needed for clut animation</span>
0509 InitializeMatlabOpenGL();
0510 
0511 <span class="comment">% This script calls Psychtoolbox commands available only in OpenGL-based</span>
0512 <span class="comment">% versions of the Psychtoolbox. (So far, the OS X Psychtoolbox is the</span>
0513 <span class="comment">% only OpenGL-base Psychtoolbox.)  The Psychtoolbox command AssertPsychOpenGL will issue</span>
0514 <span class="comment">% an error message if someone tries to execute this script on a computer without</span>
0515 <span class="comment">% an OpenGL Psychtoolbox</span>
0516 AssertOpenGL();
0517 
0518 <span class="comment">% set OpenGL blend functions</span>
0519 Screen(<span class="string">'BlendFunction'</span>, winPtr, GL_SRC_ALPHA, GL_ONE_MINUS_SRC_ALPHA);
0520 
0521 
0522 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0523 <span class="comment">%%%% Displaying 'Initializing...'</span>
0524 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0525 
0526 <span class="comment">% displaying texts on the center of the screen</span>
0527 <a href="../../Retinotopy/Common/DisplayMessage2.html" class="code" title="function DisplayMessage2(message,bgcolor,winPtr,numScreens,drawing_font,drawing_size)">DisplayMessage2</a>(<span class="string">'Initializing...'</span>,sparam.bgcolor,winPtr,nScr,<span class="string">'Arial'</span>,36);
0528 
0529 
0530 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0531 <span class="comment">%%%% Initializing variables</span>
0532 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0533 
0534 <span class="comment">%% unit conversion</span>
0535 
0536 <span class="comment">% cm per pix</span>
0537 sparam.cm_per_pix=1/sparam.pix_per_cm;
0538 
0539 <span class="comment">% pixles per degree</span>
0540 sparam.pix_per_deg=round( 1/( 180*atan(sparam.cm_per_pix/sparam.vdist)/pi ) );
0541 
0542 <span class="comment">% deg to radian</span>
0543 <span class="comment">% do not convert!</span>
0544 <span class="comment">% sparam.width, sparam.phase, sparam.startangle, sparam.rotangle are used in deg formats</span>
0545 
0546 <span class="comment">% number of checkerboard color</span>
0547 sparam.ncolors=(size(sparam.colors,1)-1)/2;
0548 
0549 <span class="comment">% sec to number of frames</span>
0550 nframe_fixation=round(sparam.initial_fixation_time.*dparam.fps./sparam.waitframes);
0551 nframe_stim=round((sparam.block_duration-sparam.rest_duration)*dparam.fps/sparam.waitframes);
0552 nframe_rest=round(sparam.rest_duration*dparam.fps/sparam.waitframes);
0553 nframe_flicker=round(sparam.flip_duration*dparam.fps/sparam.waitframes);
0554 nframe_task=round(18/sparam.waitframes); <span class="comment">% just arbitral, you can change as you like</span>
0555 
0556 <span class="comment">%% initialize chackerboard parameters</span>
0557 
0558 <span class="comment">% adjust size ratio considering full-screen effect</span>
0559 <span class="keyword">if</span> dparam.fullscr
0560   <span class="comment">% here, use width information alone, assuming that the pixel is square</span>
0561   ratio_wid=( winRect(3)-winRect(1) )/dparam.ScrWidth;
0562   <span class="comment">%ratio_hei=( winRect(4)-winRect(2) )/dparam.ScrHeight;</span>
0563 
0564   <span class="comment">% min/max radius of annulus</span>
0565   rmin=sparam.minRad*ratio_wid; <span class="comment">% !!! degree, not pixel or cm !!!</span>
0566   rmax=sparam.maxRad*ratio_wid;
0567 <span class="keyword">else</span>
0568   rmin=sparam.minRad;
0569   rmax=sparam.maxRad;
0570 <span class="keyword">end</span>
0571 
0572 
0573 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0574 <span class="comment">%%%% Generating checkerboard patterns</span>
0575 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0576 
0577 <span class="comment">% [note]</span>
0578 <span class="comment">% After this processing, each checkerboard image has checker elements with values as shown below</span>
0579 <span class="comment">% 0 = background</span>
0580 <span class="comment">% 1 = checker ID 1</span>
0581 <span class="comment">% 2 = checker ID 2</span>
0582 <span class="comment">% 3 = checker ID 3</span>
0583 <span class="comment">% .....</span>
0584 <span class="comment">% sparam.npatches = checker ID</span>
0585 <span class="comment">% Each patch ID will be associated with a CLUT color of the same ID</span>
0586 
0587 <span class="comment">% generate a dual wedge checkerboard pattern</span>
0588 sparam.startangles=[0-sparam.width/2,0-sparam.width/2+90];
0589 [dummy1,dummy2,checkerboard]=<a href="../../Retinotopy/Generation/pol_GenerateCheckerBoard1D.html" class="code" title="function [checkerboard,bincheckerboard,mask]=pol_GenerateCheckerBoard1D(rmin,rmax,width,startangle,pix_per_deg,nwedges,nrings,phase,dual_flg)">pol_GenerateCheckerBoard1D</a>(rmin,rmax,sparam.width,sparam.startangles,sparam.pix_per_deg,1,1,0,1);
0590 
0591 <span class="comment">%% organize the checkerboard into masks</span>
0592 <span class="keyword">for</span> ii=1:1:numel(sparam.startangles)
0593   checkerboard{ii}=repmat(255.*double(~checkerboard{ii}),[1,1,4]);
0594   checkerboard{ii}(:,:,1:3)=repmat(reshape(sparam.bgcolor,[1,1,3]),[size(checkerboard{ii},1),size(checkerboard{ii},2)]);
0595 <span class="keyword">end</span>
0596 
0597 <span class="comment">%% Make Checkerboard-mask textures</span>
0598 checkertexture=cell(numel(sparam.startangles),1);
0599 <span class="keyword">for</span> ii=1:1:numel(sparam.startangles), checkertexture{ii}=Screen(<span class="string">'MakeTexture'</span>,winPtr,checkerboard{ii}); <span class="keyword">end</span>
0600 
0601 
0602 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0603 <span class="comment">%%%% Initializing a background brownian noise image</span>
0604 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0605 
0606 <span class="comment">%pdims=[4,4];</span>
0607 <span class="comment">%szh=size(checkerboard{1},1);</span>
0608 <span class="comment">%if mod(szh,pdims(1)), szh=szh+pdims(1)-mod(szh,pdims(1)); end</span>
0609 <span class="comment">%szw=size(checkerboard{1},2);</span>
0610 <span class="comment">%if mod(szw,pdims(2)), szw=szw+pdims(2)-mod(szw,pdims(1)); end</span>
0611 <span class="comment">%bnimg=CreateColoredNoise([szh,szw],pdims,3,2,1,0,0);</span>
0612 <span class="comment">%bnimg=bnimg(1:size(checkerboard{1},1),1:size(checkerboard{1},2),:);</span>
0613 
0614 bnimg=<a href="../../Retinotopy/Common/CreateColoredNoise.html" class="code" title="function img=CreateColoredNoise(idims,sdims,num,beta,norm_flg,save_flg,show_flg)">CreateColoredNoise</a>(round([size(checkerboard{1},1),size(checkerboard{1},2)]./4),[1,1],3,2,1,0,0); <span class="comment">% ./4 is for reducing computation time, 3 is required for RGB color noise</span>
0615 noisetexture=Screen(<span class="string">'MakeTexture'</span>,winPtr,bnimg);
0616 
0617 
0618 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0619 <span class="comment">%%%% Initializing object images</span>
0620 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0621 
0622 <span class="comment">% loading the object image database</span>
0623 load(fullfile(fileparts(mfilename(<span class="string">'fullpath'</span>)),<span class="string">'..'</span>,<span class="string">'object_images'</span>,<span class="string">'object_image_database.mat'</span>)); <span class="comment">% img is loaded on the memory</span>
0624 
0625 <span class="comment">% shuffling the presentation order</span>
0626 img=img(:,:,:,<a href="../../Retinotopy/Common/shuffle.html" class="code" title="function [Y,index] = shuffle(X)">shuffle</a>(1:size(img,4)));
0627 imgsz=[size(img,1),size(img,2)];
0628 posLims=CenterRect([0,0,size(checkerboard{1},2),size(checkerboard{1},1)],winRect); <span class="comment">% image location limit, [x_min, y_min, x_max, y_max], the image positions are randomly selected whithin this range</span>
0629 
0630 <span class="comment">% initializing the firt object image textures</span>
0631 
0632 <span class="comment">% image IDs</span>
0633 imgids=1:1:sparam.nimg;
0634 imgids(imgids&gt;size(img,4))=mod(imgids(imgids&gt;size(img,4)),size(img,4));
0635 imgids(imgids==0)=size(img,4);
0636 
0637 <span class="comment">% rectangles</span>
0638 cpos=[(posLims(3)-posLims(1)).*rand(sparam.nimg,1)+posLims(1),(posLims(4)-posLims(2)).*rand(sparam.nimg,1)+posLims(2)]; <span class="comment">% center positions, [x,y]</span>
0639 cszs=(sparam.imRatio(2)-sparam.imRatio(1)).*rand(sparam.nimg,1)+sparam.imRatio(1); <span class="comment">% image maginification factor</span>
0640 imgpos=[round(cpos(:,1)-cszs*imgsz(2)/2)+1,round(cpos(:,2)-cszs*imgsz(1)/2)+1,round(cpos(:,1)+cszs*imgsz(2)/2),round(cpos(:,2)+cszs*imgsz(1)/2)]';
0641 
0642 <span class="comment">% angles</span>
0643 imgrot=360.*rand(sparam.nimg,1);
0644 
0645 <span class="comment">% stereo depth</span>
0646 <span class="keyword">if</span> nScr&gt;1
0647   <span class="comment">% compute image shift from disparity</span>
0648   depths=(sparam.imdepth(2)-sparam.imdepth(1)).*rand(sparam.nimg,1)+sparam.imdepth(1);
0649   zdist=<a href="../../Retinotopy/Common/CalcDistFromDisparity.html" class="code" title="function zdist = CalcDistFromDisparity(ipd,disparity,viewdist)">CalcDistFromDisparity</a>(sparam.ipd,depths,sparam.vdist);
0650   zdist=sort(zdist,<span class="string">'descend'</span>);
0651   [Lshift,Rshift]=RayTrace_ScreenPos_X_MEX(zdist,sparam.ipd,sparam.vdist,sparam.pix_per_cm,0);
0652   stereopos{1}=[Lshift,zeros(sparam.nimg,1),Lshift,zeros(sparam.nimg,1)]';
0653   stereopos{2}=[Rshift,zeros(sparam.nimg,1),Rshift,zeros(sparam.nimg,1)]';
0654 <span class="keyword">else</span>
0655   stereopos{1}=repmat([0,0,0,0],[sparam.nimg,1])';
0656   stereopos{2}=repmat([0,0,0,0],[sparam.nimg,1])';
0657 <span class="keyword">end</span>
0658 
0659 <span class="comment">% generate the object image textures at the first frame</span>
0660 objecttextures=zeros(numel(imgids),1);
0661 <span class="keyword">for</span> pp=1:1:numel(imgids), objecttextures(pp)=Screen(<span class="string">'MakeTexture'</span>,winPtr,img(:,:,:,imgids(pp))); <span class="keyword">end</span>
0662 
0663 
0664 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0665 <span class="comment">%%%% Debug codes</span>
0666 <span class="comment">%%%% saving the stimulus images as *.png format files and enter the debug (keyboard) mode</span>
0667 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0668 
0669 <span class="comment">% %%%%%% DEBUG codes start here</span>
0670 <span class="keyword">if</span> strfind(upper(subjID),<span class="string">'DEBUG'</span>)
0671 
0672   Screen(<span class="string">'CloseAll'</span>);
0673 
0674   save_dir=fullfile(resultDir,<span class="string">'images_imeridian_fixtask'</span>);
0675   <span class="keyword">if</span> ~exist(save_dir,<span class="string">'dir'</span>), mkdir(save_dir); <span class="keyword">end</span>
0676 
0677   <span class="comment">% open a new window for drawing stimuli</span>
0678   stimRect=[0,0,size(checkerboard{1},2),size(checkerboard{1},1)];
0679   [winPtr,winRect]=Screen(<span class="string">'OpenWindow'</span>,dparam.scrID,sparam.bgcolor,CenterRect(stimRect,Screen(<span class="string">'Rect'</span>,dparam.scrID)));
0680 
0681   <span class="comment">% set OpenGL</span>
0682   priorityLevel=MaxPriority(winPtr,<span class="string">'WaitBlanking'</span>);
0683   Priority(priorityLevel);
0684   AssertOpenGL();
0685   Screen(<span class="string">'BlendFunction'</span>, winPtr, GL_SRC_ALPHA, GL_ONE_MINUS_SRC_ALPHA);
0686 
0687   <span class="comment">% regenerate checkerboard textures</span>
0688   <span class="keyword">for</span> nn=1:1:numel(sparam.startangles), checkertexture{nn}=Screen(<span class="string">'MakeTexture'</span>,winPtr,checkerboard{nn}); <span class="keyword">end</span>
0689 
0690   <span class="comment">% check the number of flickers</span>
0691   <span class="keyword">if</span> mod((sparam.block_duration-sparam.rest_duration)/sparam.flip_duration,1)~=0
0692     warning(<span class="string">'sparam.block_duration-sparam.rest_duration can not be divided by sparam.flip_duration. check the sparam parameters.'</span>);
0693   <span class="keyword">end</span>
0694 
0695   <span class="comment">% processing</span>
0696   obj_counter=0;
0697   <span class="keyword">for</span> rr=1:1:sparam.numRepeats
0698     <span class="keyword">for</span> nn=1:1:numel(sparam.startangles)
0699       <span class="keyword">for</span> cc=1:1:round((sparam.block_duration-sparam.rest_duration)/sparam.flip_duration)
0700 
0701         <span class="comment">% brownian noise image</span>
0702         bnimg=<a href="../../Retinotopy/Common/CreateColoredNoise.html" class="code" title="function img=CreateColoredNoise(idims,sdims,num,beta,norm_flg,save_flg,show_flg)">CreateColoredNoise</a>(round([size(checkerboard{1},1),size(checkerboard{1},2)]./4),[1,1],3,2,1,0,0);
0703         noisetexture=Screen(<span class="string">'MakeTexture'</span>,winPtr,bnimg);
0704 
0705         <span class="keyword">for</span> pp=1:1:2 <span class="comment">% by default, 2 image sets in one background noise flicker</span>
0706           <span class="comment">% generate object image textures</span>
0707 
0708           <span class="comment">% image IDs</span>
0709           obj_counter=obj_counter+1;
0710           imgids=sparam.nimg*(obj_counter-1)+1:1:sparam.nimg*obj_counter;
0711           imgids(imgids&gt;size(img,4))=mod(imgids(imgids&gt;size(img,4)),size(img,4));
0712           imgids(imgids==0)=size(img,4);
0713 
0714           <span class="comment">% rectangles</span>
0715           cpos=[(stimRect(3)-stimRect(1)).*rand(sparam.nimg,1)+stimRect(1),(stimRect(4)-stimRect(2)).*rand(sparam.nimg,1)+stimRect(2)]; <span class="comment">% center positions, [x,y]</span>
0716           cszs=(sparam.imRatio(2)-sparam.imRatio(1)).*rand(sparam.nimg,1)+sparam.imRatio(1); <span class="comment">% image maginification factor</span>
0717           imgpos=[round(cpos(:,1)-cszs*imgsz(2)/2)+1,round(cpos(:,2)-cszs*imgsz(1)/2)+1,round(cpos(:,1)+cszs*imgsz(2)/2),round(cpos(:,2)+cszs*imgsz(1)/2)]';
0718 
0719           <span class="comment">% angles</span>
0720           imgrot=360.*rand(sparam.nimg,1);
0721 
0722           <span class="comment">% stereo depth</span>
0723           <span class="keyword">if</span> nScr&gt;1
0724             <span class="comment">% compute image shift from disparity</span>
0725             depths=(sparam.imdepth(2)-sparam.imdepth(1)).*rand(sparam.nimg,1)+sparam.imdepth(1);
0726             zdist=<a href="../../Retinotopy/Common/CalcDistFromDisparity.html" class="code" title="function zdist = CalcDistFromDisparity(ipd,disparity,viewdist)">CalcDistFromDisparity</a>(sparam.ipd,depths,sparam.vdist);
0727             zdist=sort(zdist,<span class="string">'descend'</span>);
0728             [Lshift,Rshift]=RayTrace_ScreenPos_X_MEX(zdist,sparam.ipd,sparam.vdist,sparam.pix_per_cm,0);
0729             stereopos{1}=[Lshift,zeros(sparam.nimg,1),Lshift,zeros(sparam.nimg,1)]';
0730             stereopos{2}=[Rshift,zeros(sparam.nimg,1),Rshift,zeros(sparam.nimg,1)]';
0731           <span class="keyword">else</span>
0732             stereopos{1}=repmat([0,0,0,0],[sparam.nimg,1])';
0733             stereopos{2}=repmat([0,0,0,0],[sparam.nimg,1])';
0734           <span class="keyword">end</span>
0735 
0736           <span class="keyword">for</span> mm=1:1:numel(imgids), objecttextures(mm)=Screen(<span class="string">'MakeTexture'</span>,winPtr,img(:,:,:,imgids(mm))); <span class="keyword">end</span>
0737 
0738           <span class="keyword">for</span> nnnn=1:1:nScr
0739             <span class="comment">% drawing</span>
0740             Screen(<span class="string">'DrawTexture'</span>,winPtr,noisetexture,[],CenterRect(stimRect,winRect)); <span class="comment">% noise textures</span>
0741             Screen(<span class="string">'DrawTextures'</span>,winPtr,objecttextures,[],imgpos+stereopos{nnnn},imgrot); <span class="comment">% object images</span>
0742             Screen(<span class="string">'DrawTexture'</span>,winPtr,checkertexture{nn},[],CenterRect(stimRect,winRect)); <span class="comment">% checkerboard mask</span>
0743 
0744             <span class="comment">% flip the window</span>
0745             Screen(<span class="string">'DrawingFinished'</span>,winPtr);
0746             Screen(<span class="string">'Flip'</span>,winPtr,[],[],[],1);
0747 
0748             <span class="comment">% get the current frame and save it</span>
0749             imwrite(Screen(<span class="string">'GetImage'</span>,winPtr,winRect),fullfile(save_dir,sprintf(<span class="string">'retinotopy_%s_cycle_%02d_pos_%02d_type_%02d_%02d_stereo_%02d.png'</span>,sparam.mode,rr,nn,cc,pp,nnnn)),<span class="string">'png'</span>);
0750           <span class="keyword">end</span>
0751 
0752           <span class="comment">% close the textures and OffScreenWindow</span>
0753           <span class="keyword">for</span> mm=1:1:numel(imgids), Screen(<span class="string">'Close'</span>,objecttextures(mm)); <span class="keyword">end</span>
0754         <span class="keyword">end</span> <span class="comment">% for pp=1:1:2</span>
0755         Screen(<span class="string">'Close'</span>,noisetexture);
0756 
0757       <span class="keyword">end</span> <span class="comment">% for cc=1:1:round((sparam.block_duration-sparam.rest_duration)/sparam.flip_duration);</span>
0758     <span class="keyword">end</span> <span class="comment">% for nn=1:1:numel(sparam.startangles)</span>
0759   <span class="keyword">end</span> <span class="comment">% for rr=1:1:sparam.numRepeats</span>
0760 
0761   Screen(<span class="string">'CloseAll'</span>);
0762   save(fullfile(save_dir,sprintf(<span class="string">'stimulus_%s.mat'</span>,sparam.mode)),<span class="string">'checkerboard'</span>,<span class="string">'sparam'</span>,<span class="string">'dparam'</span>);
0763   keyboard;
0764 
0765 <span class="keyword">end</span> <span class="comment">% if strfind(upper(subjID),'DEBUG')</span>
0766 <span class="comment">% %%%%%% DEBUG code ends here</span>
0767 
0768 
0769 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0770 <span class="comment">%%%% Generating fixation detection task parameters</span>
0771 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0772 
0773 <span class="comment">%% set task variables</span>
0774 <span class="comment">% flag to decide whether presenting fixation task</span>
0775 totalframes=max(sum(nframe_fixation),1)+2*(nframe_stim+nframe_rest)*sparam.numRepeats;
0776 num_tasks=ceil(totalframes/nframe_task);
0777 task_flg=ones(1,num_tasks);
0778 <span class="keyword">for</span> nn=2:1:num_tasks
0779   <span class="keyword">if</span> task_flg(nn-1)==2
0780     task_flg(nn)=1;
0781   <span class="keyword">else</span>
0782     <span class="keyword">if</span> mod(randi(4,1),4)==0 <span class="comment">% this is arbitral, but I put these lines just to reduce the number of tasks</span>
0783       task_flg(nn)=round(rand(1,1))+1;
0784     <span class="keyword">else</span>
0785       task_flg(nn)=1;
0786     <span class="keyword">end</span>
0787   <span class="keyword">end</span>
0788 <span class="keyword">end</span>
0789 task_flg=repmat(task_flg,nframe_task,1);
0790 task_flg=task_flg(:);
0791 
0792 
0793 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0794 <span class="comment">%%%% Creating background images</span>
0795 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0796 
0797 <span class="keyword">if</span> sparam.bgtype==1 <span class="comment">% a simple background with sparam.bgcolor</span>
0798   bgimg{1}=repmat(reshape(sparam.bgcolor,[1,1,3]),[dparam.ScrHeight,dparam.ScrWidth]);
0799 
0800 <span class="keyword">elseif</span> sparam.bgtype==2 <span class="comment">% a background with grid guides</span>
0801 
0802   <span class="comment">% calculate the central aperture size of the background image</span>
0803   edgeY=mod(dparam.ScrHeight,sparam.patch_num(1)); <span class="comment">% delete the exceeded region</span>
0804   p_height=round((dparam.ScrHeight-edgeY)/sparam.patch_num(1)); <span class="comment">% height in pix of patch_height + interval-Y</span>
0805 
0806   edgeX=mod(dparam.ScrWidth,sparam.patch_num(2)); <span class="comment">% delete exceeded region</span>
0807   p_width=round((dparam.ScrWidth-edgeX)/sparam.patch_num(2)); <span class="comment">% width in pix of patch_width + interval-X</span>
0808 
0809   <span class="keyword">if</span> dparam.fullscr
0810     aperture_size=[2*( p_height*ceil( size(checkerboard{1},1)/2*( (winRect(4)-winRect(2))/dparam.ScrHeight ) /p_height ) ),<span class="keyword">...</span>
0811                    2*( p_width*ceil( size(checkerboard{1},2)/2*( (winRect(3)-winRect(1))/dparam.ScrWidth ) /p_width ) )];
0812   <span class="keyword">else</span>
0813     aperture_size=[2*( p_height*ceil(size(checkerboard{1},1)/2/p_height) ),<span class="keyword">...</span>
0814                    2*( p_width*ceil(size(checkerboard{1},2)/2/p_width) )];
0815   <span class="keyword">end</span>
0816 
0817   bgimg=<a href="../../Retinotopy/Common/CreateBackgroundImage.html" class="code" title="function [Bimg,parameters] = CreateBackgroundImage(wdims,stdims,pdims,bgcolor,color1,color2,fixcolor,patchnum,fix_flag,save_flag,show_flag)">CreateBackgroundImage</a>([dparam.ScrHeight,dparam.ScrWidth],aperture_size,sparam.patch_size,sparam.bgcolor,sparam.patch_color1,sparam.patch_color2,sparam.fixcolor,sparam.patch_num,0,0,0);
0818 <span class="keyword">else</span>
0819   error(<span class="string">'sparam.bgtype should be 1 or 2. check the input variable.'</span>);
0820 <span class="keyword">end</span>
0821 
0822 <span class="comment">% set mask and transparency in the middle region of the background where the target stimuli are to be presented.</span>
0823 <span class="comment">% this mask is required to prevent the object images from being presented in the external regions.</span>
0824 bgimg=bgimg{1};
0825 bgimg(:,:,4)=255*ones(size(bgimg,1),size(bgimg,2));
0826 maskRect=CenterRect([1,1,size(checkerboard{1},2),size(checkerboard{1},1)],[1,1,size(bgimg,2),size(bgimg,1)]);
0827 bgimg(maskRect(2)+1:maskRect(4),maskRect(1)+1:maskRect(3),4)=0; <span class="comment">% alpha channel, transparency</span>
0828 
0829 background=Screen(<span class="string">'MakeTexture'</span>,winPtr,bgimg);
0830 
0831 
0832 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0833 <span class="comment">%%%% Creating the central fixation, cross images</span>
0834 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0835 
0836 <span class="comment">% Create fixation cross images.</span>
0837 <span class="comment">% Firstly larger fixations are generated, then they are antialiased. This is required to present a beautiful circle</span>
0838 
0839 <span class="keyword">if</span> sparam.fixtype==1 <span class="comment">% circular fixation</span>
0840   fixW=<a href="../../Retinotopy/Common/CreateFixationImgCircular.html" class="code" title="function fix=CreateFixationImgCircular(fixsize,fixcolor,bgcolor,circlesize,show_flag,save_flag)">CreateFixationImgCircular</a>(4*sparam.fixsize,sparam.fixcolor,sparam.bgcolor,4*sparam.fixsize,0,0);
0841   fixD=<a href="../../Retinotopy/Common/CreateFixationImgCircular.html" class="code" title="function fix=CreateFixationImgCircular(fixsize,fixcolor,bgcolor,circlesize,show_flag,save_flag)">CreateFixationImgCircular</a>(4*sparam.fixsize,[64,64,64],sparam.bgcolor,4*sparam.fixsize,0,0);
0842 <span class="keyword">elseif</span> sparam.fixtype==2 <span class="comment">% rectangular fixation</span>
0843   fixW=<a href="../../Retinotopy/Common/CreateFixationImgMono.html" class="code" title="function fix=CreateFixationImgMono(fixsize,fixcolor,bgcolor,fixlinew,fixlineh,show_flag,save_flag)">CreateFixationImgMono</a>(4*sparam.fixsize,sparam.fixcolor,sparam.bgcolor,4*2,4*ceil(0.4*sparam.fixsize),0,0);
0844   fixD=<a href="../../Retinotopy/Common/CreateFixationImgMono.html" class="code" title="function fix=CreateFixationImgMono(fixsize,fixcolor,bgcolor,fixlinew,fixlineh,show_flag,save_flag)">CreateFixationImgMono</a>(4*sparam.fixsize,[64,64,64],sparam.bgcolor,4*2,4*ceil(0.4*sparam.fixsize),0,0);
0845 <span class="keyword">elseif</span> sparam.fixtype==3 <span class="comment">% concentric fixation</span>
0846   fixW=<a href="../../Retinotopy/Common/CreateFixationImgConcentrateMono.html" class="code" title="function fix=CreateFixationImgConcentrateMono(fixsize,fixcolor,bgcolor,circlesize,gap,show_flag,save_flag)">CreateFixationImgConcentrateMono</a>(4*sparam.fixsize,sparam.fixcolor,sparam.bgcolor,4*[2,ceil(0.8*sparam.fixsize)],0,0,0);
0847   fixD=<a href="../../Retinotopy/Common/CreateFixationImgConcentrateMono.html" class="code" title="function fix=CreateFixationImgConcentrateMono(fixsize,fixcolor,bgcolor,circlesize,gap,show_flag,save_flag)">CreateFixationImgConcentrateMono</a>(4*sparam.fixsize,[64,64,64],sparam.bgcolor,4*[2,ceil(0.8*sparam.fixsize)],0,0,0);
0848 <span class="keyword">else</span>
0849   error(<span class="string">'sparam.fixtype should be one of 1,2, and 3. check the input variable.'</span>);
0850 <span class="keyword">end</span>
0851 fixW=imresize(fixW,0.25);
0852 fixD=imresize(fixD,0.25);
0853 
0854 fix=cell(2,1); <span class="comment">% 1 is for default fixation, 2 is for darker fixation (luminance detection task)</span>
0855 fix{1}=Screen(<span class="string">'MakeTexture'</span>,winPtr,fixW);
0856 fix{2}=Screen(<span class="string">'MakeTexture'</span>,winPtr,fixD);
0857 
0858 
0859 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0860 <span class="comment">%%%% Prepare blue lines for stereo image flip sync with VPixx PROPixx</span>
0861 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0862 
0863 <span class="comment">% There seems to be a blueline generation bug on some OpenGL systems.</span>
0864 <span class="comment">% SetStereoBlueLineSyncParameters(winPtr, winRect(4)) corrects the</span>
0865 <span class="comment">% bug on some systems, but breaks on other systems.</span>
0866 <span class="comment">% We'll just disable automatic blueline, and manually draw our own bluelines!</span>
0867 
0868 <span class="keyword">if</span> strcmpi(dparam.ExpMode,<span class="string">'propixxstereo'</span>)
0869   SetStereoBlueLineSyncParameters(winPtr, winRect(4)+10);
0870   blueRectOn(1,:)=[0, winRect(4)-1, winRect(3)/4, winRect(4)];
0871   blueRectOn(2,:)=[0, winRect(4)-1, winRect(3)*3/4, winRect(4)];
0872   blueRectOff(1,:)=[winRect(3)/4, winRect(4)-1, winRect(3), winRect(4)];
0873   blueRectOff(2,:)=[winRect(3)*3/4, winRect(4)-1, winRect(3), winRect(4)];
0874 <span class="keyword">end</span>
0875 
0876 
0877 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0878 <span class="comment">%%%% Image size adjusting to match the current display resolutions</span>
0879 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0880 
0881 <span class="keyword">if</span> dparam.fullscr
0882   ratio_wid= ( winRect(3)-winRect(1) )/dparam.ScrWidth;
0883   ratio_hei= ( winRect(4)-winRect(2) )/dparam.ScrHeight;
0884   bgSize   = [size(bgimg{1},2)*ratio_wid, size(bgimg{1},1)*ratio_hei];
0885   stimSize = [size(checkerboard{1},2)*ratio_wid, size(checkerboard{1},1)*ratio_hei];
0886   fixSize  = [2*sparam.fixsize*ratio_wid, 2*sparam.fixsize*ratio_hei];
0887 <span class="keyword">else</span>
0888   bgSize   = [dparam.ScrWidth, dparam.ScrHeight];
0889   stimSize = [size(checkerboard{1},2), size(checkerboard{1},1)];
0890   fixSize  = [2*sparam.fixsize, 2*sparam.fixsize];
0891 <span class="keyword">end</span>
0892 
0893 <span class="comment">% for some display modes in which one screen is splitted into two binocular displays</span>
0894 <span class="keyword">if</span> strcmpi(dparam.ExpMode,<span class="string">'cross'</span>) || strcmpi(dparam.ExpMode,<span class="string">'parallel'</span>) || <span class="keyword">...</span>
0895    strcmpi(dparam.ExpMode,<span class="string">'topbottom'</span>) || strcmpi(dparam.ExpMode,<span class="string">'bottomtop'</span>)
0896   bgSize=bgSize./2;
0897   stimSize=stimSize./2;
0898   fixSize=fixSize./2;
0899 
0900   <span class="comment">% adjust image size (note: in contrast, we have to keep the stereo shifts as they are)</span>
0901   imgsz=imgsz./2;
0902 
0903   <span class="comment">% update lim positions just for the first frame</span>
0904   posLims=CenterRect([0,0,size(checkerboard{1},2)./2,size(checkerboard{1},1)./2],winRect); <span class="comment">% image location limit, [x_min, y_min, x_max, y_max], the image positions are randomly selected whithin this range</span>
0905 
0906   <span class="comment">% update image locations just for the first frame</span>
0907   cpos=[(posLims(3)-posLims(1)).*rand(sparam.nimg,1)+posLims(1),(posLims(4)-posLims(2)).*rand(sparam.nimg,1)+posLims(2)]; <span class="comment">% center positions, [x,y]</span>
0908   cszs=(sparam.imRatio(2)-sparam.imRatio(1)).*rand(sparam.nimg,1)+sparam.imRatio(1); <span class="comment">% image maginification factor</span>
0909   imgpos=[round(cpos(:,1)-cszs*imgsz(2)/2)+1,round(cpos(:,2)-cszs*imgsz(1)/2)+1,round(cpos(:,1)+cszs*imgsz(2)/2),round(cpos(:,2)+cszs*imgsz(1)/2)]';
0910 <span class="keyword">end</span>
0911 
0912 bgRect  = [0, 0, bgSize]; <span class="comment">% used to display background images;</span>
0913 stimRect= [0, 0, stimSize];
0914 fixRect = [0, 0, fixSize]; <span class="comment">% used to display the central fixation point</span>
0915 
0916 
0917 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0918 <span class="comment">%%%% Generating additional mask which covers the outside region of the background.</span>
0919 <span class="comment">%%%% The mask is required to hide parts of the objects presented outside the background</span>
0920 <span class="comment">%%%% when the script is not running with full-screen mode.</span>
0921 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0922 
0923 
0924 wrect=Screen(<span class="string">'Rect'</span>,winPtr);
0925 <span class="keyword">if</span> wrect(3)-wrect(1)&gt;bgRect(3)-bgRect(1) | wrect(4)-wrect(2)&gt;bgRect(4)-bgRect(2) <span class="comment">% if background is smaller than the whole screen</span>
0926   hide_flg=1;
0927   amskimg=repmat(reshape(sparam.colors(1,:),[1,1,3]),[wrect(4)-wrect(2),wrect(3)-wrect(1)]);
0928   amskimg(:,:,4)=255*ones(size(amskimg,1),size(amskimg,2));
0929   amskRect=CenterRect(bgRect,wrect);
0930   amskimg(amskRect(2)+1:amskRect(4),amskRect(1)+1:amskRect(3),4)=0; <span class="comment">% alpha channel, transparency</span>
0931 
0932   abackground=Screen(<span class="string">'MakeTexture'</span>,winPtr,amskimg);
0933 <span class="keyword">else</span>
0934   hide_flg=0;
0935 <span class="keyword">end</span>
0936 
0937 
0938 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0939 <span class="comment">%%%% Initialize functions and variables for trial loop</span>
0940 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0941 
0942 <span class="comment">% initialize variables that we will use during the experiment (faster)</span>
0943 cur_frames=0;
0944 
0945 <span class="comment">% object image counter</span>
0946 obj_counter=0;
0947 
0948 
0949 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0950 <span class="comment">%%%% Displaying 'Ready to Start'</span>
0951 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0952 
0953 <span class="comment">% displaying texts on the center of the screen</span>
0954 <a href="../../Retinotopy/Common/DisplayMessage2.html" class="code" title="function DisplayMessage2(message,bgcolor,winPtr,numScreens,drawing_font,drawing_size)">DisplayMessage2</a>(<span class="string">'Ready to Start'</span>,sparam.bgcolor,winPtr,nScr,<span class="string">'Arial'</span>,36);
0955 ttime=GetSecs(); <span class="keyword">while</span> (GetSecs()-ttime &lt; 0.5), <span class="keyword">end</span>  <span class="comment">% run up the clock.</span>
0956 
0957 
0958 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0959 <span class="comment">%%%% Flip the display(s) to the background image(s)</span>
0960 <span class="comment">%%%% and inform the ready of stimulus presentation</span>
0961 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0962 
0963 <span class="comment">% change the screen and wait for the trigger or pressing the start button</span>
0964 <span class="keyword">for</span> nn=1:1:nScr
0965   Screen(<span class="string">'SelectStereoDrawBuffer'</span>,winPtr,nn-1);
0966   Screen(<span class="string">'DrawTexture'</span>,winPtr,fix{2},[],CenterRect(fixRect,winRect));
0967   Screen(<span class="string">'DrawTexture'</span>,winPtr,background,[],CenterRect(bgRect,winRect));
0968 
0969   <span class="comment">% blue line for stereo sync</span>
0970   <span class="keyword">if</span> strcmpi(dparam.ExpMode,<span class="string">'propixxstereo'</span>)
0971     Screen(<span class="string">'FillRect'</span>,winPtr,[0,0,255],blueRectOn(nn,:));
0972     Screen(<span class="string">'FillRect'</span>,winPtr,[0,0,0],blueRectOff(nn,:));
0973   <span class="keyword">end</span>
0974 <span class="keyword">end</span>
0975 Screen(<span class="string">'DrawingFinished'</span>,winPtr);
0976 Screen(<span class="string">'Flip'</span>, winPtr,[],[],[],1);
0977 
0978 <span class="comment">% prepare the next frame for the initial fixation period</span>
0979 <span class="keyword">for</span> nn=1:1:nScr
0980   Screen(<span class="string">'SelectStereoDrawBuffer'</span>,winPtr,nn-1);
0981   Screen(<span class="string">'DrawTexture'</span>,winPtr,fix{1},[],CenterRect(fixRect,winRect)); <span class="comment">% fix{1} is valid as no task in the first period</span>
0982   Screen(<span class="string">'DrawTexture'</span>,winPtr,background,[],CenterRect(bgRect,winRect));
0983 
0984   <span class="comment">% blue line for stereo sync</span>
0985   <span class="keyword">if</span> strcmpi(dparam.ExpMode,<span class="string">'propixxstereo'</span>)
0986     Screen(<span class="string">'FillRect'</span>,winPtr,[0,0,255],blueRectOn(nn,:));
0987     Screen(<span class="string">'FillRect'</span>,winPtr,[0,0,0],blueRectOff(nn,:));
0988   <span class="keyword">end</span>
0989 <span class="keyword">end</span>
0990 Screen(<span class="string">'DrawingFinished'</span>,winPtr);
0991 
0992 
0993 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0994 <span class="comment">%%%% Wait for the first trigger pulse from fMRI scanner or start with button pressing</span>
0995 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0996 
0997 <span class="comment">% add time stamp (this also works to load add_event method in memory in advance of the actual displays)</span>
0998 fprintf(<span class="string">'\nWaiting for the start...\n'</span>);
0999 event=event.add_event(<span class="string">'Experiment Start'</span>,strcat([datestr(now,<span class="string">'yymmdd'</span>),<span class="string">' '</span>,datestr(now,<span class="string">'HH:mm:ss'</span>)]),NaN);
1000 
1001 <span class="comment">% waiting for stimulus presentation</span>
1002 resps.wait_stimulus_presentation(dparam.start_method,dparam.custom_trigger);
1003 <span class="comment">%PlaySound(1);</span>
1004 fprintf(<span class="string">'\nExperiment running...\n'</span>);
1005 
1006 
1007 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
1008 <span class="comment">%%%% Initial Fixation Period</span>
1009 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
1010 
1011 vbl=Screen(<span class="string">'Flip'</span>,winPtr,[],[],[],1); <span class="comment">% the first flip</span>
1012 [event,the_experiment_start]=event.set_reference_time(vbl);
1013 event=event.add_event(<span class="string">'Initial Fixation'</span>,[]);
1014 fprintf(<span class="string">'\nfixation\n\n'</span>);
1015 cur_frames=cur_frames+1;
1016 
1017 <span class="comment">% wait for the initial fixation</span>
1018 <span class="keyword">for</span> ff=1:1:nframe_fixation(1)
1019   <span class="keyword">for</span> nn=1:1:nScr
1020     Screen(<span class="string">'SelectStereoDrawBuffer'</span>,winPtr,nn-1);
1021     Screen(<span class="string">'DrawTexture'</span>,winPtr,fix{task_flg(cur_frames)},[],CenterRect(fixRect,winRect));
1022     Screen(<span class="string">'DrawTexture'</span>,winPtr,background,[],CenterRect(bgRect,winRect));
1023 
1024     <span class="comment">% blue line for stereo sync</span>
1025     <span class="keyword">if</span> strcmpi(dparam.ExpMode,<span class="string">'propixxstereo'</span>)
1026       Screen(<span class="string">'FillRect'</span>,winPtr,[0,0,255],blueRectOn(nn,:));
1027       Screen(<span class="string">'FillRect'</span>,winPtr,[0,0,0],blueRectOff(nn,:));
1028     <span class="keyword">end</span>
1029   <span class="keyword">end</span>
1030   Screen(<span class="string">'DrawingFinished'</span>,winPtr);
1031   <span class="keyword">while</span> GetSecs()&lt;vbl+(ff*sparam.waitframes-0.5)*dparam.ifi, [resps,event]=resps.check_responses(event); <span class="keyword">end</span>
1032   Screen(<span class="string">'Flip'</span>,winPtr,[],[],[],1);
1033 
1034   <span class="comment">% update task</span>
1035   cur_frames=cur_frames+1;
1036   <span class="keyword">if</span> task_flg(cur_frames-1)==2 &amp;&amp; task_flg(cur_frames-2)==1, event=event.add_event(<span class="string">'Luminance Task'</span>,[]); <span class="keyword">end</span>
1037 <span class="keyword">end</span>
1038 
1039 
1040 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
1041 <span class="comment">%%%% The Trial Loop</span>
1042 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
1043 
1044 <span class="keyword">for</span> cc=1:1:sparam.numRepeats
1045 
1046   <span class="comment">%% stimulus presentation loop</span>
1047   <span class="keyword">for</span> pp=1:1:2 <span class="comment">% 2 = horizontal and vertical visual meridians</span>
1048     <span class="keyword">for</span> ff=1:1:nframe_stim+nframe_rest
1049 
1050       <span class="comment">%% display the current frame</span>
1051       <span class="keyword">for</span> nn=1:1:nScr
1052         Screen(<span class="string">'SelectStereoDrawBuffer'</span>,winPtr,nn-1);
1053         <span class="comment">% present the checkerboard along the horizontal (when pp is 1) or vertical (when pp is 2) visual meridian</span>
1054         <span class="keyword">if</span> ff&lt;=nframe_stim
1055           Screen(<span class="string">'DrawTexture'</span>,winPtr,noisetexture,[],CenterRect(stimRect,winRect)); <span class="comment">% noise textures</span>
1056           Screen(<span class="string">'DrawTextures'</span>,winPtr,objecttextures,[],imgpos+stereopos{nn},imgrot); <span class="comment">% object images</span>
1057           Screen(<span class="string">'DrawTexture'</span>,winPtr,checkertexture{pp},[],CenterRect(stimRect,winRect)); <span class="comment">% checkerboard mask</span>
1058           <span class="keyword">if</span> hide_flg, Screen(<span class="string">'DrawTexture'</span>,winPtr,abackground,[],winRect); <span class="keyword">end</span> <span class="comment">% additional background to hide the external region</span>
1059         <span class="keyword">end</span>
1060         Screen(<span class="string">'DrawTexture'</span>,winPtr,fix{task_flg(cur_frames)},[],CenterRect(fixRect,winRect)); <span class="comment">% the central fixation oval</span>
1061         Screen(<span class="string">'DrawTexture'</span>,winPtr,background,[],CenterRect(bgRect,winRect)); <span class="comment">% background</span>
1062 
1063         <span class="comment">% blue line for stereo sync</span>
1064         <span class="keyword">if</span> strcmpi(dparam.ExpMode,<span class="string">'propixxstereo'</span>)
1065           Screen(<span class="string">'FillRect'</span>,winPtr,[0,0,255],blueRectOn(nn,:));
1066           Screen(<span class="string">'FillRect'</span>,winPtr,[0,0,0],blueRectOff(nn,:));
1067         <span class="keyword">end</span>
1068       <span class="keyword">end</span>
1069 
1070       <span class="comment">% flip the window</span>
1071       Screen(<span class="string">'DrawingFinished'</span>,winPtr);
1072       <span class="keyword">while</span> GetSecs()&lt;vbl+sparam.initial_fixation_time(1)+(cc-1)*2*sparam.block_duration+(pp-1)*sparam.block_duration+((ff-1)*sparam.waitframes-0.5)*dparam.ifi, [resps,event]=resps.check_responses(event); <span class="keyword">end</span>
1073       Screen(<span class="string">'Flip'</span>,winPtr,[],[],[],1);
1074 
1075       <span class="keyword">if</span> pp==1 &amp;&amp; ff==1
1076         event=event.add_event(sprintf(<span class="string">'Cycle: %d'</span>,cc),[]);
1077         fprintf(sprintf(<span class="string">'Cycle: %03d...\n'</span>,cc));
1078       <span class="keyword">end</span>
1079 
1080       <span class="comment">% update task</span>
1081       cur_frames=cur_frames+1;
1082       <span class="keyword">if</span> task_flg(cur_frames)==2 &amp;&amp; task_flg(cur_frames-1)==1, event=event.add_event(<span class="string">'Luminance Task'</span>,[]); <span class="keyword">end</span>
1083 
1084       <span class="comment">%% exit from the loop if the final frame is displayed</span>
1085       <span class="keyword">if</span> pp==2 &amp;&amp; ff==nframe_stim+nframe_rest &amp;&amp; cc==sparam.numRepeats, <span class="keyword">continue</span>; <span class="keyword">end</span>
1086 
1087       <span class="comment">%% update IDs</span>
1088 
1089       <span class="comment">% flickering checkerboard</span>
1090       <span class="keyword">if</span> ff&lt;=nframe_stim
1091         <span class="keyword">if</span> ~mod(ff,nframe_flicker) <span class="comment">% color reversal</span>
1092           <span class="comment">% update the brownian noise texture.</span>
1093           Screen(<span class="string">'Close'</span>,noisetexture);
1094           <span class="comment">%bnimg=CreateColoredNoise([szh,szw],pdims,3,2,1,0,0);</span>
1095           <span class="comment">%bnimg=bnimg(1:size(checkerboard{1},1),1:size(checkerboard{1},2),:);</span>
1096           bnimg=<a href="../../Retinotopy/Common/CreateColoredNoise.html" class="code" title="function img=CreateColoredNoise(idims,sdims,num,beta,norm_flg,save_flg,show_flg)">CreateColoredNoise</a>(round([size(checkerboard{1},1),size(checkerboard{1},2)]./4),[1,1],3,2,1,0,0);
1097           noisetexture=Screen(<span class="string">'MakeTexture'</span>,winPtr,bnimg);
1098         <span class="keyword">end</span>
1099 
1100         <span class="keyword">if</span> ~mod(ff,ceil(nframe_flicker/2)) <span class="comment">% object image reversal</span>
1101           <span class="comment">%% update object images</span>
1102           <span class="keyword">for</span> mm=1:1:numel(imgids), Screen(<span class="string">'Close'</span>,objecttextures(mm)); <span class="keyword">end</span>
1103 
1104           obj_counter=obj_counter+1;
1105 
1106           <span class="comment">% image IDs</span>
1107           imgids=sparam.nimg*obj_counter+1:1:sparam.nimg*(obj_counter+1); <span class="comment">% the first image set is already presented</span>
1108           imgids(imgids&gt;size(img,4))=mod(imgids(imgids&gt;size(img,4)),size(img,4));
1109           imgids(imgids==0)=size(img,4);
1110 
1111           <span class="comment">% rectangles</span>
1112           cpos=[(posLims(3)-posLims(1)).*rand(sparam.nimg,1)+posLims(1),(posLims(4)-posLims(2)).*rand(sparam.nimg,1)+posLims(2)]; <span class="comment">% center positions, [x,y]</span>
1113           cszs=(sparam.imRatio(2)-sparam.imRatio(1)).*rand(sparam.nimg,1)+sparam.imRatio(1); <span class="comment">% image maginification factor</span>
1114           imgpos=[round(cpos(:,1)-cszs*imgsz(2)/2)+1,round(cpos(:,2)-cszs*imgsz(1)/2)+1,round(cpos(:,1)+cszs*imgsz(2)/2),round(cpos(:,2)+cszs*imgsz(1)/2)]';
1115 
1116           <span class="comment">% angles</span>
1117           imgrot=360.*rand(sparam.nimg,1);
1118 
1119           <span class="comment">% stereo depth</span>
1120           <span class="keyword">if</span> nScr&gt;1
1121             <span class="comment">% compute image shift from disparity</span>
1122             depths=(sparam.imdepth(2)-sparam.imdepth(1)).*rand(sparam.nimg,1)+sparam.imdepth(1);
1123             zdist=<a href="../../Retinotopy/Common/CalcDistFromDisparity.html" class="code" title="function zdist = CalcDistFromDisparity(ipd,disparity,viewdist)">CalcDistFromDisparity</a>(sparam.ipd,depths,sparam.vdist);
1124             zdist=sort(zdist,<span class="string">'descend'</span>);
1125             [Lshift,Rshift]=RayTrace_ScreenPos_X_MEX(zdist,sparam.ipd,sparam.vdist,sparam.pix_per_cm,0);
1126             stereopos{1}=[Lshift,zeros(sparam.nimg,1),Lshift,zeros(sparam.nimg,1)]';
1127             stereopos{2}=[Rshift,zeros(sparam.nimg,1),Rshift,zeros(sparam.nimg,1)]';
1128           <span class="keyword">else</span>
1129             stereopos{1}=repmat([0,0,0,0],[sparam.nimg,1])';
1130             stereopos{2}=repmat([0,0,0,0],[sparam.nimg,1])';
1131           <span class="keyword">end</span>
1132 
1133           <span class="comment">% generate object image textures</span>
1134           <span class="keyword">for</span> mm=1:1:numel(imgids), objecttextures(mm)=Screen(<span class="string">'MakeTexture'</span>,winPtr,img(:,:,:,imgids(mm))); <span class="keyword">end</span>
1135         <span class="keyword">end</span>
1136       <span class="keyword">end</span>
1137     <span class="keyword">end</span> <span class="comment">% for ff=1:1:nframe_stim+nframe_rest</span>
1138   <span class="keyword">end</span> <span class="comment">% for pp=1:1:2 % 2 = horizontal and vertical visual meridians</span>
1139 
1140 <span class="keyword">end</span> <span class="comment">% for cc=1:1:sparam.numRepeats</span>
1141 
1142 
1143 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
1144 <span class="comment">%%%% Final Fixation</span>
1145 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
1146 
1147 <span class="keyword">for</span> nn=1:1:nScr
1148   Screen(<span class="string">'SelectStereoDrawBuffer'</span>,winPtr,nn-1);
1149   Screen(<span class="string">'DrawTexture'</span>,winPtr,fix{task_flg(cur_frames)},[],CenterRect(fixRect,winRect));
1150   Screen(<span class="string">'DrawTexture'</span>,winPtr,background,[],CenterRect(bgRect,winRect));
1151 
1152   <span class="comment">% blue line for stereo sync</span>
1153   <span class="keyword">if</span> strcmpi(dparam.ExpMode,<span class="string">'propixxstereo'</span>)
1154     Screen(<span class="string">'FillRect'</span>,winPtr,[0,0,255],blueRectOn(nn,:));
1155     Screen(<span class="string">'FillRect'</span>,winPtr,[0,0,0],blueRectOff(nn,:));
1156   <span class="keyword">end</span>
1157 <span class="keyword">end</span>
1158 Screen(<span class="string">'DrawingFinished'</span>,winPtr);
1159 <span class="keyword">while</span> GetSecs()&lt;vbl+sparam.initial_fixation_time(1)+sparam.numRepeats*2*sparam.block_duration-0.5*dparam.ifi, [resps,event]=resps.check_responses(event); <span class="keyword">end</span>
1160 Screen(<span class="string">'Flip'</span>,winPtr,[],[],[],1);
1161 <span class="comment">%cur_frames=cur_frames+1;</span>
1162 event=event.add_event(<span class="string">'Final Fixation'</span>,[]);
1163 fprintf(<span class="string">'\nfixation\n'</span>);
1164 
1165 <span class="comment">% wait for the initial fixation</span>
1166 <span class="keyword">for</span> ff=1:1:nframe_fixation(2)
1167   <span class="keyword">for</span> nn=1:1:nScr
1168     Screen(<span class="string">'SelectStereoDrawBuffer'</span>,winPtr,nn-1);
1169     Screen(<span class="string">'DrawTexture'</span>,winPtr,fix{task_flg(cur_frames)},[],CenterRect(fixRect,winRect));
1170     Screen(<span class="string">'DrawTexture'</span>,winPtr,background,[],CenterRect(bgRect,winRect));
1171 
1172     <span class="comment">% blue line for stereo sync</span>
1173     <span class="keyword">if</span> strcmpi(dparam.ExpMode,<span class="string">'propixxstereo'</span>)
1174       Screen(<span class="string">'FillRect'</span>,winPtr,[0,0,255],blueRectOn(nn,:));
1175       Screen(<span class="string">'FillRect'</span>,winPtr,[0,0,0],blueRectOff(nn,:));
1176     <span class="keyword">end</span>
1177   <span class="keyword">end</span>
1178   Screen(<span class="string">'DrawingFinished'</span>,winPtr);
1179   <span class="keyword">while</span> GetSecs()&lt;vbl+sparam.initial_fixation_time(1)+sparam.numRepeats*2*sparam.block_duration+(ff*sparam.waitframes-0.5)*dparam.ifi, [resps,event]=resps.check_responses(event); <span class="keyword">end</span>
1180   Screen(<span class="string">'Flip'</span>,winPtr,[],[],[],1);
1181 
1182   <span class="comment">% update task</span>
1183   cur_frames=cur_frames+1;
1184   <span class="keyword">if</span> task_flg(cur_frames-1)==2 &amp;&amp; task_flg(cur_frames-2)==1, event=event.add_event(<span class="string">'Luminance Task'</span>,[]); <span class="keyword">end</span>
1185 <span class="keyword">end</span>
1186 
1187 <span class="comment">% the final clock up</span>
1188 <span class="keyword">while</span> GetSecs()-the_experiment_start&lt;sum(sparam.initial_fixation_time)+sparam.numRepeats*2*sparam.block_duration
1189   [resps,event]=resps.check_responses(event);
1190 <span class="keyword">end</span>
1191 
1192 
1193 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
1194 <span class="comment">%%%% Experiment &amp; scanner end here</span>
1195 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
1196 
1197 experimentDuration=GetSecs()-the_experiment_start+sparam.waitframes*dparam.ifi;
1198 event=event.add_event(<span class="string">'End'</span>,[]);
1199 fprintf(<span class="string">'\n'</span>);
1200 fprintf(<span class="string">'Experiment Completed: %.2f/%.2f secs\n'</span>,experimentDuration,<span class="keyword">...</span>
1201         sum(sparam.initial_fixation_time)+sparam.numRepeats*2*sparam.block_duration);
1202 fprintf(<span class="string">'\n'</span>);
1203 
1204 
1205 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
1206 <span class="comment">%%%% Cleaning up the PTB screen</span>
1207 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
1208 
1209 Screen(<span class="string">'CloseAll'</span>);
1210 
1211 <span class="comment">% closing datapixx</span>
1212 <span class="keyword">if</span> strcmpi(dparam.ExpMode,<span class="string">'propixxmono'</span>) || strcmpi(dparam.ExpMode,<span class="string">'propixxstereo'</span>)
1213   <span class="keyword">if</span> Datapixx(<span class="string">'IsViewpixx3D'</span>)
1214     Datapixx(<span class="string">'DisableVideoLcd3D60Hz'</span>);
1215     Datapixx(<span class="string">'RegWr'</span>);
1216   <span class="keyword">end</span>
1217   Datapixx(<span class="string">'Close'</span>);
1218 <span class="keyword">end</span>
1219 
1220 ShowCursor();
1221 Priority(0);
1222 <a href="../../Retinotopy/Common/GammaResetPTB.html" class="code" title="function GammaResetPTB(luminance_ratio)">GammaResetPTB</a>(1.0);
1223 
1224 
1225 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
1226 <span class="comment">%%%% Write data into file for post analysis</span>
1227 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
1228 
1229 <span class="comment">% saving the results</span>
1230 fprintf(<span class="string">'saving data...'</span>);
1231 
1232 <span class="comment">% save data</span>
1233 savefname=fullfile(resultDir,[num2str(subjID),<span class="string">'_imeridian_fixtask_results_run_'</span>,num2str(acq,<span class="string">'%02d'</span>),<span class="string">'.mat'</span>]);
1234 
1235 <span class="comment">% backup the old file(s)</span>
1236 <span class="keyword">if</span> ~overwrite_flg
1237   <a href="../../Retinotopy/Common/BackUpObsoleteFiles.html" class="code" title="function [new_fname,backup_fname]=BackUpObsoleteFiles(tgt_dir,tgt_fname,backup_prefix)">BackUpObsoleteFiles</a>(fullfile(<span class="string">'subjects'</span>,num2str(subjID),<span class="string">'results'</span>,today),<span class="keyword">...</span>
1238                       [num2str(subjID),<span class="string">'_imeridian_fixtask_results_run_'</span>,num2str(acq,<span class="string">'%02d'</span>),<span class="string">'.mat'</span>],<span class="string">'_old'</span>);
1239 <span class="keyword">end</span>
1240 
1241 eval(sprintf(<span class="string">'save %s subjID acq sparam dparam event gamma_table;'</span>,savefname));
1242 fprintf(<span class="string">'done.\n'</span>);
1243 
1244 <span class="comment">% calculate &amp; display task performance</span>
1245 fprintf(<span class="string">'calculating task accuracy...\n'</span>);
1246 correct_event=cell(2,1); <span class="keyword">for</span> ii=1:1:2, correct_event{ii}=sprintf(<span class="string">'key%d'</span>,ii); <span class="keyword">end</span>
1247 [task.numTasks,task.numHits,task.numErrors,task.numResponses,task.RT]=event.calc_accuracy(correct_event);
1248 event=event.get_event(); <span class="comment">% convert an event logger object to a cell data structure</span>
1249 eval(sprintf(<span class="string">'save -append %s event task;'</span>,savefname));
1250 fprintf(<span class="string">'done.\n'</span>);
1251 
1252 
1253 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
1254 <span class="comment">%%%% Removing path to the subfunctions, and finalizing the script</span>
1255 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
1256 
1257 rmpath(genpath(fullfile(rootDir,<span class="string">'..'</span>,<span class="string">'Common'</span>)));
1258 rmpath(fullfile(rootDir,<span class="string">'..'</span>,<span class="string">'Generation'</span>));
1259 clear all; clear mex; clear <span class="keyword">global</span>;
1260 diary off;
1261 
1262 
1263 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
1264 <span class="comment">%%%% tell the experimenter that the measurements are completed</span>
1265 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
1266 
1267 <span class="keyword">try</span>
1268   <span class="keyword">for</span> ii=1:1:3, Snd(<span class="string">'Play'</span>,sin(2*pi*0.2*(0:900)),8000); <span class="keyword">end</span>
1269 <span class="keyword">catch</span>
1270   <span class="comment">% do nothing</span>
1271 <span class="keyword">end</span>
1272 
1273 
1274 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
1275 <span class="comment">%%%% Catch the errors</span>
1276 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
1277 
1278 <span class="keyword">catch</span> lasterror
1279   <span class="comment">% this &quot;catch&quot; section executes in case of an error in the &quot;try&quot; section</span>
1280   <span class="comment">% above.  Importantly, it closes the onscreen window if its open.</span>
1281   Screen(<span class="string">'CloseAll'</span>);
1282 
1283   <span class="keyword">if</span> exist(<span class="string">'dparam'</span>,<span class="string">'var'</span>)
1284     <span class="keyword">if</span> <a href="../../Retinotopy/Common/isstructmember.html" class="code" title="function isFieldResult = isstructmember(inStruct, fieldName)">isstructmember</a>(dparam,<span class="string">'ExpMode'</span>)
1285       <span class="keyword">if</span> strcmpi(dparam.ExpMode,<span class="string">'propixxmono'</span>) || strcmpi(dparam.ExpMode,<span class="string">'propixxstereo'</span>)
1286         <span class="keyword">if</span> Datapixx(<span class="string">'IsViewpixx3D'</span>)
1287           Datapixx(<span class="string">'DisableVideoLcd3D60Hz'</span>);
1288           Datapixx(<span class="string">'RegWr'</span>);
1289         <span class="keyword">end</span>
1290         Datapixx(<span class="string">'Close'</span>);
1291       <span class="keyword">end</span>
1292     <span class="keyword">end</span>
1293   <span class="keyword">end</span>
1294 
1295   ShowCursor();
1296   Priority(0);
1297   <a href="../../Retinotopy/Common/GammaResetPTB.html" class="code" title="function GammaResetPTB(luminance_ratio)">GammaResetPTB</a>(1.0);
1298   tmp=lasterror; <span class="comment">%#ok</span>
1299   <span class="comment">%if exist('event','var'), event=event.get_event(); end %#ok % just for debugging</span>
1300   diary off;
1301   fprintf([<span class="string">'\nError detected and the program was terminated.\n'</span>,<span class="keyword">...</span>
1302            <span class="string">'To check error(s), please type ''tmp''.\n'</span>,<span class="keyword">...</span>
1303            <span class="string">'Please save the current variables now if you need.\n'</span>,<span class="keyword">...</span>
1304            <span class="string">'Then, quit by ''dbquit''\n'</span>]);
1305   keyboard;
1306   rmpath(genpath(fullfile(rootDir,<span class="string">'..'</span>,<span class="string">'Common'</span>)));
1307   rmpath(fullfile(rootDir,<span class="string">'..'</span>,<span class="string">'Generation'</span>));
1308   clear all; clear mex; clear <span class="keyword">global</span>;
1309   <span class="keyword">return</span>
1310 <span class="keyword">end</span> <span class="comment">% try..catch</span>
1311 
1312 
1313 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
1314 <span class="comment">%%%%% That's it - we're done</span>
1315 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
1316 <span class="keyword">return</span>;
1317 <span class="comment">% end % function imeridian</span></pre></div>
<hr><address>Generated on Wed 09-Jun-2021 15:37:02 by <strong><a href="http://www.artefact.tk/software/matlab/m2html/" target="_parent">m2html</a></strong> &copy; 2005 using a BVQX_hbtools customized template</address>
</body>
</html>