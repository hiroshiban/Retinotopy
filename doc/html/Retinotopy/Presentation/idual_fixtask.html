<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
                "http://www.w3.org/TR/REC-html40/loose.dtd">
<html>
<head>
  <title>Description of idual_fixtask</title>
  <meta name="keywords" content="idual_fixtask">
  <meta name="description" content="Object-image-defined retinotopy stimulus with fixation luminance change-detection tasks.">
  <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
  <meta name="generator" content="m2html &copy; 2005 Guillaume Flandin">
  <meta name="robots" content="index, follow">
  <link type="text/css" rel="stylesheet" href="../../m2html.css">
  <script type="text/javascript">
    if (top.frames.length == 0) { top.location = "../../index.html"; };
  </script>
</head>
<body>
<a name="_top"></a>
<!-- # Retinotopy --><!-- menu.html Presentation -->
<h1>idual_fixtask
</h1>

<h2><a name="_name"></a>PURPOSE <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
<div class="box"><strong>Object-image-defined retinotopy stimulus with fixation luminance change-detection tasks.</strong></div>

<h2><a name="_synopsis"></a>SYNOPSIS <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
<div class="box"><strong>function idual_fixtask(subjID,exp_mode,acq,displayfile,stimulusfile,gamma_table,overwrite_flg,force_proceed_flag) </strong></div>

<h2><a name="_description"></a>DESCRIPTION <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
<div class="fragment" style="background-image:url(../../hb_brain.png); background-position:right top"><pre class="comment"> Object-image-defined retinotopy stimulus with fixation luminance change-detection tasks.
 function idual_fixtask(subjID,exp_mode,acq,:displayfile,:stimulusfile,:gamma_table,:overwrite_flg,:force_proceed_flag)
 (: is optional)

 - This function generates and presents dual retinotopy stimulus (rotating wedge +
   expanding/contracting annulus) on which object images are randomly located with
   brownian noise images on its background.
   The stimulus can be used to measure cortical retinotopy and to delineate retinotopic
   borders using the standard phase-encoded or pRF (population receptive field) analysis techniques.

   references: 1. Population receptive field estimates in human visual cortex.
                  Dumoulin, S.O. and Wandell, B.A. (2008). Neuroimage, 39(2), 647-660.
               2. Borders of multiple visual areas in humans revealed by functional magnetic resonance imaging.
                  Sereno MI, Dale AM, Reppas JB, Kwong KK, Belliveau JW, Brady TJ, Rosen BR, Tootell RB. (1995).
                  Science 268(5212), 889-893.
               3. fMRI of human visual cortex.
                  Engel SA, Rumelhart DE, Wandell BA, Lee AT, Glover GH, Chichilnisky EJ, Shadlen MN. (1994).
                  Nature, 369(6481), 525.
               4. Visual field maps in human cortex.
                  Wandell BA, Dumoulin SO, Brewer AA. (2007). Neuron, 56(2), 366-383.

 - This script shoud be used with MATLAB Psychtoolbox version 3 or above.

 - Luminance detection task: the central fixation point (default: white)
   randomly turns to gray. An observer has to press the button if s/he
   detects this luminance change. Response keys are defined in displayfile.

 [about the object images used in this function]
 The object images used in this function (stored in ~/Retinotopy/object_images/ as object_image_database.mat) are
 obtained and modified from the databases publicly available from http://konklab.fas.harvard.edu/#
 I sincerely express my gratitude to the developers, distributors, and scientists in Dr Talia Konkle's research group
 for their contributions to these databases. When you use this function for your research, please cite the original
 papers listed below.

 - Tripartite Organization of the Ventral Stream by Animacy and Object Size.
   Konkle, T., &amp; Caramazza, A. (2013). Journal of Neuroscience, 33 (25), 10235-42.

 - A real-world size organization of object responses in occipito-temporal cortex.
   Konkle. T., &amp; Oliva, A. (2012). Neuron, 74(6), 1114-24.

 - Visual long-term memory has a massive storage capacity for object details.
   Brady, T. F., Konkle, T., Alvarez, G. A. &amp; Oliva, A. (2008). Proceedings of the National Academy of Sciences USA, 105(38), 14325-9.

 - Conceptual distinctiveness supports detailed visual long-term memory.
   Konkle, T., Brady, T. F., Alvarez, G. A., &amp; Oliva, A. (2010). Journal of Experimental Psychology: General, 139(3), 558-578.

 - A Familiar Size Stroop Effect: Real-world size is an automatic property of object representation.
   Konkle, T., &amp; Oliva, A. (2012). Journal of Experimental Psychology: Human Perception &amp; Performance, 38, 561-9.

 [note]
 Behavioral task of (function_name)_fixtask is to detect changes of luminance
 of the central fixation point, while the task in (function_name) is to detect
 changes of luminance of one of the patches in the checkerboard stimuli.
 Here, the central fixation task is more easy to sustain the stable fixation
 on the center of the screen and may be suitable for naive/non-expert
 participants with minimizing unwilling eye movements. However, some studies
 have reported that attention to the target stimulus (checker-patch luminance
 change detection task) is required to get reliable retinotopic representations
 in higher-order visual areas.


 Created    : &quot;2018-12-20 14:26:03 ban&quot;
 Last Update: &quot;2021-06-07 17:18:34 ban&quot;



 [input variables]
 sujID         : ID of subject, string, such as 's01'
                 you also need to create a directory ./subjects/(subj) and put displayfile and stimulusfile there.
                 !!!!!!!!!!!!!!!!!! IMPORTANT NOTE !!!!!!!!!!!!!!!!!!!!!!!!
                 !!! if 'debug' (case insensitive) is included          !!!
                 !!! in subjID string, this program runs as DEBUG mode; !!!
                 !!! stimulus images are saved as *.png format at       !!!
                 !!! ~/Retinotopy/Presentation/images                   !!!
                 !!!!!!!!!!!!!!!!!! IMPORTANT NOTE !!!!!!!!!!!!!!!!!!!!!!!!

 exp_mode      : experiment mode that you want to run, one of
  - ccwexp : a wedge rotating counter-clockwisely + an expanding annulus
  - cwexp  : a wedge rotating clockwisely + an expanding annulus
  - ccwcont: a wedge rotating counter-clockwisely + a contracting annulus
  - cwcont : a wedge rotating clockwisely + a contracting annulus
 acq           : acquisition number (design file number),
                 an integer, such as 1, 2, 3, ...
 displayfile   : (optional) display condition file,
                 *.m file, such as 'RetDepth_display_fmri.m'
                 the file should be located in ./subjects/(subj)/
 stimulusfile  : (optional) stimulus condition file,
                 *.m file, such as 'RetDepth_stimulus_exp1.m'
                 the file should be located in ./subjects/(subj)/
 gamma_table   : (optional) table(s) of gamma-corrected video input values (Color LookupTable).
                 256(8-bits) x 3(RGB) x 1(or 2,3,... when using multiple displays) matrix
                 or a *.mat file specified with a relative path format. e.g. '/gamma_table/gamma1.mat'
                 The *.mat should include a variable named &quot;gamma_table&quot; consists of a 256x3xN matrix.
                 if you use multiple (more than 1) displays and set a 256x3x1 gamma-table, the same
                 table will be applied to all displays. if the number of displays and gamma tables
                 are different (e.g. you have 3 displays and 256x3x!2! gamma-tables), the last
                 gamma_table will be applied to the second and third displays.
                 if empty, normalized gamma table (repmat(linspace(0.0,1.0,256),3,1)) will be applied.
 overwrite_flg : (optional) whether overwriting pre-existing result file. if 1, the previous result
                 file with the same acquisition number will be overwritten by the previous one.
                 if 0, the existing file will be backed-up by adding a prefix '_old' at the tail
                 of the file. 0 by default.
 force_proceed_flag : (optional) whether proceeding stimulus presentatin without waiting for
                 the experimenter response (e.g. presesing the ENTER key) or a trigger.
                 if 1, the stimulus presentation will be automatically carried on.

 !!! NOTICE !!!!
 displayfile &amp; stimulusfile should be located at
 ./subjects/(subjID)/
 as ./subjects/(subjID)/*_display_fmri.m
    ./subjects/(subjID)/*_stimuli.m


 [output variables]
 no output matlab variable.


 [output files]
 1. result file
    stored ./subjects/(subjID)/results/(date)
    as ./subjects/(subjID)/results/(date)/(subjID)_idual_fixtask_(exp_mode)_results_run_(run_num).mat


 [example]
 &gt;&gt; idual_fixtask('HB','ccwexp',1,'ret_display.m','ret_checker_stimulus_exp1.m')

 [About displayfile]
 The contents of the displayfile are as below.
 (The file includs 6 lines of headers and following display parameters)

 (an example of the displayfile)

 % ************************************************************
 % This is the display configuration file for the retinotopy stimuli
 % Programmed by Hiroshi Ban Nov 01 2013
 % ************************************************************

 % display mode, one of &quot;mono&quot;, &quot;dual&quot;, &quot;dualcross&quot;, &quot;dualparallel&quot;, &quot;cross&quot;, &quot;parallel&quot;, &quot;redgreen&quot;, &quot;greenred&quot;,
 % &quot;redblue&quot;, &quot;bluered&quot;, &quot;shutter&quot;, &quot;topbottom&quot;, &quot;bottomtop&quot;, &quot;interleavedline&quot;, &quot;interleavedcolumn&quot;, &quot;propixxmono&quot;, &quot;propixxstereo&quot;
 dparam.ExpMode='mono';

 dparam.scrID=1; % screen ID, generally 0 for a single display setup, 1 for dual display setup

 % a method to start stimulus presentation
 % 0:ENTER/SPACE, 1:Left-mouse button, 2:the first MR trigger pulse (CiNet),
 % 3:waiting for a MR trigger pulse (BUIC) -- checking onset of pin #11 of the parallel port,
 % or 4:custom key trigger (wait for a key input that you specify as tgt_key).
 dparam.start_method=2;

 % a pseudo trigger key from the MR scanner when it starts, valid only when dparam.start_method=4;
 dparam.custom_trigger='t';

 % keyboard settings
 dparam.Key1=51; % key 1 (left)
 dparam.Key2=52; % key 2 (right)

 % screen settings

 %%% whether displaying the stimuli in full-screen mode or
 %%% as is (the precise resolution), 'true' or 'false' (true)
 dparam.fullscr=false;

 %%% the resolution of the screen height
 dparam.ScrHeight=1200;

 %% the resolution of the screen width
 dparam.ScrWidth=1920;

 % whether forcing to use specific frame rate, if 0, the frame rate wil bw computed in the ImagesShowPTB function.
 % if non zero, the value is used as the screen frame rate.
 dparam.force_frame_rate=60;

 % whther skipping the PTB's vertical-sync signal test. if 1, the sync test is skipped
 dparam.skip_sync_test=0;


 [About stimulusfile]
 The contents of the stimulusfile are as below.
 (The file includs 6 lines of headers and following stimulus parameters)

 (an example of the stimulusfile)

 % ************************************************************
 % This is the stimulus parameter file for the dual (wedge + annulus) retinotopy stimulus
 % Programmed by Hiroshi Ban Jan 25 2019
 % ************************************************************

 % &quot;sparam&quot; means &quot;stimulus generation parameters&quot;

 %%% stimulus parameters
 sparam.pol_width       = 48;    % wedge width in deg along polar angle
 sparam.pol_rotangle    = 12;    % rotation angle in deg
 sparam.pol_startangle  = -sparam.pol_width/2-90; % presentation start angle in deg, from right-horizontal meridian, ccw

 sparam.ecc_width       = sparam.pol_width/2;
 sparam.ecc_rotangle    = sparam.pol_rotangle;
 sparam.ecc_startangle  = -sparam.ecc_width/2-90;  % presentation start angle in deg, from right-horizontal meridian, ccw (actually this value is not used for the eccentricity stimuli (exp and cont))

 sparam.maxRad      = 6.0;  % maximum radius of  annulus (degrees)
 sparam.minRad      = 0;    % minumum

 %%% duration in msec for each cycle &amp; repetitions
 % ===========================================================================================================================================
 % IMPORTANT NOTE: sparam.pol_cycle_duration x sparam.pol_numRepeats should be the same with sparam.ecc_cycle_duration x sparam.ecc_numRepeats
 % ===========================================================================================================================================

 sparam.pol_cycle_duration=60000; % msec
 sparam.pol_rest_duration =0; % msec, rest after each cycle, stimulation = cycle_duration-eccrest
 sparam.pol_numRepeats=6;

 sparam.ecc_cycle_duration=40000; % msec
 sparam.ecc_rest_duration =8000; % msec, rest after each cycle, stimulation = cycle_duration-eccrest
 sparam.ecc_numRepeats=9;

 %%% parameters used only for object-image-based retinotopy stimuli
 sparam.flip_duration=250; % msec
 sparam.nimg=120; % number of images to be presented at a frame
 sparam.imRatio=[0.2,0.5]; % image magnification ratio, [min, max] (0.0-1.0), the image sizes are randomly selected whithin this range
 sparam.imdepth=[-12,12]; % disparities (arcmins) added to the images, effective only in a stereo mode (e.g. shutter, dual, parallel etc)

 %%% set number of frames to flip the screen
 % Here, I set the number as large as I can to minimize vertical cynching error.
 % Set 1 if you want to flip the display at each vertical sync, but not recommended as it uses much CPU power
 sparam.waitframes = 6; % #frames for each object-images, 30 = 0.5 sec if the display vsynch = 60 Hz.

 %%% fixation period in msec before/after presenting the target stimuli, integer
 % must set a value more than 1 TR for initializing the frame counting.
 sparam.initial_fixation_time=[4000,4000];

 %%% fixation size &amp; color
 sparam.fixtype=1; % 1: circular, 2: rectangular, 3: concentric fixation point
 sparam.fixsize=12; % radius in pixels
 sparam.fixcolor=[255,255,255];

 %%% background color
 sparam.bgcolor=sparam.colors(1,:); %[0,0,0];

 %%% background-patch colors (RGB)
 sparam.bgtype=1; % 1: a simple background with sparam.bgcolor (then, the parameters belows are not used), 2: a background with grid guides
 sparam.patch_size=[30,30]; % background patch size, [height,width] in pixels
 sparam.patch_num=[20,40];  % the number of background patches along vertical and horizontal axis
 sparam.patch_color1=[255,255,255];
 sparam.patch_color2=[0,0,0];

 %%% for converting degree to pixels
 run(fullfile(fileparts(mfilename('fullpath')),'sizeparams'));
 %sparam.pix_per_cm=57.1429;
 %sparam.vdist=65;
 %sparam.ipd=6.5;


 [HOWTO create stimulus files]
 1. All of the stimuli are created in this script in real-time
    with MATLAB scripts &amp; functions.
    see ../Generation &amp; ../Common directries.
 2. Stimulus parameters are defined in the display &amp; stimulus file.


 [reference]
 for stmulus generation, see ../Generation &amp; ../Common directories.</pre></div>

<!-- crossreference -->
<h2><a name="_cross"></a>CROSS-REFERENCE INFORMATION <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
<div class="fragment" style="background-image:url(../../hb_brain.png); background-position:right top">
This function calls:
<ul style="list-style-image:url(../../matlabicon.gif)">
<li><a href="../../Retinotopy/Common/BackUpObsoleteFiles.html" class="code" title="function [new_fname,backup_fname]=BackUpObsoleteFiles(tgt_dir,tgt_fname,backup_prefix)">BackUpObsoleteFiles</a>	Backups already-existing file(s) in the target directory by adding some file-prefix.</li><li><a href="../../Retinotopy/Common/CalcDistFromDisparity.html" class="code" title="function zdist = CalcDistFromDisparity(ipd,disparity,viewdist)">CalcDistFromDisparity</a>	Calculates the actual distance (cm) from binocular disparity (arcmin).</li><li><a href="../../Retinotopy/Common/CheckPTBversion.html" class="code" title="function [PTB_OK,vertxt] = CheckPTBversion(num_mainver_youwant)">CheckPTBversion</a>	Checks the version of the currently running Psychtoolbox.</li><li><a href="../../Retinotopy/Common/CreateBackgroundImage.html" class="code" title="function [Bimg,parameters] = CreateBackgroundImage(wdims,stdims,pdims,bgcolor,color1,color2,fixcolor,patchnum,fix_flag,save_flag,show_flag)">CreateBackgroundImage</a>	Creates background image that can be used as a background of your stimulus displays.</li><li><a href="../../Retinotopy/Common/CreateColoredNoise.html" class="code" title="function img=CreateColoredNoise(idims,sdims,num,beta,norm_flg,save_flg,show_flg)">CreateColoredNoise</a>	Creates colored (i.e. pink, brown(ian), blue, and white) noise image(s).</li><li><a href="../../Retinotopy/Common/CreateFixationImgCircular.html" class="code" title="function fix=CreateFixationImgCircular(fixsize,fixcolor,bgcolor,circlesize,show_flag,save_flag)">CreateFixationImgCircular</a>	Creates a circular fixation image for a monocular display setting.</li><li><a href="../../Retinotopy/Common/CreateFixationImgConcentrateMono.html" class="code" title="function fix=CreateFixationImgConcentrateMono(fixsize,fixcolor,bgcolor,circlesize,gap,show_flag,save_flag)">CreateFixationImgConcentrateMono</a>	Creates a circular fixation image for a monocular display setting.</li><li><a href="../../Retinotopy/Common/CreateFixationImgMono.html" class="code" title="function fix=CreateFixationImgMono(fixsize,fixcolor,bgcolor,fixlinew,fixlineh,show_flag,save_flag)">CreateFixationImgMono</a>	Creates a cross-shaped fixation image for a monocular display setting.</li><li><a href="../../Retinotopy/Common/DisplayMessage2.html" class="code" title="function DisplayMessage2(message,bgcolor,winPtr,numScreens,drawing_font,drawing_size)">DisplayMessage2</a>	Displays message on the center of each of multiple PTB windows.</li><li><a href="../../Retinotopy/Common/GammaLoadPTB.html" class="code" title="function GammaLoadPTB(gamma_table)">GammaLoadPTB</a>	Loads and sets display gamma-table(s) using PTB Screen() function.</li><li><a href="../../Retinotopy/Common/GammaResetPTB.html" class="code" title="function GammaResetPTB(luminance_ratio)">GammaResetPTB</a>	Resets display gamma with PTB Screen() function.</li><li><a href="../../Retinotopy/Common/InitializePTBDisplays.html" class="code" title="function [winPtr,winRect,nScr,fps,ifi,initDisplay_OK]=InitializePTBDisplays(disp_mode,bgcolor,flipping,rgb_gains,custom_scrIDs)">InitializePTBDisplays</a>	Initializes PTB screen(s) for monocular/binocular presentations using PsychImaging() function.</li><li><a href="../../Retinotopy/Common/InitializeRandomSeed.html" class="code" title="function cseed=InitializeRandomSeed">InitializeRandomSeed</a>	Initializes MATLAB internal state of a random seed.</li><li><a href="../../Retinotopy/Common/ValidateStructureFields.html" class="code" title="function structval=ValidateStructureFields(structval,varargin)">ValidateStructureFields</a>	Validates the input structure and set the default values to the missing field(s)</li><li><a href="../../Retinotopy/Common/eventlogger.html" class="code" title="">eventlogger</a>	</li><li><a href="../../Retinotopy/Common/isstructmember.html" class="code" title="function isFieldResult = isstructmember(inStruct, fieldName)">isstructmember</a>	Checks whether the target struct contains a filed you specified as a member.</li><li><a href="../../Retinotopy/Common/responselogger.html" class="code" title="">responselogger</a>	</li><li><a href="../../Retinotopy/Common/shuffle.html" class="code" title="function [Y,index] = shuffle(X)">shuffle</a>	Randomly sorts the input array.</li><li><a href="../../Retinotopy/Generation/ecc_GenerateCheckerBoard1D.html" class="code" title="function [checkerboard,bincheckerboard,mask]=ecc_GenerateCheckerBoard1D(edges,width,startangle,pix_per_deg,nwedges,nrings,phase)">ecc_GenerateCheckerBoard1D</a>	Generates checkerboard patterns (annulus-based subdivision) with an individual ID number on each patch.</li><li><a href="../../Retinotopy/Generation/pol_GenerateCheckerBoard1D.html" class="code" title="function [checkerboard,bincheckerboard,mask]=pol_GenerateCheckerBoard1D(rmin,rmax,width,startangle,pix_per_deg,nwedges,nrings,phase,dual_flg)">pol_GenerateCheckerBoard1D</a>	Generates checkerboard patterns (polar angle-based subdivision) with an individual ID number on each patch.</li></ul>
This function is called by:
<ul style="list-style-image:url(../../matlabicon.gif)">
</ul>
</div>
<!-- crossreference -->



<h2><a name="_source"></a>SOURCE CODE <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
<div class="fragment" style="background-image:url(../../hb_brain.png); background-position:right top"><pre>0001 <a name="_sub0" href="#_subfunctions" class="code">function idual_fixtask(subjID,exp_mode,acq,displayfile,stimulusfile,gamma_table,overwrite_flg,force_proceed_flag)</a>
0002 
0003 <span class="comment">% Object-image-defined retinotopy stimulus with fixation luminance change-detection tasks.</span>
0004 <span class="comment">% function idual_fixtask(subjID,exp_mode,acq,:displayfile,:stimulusfile,:gamma_table,:overwrite_flg,:force_proceed_flag)</span>
0005 <span class="comment">% (: is optional)</span>
0006 <span class="comment">%</span>
0007 <span class="comment">% - This function generates and presents dual retinotopy stimulus (rotating wedge +</span>
0008 <span class="comment">%   expanding/contracting annulus) on which object images are randomly located with</span>
0009 <span class="comment">%   brownian noise images on its background.</span>
0010 <span class="comment">%   The stimulus can be used to measure cortical retinotopy and to delineate retinotopic</span>
0011 <span class="comment">%   borders using the standard phase-encoded or pRF (population receptive field) analysis techniques.</span>
0012 <span class="comment">%</span>
0013 <span class="comment">%   references: 1. Population receptive field estimates in human visual cortex.</span>
0014 <span class="comment">%                  Dumoulin, S.O. and Wandell, B.A. (2008). Neuroimage, 39(2), 647-660.</span>
0015 <span class="comment">%               2. Borders of multiple visual areas in humans revealed by functional magnetic resonance imaging.</span>
0016 <span class="comment">%                  Sereno MI, Dale AM, Reppas JB, Kwong KK, Belliveau JW, Brady TJ, Rosen BR, Tootell RB. (1995).</span>
0017 <span class="comment">%                  Science 268(5212), 889-893.</span>
0018 <span class="comment">%               3. fMRI of human visual cortex.</span>
0019 <span class="comment">%                  Engel SA, Rumelhart DE, Wandell BA, Lee AT, Glover GH, Chichilnisky EJ, Shadlen MN. (1994).</span>
0020 <span class="comment">%                  Nature, 369(6481), 525.</span>
0021 <span class="comment">%               4. Visual field maps in human cortex.</span>
0022 <span class="comment">%                  Wandell BA, Dumoulin SO, Brewer AA. (2007). Neuron, 56(2), 366-383.</span>
0023 <span class="comment">%</span>
0024 <span class="comment">% - This script shoud be used with MATLAB Psychtoolbox version 3 or above.</span>
0025 <span class="comment">%</span>
0026 <span class="comment">% - Luminance detection task: the central fixation point (default: white)</span>
0027 <span class="comment">%   randomly turns to gray. An observer has to press the button if s/he</span>
0028 <span class="comment">%   detects this luminance change. Response keys are defined in displayfile.</span>
0029 <span class="comment">%</span>
0030 <span class="comment">% [about the object images used in this function]</span>
0031 <span class="comment">% The object images used in this function (stored in ~/Retinotopy/object_images/ as object_image_database.mat) are</span>
0032 <span class="comment">% obtained and modified from the databases publicly available from http://konklab.fas.harvard.edu/#</span>
0033 <span class="comment">% I sincerely express my gratitude to the developers, distributors, and scientists in Dr Talia Konkle's research group</span>
0034 <span class="comment">% for their contributions to these databases. When you use this function for your research, please cite the original</span>
0035 <span class="comment">% papers listed below.</span>
0036 <span class="comment">%</span>
0037 <span class="comment">% - Tripartite Organization of the Ventral Stream by Animacy and Object Size.</span>
0038 <span class="comment">%   Konkle, T., &amp; Caramazza, A. (2013). Journal of Neuroscience, 33 (25), 10235-42.</span>
0039 <span class="comment">%</span>
0040 <span class="comment">% - A real-world size organization of object responses in occipito-temporal cortex.</span>
0041 <span class="comment">%   Konkle. T., &amp; Oliva, A. (2012). Neuron, 74(6), 1114-24.</span>
0042 <span class="comment">%</span>
0043 <span class="comment">% - Visual long-term memory has a massive storage capacity for object details.</span>
0044 <span class="comment">%   Brady, T. F., Konkle, T., Alvarez, G. A. &amp; Oliva, A. (2008). Proceedings of the National Academy of Sciences USA, 105(38), 14325-9.</span>
0045 <span class="comment">%</span>
0046 <span class="comment">% - Conceptual distinctiveness supports detailed visual long-term memory.</span>
0047 <span class="comment">%   Konkle, T., Brady, T. F., Alvarez, G. A., &amp; Oliva, A. (2010). Journal of Experimental Psychology: General, 139(3), 558-578.</span>
0048 <span class="comment">%</span>
0049 <span class="comment">% - A Familiar Size Stroop Effect: Real-world size is an automatic property of object representation.</span>
0050 <span class="comment">%   Konkle, T., &amp; Oliva, A. (2012). Journal of Experimental Psychology: Human Perception &amp; Performance, 38, 561-9.</span>
0051 <span class="comment">%</span>
0052 <span class="comment">% [note]</span>
0053 <span class="comment">% Behavioral task of (function_name)_fixtask is to detect changes of luminance</span>
0054 <span class="comment">% of the central fixation point, while the task in (function_name) is to detect</span>
0055 <span class="comment">% changes of luminance of one of the patches in the checkerboard stimuli.</span>
0056 <span class="comment">% Here, the central fixation task is more easy to sustain the stable fixation</span>
0057 <span class="comment">% on the center of the screen and may be suitable for naive/non-expert</span>
0058 <span class="comment">% participants with minimizing unwilling eye movements. However, some studies</span>
0059 <span class="comment">% have reported that attention to the target stimulus (checker-patch luminance</span>
0060 <span class="comment">% change detection task) is required to get reliable retinotopic representations</span>
0061 <span class="comment">% in higher-order visual areas.</span>
0062 <span class="comment">%</span>
0063 <span class="comment">%</span>
0064 <span class="comment">% Created    : &quot;2018-12-20 14:26:03 ban&quot;</span>
0065 <span class="comment">% Last Update: &quot;2021-06-07 17:18:34 ban&quot;</span>
0066 <span class="comment">%</span>
0067 <span class="comment">%</span>
0068 <span class="comment">%</span>
0069 <span class="comment">% [input variables]</span>
0070 <span class="comment">% sujID         : ID of subject, string, such as 's01'</span>
0071 <span class="comment">%                 you also need to create a directory ./subjects/(subj) and put displayfile and stimulusfile there.</span>
0072 <span class="comment">%                 !!!!!!!!!!!!!!!!!! IMPORTANT NOTE !!!!!!!!!!!!!!!!!!!!!!!!</span>
0073 <span class="comment">%                 !!! if 'debug' (case insensitive) is included          !!!</span>
0074 <span class="comment">%                 !!! in subjID string, this program runs as DEBUG mode; !!!</span>
0075 <span class="comment">%                 !!! stimulus images are saved as *.png format at       !!!</span>
0076 <span class="comment">%                 !!! ~/Retinotopy/Presentation/images                   !!!</span>
0077 <span class="comment">%                 !!!!!!!!!!!!!!!!!! IMPORTANT NOTE !!!!!!!!!!!!!!!!!!!!!!!!</span>
0078 <span class="comment">%</span>
0079 <span class="comment">% exp_mode      : experiment mode that you want to run, one of</span>
0080 <span class="comment">%  - ccwexp : a wedge rotating counter-clockwisely + an expanding annulus</span>
0081 <span class="comment">%  - cwexp  : a wedge rotating clockwisely + an expanding annulus</span>
0082 <span class="comment">%  - ccwcont: a wedge rotating counter-clockwisely + a contracting annulus</span>
0083 <span class="comment">%  - cwcont : a wedge rotating clockwisely + a contracting annulus</span>
0084 <span class="comment">% acq           : acquisition number (design file number),</span>
0085 <span class="comment">%                 an integer, such as 1, 2, 3, ...</span>
0086 <span class="comment">% displayfile   : (optional) display condition file,</span>
0087 <span class="comment">%                 *.m file, such as 'RetDepth_display_fmri.m'</span>
0088 <span class="comment">%                 the file should be located in ./subjects/(subj)/</span>
0089 <span class="comment">% stimulusfile  : (optional) stimulus condition file,</span>
0090 <span class="comment">%                 *.m file, such as 'RetDepth_stimulus_exp1.m'</span>
0091 <span class="comment">%                 the file should be located in ./subjects/(subj)/</span>
0092 <span class="comment">% gamma_table   : (optional) table(s) of gamma-corrected video input values (Color LookupTable).</span>
0093 <span class="comment">%                 256(8-bits) x 3(RGB) x 1(or 2,3,... when using multiple displays) matrix</span>
0094 <span class="comment">%                 or a *.mat file specified with a relative path format. e.g. '/gamma_table/gamma1.mat'</span>
0095 <span class="comment">%                 The *.mat should include a variable named &quot;gamma_table&quot; consists of a 256x3xN matrix.</span>
0096 <span class="comment">%                 if you use multiple (more than 1) displays and set a 256x3x1 gamma-table, the same</span>
0097 <span class="comment">%                 table will be applied to all displays. if the number of displays and gamma tables</span>
0098 <span class="comment">%                 are different (e.g. you have 3 displays and 256x3x!2! gamma-tables), the last</span>
0099 <span class="comment">%                 gamma_table will be applied to the second and third displays.</span>
0100 <span class="comment">%                 if empty, normalized gamma table (repmat(linspace(0.0,1.0,256),3,1)) will be applied.</span>
0101 <span class="comment">% overwrite_flg : (optional) whether overwriting pre-existing result file. if 1, the previous result</span>
0102 <span class="comment">%                 file with the same acquisition number will be overwritten by the previous one.</span>
0103 <span class="comment">%                 if 0, the existing file will be backed-up by adding a prefix '_old' at the tail</span>
0104 <span class="comment">%                 of the file. 0 by default.</span>
0105 <span class="comment">% force_proceed_flag : (optional) whether proceeding stimulus presentatin without waiting for</span>
0106 <span class="comment">%                 the experimenter response (e.g. presesing the ENTER key) or a trigger.</span>
0107 <span class="comment">%                 if 1, the stimulus presentation will be automatically carried on.</span>
0108 <span class="comment">%</span>
0109 <span class="comment">% !!! NOTICE !!!!</span>
0110 <span class="comment">% displayfile &amp; stimulusfile should be located at</span>
0111 <span class="comment">% ./subjects/(subjID)/</span>
0112 <span class="comment">% as ./subjects/(subjID)/*_display_fmri.m</span>
0113 <span class="comment">%    ./subjects/(subjID)/*_stimuli.m</span>
0114 <span class="comment">%</span>
0115 <span class="comment">%</span>
0116 <span class="comment">% [output variables]</span>
0117 <span class="comment">% no output matlab variable.</span>
0118 <span class="comment">%</span>
0119 <span class="comment">%</span>
0120 <span class="comment">% [output files]</span>
0121 <span class="comment">% 1. result file</span>
0122 <span class="comment">%    stored ./subjects/(subjID)/results/(date)</span>
0123 <span class="comment">%    as ./subjects/(subjID)/results/(date)/(subjID)_idual_fixtask_(exp_mode)_results_run_(run_num).mat</span>
0124 <span class="comment">%</span>
0125 <span class="comment">%</span>
0126 <span class="comment">% [example]</span>
0127 <span class="comment">% &gt;&gt; idual_fixtask('HB','ccwexp',1,'ret_display.m','ret_checker_stimulus_exp1.m')</span>
0128 <span class="comment">%</span>
0129 <span class="comment">% [About displayfile]</span>
0130 <span class="comment">% The contents of the displayfile are as below.</span>
0131 <span class="comment">% (The file includs 6 lines of headers and following display parameters)</span>
0132 <span class="comment">%</span>
0133 <span class="comment">% (an example of the displayfile)</span>
0134 <span class="comment">%</span>
0135 <span class="comment">% % ************************************************************</span>
0136 <span class="comment">% % This is the display configuration file for the retinotopy stimuli</span>
0137 <span class="comment">% % Programmed by Hiroshi Ban Nov 01 2013</span>
0138 <span class="comment">% % ************************************************************</span>
0139 <span class="comment">%</span>
0140 <span class="comment">% % display mode, one of &quot;mono&quot;, &quot;dual&quot;, &quot;dualcross&quot;, &quot;dualparallel&quot;, &quot;cross&quot;, &quot;parallel&quot;, &quot;redgreen&quot;, &quot;greenred&quot;,</span>
0141 <span class="comment">% % &quot;redblue&quot;, &quot;bluered&quot;, &quot;shutter&quot;, &quot;topbottom&quot;, &quot;bottomtop&quot;, &quot;interleavedline&quot;, &quot;interleavedcolumn&quot;, &quot;propixxmono&quot;, &quot;propixxstereo&quot;</span>
0142 <span class="comment">% dparam.ExpMode='mono';</span>
0143 <span class="comment">%</span>
0144 <span class="comment">% dparam.scrID=1; % screen ID, generally 0 for a single display setup, 1 for dual display setup</span>
0145 <span class="comment">%</span>
0146 <span class="comment">% % a method to start stimulus presentation</span>
0147 <span class="comment">% % 0:ENTER/SPACE, 1:Left-mouse button, 2:the first MR trigger pulse (CiNet),</span>
0148 <span class="comment">% % 3:waiting for a MR trigger pulse (BUIC) -- checking onset of pin #11 of the parallel port,</span>
0149 <span class="comment">% % or 4:custom key trigger (wait for a key input that you specify as tgt_key).</span>
0150 <span class="comment">% dparam.start_method=2;</span>
0151 <span class="comment">%</span>
0152 <span class="comment">% % a pseudo trigger key from the MR scanner when it starts, valid only when dparam.start_method=4;</span>
0153 <span class="comment">% dparam.custom_trigger='t';</span>
0154 <span class="comment">%</span>
0155 <span class="comment">% % keyboard settings</span>
0156 <span class="comment">% dparam.Key1=51; % key 1 (left)</span>
0157 <span class="comment">% dparam.Key2=52; % key 2 (right)</span>
0158 <span class="comment">%</span>
0159 <span class="comment">% % screen settings</span>
0160 <span class="comment">%</span>
0161 <span class="comment">% %%% whether displaying the stimuli in full-screen mode or</span>
0162 <span class="comment">% %%% as is (the precise resolution), 'true' or 'false' (true)</span>
0163 <span class="comment">% dparam.fullscr=false;</span>
0164 <span class="comment">%</span>
0165 <span class="comment">% %%% the resolution of the screen height</span>
0166 <span class="comment">% dparam.ScrHeight=1200;</span>
0167 <span class="comment">%</span>
0168 <span class="comment">% %% the resolution of the screen width</span>
0169 <span class="comment">% dparam.ScrWidth=1920;</span>
0170 <span class="comment">%</span>
0171 <span class="comment">% % whether forcing to use specific frame rate, if 0, the frame rate wil bw computed in the ImagesShowPTB function.</span>
0172 <span class="comment">% % if non zero, the value is used as the screen frame rate.</span>
0173 <span class="comment">% dparam.force_frame_rate=60;</span>
0174 <span class="comment">%</span>
0175 <span class="comment">% % whther skipping the PTB's vertical-sync signal test. if 1, the sync test is skipped</span>
0176 <span class="comment">% dparam.skip_sync_test=0;</span>
0177 <span class="comment">%</span>
0178 <span class="comment">%</span>
0179 <span class="comment">% [About stimulusfile]</span>
0180 <span class="comment">% The contents of the stimulusfile are as below.</span>
0181 <span class="comment">% (The file includs 6 lines of headers and following stimulus parameters)</span>
0182 <span class="comment">%</span>
0183 <span class="comment">% (an example of the stimulusfile)</span>
0184 <span class="comment">%</span>
0185 <span class="comment">% % ************************************************************</span>
0186 <span class="comment">% % This is the stimulus parameter file for the dual (wedge + annulus) retinotopy stimulus</span>
0187 <span class="comment">% % Programmed by Hiroshi Ban Jan 25 2019</span>
0188 <span class="comment">% % ************************************************************</span>
0189 <span class="comment">%</span>
0190 <span class="comment">% % &quot;sparam&quot; means &quot;stimulus generation parameters&quot;</span>
0191 <span class="comment">%</span>
0192 <span class="comment">% %%% stimulus parameters</span>
0193 <span class="comment">% sparam.pol_width       = 48;    % wedge width in deg along polar angle</span>
0194 <span class="comment">% sparam.pol_rotangle    = 12;    % rotation angle in deg</span>
0195 <span class="comment">% sparam.pol_startangle  = -sparam.pol_width/2-90; % presentation start angle in deg, from right-horizontal meridian, ccw</span>
0196 <span class="comment">%</span>
0197 <span class="comment">% sparam.ecc_width       = sparam.pol_width/2;</span>
0198 <span class="comment">% sparam.ecc_rotangle    = sparam.pol_rotangle;</span>
0199 <span class="comment">% sparam.ecc_startangle  = -sparam.ecc_width/2-90;  % presentation start angle in deg, from right-horizontal meridian, ccw (actually this value is not used for the eccentricity stimuli (exp and cont))</span>
0200 <span class="comment">%</span>
0201 <span class="comment">% sparam.maxRad      = 6.0;  % maximum radius of  annulus (degrees)</span>
0202 <span class="comment">% sparam.minRad      = 0;    % minumum</span>
0203 <span class="comment">%</span>
0204 <span class="comment">% %%% duration in msec for each cycle &amp; repetitions</span>
0205 <span class="comment">% % ===========================================================================================================================================</span>
0206 <span class="comment">% % IMPORTANT NOTE: sparam.pol_cycle_duration x sparam.pol_numRepeats should be the same with sparam.ecc_cycle_duration x sparam.ecc_numRepeats</span>
0207 <span class="comment">% % ===========================================================================================================================================</span>
0208 <span class="comment">%</span>
0209 <span class="comment">% sparam.pol_cycle_duration=60000; % msec</span>
0210 <span class="comment">% sparam.pol_rest_duration =0; % msec, rest after each cycle, stimulation = cycle_duration-eccrest</span>
0211 <span class="comment">% sparam.pol_numRepeats=6;</span>
0212 <span class="comment">%</span>
0213 <span class="comment">% sparam.ecc_cycle_duration=40000; % msec</span>
0214 <span class="comment">% sparam.ecc_rest_duration =8000; % msec, rest after each cycle, stimulation = cycle_duration-eccrest</span>
0215 <span class="comment">% sparam.ecc_numRepeats=9;</span>
0216 <span class="comment">%</span>
0217 <span class="comment">% %%% parameters used only for object-image-based retinotopy stimuli</span>
0218 <span class="comment">% sparam.flip_duration=250; % msec</span>
0219 <span class="comment">% sparam.nimg=120; % number of images to be presented at a frame</span>
0220 <span class="comment">% sparam.imRatio=[0.2,0.5]; % image magnification ratio, [min, max] (0.0-1.0), the image sizes are randomly selected whithin this range</span>
0221 <span class="comment">% sparam.imdepth=[-12,12]; % disparities (arcmins) added to the images, effective only in a stereo mode (e.g. shutter, dual, parallel etc)</span>
0222 <span class="comment">%</span>
0223 <span class="comment">% %%% set number of frames to flip the screen</span>
0224 <span class="comment">% % Here, I set the number as large as I can to minimize vertical cynching error.</span>
0225 <span class="comment">% % Set 1 if you want to flip the display at each vertical sync, but not recommended as it uses much CPU power</span>
0226 <span class="comment">% sparam.waitframes = 6; % #frames for each object-images, 30 = 0.5 sec if the display vsynch = 60 Hz.</span>
0227 <span class="comment">%</span>
0228 <span class="comment">% %%% fixation period in msec before/after presenting the target stimuli, integer</span>
0229 <span class="comment">% % must set a value more than 1 TR for initializing the frame counting.</span>
0230 <span class="comment">% sparam.initial_fixation_time=[4000,4000];</span>
0231 <span class="comment">%</span>
0232 <span class="comment">% %%% fixation size &amp; color</span>
0233 <span class="comment">% sparam.fixtype=1; % 1: circular, 2: rectangular, 3: concentric fixation point</span>
0234 <span class="comment">% sparam.fixsize=12; % radius in pixels</span>
0235 <span class="comment">% sparam.fixcolor=[255,255,255];</span>
0236 <span class="comment">%</span>
0237 <span class="comment">% %%% background color</span>
0238 <span class="comment">% sparam.bgcolor=sparam.colors(1,:); %[0,0,0];</span>
0239 <span class="comment">%</span>
0240 <span class="comment">% %%% background-patch colors (RGB)</span>
0241 <span class="comment">% sparam.bgtype=1; % 1: a simple background with sparam.bgcolor (then, the parameters belows are not used), 2: a background with grid guides</span>
0242 <span class="comment">% sparam.patch_size=[30,30]; % background patch size, [height,width] in pixels</span>
0243 <span class="comment">% sparam.patch_num=[20,40];  % the number of background patches along vertical and horizontal axis</span>
0244 <span class="comment">% sparam.patch_color1=[255,255,255];</span>
0245 <span class="comment">% sparam.patch_color2=[0,0,0];</span>
0246 <span class="comment">%</span>
0247 <span class="comment">% %%% for converting degree to pixels</span>
0248 <span class="comment">% run(fullfile(fileparts(mfilename('fullpath')),'sizeparams'));</span>
0249 <span class="comment">% %sparam.pix_per_cm=57.1429;</span>
0250 <span class="comment">% %sparam.vdist=65;</span>
0251 <span class="comment">% %sparam.ipd=6.5;</span>
0252 <span class="comment">%</span>
0253 <span class="comment">%</span>
0254 <span class="comment">% [HOWTO create stimulus files]</span>
0255 <span class="comment">% 1. All of the stimuli are created in this script in real-time</span>
0256 <span class="comment">%    with MATLAB scripts &amp; functions.</span>
0257 <span class="comment">%    see ../Generation &amp; ../Common directries.</span>
0258 <span class="comment">% 2. Stimulus parameters are defined in the display &amp; stimulus file.</span>
0259 <span class="comment">%</span>
0260 <span class="comment">%</span>
0261 <span class="comment">% [reference]</span>
0262 <span class="comment">% for stmulus generation, see ../Generation &amp; ../Common directories.</span>
0263 
0264 
0265 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0266 <span class="comment">%%%% Check the input variables</span>
0267 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0268 
0269 clear <span class="keyword">global</span>; clear mex;
0270 <span class="keyword">if</span> nargin&lt;3, help(mfilename()); <span class="keyword">return</span>; <span class="keyword">end</span>
0271 <span class="keyword">if</span> nargin&lt;4 || isempty(displayfile), displayfile=[]; <span class="keyword">end</span>
0272 <span class="keyword">if</span> nargin&lt;5 || isempty(stimulusfile), stimulusfile=[]; <span class="keyword">end</span>
0273 <span class="keyword">if</span> nargin&lt;6 || isempty(gamma_table), gamma_table=[]; <span class="keyword">end</span>
0274 <span class="keyword">if</span> nargin&lt;7 || isempty(overwrite_flg), overwrite_flg=1; <span class="keyword">end</span>
0275 <span class="keyword">if</span> nargin&lt;8 || isempty(force_proceed_flag), force_proceed_flag=0; <span class="keyword">end</span>
0276 
0277 <span class="comment">% check the aqcuisition number</span>
0278 <span class="keyword">if</span> acq&lt;1, error(<span class="string">'Acquistion number must be integer and greater than zero'</span>); <span class="keyword">end</span>
0279 
0280 <span class="comment">% check the experiment mode (stimulus type)</span>
0281 <span class="keyword">if</span> ~strcmpi(exp_mode,<span class="string">'ccwexp'</span>) &amp;&amp; ~strcmpi(exp_mode,<span class="string">'cwexp'</span>) &amp;&amp; ~strcmpi(exp_mode,<span class="string">'ccwcont'</span>) &amp;&amp; ~strcmpi(exp_mode,<span class="string">'cwcont'</span>)
0282   error(<span class="string">'exp_mode should be one of &quot;ccwexp&quot;, &quot;cwexp&quot;, &quot;ccwcont&quot;, and &quot;cwcont&quot;. check the input variable.'</span>);
0283 <span class="keyword">end</span>
0284 
0285 rootDir=fileparts(mfilename(<span class="string">'fullpath'</span>));
0286 
0287 <span class="comment">% check the subject directory</span>
0288 <span class="keyword">if</span> ~exist(fullfile(rootDir,<span class="string">'subjects'</span>,subjID),<span class="string">'dir'</span>), error(<span class="string">'can not find subj directory. check the input variable.'</span>); <span class="keyword">end</span>
0289 
0290 <span class="comment">% check the display/stimulus files</span>
0291 <span class="keyword">if</span> ~isempty(displayfile)
0292   <span class="keyword">if</span> ~strcmpi(displayfile(end-1:end),<span class="string">'.m'</span>), displayfile=[displayfile,<span class="string">'.m'</span>]; <span class="keyword">end</span>
0293   <span class="keyword">if</span> ~exist(fullfile(rootDir,<span class="string">'subjects'</span>,subjID,displayfile),<span class="string">'file'</span>), error(<span class="string">'displayfile not found. check the input variable.'</span>); <span class="keyword">end</span>
0294 <span class="keyword">end</span>
0295 
0296 <span class="keyword">if</span> ~isempty(stimulusfile)
0297   <span class="keyword">if</span> ~strcmpi(stimulusfile(end-1:end),<span class="string">'.m'</span>), stimulusfile=[stimulusfile,<span class="string">'.m'</span>]; <span class="keyword">end</span>
0298   <span class="keyword">if</span> ~exist(fullfile(rootDir,<span class="string">'subjects'</span>,subjID,stimulusfile),<span class="string">'file'</span>), error(<span class="string">'stimulusfile not found. check the input variable.'</span>); <span class="keyword">end</span>
0299 <span class="keyword">end</span>
0300 
0301 
0302 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0303 <span class="comment">%%%% Add path to the subfunctions</span>
0304 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0305 
0306 <span class="comment">% add paths to the subfunctions</span>
0307 addpath(genpath(fullfile(rootDir,<span class="string">'..'</span>,<span class="string">'Common'</span>)));
0308 addpath(fullfile(rootDir,<span class="string">'..'</span>,<span class="string">'Generation'</span>));
0309 
0310 
0311 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0312 <span class="comment">%%%% For log file</span>
0313 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0314 
0315 <span class="comment">% get date</span>
0316 today=datestr(now,<span class="string">'yymmdd'</span>);
0317 
0318 <span class="comment">% result directry &amp; file</span>
0319 resultDir=fullfile(rootDir,<span class="string">'subjects'</span>,num2str(subjID),<span class="string">'results'</span>,today);
0320 <span class="keyword">if</span> ~exist(resultDir,<span class="string">'dir'</span>), mkdir(resultDir); <span class="keyword">end</span>
0321 
0322 <span class="comment">% record the output window</span>
0323 logfname=fullfile(resultDir,[num2str(subjID),<span class="string">'_idual_fixtask_'</span>,exp_mode,<span class="string">'_results_run_'</span>,num2str(acq,<span class="string">'%02d'</span>),<span class="string">'.log'</span>]);
0324 diary(logfname);
0325 warning off; <span class="comment">%#ok warning('off','MATLAB:dispatcher:InexactCaseMatch');</span>
0326 
0327 
0328 <span class="comment">%%%%% try &amp; catch %%%%%</span>
0329 <span class="keyword">try</span>
0330 
0331 
0332 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0333 <span class="comment">%%%% Check the PTB version</span>
0334 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0335 
0336 PTB_OK=<a href="../../Retinotopy/Common/CheckPTBversion.html" class="code" title="function [PTB_OK,vertxt] = CheckPTBversion(num_mainver_youwant)">CheckPTBversion</a>(3); <span class="comment">% check wether the PTB version is 3</span>
0337 <span class="keyword">if</span> ~PTB_OK, error(<span class="string">'Wrong version of Psychtoolbox is running. %s requires PTB ver.3'</span>,mfilename()); <span class="keyword">end</span>
0338 
0339 <span class="comment">% debug level, black screen during calibration</span>
0340 Screen(<span class="string">'Preference'</span>, <span class="string">'VisualDebuglevel'</span>, 3);
0341 
0342 
0343 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0344 <span class="comment">%%%% Setup random seed</span>
0345 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0346 
0347 <a href="../../Retinotopy/Common/InitializeRandomSeed.html" class="code" title="function cseed=InitializeRandomSeed">InitializeRandomSeed</a>();
0348 
0349 
0350 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0351 <span class="comment">%%%% Reset display Gamma-function</span>
0352 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0353 
0354 <span class="keyword">if</span> isempty(gamma_table)
0355   gamma_table=repmat(linspace(0.0,1.0,256),3,1); <span class="comment">%#ok</span>
0356   <a href="../../Retinotopy/Common/GammaResetPTB.html" class="code" title="function GammaResetPTB(luminance_ratio)">GammaResetPTB</a>(1.0);
0357 <span class="keyword">else</span>
0358   <a href="../../Retinotopy/Common/GammaLoadPTB.html" class="code" title="function GammaLoadPTB(gamma_table)">GammaLoadPTB</a>(gamma_table);
0359 <span class="keyword">end</span>
0360 
0361 
0362 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0363 <span class="comment">%%%% Validate dparam (displayfile) and sparam (stimulusfile) structures</span>
0364 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0365 
0366 <span class="comment">% organize dparam</span>
0367 dparam=struct(); <span class="comment">% initialize</span>
0368 <span class="keyword">if</span> ~isempty(displayfile), run(fullfile(rootDir,<span class="string">'subjects'</span>,subjID,displayfile)); <span class="keyword">end</span> <span class="comment">% load specific dparam parameters configured for each of the participants</span>
0369 dparam=<a href="../../Retinotopy/Common/ValidateStructureFields.html" class="code" title="function structval=ValidateStructureFields(structval,varargin)">ValidateStructureFields</a>(dparam,<span class="keyword">...</span><span class="comment"> % validate fields and set the default values to missing field(s)</span>
0370          <span class="string">'ExpMode'</span>,<span class="string">'mono'</span>,<span class="keyword">...</span>
0371          <span class="string">'scrID'</span>,1,<span class="keyword">...</span>
0372          <span class="string">'start_method'</span>,0,<span class="keyword">...</span>
0373          <span class="string">'custom_trigger'</span>,<span class="string">'t'</span>,<span class="keyword">...</span>
0374          <span class="string">'Key1'</span>,51,<span class="keyword">...</span>
0375          <span class="string">'Key2'</span>,52,<span class="keyword">...</span>
0376          <span class="string">'fullscr'</span>,false,<span class="keyword">...</span>
0377          <span class="string">'ScrHeight'</span>,1200,<span class="keyword">...</span>
0378          <span class="string">'ScrWidth'</span>,1920,<span class="keyword">...</span>
0379          <span class="string">'force_frame_rate'</span>,60,<span class="keyword">...</span>
0380          <span class="string">'skip_sync_test'</span>,0);
0381 
0382 <span class="comment">% organize sparam</span>
0383 sparam=struct(); <span class="comment">% initialize</span>
0384 sparam.mode=exp_mode;
0385 <span class="keyword">if</span> ~isempty(stimulusfile), run(fullfile(rootDir,<span class="string">'subjects'</span>,subjID,stimulusfile)); <span class="keyword">end</span> <span class="comment">% load specific sparam parameters configured for each of the participants</span>
0386 sparam=<a href="../../Retinotopy/Common/ValidateStructureFields.html" class="code" title="function structval=ValidateStructureFields(structval,varargin)">ValidateStructureFields</a>(sparam,<span class="keyword">...</span><span class="comment"> % validate fields and set the default values to missing field(s)</span>
0387          <span class="string">'pol_width'</span>,48,<span class="keyword">...</span>
0388          <span class="string">'pol_rotangle'</span>,12,<span class="keyword">...</span>
0389          <span class="string">'pol_startangle'</span>,-48/2-90,<span class="keyword">...</span>
0390          <span class="string">'ecc_width'</span>,48,<span class="keyword">...</span>
0391          <span class="string">'ecc_rotangle'</span>,12,<span class="keyword">...</span>
0392          <span class="string">'ecc_startangle'</span>,-48/2-90,<span class="keyword">...</span>
0393          <span class="string">'maxRad'</span>,8,<span class="keyword">...</span>
0394          <span class="string">'minRad'</span>,0,<span class="keyword">...</span>
0395          <span class="string">'pol_cycle_duration'</span>,60000,<span class="keyword">...</span>
0396          <span class="string">'pol_rest_duration'</span>,0,<span class="keyword">...</span>
0397          <span class="string">'pol_numRepeats'</span>,6,<span class="keyword">...</span>
0398          <span class="string">'ecc_cycle_duration'</span>,40000,<span class="keyword">...</span>
0399          <span class="string">'ecc_rest_duration'</span>,8000,<span class="keyword">...</span>
0400          <span class="string">'ecc_numRepeats'</span>,9,<span class="keyword">...</span>
0401          <span class="string">'flip_duration'</span>,250,<span class="keyword">...</span>
0402          <span class="string">'nimg'</span>,120,<span class="keyword">...</span>
0403          <span class="string">'imRatio'</span>,[0.2,0.5],<span class="keyword">...</span>
0404          <span class="string">'imdepth'</span>,[-12,12],<span class="keyword">...</span><span class="comment"> % effective only when the stimuli are presented in stereo mode (e.g. dual, cross, parallel etc)</span>
0405          <span class="string">'waitframes'</span>,6,<span class="keyword">...</span><span class="comment"> % Screen('FrameRate',0)*(sparam.cycle_duration/1000) / (360/sparam.rotangle) / ( (size(sparam.colors,1)-1)*2 );</span>
0406          <span class="string">'initial_fixation_time'</span>,[4000,4000],<span class="keyword">...</span>
0407          <span class="string">'fixtype'</span>,1,<span class="keyword">...</span>
0408          <span class="string">'fixsize'</span>,12,<span class="keyword">...</span>
0409          <span class="string">'fixcolor'</span>,[255,255,255],<span class="keyword">...</span>
0410          <span class="string">'bgcolor'</span>,[128,128,128],<span class="keyword">...</span><span class="comment"> % sparam.colors(1,:);</span>
0411          <span class="string">'bgtype'</span>,1,<span class="keyword">...</span>
0412          <span class="string">'patch_size'</span>,[30,30],<span class="keyword">...</span>
0413          <span class="string">'patch_num'</span>,[20,40],<span class="keyword">...</span>
0414          <span class="string">'patch_color1'</span>,[255,255,255],<span class="keyword">...</span>
0415          <span class="string">'patch_color2'</span>,[0,0,0],<span class="keyword">...</span>
0416          <span class="string">'pix_per_cm'</span>,57.1429,<span class="keyword">...</span>
0417          <span class="string">'vdist'</span>,65,<span class="keyword">...</span>
0418          <span class="string">'ipd'</span>,6.5);
0419 
0420 <span class="comment">% change unit from msec to sec.</span>
0421 sparam.initial_fixation_time=sparam.initial_fixation_time./1000; <span class="comment">%#ok</span>
0422 
0423 <span class="comment">% change unit from msec to sec.</span>
0424 sparam.pol_cycle_duration = sparam.pol_cycle_duration./1000;
0425 sparam.pol_rest_duration  = sparam.pol_rest_duration./1000;
0426 
0427 sparam.ecc_cycle_duration = sparam.ecc_cycle_duration./1000;
0428 sparam.ecc_rest_duration  = sparam.ecc_rest_duration./1000;
0429 
0430 sparam.flip_duration  = sparam.flip_duration./1000;
0431 
0432 <span class="comment">% set the other parameters</span>
0433 dparam.RunScript = mfilename();
0434 sparam.RunScript = mfilename();
0435 
0436 <span class="comment">%% check varidity of parameters</span>
0437 fprintf(<span class="string">'checking validity of stimulus generation/presentation parameters...'</span>);
0438 <span class="keyword">if</span> sparam.pol_cycle_duration*sparam.pol_numRepeats~=sparam.ecc_cycle_duration*sparam.ecc_numRepeats
0439   error(<span class="string">'sparam.pol_cycle_duration x sparam.pol_numRepeats should be the same with sparam.ecc_cycle_duration x sparam.ecc_numRepeats. check the input variables.'</span>);
0440 <span class="keyword">end</span>
0441 <span class="keyword">if</span> mod(360,sparam.pol_rotangle), error(<span class="string">'mod(360,sparam.pol_rotangle) should be 0. check the input variables.'</span>); <span class="keyword">end</span>
0442 <span class="keyword">if</span> mod(360,sparam.ecc_rotangle), error(<span class="string">'mod(360,sparam.ecc_rotangle) should be 0. check the input variables.'</span>); <span class="keyword">end</span>
0443 <span class="keyword">if</span> mod(sparam.pol_width,sparam.pol_rotangle), error(<span class="string">'mod(sparam.pol_width,sparam.pol_rotangle) should be 0. check the input variables.'</span>); <span class="keyword">end</span>
0444 <span class="keyword">if</span> mod(sparam.ecc_width,sparam.ecc_rotangle), error(<span class="string">'mod(sparam.ecc_width,sparam.ecc_rotangle) should be 0. check the input variables.'</span>); <span class="keyword">end</span>
0445 fprintf(<span class="string">'done.\n'</span>);
0446 
0447 
0448 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0449 <span class="comment">%%%% Displaying the presentation parameters you set</span>
0450 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0451 
0452 fprintf(<span class="string">'The Presentation Parameters are as below.\n\n'</span>);
0453 fprintf(<span class="string">'************************************************\n'</span>);
0454 fprintf(<span class="string">'****** Script, Subject, Acquistion Number ******\n'</span>);
0455 fprintf(<span class="string">'Date &amp; Time            : %s\n'</span>,strcat([datestr(now,<span class="string">'yymmdd'</span>),<span class="string">' '</span>,datestr(now,<span class="string">'HH:mm:ss'</span>)]));
0456 fprintf(<span class="string">'Running Script Name    : %s\n'</span>,mfilename());
0457 fprintf(<span class="string">'Subject ID             : %s\n'</span>,subjID);
0458 fprintf(<span class="string">'Acquisition Number     : %d\n'</span>,acq);
0459 fprintf(<span class="string">'********* Run Type, Display Image Type *********\n'</span>);
0460 fprintf(<span class="string">'Display Mode           : %s\n'</span>,dparam.ExpMode);
0461 fprintf(<span class="string">'use Full Screen Mode   : %d\n'</span>,dparam.fullscr);
0462 fprintf(<span class="string">'Start Method           : %d\n'</span>,dparam.start_method);
0463 <span class="keyword">if</span> dparam.start_method==4
0464   fprintf(<span class="string">'Custom Trigger         : %d\n'</span>,dparam.custom_trigger);
0465 <span class="keyword">end</span>
0466 fprintf(<span class="string">'*************** Screen Settings ****************\n'</span>);
0467 fprintf(<span class="string">'Screen Height          : %d\n'</span>,dparam.ScrHeight);
0468 fprintf(<span class="string">'Screen Width           : %d\n'</span>,dparam.ScrWidth);
0469 fprintf(<span class="string">'*********** Stimulation Periods etc. ***********\n'</span>);
0470 fprintf(<span class="string">'Fixation Time(sec)     : %d &amp; %d\n'</span>,sparam.initial_fixation_time(1),sparam.initial_fixation_time(2));
0471 fprintf(<span class="string">'[POL] Cycle Duration(sec) : %d\n'</span>,sparam.pol_cycle_duration);
0472 fprintf(<span class="string">'      Rest  Duration(sec) : %d\n'</span>,sparam.pol_rest_duration);
0473 fprintf(<span class="string">'      Repetitions(cycles) : %d\n'</span>,sparam.pol_numRepeats);
0474 fprintf(<span class="string">'[ECC] Cycle Duration(sec) : %d\n'</span>,sparam.ecc_cycle_duration);
0475 fprintf(<span class="string">'      Rest  Duration(sec) : %d\n'</span>,sparam.ecc_rest_duration);
0476 fprintf(<span class="string">'      Repetitions(cycles) : %d\n'</span>,sparam.ecc_numRepeats);
0477 fprintf(<span class="string">'Frame Flip(per VerSync): %d\n'</span>,sparam.waitframes);
0478 fprintf(<span class="string">'Total Time (sec)       : %d\n'</span>,sum(sparam.initial_fixation_time)+sparam.pol_numRepeats*sparam.pol_cycle_duration);
0479 fprintf(<span class="string">'**************** Stimulus Type *****************\n'</span>);
0480 fprintf(<span class="string">'Experiment Mode        : %s\n'</span>,sparam.mode);
0481 fprintf(<span class="string">'************ Response key settings *************\n'</span>);
0482 fprintf(<span class="string">'Reponse Key #1         : %d = %s\n'</span>,dparam.Key1,KbName(dparam.Key1));
0483 fprintf(<span class="string">'Reponse Key #2         : %d = %s\n'</span>,dparam.Key2,KbName(dparam.Key2));
0484 fprintf(<span class="string">'************************************************\n\n'</span>);
0485 fprintf(<span class="string">'Please carefully check before proceeding.\n\n'</span>);
0486 
0487 
0488 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0489 <span class="comment">%%%% Initialize response &amp; event logger objects</span>
0490 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0491 
0492 <span class="comment">% initialize MATLAB objects for event and response logs</span>
0493 event=<a href="../../Retinotopy/Common/eventlogger.html" class="code" title="">eventlogger</a>();
0494 resps=<a href="../../Retinotopy/Common/responselogger.html" class="code" title="">responselogger</a>([dparam.Key1,dparam.Key2]);
0495 resps.initialize(event); <span class="comment">% initialize responselogger</span>
0496 
0497 
0498 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0499 <span class="comment">%%%% Wait for user reponse to start</span>
0500 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0501 
0502 <span class="keyword">if</span> ~force_proceed_flag
0503   [user_answer,resps]=resps.wait_to_proceed();
0504   <span class="keyword">if</span> ~user_answer, diary off; <span class="keyword">return</span>; <span class="keyword">end</span>
0505 <span class="keyword">end</span>
0506 
0507 
0508 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0509 <span class="comment">%%%% Initialization of Left &amp; Right screens for binocular presenting/viewing mode</span>
0510 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0511 
0512 <span class="keyword">if</span> dparam.skip_sync_test, Screen(<span class="string">'Preference'</span>,<span class="string">'SkipSyncTests'</span>,1); <span class="keyword">end</span>
0513 
0514 [winPtr,winRect,nScr,dparam.fps,dparam.ifi,initDisplay_OK]=<a href="../../Retinotopy/Common/InitializePTBDisplays.html" class="code" title="function [winPtr,winRect,nScr,fps,ifi,initDisplay_OK]=InitializePTBDisplays(disp_mode,bgcolor,flipping,rgb_gains,custom_scrIDs)">InitializePTBDisplays</a>(dparam.ExpMode,sparam.bgcolor,0,[],dparam.scrID);
0515 <span class="keyword">if</span> ~initDisplay_OK, error(<span class="string">'Display initialization error. Please check your exp_run parameter.'</span>); <span class="keyword">end</span>
0516 HideCursor();
0517 
0518 <span class="keyword">if</span> <a href="../../Retinotopy/Common/isstructmember.html" class="code" title="function isFieldResult = isstructmember(inStruct, fieldName)">isstructmember</a>(dparam,<span class="string">'force_frame_rate'</span>)
0519   <span class="keyword">if</span> dparam.force_frame_rate
0520     dparam.fps=dparam.force_frame_rate;
0521     dparam.ifi=1/dparam.fps;
0522   <span class="keyword">end</span>
0523 <span class="keyword">end</span>
0524 
0525 
0526 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0527 <span class="comment">%%%% Setting the PTB runnning priority to MAX</span>
0528 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0529 
0530 <span class="comment">% set the priority of this script to MAX</span>
0531 priorityLevel=MaxPriority(winPtr,<span class="string">'WaitBlanking'</span>);
0532 Priority(priorityLevel);
0533 
0534 <span class="comment">% conserve VRAM memory: Workaround for flawed hardware and drivers</span>
0535 <span class="comment">% 32 == kPsychDontShareContextRessources: Do not share ressources between</span>
0536 <span class="comment">% different onscreen windows. Usually you want PTB to share all ressources</span>
0537 <span class="comment">% like offscreen windows, textures and GLSL shaders among all open onscreen</span>
0538 <span class="comment">% windows. If that causes trouble for some weird reason, you can prevent</span>
0539 <span class="comment">% automatic sharing with this flag.</span>
0540 <span class="comment">%Screen('Preference','ConserveVRAM',32);</span>
0541 
0542 
0543 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0544 <span class="comment">%%%% Setting the PTB OpenGL functions</span>
0545 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0546 
0547 <span class="comment">% Enable OpenGL mode of Psychtoolbox: This is crucially needed for clut animation</span>
0548 InitializeMatlabOpenGL();
0549 
0550 <span class="comment">% This script calls Psychtoolbox commands available only in OpenGL-based</span>
0551 <span class="comment">% versions of the Psychtoolbox. (So far, the OS X Psychtoolbox is the</span>
0552 <span class="comment">% only OpenGL-base Psychtoolbox.)  The Psychtoolbox command AssertPsychOpenGL will issue</span>
0553 <span class="comment">% an error message if someone tries to execute this script on a computer without</span>
0554 <span class="comment">% an OpenGL Psychtoolbox</span>
0555 AssertOpenGL();
0556 
0557 <span class="comment">% set OpenGL blend functions</span>
0558 Screen(<span class="string">'BlendFunction'</span>, winPtr, GL_SRC_ALPHA, GL_ONE_MINUS_SRC_ALPHA);
0559 
0560 
0561 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0562 <span class="comment">%%%% Displaying 'Initializing...'</span>
0563 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0564 
0565 <span class="comment">% displaying texts on the center of the screen</span>
0566 <a href="../../Retinotopy/Common/DisplayMessage2.html" class="code" title="function DisplayMessage2(message,bgcolor,winPtr,numScreens,drawing_font,drawing_size)">DisplayMessage2</a>(<span class="string">'Initializing...'</span>,sparam.bgcolor,winPtr,nScr,<span class="string">'Arial'</span>,36);
0567 
0568 
0569 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0570 <span class="comment">%%%% Initializing variables</span>
0571 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0572 
0573 <span class="comment">%% unit conversion</span>
0574 
0575 <span class="comment">% cm per pix</span>
0576 sparam.cm_per_pix=1/sparam.pix_per_cm;
0577 
0578 <span class="comment">% pixles per degree</span>
0579 sparam.pix_per_deg=round( 1/( 180*atan(sparam.cm_per_pix/sparam.vdist)/pi ) );
0580 
0581 <span class="comment">% deg to radian</span>
0582 <span class="comment">% do not convert!</span>
0583 <span class="comment">% sparam.width, sparam.phase, sparam.startangle, sparam.rotangle are used in deg formats</span>
0584 
0585 <span class="comment">% number of checkerboard color</span>
0586 sparam.ncolors=(size(sparam.colors,1)-1)/2;
0587 
0588 <span class="comment">% sec to number of frames</span>
0589 nframe_fixation=round(sparam.initial_fixation_time.*dparam.fps./sparam.waitframes);
0590 
0591 sparam.pol_npositions=360/sparam.pol_rotangle;
0592 sparam.ecc_npositions=sparam.pol_npositions*(sparam.ecc_cycle_duration-sparam.ecc_rest_duration)/(sparam.pol_cycle_duration-sparam.pol_rest_duration);
0593 
0594 nframe_stim=round((sparam.pol_cycle_duration-sparam.pol_rest_duration)*dparam.fps/(360/sparam.pol_rotangle)/sparam.waitframes);
0595 nframe_flicker=round(sparam.flip_duration*dparam.fps/sparam.waitframes);
0596 nframe_task=round(18/sparam.waitframes); <span class="comment">% just arbitral, you can change as you like</span>
0597 
0598 <span class="comment">%% initialize chackerboard parameters</span>
0599 
0600 <span class="comment">% adjust size ratio considering full-screen effect</span>
0601 <span class="keyword">if</span> dparam.fullscr
0602   <span class="comment">% here, use width information alone, assuming that the pixel is square</span>
0603   ratio_wid=( winRect(3)-winRect(1) )/dparam.ScrWidth;
0604   <span class="comment">%ratio_hei=( winRect(4)-winRect(2) )/dparam.ScrHeight;</span>
0605 
0606   <span class="comment">% min/max radius of annulus</span>
0607   rmin=sparam.minRad*ratio_wid; <span class="comment">% !!! degree, not pixel or cm !!!</span>
0608   rmax=sparam.maxRad*ratio_wid;
0609 <span class="keyword">else</span>
0610   rmin=sparam.minRad;
0611   rmax=sparam.maxRad;
0612 <span class="keyword">end</span>
0613 
0614 
0615 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0616 <span class="comment">%%%% Generating checkerboard patterns</span>
0617 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0618 
0619 <span class="comment">% [note]</span>
0620 <span class="comment">% After this processing, each checkerboard image has checker elements with values as shown below</span>
0621 <span class="comment">% 0 = background</span>
0622 <span class="comment">% 1 = checker ID 1</span>
0623 <span class="comment">% 2 = checker ID 2</span>
0624 <span class="comment">% 3 = checker ID 3</span>
0625 <span class="comment">% .....</span>
0626 <span class="comment">% sparam.npatches = checker ID</span>
0627 <span class="comment">% Each patch ID will be associated with a CLUT color of the same ID</span>
0628 
0629 <span class="comment">%%% a wedge for polar representation</span>
0630 startangles=zeros(sparam.pol_npositions,1);
0631 <span class="keyword">for</span> nn=1:1:sparam.pol_npositions, startangles(nn)=sparam.pol_startangle+(nn-1)*sparam.pol_rotangle; <span class="keyword">end</span>
0632 
0633 [dummy1,dummy2,pol_checkerboard]=<a href="../../Retinotopy/Generation/pol_GenerateCheckerBoard1D.html" class="code" title="function [checkerboard,bincheckerboard,mask]=pol_GenerateCheckerBoard1D(rmin,rmax,width,startangle,pix_per_deg,nwedges,nrings,phase,dual_flg)">pol_GenerateCheckerBoard1D</a>(rmin,rmax,sparam.pol_width,startangles,sparam.pix_per_deg,1,1,0);
0634 
0635 <span class="comment">%%% an annulus for eccentricity representation</span>
0636 eccedge=(rmax-rmin)/( sparam.ecc_npositions-1 );
0637 eccwidth=eccedge*(sparam.ecc_width/sparam.ecc_rotangle);
0638 
0639 <span class="comment">% get annuli's min/max lims</span>
0640 ecclims=zeros(sparam.ecc_npositions,3);
0641 <span class="keyword">for</span> nn=1:1:sparam.ecc_npositions <span class="comment">%1:1:sparam.npositions</span>
0642   minlim=rmin+(nn-1)*eccedge-eccwidth/2;
0643   <span class="keyword">if</span> minlim&lt;rmin, minlim=rmin; <span class="keyword">end</span>
0644   maxlim=rmin+(nn-1)*eccedge+eccwidth/2;
0645   <span class="keyword">if</span> maxlim&gt;rmax, maxlim=rmax; <span class="keyword">end</span>
0646 
0647   ecclims(nn,:)=[minlim,maxlim,eccwidth];
0648 <span class="keyword">end</span>
0649 
0650 [dummy1,dummy2,ecc_checkerboard]=<a href="../../Retinotopy/Generation/ecc_GenerateCheckerBoard1D.html" class="code" title="function [checkerboard,bincheckerboard,mask]=ecc_GenerateCheckerBoard1D(edges,width,startangle,pix_per_deg,nwedges,nrings,phase)">ecc_GenerateCheckerBoard1D</a>(ecclims,360,sparam.ecc_startangle,sparam.pix_per_deg,1,1,0);
0651 
0652 <span class="comment">%% flip all data for ccw/cont</span>
0653 <span class="keyword">if</span> ~isempty(strfind(sparam.mode,<span class="string">'ccw'</span>))
0654   tmp_checkerboard=cell(sparam.pol_npositions,1);
0655   <span class="keyword">for</span> nn=1:1:sparam.pol_npositions, tmp_checkerboard{nn}=pol_checkerboard{sparam.pol_npositions-(nn-1)}; <span class="keyword">end</span>
0656   pol_checkerboard=tmp_checkerboard;
0657   clear tmp_checkerboard;
0658 <span class="keyword">end</span>
0659 
0660 <span class="keyword">if</span> ~isempty(strfind(sparam.mode,<span class="string">'cont'</span>))
0661   tmp_checkerboard=cell(sparam.ecc_npositions,1);
0662   <span class="keyword">for</span> nn=1:1:sparam.ecc_npositions, tmp_checkerboard{nn}=ecc_checkerboard{sparam.ecc_npositions-(nn-1)}; <span class="keyword">end</span>
0663   ecc_checkerboard=tmp_checkerboard;
0664   clear tmp_checkerboard;
0665 <span class="keyword">end</span>
0666 
0667 <span class="comment">%%% generate the combined checkerboard patterns</span>
0668 
0669 commduration=lcm(sparam.pol_cycle_duration,sparam.ecc_cycle_duration); <span class="comment">% the least common multiple duration at which the stimulus rotation turns to the beginning.</span>
0670 <span class="keyword">if</span> commduration&lt;sparam.pol_cycle_duration*sparam.pol_numRepeats
0671   pol_subrepeats=ceil(commduration/sparam.pol_cycle_duration);
0672   ecc_subrepeats=ceil(commduration/sparam.ecc_cycle_duration);
0673 <span class="keyword">else</span>
0674   fprintf(<span class="string">'WARNING: It is recommended to adjust the sparam parameters so that lcm(sparam.pol_cycle_duration,sparam.ecc_cycle_duration) is less than sparam.pol_cycle_duration*sparam.pol_numRepeats\n'</span>);
0675   pol_subrepeats=sparam.pol_numRepeats;
0676   ecc_subrepeats=sparam.ecc_numRepeats;
0677 <span class="keyword">end</span>
0678 
0679 <span class="comment">% put the rest period for polar patterns</span>
0680 nrest=sparam.pol_npositions/(sparam.pol_cycle_duration-sparam.pol_rest_duration)*sparam.pol_rest_duration;
0681 <span class="keyword">if</span> nrest&gt;0
0682   <span class="keyword">if</span> ~isempty(strfind(sparam.mode,<span class="string">'ccw'</span>))
0683     pol_checkerboard=[pol_checkerboard;repmat({zeros(size(pol_checkerboard{1}))},nrest,1)];
0684   <span class="keyword">else</span> <span class="comment">% if ~isempty(strfind(sparam.mode,'cw'))</span>
0685     pol_checkerboard=[repmat({zeros(size(pol_checkerboard{1}))},nrest,1);pol_checkerboard];
0686   <span class="keyword">end</span>
0687 <span class="keyword">end</span>
0688 
0689 <span class="comment">% put the rest period for eccentricity patterns</span>
0690 nrest=sparam.ecc_npositions/(sparam.ecc_cycle_duration-sparam.ecc_rest_duration)*sparam.ecc_rest_duration;
0691 <span class="keyword">if</span> nrest&gt;0
0692   <span class="keyword">if</span> ~isempty(strfind(sparam.mode,<span class="string">'cont'</span>))
0693     ecc_checkerboard=[repmat({zeros(size(ecc_checkerboard{1}))},nrest,1);ecc_checkerboard];
0694   <span class="keyword">else</span> <span class="comment">% if ~isempty(strfind(sparam.mode,'ecc'))</span>
0695     ecc_checkerboard=[ecc_checkerboard;repmat({zeros(size(ecc_checkerboard{1}))},nrest,1)];
0696   <span class="keyword">end</span>
0697 <span class="keyword">end</span>
0698 
0699 <span class="comment">% multiply the patterns for the pol_subrepeats</span>
0700 pol_checkerboard=repmat(pol_checkerboard,pol_subrepeats,1);
0701 
0702 <span class="comment">% initialize the final checkerboard by eccentricity patterns</span>
0703 checkerboard=repmat(ecc_checkerboard,ecc_subrepeats,1);
0704 
0705 <span class="comment">% overwrite the polar patterns</span>
0706 <span class="keyword">for</span> nn=1:1:length(pol_checkerboard)
0707   checkerboard{nn}(pol_checkerboard{nn}~=0)=pol_checkerboard{nn}(pol_checkerboard{nn}~=0);
0708 <span class="keyword">end</span>
0709 clear pol_checkerboard ecc_checkerboard;
0710 
0711 <span class="comment">% generate the final checkerboard patterns</span>
0712 subrepeats=ceil(sparam.pol_numRepeats/pol_subrepeats);
0713 checkerboard=repmat(checkerboard,[subrepeats,1]);
0714 
0715 <span class="comment">% cut the patterns that exceeds the whole stimulus presentation trials</span>
0716 <span class="keyword">if</span> length(checkerboard) &gt; sparam.pol_cycle_duration*sparam.pol_numRepeats/(sparam.pol_cycle_duration/sparam.pol_npositions)
0717   checkerboard=checkerboard(1:sparam.pol_cycle_duration*sparam.pol_numRepeats/(sparam.pol_cycle_duration/sparam.pol_npositions));
0718 <span class="keyword">end</span>
0719 
0720 <span class="comment">%% organize the checkerboard into masks</span>
0721 <span class="keyword">for</span> nn=1:1:length(checkerboard)
0722   checkerboard{nn}=255.*(~checkerboard{nn});
0723   checkerboard{nn}=repmat(checkerboard{nn},[1,1,4]);
0724   checkerboard{nn}(:,:,1:3)=repmat(reshape(sparam.bgcolor,[1,1,3]),[size(checkerboard{nn},1),size(checkerboard{nn},2)]);
0725 <span class="keyword">end</span>
0726 
0727 <span class="comment">%% Make Checkerboard textures</span>
0728 checkertexture=cell(length(checkerboard),1);
0729 <span class="keyword">for</span> nn=1:1:length(checkerboard)
0730   checkertexture{nn}=Screen(<span class="string">'MakeTexture'</span>,winPtr,checkerboard{nn});
0731 <span class="keyword">end</span>
0732 
0733 
0734 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0735 <span class="comment">%%%% Initializing a background brownian noise image</span>
0736 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0737 
0738 <span class="comment">%pdims=[4,4];</span>
0739 <span class="comment">%szh=size(checkerboard{1},1);</span>
0740 <span class="comment">%if mod(szh,pdims(1)), szh=szh+pdims(1)-mod(szh,pdims(1)); end</span>
0741 <span class="comment">%szw=size(checkerboard{1},2);</span>
0742 <span class="comment">%if mod(szw,pdims(2)), szw=szw+pdims(2)-mod(szw,pdims(1)); end</span>
0743 <span class="comment">%bnimg=CreateColoredNoise([szh,szw],pdims,3,2,1,0,0);</span>
0744 <span class="comment">%bnimg=bnimg(1:size(checkerboard{1},1),1:size(checkerboard{1},2),:);</span>
0745 
0746 bnimg=<a href="../../Retinotopy/Common/CreateColoredNoise.html" class="code" title="function img=CreateColoredNoise(idims,sdims,num,beta,norm_flg,save_flg,show_flg)">CreateColoredNoise</a>(round([size(checkerboard{1},1),size(checkerboard{1},2)]./4),[1,1],3,2,1,0,0); <span class="comment">% ./4 is for reducing computation time, 3 is required for RGB color noise</span>
0747 noisetexture=Screen(<span class="string">'MakeTexture'</span>,winPtr,bnimg);
0748 
0749 
0750 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0751 <span class="comment">%%%% Initializing object images</span>
0752 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0753 
0754 <span class="comment">% loading the object image database</span>
0755 load(fullfile(fileparts(mfilename(<span class="string">'fullpath'</span>)),<span class="string">'..'</span>,<span class="string">'object_images'</span>,<span class="string">'object_image_database.mat'</span>)); <span class="comment">% img is loaded on the memory</span>
0756 
0757 <span class="comment">% shuffling the presentation order</span>
0758 img=img(:,:,:,<a href="../../Retinotopy/Common/shuffle.html" class="code" title="function [Y,index] = shuffle(X)">shuffle</a>(1:size(img,4)));
0759 imgsz=[size(img,1),size(img,2)];
0760 posLims=CenterRect([0,0,size(checkerboard{1},2),size(checkerboard{1},1)],winRect); <span class="comment">% image location limit, [x_min, y_min, x_max, y_max], the image positions are randomly selected whithin this range</span>
0761 
0762 <span class="comment">% initializing the firt object image textures</span>
0763 
0764 <span class="comment">% image IDs</span>
0765 imgids=1:1:sparam.nimg;
0766 imgids(imgids&gt;size(img,4))=mod(imgids(imgids&gt;size(img,4)),size(img,4));
0767 imgids(imgids==0)=size(img,4);
0768 
0769 <span class="comment">% rectangles</span>
0770 cpos=[(posLims(3)-posLims(1)).*rand(sparam.nimg,1)+posLims(1),(posLims(4)-posLims(2)).*rand(sparam.nimg,1)+posLims(2)]; <span class="comment">% center positions, [x,y]</span>
0771 cszs=(sparam.imRatio(2)-sparam.imRatio(1)).*rand(sparam.nimg,1)+sparam.imRatio(1); <span class="comment">% image maginification factor</span>
0772 imgpos=[round(cpos(:,1)-cszs*imgsz(2)/2)+1,round(cpos(:,2)-cszs*imgsz(1)/2)+1,round(cpos(:,1)+cszs*imgsz(2)/2),round(cpos(:,2)+cszs*imgsz(1)/2)]';
0773 
0774 <span class="comment">% angles</span>
0775 imgrot=360.*rand(sparam.nimg,1);
0776 
0777 <span class="comment">% stereo depth</span>
0778 <span class="keyword">if</span> nScr&gt;1
0779   <span class="comment">% compute image shift from disparity</span>
0780   depths=(sparam.imdepth(2)-sparam.imdepth(1)).*rand(sparam.nimg,1)+sparam.imdepth(1);
0781   zdist=<a href="../../Retinotopy/Common/CalcDistFromDisparity.html" class="code" title="function zdist = CalcDistFromDisparity(ipd,disparity,viewdist)">CalcDistFromDisparity</a>(sparam.ipd,depths,sparam.vdist);
0782   zdist=sort(zdist,<span class="string">'descend'</span>);
0783   [Lshift,Rshift]=RayTrace_ScreenPos_X_MEX(zdist,sparam.ipd,sparam.vdist,sparam.pix_per_cm,0);
0784   stereopos{1}=[Lshift,zeros(sparam.nimg,1),Lshift,zeros(sparam.nimg,1)]';
0785   stereopos{2}=[Rshift,zeros(sparam.nimg,1),Rshift,zeros(sparam.nimg,1)]';
0786 <span class="keyword">else</span>
0787   stereopos{1}=repmat([0,0,0,0],[sparam.nimg,1])';
0788   stereopos{2}=repmat([0,0,0,0],[sparam.nimg,1])';
0789 <span class="keyword">end</span>
0790 
0791 <span class="comment">% generate the object image textures at the first frame</span>
0792 objecttextures=zeros(numel(imgids),1);
0793 <span class="keyword">for</span> pp=1:1:numel(imgids), objecttextures(pp)=Screen(<span class="string">'MakeTexture'</span>,winPtr,img(:,:,:,imgids(pp))); <span class="keyword">end</span>
0794 
0795 
0796 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0797 <span class="comment">%%%% Debug codes</span>
0798 <span class="comment">%%%% saving the stimulus images as *.png format files and enter the debug (keyboard) mode</span>
0799 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0800 
0801 <span class="comment">% %%%%%% DEBUG codes start here</span>
0802 <span class="keyword">if</span> strfind(upper(subjID),<span class="string">'DEBUG'</span>)
0803 
0804   Screen(<span class="string">'CloseAll'</span>);
0805 
0806   save_dir=fullfile(resultDir,<span class="string">'images_idual_fixtask'</span>);
0807   <span class="keyword">if</span> ~exist(save_dir,<span class="string">'dir'</span>), mkdir(save_dir); <span class="keyword">end</span>
0808 
0809   <span class="comment">% open a new window for drawing stimuli</span>
0810   stimRect=[0,0,size(checkerboard{1},2),size(checkerboard{1},1)];
0811   [winPtr,winRect]=Screen(<span class="string">'OpenWindow'</span>,dparam.scrID,sparam.bgcolor,CenterRect(stimRect,Screen(<span class="string">'Rect'</span>,dparam.scrID)));
0812 
0813   <span class="comment">% set OpenGL</span>
0814   priorityLevel=MaxPriority(winPtr,<span class="string">'WaitBlanking'</span>);
0815   Priority(priorityLevel);
0816   AssertOpenGL();
0817   Screen(<span class="string">'BlendFunction'</span>, winPtr, GL_SRC_ALPHA, GL_ONE_MINUS_SRC_ALPHA);
0818 
0819   <span class="comment">% regenerate checkerboard textures</span>
0820   <span class="keyword">for</span> nn=1:1:length(checkerboard), checkertexture{nn}=Screen(<span class="string">'MakeTexture'</span>,winPtr,checkerboard{nn}); <span class="keyword">end</span>
0821 
0822   <span class="comment">% check the number of flickers</span>
0823   <span class="keyword">if</span> mod((sparam.pol_cycle_duration-sparam.pol_rest_duration)/(360/sparam.pol_rotangle)/sparam.flip_duration,1)~=0
0824     warning(<span class="string">'(sparam.pol_cycle_duration-sparam.pol_rest_duration)/(360/sparam.pol_rotangle)/sparam.flip_duration is not an integer. check the sparam parameters.'</span>);
0825   <span class="keyword">end</span>
0826 
0827   <span class="comment">% processing</span>
0828   obj_counter=0;
0829   <span class="keyword">for</span> nn=1:1:length(checkerboard)
0830     <span class="keyword">for</span> cc=1:1:round((sparam.pol_cycle_duration-sparam.pol_rest_duration)/(360/sparam.pol_rotangle)/sparam.flip_duration);
0831 
0832       <span class="comment">% brownian noise image</span>
0833       bnimg=<a href="../../Retinotopy/Common/CreateColoredNoise.html" class="code" title="function img=CreateColoredNoise(idims,sdims,num,beta,norm_flg,save_flg,show_flg)">CreateColoredNoise</a>(round([size(checkerboard{1},1),size(checkerboard{1},2)]./4),[1,1],3,2,1,0,0);
0834       noisetexture=Screen(<span class="string">'MakeTexture'</span>,winPtr,bnimg);
0835 
0836       <span class="keyword">for</span> pp=1:1:2 <span class="comment">% by default, 2 image sets in one background noise flicker</span>
0837         <span class="comment">% generate object image textures</span>
0838 
0839         <span class="comment">% image IDs</span>
0840         obj_counter=obj_counter+1;
0841         imgids=sparam.nimg*(obj_counter-1)+1:1:sparam.nimg*obj_counter;
0842         imgids(imgids&gt;size(img,4))=mod(imgids(imgids&gt;size(img,4)),size(img,4));
0843         imgids(imgids==0)=size(img,4);
0844 
0845         <span class="comment">% rectangles</span>
0846         cpos=[(stimRect(3)-stimRect(1)).*rand(sparam.nimg,1)+stimRect(1),(stimRect(4)-stimRect(2)).*rand(sparam.nimg,1)+stimRect(2)]; <span class="comment">% center positions, [x,y]</span>
0847         cszs=(sparam.imRatio(2)-sparam.imRatio(1)).*rand(sparam.nimg,1)+sparam.imRatio(1); <span class="comment">% image maginification factor</span>
0848         imgpos=[round(cpos(:,1)-cszs*imgsz(2)/2)+1,round(cpos(:,2)-cszs*imgsz(1)/2)+1,round(cpos(:,1)+cszs*imgsz(2)/2),round(cpos(:,2)+cszs*imgsz(1)/2)]';
0849 
0850         <span class="comment">% angles</span>
0851         imgrot=360.*rand(sparam.nimg,1);
0852 
0853         <span class="comment">% stereo depth</span>
0854         <span class="keyword">if</span> nScr&gt;1
0855           <span class="comment">% compute image shift from disparity</span>
0856           depths=(sparam.imdepth(2)-sparam.imdepth(1)).*rand(sparam.nimg,1)+sparam.imdepth(1);
0857           zdist=<a href="../../Retinotopy/Common/CalcDistFromDisparity.html" class="code" title="function zdist = CalcDistFromDisparity(ipd,disparity,viewdist)">CalcDistFromDisparity</a>(sparam.ipd,depths,sparam.vdist);
0858           zdist=sort(zdist,<span class="string">'descend'</span>);
0859           [Lshift,Rshift]=RayTrace_ScreenPos_X_MEX(zdist,sparam.ipd,sparam.vdist,sparam.pix_per_cm,0);
0860           stereopos{1}=[Lshift,zeros(sparam.nimg,1),Lshift,zeros(sparam.nimg,1)]';
0861           stereopos{2}=[Rshift,zeros(sparam.nimg,1),Rshift,zeros(sparam.nimg,1)]';
0862         <span class="keyword">else</span>
0863           stereopos{1}=repmat([0,0,0,0],[sparam.nimg,1])';
0864           stereopos{2}=repmat([0,0,0,0],[sparam.nimg,1])';
0865         <span class="keyword">end</span>
0866 
0867         <span class="keyword">for</span> mm=1:1:numel(imgids), objecttextures(mm)=Screen(<span class="string">'MakeTexture'</span>,winPtr,img(:,:,:,imgids(mm))); <span class="keyword">end</span>
0868 
0869         <span class="keyword">for</span> nnnn=1:1:nScr
0870           <span class="comment">% drawing</span>
0871           Screen(<span class="string">'DrawTexture'</span>,winPtr,noisetexture,[],CenterRect(stimRect,winRect)); <span class="comment">% noise textures</span>
0872           Screen(<span class="string">'DrawTextures'</span>,winPtr,objecttextures,[],imgpos+stereopos{nnnn},imgrot); <span class="comment">% object images</span>
0873           Screen(<span class="string">'DrawTexture'</span>,winPtr,checkertexture{nn},[],CenterRect(stimRect,winRect)); <span class="comment">% checkerboard mask</span>
0874 
0875           <span class="comment">% flip the window</span>
0876           Screen(<span class="string">'DrawingFinished'</span>,winPtr);
0877           Screen(<span class="string">'Flip'</span>,winPtr,[],[],[],1);
0878 
0879           <span class="comment">% get the current frame and save it</span>
0880           imwrite(Screen(<span class="string">'GetImage'</span>,winPtr,winRect),fullfile(save_dir,sprintf(<span class="string">'retinotopy_%s_pos_%02d_type_%02d_%02d_stereo_%02d.png'</span>,sparam.mode,nn,cc,pp,nnnn)),<span class="string">'png'</span>);
0881         <span class="keyword">end</span>
0882 
0883         <span class="comment">% close the textures and OffScreenWindow</span>
0884         <span class="keyword">for</span> mm=1:1:numel(imgids), Screen(<span class="string">'Close'</span>,objecttextures(mm)); <span class="keyword">end</span>
0885       <span class="keyword">end</span>
0886       Screen(<span class="string">'Close'</span>,noisetexture);
0887 
0888     <span class="keyword">end</span> <span class="comment">% for cc=1:1:round((sparam.pol_cycle_duration-sparam.pol_rest_duration)/(360/sparam.pol_rotangle)/sparam.flip_duration);</span>
0889   <span class="keyword">end</span> <span class="comment">% for nn=1:1:length(checkerboard)</span>
0890 
0891   Screen(<span class="string">'CloseAll'</span>);
0892   save(fullfile(save_dir,sprintf(<span class="string">'stimulus_%s.mat'</span>,sparam.mode)),<span class="string">'checkerboard'</span>,<span class="string">'sparam'</span>,<span class="string">'dparam'</span>);
0893   keyboard;
0894 
0895 <span class="keyword">end</span> <span class="comment">% if strfind(upper(subjID),'DEBUG')</span>
0896 <span class="comment">% %%%%%% DEBUG code ends here</span>
0897 
0898 
0899 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0900 <span class="comment">%%%% Generating fixation detection task parameters</span>
0901 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0902 
0903 <span class="comment">%% set task variables</span>
0904 <span class="comment">% flag to decide whether presenting fixation task</span>
0905 totalframes=max(sum(nframe_fixation),1)+length(checkerboard)*nframe_stim;
0906 num_tasks=ceil(totalframes/nframe_task);
0907 task_flg=ones(1,num_tasks);
0908 <span class="keyword">for</span> nn=2:1:num_tasks
0909   <span class="keyword">if</span> task_flg(nn-1)==2
0910     task_flg(nn)=1;
0911   <span class="keyword">else</span>
0912     <span class="keyword">if</span> mod(randi(4,1),4)==0 <span class="comment">% this is arbitral, but I put these lines just to reduce the number of tasks</span>
0913       task_flg(nn)=round(rand(1,1))+1;
0914     <span class="keyword">else</span>
0915       task_flg(nn)=1;
0916     <span class="keyword">end</span>
0917   <span class="keyword">end</span>
0918 <span class="keyword">end</span>
0919 task_flg=repmat(task_flg,nframe_task,1);
0920 task_flg=task_flg(:);
0921 
0922 
0923 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0924 <span class="comment">%%%% Creating background images</span>
0925 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0926 
0927 <span class="keyword">if</span> sparam.bgtype==1 <span class="comment">% a simple background with sparam.bgcolor</span>
0928   bgimg{1}=repmat(reshape(sparam.bgcolor,[1,1,3]),[dparam.ScrHeight,dparam.ScrWidth]);
0929 
0930 <span class="keyword">elseif</span> sparam.bgtype==2 <span class="comment">% a background with grid guides</span>
0931 
0932   <span class="comment">% calculate the central aperture size of the background image</span>
0933   edgeY=mod(dparam.ScrHeight,sparam.patch_num(1)); <span class="comment">% delete the exceeded region</span>
0934   p_height=round((dparam.ScrHeight-edgeY)/sparam.patch_num(1)); <span class="comment">% height in pix of patch_height + interval-Y</span>
0935 
0936   edgeX=mod(dparam.ScrWidth,sparam.patch_num(2)); <span class="comment">% delete exceeded region</span>
0937   p_width=round((dparam.ScrWidth-edgeX)/sparam.patch_num(2)); <span class="comment">% width in pix of patch_width + interval-X</span>
0938 
0939   <span class="keyword">if</span> dparam.fullscr
0940     aperture_size=[2*( p_height*ceil( size(checkerboard{1},1)/2*( (winRect(4)-winRect(2))/dparam.ScrHeight ) /p_height ) ),<span class="keyword">...</span>
0941                    2*( p_width*ceil( size(checkerboard{1},2)/2*( (winRect(3)-winRect(1))/dparam.ScrWidth ) /p_width ) )];
0942   <span class="keyword">else</span>
0943     aperture_size=[2*( p_height*ceil(size(checkerboard{1},1)/2/p_height) ),<span class="keyword">...</span>
0944                    2*( p_width*ceil(size(checkerboard{1},2)/2/p_width) )];
0945   <span class="keyword">end</span>
0946 
0947   bgimg=<a href="../../Retinotopy/Common/CreateBackgroundImage.html" class="code" title="function [Bimg,parameters] = CreateBackgroundImage(wdims,stdims,pdims,bgcolor,color1,color2,fixcolor,patchnum,fix_flag,save_flag,show_flag)">CreateBackgroundImage</a>([dparam.ScrHeight,dparam.ScrWidth],aperture_size,sparam.patch_size,sparam.bgcolor,sparam.patch_color1,sparam.patch_color2,sparam.fixcolor,sparam.patch_num,0,0,0);
0948 <span class="keyword">else</span>
0949   error(<span class="string">'sparam.bgtype should be 1 or 2. check the input variable.'</span>);
0950 <span class="keyword">end</span>
0951 
0952 <span class="comment">% set mask and transparency in the middle region of the background where the target stimuli are to be presented.</span>
0953 <span class="comment">% this mask is required to prevent the object images from being presented in the external regions.</span>
0954 bgimg=bgimg{1};
0955 bgimg(:,:,4)=255*ones(size(bgimg,1),size(bgimg,2));
0956 maskRect=CenterRect([1,1,size(checkerboard{1},2),size(checkerboard{1},1)],[1,1,size(bgimg,2),size(bgimg,1)]);
0957 bgimg(maskRect(2)+1:maskRect(4),maskRect(1)+1:maskRect(3),4)=0; <span class="comment">% alpha channel, transparency</span>
0958 
0959 background=Screen(<span class="string">'MakeTexture'</span>,winPtr,bgimg);
0960 
0961 
0962 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0963 <span class="comment">%%%% Creating the central fixation, cross images</span>
0964 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0965 
0966 <span class="comment">% Create fixation cross images.</span>
0967 <span class="comment">% Firstly larger fixations are generated, then they are antialiased. This is required to present a beautiful circle</span>
0968 
0969 <span class="keyword">if</span> sparam.fixtype==1 <span class="comment">% circular fixation</span>
0970   fixW=<a href="../../Retinotopy/Common/CreateFixationImgCircular.html" class="code" title="function fix=CreateFixationImgCircular(fixsize,fixcolor,bgcolor,circlesize,show_flag,save_flag)">CreateFixationImgCircular</a>(4*sparam.fixsize,sparam.fixcolor,sparam.bgcolor,4*sparam.fixsize,0,0);
0971   fixD=<a href="../../Retinotopy/Common/CreateFixationImgCircular.html" class="code" title="function fix=CreateFixationImgCircular(fixsize,fixcolor,bgcolor,circlesize,show_flag,save_flag)">CreateFixationImgCircular</a>(4*sparam.fixsize,[64,64,64],sparam.bgcolor,4*sparam.fixsize,0,0);
0972 <span class="keyword">elseif</span> sparam.fixtype==2 <span class="comment">% rectangular fixation</span>
0973   fixW=<a href="../../Retinotopy/Common/CreateFixationImgMono.html" class="code" title="function fix=CreateFixationImgMono(fixsize,fixcolor,bgcolor,fixlinew,fixlineh,show_flag,save_flag)">CreateFixationImgMono</a>(4*sparam.fixsize,sparam.fixcolor,sparam.bgcolor,4*2,4*ceil(0.4*sparam.fixsize),0,0);
0974   fixD=<a href="../../Retinotopy/Common/CreateFixationImgMono.html" class="code" title="function fix=CreateFixationImgMono(fixsize,fixcolor,bgcolor,fixlinew,fixlineh,show_flag,save_flag)">CreateFixationImgMono</a>(4*sparam.fixsize,[64,64,64],sparam.bgcolor,4*2,4*ceil(0.4*sparam.fixsize),0,0);
0975 <span class="keyword">elseif</span> sparam.fixtype==3 <span class="comment">% concentric fixation</span>
0976   fixW=<a href="../../Retinotopy/Common/CreateFixationImgConcentrateMono.html" class="code" title="function fix=CreateFixationImgConcentrateMono(fixsize,fixcolor,bgcolor,circlesize,gap,show_flag,save_flag)">CreateFixationImgConcentrateMono</a>(4*sparam.fixsize,sparam.fixcolor,sparam.bgcolor,4*[2,ceil(0.8*sparam.fixsize)],0,0,0);
0977   fixD=<a href="../../Retinotopy/Common/CreateFixationImgConcentrateMono.html" class="code" title="function fix=CreateFixationImgConcentrateMono(fixsize,fixcolor,bgcolor,circlesize,gap,show_flag,save_flag)">CreateFixationImgConcentrateMono</a>(4*sparam.fixsize,[64,64,64],sparam.bgcolor,4*[2,ceil(0.8*sparam.fixsize)],0,0,0);
0978 <span class="keyword">else</span>
0979   error(<span class="string">'sparam.fixtype should be one of 1,2, and 3. check the input variable.'</span>);
0980 <span class="keyword">end</span>
0981 fixW=imresize(fixW,0.25);
0982 fixD=imresize(fixD,0.25);
0983 
0984 fix=cell(2,1); <span class="comment">% 1 is for default fixation, 2 is for darker fixation (luminance detection task)</span>
0985 fix{1}=Screen(<span class="string">'MakeTexture'</span>,winPtr,fixW);
0986 fix{2}=Screen(<span class="string">'MakeTexture'</span>,winPtr,fixD);
0987 
0988 
0989 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0990 <span class="comment">%%%% Prepare blue lines for stereo image flip sync with VPixx PROPixx</span>
0991 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0992 
0993 <span class="comment">% There seems to be a blueline generation bug on some OpenGL systems.</span>
0994 <span class="comment">% SetStereoBlueLineSyncParameters(winPtr, winRect(4)) corrects the</span>
0995 <span class="comment">% bug on some systems, but breaks on other systems.</span>
0996 <span class="comment">% We'll just disable automatic blueline, and manually draw our own bluelines!</span>
0997 
0998 <span class="keyword">if</span> strcmpi(dparam.ExpMode,<span class="string">'propixxstereo'</span>)
0999   SetStereoBlueLineSyncParameters(winPtr, winRect(4)+10);
1000   blueRectOn(1,:)=[0, winRect(4)-1, winRect(3)/4, winRect(4)];
1001   blueRectOn(2,:)=[0, winRect(4)-1, winRect(3)*3/4, winRect(4)];
1002   blueRectOff(1,:)=[winRect(3)/4, winRect(4)-1, winRect(3), winRect(4)];
1003   blueRectOff(2,:)=[winRect(3)*3/4, winRect(4)-1, winRect(3), winRect(4)];
1004 <span class="keyword">end</span>
1005 
1006 
1007 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
1008 <span class="comment">%%%% Image size adjusting to match the current display resolutions</span>
1009 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
1010 
1011 <span class="keyword">if</span> dparam.fullscr
1012   ratio_wid= ( winRect(3)-winRect(1) )/dparam.ScrWidth;
1013   ratio_hei= ( winRect(4)-winRect(2) )/dparam.ScrHeight;
1014   bgSize   = [size(bgimg{1},2)*ratio_wid, size(bgimg{1},1)*ratio_hei];
1015   stimSize = [size(checkerboard{1},2)*ratio_wid, size(checkerboard{1},1)*ratio_hei];
1016   fixSize  = [2*sparam.fixsize*ratio_wid, 2*sparam.fixsize*ratio_hei];
1017 <span class="keyword">else</span>
1018   bgSize   = [dparam.ScrWidth, dparam.ScrHeight];
1019   stimSize = [size(checkerboard{1},2), size(checkerboard{1},1)];
1020   fixSize  = [2*sparam.fixsize, 2*sparam.fixsize];
1021 <span class="keyword">end</span>
1022 
1023 <span class="comment">% for some display modes in which one screen is splitted into two binocular displays</span>
1024 <span class="keyword">if</span> strcmpi(dparam.ExpMode,<span class="string">'cross'</span>) || strcmpi(dparam.ExpMode,<span class="string">'parallel'</span>) || <span class="keyword">...</span>
1025    strcmpi(dparam.ExpMode,<span class="string">'topbottom'</span>) || strcmpi(dparam.ExpMode,<span class="string">'bottomtop'</span>)
1026   bgSize=bgSize./2;
1027   stimSize=stimSize./2;
1028   fixSize=fixSize./2;
1029 
1030   <span class="comment">% adjust image size (note: in contrast, we have to keep the stereo shifts as they are)</span>
1031   imgsz=imgsz./2;
1032 
1033   <span class="comment">% update lim positions just for the first frame</span>
1034   posLims=CenterRect([0,0,size(checkerboard{1},2)./2,size(checkerboard{1},1)./2],winRect); <span class="comment">% image location limit, [x_min, y_min, x_max, y_max], the image positions are randomly selected whithin this range</span>
1035 
1036   <span class="comment">% update image locations just for the first frame</span>
1037   cpos=[(posLims(3)-posLims(1)).*rand(sparam.nimg,1)+posLims(1),(posLims(4)-posLims(2)).*rand(sparam.nimg,1)+posLims(2)]; <span class="comment">% center positions, [x,y]</span>
1038   cszs=(sparam.imRatio(2)-sparam.imRatio(1)).*rand(sparam.nimg,1)+sparam.imRatio(1); <span class="comment">% image maginification factor</span>
1039   imgpos=[round(cpos(:,1)-cszs*imgsz(2)/2)+1,round(cpos(:,2)-cszs*imgsz(1)/2)+1,round(cpos(:,1)+cszs*imgsz(2)/2),round(cpos(:,2)+cszs*imgsz(1)/2)]';
1040 <span class="keyword">end</span>
1041 
1042 bgRect  = [0, 0, bgSize]; <span class="comment">% used to display background images;</span>
1043 stimRect= [0, 0, stimSize];
1044 fixRect = [0, 0, fixSize]; <span class="comment">% used to display the central fixation point</span>
1045 
1046 
1047 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
1048 <span class="comment">%%%% Generating additional mask which covers the outside region of the background.</span>
1049 <span class="comment">%%%% The mask is required to hide parts of the objects presented outside the background</span>
1050 <span class="comment">%%%% when the script is not running with full-screen mode.</span>
1051 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
1052 
1053 
1054 wrect=Screen(<span class="string">'Rect'</span>,winPtr);
1055 <span class="keyword">if</span> wrect(3)-wrect(1)&gt;bgRect(3)-bgRect(1) | wrect(4)-wrect(2)&gt;bgRect(4)-bgRect(2) <span class="comment">% if background is smaller than the whole screen</span>
1056   hide_flg=1;
1057   amskimg=repmat(reshape(sparam.colors(1,:),[1,1,3]),[wrect(4)-wrect(2),wrect(3)-wrect(1)]);
1058   amskimg(:,:,4)=255*ones(size(amskimg,1),size(amskimg,2));
1059   amskRect=CenterRect(bgRect,wrect);
1060   amskimg(amskRect(2)+1:amskRect(4),amskRect(1)+1:amskRect(3),4)=0; <span class="comment">% alpha channel, transparency</span>
1061 
1062   abackground=Screen(<span class="string">'MakeTexture'</span>,winPtr,amskimg);
1063 <span class="keyword">else</span>
1064   hide_flg=0;
1065 <span class="keyword">end</span>
1066 
1067 
1068 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
1069 <span class="comment">%%%% Initialize functions and variables for trial loop</span>
1070 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
1071 
1072 <span class="comment">% initialize variables that we will use during the experiment (faster)</span>
1073 cur_frames=0;
1074 
1075 <span class="comment">% object image counter</span>
1076 obj_counter=0;
1077 
1078 
1079 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
1080 <span class="comment">%%%% Displaying 'Ready to Start'</span>
1081 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
1082 
1083 <span class="comment">% displaying texts on the center of the screen</span>
1084 <a href="../../Retinotopy/Common/DisplayMessage2.html" class="code" title="function DisplayMessage2(message,bgcolor,winPtr,numScreens,drawing_font,drawing_size)">DisplayMessage2</a>(<span class="string">'Ready to Start'</span>,sparam.bgcolor,winPtr,nScr,<span class="string">'Arial'</span>,36);
1085 ttime=GetSecs(); <span class="keyword">while</span> (GetSecs()-ttime &lt; 0.5), <span class="keyword">end</span>  <span class="comment">% run up the clock.</span>
1086 
1087 
1088 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
1089 <span class="comment">%%%% Flip the display(s) to the background image(s)</span>
1090 <span class="comment">%%%% and inform the ready of stimulus presentation</span>
1091 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
1092 
1093 <span class="comment">% change the screen and wait for the trigger or pressing the start button</span>
1094 <span class="keyword">for</span> nn=1:1:nScr
1095   Screen(<span class="string">'SelectStereoDrawBuffer'</span>,winPtr,nn-1);
1096   Screen(<span class="string">'DrawTexture'</span>,winPtr,fix{2},[],CenterRect(fixRect,winRect));
1097   Screen(<span class="string">'DrawTexture'</span>,winPtr,background,[],CenterRect(bgRect,winRect));
1098 
1099   <span class="comment">% blue line for stereo sync</span>
1100   <span class="keyword">if</span> strcmpi(dparam.ExpMode,<span class="string">'propixxstereo'</span>)
1101     Screen(<span class="string">'FillRect'</span>,winPtr,[0,0,255],blueRectOn(nn,:));
1102     Screen(<span class="string">'FillRect'</span>,winPtr,[0,0,0],blueRectOff(nn,:));
1103   <span class="keyword">end</span>
1104 <span class="keyword">end</span>
1105 Screen(<span class="string">'DrawingFinished'</span>,winPtr);
1106 Screen(<span class="string">'Flip'</span>, winPtr,[],[],[],1);
1107 
1108 <span class="comment">% prepare the next frame for the initial fixation period</span>
1109 <span class="keyword">for</span> nn=1:1:nScr
1110   Screen(<span class="string">'SelectStereoDrawBuffer'</span>,winPtr,nn-1);
1111   Screen(<span class="string">'DrawTexture'</span>,winPtr,fix{1},[],CenterRect(fixRect,winRect)); <span class="comment">% fix{1} is valid as no task in the first period</span>
1112   Screen(<span class="string">'DrawTexture'</span>,winPtr,background,[],CenterRect(bgRect,winRect));
1113 
1114   <span class="comment">% blue line for stereo sync</span>
1115   <span class="keyword">if</span> strcmpi(dparam.ExpMode,<span class="string">'propixxstereo'</span>)
1116     Screen(<span class="string">'FillRect'</span>,winPtr,[0,0,255],blueRectOn(nn,:));
1117     Screen(<span class="string">'FillRect'</span>,winPtr,[0,0,0],blueRectOff(nn,:));
1118   <span class="keyword">end</span>
1119 <span class="keyword">end</span>
1120 Screen(<span class="string">'DrawingFinished'</span>,winPtr);
1121 
1122 
1123 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
1124 <span class="comment">%%%% Wait for the first trigger pulse from fMRI scanner or start with button pressing</span>
1125 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
1126 
1127 <span class="comment">% add time stamp (this also works to load add_event method in memory in advance of the actual displays)</span>
1128 fprintf(<span class="string">'\nWaiting for the start...\n'</span>);
1129 event=event.add_event(<span class="string">'Experiment Start'</span>,strcat([datestr(now,<span class="string">'yymmdd'</span>),<span class="string">' '</span>,datestr(now,<span class="string">'HH:mm:ss'</span>)]),NaN);
1130 
1131 <span class="comment">% waiting for stimulus presentation</span>
1132 resps.wait_stimulus_presentation(dparam.start_method,dparam.custom_trigger);
1133 <span class="comment">%PlaySound(1);</span>
1134 fprintf(<span class="string">'\nExperiment running...\n'</span>);
1135 
1136 
1137 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
1138 <span class="comment">%%%% Initial Fixation Period</span>
1139 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
1140 
1141 vbl=Screen(<span class="string">'Flip'</span>,winPtr,[],[],[],1); <span class="comment">% the first flip</span>
1142 [event,the_experiment_start]=event.set_reference_time(vbl);
1143 event=event.add_event(<span class="string">'Initial Fixation'</span>,[]);
1144 fprintf(<span class="string">'\nfixation\n\n'</span>);
1145 cur_frames=cur_frames+1;
1146 
1147 <span class="comment">% wait for the initial fixation</span>
1148 <span class="keyword">for</span> ff=1:1:nframe_fixation(1)
1149   <span class="keyword">for</span> nn=1:1:nScr
1150     Screen(<span class="string">'SelectStereoDrawBuffer'</span>,winPtr,nn-1);
1151     Screen(<span class="string">'DrawTexture'</span>,winPtr,fix{task_flg(cur_frames)},[],CenterRect(fixRect,winRect));
1152     Screen(<span class="string">'DrawTexture'</span>,winPtr,background,[],CenterRect(bgRect,winRect));
1153 
1154     <span class="comment">% blue line for stereo sync</span>
1155     <span class="keyword">if</span> strcmpi(dparam.ExpMode,<span class="string">'propixxstereo'</span>)
1156       Screen(<span class="string">'FillRect'</span>,winPtr,[0,0,255],blueRectOn(nn,:));
1157       Screen(<span class="string">'FillRect'</span>,winPtr,[0,0,0],blueRectOff(nn,:));
1158     <span class="keyword">end</span>
1159   <span class="keyword">end</span>
1160   Screen(<span class="string">'DrawingFinished'</span>,winPtr);
1161   <span class="keyword">while</span> GetSecs()&lt;vbl+(ff*sparam.waitframes-0.5)*dparam.ifi, [resps,event]=resps.check_responses(event); <span class="keyword">end</span>
1162   Screen(<span class="string">'Flip'</span>,winPtr,[],[],[],1);
1163 
1164   <span class="comment">% update task</span>
1165   cur_frames=cur_frames+1;
1166   <span class="keyword">if</span> task_flg(cur_frames-1)==2 &amp;&amp; task_flg(cur_frames-2)==1, event=event.add_event(<span class="string">'Luminance Task'</span>,[]); <span class="keyword">end</span>
1167 <span class="keyword">end</span>
1168 
1169 
1170 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
1171 <span class="comment">%%%% The Trial Loop</span>
1172 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
1173 
1174 <span class="keyword">for</span> cc=1:1:length(checkerboard)
1175 
1176   <span class="comment">%% stimulus presentation loop</span>
1177   <span class="keyword">for</span> ff=1:1:nframe_stim
1178 
1179     <span class="comment">%% display the current frame</span>
1180     <span class="keyword">for</span> nn=1:1:nScr
1181       Screen(<span class="string">'SelectStereoDrawBuffer'</span>,winPtr,nn-1);
1182       Screen(<span class="string">'DrawTexture'</span>,winPtr,noisetexture,[],CenterRect(stimRect,winRect)); <span class="comment">% noise textures</span>
1183       Screen(<span class="string">'DrawTextures'</span>,winPtr,objecttextures,[],imgpos+stereopos{nn},imgrot); <span class="comment">% object images</span>
1184       Screen(<span class="string">'DrawTexture'</span>,winPtr,checkertexture{cc},[],CenterRect(stimRect,winRect)); <span class="comment">% checkerboard mask</span>
1185       Screen(<span class="string">'DrawTexture'</span>,winPtr,fix{task_flg(cur_frames)},[],CenterRect(fixRect,winRect)); <span class="comment">% the central fixation oval</span>
1186       Screen(<span class="string">'DrawTexture'</span>,winPtr,background,[],CenterRect(bgRect,winRect)); <span class="comment">% background</span>
1187       <span class="keyword">if</span> hide_flg, Screen(<span class="string">'DrawTexture'</span>,winPtr,abackground,[],winRect); <span class="keyword">end</span> <span class="comment">% additional background to hide the external region</span>
1188 
1189       <span class="comment">% blue line for stereo sync</span>
1190       <span class="keyword">if</span> strcmpi(dparam.ExpMode,<span class="string">'propixxstereo'</span>)
1191         Screen(<span class="string">'FillRect'</span>,winPtr,[0,0,255],blueRectOn(nn,:));
1192         Screen(<span class="string">'FillRect'</span>,winPtr,[0,0,0],blueRectOff(nn,:));
1193       <span class="keyword">end</span>
1194     <span class="keyword">end</span>
1195 
1196     <span class="comment">% flip the window</span>
1197     Screen(<span class="string">'DrawingFinished'</span>,winPtr);
1198     <span class="keyword">while</span> GetSecs()&lt;vbl+sparam.initial_fixation_time(1)+( ((cc-1)*nframe_stim+(ff-1))*sparam.waitframes-0.5 )*dparam.ifi, [resps,event]=resps.check_responses(event); <span class="keyword">end</span>
1199     Screen(<span class="string">'Flip'</span>,winPtr,[],[],[],1);
1200 
1201     <span class="keyword">if</span> ff==1
1202       event=event.add_event(sprintf(<span class="string">'Trial: %d'</span>,cc),[]);
1203       <span class="keyword">if</span> cc==1, fprintf(<span class="string">'Trial: '</span>); <span class="keyword">end</span>
1204       <span class="keyword">if</span> mod(cc,20)~=0 &amp;&amp; cc~=length(checkerboard), fprintf(sprintf(<span class="string">'%03d, '</span>,cc)); <span class="keyword">end</span>
1205       <span class="keyword">if</span> mod(cc,20)==0 || cc==length(checkerboard), fprintf(<span class="string">'%03d\n       '</span>,cc); <span class="keyword">end</span>
1206     <span class="keyword">end</span>
1207 
1208     <span class="comment">% update task</span>
1209     cur_frames=cur_frames+1;
1210     <span class="keyword">if</span> task_flg(cur_frames)==2 &amp;&amp; task_flg(cur_frames-1)==1, event=event.add_event(<span class="string">'Luminance Task'</span>,[]); <span class="keyword">end</span>
1211 
1212     <span class="comment">%% exit from the loop if the final frame is displayed</span>
1213     <span class="keyword">if</span> ff==nframe_stim &amp;&amp; cc==length(checkerboard), <span class="keyword">continue</span>; <span class="keyword">end</span>
1214 
1215     <span class="comment">%% update IDs</span>
1216 
1217     <span class="comment">% flickering checkerboard</span>
1218     <span class="keyword">if</span> ~mod(ff,nframe_flicker) <span class="comment">% noise pattern reversal</span>
1219       <span class="comment">% update the brownian noise texture.</span>
1220       Screen(<span class="string">'Close'</span>,noisetexture);
1221       <span class="comment">%bnimg=CreateColoredNoise([szh,szw],pdims,3,2,1,0,0);</span>
1222       <span class="comment">%bnimg=bnimg(1:size(checkerboard{1},1),1:size(checkerboard{1},2),:);</span>
1223       bnimg=<a href="../../Retinotopy/Common/CreateColoredNoise.html" class="code" title="function img=CreateColoredNoise(idims,sdims,num,beta,norm_flg,save_flg,show_flg)">CreateColoredNoise</a>(round([size(checkerboard{1},1),size(checkerboard{1},2)]./4),[1,1],3,2,1,0,0);
1224       noisetexture=Screen(<span class="string">'MakeTexture'</span>,winPtr,bnimg);
1225     <span class="keyword">end</span>
1226 
1227     <span class="keyword">if</span> ~mod(ff,ceil(nframe_flicker/2)) <span class="comment">% object image reversal</span>
1228       <span class="comment">%% update object images</span>
1229       <span class="keyword">for</span> pp=1:1:numel(imgids), Screen(<span class="string">'Close'</span>,objecttextures(pp)); <span class="keyword">end</span>
1230 
1231       obj_counter=obj_counter+1;
1232 
1233       <span class="comment">% image IDs</span>
1234       imgids=sparam.nimg*obj_counter+1:1:sparam.nimg*(obj_counter+1); <span class="comment">% the first image set is already presented</span>
1235       imgids(imgids&gt;size(img,4))=mod(imgids(imgids&gt;size(img,4)),size(img,4));
1236       imgids(imgids==0)=size(img,4);
1237 
1238       <span class="comment">% rectangles</span>
1239       cpos=[(posLims(3)-posLims(1)).*rand(sparam.nimg,1)+posLims(1),(posLims(4)-posLims(2)).*rand(sparam.nimg,1)+posLims(2)]; <span class="comment">% center positions, [x,y]</span>
1240       cszs=(sparam.imRatio(2)-sparam.imRatio(1)).*rand(sparam.nimg,1)+sparam.imRatio(1); <span class="comment">% image maginification factor</span>
1241       imgpos=[round(cpos(:,1)-cszs*imgsz(2)/2)+1,round(cpos(:,2)-cszs*imgsz(1)/2)+1,round(cpos(:,1)+cszs*imgsz(2)/2),round(cpos(:,2)+cszs*imgsz(1)/2)]';
1242 
1243       <span class="comment">% angles</span>
1244       imgrot=360.*rand(sparam.nimg,1);
1245 
1246       <span class="comment">% stereo depth</span>
1247       <span class="keyword">if</span> nScr&gt;1
1248         <span class="comment">% compute image shift from disparity</span>
1249         depths=(sparam.imdepth(2)-sparam.imdepth(1)).*rand(sparam.nimg,1)+sparam.imdepth(1);
1250         zdist=<a href="../../Retinotopy/Common/CalcDistFromDisparity.html" class="code" title="function zdist = CalcDistFromDisparity(ipd,disparity,viewdist)">CalcDistFromDisparity</a>(sparam.ipd,depths,sparam.vdist);
1251         zdist=sort(zdist,<span class="string">'descend'</span>);
1252         [Lshift,Rshift]=RayTrace_ScreenPos_X_MEX(zdist,sparam.ipd,sparam.vdist,sparam.pix_per_cm,0);
1253         stereopos{1}=[Lshift,zeros(sparam.nimg,1),Lshift,zeros(sparam.nimg,1)]';
1254         stereopos{2}=[Rshift,zeros(sparam.nimg,1),Rshift,zeros(sparam.nimg,1)]';
1255       <span class="keyword">else</span>
1256         stereopos{1}=repmat([0,0,0,0],[sparam.nimg,1])';
1257         stereopos{2}=repmat([0,0,0,0],[sparam.nimg,1])';
1258       <span class="keyword">end</span>
1259 
1260       <span class="comment">% generate object image textures</span>
1261       <span class="keyword">for</span> pp=1:1:numel(imgids), objecttextures(pp)=Screen(<span class="string">'MakeTexture'</span>,winPtr,img(:,:,:,imgids(pp))); <span class="keyword">end</span>
1262     <span class="keyword">end</span>
1263   <span class="keyword">end</span> <span class="comment">% for ff=1:1:nframe_stim</span>
1264 <span class="keyword">end</span> <span class="comment">% for cc=1:1:length(checkerboard)</span>
1265 
1266 
1267 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
1268 <span class="comment">%%%% Final Fixation</span>
1269 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
1270 
1271 <span class="keyword">for</span> nn=1:1:nScr
1272   Screen(<span class="string">'SelectStereoDrawBuffer'</span>,winPtr,nn-1);
1273   Screen(<span class="string">'DrawTexture'</span>,winPtr,fix{task_flg(cur_frames)},[],CenterRect(fixRect,winRect));
1274   Screen(<span class="string">'DrawTexture'</span>,winPtr,background,[],CenterRect(bgRect,winRect));
1275 
1276   <span class="comment">% blue line for stereo sync</span>
1277   <span class="keyword">if</span> strcmpi(dparam.ExpMode,<span class="string">'propixxstereo'</span>)
1278     Screen(<span class="string">'FillRect'</span>,winPtr,[0,0,255],blueRectOn(nn,:));
1279     Screen(<span class="string">'FillRect'</span>,winPtr,[0,0,0],blueRectOff(nn,:));
1280   <span class="keyword">end</span>
1281 <span class="keyword">end</span>
1282 Screen(<span class="string">'DrawingFinished'</span>,winPtr);
1283 <span class="keyword">while</span> GetSecs()&lt;vbl+sparam.initial_fixation_time(1)+sparam.pol_numRepeats*sparam.pol_cycle_duration-0.5*dparam.ifi, [resps,event]=resps.check_responses(event); <span class="keyword">end</span>
1284 Screen(<span class="string">'Flip'</span>,winPtr,[],[],[],1);
1285 <span class="comment">%cur_frames=cur_frames+1;</span>
1286 event=event.add_event(<span class="string">'Final Fixation'</span>,[]);
1287 fprintf(<span class="string">'\nfixation\n'</span>);
1288 
1289 <span class="comment">% wait for the initial fixation</span>
1290 <span class="keyword">for</span> ff=1:1:nframe_fixation(2)
1291   <span class="keyword">for</span> nn=1:1:nScr
1292     Screen(<span class="string">'SelectStereoDrawBuffer'</span>,winPtr,nn-1);
1293     Screen(<span class="string">'DrawTexture'</span>,winPtr,fix{task_flg(cur_frames)},[],CenterRect(fixRect,winRect));
1294     Screen(<span class="string">'DrawTexture'</span>,winPtr,background,[],CenterRect(bgRect,winRect));
1295 
1296     <span class="comment">% blue line for stereo sync</span>
1297     <span class="keyword">if</span> strcmpi(dparam.ExpMode,<span class="string">'propixxstereo'</span>)
1298       Screen(<span class="string">'FillRect'</span>,winPtr,[0,0,255],blueRectOn(nn,:));
1299       Screen(<span class="string">'FillRect'</span>,winPtr,[0,0,0],blueRectOff(nn,:));
1300     <span class="keyword">end</span>
1301   <span class="keyword">end</span>
1302   Screen(<span class="string">'DrawingFinished'</span>,winPtr);
1303   <span class="keyword">while</span> GetSecs()&lt;vbl+sparam.initial_fixation_time(1)+sparam.pol_numRepeats*sparam.pol_cycle_duration+(ff*sparam.waitframes-0.5)*dparam.ifi, [resps,event]=resps.check_responses(event); <span class="keyword">end</span>
1304   Screen(<span class="string">'Flip'</span>,winPtr,[],[],[],1);
1305 
1306   <span class="comment">% update task</span>
1307   cur_frames=cur_frames+1;
1308   <span class="keyword">if</span> task_flg(cur_frames-1)==2 &amp;&amp; task_flg(cur_frames-2)==1, event=event.add_event(<span class="string">'Luminance Task'</span>,[]); <span class="keyword">end</span>
1309 <span class="keyword">end</span>
1310 
1311 <span class="comment">% the final clock up</span>
1312 <span class="keyword">while</span> GetSecs()-the_experiment_start&lt;sum(sparam.initial_fixation_time)+sparam.pol_numRepeats*sparam.pol_cycle_duration
1313   [resps,event]=resps.check_responses(event);
1314 <span class="keyword">end</span>
1315 
1316 
1317 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
1318 <span class="comment">%%%% Experiment &amp; scanner end here</span>
1319 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
1320 
1321 experimentDuration=GetSecs()-the_experiment_start;
1322 event=event.add_event(<span class="string">'End'</span>,[]);
1323 fprintf(<span class="string">'\n'</span>);
1324 fprintf(<span class="string">'Experiment Completed: %.2f/%.2f secs\n'</span>,experimentDuration,<span class="keyword">...</span>
1325         sum(sparam.initial_fixation_time)+sparam.pol_numRepeats*sparam.pol_cycle_duration);
1326 fprintf(<span class="string">'\n'</span>);
1327 
1328 
1329 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
1330 <span class="comment">%%%% Cleaning up the PTB screen</span>
1331 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
1332 
1333 Screen(<span class="string">'CloseAll'</span>);
1334 
1335 <span class="comment">% closing datapixx</span>
1336 <span class="keyword">if</span> strcmpi(dparam.ExpMode,<span class="string">'propixxmono'</span>) || strcmpi(dparam.ExpMode,<span class="string">'propixxstereo'</span>)
1337   <span class="keyword">if</span> Datapixx(<span class="string">'IsViewpixx3D'</span>)
1338     Datapixx(<span class="string">'DisableVideoLcd3D60Hz'</span>);
1339     Datapixx(<span class="string">'RegWr'</span>);
1340   <span class="keyword">end</span>
1341   Datapixx(<span class="string">'Close'</span>);
1342 <span class="keyword">end</span>
1343 
1344 ShowCursor();
1345 Priority(0);
1346 <a href="../../Retinotopy/Common/GammaResetPTB.html" class="code" title="function GammaResetPTB(luminance_ratio)">GammaResetPTB</a>(1.0);
1347 
1348 
1349 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
1350 <span class="comment">%%%% Write data into file for post analysis</span>
1351 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
1352 
1353 <span class="comment">% saving the results</span>
1354 fprintf(<span class="string">'saving data...'</span>);
1355 
1356 <span class="comment">% save data</span>
1357 savefname=fullfile(resultDir,[num2str(subjID),<span class="string">'_idual_fixtask_'</span>,sparam.mode,<span class="string">'_results_run_'</span>,num2str(acq,<span class="string">'%02d'</span>),<span class="string">'.mat'</span>]);
1358 
1359 <span class="comment">% backup the old file(s)</span>
1360 <span class="keyword">if</span> ~overwrite_flg
1361   <a href="../../Retinotopy/Common/BackUpObsoleteFiles.html" class="code" title="function [new_fname,backup_fname]=BackUpObsoleteFiles(tgt_dir,tgt_fname,backup_prefix)">BackUpObsoleteFiles</a>(fullfile(<span class="string">'subjects'</span>,num2str(subjID),<span class="string">'results'</span>,today),<span class="keyword">...</span>
1362                       [num2str(subjID),<span class="string">'_idual_fixtask_'</span>,sparam.mode,<span class="string">'_results_run_'</span>,num2str(acq,<span class="string">'%02d'</span>),<span class="string">'.mat'</span>],<span class="string">'_old'</span>);
1363 <span class="keyword">end</span>
1364 
1365 eval(sprintf(<span class="string">'save %s subjID acq sparam dparam event gamma_table;'</span>,savefname));
1366 fprintf(<span class="string">'done.\n'</span>);
1367 
1368 <span class="comment">% calculate &amp; display task performance</span>
1369 fprintf(<span class="string">'calculating task accuracy...\n'</span>);
1370 correct_event=cell(2,1); <span class="keyword">for</span> ii=1:1:2, correct_event{ii}=sprintf(<span class="string">'key%d'</span>,ii); <span class="keyword">end</span>
1371 [task.numTasks,task.numHits,task.numErrors,task.numResponses,task.RT]=event.calc_accuracy(correct_event);
1372 event=event.get_event(); <span class="comment">% convert an event logger object to a cell data structure</span>
1373 eval(sprintf(<span class="string">'save -append %s event task;'</span>,savefname));
1374 fprintf(<span class="string">'done.\n'</span>);
1375 
1376 
1377 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
1378 <span class="comment">%%%% Removing path to the subfunctions, and finalizing the script</span>
1379 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
1380 
1381 rmpath(genpath(fullfile(rootDir,<span class="string">'..'</span>,<span class="string">'Common'</span>)));
1382 rmpath(fullfile(rootDir,<span class="string">'..'</span>,<span class="string">'Generation'</span>));
1383 clear all; clear mex; clear <span class="keyword">global</span>;
1384 diary off;
1385 
1386 
1387 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
1388 <span class="comment">%%%% tell the experimenter that the measurements are completed</span>
1389 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
1390 
1391 <span class="keyword">try</span>
1392   <span class="keyword">for</span> ii=1:1:3, Snd(<span class="string">'Play'</span>,sin(2*pi*0.2*(0:900)),8000); <span class="keyword">end</span>
1393 <span class="keyword">catch</span>
1394   <span class="comment">% do nothing</span>
1395 <span class="keyword">end</span>
1396 
1397 
1398 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
1399 <span class="comment">%%%% Catch the errors</span>
1400 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
1401 
1402 <span class="keyword">catch</span> lasterror
1403   <span class="comment">% this &quot;catch&quot; section executes in case of an error in the &quot;try&quot; section</span>
1404   <span class="comment">% above.  Importantly, it closes the onscreen window if its open.</span>
1405   Screen(<span class="string">'CloseAll'</span>);
1406 
1407   <span class="keyword">if</span> exist(<span class="string">'dparam'</span>,<span class="string">'var'</span>)
1408     <span class="keyword">if</span> <a href="../../Retinotopy/Common/isstructmember.html" class="code" title="function isFieldResult = isstructmember(inStruct, fieldName)">isstructmember</a>(dparam,<span class="string">'ExpMode'</span>)
1409       <span class="keyword">if</span> strcmpi(dparam.ExpMode,<span class="string">'propixxmono'</span>) || strcmpi(dparam.ExpMode,<span class="string">'propixxstereo'</span>)
1410         <span class="keyword">if</span> Datapixx(<span class="string">'IsViewpixx3D'</span>)
1411           Datapixx(<span class="string">'DisableVideoLcd3D60Hz'</span>);
1412           Datapixx(<span class="string">'RegWr'</span>);
1413         <span class="keyword">end</span>
1414         Datapixx(<span class="string">'Close'</span>);
1415       <span class="keyword">end</span>
1416     <span class="keyword">end</span>
1417   <span class="keyword">end</span>
1418 
1419   ShowCursor();
1420   Priority(0);
1421   <a href="../../Retinotopy/Common/GammaResetPTB.html" class="code" title="function GammaResetPTB(luminance_ratio)">GammaResetPTB</a>(1.0);
1422   tmp=lasterror; <span class="comment">%#ok</span>
1423   <span class="comment">%if exist('event','var'), event=event.get_event(); end %#ok % just for debugging</span>
1424   diary off;
1425   fprintf([<span class="string">'\nError detected and the program was terminated.\n'</span>,<span class="keyword">...</span>
1426            <span class="string">'To check error(s), please type ''tmp''.\n'</span>,<span class="keyword">...</span>
1427            <span class="string">'Please save the current variables now if you need.\n'</span>,<span class="keyword">...</span>
1428            <span class="string">'Then, quit by ''dbquit''\n'</span>]);
1429   keyboard;
1430   rmpath(genpath(fullfile(rootDir,<span class="string">'..'</span>,<span class="string">'Common'</span>)));
1431   rmpath(fullfile(rootDir,<span class="string">'..'</span>,<span class="string">'Generation'</span>));
1432   clear all; clear mex; clear <span class="keyword">global</span>;
1433   <span class="keyword">return</span>
1434 <span class="keyword">end</span> <span class="comment">% try..catch</span>
1435 
1436 
1437 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
1438 <span class="comment">%%%%% That's it - we're done</span>
1439 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
1440 <span class="keyword">return</span>;
1441 <span class="comment">% end % function idual_fixtask</span></pre></div>
<hr><address>Generated on Wed 09-Jun-2021 14:56:30 by <strong><a href="http://www.artefact.tk/software/matlab/m2html/" target="_parent">m2html</a></strong> &copy; 2005 using a BVQX_hbtools customized template</address>
</body>
</html>