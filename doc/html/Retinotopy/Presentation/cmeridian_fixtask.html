<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
                "http://www.w3.org/TR/REC-html40/loose.dtd">
<html>
<head>
  <title>Description of cmeridian_fixtask</title>
  <meta name="keywords" content="cmeridian_fixtask">
  <meta name="description" content="Color/luminance-defined dual checkerboard stimulus along horizontal/vertical meridians with fixation luminance change-detection tasks.">
  <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
  <meta name="generator" content="m2html &copy; 2005 Guillaume Flandin">
  <meta name="robots" content="index, follow">
  <link type="text/css" rel="stylesheet" href="../../m2html.css">
  <script type="text/javascript">
    if (top.frames.length == 0) { top.location = "../../index.html"; };
  </script>
</head>
<body>
<a name="_top"></a>
<!-- # Retinotopy --><!-- menu.html Presentation -->
<h1>cmeridian_fixtask
</h1>

<h2><a name="_name"></a>PURPOSE <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
<div class="box"><strong>Color/luminance-defined dual checkerboard stimulus along horizontal/vertical meridians with fixation luminance change-detection tasks.</strong></div>

<h2><a name="_synopsis"></a>SYNOPSIS <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
<div class="box"><strong>function cmeridian_fixtask(subjID,exp_mode,acq,displayfile,stimulusfile,gamma_table,overwrite_flg,force_proceed_flag) </strong></div>

<h2><a name="_description"></a>DESCRIPTION <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
<div class="fragment" style="background-image:url(../../hb_brain.png); background-position:right top"><pre class="comment"> Color/luminance-defined dual checkerboard stimulus along horizontal/vertical meridians with fixation luminance change-detection tasks.
 function cmeridian_fixtask(subjID,exp_mode,acq,:displayfile,:stimulusfile,:gamma_table,:overwrite_flg,:force_proceed_flag)
 (: is optional)

 - This function generates and presents color/luminance-defined dual checkerboard stimulus
   to measure cortical retinotopy and to delineate retinotopic visual area borders.
   Unlike the standard phase-encoded visual stimulation, this fucntion presents the checkerboards
   alond the horizontal or vertical visual meridians alternatively. Please use GLM for retinotopy
   analysis, not the conventional phase-encoded analysis technique.

   references : 1. Visuotopic cortical connectivity underlying attention revealed with white-matter tractography.
                   Greenberg AS, Verstynen T, Chiu YC, Yantis S, Schneider W, Behrmann M. (2012).
                   J Neurosci. 32(8), 2773-82.
                2. Parallel, multi-stage processing of colors, faces and shapes in macaque inferior temporal cortex.
                   Lafer-Sousa, R, Conway, BR. (2013). Nature Neuroscience, 16, 1870-1878.

 - This script shoud be used with MATLAB Psychtoolbox version 3 or above.

 - Luminance detection task: the central fixation point (default: white)
   randomly turns to gray. An observer has to press the button if s/he
   detects this luminance change. Response keys are defined in displayfile.

 [note]
 Behavioral task of (function_name)_fixtask is to detect changes of luminance
 of the central fixation point, while the task in (function_name) is to detect
 changes of luminance of one of the patches in the checkerboard stimuli.
 Here, the central fixation task is more easy to sustain the stable fixation
 on the center of the screen and may be suitable for naive/non-expert
 participants with minimizing unwilling eye movements. However, some studies
 have reported that attention to the target stimulus (checker-patch luminance
 change detection task) is required to get reliable retinotopic representations
 in higher-order visual areas.


 Created    : &quot;2018-12-12 12:13:50 ban&quot;
 Last Update: &quot;2021-06-07 17:24:29 ban&quot;



 [input variables]
 sujID         : ID of subject, string, such as 's01'
                 you also need to create a directory ./subjects/(subj) and put displayfile and stimulusfile there.
                 !!!!!!!!!!!!!!!!!! IMPORTANT NOTE !!!!!!!!!!!!!!!!!!!!!!!!
                 !!! if 'debug' (case insensitive) is included          !!!
                 !!! in subjID string, this program runs as DEBUG mode; !!!
                 !!! stimulus images are saved as *.png format at       !!!
                 !!! ~/Retinotopy/Presentation/images                   !!!
                 !!!!!!!!!!!!!!!!!! IMPORTANT NOTE !!!!!!!!!!!!!!!!!!!!!!!!

 exp_mode      : experiment mode acceptable in this script is only &quot;meridian&quot;
 acq           : acquisition number (design file number),
                 an integer, such as 1, 2, 3, ...
 displayfile   : (optional) display condition file,
                 *.m file, such as 'RetDepth_display_fmri.m'
                 the file should be located in ./subjects/(subj)/
 stimulusfile  : (optional) stimulus condition file,
                 *.m file, such as 'RetDepth_stimulus_exp1.m'
                 the file should be located in ./subjects/(subj)/
 gamma_table   : (optional) table(s) of gamma-corrected video input values (Color LookupTable).
                 256(8-bits) x 3(RGB) x 1(or 2,3,... when using multiple displays) matrix
                 or a *.mat file specified with a relative path format. e.g. '/gamma_table/gamma1.mat'
                 The *.mat should include a variable named &quot;gamma_table&quot; consists of a 256x3xN matrix.
                 if you use multiple (more than 1) displays and set a 256x3x1 gamma-table, the same
                 table will be applied to all displays. if the number of displays and gamma tables
                 are different (e.g. you have 3 displays and 256x3x!2! gamma-tables), the last
                 gamma_table will be applied to the second and third displays.
                 if empty, normalized gamma table (repmat(linspace(0.0,1.0,256),3,1)) will be applied.
 overwrite_flg : (optional) whether overwriting pre-existing result file. if 1, the previous result
                 file with the same acquisition number will be overwritten by the previous one.
                 if 0, the existing file will be backed-up by adding a prefix '_old' at the tail
                 of the file. 0 by default.
 force_proceed_flag : (optional) whether proceeding stimulus presentatin without waiting for
                 the experimenter response (e.g. presesing the ENTER key) or a trigger.
                 if 1, the stimulus presentation will be automatically carried on.

 !!! NOTICE !!!!
 displayfile &amp; stimulusfile should be located at
 ./subjects/(subjID)/
 as ./subjects/(subjID)/*_display_fmri.m
    ./subjects/(subjID)/*_stimuli.m


 [output variables]
 no output matlab variable.


 [output files]
 1. result file
    stored ./subjects/(subjID)/results/(date)
    as ./subjects/(subjID)/results/(date)/(subjID)_cmeridian_fixtask_results_run_(run_num).mat


 [example]
 &gt;&gt; cmeridian_fixtask('HB','meridian',1,'ret_display.m','ret_checker_stimulus_exp1.m')

 [About displayfile]
 The contents of the displayfile are as below.
 (The file includs 6 lines of headers and following display parameters)

 (an example of the displayfile)

 % ************************************************************
 % This is the display configuration file for the retinotopy stimuli
 % Programmed by Hiroshi Ban Nov 01 2013
 % ************************************************************

 % display mode, one of &quot;mono&quot;, &quot;dual&quot;, &quot;dualcross&quot;, &quot;dualparallel&quot;, &quot;cross&quot;, &quot;parallel&quot;, &quot;redgreen&quot;, &quot;greenred&quot;,
 % &quot;redblue&quot;, &quot;bluered&quot;, &quot;shutter&quot;, &quot;topbottom&quot;, &quot;bottomtop&quot;, &quot;interleavedline&quot;, &quot;interleavedcolumn&quot;, &quot;propixxmono&quot;, &quot;propixxstereo&quot;
 dparam.ExpMode='mono';

 dparam.scrID=1; % screen ID, generally 0 for a single display setup, 1 for dual display setup

 % a method to start stimulus presentation
 % 0:ENTER/SPACE, 1:Left-mouse button, 2:the first MR trigger pulse (CiNet),
 % 3:waiting for a MR trigger pulse (BUIC) -- checking onset of pin #11 of the parallel port,
 % or 4:custom key trigger (wait for a key input that you specify as tgt_key).
 dparam.start_method=2;

 % a pseudo trigger key from the MR scanner when it starts, valid only when dparam.start_method=4;
 dparam.custom_trigger='t';

 % keyboard settings
 dparam.Key1=51; % key 1 (left)
 dparam.Key2=52; % key 2 (right)

 % screen settings

 %%% whether displaying the stimuli in full-screen mode or
 %%% as is (the precise resolution), 'true' or 'false' (true)
 dparam.fullscr=false;

 %%% the resolution of the screen height
 dparam.ScrHeight=1200;

 %% the resolution of the screen width
 dparam.ScrWidth=1920;

 % whether forcing to use specific frame rate, if 0, the frame rate wil bw computed in the ImagesShowPTB function.
 % if non zero, the value is used as the screen frame rate.
 dparam.force_frame_rate=60;

 % whther skipping the PTB's vertical-sync signal test. if 1, the sync test is skipped
 dparam.skip_sync_test=0;


 [About stimulusfile]
 The contents of the stimulusfile are as below.
 (The file includs 6 lines of headers and following stimulus parameters)

 (an example of the stimulusfile)

 % ************************************************************
 % This is the stimulus parameter file for the cmeridian retinotopy stimulus
 % Programmed by Hiroshi Ban Dec 12 2018
 % ************************************************************

 % &quot;sparam&quot; means &quot;stimulus generation parameters&quot;

 %%% stimulus parameters
 sparam.nwedges     = 4;     % number of wedge subdivisions along polar angle
 sparam.nrings      = 4;     % number of ring subdivisions along eccentricity angle
 sparam.width       = 24;    % wedge width in deg along polar angle
 sparam.phase       = 0;     % phase shift in deg

 sparam.maxRad      = 8;     % maximum radius of  annulus (degrees)
 sparam.minRad      = 0;     % minumum

 sparam.colors      = [ 128, 128, 128; % number of colors for compensating flickering checkerboard
                        255,   0,   0; % the first row is background
                          0, 255,   0; % the second to end are patch colors
                        255, 255,   0;
                          0,   0, 255;
                        255,   0, 255;
                          0, 255, 255;
                        255, 255, 255;
                          0,   0,   0;
                        255, 128,   0;
                        128,   0, 255;];

 %%% duration in msec for each cycle &amp; repetitions
 % Here, the stimulus presentation protocol is defined as below.
 % initial_fixation_time(1) ---&gt; block_duration-rest_duration (the wedge along the horizontal visual meridian) ---&gt; rest_duration (blank) ---&gt;
 %   block_duration-rest_duration (the wedge along the vertical) ---&gt; rest_duration (blank) ---&gt; block_duration-rest_duration (the wedge along the horizontal) ---&gt;
 %     rest_duration (blank) ---&gt; block_duration-rest_duration (the wedge along the vertical) ---&gt; ... (repeated numRepeats in total) ---&gt; initial_fixation_time(2)
 % Therefore, one_stimulation_cycle = block_duration x 2 (note: in this period, stimulation = block_duration-rest_duration)

 sparam.block_duration=16000; % msec
 sparam.rest_duration =0; % msec, rest after each block
 sparam.numRepeats=6;

 %%% set number of frames to flip the screen
 % Here, I set the number as large as I can to minimize vertical cynching error.
 % the final 2 is for 2 times repetitions of the flicker
 % Set 1 if you want to flip the display at each vertical sync, but not recommended as it uses much CPU power
 sparam.waitframes = 60*(sparam.block_duration/1000) / ((sparam.block_duration-sparam.rest_duration)/1000) / ( (size(sparam.colors,1)-1)*2 );

 %%% fixation period in msec before/after presenting the target stimuli, integer
 % must set a value more than 1 TR for initializing the frame counting.
 sparam.initial_fixation_time=[4000,4000];

 %%% fixation size &amp; color
 sparam.fixtype=1; % 1: circular, 2: rectangular, 3: concentric fixation point
 sparam.fixsize=12; % radius in pixels
 sparam.fixcolor=[255,255,255];

 %%% background color
 sparam.bgcolor=sparam.colors(1,:); %[0,0,0];

 %%% background-patch colors (RGB)
 sparam.bgtype=1; % 1: a simple background with sparam.bgcolor (then, the parameters belows are not used), 2: a background with grid guides
 sparam.patch_size=[30,30]; % background patch size, [height,width] in pixels
 sparam.patch_num=[20,40];  % the number of background patches along vertical and horizontal axis
 sparam.patch_color1=[255,255,255];
 sparam.patch_color2=[0,0,0];

 %%% for converting degree to pixels
 run(fullfile(fileparts(mfilename('fullpath')),'sizeparams'));
 %sparam.pix_per_cm=57.1429;
 %sparam.vdist=65;


 [HOWTO create stimulus files]
 1. All of the stimuli are created in this script in real-time
    with MATLAB scripts &amp; functions.
    see ../Generation &amp; ../Common directries.
 2. Stimulus parameters are defined in the display &amp; stimulus file.


 [reference]
 for stmulus generation, see ../Generation &amp; ../Common directories.</pre></div>

<!-- crossreference -->
<h2><a name="_cross"></a>CROSS-REFERENCE INFORMATION <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
<div class="fragment" style="background-image:url(../../hb_brain.png); background-position:right top">
This function calls:
<ul style="list-style-image:url(../../matlabicon.gif)">
<li><a href="../../Retinotopy/Common/BackUpObsoleteFiles.html" class="code" title="function [new_fname,backup_fname]=BackUpObsoleteFiles(tgt_dir,tgt_fname,backup_prefix)">BackUpObsoleteFiles</a>	Backups already-existing file(s) in the target directory by adding some file-prefix.</li><li><a href="../../Retinotopy/Common/CheckPTBversion.html" class="code" title="function [PTB_OK,vertxt] = CheckPTBversion(num_mainver_youwant)">CheckPTBversion</a>	Checks the version of the currently running Psychtoolbox.</li><li><a href="../../Retinotopy/Common/CreateBackgroundImage.html" class="code" title="function [Bimg,parameters] = CreateBackgroundImage(wdims,stdims,pdims,bgcolor,color1,color2,fixcolor,patchnum,fix_flag,save_flag,show_flag)">CreateBackgroundImage</a>	Creates background image that can be used as a background of your stimulus displays.</li><li><a href="../../Retinotopy/Common/CreateFixationImgCircular.html" class="code" title="function fix=CreateFixationImgCircular(fixsize,fixcolor,bgcolor,circlesize,show_flag,save_flag)">CreateFixationImgCircular</a>	Creates a circular fixation image for a monocular display setting.</li><li><a href="../../Retinotopy/Common/CreateFixationImgConcentrateMono.html" class="code" title="function fix=CreateFixationImgConcentrateMono(fixsize,fixcolor,bgcolor,circlesize,gap,show_flag,save_flag)">CreateFixationImgConcentrateMono</a>	Creates a circular fixation image for a monocular display setting.</li><li><a href="../../Retinotopy/Common/CreateFixationImgMono.html" class="code" title="function fix=CreateFixationImgMono(fixsize,fixcolor,bgcolor,fixlinew,fixlineh,show_flag,save_flag)">CreateFixationImgMono</a>	Creates a cross-shaped fixation image for a monocular display setting.</li><li><a href="../../Retinotopy/Common/DisplayMessage2.html" class="code" title="function DisplayMessage2(message,bgcolor,winPtr,numScreens,drawing_font,drawing_size)">DisplayMessage2</a>	Displays message on the center of each of multiple PTB windows.</li><li><a href="../../Retinotopy/Common/DrawTextureWithCLUT.html" class="code" title="function DrawTextureWithCLUT(win, src, newclut, srcRect, destRect, rotangle)">DrawTextureWithCLUT</a>	Draws a texture with Color LookupTable you specified (modified version of Screen('DrawTexture')).</li><li><a href="../../Retinotopy/Common/GammaLoadPTB.html" class="code" title="function GammaLoadPTB(gamma_table)">GammaLoadPTB</a>	Loads and sets display gamma-table(s) using PTB Screen() function.</li><li><a href="../../Retinotopy/Common/GammaResetPTB.html" class="code" title="function GammaResetPTB(luminance_ratio)">GammaResetPTB</a>	Resets display gamma with PTB Screen() function.</li><li><a href="../../Retinotopy/Common/InitializePTBDisplays.html" class="code" title="function [winPtr,winRect,nScr,fps,ifi,initDisplay_OK]=InitializePTBDisplays(disp_mode,bgcolor,flipping,rgb_gains,custom_scrIDs)">InitializePTBDisplays</a>	Initializes PTB screen(s) for monocular/binocular presentations using PsychImaging() function.</li><li><a href="../../Retinotopy/Common/InitializeRandomSeed.html" class="code" title="function cseed=InitializeRandomSeed">InitializeRandomSeed</a>	Initializes MATLAB internal state of a random seed.</li><li><a href="../../Retinotopy/Common/ValidateStructureFields.html" class="code" title="function structval=ValidateStructureFields(structval,varargin)">ValidateStructureFields</a>	Validates the input structure and set the default values to the missing field(s)</li><li><a href="../../Retinotopy/Common/eventlogger.html" class="code" title="">eventlogger</a>	</li><li><a href="../../Retinotopy/Common/isstructmember.html" class="code" title="function isFieldResult = isstructmember(inStruct, fieldName)">isstructmember</a>	Checks whether the target struct contains a filed you specified as a member.</li><li><a href="../../Retinotopy/Common/responselogger.html" class="code" title="">responselogger</a>	</li><li><a href="../../Retinotopy/Generation/DrawTextureWithCLUT.html" class="code" title="function DrawTextureWithCLUT(win, src, newclut, srcRect, destRect, rotangle)">DrawTextureWithCLUT</a>	Draws a texture with Color LookupTable you specified (modified version of Screen('DrawTexture')).</li><li><a href="../../Retinotopy/Generation/pol_GenerateCheckerBoard1D.html" class="code" title="function [checkerboard,bincheckerboard,mask]=pol_GenerateCheckerBoard1D(rmin,rmax,width,startangle,pix_per_deg,nwedges,nrings,phase,dual_flg)">pol_GenerateCheckerBoard1D</a>	Generates checkerboard patterns (polar angle-based subdivision) with an individual ID number on each patch.</li></ul>
This function is called by:
<ul style="list-style-image:url(../../matlabicon.gif)">
</ul>
</div>
<!-- crossreference -->



<h2><a name="_source"></a>SOURCE CODE <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
<div class="fragment" style="background-image:url(../../hb_brain.png); background-position:right top"><pre>0001 <a name="_sub0" href="#_subfunctions" class="code">function cmeridian_fixtask(subjID,exp_mode,acq,displayfile,stimulusfile,gamma_table,overwrite_flg,force_proceed_flag)</a>
0002 
0003 <span class="comment">% Color/luminance-defined dual checkerboard stimulus along horizontal/vertical meridians with fixation luminance change-detection tasks.</span>
0004 <span class="comment">% function cmeridian_fixtask(subjID,exp_mode,acq,:displayfile,:stimulusfile,:gamma_table,:overwrite_flg,:force_proceed_flag)</span>
0005 <span class="comment">% (: is optional)</span>
0006 <span class="comment">%</span>
0007 <span class="comment">% - This function generates and presents color/luminance-defined dual checkerboard stimulus</span>
0008 <span class="comment">%   to measure cortical retinotopy and to delineate retinotopic visual area borders.</span>
0009 <span class="comment">%   Unlike the standard phase-encoded visual stimulation, this fucntion presents the checkerboards</span>
0010 <span class="comment">%   alond the horizontal or vertical visual meridians alternatively. Please use GLM for retinotopy</span>
0011 <span class="comment">%   analysis, not the conventional phase-encoded analysis technique.</span>
0012 <span class="comment">%</span>
0013 <span class="comment">%   references : 1. Visuotopic cortical connectivity underlying attention revealed with white-matter tractography.</span>
0014 <span class="comment">%                   Greenberg AS, Verstynen T, Chiu YC, Yantis S, Schneider W, Behrmann M. (2012).</span>
0015 <span class="comment">%                   J Neurosci. 32(8), 2773-82.</span>
0016 <span class="comment">%                2. Parallel, multi-stage processing of colors, faces and shapes in macaque inferior temporal cortex.</span>
0017 <span class="comment">%                   Lafer-Sousa, R, Conway, BR. (2013). Nature Neuroscience, 16, 1870-1878.</span>
0018 <span class="comment">%</span>
0019 <span class="comment">% - This script shoud be used with MATLAB Psychtoolbox version 3 or above.</span>
0020 <span class="comment">%</span>
0021 <span class="comment">% - Luminance detection task: the central fixation point (default: white)</span>
0022 <span class="comment">%   randomly turns to gray. An observer has to press the button if s/he</span>
0023 <span class="comment">%   detects this luminance change. Response keys are defined in displayfile.</span>
0024 <span class="comment">%</span>
0025 <span class="comment">% [note]</span>
0026 <span class="comment">% Behavioral task of (function_name)_fixtask is to detect changes of luminance</span>
0027 <span class="comment">% of the central fixation point, while the task in (function_name) is to detect</span>
0028 <span class="comment">% changes of luminance of one of the patches in the checkerboard stimuli.</span>
0029 <span class="comment">% Here, the central fixation task is more easy to sustain the stable fixation</span>
0030 <span class="comment">% on the center of the screen and may be suitable for naive/non-expert</span>
0031 <span class="comment">% participants with minimizing unwilling eye movements. However, some studies</span>
0032 <span class="comment">% have reported that attention to the target stimulus (checker-patch luminance</span>
0033 <span class="comment">% change detection task) is required to get reliable retinotopic representations</span>
0034 <span class="comment">% in higher-order visual areas.</span>
0035 <span class="comment">%</span>
0036 <span class="comment">%</span>
0037 <span class="comment">% Created    : &quot;2018-12-12 12:13:50 ban&quot;</span>
0038 <span class="comment">% Last Update: &quot;2021-06-07 17:24:29 ban&quot;</span>
0039 <span class="comment">%</span>
0040 <span class="comment">%</span>
0041 <span class="comment">%</span>
0042 <span class="comment">% [input variables]</span>
0043 <span class="comment">% sujID         : ID of subject, string, such as 's01'</span>
0044 <span class="comment">%                 you also need to create a directory ./subjects/(subj) and put displayfile and stimulusfile there.</span>
0045 <span class="comment">%                 !!!!!!!!!!!!!!!!!! IMPORTANT NOTE !!!!!!!!!!!!!!!!!!!!!!!!</span>
0046 <span class="comment">%                 !!! if 'debug' (case insensitive) is included          !!!</span>
0047 <span class="comment">%                 !!! in subjID string, this program runs as DEBUG mode; !!!</span>
0048 <span class="comment">%                 !!! stimulus images are saved as *.png format at       !!!</span>
0049 <span class="comment">%                 !!! ~/Retinotopy/Presentation/images                   !!!</span>
0050 <span class="comment">%                 !!!!!!!!!!!!!!!!!! IMPORTANT NOTE !!!!!!!!!!!!!!!!!!!!!!!!</span>
0051 <span class="comment">%</span>
0052 <span class="comment">% exp_mode      : experiment mode acceptable in this script is only &quot;meridian&quot;</span>
0053 <span class="comment">% acq           : acquisition number (design file number),</span>
0054 <span class="comment">%                 an integer, such as 1, 2, 3, ...</span>
0055 <span class="comment">% displayfile   : (optional) display condition file,</span>
0056 <span class="comment">%                 *.m file, such as 'RetDepth_display_fmri.m'</span>
0057 <span class="comment">%                 the file should be located in ./subjects/(subj)/</span>
0058 <span class="comment">% stimulusfile  : (optional) stimulus condition file,</span>
0059 <span class="comment">%                 *.m file, such as 'RetDepth_stimulus_exp1.m'</span>
0060 <span class="comment">%                 the file should be located in ./subjects/(subj)/</span>
0061 <span class="comment">% gamma_table   : (optional) table(s) of gamma-corrected video input values (Color LookupTable).</span>
0062 <span class="comment">%                 256(8-bits) x 3(RGB) x 1(or 2,3,... when using multiple displays) matrix</span>
0063 <span class="comment">%                 or a *.mat file specified with a relative path format. e.g. '/gamma_table/gamma1.mat'</span>
0064 <span class="comment">%                 The *.mat should include a variable named &quot;gamma_table&quot; consists of a 256x3xN matrix.</span>
0065 <span class="comment">%                 if you use multiple (more than 1) displays and set a 256x3x1 gamma-table, the same</span>
0066 <span class="comment">%                 table will be applied to all displays. if the number of displays and gamma tables</span>
0067 <span class="comment">%                 are different (e.g. you have 3 displays and 256x3x!2! gamma-tables), the last</span>
0068 <span class="comment">%                 gamma_table will be applied to the second and third displays.</span>
0069 <span class="comment">%                 if empty, normalized gamma table (repmat(linspace(0.0,1.0,256),3,1)) will be applied.</span>
0070 <span class="comment">% overwrite_flg : (optional) whether overwriting pre-existing result file. if 1, the previous result</span>
0071 <span class="comment">%                 file with the same acquisition number will be overwritten by the previous one.</span>
0072 <span class="comment">%                 if 0, the existing file will be backed-up by adding a prefix '_old' at the tail</span>
0073 <span class="comment">%                 of the file. 0 by default.</span>
0074 <span class="comment">% force_proceed_flag : (optional) whether proceeding stimulus presentatin without waiting for</span>
0075 <span class="comment">%                 the experimenter response (e.g. presesing the ENTER key) or a trigger.</span>
0076 <span class="comment">%                 if 1, the stimulus presentation will be automatically carried on.</span>
0077 <span class="comment">%</span>
0078 <span class="comment">% !!! NOTICE !!!!</span>
0079 <span class="comment">% displayfile &amp; stimulusfile should be located at</span>
0080 <span class="comment">% ./subjects/(subjID)/</span>
0081 <span class="comment">% as ./subjects/(subjID)/*_display_fmri.m</span>
0082 <span class="comment">%    ./subjects/(subjID)/*_stimuli.m</span>
0083 <span class="comment">%</span>
0084 <span class="comment">%</span>
0085 <span class="comment">% [output variables]</span>
0086 <span class="comment">% no output matlab variable.</span>
0087 <span class="comment">%</span>
0088 <span class="comment">%</span>
0089 <span class="comment">% [output files]</span>
0090 <span class="comment">% 1. result file</span>
0091 <span class="comment">%    stored ./subjects/(subjID)/results/(date)</span>
0092 <span class="comment">%    as ./subjects/(subjID)/results/(date)/(subjID)_cmeridian_fixtask_results_run_(run_num).mat</span>
0093 <span class="comment">%</span>
0094 <span class="comment">%</span>
0095 <span class="comment">% [example]</span>
0096 <span class="comment">% &gt;&gt; cmeridian_fixtask('HB','meridian',1,'ret_display.m','ret_checker_stimulus_exp1.m')</span>
0097 <span class="comment">%</span>
0098 <span class="comment">% [About displayfile]</span>
0099 <span class="comment">% The contents of the displayfile are as below.</span>
0100 <span class="comment">% (The file includs 6 lines of headers and following display parameters)</span>
0101 <span class="comment">%</span>
0102 <span class="comment">% (an example of the displayfile)</span>
0103 <span class="comment">%</span>
0104 <span class="comment">% % ************************************************************</span>
0105 <span class="comment">% % This is the display configuration file for the retinotopy stimuli</span>
0106 <span class="comment">% % Programmed by Hiroshi Ban Nov 01 2013</span>
0107 <span class="comment">% % ************************************************************</span>
0108 <span class="comment">%</span>
0109 <span class="comment">% % display mode, one of &quot;mono&quot;, &quot;dual&quot;, &quot;dualcross&quot;, &quot;dualparallel&quot;, &quot;cross&quot;, &quot;parallel&quot;, &quot;redgreen&quot;, &quot;greenred&quot;,</span>
0110 <span class="comment">% % &quot;redblue&quot;, &quot;bluered&quot;, &quot;shutter&quot;, &quot;topbottom&quot;, &quot;bottomtop&quot;, &quot;interleavedline&quot;, &quot;interleavedcolumn&quot;, &quot;propixxmono&quot;, &quot;propixxstereo&quot;</span>
0111 <span class="comment">% dparam.ExpMode='mono';</span>
0112 <span class="comment">%</span>
0113 <span class="comment">% dparam.scrID=1; % screen ID, generally 0 for a single display setup, 1 for dual display setup</span>
0114 <span class="comment">%</span>
0115 <span class="comment">% % a method to start stimulus presentation</span>
0116 <span class="comment">% % 0:ENTER/SPACE, 1:Left-mouse button, 2:the first MR trigger pulse (CiNet),</span>
0117 <span class="comment">% % 3:waiting for a MR trigger pulse (BUIC) -- checking onset of pin #11 of the parallel port,</span>
0118 <span class="comment">% % or 4:custom key trigger (wait for a key input that you specify as tgt_key).</span>
0119 <span class="comment">% dparam.start_method=2;</span>
0120 <span class="comment">%</span>
0121 <span class="comment">% % a pseudo trigger key from the MR scanner when it starts, valid only when dparam.start_method=4;</span>
0122 <span class="comment">% dparam.custom_trigger='t';</span>
0123 <span class="comment">%</span>
0124 <span class="comment">% % keyboard settings</span>
0125 <span class="comment">% dparam.Key1=51; % key 1 (left)</span>
0126 <span class="comment">% dparam.Key2=52; % key 2 (right)</span>
0127 <span class="comment">%</span>
0128 <span class="comment">% % screen settings</span>
0129 <span class="comment">%</span>
0130 <span class="comment">% %%% whether displaying the stimuli in full-screen mode or</span>
0131 <span class="comment">% %%% as is (the precise resolution), 'true' or 'false' (true)</span>
0132 <span class="comment">% dparam.fullscr=false;</span>
0133 <span class="comment">%</span>
0134 <span class="comment">% %%% the resolution of the screen height</span>
0135 <span class="comment">% dparam.ScrHeight=1200;</span>
0136 <span class="comment">%</span>
0137 <span class="comment">% %% the resolution of the screen width</span>
0138 <span class="comment">% dparam.ScrWidth=1920;</span>
0139 <span class="comment">%</span>
0140 <span class="comment">% % whether forcing to use specific frame rate, if 0, the frame rate wil bw computed in the ImagesShowPTB function.</span>
0141 <span class="comment">% % if non zero, the value is used as the screen frame rate.</span>
0142 <span class="comment">% dparam.force_frame_rate=60;</span>
0143 <span class="comment">%</span>
0144 <span class="comment">% % whther skipping the PTB's vertical-sync signal test. if 1, the sync test is skipped</span>
0145 <span class="comment">% dparam.skip_sync_test=0;</span>
0146 <span class="comment">%</span>
0147 <span class="comment">%</span>
0148 <span class="comment">% [About stimulusfile]</span>
0149 <span class="comment">% The contents of the stimulusfile are as below.</span>
0150 <span class="comment">% (The file includs 6 lines of headers and following stimulus parameters)</span>
0151 <span class="comment">%</span>
0152 <span class="comment">% (an example of the stimulusfile)</span>
0153 <span class="comment">%</span>
0154 <span class="comment">% % ************************************************************</span>
0155 <span class="comment">% % This is the stimulus parameter file for the cmeridian retinotopy stimulus</span>
0156 <span class="comment">% % Programmed by Hiroshi Ban Dec 12 2018</span>
0157 <span class="comment">% % ************************************************************</span>
0158 <span class="comment">%</span>
0159 <span class="comment">% % &quot;sparam&quot; means &quot;stimulus generation parameters&quot;</span>
0160 <span class="comment">%</span>
0161 <span class="comment">% %%% stimulus parameters</span>
0162 <span class="comment">% sparam.nwedges     = 4;     % number of wedge subdivisions along polar angle</span>
0163 <span class="comment">% sparam.nrings      = 4;     % number of ring subdivisions along eccentricity angle</span>
0164 <span class="comment">% sparam.width       = 24;    % wedge width in deg along polar angle</span>
0165 <span class="comment">% sparam.phase       = 0;     % phase shift in deg</span>
0166 <span class="comment">%</span>
0167 <span class="comment">% sparam.maxRad      = 8;     % maximum radius of  annulus (degrees)</span>
0168 <span class="comment">% sparam.minRad      = 0;     % minumum</span>
0169 <span class="comment">%</span>
0170 <span class="comment">% sparam.colors      = [ 128, 128, 128; % number of colors for compensating flickering checkerboard</span>
0171 <span class="comment">%                        255,   0,   0; % the first row is background</span>
0172 <span class="comment">%                          0, 255,   0; % the second to end are patch colors</span>
0173 <span class="comment">%                        255, 255,   0;</span>
0174 <span class="comment">%                          0,   0, 255;</span>
0175 <span class="comment">%                        255,   0, 255;</span>
0176 <span class="comment">%                          0, 255, 255;</span>
0177 <span class="comment">%                        255, 255, 255;</span>
0178 <span class="comment">%                          0,   0,   0;</span>
0179 <span class="comment">%                        255, 128,   0;</span>
0180 <span class="comment">%                        128,   0, 255;];</span>
0181 <span class="comment">%</span>
0182 <span class="comment">% %%% duration in msec for each cycle &amp; repetitions</span>
0183 <span class="comment">% % Here, the stimulus presentation protocol is defined as below.</span>
0184 <span class="comment">% % initial_fixation_time(1) ---&gt; block_duration-rest_duration (the wedge along the horizontal visual meridian) ---&gt; rest_duration (blank) ---&gt;</span>
0185 <span class="comment">% %   block_duration-rest_duration (the wedge along the vertical) ---&gt; rest_duration (blank) ---&gt; block_duration-rest_duration (the wedge along the horizontal) ---&gt;</span>
0186 <span class="comment">% %     rest_duration (blank) ---&gt; block_duration-rest_duration (the wedge along the vertical) ---&gt; ... (repeated numRepeats in total) ---&gt; initial_fixation_time(2)</span>
0187 <span class="comment">% % Therefore, one_stimulation_cycle = block_duration x 2 (note: in this period, stimulation = block_duration-rest_duration)</span>
0188 <span class="comment">%</span>
0189 <span class="comment">% sparam.block_duration=16000; % msec</span>
0190 <span class="comment">% sparam.rest_duration =0; % msec, rest after each block</span>
0191 <span class="comment">% sparam.numRepeats=6;</span>
0192 <span class="comment">%</span>
0193 <span class="comment">% %%% set number of frames to flip the screen</span>
0194 <span class="comment">% % Here, I set the number as large as I can to minimize vertical cynching error.</span>
0195 <span class="comment">% % the final 2 is for 2 times repetitions of the flicker</span>
0196 <span class="comment">% % Set 1 if you want to flip the display at each vertical sync, but not recommended as it uses much CPU power</span>
0197 <span class="comment">% sparam.waitframes = 60*(sparam.block_duration/1000) / ((sparam.block_duration-sparam.rest_duration)/1000) / ( (size(sparam.colors,1)-1)*2 );</span>
0198 <span class="comment">%</span>
0199 <span class="comment">% %%% fixation period in msec before/after presenting the target stimuli, integer</span>
0200 <span class="comment">% % must set a value more than 1 TR for initializing the frame counting.</span>
0201 <span class="comment">% sparam.initial_fixation_time=[4000,4000];</span>
0202 <span class="comment">%</span>
0203 <span class="comment">% %%% fixation size &amp; color</span>
0204 <span class="comment">% sparam.fixtype=1; % 1: circular, 2: rectangular, 3: concentric fixation point</span>
0205 <span class="comment">% sparam.fixsize=12; % radius in pixels</span>
0206 <span class="comment">% sparam.fixcolor=[255,255,255];</span>
0207 <span class="comment">%</span>
0208 <span class="comment">% %%% background color</span>
0209 <span class="comment">% sparam.bgcolor=sparam.colors(1,:); %[0,0,0];</span>
0210 <span class="comment">%</span>
0211 <span class="comment">% %%% background-patch colors (RGB)</span>
0212 <span class="comment">% sparam.bgtype=1; % 1: a simple background with sparam.bgcolor (then, the parameters belows are not used), 2: a background with grid guides</span>
0213 <span class="comment">% sparam.patch_size=[30,30]; % background patch size, [height,width] in pixels</span>
0214 <span class="comment">% sparam.patch_num=[20,40];  % the number of background patches along vertical and horizontal axis</span>
0215 <span class="comment">% sparam.patch_color1=[255,255,255];</span>
0216 <span class="comment">% sparam.patch_color2=[0,0,0];</span>
0217 <span class="comment">%</span>
0218 <span class="comment">% %%% for converting degree to pixels</span>
0219 <span class="comment">% run(fullfile(fileparts(mfilename('fullpath')),'sizeparams'));</span>
0220 <span class="comment">% %sparam.pix_per_cm=57.1429;</span>
0221 <span class="comment">% %sparam.vdist=65;</span>
0222 <span class="comment">%</span>
0223 <span class="comment">%</span>
0224 <span class="comment">% [HOWTO create stimulus files]</span>
0225 <span class="comment">% 1. All of the stimuli are created in this script in real-time</span>
0226 <span class="comment">%    with MATLAB scripts &amp; functions.</span>
0227 <span class="comment">%    see ../Generation &amp; ../Common directries.</span>
0228 <span class="comment">% 2. Stimulus parameters are defined in the display &amp; stimulus file.</span>
0229 <span class="comment">%</span>
0230 <span class="comment">%</span>
0231 <span class="comment">% [reference]</span>
0232 <span class="comment">% for stmulus generation, see ../Generation &amp; ../Common directories.</span>
0233 
0234 
0235 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0236 <span class="comment">%%%% Check the input variables</span>
0237 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0238 
0239 clear <span class="keyword">global</span>; clear mex;
0240 <span class="keyword">if</span> nargin&lt;3, help(mfilename()); <span class="keyword">return</span>; <span class="keyword">end</span>
0241 <span class="keyword">if</span> nargin&lt;4 || isempty(displayfile), displayfile=[]; <span class="keyword">end</span>
0242 <span class="keyword">if</span> nargin&lt;5 || isempty(stimulusfile), stimulusfile=[]; <span class="keyword">end</span>
0243 <span class="keyword">if</span> nargin&lt;6 || isempty(gamma_table), gamma_table=[]; <span class="keyword">end</span>
0244 <span class="keyword">if</span> nargin&lt;7 || isempty(overwrite_flg), overwrite_flg=1; <span class="keyword">end</span>
0245 <span class="keyword">if</span> nargin&lt;8 || isempty(force_proceed_flag), force_proceed_flag=0; <span class="keyword">end</span>
0246 
0247 <span class="comment">% check the aqcuisition number</span>
0248 <span class="keyword">if</span> acq&lt;1, error(<span class="string">'Acquistion number must be integer and greater than zero'</span>); <span class="keyword">end</span>
0249 
0250 <span class="comment">% check the experiment mode (stimulus type)</span>
0251 <span class="keyword">if</span> ~strcmpi(exp_mode,<span class="string">'meridian'</span>), error(<span class="string">'exp_mode acceptable in this script is only &quot;meridian&quot;. check the input variable.'</span>); <span class="keyword">end</span>
0252 
0253 rootDir=fileparts(mfilename(<span class="string">'fullpath'</span>));
0254 
0255 <span class="comment">% check the subject directory</span>
0256 <span class="keyword">if</span> ~exist(fullfile(rootDir,<span class="string">'subjects'</span>,subjID),<span class="string">'dir'</span>), error(<span class="string">'can not find subj directory. check the input variable.'</span>); <span class="keyword">end</span>
0257 
0258 <span class="comment">% check the display/stimulus files</span>
0259 <span class="keyword">if</span> ~isempty(displayfile)
0260   <span class="keyword">if</span> ~strcmpi(displayfile(end-1:end),<span class="string">'.m'</span>), displayfile=[displayfile,<span class="string">'.m'</span>]; <span class="keyword">end</span>
0261   <span class="keyword">if</span> ~exist(fullfile(rootDir,<span class="string">'subjects'</span>,subjID,displayfile),<span class="string">'file'</span>), error(<span class="string">'displayfile not found. check the input variable.'</span>); <span class="keyword">end</span>
0262 <span class="keyword">end</span>
0263 
0264 <span class="keyword">if</span> ~isempty(stimulusfile)
0265   <span class="keyword">if</span> ~strcmpi(stimulusfile(end-1:end),<span class="string">'.m'</span>), stimulusfile=[stimulusfile,<span class="string">'.m'</span>]; <span class="keyword">end</span>
0266   <span class="keyword">if</span> ~exist(fullfile(rootDir,<span class="string">'subjects'</span>,subjID,stimulusfile),<span class="string">'file'</span>), error(<span class="string">'stimulusfile not found. check the input variable.'</span>); <span class="keyword">end</span>
0267 <span class="keyword">end</span>
0268 
0269 
0270 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0271 <span class="comment">%%%% Add path to the subfunctions</span>
0272 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0273 
0274 <span class="comment">% add paths to the subfunctions</span>
0275 addpath(genpath(fullfile(rootDir,<span class="string">'..'</span>,<span class="string">'Common'</span>)));
0276 addpath(fullfile(rootDir,<span class="string">'..'</span>,<span class="string">'Generation'</span>));
0277 
0278 
0279 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0280 <span class="comment">%%%% For log file</span>
0281 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0282 
0283 <span class="comment">% get date</span>
0284 today=datestr(now,<span class="string">'yymmdd'</span>);
0285 
0286 <span class="comment">% result directry &amp; file</span>
0287 resultDir=fullfile(rootDir,<span class="string">'subjects'</span>,num2str(subjID),<span class="string">'results'</span>,today);
0288 <span class="keyword">if</span> ~exist(resultDir,<span class="string">'dir'</span>), mkdir(resultDir); <span class="keyword">end</span>
0289 
0290 <span class="comment">% record the output window</span>
0291 logfname=fullfile(resultDir,[num2str(subjID),<span class="string">'_cmeridian_fixtask_results_run_'</span>,num2str(acq,<span class="string">'%02d'</span>),<span class="string">'.log'</span>]);
0292 diary(logfname);
0293 warning off; <span class="comment">%#ok warning('off','MATLAB:dispatcher:InexactCaseMatch');</span>
0294 
0295 
0296 <span class="comment">%%%%% try &amp; catch %%%%%</span>
0297 <span class="keyword">try</span>
0298 
0299 
0300 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0301 <span class="comment">%%%% Check the PTB version</span>
0302 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0303 
0304 PTB_OK=<a href="../../Retinotopy/Common/CheckPTBversion.html" class="code" title="function [PTB_OK,vertxt] = CheckPTBversion(num_mainver_youwant)">CheckPTBversion</a>(3); <span class="comment">% check wether the PTB version is 3</span>
0305 <span class="keyword">if</span> ~PTB_OK, error(<span class="string">'Wrong version of Psychtoolbox is running. %s requires PTB ver.3'</span>,mfilename()); <span class="keyword">end</span>
0306 
0307 <span class="comment">% debug level, black screen during calibration</span>
0308 Screen(<span class="string">'Preference'</span>, <span class="string">'VisualDebuglevel'</span>, 3);
0309 
0310 
0311 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0312 <span class="comment">%%%% Setup random seed</span>
0313 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0314 
0315 <a href="../../Retinotopy/Common/InitializeRandomSeed.html" class="code" title="function cseed=InitializeRandomSeed">InitializeRandomSeed</a>();
0316 
0317 
0318 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0319 <span class="comment">%%%% Reset display Gamma-function</span>
0320 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0321 
0322 <span class="keyword">if</span> isempty(gamma_table)
0323   gamma_table=repmat(linspace(0.0,1.0,256),3,1); <span class="comment">%#ok</span>
0324   <a href="../../Retinotopy/Common/GammaResetPTB.html" class="code" title="function GammaResetPTB(luminance_ratio)">GammaResetPTB</a>(1.0);
0325 <span class="keyword">else</span>
0326   <a href="../../Retinotopy/Common/GammaLoadPTB.html" class="code" title="function GammaLoadPTB(gamma_table)">GammaLoadPTB</a>(gamma_table);
0327 <span class="keyword">end</span>
0328 
0329 
0330 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0331 <span class="comment">%%%% Validate dparam (displayfile) and sparam (stimulusfile) structures</span>
0332 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0333 
0334 <span class="comment">% organize dparam</span>
0335 dparam=struct(); <span class="comment">% initialize</span>
0336 <span class="keyword">if</span> ~isempty(displayfile), run(fullfile(rootDir,<span class="string">'subjects'</span>,subjID,displayfile)); <span class="keyword">end</span> <span class="comment">% load specific dparam parameters configured for each of the participants</span>
0337 dparam=<a href="../../Retinotopy/Common/ValidateStructureFields.html" class="code" title="function structval=ValidateStructureFields(structval,varargin)">ValidateStructureFields</a>(dparam,<span class="keyword">...</span><span class="comment"> % validate fields and set the default values to missing field(s)</span>
0338          <span class="string">'ExpMode'</span>,<span class="string">'mono'</span>,<span class="keyword">...</span>
0339          <span class="string">'scrID'</span>,1,<span class="keyword">...</span>
0340          <span class="string">'start_method'</span>,0,<span class="keyword">...</span>
0341          <span class="string">'custom_trigger'</span>,<span class="string">'t'</span>,<span class="keyword">...</span>
0342          <span class="string">'Key1'</span>,51,<span class="keyword">...</span>
0343          <span class="string">'Key2'</span>,52,<span class="keyword">...</span>
0344          <span class="string">'fullscr'</span>,false,<span class="keyword">...</span>
0345          <span class="string">'ScrHeight'</span>,1200,<span class="keyword">...</span>
0346          <span class="string">'ScrWidth'</span>,1920,<span class="keyword">...</span>
0347          <span class="string">'force_frame_rate'</span>,60,<span class="keyword">...</span>
0348          <span class="string">'skip_sync_test'</span>,0);
0349 
0350 <span class="comment">% organize sparam</span>
0351 sparam=struct(); <span class="comment">% initialize</span>
0352 sparam.mode=exp_mode;
0353 <span class="keyword">if</span> ~isempty(stimulusfile), run(fullfile(rootDir,<span class="string">'subjects'</span>,subjID,stimulusfile)); <span class="keyword">end</span> <span class="comment">% load specific sparam parameters configured for each of the participants</span>
0354 sparam=<a href="../../Retinotopy/Common/ValidateStructureFields.html" class="code" title="function structval=ValidateStructureFields(structval,varargin)">ValidateStructureFields</a>(sparam,<span class="keyword">...</span><span class="comment"> % validate fields and set the default values to missing field(s)</span>
0355          <span class="string">'nwedges'</span>,4,<span class="keyword">...</span>
0356          <span class="string">'nrings'</span>,4,<span class="keyword">...</span>
0357          <span class="string">'width'</span>,48,<span class="keyword">...</span>
0358          <span class="string">'phase'</span>,0,<span class="keyword">...</span>
0359          <span class="string">'maxRad'</span>,8,<span class="keyword">...</span>
0360          <span class="string">'minRad'</span>,0,<span class="keyword">...</span>
0361          <span class="string">'colors'</span>,[ 128, 128, 128;
0362                     255,   0,   0;
0363                       0, 255,   0;
0364                     255, 255,   0;
0365                       0,   0, 255;
0366                     255,   0, 255;
0367                       0, 255, 255;
0368                     255, 255, 255;
0369                       0,   0,   0;
0370                     255, 128,   0;
0371                     128,   0, 255],<span class="keyword">...</span>
0372          <span class="string">'block_duration'</span>,16000,<span class="keyword">...</span>
0373          <span class="string">'rest_duration'</span>,0,<span class="keyword">...</span>
0374          <span class="string">'numRepeats'</span>,6,<span class="keyword">...</span>
0375          <span class="string">'waitframes'</span>,6,<span class="keyword">...</span><span class="comment"> % Screen('FrameRate',0)*(sparam.block_duration/1000) / ((sparam.block_duration-sparam.rest_duration)/1000) / ( (size(sparam.colors,1)-1)*2 )</span>
0376          <span class="string">'initial_fixation_time'</span>,[4000,4000],<span class="keyword">...</span>
0377          <span class="string">'fixtype'</span>,1,<span class="keyword">...</span>
0378          <span class="string">'fixsize'</span>,12,<span class="keyword">...</span>
0379          <span class="string">'fixcolor'</span>,[255,255,255],<span class="keyword">...</span>
0380          <span class="string">'bgcolor'</span>,[128,128,128],<span class="keyword">...</span><span class="comment"> % sparam.colors(1,:);</span>
0381          <span class="string">'bgtype'</span>,1,<span class="keyword">...</span>
0382          <span class="string">'patch_size'</span>,[30,30],<span class="keyword">...</span>
0383          <span class="string">'patch_num'</span>,[20,40],<span class="keyword">...</span>
0384          <span class="string">'patch_color1'</span>,[255,255,255],<span class="keyword">...</span>
0385          <span class="string">'patch_color2'</span>,[0,0,0],<span class="keyword">...</span>
0386          <span class="string">'pix_per_cm'</span>,57.1429,<span class="keyword">...</span>
0387          <span class="string">'vdist'</span>,65);
0388 
0389 <span class="comment">% change unit from msec to sec.</span>
0390 sparam.initial_fixation_time=sparam.initial_fixation_time./1000; <span class="comment">%#ok</span>
0391 
0392 <span class="comment">% change unit from msec to sec.</span>
0393 sparam.block_duration = sparam.block_duration./1000;
0394 sparam.rest_duration  = sparam.rest_duration./1000;
0395 
0396 <span class="comment">% set the other parameters</span>
0397 dparam.RunScript = mfilename();
0398 sparam.RunScript = mfilename();
0399 
0400 
0401 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0402 <span class="comment">%%%% Displaying the presentation parameters you set</span>
0403 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0404 
0405 fprintf(<span class="string">'The Presentation Parameters are as below.\n\n'</span>);
0406 fprintf(<span class="string">'************************************************\n'</span>);
0407 fprintf(<span class="string">'****** Script, Subject, Acquistion Number ******\n'</span>);
0408 fprintf(<span class="string">'Date &amp; Time            : %s\n'</span>,strcat([datestr(now,<span class="string">'yymmdd'</span>),<span class="string">' '</span>,datestr(now,<span class="string">'HH:mm:ss'</span>)]));
0409 fprintf(<span class="string">'Running Script Name    : %s\n'</span>,mfilename());
0410 fprintf(<span class="string">'Subject ID             : %s\n'</span>,subjID);
0411 fprintf(<span class="string">'Acquisition Number     : %d\n'</span>,acq);
0412 fprintf(<span class="string">'********* Run Type, Display Image Type *********\n'</span>);
0413 fprintf(<span class="string">'Display Mode           : %s\n'</span>,dparam.ExpMode);
0414 fprintf(<span class="string">'use Full Screen Mode   : %d\n'</span>,dparam.fullscr);
0415 fprintf(<span class="string">'Start Method           : %d\n'</span>,dparam.start_method);
0416 <span class="keyword">if</span> dparam.start_method==4
0417   fprintf(<span class="string">'Custom Trigger         : %d\n'</span>,dparam.custom_trigger);
0418 <span class="keyword">end</span>
0419 fprintf(<span class="string">'*************** Screen Settings ****************\n'</span>);
0420 fprintf(<span class="string">'Screen Height          : %d\n'</span>,dparam.ScrHeight);
0421 fprintf(<span class="string">'Screen Width           : %d\n'</span>,dparam.ScrWidth);
0422 fprintf(<span class="string">'*********** Stimulation Periods etc. ***********\n'</span>);
0423 fprintf(<span class="string">'Fixation Time(sec)     : %d &amp; %d\n'</span>,sparam.initial_fixation_time(1),sparam.initial_fixation_time(2));
0424 fprintf(<span class="string">'Cycle Duration(sec)    : %d\n'</span>,2*sparam.block_duration);
0425 fprintf(<span class="string">'Block Duration(sec)    : %d x 2 (H/V)\n'</span>,sparam.block_duration-sparam.rest_duration);
0426 fprintf(<span class="string">'Rest  Duration(sec)    : %d\n'</span>,sparam.rest_duration);
0427 fprintf(<span class="string">'Repetitions(cycles)    : %d\n'</span>,sparam.numRepeats);
0428 fprintf(<span class="string">'Frame Flip(per VerSync): %d\n'</span>,sparam.waitframes);
0429 fprintf(<span class="string">'Total Time (sec)       : %d\n'</span>,sum(sparam.initial_fixation_time)+sparam.numRepeats*2*sparam.block_duration);
0430 fprintf(<span class="string">'**************** Stimulus Type ****************\n'</span>);
0431 fprintf(<span class="string">'Experiment Mode        : %s\n'</span>,sparam.mode);
0432 fprintf(<span class="string">'************ Response key settings *************\n'</span>);
0433 fprintf(<span class="string">'Reponse Key #1         : %d = %s\n'</span>,dparam.Key1,KbName(dparam.Key1));
0434 fprintf(<span class="string">'Reponse Key #2         : %d = %s\n'</span>,dparam.Key2,KbName(dparam.Key2));
0435 fprintf(<span class="string">'************************************************\n\n'</span>);
0436 fprintf(<span class="string">'Please carefully check before proceeding.\n\n'</span>);
0437 
0438 
0439 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0440 <span class="comment">%%%% Initialize response &amp; event logger objects</span>
0441 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0442 
0443 <span class="comment">% initialize MATLAB objects for event and response logs</span>
0444 event=<a href="../../Retinotopy/Common/eventlogger.html" class="code" title="">eventlogger</a>();
0445 resps=<a href="../../Retinotopy/Common/responselogger.html" class="code" title="">responselogger</a>([dparam.Key1,dparam.Key2]);
0446 resps.initialize(event); <span class="comment">% initialize responselogger</span>
0447 
0448 
0449 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0450 <span class="comment">%%%% Wait for user reponse to start</span>
0451 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0452 
0453 <span class="keyword">if</span> ~force_proceed_flag
0454   [user_answer,resps]=resps.wait_to_proceed();
0455   <span class="keyword">if</span> ~user_answer, diary off; <span class="keyword">return</span>; <span class="keyword">end</span>
0456 <span class="keyword">end</span>
0457 
0458 
0459 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0460 <span class="comment">%%%% Initialization of Left &amp; Right screens for binocular presenting/viewing mode</span>
0461 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0462 
0463 <span class="keyword">if</span> dparam.skip_sync_test, Screen(<span class="string">'Preference'</span>,<span class="string">'SkipSyncTests'</span>,1); <span class="keyword">end</span>
0464 
0465 [winPtr,winRect,nScr,dparam.fps,dparam.ifi,initDisplay_OK]=<a href="../../Retinotopy/Common/InitializePTBDisplays.html" class="code" title="function [winPtr,winRect,nScr,fps,ifi,initDisplay_OK]=InitializePTBDisplays(disp_mode,bgcolor,flipping,rgb_gains,custom_scrIDs)">InitializePTBDisplays</a>(dparam.ExpMode,sparam.bgcolor,0,[],dparam.scrID);
0466 <span class="keyword">if</span> ~initDisplay_OK, error(<span class="string">'Display initialization error. Please check your exp_run parameter.'</span>); <span class="keyword">end</span>
0467 HideCursor();
0468 
0469 <span class="keyword">if</span> <a href="../../Retinotopy/Common/isstructmember.html" class="code" title="function isFieldResult = isstructmember(inStruct, fieldName)">isstructmember</a>(dparam,<span class="string">'force_frame_rate'</span>)
0470   <span class="keyword">if</span> dparam.force_frame_rate
0471     dparam.fps=dparam.force_frame_rate;
0472     dparam.ifi=1/dparam.fps;
0473   <span class="keyword">end</span>
0474 <span class="keyword">end</span>
0475 
0476 
0477 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0478 <span class="comment">%%%% Setting the PTB runnning priority to MAX</span>
0479 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0480 
0481 <span class="comment">% set the priority of this script to MAX</span>
0482 priorityLevel=MaxPriority(winPtr,<span class="string">'WaitBlanking'</span>);
0483 Priority(priorityLevel);
0484 
0485 <span class="comment">% conserve VRAM memory: Workaround for flawed hardware and drivers</span>
0486 <span class="comment">% 32 == kPsychDontShareContextRessources: Do not share ressources between</span>
0487 <span class="comment">% different onscreen windows. Usually you want PTB to share all ressources</span>
0488 <span class="comment">% like offscreen windows, textures and GLSL shaders among all open onscreen</span>
0489 <span class="comment">% windows. If that causes trouble for some weird reason, you can prevent</span>
0490 <span class="comment">% automatic sharing with this flag.</span>
0491 <span class="comment">%Screen('Preference','ConserveVRAM',32);</span>
0492 
0493 
0494 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0495 <span class="comment">%%%% Setting the PTB OpenGL functions</span>
0496 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0497 
0498 <span class="comment">% Enable OpenGL mode of Psychtoolbox: This is crucially needed for clut animation</span>
0499 InitializeMatlabOpenGL();
0500 
0501 <span class="comment">% This script calls Psychtoolbox commands available only in OpenGL-based</span>
0502 <span class="comment">% versions of the Psychtoolbox. (So far, the OS X Psychtoolbox is the</span>
0503 <span class="comment">% only OpenGL-base Psychtoolbox.)  The Psychtoolbox command AssertPsychOpenGL will issue</span>
0504 <span class="comment">% an error message if someone tries to execute this script on a computer without</span>
0505 <span class="comment">% an OpenGL Psychtoolbox</span>
0506 AssertOpenGL();
0507 
0508 <span class="comment">% set OpenGL blend functions</span>
0509 Screen(<span class="string">'BlendFunction'</span>, winPtr, GL_SRC_ALPHA, GL_ONE_MINUS_SRC_ALPHA);
0510 
0511 
0512 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0513 <span class="comment">%%%% Initializing MATLAB OpenGL shader API</span>
0514 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0515 
0516 <span class="comment">% just call DrawTextureWithCLUT with window pointer alone</span>
0517 <a href="../../Retinotopy/Common/DrawTextureWithCLUT.html" class="code" title="function DrawTextureWithCLUT(win, src, newclut, srcRect, destRect, rotangle)">DrawTextureWithCLUT</a>(winPtr);
0518 
0519 
0520 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0521 <span class="comment">%%%% Displaying 'Initializing...'</span>
0522 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0523 
0524 <span class="comment">% displaying texts on the center of the screen</span>
0525 <a href="../../Retinotopy/Common/DisplayMessage2.html" class="code" title="function DisplayMessage2(message,bgcolor,winPtr,numScreens,drawing_font,drawing_size)">DisplayMessage2</a>(<span class="string">'Initializing...'</span>,sparam.bgcolor,winPtr,nScr,<span class="string">'Arial'</span>,36);
0526 
0527 
0528 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0529 <span class="comment">%%%% Initializing variables</span>
0530 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0531 
0532 <span class="comment">%% unit conversion</span>
0533 
0534 <span class="comment">% cm per pix</span>
0535 sparam.cm_per_pix=1/sparam.pix_per_cm;
0536 
0537 <span class="comment">% pixles per degree</span>
0538 sparam.pix_per_deg=round( 1/( 180*atan(sparam.cm_per_pix/sparam.vdist)/pi ) );
0539 
0540 <span class="comment">% deg to radian</span>
0541 <span class="comment">% do not convert!</span>
0542 <span class="comment">% sparam.width, sparam.phase, sparam.startangle, sparam.rotangle are used in deg formats</span>
0543 
0544 <span class="comment">% number of checkerboard color</span>
0545 sparam.ncolors=(size(sparam.colors,1)-1)/2;
0546 
0547 <span class="comment">% sec to number of frames</span>
0548 nframe_fixation=round(sparam.initial_fixation_time.*dparam.fps./sparam.waitframes);
0549 nframe_stim=round((sparam.block_duration-sparam.rest_duration)*dparam.fps/sparam.waitframes);
0550 nframe_rest=round(sparam.rest_duration*dparam.fps/sparam.waitframes);
0551 
0552 <span class="comment">% !!!NOTICE!!!</span>
0553 <span class="comment">% Two lines below are from cretinotopy.m</span>
0554 <span class="comment">% nframe_rotation=round((sparam.cycle_duration-sparam.rest_duration)*dparam.fps/(360/sparam.rotangle)/sparam.waitframes);</span>
0555 <span class="comment">% nframe_flicker=round(nframe_rotation/sparam.ncolors/4);</span>
0556 <span class="comment">% nframe_flicker should be adjusted to match with these parameters.</span>
0557 nframe_flicker=round(round((60-0)*dparam.fps/(360/12)/sparam.waitframes)/sparam.ncolors/4); <span class="comment">%60,0,30 are from CCW/CW parameters.</span>
0558 
0559 nframe_task=round(18/sparam.waitframes); <span class="comment">% just arbitral, you can change as you like</span>
0560 
0561 <span class="comment">%% initialize chackerboard parameters</span>
0562 
0563 <span class="comment">% adjust size ratio considering full-screen effect</span>
0564 <span class="keyword">if</span> dparam.fullscr
0565   <span class="comment">% here, use width information alone, assuming that the pixel is square</span>
0566   ratio_wid=( winRect(3)-winRect(1) )/dparam.ScrWidth;
0567   <span class="comment">%ratio_hei=( winRect(4)-winRect(2) )/dparam.ScrHeight;</span>
0568 
0569   <span class="comment">% min/max radius of annulus</span>
0570   rmin=sparam.minRad*ratio_wid; <span class="comment">% !!! degree, not pixel or cm !!!</span>
0571   rmax=sparam.maxRad*ratio_wid;
0572 <span class="keyword">else</span>
0573   rmin=sparam.minRad;
0574   rmax=sparam.maxRad;
0575 <span class="keyword">end</span>
0576 
0577 
0578 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0579 <span class="comment">%%%% Generating checkerboard patterns</span>
0580 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0581 
0582 <span class="comment">% [note]</span>
0583 <span class="comment">% After this processing, each checkerboard image has checker elements with values as shown below</span>
0584 <span class="comment">% 0 = background</span>
0585 <span class="comment">% 1 = checker ID 1</span>
0586 <span class="comment">% 2 = checker ID 2</span>
0587 <span class="comment">% 3 = checker ID 3</span>
0588 <span class="comment">% .....</span>
0589 <span class="comment">% sparam.npatches = checker ID</span>
0590 <span class="comment">% Each patch ID will be associated with a CLUT color of the same ID</span>
0591 
0592 <span class="comment">% generate a dual wedge checkerboard pattern</span>
0593 sparam.startangles=[0-sparam.width/2,0-sparam.width/2+90];
0594 [checkerboardID,checkerboard]=<a href="../../Retinotopy/Generation/pol_GenerateCheckerBoard1D.html" class="code" title="function [checkerboard,bincheckerboard,mask]=pol_GenerateCheckerBoard1D(rmin,rmax,width,startangle,pix_per_deg,nwedges,nrings,phase,dual_flg)">pol_GenerateCheckerBoard1D</a>(rmin,rmax,sparam.width,sparam.startangles,sparam.pix_per_deg,<span class="keyword">...</span>
0595                                                          sparam.nwedges,sparam.nrings,sparam.phase,1);
0596 
0597 <span class="comment">% make the checkerboard texture</span>
0598 checkertexture=cell(numel(sparam.startangles),1);
0599 <span class="keyword">for</span> ii=1:1:numel(sparam.startangles), checkertexture{ii}=Screen(<span class="string">'MakeTexture'</span>,winPtr,checkerboard{ii}); <span class="keyword">end</span>
0600 
0601 
0602 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0603 <span class="comment">%%%% Initializing Color Lookup-Table (CLUT)</span>
0604 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0605 
0606 <span class="comment">% [note]</span>
0607 <span class="comment">% all checker color/luminance flickering is realized by just flipping CLUT generated here</span>
0608 <span class="comment">% to save memory and CPU power</span>
0609 
0610 CLUT=cell(sparam.ncolors,2); <span class="comment">% 2 is for compensating patterns</span>
0611 
0612 <span class="comment">% generate base CLUT</span>
0613 <span class="keyword">for</span> cc=1:1:sparam.ncolors
0614   <span class="keyword">for</span> pp=1:1:2 <span class="comment">% compensating checkers</span>
0615 
0616     <span class="comment">% initialize, DrawTextureWithCLUT requires [256x4] color lookup table even when we do not use whole 256 colors</span>
0617     <span class="comment">% though DrawTextureWithCLUT does not support alpha transparency up to now...</span>
0618     CLUT{cc,pp}=zeros(256,4);
0619     CLUT{cc,pp}(:,4)=1; <span class="comment">% default alpha is 1 (no transparent)</span>
0620 
0621     CLUT{cc,pp}(1,:)=[sparam.colors(1,:),0]; <span class="comment">% background LUT, default alpha is 0 (invisible);</span>
0622 
0623     <span class="keyword">if</span> ~mod(pp,2)
0624       CLUT{cc,pp}(2,1:3)=sparam.colors(2*cc,:);
0625       CLUT{cc,pp}(3,1:3)=sparam.colors(2*cc+1,:);
0626     <span class="keyword">else</span>
0627       CLUT{cc,pp}(2,1:3)=sparam.colors(2*cc+1,:);
0628       CLUT{cc,pp}(3,1:3)=sparam.colors(2*cc,:);
0629     <span class="keyword">end</span>
0630 
0631   <span class="keyword">end</span> <span class="comment">% for pp=1:1:2 % compensating checkers</span>
0632 <span class="keyword">end</span> <span class="comment">% for cc=1:1:sparam.ncolors</span>
0633 
0634 
0635 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0636 <span class="comment">%%%% Debug codes</span>
0637 <span class="comment">%%%% saving the stimulus images as *.png format files and enter the debug (keyboard) mode</span>
0638 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0639 
0640 <span class="comment">% %%%%%% DEBUG codes start here</span>
0641 <span class="comment">% note: debug stimuli have no jitters of binocular disparity</span>
0642 <span class="keyword">if</span> strfind(upper(subjID),<span class="string">'DEBUG'</span>)
0643 
0644   <span class="comment">% just to get stimulus figures</span>
0645   Screen(<span class="string">'CloseAll'</span>);
0646   save_dir=fullfile(resultDir,<span class="string">'images_cmeridian_fixtask'</span>);
0647   <span class="keyword">if</span> ~exist(save_dir,<span class="string">'dir'</span>), mkdir(save_dir); <span class="keyword">end</span>
0648 
0649   figure; hold off;
0650   <span class="keyword">for</span> nn=1:1:numel(sparam.startangles)
0651     imagesc(checkerboard{nn}+1,[1,numel(unique(checkerboard{nn}))]);
0652     axis off; axis equal;
0653 
0654     <span class="keyword">for</span> cc=1:1:sparam.ncolors
0655       <span class="keyword">for</span> pp=1:1:2 <span class="comment">% compensating checkers</span>
0656         colormap(CLUT{cc,pp}(1:3,1:3)./255);
0657         drawnow;
0658         pause(0.05);
0659         imwrite(checkerboard{nn}+1,CLUT{cc,pp}(1:3,1:3)./255,fullfile(save_dir,sprintf(<span class="string">'checkerboard_%s_pos_%02d_lut_%02d_%02d.png'</span>,sparam.mode,nn,cc,pp)),<span class="string">'png'</span>); <span class="comment">% +1 is required as the image index is assumed to be started from 1.</span>
0660       <span class="keyword">end</span>
0661     <span class="keyword">end</span>
0662 
0663   <span class="keyword">end</span>
0664   close all;
0665   save(fullfile(save_dir,sprintf(<span class="string">'stimulus_%s.mat'</span>,sparam.mode)),<span class="string">'checkerboard'</span>,<span class="string">'sparam'</span>,<span class="string">'dparam'</span>,<span class="string">'CLUT'</span>);
0666   keyboard;
0667 
0668 <span class="keyword">end</span> <span class="comment">% if strfind(upper(subjID),'DEBUG')</span>
0669 <span class="comment">% %%%%%% DEBUG code ends here</span>
0670 
0671 
0672 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0673 <span class="comment">%%%% Generating fixation detection task parameters</span>
0674 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0675 
0676 <span class="comment">%% set task variables</span>
0677 <span class="comment">% flag to decide whether presenting fixation task</span>
0678 totalframes=max(sum(nframe_fixation),1)+2*(nframe_stim+nframe_rest)*sparam.numRepeats;
0679 num_tasks=ceil(totalframes/nframe_task);
0680 task_flg=ones(1,num_tasks);
0681 <span class="keyword">for</span> nn=2:1:num_tasks
0682   <span class="keyword">if</span> task_flg(nn-1)==2
0683     task_flg(nn)=1;
0684   <span class="keyword">else</span>
0685     <span class="keyword">if</span> mod(randi(4,1),4)==0 <span class="comment">% this is arbitral, but I put these lines just to reduce the number of tasks</span>
0686       task_flg(nn)=round(rand(1,1))+1;
0687     <span class="keyword">else</span>
0688       task_flg(nn)=1;
0689     <span class="keyword">end</span>
0690   <span class="keyword">end</span>
0691 <span class="keyword">end</span>
0692 task_flg=repmat(task_flg,nframe_task,1);
0693 task_flg=task_flg(:);
0694 
0695 
0696 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0697 <span class="comment">%%%% Initializing checkerboard color management parameters</span>
0698 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0699 
0700 <span class="comment">% checkerboard color id</span>
0701 color_id=1;
0702 
0703 <span class="comment">% checkerboard compensating color id</span>
0704 compensate_id=1;
0705 
0706 
0707 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0708 <span class="comment">%%%% Creating background images</span>
0709 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0710 
0711 <span class="keyword">if</span> sparam.bgtype==1 <span class="comment">% a simple background with sparam.bgcolor</span>
0712   bgimg{1}=repmat(reshape(sparam.colors(1,:),[1,1,3]),[dparam.ScrHeight,dparam.ScrWidth]);
0713 
0714 <span class="keyword">elseif</span> sparam.bgtype==2 <span class="comment">% a background with grid guides</span>
0715 
0716   <span class="comment">% calculate the central aperture size of the background image</span>
0717   edgeY=mod(dparam.ScrHeight,sparam.patch_num(1)); <span class="comment">% delete the exceeded region</span>
0718   p_height=round((dparam.ScrHeight-edgeY)/sparam.patch_num(1)); <span class="comment">% height in pix of patch_height + interval-Y</span>
0719 
0720   edgeX=mod(dparam.ScrWidth,sparam.patch_num(2)); <span class="comment">% delete exceeded region</span>
0721   p_width=round((dparam.ScrWidth-edgeX)/sparam.patch_num(2)); <span class="comment">% width in pix of patch_width + interval-X</span>
0722 
0723   <span class="keyword">if</span> dparam.fullscr
0724     aperture_size=[2*( p_height*ceil( size(checkerboard{1},1)/2*( (winRect(4)-winRect(2))/dparam.ScrHeight ) /p_height ) ),<span class="keyword">...</span>
0725                    2*( p_width*ceil( size(checkerboard{1},2)/2*( (winRect(3)-winRect(1))/dparam.ScrWidth ) /p_width ) )];
0726   <span class="keyword">else</span>
0727     aperture_size=[2*( p_height*ceil(size(checkerboard{1},1)/2/p_height) ),<span class="keyword">...</span>
0728                    2*( p_width*ceil(size(checkerboard{1},2)/2/p_width) )];
0729   <span class="keyword">end</span>
0730 
0731   bgimg=<a href="../../Retinotopy/Common/CreateBackgroundImage.html" class="code" title="function [Bimg,parameters] = CreateBackgroundImage(wdims,stdims,pdims,bgcolor,color1,color2,fixcolor,patchnum,fix_flag,save_flag,show_flag)">CreateBackgroundImage</a>([dparam.ScrHeight,dparam.ScrWidth],aperture_size,sparam.patch_size,sparam.bgcolor,sparam.patch_color1,sparam.patch_color2,sparam.fixcolor,sparam.patch_num,0,0,0);
0732 <span class="keyword">else</span>
0733   error(<span class="string">'sparam.bgtype should be 1 or 2. check the input variable.'</span>);
0734 <span class="keyword">end</span>
0735 
0736 background=Screen(<span class="string">'MakeTexture'</span>,winPtr,bgimg{1});
0737 
0738 
0739 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0740 <span class="comment">%%%% Creating the central fixation, cross images</span>
0741 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0742 
0743 <span class="comment">% Create fixation cross images.</span>
0744 <span class="comment">% Firstly larger fixations are generated, then they are antialiased. This is required to present a beautiful circle</span>
0745 
0746 <span class="keyword">if</span> sparam.fixtype==1 <span class="comment">% circular fixation</span>
0747   fixW=<a href="../../Retinotopy/Common/CreateFixationImgCircular.html" class="code" title="function fix=CreateFixationImgCircular(fixsize,fixcolor,bgcolor,circlesize,show_flag,save_flag)">CreateFixationImgCircular</a>(4*sparam.fixsize,sparam.fixcolor,sparam.bgcolor,4*sparam.fixsize,0,0);
0748   fixD=<a href="../../Retinotopy/Common/CreateFixationImgCircular.html" class="code" title="function fix=CreateFixationImgCircular(fixsize,fixcolor,bgcolor,circlesize,show_flag,save_flag)">CreateFixationImgCircular</a>(4*sparam.fixsize,[64,64,64],sparam.bgcolor,4*sparam.fixsize,0,0);
0749 <span class="keyword">elseif</span> sparam.fixtype==2 <span class="comment">% rectangular fixation</span>
0750   fixW=<a href="../../Retinotopy/Common/CreateFixationImgMono.html" class="code" title="function fix=CreateFixationImgMono(fixsize,fixcolor,bgcolor,fixlinew,fixlineh,show_flag,save_flag)">CreateFixationImgMono</a>(4*sparam.fixsize,sparam.fixcolor,sparam.bgcolor,4*2,4*ceil(0.4*sparam.fixsize),0,0);
0751   fixD=<a href="../../Retinotopy/Common/CreateFixationImgMono.html" class="code" title="function fix=CreateFixationImgMono(fixsize,fixcolor,bgcolor,fixlinew,fixlineh,show_flag,save_flag)">CreateFixationImgMono</a>(4*sparam.fixsize,[64,64,64],sparam.bgcolor,4*2,4*ceil(0.4*sparam.fixsize),0,0);
0752 <span class="keyword">elseif</span> sparam.fixtype==3 <span class="comment">% concentric fixation</span>
0753   fixW=<a href="../../Retinotopy/Common/CreateFixationImgConcentrateMono.html" class="code" title="function fix=CreateFixationImgConcentrateMono(fixsize,fixcolor,bgcolor,circlesize,gap,show_flag,save_flag)">CreateFixationImgConcentrateMono</a>(4*sparam.fixsize,sparam.fixcolor,sparam.bgcolor,4*[2,ceil(0.8*sparam.fixsize)],0,0,0);
0754   fixD=<a href="../../Retinotopy/Common/CreateFixationImgConcentrateMono.html" class="code" title="function fix=CreateFixationImgConcentrateMono(fixsize,fixcolor,bgcolor,circlesize,gap,show_flag,save_flag)">CreateFixationImgConcentrateMono</a>(4*sparam.fixsize,[64,64,64],sparam.bgcolor,4*[2,ceil(0.8*sparam.fixsize)],0,0,0);
0755 <span class="keyword">else</span>
0756   error(<span class="string">'sparam.fixtype should be one of 1,2, and 3. check the input variable.'</span>);
0757 <span class="keyword">end</span>
0758 fixW=imresize(fixW,0.25);
0759 fixD=imresize(fixD,0.25);
0760 
0761 fix=cell(2,1); <span class="comment">% 1 is for default fixation, 2 is for darker fixation (luminance detection task)</span>
0762 fix{1}=Screen(<span class="string">'MakeTexture'</span>,winPtr,fixW);
0763 fix{2}=Screen(<span class="string">'MakeTexture'</span>,winPtr,fixD);
0764 
0765 
0766 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0767 <span class="comment">%%%% Prepare blue lines for stereo image flip sync with VPixx PROPixx</span>
0768 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0769 
0770 <span class="comment">% There seems to be a blueline generation bug on some OpenGL systems.</span>
0771 <span class="comment">% SetStereoBlueLineSyncParameters(winPtr, winRect(4)) corrects the</span>
0772 <span class="comment">% bug on some systems, but breaks on other systems.</span>
0773 <span class="comment">% We'll just disable automatic blueline, and manually draw our own bluelines!</span>
0774 
0775 <span class="keyword">if</span> strcmpi(dparam.ExpMode,<span class="string">'propixxstereo'</span>)
0776   SetStereoBlueLineSyncParameters(winPtr, winRect(4)+10);
0777   blueRectOn(1,:)=[0, winRect(4)-1, winRect(3)/4, winRect(4)];
0778   blueRectOn(2,:)=[0, winRect(4)-1, winRect(3)*3/4, winRect(4)];
0779   blueRectOff(1,:)=[winRect(3)/4, winRect(4)-1, winRect(3), winRect(4)];
0780   blueRectOff(2,:)=[winRect(3)*3/4, winRect(4)-1, winRect(3), winRect(4)];
0781 <span class="keyword">end</span>
0782 
0783 
0784 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0785 <span class="comment">%%%% Image size adjusting to match the current display resolutions</span>
0786 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0787 
0788 <span class="keyword">if</span> dparam.fullscr
0789   ratio_wid= ( winRect(3)-winRect(1) )/dparam.ScrWidth;
0790   ratio_hei= ( winRect(4)-winRect(2) )/dparam.ScrHeight;
0791   bgSize   = [size(bgimg{1},2)*ratio_wid, size(bgimg{1},1)*ratio_hei];
0792   stimSize = [size(checkerboard{1},2)*ratio_wid, size(checkerboard{1},1)*ratio_hei];
0793   fixSize  = [2*sparam.fixsize*ratio_wid, 2*sparam.fixsize*ratio_hei];
0794 <span class="keyword">else</span>
0795   bgSize   = [dparam.ScrWidth, dparam.ScrHeight];
0796   stimSize = [size(checkerboard{1},2), size(checkerboard{1},1)];
0797   fixSize  = [2*sparam.fixsize, 2*sparam.fixsize];
0798 <span class="keyword">end</span>
0799 
0800 <span class="comment">% for some display modes in which one screen is splitted into two binocular displays</span>
0801 <span class="keyword">if</span> strcmpi(dparam.ExpMode,<span class="string">'cross'</span>) || strcmpi(dparam.ExpMode,<span class="string">'parallel'</span>) || <span class="keyword">...</span>
0802    strcmpi(dparam.ExpMode,<span class="string">'topbottom'</span>) || strcmpi(dparam.ExpMode,<span class="string">'bottomtop'</span>)
0803   bgSize=bgSize./2;
0804   stimSize=stimSize./2;
0805   fixSize=fixSize./2;
0806 <span class="keyword">end</span>
0807 
0808 bgRect  = [0, 0, bgSize]; <span class="comment">% used to display background images;</span>
0809 stimRect= [0, 0, stimSize];
0810 fixRect = [0, 0, fixSize]; <span class="comment">% used to display the central fixation point</span>
0811 
0812 
0813 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0814 <span class="comment">%%%% Initialize functions and variables for trial loop</span>
0815 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0816 
0817 <span class="comment">% initialize variables that we will use during the experiment (faster)</span>
0818 cur_frames=0;
0819 
0820 
0821 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0822 <span class="comment">%%%% Displaying 'Ready to Start'</span>
0823 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0824 
0825 <span class="comment">% displaying texts on the center of the screen</span>
0826 <a href="../../Retinotopy/Common/DisplayMessage2.html" class="code" title="function DisplayMessage2(message,bgcolor,winPtr,numScreens,drawing_font,drawing_size)">DisplayMessage2</a>(<span class="string">'Ready to Start'</span>,sparam.bgcolor,winPtr,nScr,<span class="string">'Arial'</span>,36);
0827 ttime=GetSecs(); <span class="keyword">while</span> (GetSecs()-ttime &lt; 0.5), <span class="keyword">end</span>  <span class="comment">% run up the clock.</span>
0828 
0829 
0830 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0831 <span class="comment">%%%% Flip the display(s) to the background image(s)</span>
0832 <span class="comment">%%%% and inform the ready of stimulus presentation</span>
0833 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0834 
0835 <span class="comment">% change the screen and wait for the trigger or pressing the start button</span>
0836 <span class="keyword">for</span> nn=1:1:nScr
0837   Screen(<span class="string">'SelectStereoDrawBuffer'</span>,winPtr,nn-1);
0838   Screen(<span class="string">'DrawTexture'</span>,winPtr,background,[],CenterRect(bgRect,winRect));
0839   Screen(<span class="string">'DrawTexture'</span>,winPtr,fix{2},[],CenterRect(fixRect,winRect));
0840 
0841   <span class="comment">% blue line for stereo sync</span>
0842   <span class="keyword">if</span> strcmpi(dparam.ExpMode,<span class="string">'propixxstereo'</span>)
0843     Screen(<span class="string">'FillRect'</span>,winPtr,[0,0,255],blueRectOn(nn,:));
0844     Screen(<span class="string">'FillRect'</span>,winPtr,[0,0,0],blueRectOff(nn,:));
0845   <span class="keyword">end</span>
0846 <span class="keyword">end</span>
0847 Screen(<span class="string">'DrawingFinished'</span>,winPtr);
0848 Screen(<span class="string">'Flip'</span>, winPtr,[],[],[],1);
0849 
0850 <span class="comment">% prepare the next frame for the initial fixation period</span>
0851 <span class="keyword">for</span> nn=1:1:nScr
0852   Screen(<span class="string">'SelectStereoDrawBuffer'</span>,winPtr,nn-1);
0853   Screen(<span class="string">'DrawTexture'</span>,winPtr,background,[],CenterRect(bgRect,winRect));
0854   Screen(<span class="string">'DrawTexture'</span>,winPtr,fix{1},[],CenterRect(fixRect,winRect));
0855 
0856   <span class="comment">% blue line for stereo sync</span>
0857   <span class="keyword">if</span> strcmpi(dparam.ExpMode,<span class="string">'propixxstereo'</span>)
0858     Screen(<span class="string">'FillRect'</span>,winPtr,[0,0,255],blueRectOn(nn,:));
0859     Screen(<span class="string">'FillRect'</span>,winPtr,[0,0,0],blueRectOff(nn,:));
0860   <span class="keyword">end</span>
0861 <span class="keyword">end</span>
0862 Screen(<span class="string">'DrawingFinished'</span>,winPtr);
0863 
0864 
0865 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0866 <span class="comment">%%%% Wait for the first trigger pulse from fMRI scanner or start with button pressing</span>
0867 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0868 
0869 <span class="comment">% add time stamp (this also works to load add_event method in memory in advance of the actual displays)</span>
0870 fprintf(<span class="string">'\nWaiting for the start...\n'</span>);
0871 event=event.add_event(<span class="string">'Experiment Start'</span>,strcat([datestr(now,<span class="string">'yymmdd'</span>),<span class="string">' '</span>,datestr(now,<span class="string">'HH:mm:ss'</span>)]),NaN);
0872 
0873 <span class="comment">% waiting for stimulus presentation</span>
0874 resps.wait_stimulus_presentation(dparam.start_method,dparam.custom_trigger);
0875 <span class="comment">%PlaySound(1);</span>
0876 fprintf(<span class="string">'\nExperiment running...\n'</span>);
0877 
0878 
0879 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0880 <span class="comment">%%%% Initial Fixation Period</span>
0881 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0882 
0883 vbl=Screen(<span class="string">'Flip'</span>,winPtr,[],[],[],1); <span class="comment">% the first flip</span>
0884 [event,the_experiment_start]=event.set_reference_time(vbl);
0885 event=event.add_event(<span class="string">'Initial Fixation'</span>,[]);
0886 fprintf(<span class="string">'\nfixation\n\n'</span>);
0887 cur_frames=cur_frames+1;
0888 
0889 <span class="comment">% wait for the initial fixation</span>
0890 <span class="keyword">for</span> ff=1:1:nframe_fixation(1)
0891   <span class="keyword">for</span> nn=1:1:nScr
0892     Screen(<span class="string">'SelectStereoDrawBuffer'</span>,winPtr,nn-1);
0893     Screen(<span class="string">'DrawTexture'</span>,winPtr,background,[],CenterRect(bgRect,winRect));
0894     Screen(<span class="string">'DrawTexture'</span>,winPtr,fix{task_flg(cur_frames)},[],CenterRect(fixRect,winRect));
0895 
0896     <span class="comment">% blue line for stereo sync</span>
0897     <span class="keyword">if</span> strcmpi(dparam.ExpMode,<span class="string">'propixxstereo'</span>)
0898       Screen(<span class="string">'FillRect'</span>,winPtr,[0,0,255],blueRectOn(nn,:));
0899       Screen(<span class="string">'FillRect'</span>,winPtr,[0,0,0],blueRectOff(nn,:));
0900     <span class="keyword">end</span>
0901   <span class="keyword">end</span>
0902   Screen(<span class="string">'DrawingFinished'</span>,winPtr);
0903   <span class="keyword">while</span> GetSecs()&lt;vbl+(ff*sparam.waitframes-0.5)*dparam.ifi, [resps,event]=resps.check_responses(event); <span class="keyword">end</span>
0904   Screen(<span class="string">'Flip'</span>,winPtr,[],[],[],1);
0905 
0906   <span class="comment">% update task</span>
0907   cur_frames=cur_frames+1;
0908   <span class="keyword">if</span> task_flg(cur_frames-1)==2 &amp;&amp; task_flg(cur_frames-2)==1, event=event.add_event(<span class="string">'Luminance Task'</span>,[]); <span class="keyword">end</span>
0909 <span class="keyword">end</span>
0910 
0911 
0912 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0913 <span class="comment">%%%% The Trial Loop</span>
0914 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0915 
0916 <span class="keyword">for</span> cc=1:1:sparam.numRepeats
0917 
0918   <span class="comment">%% stimulus presentation loop</span>
0919   <span class="keyword">for</span> pp=1:1:2 <span class="comment">% 2 = horizontal and vertical visual meridians</span>
0920     <span class="keyword">for</span> ff=1:1:nframe_stim+nframe_rest
0921 
0922       <span class="comment">%% display the current frame</span>
0923       <span class="keyword">for</span> nn=1:1:nScr
0924         Screen(<span class="string">'SelectStereoDrawBuffer'</span>,winPtr,nn-1);
0925         Screen(<span class="string">'DrawTexture'</span>,winPtr,background,[],CenterRect(bgRect,winRect)); <span class="comment">% background</span>
0926         <span class="comment">% present the checkerboard along the horizontal (when pp is 1) or vertical (when pp is 2) visual meridian</span>
0927         <span class="keyword">if</span> ff&lt;=nframe_stim
0928           <a href="../../Retinotopy/Common/DrawTextureWithCLUT.html" class="code" title="function DrawTextureWithCLUT(win, src, newclut, srcRect, destRect, rotangle)">DrawTextureWithCLUT</a>(winPtr,checkertexture{pp},CLUT{color_id,compensate_id},[],CenterRect(stimRect,winRect)); <span class="comment">% checkerboard</span>
0929         <span class="keyword">end</span>
0930         Screen(<span class="string">'DrawTexture'</span>,winPtr,fix{task_flg(cur_frames)},[],CenterRect(fixRect,winRect)); <span class="comment">% the central fixation oval</span>
0931 
0932         <span class="comment">% blue line for stereo sync</span>
0933         <span class="keyword">if</span> strcmpi(dparam.ExpMode,<span class="string">'propixxstereo'</span>)
0934           Screen(<span class="string">'FillRect'</span>,winPtr,[0,0,255],blueRectOn(nn,:));
0935           Screen(<span class="string">'FillRect'</span>,winPtr,[0,0,0],blueRectOff(nn,:));
0936         <span class="keyword">end</span>
0937       <span class="keyword">end</span>
0938 
0939       <span class="comment">% flip the window</span>
0940       Screen(<span class="string">'DrawingFinished'</span>,winPtr);
0941       <span class="keyword">while</span> GetSecs()&lt;vbl+sparam.initial_fixation_time(1)+(cc-1)*2*sparam.block_duration+(pp-1)*sparam.block_duration+((ff-1)*sparam.waitframes-0.5)*dparam.ifi, [resps,event]=resps.check_responses(event); <span class="keyword">end</span>
0942       Screen(<span class="string">'Flip'</span>,winPtr,[],[],[],1);
0943 
0944       <span class="keyword">if</span> pp==1 &amp;&amp; ff==1
0945         event=event.add_event(sprintf(<span class="string">'Cycle: %d'</span>,cc),[]);
0946         fprintf(sprintf(<span class="string">'Cycle: %03d...\n'</span>,cc));
0947       <span class="keyword">end</span>
0948 
0949       <span class="comment">% update task</span>
0950       cur_frames=cur_frames+1;
0951       <span class="keyword">if</span> task_flg(cur_frames)==2 &amp;&amp; task_flg(cur_frames-1)==1, event=event.add_event(<span class="string">'Luminance Task'</span>,[]); <span class="keyword">end</span>
0952 
0953       <span class="comment">%% exit from the loop if the final frame is displayed</span>
0954       <span class="keyword">if</span> pp==2 &amp;&amp; ff==nframe_stim+nframe_rest &amp;&amp; cc==sparam.numRepeats, <span class="keyword">continue</span>; <span class="keyword">end</span>
0955 
0956       <span class="comment">%% update IDs</span>
0957 
0958       <span class="comment">% flickering checkerboard</span>
0959       <span class="keyword">if</span> ff&lt;=nframe_stim
0960         <span class="keyword">if</span> ~mod(ff,nframe_flicker) <span class="comment">% color reversal</span>
0961           compensate_id=mod(compensate_id,2)+1;
0962         <span class="keyword">end</span>
0963 
0964         <span class="keyword">if</span> ~mod(ff,2*nframe_flicker) <span class="comment">% color change</span>
0965           color_id=color_id+1;
0966           <span class="keyword">if</span> color_id&gt;sparam.ncolors, color_id=1; <span class="keyword">end</span>
0967         <span class="keyword">end</span>
0968       <span class="keyword">else</span>
0969         compensate_id=1;
0970         color_id=1;
0971       <span class="keyword">end</span>
0972     <span class="keyword">end</span> <span class="comment">% for ff=1:1:nframe_stim+nframe_rest</span>
0973   <span class="keyword">end</span> <span class="comment">% for pp=1:1:2 % 2 = horizontal and vertical visual meridians</span>
0974 
0975 <span class="keyword">end</span> <span class="comment">% for cc=1:1:sparam.numRepeats</span>
0976 
0977 
0978 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0979 <span class="comment">%%%% Final Fixation</span>
0980 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0981 
0982 <span class="keyword">for</span> nn=1:1:nScr
0983   Screen(<span class="string">'SelectStereoDrawBuffer'</span>,winPtr,nn-1);
0984   Screen(<span class="string">'DrawTexture'</span>,winPtr,background,[],CenterRect(bgRect,winRect));
0985   Screen(<span class="string">'DrawTexture'</span>,winPtr,fix{task_flg(cur_frames)},[],CenterRect(fixRect,winRect));
0986 
0987   <span class="comment">% blue line for stereo sync</span>
0988   <span class="keyword">if</span> strcmpi(dparam.ExpMode,<span class="string">'propixxstereo'</span>)
0989     Screen(<span class="string">'FillRect'</span>,winPtr,[0,0,255],blueRectOn(nn,:));
0990     Screen(<span class="string">'FillRect'</span>,winPtr,[0,0,0],blueRectOff(nn,:));
0991   <span class="keyword">end</span>
0992 <span class="keyword">end</span>
0993 Screen(<span class="string">'DrawingFinished'</span>,winPtr);
0994 <span class="keyword">while</span> GetSecs()&lt;vbl+sparam.initial_fixation_time(1)+sparam.numRepeats*2*sparam.block_duration-0.5*dparam.ifi, [resps,event]=resps.check_responses(event); <span class="keyword">end</span>
0995 Screen(<span class="string">'Flip'</span>,winPtr,[],[],[],1);
0996 <span class="comment">%cur_frames=cur_frames+1;</span>
0997 event=event.add_event(<span class="string">'Final Fixation'</span>,[]);
0998 fprintf(<span class="string">'\nfixation\n'</span>);
0999 
1000 <span class="comment">% wait for the initial fixation</span>
1001 <span class="keyword">for</span> ff=1:1:nframe_fixation(2)
1002   <span class="keyword">for</span> nn=1:1:nScr
1003     Screen(<span class="string">'SelectStereoDrawBuffer'</span>,winPtr,nn-1);
1004     Screen(<span class="string">'DrawTexture'</span>,winPtr,background,[],CenterRect(bgRect,winRect));
1005     Screen(<span class="string">'DrawTexture'</span>,winPtr,fix{task_flg(cur_frames)},[],CenterRect(fixRect,winRect));
1006 
1007     <span class="comment">% blue line for stereo sync</span>
1008     <span class="keyword">if</span> strcmpi(dparam.ExpMode,<span class="string">'propixxstereo'</span>)
1009       Screen(<span class="string">'FillRect'</span>,winPtr,[0,0,255],blueRectOn(nn,:));
1010       Screen(<span class="string">'FillRect'</span>,winPtr,[0,0,0],blueRectOff(nn,:));
1011     <span class="keyword">end</span>
1012   <span class="keyword">end</span>
1013   Screen(<span class="string">'DrawingFinished'</span>,winPtr);
1014   <span class="keyword">while</span> GetSecs()&lt;vbl+sparam.initial_fixation_time(1)+sparam.numRepeats*2*sparam.block_duration+(ff*sparam.waitframes-0.5)*dparam.ifi, [resps,event]=resps.check_responses(event); <span class="keyword">end</span>
1015   Screen(<span class="string">'Flip'</span>,winPtr,[],[],[],1);
1016 
1017   <span class="comment">% update task</span>
1018   cur_frames=cur_frames+1;
1019   <span class="keyword">if</span> task_flg(cur_frames-1)==2 &amp;&amp; task_flg(cur_frames-2)==1, event=event.add_event(<span class="string">'Luminance Task'</span>,[]); <span class="keyword">end</span>
1020 <span class="keyword">end</span>
1021 
1022 <span class="comment">% the final clock up</span>
1023 <span class="keyword">while</span> GetSecs()-the_experiment_start&lt;sum(sparam.initial_fixation_time)+sparam.numRepeats*2*sparam.block_duration
1024   [resps,event]=resps.check_responses(event);
1025 <span class="keyword">end</span>
1026 
1027 
1028 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
1029 <span class="comment">%%%% Experiment &amp; scanner end here</span>
1030 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
1031 
1032 experimentDuration=GetSecs()-the_experiment_start+sparam.waitframes*dparam.ifi;
1033 event=event.add_event(<span class="string">'End'</span>,[]);
1034 fprintf(<span class="string">'\n'</span>);
1035 fprintf(<span class="string">'Experiment Completed: %.2f/%.2f secs\n'</span>,experimentDuration,<span class="keyword">...</span>
1036         sum(sparam.initial_fixation_time)+sparam.numRepeats*2*sparam.block_duration);
1037 fprintf(<span class="string">'\n'</span>);
1038 
1039 
1040 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
1041 <span class="comment">%%%% Cleaning up MATLAB OpenGL shader API</span>
1042 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
1043 
1044 <span class="comment">% just call DrawTextureWithCLUT without any input argument</span>
1045 <a href="../../Retinotopy/Common/DrawTextureWithCLUT.html" class="code" title="function DrawTextureWithCLUT(win, src, newclut, srcRect, destRect, rotangle)">DrawTextureWithCLUT</a>();
1046 
1047 
1048 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
1049 <span class="comment">%%%% Cleaning up the PTB screen</span>
1050 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
1051 
1052 Screen(<span class="string">'CloseAll'</span>);
1053 
1054 <span class="comment">% closing datapixx</span>
1055 <span class="keyword">if</span> strcmpi(dparam.ExpMode,<span class="string">'propixxmono'</span>) || strcmpi(dparam.ExpMode,<span class="string">'propixxstereo'</span>)
1056   <span class="keyword">if</span> Datapixx(<span class="string">'IsViewpixx3D'</span>)
1057     Datapixx(<span class="string">'DisableVideoLcd3D60Hz'</span>);
1058     Datapixx(<span class="string">'RegWr'</span>);
1059   <span class="keyword">end</span>
1060   Datapixx(<span class="string">'Close'</span>);
1061 <span class="keyword">end</span>
1062 
1063 ShowCursor();
1064 Priority(0);
1065 <a href="../../Retinotopy/Common/GammaResetPTB.html" class="code" title="function GammaResetPTB(luminance_ratio)">GammaResetPTB</a>(1.0);
1066 
1067 
1068 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
1069 <span class="comment">%%%% Write data into file for post analysis</span>
1070 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
1071 
1072 <span class="comment">% saving the results</span>
1073 fprintf(<span class="string">'saving data...'</span>);
1074 
1075 <span class="comment">% save data</span>
1076 savefname=fullfile(resultDir,[num2str(subjID),<span class="string">'_cmeridian_fixtask_results_run_'</span>,num2str(acq,<span class="string">'%02d'</span>),<span class="string">'.mat'</span>]);
1077 
1078 <span class="comment">% backup the old file(s)</span>
1079 <span class="keyword">if</span> ~overwrite_flg
1080   <a href="../../Retinotopy/Common/BackUpObsoleteFiles.html" class="code" title="function [new_fname,backup_fname]=BackUpObsoleteFiles(tgt_dir,tgt_fname,backup_prefix)">BackUpObsoleteFiles</a>(fullfile(<span class="string">'subjects'</span>,num2str(subjID),<span class="string">'results'</span>,today),<span class="keyword">...</span>
1081                       [num2str(subjID),<span class="string">'_cmeridian_fixtask_results_run_'</span>,num2str(acq,<span class="string">'%02d'</span>),<span class="string">'.mat'</span>],<span class="string">'_old'</span>);
1082 <span class="keyword">end</span>
1083 
1084 eval(sprintf(<span class="string">'save %s subjID acq sparam dparam event gamma_table;'</span>,savefname));
1085 fprintf(<span class="string">'done.\n'</span>);
1086 
1087 <span class="comment">% calculate &amp; display task performance</span>
1088 fprintf(<span class="string">'calculating task accuracy...\n'</span>);
1089 correct_event=cell(2,1); <span class="keyword">for</span> ii=1:1:2, correct_event{ii}=sprintf(<span class="string">'key%d'</span>,ii); <span class="keyword">end</span>
1090 [task.numTasks,task.numHits,task.numErrors,task.numResponses,task.RT]=event.calc_accuracy(correct_event);
1091 event=event.get_event(); <span class="comment">% convert an event logger object to a cell data structure</span>
1092 eval(sprintf(<span class="string">'save -append %s event task;'</span>,savefname));
1093 fprintf(<span class="string">'done.\n'</span>);
1094 
1095 
1096 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
1097 <span class="comment">%%%% Removing path to the subfunctions, and finalizing the script</span>
1098 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
1099 
1100 rmpath(genpath(fullfile(rootDir,<span class="string">'..'</span>,<span class="string">'Common'</span>)));
1101 rmpath(fullfile(rootDir,<span class="string">'..'</span>,<span class="string">'Generation'</span>));
1102 clear all; clear mex; clear <span class="keyword">global</span>;
1103 diary off;
1104 
1105 
1106 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
1107 <span class="comment">%%%% tell the experimenter that the measurements are completed</span>
1108 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
1109 
1110 <span class="keyword">try</span>
1111   <span class="keyword">for</span> ii=1:1:3, Snd(<span class="string">'Play'</span>,sin(2*pi*0.2*(0:900)),8000); <span class="keyword">end</span>
1112 <span class="keyword">catch</span>
1113   <span class="comment">% do nothing</span>
1114 <span class="keyword">end</span>
1115 
1116 
1117 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
1118 <span class="comment">%%%% Catch the errors</span>
1119 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
1120 
1121 <span class="keyword">catch</span> lasterror
1122   <span class="comment">% this &quot;catch&quot; section executes in case of an error in the &quot;try&quot; section</span>
1123   <span class="comment">% above.  Importantly, it closes the onscreen window if its open.</span>
1124   Screen(<span class="string">'CloseAll'</span>);
1125 
1126   <span class="keyword">if</span> exist(<span class="string">'dparam'</span>,<span class="string">'var'</span>)
1127     <span class="keyword">if</span> <a href="../../Retinotopy/Common/isstructmember.html" class="code" title="function isFieldResult = isstructmember(inStruct, fieldName)">isstructmember</a>(dparam,<span class="string">'ExpMode'</span>)
1128       <span class="keyword">if</span> strcmpi(dparam.ExpMode,<span class="string">'propixxmono'</span>) || strcmpi(dparam.ExpMode,<span class="string">'propixxstereo'</span>)
1129         <span class="keyword">if</span> Datapixx(<span class="string">'IsViewpixx3D'</span>)
1130           Datapixx(<span class="string">'DisableVideoLcd3D60Hz'</span>);
1131           Datapixx(<span class="string">'RegWr'</span>);
1132         <span class="keyword">end</span>
1133         Datapixx(<span class="string">'Close'</span>);
1134       <span class="keyword">end</span>
1135     <span class="keyword">end</span>
1136   <span class="keyword">end</span>
1137 
1138   ShowCursor();
1139   Priority(0);
1140   <a href="../../Retinotopy/Common/GammaResetPTB.html" class="code" title="function GammaResetPTB(luminance_ratio)">GammaResetPTB</a>(1.0);
1141   tmp=lasterror; <span class="comment">%#ok</span>
1142   <span class="comment">%if exist('event','var'), event=event.get_event(); end %#ok % just for debugging</span>
1143   diary off;
1144   fprintf([<span class="string">'\nError detected and the program was terminated.\n'</span>,<span class="keyword">...</span>
1145            <span class="string">'To check error(s), please type ''tmp''.\n'</span>,<span class="keyword">...</span>
1146            <span class="string">'Please save the current variables now if you need.\n'</span>,<span class="keyword">...</span>
1147            <span class="string">'Then, quit by ''dbquit''\n'</span>]);
1148   keyboard;
1149   rmpath(genpath(fullfile(rootDir,<span class="string">'..'</span>,<span class="string">'Common'</span>)));
1150   rmpath(fullfile(rootDir,<span class="string">'..'</span>,<span class="string">'Generation'</span>));
1151   clear all; clear mex; clear <span class="keyword">global</span>;
1152   <span class="keyword">return</span>
1153 <span class="keyword">end</span> <span class="comment">% try..catch</span>
1154 
1155 
1156 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
1157 <span class="comment">%%%%% That's it - we're done</span>
1158 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
1159 <span class="keyword">return</span>;
1160 <span class="comment">% end % function cmeridian_fixtask</span></pre></div>
<hr><address>Generated on Thu 10-Jun-2021 10:01:25 by <strong><a href="http://www.artefact.tk/software/matlab/m2html/" target="_parent">m2html</a></strong> &copy; 2005 using a BVQX_hbtools customized template</address>
</body>
</html>